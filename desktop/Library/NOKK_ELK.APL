.head 0 +  Application Description: технологические операции по обработке файлов системы КЛИЕНТ-БАНК (ИКТ)
.head 1 -  Outline Version - 4.0.26
.head 1 +  Design-time Settings
.data VIEWINFO
0000: 6F00000001000000 FFFF01000D004347 5458566965775374 6174650400010000
0020: 0000000000B30000 002C000000020000 0003000000FFFFFF FFFFFFFFFFFCFFFF
0040: FFE9FFFFFF000000 0000000000DE0100 0041010000010000 0000000000010000
0060: 000F4170706C6963 6174696F6E497465 6D04000000075769 6E646F7773076672
0080: 6D5F4E4F4B094675 6E6374696F6E7307 4F706C61746131
.enddata
.data DT_MAKERUNDLG
0000: 000000001E5C4241 525339385C524553 4F555243455C4943 4F5C4D6F6E65792E
0020: 69636F185C424152 5339385C42494E5C 4E6F6B6B5F456C6B 2E457865165C4241
0040: 525339385C42494E 5C6E65776170702E 646C6C165C424152 5339385C42494E5C
0060: 6E65776170702E61 7063000001010115 513A5C43454E5455 52415C6E65776170
0080: 702E72756E15513A 5C43454E54555241 5C6E65776170702E 646C6C15513A5C43
00A0: 454E545552415C6E 65776170702E6170 6300000101011A51 3A5C424152533938
00C0: 5C42494E5C6B6C6F 705F656C6C2E6578 6518513A5C424152 5339385C42494E5C
00E0: 6E65776170702E64 6C6C18513A5C4241 525339385C42494E 5C6E65776170702E
0100: 6170630000010101 15513A5C43454E54 5552415C6E657761 70702E61706C1551
0120: 3A5C43454E545552 415C6E6577617070 2E646C6C15513A5C 43454E545552415C
0140: 6E65776170702E61 70630000010101
.enddata
.head 2 -  Outline Window State: Normal
.head 2 +  Outline Window Location and Size
.data VIEWINFO
0000: 6600040003002D00 0000000000000000 0000B71E5D0E0500 1D00FFFF4D61696E
0020: 0000000000000000 0000000000000000 0000003B00010000 00000000000000E9
0040: 1E800A00008600FF FF496E7465726E61 6C2046756E637469 6F6E730000000000
0060: 0000000000000000 0000000000003200 0100000000000000 0000E91E800A0000
0080: DF00FFFF56617269 61626C6573000000 0000000000000000 0000000000000000
00A0: 3000010000000000 00000000F51E100D 0000F400FFFF436C 6173736573000000
00C0: 0000000000000000 0000000000000000
.enddata
.data VIEWSIZE
0000: D000
.enddata
.head 3 -  Left:   -0.013"
.head 3 -  Top:    0.0"
.head 3 -  Width:  8.013"
.head 3 -  Height: 4.969"
.head 2 +  Options Box Location
.data VIEWINFO
0000: 0418B80BB80B2500
.enddata
.data VIEWSIZE
0000: 0800
.enddata
.head 3 -  Visible? Yes
.head 3 -  Left:   4.15"
.head 3 -  Top:    1.885"
.head 3 -  Width:  3.8"
.head 3 -  Height: 2.073"
.head 2 +  Class Editor Location
.head 3 -  Visible? No
.head 3 -  Left:   0.575"
.head 3 -  Top:    0.094"
.head 3 -  Width:  5.063"
.head 3 -  Height: 2.719"
.head 2 +  Tool Palette Location
.head 3 -  Visible? No
.head 3 -  Left:   6.388"
.head 3 -  Top:    0.729"
.head 2 -  Fully Qualified External References? Yes
.head 2 -  Reject Multiple Window Instances? No
.head 2 -  Enable Runtime Checks Of External References? Yes
.head 2 -  Use Release 4.0 Scope Rules? No
.head 1 +  Libraries
.head 2 -  Dynalib: Global.apd
.head 2 -  Dynalib: Message.apd
.head 2 -  Dynalib: Absapi.apd
.head 2 -  Dynalib: Nsiapi.apd
.head 2 -  Dynalib: DOCVIEW.APD
.head 2 -  Dynalib: Watchdog.apd
.head 2 -  Dynalib: Ssplashn.apd
.head 2 -  Dynalib: Dblogin.apd
.head 2 -  Dynalib: License.apd
.head 2 -  Dynalib: Dfltrapi.apd
.head 2 -  File Include: Gentimer.apl
.head 2 -  File Include: GenButn.apl
.head 2 -  File Include: GenFcls.apl
.head 2 -  File Include: Gentbl.apl
.head 2 -  File Include: Constant.apl
.head 2 -  File Include: Winbars2.apl
.head 2 -  File Include: Ttp32.apl
.head 2 -  File Include: Docfun6.apl
.head 2 -  File Include: Genfiltr.apl
.head 2 -  File Include: Winapi.apl
.head 2 -  File Include: Vtmeter.apl
.head 2 -  File Include: Vtdos.apl
.head 2 -  File Include: Vtlbx.apl
.head 2 -  File Include: Vttblwin.apl
.head 2 -  File Include: Vtfile.apl
.head 2 -  File Include: vtcomm.apl
.head 2 -  File Include: vtmisc.apl
.head 2 -  File Include: vtstr.apl
.head 2 -  File Include: VTARRAY.APL
.head 1 +  Global Declarations
.head 2 +  Window Defaults
.head 3 +  Tool Bar
.head 4 -  Display Style? Etched
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Form Window
.head 4 -  Display Style? Etched
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Dialog Box
.head 4 -  Display Style? Etched
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Top Level Table Window
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Data Field
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Multiline Field
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Spin Field
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Background Text
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Pushbutton
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 3 +  Radio Button
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Check Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Option Button
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 3 +  Group Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Child Table Window
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  List Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Combo Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Line
.head 4 -  Line Color: Use Parent
.head 3 +  Frame
.head 4 -  Border Color: Use Parent
.head 4 -  Background Color: 3D Face Color
.head 3 +  Picture
.head 4 -  Border Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 2 +  Formats
.head 3 -  Number: 0'%'
.head 3 -  Number: #0
.head 3 -  Number: ###000
.head 3 -  Number: ###000;'($'###000')'
.head 3 -  Date/Time: hh:mm:ss AMPM
.head 3 -  Date/Time: M/d/yy
.head 3 -  Date/Time: MM-dd-yy
.head 3 -  Date/Time: dd-MMM-yyyy
.head 3 -  Date/Time: MMM d, yyyy
.head 3 -  Date/Time: MMM d, yyyy hh:mm AMPM
.head 3 -  Date/Time: MMMM d, yyyy hh:mm AMPM
.head 2 +  External Functions
.head 3 +  Library name: IctBob.Dll
.head 4 +  Function: llopen
.head 5 -  Description: открытие файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: HANDLE
.head 5 +  Parameters
.head 6 -  ! первый параметр: имя файла, второй: тип открытия
.head 6 -  String: LPCSTR
.head 6 -  Number: INT
.head 4 +  Function: llcreat
.head 5 -  Description: создание файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: HANDLE
.head 5 +  Parameters
.head 6 -  ! первый параметр: имя файла, второй: тип открытия
.head 6 -  String: LPCSTR
.head 6 -  Number: INT
.head 4 +  Function: llclose
.head 5 -  Description: закрытие файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: HANDLE
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 4 +  Function: llread
.head 5 -  Description: чтение файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: UINT
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 6 -  String: LPVOID
.head 6 -  Number: UINT
.head 4 +  Function: llwrite
.head 5 -  Description:
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: UINT
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 6 -  String: LPCSTR
.head 6 -  Number: UINT
.head 4 +  Function: lllseek
.head 5 -  Description:
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: LONG
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 6 -  Number: LONG
.head 6 -  Number: INT
.head 4 +  Function: llstr2str
.head 5 -  Description: преобразование строки HEXtoBIN
.head 5 -  Export Ordinal: 0
.head 5 -  Returns
.head 5 +  Parameters
.head 6 -  String: LPSTR
.head 6 -  Receive String: LPVOID
.head 6 -  Number: ULONG
.head 2 +  Constants
.data CCDATA
0000: 3000000000000000 0000000000000000 00000000
.enddata
.data CCSIZE
0000: 1400
.enddata
.head 3 +  System
.head 3 +  User
.head 2 +  Resources
.head 3 +  Bitmap: bmp1
.head 4 -  File Name: /Bars98/Resource/Bmp/orchid.bmp
.head 3 +  Bitmap: bmp3
.head 4 -  File Name: /Bars98/Resource/Bmp/teal.bmp
.head 2 +  Variables
.data RESOURCE 0 0 1 3904120409
0000: 380000001D000000 0000000000000000 020000020000009A 000000E003040000
0020: 00FF3F9E00800000 010D000000FFFF
.enddata
.head 3 -  Number: nFetchRes
.head 3 -  Number: nUsers
.head 3 -  Date/Time: dtExpDate
.head 3 -  Date/Time: dtWBDate
.head 3 -  !
.head 3 -  Number: ni2
.head 2 +  Internal Functions
.head 2 +  Named Menus
.head 2 +  Class Definitions
.data RESOURCE 0 0 1 115717692
0000: D9010000F1000000 0000000000000000 0200000300FFFF01 00160000436C6173
0020: 73566172004F7574 6C696E6552006567 496E666F22003C00 000A630047656E46
0040: 696C746500727400 00000400001E0002 0400C10001000000 3F8001F800000037
0060: 040001F00D000000 FF1F110000DC0002 00FF7F1570000000 0100FFFF21018022
0080: 000001C200000B63 47F8444669B30004 00770200F601004F 800100FE008D0400
00A0: 010DFD00FF371100 02F700FFDF15DC00 0100FF7F01008041 0000000200000000
00C0: 0D63526164696F00 4C697374426F7886 8000000005000000 67010D00FFFFC90D
00E0: 000001FD00FF071A 00000001F700FF1F 270000DC000100FF 7F34700000000100
0100: FFFF01
.enddata
.head 3 +  ! Functional Class: cDocNOKK
.winattr
.end
.head 4 -                  Description: Класс документа для электронных клиентов
.head 4 +                  Derived From
.head 5 -                  Class: cDoc
.head 4 -                  Class Variables
.head 4 +                  Instance Variables
.head 5 -                  Boolean: bSignInited
.head 4 +                  Functions
.head 5 +  ! Function: sIni
.head 6 -                  Description: Инициализировать ЭЦП
.head 6 +                  Returns
.head 7 -                  Boolean:
.head 6 -                  Parameters
.head 6 +                  Static Variables
.head 7 -  ! Boolean: bSignInited
.head 7 -                  Number: nTim
.head 6 +                  Local variables
.head 7 -  ! String: strUxDateTime
.head 7 -                  String: strDay
.head 7 -                  Number: nDay
.head 7 -                  Number: nErrorSign
.head 7 -                  String: strErrorSign
.head 7 -                  String: strPinCode
.head 6 +                  Actions
.head 7 -  ! Call Debug('bSignInited:'||Str(bSignInited))
.head 7 +                  If bSignInited
.head 8 -                  Return TRUE
.head 7 +                  If GetSignType() = 'UKR' or GetSignType() = 'NBU'
.head 8 -                  Set nErrorSign = NUMBER_Null
.head 8 -                  Set strPinCode = ''
.head 8 +                  While TRUE
.head 9 +                  If SalModalDialog(dlgAskPinCode, hWndForm,strPinCode)
.head 10 +                  If GetSignType() = 'NBU'
.head 11 +                  If bSignInited
.head 12 -                  Set nErrorSign = CLOSE_ZAH()
.head 11 -  ! Set strUxDateTime = '1998/01/18 08:08:08'
    !!! ТОЛЬКО ДЛЯ ОТЛАДКИ !!!
.head 11 -  ! Set strUxDateTime = SalFmtFormatDateTime(
    GetBankDate(), 'yyyy/MM/dd') ||
    ' 07:07:07'
.head 11 -                  Set nErrorSign = INIT_ZAH(GetOpenKeyDir(),
    GetSecretKeyDrv(), GetIdOper(),
    GetKeyDate(), strPinCode)
.head 11 +                  If nErrorSign = -70
.head 12 -                  Call MessageErrorEx('>> RSA. Последний ' ||
     'день действия секретного ключа')
.head 11 +                  Else If nErrorSign > -77 And nErrorSign < -70
.head 12 -                  Set nDay = - nErrorSign - 70
.head 12 +                  If nDay = 1
.head 13 -                  Set strDay = 'день'
.head 12 +                  Else If nDay = 2 Or nDay = 3 Or nDay = 4
.head 13 -                  Set strDay = 'дня'
.head 12 +                  Else If nDay = 5 Or nDay = 6
.head 13 -                  Set strDay = 'дней'
.head 12 -                  Call MessageErrorEx('>> RSA. Срок действия'
     || 'секретного ключа прекращается ' ||
     'через ' || NumberToStr(nDay) || ' '
     || strDay)
.head 11 +                  Else If nErrorSign != 0
.head 12 -                  Break
.head 10 +                  Else
.head 11 +                  If bSignInited
.head 12 -                  Set nErrorSign = nsignExitOPSign()
.head 11 -  ! Cipher 98
.head 11 -  ! Set nErrorSign = nsignInitOPSign(
    GetOpenKeyDir(), GetSecretKeyDrv(),
    strPinCode, GetBankMfo())
.head 11 -  ! Cipher 99 с ОперИдом
.head 11 -                  Set nErrorSign = nsignInitOPSign(
    GetOpenKeyDir(), GetSecretKeyDrv(),
    strPinCode, GetBankMfo(),GetIdOper())
.head 11 -  ! Отладка
.head 11 -  ! Set nErrorSign = nsignInitOPSign(
    GetOpenKeyDir(), GetSecretKeyDrv(),
    strPinCode, '351447', GetIdOper())
.head 11 +                  If nErrorSign != 0
.head 12 -                  Break
.head 10 -                  Call SaveInfoToLog('>> RSA - инициализация - OK')
.head 10 -                  Set bSignInited = TRUE
.head 10 -                  Return TRUE
.head 9 +                  Else
.head 10 -                  Break
.head 8 +                  If nErrorSign != NUMBER_Null ! обработка ошибок ЭЦП
.head 9 +                  If GetSignType() = 'NBU'
.head 10 -                  Set strErrorSign = '>> RSA. Ошибка инициализации ЭЦП: '||NumberToStr(nErrorSign)
.head 10 -  ! Call CLOSE_ZAH()
.head 10 -                  Call MessageErrorEx(strErrorSign)
.head 9 +                  Else
.head 10 -                  Set strErrorSign = SalStrRepeatX(' ', 129)
.head 10 -                  Call nsignMapError2Text(strErrorSign,
     nErrorSign)
.head 10 -                  Call MessageErrorEx('>> CIP. ' ||
     StrDosToWinX(strErrorSign))
.head 10 -                  Call nsignExitOPSign()
.head 8 -                  Return FALSE
.head 7 +                  Else
.head 8 -                  Return MessageErrorEx('Неизвестная система ЭЦП: '|| GetSignType())
.head 7 +  ! Комментарий
.head 8 -  ! 'NBU' -- используется ЭЦП НБУ
.head 8 -  ! 'UKR' -- используется ЭЦП Банка 'Украина'
.head 5 +                  Function: sIni
.head 6 -                  Description: Инициализировать ЭЦП
.head 6 +                  Returns
.head 7 -                  Boolean:
.head 6 -                  Parameters
.head 6 +                  Static Variables
.head 7 -                  Boolean: bSignInited
.head 7 -                  Number: nTim
.head 6 +                  Local variables
.head 7 -                  String: strDay
.head 7 -                  Number: nDay
.head 7 -                  Number: nErrorSign
.head 7 -                  String: strErrorSign
.head 7 -                  String: strPinCode
.head 7 -                  Number: lTim
.head 7 -                  Number: nDaysLeft
.head 7 -                  String: strDaysLeftMsg
.head 7 -                  String: strFullMsg
.head 7 -                  String: strFileName
.head 6 +                  Actions
.head 7 -                  Set lTim = nTim
.head 7 -                  Set nTim = SalDateHour(SalDateCurrent())*60 + SalDateMinute(SalDateCurrent())
.head 7 +                  If bSignInited and nTim-lTim < 5
.head 8 -                  Return TRUE
.head 7 +                  If GetSignType() = 'UKR' or
   GetSignType() = 'NBU' or GetSignType() = 'VEG'
.head 8 -                  Set nErrorSign = NUMBER_Null
.head 8 -                  Set strPinCode = ''
.head 8 +                  While TRUE
.head 9 +                  If SalModalDialog(dlgAskPinCode, hWndForm, strPinCode)
.head 10 +                  If GetSignType() = 'NBU'
.head 11 +                  If bSignInited
.head 12 -                  Set nErrorSign = CLOSE_ZAH()
.head 12 -                  Set bSignInited = FALSE
.head 11 -                  Set nErrorSign = INIT_ZAH(GetOpenKeyDir(),GetSecretKeyDrv(),GetIdOper(),GetKeyDate(), strPinCode)
.head 11 +                  If nErrorSign = -70
.head 12 -                  Call MessageErrorEx('Последний день действия секретного ключа '||GetIdOper())
.head 11 +                  Else If nErrorSign > -77 And nErrorSign < -70
.head 12 -                  Set nDay = - nErrorSign - 70
.head 12 -                  Call MessageErrorEx('Действие ключа '||GetIdOper()||' прекращается через ' ||NumberToStr(nDay) || ' ' || GetDayStrByNum(nDay))
.head 11 +                  Else If nErrorSign
.head 12 -                  Break
.head 10 +                  Else If GetSignType() = 'VEG'
.head 11 +                  If bSignInited
.head 12 -                  Set nErrorSign = VegaClose (0)
.head 12 -                  Set bSignInited = FALSE
.head 11 -                  Call SalStrSetBufferLength( sBuf, 11024+4104+1)
.head 11 -                  Set nErrorSign = VegaSetBuf(sBuf,11024+4104)
.head 11 +                  If nErrorSign
.head 12 -  ! Call Debug('VegaSetBuf Err '||SalNumberToStrX(nErrorSign,0))
.head 12 -                  Break
.head 11 -                  Set nErrorSign = VegaSetDate(SalFmtFormatDateTime(GetBankDate(),'dd/MM/yyyy'))
.head 11 +                  If nErrorSign
.head 12 -  ! Call Debug('VegaSetDate Err '||SalNumberToStrX(nErrorSign,0))
.head 12 -                  Break
.head 11 -                  Set nErrorSign = VegaOpen(GetOpenKeyDir()||'\\Vega.cfg',GetOpenKeyDir()||'\\',0)
.head 11 +                  If nErrorSign
.head 12 -  ! Call Debug('VegaOpen Err '||SalNumberToStrX(nErrorSign,0))
.head 12 -                  Break
.head 11 -                  Call SalStrSetBufferLength(sUid,9)
.head 11 +                  If GetSecretKeyDrv()='TM'
.head 12 -                  Set nErrorSign=ReadTM()
.head 12 +                  If nErrorSign
.head 13 -  ! Call Debug('ReadTM Err '||SalNumberToStrX(nErrorSign,0))
.head 13 -                  Set nErrorSign=nErrorSign+500
.head 13 -                  Break
.head 12 -                  Call VegaSetFmode(1,0)
.head 12 -                  Set nErrorSign = VegaLoadSecKey(m_lsSecretKey,PadR(strPinCode,32),sUid,0)
.head 12 -                  Call VegaSetFmode(0,0)
.head 11 +                  Else
.head 12 -                  Set nErrorSign = VegaLoadSecKey(GetSecretKeyDrv()||'\\'||SalStrRightX('00'||GetGlobalOption('REGNCODE'),2)||GetIdOper()||'.KEY',PadR(strPinCode,32),sUid,0)
.head 11 -  ! Обрабатываем все предупреждения от VegaLoadSecKey - SERG
.head 11 +                  If nErrorSign>=1 AND  nErrorSign<=8
.head 12 -                  Set strErrorSign = SalStrRepeatX(' ', 129)
.head 12 -                  Call VegaGetMsgAux(nErrorSign, strErrorSign, 128 )
.head 12 +                  If nErrorSign=1 OR nErrorSign=2
.head 13 -                  Set nDaysLeft = VegaDaysLeft(0)
.head 13 -                  Set strDaysLeftMsg = 'До истечения срока действия секретного ключа осталось '
||SalNumberToStrX(nDaysLeft,0) || ' ' || GetDayStrByNum(nDaysLeft)
.head 12 +                  Else If nErrorSign=4
.head 13 -                  Set nDaysLeft = VegaDaysLeftA(0)
.head 13 -                  Set strDaysLeftMsg = 'До истечения срока действия ключа администратора осталось '
||SalNumberToStrX(nDaysLeft,0) || ' ' || GetDayStrByNum(nDaysLeft)
.head 12 -                  Set strFullMsg = SalStrLeftX(strErrorSign, SalStrLength(strErrorSign)) || SalNumberToChar(13) ||
	strDaysLeftMsg || SalNumberToChar(13) || 'Продолжите работу'
.head 12 -  ! Операционисты должны видеть только предупреждения
с кодом 1 или 2 - остальные пока игнорируем
4 - касается администратора
8 - возникать не должно
.head 12 +                  If nErrorSign=1 OR nErrorSign=2
.head 13 -                  Call SalMessageBox(strFullMsg , 'Предупреждение', MB_Ok | MB_IconExclamation )
.head 12 -  ! Обнуляем переменную с кодом ошибки
.head 12 -                  Set nErrorSign=0
.head 11 +                  If nErrorSign
.head 12 -  ! Call Debug('VegaLoadSecKey Err '||SalNumberToStrX(nErrorSign,0))
.head 12 -                  Break
.head 11 +                  If SalStrRightX('00'||GetGlobalOption('REGNCODE'),2)||GetIdOper() != sUid
.head 12 -                  Set nErrorSign=202
.head 12 -                  Break
.head 11 -  ! Проверим соответствие идентификатора ключа
.head 11 -  ! Обрабатываем ситуацию обновления ключа для TouchMemory
.head 11 +                  If GetSecretKeyDrv()='TM'
.head 12 +                  If VegaSecKeyUpdate(0)  ! было изменение ключа
.head 13 -  ! дампим старый ключ на диск C и прописываем новый на ТМ
.head 13 -  ! Call Debug('Обновление ключа')
.head 13 -  ! Дампить СК на лок. диск запрещается !!!
.head 13 -  ! Set strFileName = 'C:\\' || SalStrRightX('00'||GetGlobalOption('REGNCODE'),2)||GetIdOper()||'.KEY'
.head 13 +  ! If SalFileOpen(hFileKeyBackup, strFileName, OF_Create | OF_Write | OF_Binary )
.head 14 -                  Call SalFileWrite(hFileKeyBackup, m_lsSecretKeyCopy, VEGA_SKFILE_SIZE)
.head 14 -                  Call SalFileClose(hFileKeyBackup)
.head 14 -                  Call SalMessageBox( 'Старый ключ сохранен в файле ' || strFileName ,
'Сообщение',  MB_Ok | MB_IconAsterisk )
.head 13 +  ! Else
.head 14 -                  Call SalMessageBox( 'Ошибка открытия файла '|| strFileName ||
' для записи' || SalNumberToChar(13) || 'Старый ключ сохранен не будет',
'Предупреждение', MB_Ok | MB_IconExclamation )
.head 13 -                  Set nErrorSign =  WriteTM()
.head 13 +                  If nErrorSign = 0
.head 14 -                  Call SalMessageBox( 'Секретный ключ успешно обновлен на TouchMemory',
 'Сообщение', MB_Ok | MB_IconAsterisk )
.head 14 -                  Call SaveInfoToLog('СК ' || SalStrRightX('00'||GetGlobalOption('REGNCODE'),2)||GetIdOper() ||
' успешно обновлен на TouchMemory')
.head 13 +                  Else
.head 14 -                  Set nErrorSign = nErrorSign+500
.head 12 +  ! Else
.head 13 -                  Call Debug('Ключ не менялся ')
.head 13 -                  Set strFileName = 'C:\\' || SalStrRightX('00'||GetGlobalOption('REGNCODE'),2)||GetIdOper()||'.KEY'
.head 13 -                  Call Debug( strFileName )
.head 10 +                  Else
.head 11 +                  If bSignInited
.head 12 -                  Set nErrorSign = nsignExitOPSign()
.head 12 -                  Set bSignInited = FALSE
.head 11 -                  Set nErrorSign = nsignInitOPSign(GetOpenKeyDir(),GetSecretKeyDrv(),strPinCode,GetBankMfo(),GetIdOper())
.head 11 +                  If nErrorSign
.head 12 -                  Break
.head 10 -                  Call SaveInfoToLog('Инициализация ЭЦП - OK')
.head 10 -                  Set bSignInited = TRUE
.head 10 -                  Return TRUE
.head 9 +                  Else
.head 10 -                  Break
.head 8 +                  If nErrorSign                 ! обработка ошибок ЭЦП
.head 9 +                  If GetSignType() = 'NBU'
.head 10 -                  Set strErrorSign = 'Ошибка '||NumberToStr(nErrorSign) || ' инициализации ЭЦП НБУ. '||GetIdOper()
.head 10 -                  Call MessageErrorEx(strErrorSign)
.head 9 +                  Else If GetSignType() = 'VEG'
.head 10 -  ! Строку сообщения для ошибок VEGA и TM предоставляет библ. ф-ция VegaGetMsgAux - SERG
.head 10 -  ! Set strErrorSign = 'Ошибка '||SalNumberToStrX( (nErrorSign - SalNumberMod( nErrorSign, 4096 ))/4095, 0 )||'-'||
                SalNumberToStrX(SalNumberMod( nErrorSign, 4096 ),0) || ' инициализации ЭЦП VEGA. '||GetIdOper()
.head 10 -                  Set strErrorSign = SalStrRepeatX(' ', 4096)
.head 10 -                  Call VegaGetMsgAux(nErrorSign, strErrorSign, 4096)
.head 10 -                  Call MessageErrorEx(strErrorSign)
.head 9 +                  Else
.head 10 -                  Set strErrorSign = SalStrRepeatX(' ', 129)
.head 10 -                  Call nsignMapError2Text(strErrorSign, nErrorSign)
.head 10 -                  Call MessageErrorEx( StrDosToWinX(strErrorSign) )
.head 10 -                  Call nsignExitOPSign()
.head 8 -                  Return FALSE
.head 7 +                  Else
.head 8 -                  Return MessageErrorEx('Неизвестная система ЭЦП: '|| GetSignType())
.head 7 +  ! Комментарий
.head 8 -  ! 'NBU' -- используется ЭЦП НБУ
.head 8 -  ! 'UKR' -- используется ЭЦП Банка 'Украина'
.head 8 -  ! 'VEG' -- используется ЭЦП NOKK 'VEGA'
.head 3 +  Functional Class: cDocNokk
.head 4 -  Description:
.head 4 +  Derived From
.head 5 -  Class: cDoc
.head 4 -  Class Variables
.head 4 +  Instance Variables
.head 5 -  String: s8
.head 5 -  String: sFile
.head 5 -  String: sTilda
.head 5 -  String: sDatF
.head 5 -  String: sNumP
.head 5 -  String: sMsg
.head 5 -  String: sKod4
.head 5 -  String: sKod5
.head 4 +  Functions
.head 5 +  Function: iDop
.head 6 -  Description:
.head 6 +  Returns
.head 7 -  Boolean:
.head 6 -  Parameters
.head 6 -  Static Variables
.head 6 -  Local variables
.head 6 +  Actions
.head 7 -  ! вставить в OPERW В доп реквизиты IDB
.head 7 -  ! Set s8 = Subs(sTmp, 407, 14)
.head 7 +  If SqlPrepareAndExecute(hSqlAux2(), "
   INSERT
   INTO operw (REF,TAG,VALUE)
   VALUES (:ccDoc.m_nRef,'IDB',:ccDoc.s8)") and
   SqlPrepareAndExecute(hSqlAux2(), "
   INSERT
   INTO operw (REF,TAG,VALUE)
   VALUES (:ccDoc.m_nRef,'IDF',:ccDoc.sFile)") and
   SqlPrepareAndExecute(hSqlAux2(), "
   INSERT
   INTO operw (REF,TAG,VALUE)
   VALUES (:ccDoc.m_nRef,'IDD',:ccDoc.sDatF)") and
   SqlPrepareAndExecute(hSqlAux2(), "
   INSERT
   INTO operw (REF,TAG,VALUE)
   VALUES (:ccDoc.m_nRef,'IDN',:ccDoc.sNumP)")
.head 8 +  If Len(sTilda) > 0
.head 9 +  If SqlPrepareAndExecute(hSqlAux2(), "
   INSERT
   INTO operw (REF,TAG,VALUE)
   VALUES (:ccDoc.m_nRef,'RCK_D',:ccDoc.sTilda)")
.head 10 -  Return TRUE
.head 9 +  Else
.head 10 -  Set sMsg = 'Ош вставки RCK_D'
.head 10 -  Set sKod5 = '1'
.head 10 -  Return FALSE
.head 8 +  Else
.head 9 -  Return TRUE
.head 7 +  Else
.head 8 -  Set sMsg = 'Ош вставки IDB или IDF'
.head 8 -  Set sKod4 = '1'
.head 8 -  Return FALSE
.head 2 +  Default Classes
.head 3 -  MDI Window: cBaseMDI
.head 3 -  Form Window:
.head 3 -  Dialog Box:
.head 3 -  Table Window:
.head 3 -  Quest Window:
.head 3 -  Data Field:
.head 3 -  Spin Field:
.head 3 -  Multiline Field:
.head 3 -  Pushbutton:
.head 3 -  Radio Button:
.head 3 -  Option Button:
.head 3 -  Check Box:
.head 3 -  Child Table:
.head 3 -  Quest Child Window: cQuickDatabase
.head 3 -  List Box:
.head 3 -  Combo Box:
.head 3 -  Picture:
.head 3 -  Vertical Scroll Bar:
.head 3 -  Horizontal Scroll Bar:
.head 3 -  Column:
.head 3 -  Background Text:
.head 3 -  Group Box:
.head 3 -  Line:
.head 3 -  Frame:
.head 3 -  Custom Control:
.head 2 +  Application Actions
.head 3 +  On SAM_AppStartup
.head 4 -  Call SplashOpenWindow()
.head 4 -  ! Инициализация начальных  параметров
.head 4 -  ! Call SplashSetStatusText("Инициализация параметров...")
.head 4 -  Call GetConfigSettings()
.head 4 -  !
.head 4 -  ! Call SplashSetStatusText("Инициализация аудита...")
.head 4 -  ! Call DBSpy_Init(GetDbs())
.head 4 -  Set ni2 = 0
.head 4 +  While ni2 < 500000
.head 5 -  Set ni2 = ni2 + 1
.head 4 -  !
.head 4 -  ! Call SplashSetStatusText("Инициализация интерфейса...")
.head 4 -  Call SplashCloseWindow()
.head 4 +  If DatabaseLogin(dtWBDate)
.head 5 -  Call SetWorkBankDate(GetParamBankDate())
.head 5 -  Set nUsers = GetGlobalOptionEx('USRLIMIT')
.head 5 -  Set dtExpDate = SalFmtFormatStrDateTime(GetGlobalOption('EXPDATE'), 'dd/MM/yyyy')
.head 5 +  If dtExpDate < SalDateCurrent()
.head 6 -  Call SalMessageBeep(MB_IconStop)
.head 6 -  Call SalMessageBox('Истек срок действия лицензии!', 'Bars: Лицензирование!', MB_Ok)
.head 6 -  Call SalQuit()
.head 5 +  Else
.head 6 +  If IsLicenseValid(GetBankMfo(), GetBankName(), nUsers, dtExpDate, FALSE)
.head 7 +  If dtExpDate - SalDateCurrent() < 31
.head 8 -  Call SalMessageBeep(MB_IconStop)
.head 8 -  Set ni2 = dtExpDate - SalDateCurrent()
.head 8 -  Call SalMessageBox('Срок действия лицензии истекает через ' || Str(ni2) || IifS(
     Mod(ni2, 10)>4 or Int(Mod(ni2, 100) / 10)=1, ' дней', IifS(Mod(ni2, 10)=1,
     ' день', ' дня')) || '!', 'Bars: Лицензирование!', MB_Ok)
.head 7 -  ! Основной вызов
.head 7 -  Call SalCreateWindow(frm_NOK, hWndNULL, 4)
.head 6 +  Else
.head 7 -  Call SalMessageBeep(MB_IconStop)
.head 7 -  Call SalMessageBox('Лицензия неверна или истек срок ее действия!',
     'Bars: Лицензирование!', MB_Ok)
.head 7 -  Call SalQuit()
.head 4 +  ! If DatabaseLogin()
.head 5 -  ! Call SetWorkBankDate(dtWBDate)
.head 5 -                  Set nUsers = GetGlobalOptionEx('USRLIMIT')
.head 5 -                  Set dtExpDate = SalFmtFormatStrDateTime(GetGlobalOption('EXPDATE'), 'dd/MM/yyyy')
.head 5 +                  If dtExpDate < SalDateCurrent()
.head 6 -                  Call SalMessageBeep(MB_IconStop)
.head 6 -                  Call SalMessageBox('Истек срок действия лицензии!', 'Bars: Лицензирование!', MB_Ok)
.head 6 -                  Call SalQuit()
.head 5 +                  Else
.head 6 +                  If IsLicenseValid(GetBankMfo(), GetBankName(), nUsers, dtExpDate)
.head 7 +                  If dtExpDate - SalDateCurrent() < 31
.head 8 -                  Call SalMessageBeep(MB_IconStop)
.head 8 -                  Call SalMessageBox('Срок действия лицензии истекает через ' ||
     Str(dtExpDate-SalDateCurrent()) || ' дней!', 'Bars: Лицензирование!', MB_Ok)
.head 7 -  ! Основной вызов
.head 7 -                  Call SalCreateWindow(frm_NOK, hWndNULL, 4)
.head 6 +                  Else
.head 7 -                  Call SalMessageBeep(MB_IconStop)
.head 7 -                  Call SalMessageBox('Лицензия неверна или истек срок ее действия!',
     'Bars: Лицензирование!', MB_Ok)
.head 7 -                  Call SalQuit()
.head 4 +  Else
.head 5 -  Call SalQuit()
.head 3 +  On SAM_SqlError
.head 4 -  Call ShowSqlError(wParam, lParam)
.head 4 -  Return FALSE
.head 3 +  On SAM_AppExit
.head 4 -  Call SaveInfoToLog(MSG_DisconnectDbs() || GetDbs())
.head 4 +  If hSqlAux3()
.head 5 -  Call SqlDisconnect(hSqlAux3())
.head 4 +  If hSqlAux2()
.head 5 -  Call SqlDisconnect(hSqlAux2())
.head 4 +  If hSqlAux()
.head 5 -  Call SqlDisconnect(hSqlAux())
.head 4 +  If hSql()
.head 5 -  Call SqlDisconnect(hSql())
.head 4 -  Call DBSpy_Disconnect()
.head 4 -  Call SalQuit()
.head 1 +  Form Window: frm_NOK
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Монитор Клиент-БАНК (прием пакетов документов / формирование выписок NOKK)
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? Yes
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? No
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Yes
.head 3 -  Minimizable? Yes
.head 3 -  System Menu? Yes
.head 3 -  Resizable? Yes
.head 3 -  Window Location and Size
.head 4 -  Left:   1.088"
.head 4 -  Top:    0.302"
.head 4 -  Width:  12.917"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 6.571"
.head 4 -  Height Editable? Yes
.head 3 -  Form Size
.head 4 -  Width:  Default
.head 4 -  Height: Default
.head 4 -  Number of Pages: Dynamic
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? No
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  Data Field: dTime
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cClock
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Date/Time
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.714"
.head 6 -  Top:    0.302"
.head 6 -  Width:  1.143"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Center
.head 5 -  Format: Class Default
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Pushbutton: pbRef
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cTimer
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выполнить
.head 4 -  Window Location and Size
.head 5 -  Left:   4.914"
.head 5 -  Top:    0.031"
.head 5 -  Width:  2.0"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.521"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Execute.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call pbRef.Init(nInterval, 0, TRUE)
.head 5 +  On UM_TimerFired
.head 6 -  ! new
.head 6 -  ! поставить проверку на отсутствие доступа к сетевым ресурсам:
  каталоги - strPath     параметры - NOKK_OUT
             sPathBad                NOKK_BAD
             strPath1                NOKK_IN
             strPath2                NOKK_PRINT
             strBKUPDir              BackUpDir
             strVipDir               NOKK_VipPath
             strTmpDir               NOKK_TmpPath
             sDPath                  NOKK_DPath
.head 6 +  If not VisDosExist(strPath)
.head 7 -  Call DoHera(nBeep, strPath)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || strPath || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(sPathBad)
.head 7 -  Call DoHera(nBeep, sPathBad)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || sPathBad || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(strPath1)
.head 7 -  Call DoHera(nBeep, strPath1)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || strPath1 || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(strPath2)
.head 7 -  Call DoHera(nBeep, strPath2)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || strPath2 || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(strBKUPDir)
.head 7 -  Call DoHera(nBeep, strBKUPDir)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || strBKUPDir || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(strVipDir)
.head 7 -  Call DoHera(nBeep, strVipDir)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || strVipDir || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(strTmpDir)
.head 7 -  Call DoHera(nBeep, strTmpDir)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || strTmpDir || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 +  If not VisDosExist(sDPath)
.head 7 -  Call DoHera(nBeep, sDPath)
.head 7 -  ! Call MessageNoWait('Отсутствует каталог ' || sDPath || ' ...', 'ВНИМАНИЕ!', 17, 1)
.head 7 -  ! Call SalQuit()
.head 6 -  ! Call Debug(SalFmtFormatDateTime(SalDateCurrent(), 'hhhh:mm:ss'))
.head 6 -  ! Call Debug('(' || SalFmtFormatDateTime(SalDateCurrent(), 'hhhh:mm:ss') || '--' || sAutoEnd || ')')
.head 6 +  ! If SalFmtFormatDateTime(SalDateCurrent(), 'hhhh:mm:ss') >= sAutoEnd
.head 7 +  If bDebug
.head 8 -  Call Debug('Истекло время работы программы (' || SalFmtFormatDateTime(SalDateCurrent(), 'hhhh:mm:ss') || '--' ||
   sAutoEnd || ') !')
.head 7 -  Call SalQuit()
.head 6 +  If Right('0' || SalFmtFormatDateTime(SalDateCurrent(), 'hhhh:mm:ss'), 8) >= sAutoEnd
.head 7 +  If bDebug
.head 8 -  Call Debug('Истекло время работы программы (' || Right('0' || SalFmtFormatDateTime(
     SalDateCurrent(), 'hhhh:mm:ss'), 8) || '--' || sAutoEnd || ') !')
.head 7 -  Call SalQuit()
.head 6 -  ! вставить обработку очереди rck_bck_que на предмет формирования файлов D для БЭКнутых RCKшных документов
.head 6 +  If bRckBckQue
.head 7 +  If SqlPrepareAndExecute(hSql(), "
   SELECT r.ref,w1.value,w2.value,nvl(w3.value,'1'),w4.value
   INTO :nRefBck,:sDatD,:sFileD,:sNumD,:sBack
   FROM rck_bck_que r, operw w1, operw w2, operw w3, operw w4
   WHERE w1.ref=r.ref and w1.tag='IDD  ' and w2.ref=r.ref and w2.tag='IDF  ' and w3.ref(+)=r.ref and
         w3.tag(+)='IDN  ' and w4.ref=r.ref and w4.tag='BACKR'")
.head 8 -  Set sRefBck = ''
.head 8 +  While SqlFetchNext(hSql(), nFetchRes)
.head 9 +  If MakeDRCK(sDatD, sFileD, sNumD, sBack)
.head 10 -  Set sRefBck = sRefBck || Str(nRefBck) || ','
.head 8 +  If Len(sRefBck) > 0
.head 9 -  Set sRefBck = Left(sRefBck, Len(sRefBck)-1)
.head 9 -  ! Call Debug(sRefBck)
.head 9 -  Call SqlPrepareAndExecute(hSql(), "
     DELETE
     FROM rck_bck_que
     WHERE ref in (" || sRefBck || ")")
.head 9 -  Call SqlCommit(hSql())
.head 6 -  !
.head 6 +  If cbOtDo and (dfDatOt > dfDatDo or AddMonths(dfDatOt, 1) <= dfDatDo)
.head 7 -  Call MessageNoWait('Некорректный диапазон дат !', 'Предупреждение', 7, 0)
.head 6 +  Else
.head 7 +  If not IsBankDayOpen()
.head 8 +  If bDebug
.head 9 -  Call Debug('Банковский День не открыт !')
.head 8 -  Call SalQuit()
.head 7 +  If SalStrTrimX(SalStrUpperX(GetDBMS())) = 'ORACLE'
.head 8 +  If SqlPLSQLCommand(hSql(), "bars_notifier_receive(nRet, dBDate, sStatus)")
.head 9 +  If nRet
.head 10 +  If dBDate = GetBankDate()
.head 11 +  If sStatus = 'CLOSED' OR sStatus = 'PROHIBITED'
.head 12 +  If bDebug
.head 13 -  Call Debug('Банковский День блокирован или запрещен !')
.head 12 -  Call SalQuit()
.head 10 -  Else If dBDate != GetBankDate()
.head 7 -  Call SalSendMsg(hWndForm, SAM_User, 0, 0)
.head 6 -  Set cbZAK = 0
.head 3 +  Child Table: tbKLI
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.083"
.head 6 -  Top:    0.905"
.head 6 -  Width:  12.35"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 4.845"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: 8
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: 10000
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: nRnk
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Рег
 №
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.883"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: sOKPO
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: OKPO
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.843"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nRnkP
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Рег №
патрона
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.883"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: dKli
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Наименование
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  4.967"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: dSab
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Эл.код
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.7"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: sXXX
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Сим
вып
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.486"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value: 1
.head 8 -  Uncheck Value: 0
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nFile  ! количество пакетов
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Кол-во
пак.
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.714"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nFile1 ! в т.ч. ОШ
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: в т.ч.
ОШ
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.571"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nFile2 ! в т.ч. УСП
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: в т.ч.
УСП
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.586"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nDo    ! количество документов
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Кол-во
док
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.686"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nDo1   ! в т.ч. ОШ
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: в т.ч.
ОШ
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.586"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nDo2   ! в т.ч. УСП
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: в т.ч.
УСП
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.586"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: nVip
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Выписок
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.883"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 -  Message Actions
.head 3 +  Check Box: cb1
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Платежи
.head 4 -  Window Location and Size
.head 5 -  Left:   0.286"
.head 5 -  Top:    0.146"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.135"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If cb1
.head 7 -  Set cbOtDo = 0
.head 7 -  Call SalHideWindow(dfOt)
.head 7 -  Call SalHideWindow(dfDatOt)
.head 7 -  Call SalHideWindow(dfDo)
.head 7 -  Call SalHideWindow(dfDatDo)
.head 3 +  Check Box: cb2
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выписки все
.head 4 -  Window Location and Size
.head 5 -  Left:   1.686"
.head 5 -  Top:    0.357"
.head 5 -  Width:  1.7"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.135"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If cb2
.head 7 -  Set cbOtDo = 0
.head 7 -  Set cbZAK = 0
.head 7 -  Call SalHideWindow(dfOt)
.head 7 -  Call SalHideWindow(dfDatOt)
.head 7 -  Call SalHideWindow(dfDo)
.head 7 -  Call SalHideWindow(dfDatDo)
.head 3 +  Check Box: cb21
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Вып. по оборотам
.head 4 -  Window Location and Size
.head 5 -  Left:   1.686"
.head 5 -  Top:    0.146"
.head 5 -  Width:  2.0"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.135"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If cb21
.head 7 -  Set cbOtDo = 0
.head 7 -  Set cbZAK = 0
.head 7 -  Call SalHideWindow(dfOt)
.head 7 -  Call SalHideWindow(dfDatOt)
.head 7 -  Call SalHideWindow(dfDo)
.head 7 -  Call SalHideWindow(dfDatDo)
.head 3 +  Check Box: cb3
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Сальдовки
.head 4 -  Window Location and Size
.head 5 -  Left:   0.286"
.head 5 -  Top:    0.357"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.135"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If cb3
.head 7 -  Set cbOtDo = 0
.head 7 -  Set cbZAK = 0
.head 7 -  Call SalHideWindow(dfOt)
.head 7 -  Call SalHideWindow(dfDatOt)
.head 7 -  Call SalHideWindow(dfDo)
.head 7 -  Call SalHideWindow(dfDatDo)
.head 3 +  Radio Button: rbAll
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Все
.head 4 -  Window Location and Size
.head 5 -  Left:   7.183"
.head 5 -  Top:    0.619"
.head 5 -  Width:  0.814"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 +  Radio Button: rbSelect
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выбранные
.head 4 -  Window Location and Size
.head 5 -  Left:   8.183"
.head 5 -  Top:    0.619"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 +  Data Field: dDAT
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Date/Time
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.714"
.head 6 -  Top:    0.031"
.head 6 -  Width:  1.143"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Center
.head 5 -  Format: Date
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 +  Message Actions
.head 5 +  On SAM_Validate
.head 6 +  If dDAT > GetBankDate()+5
.head 7 -  Call MessageNoWait('Невозможно задать дату больше банковской+5 !', 'Предупреждение', 7, 0)
.head 7 -  Set dDAT = dDATtek
.head 7 -  Return FALSE
.head 5 +  On SAM_SetFocus
.head 6 -  Set dDATtek = dDAT
.head 3 +  Pushbutton: pbFilter
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbFilter
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   10.5"
.head 5 -  Top:    0.071"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Установить фильтр'
.head 5 +  On SAM_Click
.head 6 +  If SetQueryFilter(cF)
.head 7 -  Call NASELENIE()
.head 3 +  Pushbutton: pb4
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbSearch
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   10.933"
.head 5 -  Top:    0.071"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \Bars98\RESOURCE\BMP\Updown.bmp
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Файлы за предыдущие дни'
.head 5 +  On SAM_Click
.head 6 +  If not IsWindow(hNOKF)
.head 7 -  Set hNOKF = SalCreateWindow(NOKF, hWndMDI, nStmt)
.head 3 +  Check Box: cbF
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Обраб. отлож. файлы
.head 4 -  Window Location and Size
.head 5 -  Left:   9.75"
.head 5 -  Top:    0.619"
.head 5 -  Width:  2.3"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   11.383"
.head 5 -  Top:    0.071"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Выйти'
.head 5 +  On SAM_Click
.head 6 -  Call pbRef.Kill()
.head 6 +  If SalMessageBox("Вы намерены выйти из программы ?", "Внимание !", MB_YesNo) = IDYES
.head 7 -  Call SalQuit()
.head 6 +  Else
.head 7 -  Return FALSE
.head 3 +  Data Field: dfSM
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: 1
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   11.833"
.head 6 -  Top:    0.106"
.head 6 -  Width:  0.433"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.321"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? No
.head 5 -  Justify: Center
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: 14
.head 5 -  Font Enhancement: Bold
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Radio Button: rbPlus
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Межбанк ПОДТВЕРЖДЕН
.head 4 -  Window Location and Size
.head 5 -  Left:   7.183"
.head 5 -  Top:    0.071"
.head 5 -  Width:  3.1"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Dark Green
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 +  Radio Button: rbMinus
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Межбанк НЕподтвержден
.head 4 -  Window Location and Size
.head 5 -  Left:   7.183"
.head 5 -  Top:    0.274"
.head 5 -  Width:  3.1"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Periwinkle
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 -  Frame
.head 4 -  Resource Id: 14868
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   7.083"
.head 5 -  Top:    0.048"
.head 5 -  Width:  3.217"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.524"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Solid
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: Default
.head 4 -  Background Color: Default
.head 3 +  Check Box: cbOtDo
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выписки по диапазону дат
.head 4 -  Window Location and Size
.head 5 -  Left:   0.283"
.head 5 -  Top:    0.619"
.head 5 -  Width:  3.067"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If cbOtDo
.head 7 -  Set cb1 = 0
.head 7 -  Set cb21 = 0
.head 7 -  Set cb3 = 0
.head 7 -  Set cb2 = 0
.head 7 -  Call SalShowWindow(dfOt)
.head 7 -  Call SalShowWindow(dfDatOt)
.head 7 -  Call SalShowWindow(dfDo)
.head 7 -  Call SalShowWindow(dfDatDo)
.head 7 +  If dfDatOt = DATETIME_Null
.head 8 -  Set dfDatOt = dDAT
.head 8 -  Set dfDatDo = dDAT
.head 6 +  Else
.head 7 -  Call SalHideWindow(dfOt)
.head 7 -  Call SalHideWindow(dfDatOt)
.head 7 -  Call SalHideWindow(dfDo)
.head 7 -  Call SalHideWindow(dfDatDo)
.head 3 +  Data Field: dfDatOt
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Date/Time
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.717"
.head 6 -  Top:    0.619"
.head 6 -  Width:  1.15"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Date
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 +  Message Actions
.head 5 +  ! On SAM_Validate
.head 6 -  Return IifN(dfDatOt>dfDatDo or AddMonths(dfDatOt, 1)<=dfDatDo, VALIDATE_Cancel, VALIDATE_Ok)
.head 3 +  Data Field: dfDatDo
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Date/Time
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   5.2"
.head 6 -  Top:    0.619"
.head 6 -  Width:  1.15"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Date
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 +  Message Actions
.head 5 +  ! On SAM_Validate
.head 6 -  Return IifN(dfDatDo<dfDatOt or AddMonths(dfDatOt, 1)<=dfDatDo, VALIDATE_Cancel, VALIDATE_Ok)
.head 3 +  Data Field: dfOt
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.35"
.head 6 -  Top:    0.655"
.head 6 -  Width:  0.35"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.167"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? No
.head 5 -  Justify: Right
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Data Field: dfDo
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   4.85"
.head 6 -  Top:    0.655"
.head 6 -  Width:  0.35"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.167"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? No
.head 5 -  Justify: Right
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  ! Data Field: dfInd
.winattr
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.0"
.head 6 -  Top:    0.0"
.head 6 -  Width:  0.15"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.15"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? No
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.end
.head 4 -  Message Actions
.head 3 +  Check Box: cbZAK
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Заключ.
.head 4 -  Window Location and Size
.head 5 -  Left:   1.683"
.head 5 -  Top:    0.5"
.head 5 -  Width:  1.7"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.131"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 2 +  Functions
.head 3 +  Function: Klient1_PL  ! Цикл по пакетам 1-го клиента
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: dSab
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sMaska
.head 5 -  String: sMass[*]
.head 5 -  Number: nKol
.head 5 -  Number: nTek
.head 4 +  Actions
.head 5 +  If IsBankDayOpen()
.head 6 +  If cbF ! обработка отложенных файлов (из strDopDir)
.head 7 -  ! Set sMaska = strDopDir || '\\^@' || dSab || DD || '.*'
.head 7 -  Set sMaska = strDopDir || '\\^@' || dSab || '*.*'
.head 7 -  Call SalArraySetUpperBound(sMass, 1, -1)
.head 7 -  Set nKol = VisDosEnumFiles(sMaska, FA_Standard, sMass)
.head 7 +  If nKol > 0 ! обработка файлов
.head 8 -  Set tbKLI.nFile = nKol
.head 8 -  Set tbKLI.nFile1 = 0
.head 8 -  Set tbKLI.nFile2 = 0
.head 8 -  Set tbKLI.nDo = 0
.head 8 -  Set tbKLI.nDo1 = 0
.head 8 -  Set tbKLI.nDo2 = 0
.head 8 -  Set bcbF = 1
.head 8 -  Set nTek = 0
.head 8 +  While nTek < nKol
.head 9 +  If not Kontrol1(sMass[nTek])
.head 10 -  Call SqlRollback(hSqlAux3())
.head 9 -  Set nTek = nTek + 1
.head 8 +  If tbKLI.nFile1 > 0
.head 9 -  Call SalTblSetCellTextColor(tbKLI.nFile1, COLOR_Red, FALSE)
.head 8 +  If tbKLI.nDo1 > 0
.head 9 -  Call SalTblSetCellTextColor(tbKLI.nDo1, COLOR_Red, FALSE)
.head 6 -  Set bcbF = 0
.head 6 -  ! обработка файлов из основной дир.
.head 6 -  Set sMaska = strPath1 || '\\^@' || dSab || '*.*'
.head 6 -  ! Set sMaska = strPath1 || '\\^@' || dSab || DD || '.*'
.head 6 -  ! Set sMaska = strPath1 || '\\^@' || dSab || DD || '.' || tbKLI.sXXX
.head 6 -  Call SalArraySetUpperBound(sMass, 1, -1)
.head 6 -  Set nKol = VisDosEnumFiles(sMaska, FA_Standard, sMass)
.head 6 -  ! Call DebugN(nKol)
.head 6 +  If nKol > 0 ! обработка файлов
.head 7 +  If tbKLI.nFile = NUMBER_Null
.head 8 -  Set tbKLI.nFile = nKol
.head 7 +  Else
.head 8 -  Set tbKLI.nFile = tbKLI.nFile + nKol
.head 7 +  If tbKLI.nFile1 = NUMBER_Null
.head 8 -  Set tbKLI.nFile1 = 0
.head 7 +  If tbKLI.nFile2 = NUMBER_Null
.head 8 -  Set tbKLI.nFile2 = 0
.head 7 +  If tbKLI.nDo = NUMBER_Null
.head 8 -  Set tbKLI.nDo = 0
.head 7 +  If tbKLI.nDo1 = NUMBER_Null
.head 8 -  Set tbKLI.nDo1 = 0
.head 7 +  If tbKLI.nDo2 = NUMBER_Null
.head 8 -  Set tbKLI.nDo2 = 0
.head 7 -  Set nTek = 0
.head 7 +  While nTek < nKol
.head 8 +  If not Kontrol1(sMass[nTek])
.head 9 -  Call SqlRollback(hSqlAux3())
.head 8 -  Set nTek = nTek + 1
.head 7 +  If tbKLI.nFile1 > 0
.head 8 -  Call SalTblSetCellTextColor(tbKLI.nFile1, COLOR_Red, FALSE)
.head 7 +  If tbKLI.nDo1 > 0
.head 8 -  Call SalTblSetCellTextColor(tbKLI.nDo1, COLOR_Red, FALSE)
.head 5 -  Return TRUE
.head 3 +  Function: Kontrol1    ! контроль 1-го пакета (Сухова)
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  String: sFile
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: hF
.head 5 -  String: sTmp
.head 5 -  Number: bOk
.head 5 -  Number: i
.head 5 -  String: sStr
.head 5 -  Number: sum
.head 5 -  Number: nRP
.head 5 -  File Handle: hFile
.head 5 -  !
.head 5 -  Date/Time: dDatP
.head 5 -  Boolean: bRet
.head 4 +  Actions
.head 5 -  Set sErrMes = '???'
.head 5 +  Loop
.head 6 -  Set i = 0
.head 6 +  While i < nErr
.head 7 -  Set sMErr[i,1] = '0'
.head 7 -  Set i = i + 1
.head 6 +  If bcbF = 1
.head 7 -  Set hF = llopen(strDopDir || '\\' || sFile, 2)
.head 6 +  Else
.head 7 -  Set hF = llopen(strPath1 || '\\' || sFile, 2)
.head 6 +  If hF <= 0
.head 7 -  Set tbKLI.nFile1 = tbKLI.nFile1 + 1
.head 7 -  Set sErrMes = 'Невозможно открыть'
.head 7 -  Set bOk = -1 ! ~ FALSE файл не убивать
.head 7 -  Break
.head 6 -  Set bOk = 0 ! ~ FALSE
.head 6 -  Set sTmp = Spac(12)
.head 6 -  Call lllseek(hF, 102, FILE_SeekBegin)
.head 6 -  Call llread(hF, sTmp, 12)
.head 6 +  If sTmp != '$' || Subs(sFile, 2, 11)
.head 7 -  Set tbKLI.nFile1 = tbKLI.nFile1 + 1
.head 7 -  Set sErrMes = 'Ош.Имени /в заголовке ' || sTmp
.head 7 -  ! Call llclose(hF)
.head 7 -  Break
.head 6 -  Call llread(hF, sTmp, 12)
.head 6 -  Set dDatP = SalDateConstruct(2000+Val(Subs(sTmp, 1, 2)), Val(Subs(sTmp, 3, 2)), Val(Subs(sTmp, 5, 2)), 0, 0, 0)
.head 6 +  If dDatP > GetBankDate() or dDatP+30 <= GetBankDate()
.head 7 -  Set tbKLI.nFile1 = tbKLI.nFile1 + 1
.head 7 -  Set sErrMes = 'Ош.даты /в заголовке ' || SalFmtFormatDateTime(dDatP, 'dd/MM/yyyy ') || '(' || Left(sTmp, 6) || ')'
.head 7 -  ! Call llclose(hF)
.head 7 -  Break
.head 6 +  If not Kontrol2(hF, sFile)
.head 7 -  Set tbKLI.nFile1 = tbKLI.nFile1 + 1
.head 7 -  ! Call Debug('Файл ' || sFile || ' Ош.ЭЦП')
.head 7 -  ! Call llclose(hF)
.head 7 -  Break
.head 6 +  If not Paket1(hF, sFile)
.head 7 -  Set tbKLI.nFile1 = tbKLI.nFile1 + 1
.head 7 -  ! Call Debug('Файл ' || sFile || ' Ош.в платежах')
.head 7 -  ! Call llclose(hF)
.head 7 -  Break
.head 6 -  Set tbKLI.nFile2 = tbKLI.nFile2 + 1
.head 6 -  Set bOk = 1 ! ~ TRUE
.head 6 -  Break
.head 5 -  Set i = 0
.head 5 -  Set sum = 0
.head 5 +  While i < nErr
.head 6 -  Set sum = sum + Val(sMErr[i,1])
.head 6 -  Set i = i + 1
.head 5 +  If sum > 0
.head 6 -  Set sStr = ''
.head 6 -  Set i = 0
.head 6 +  While i < nErr
.head 7 +  If sMErr[i,1] = '1'
.head 8 -  Set sStr = sStr || sMErr[i,0] || '
'
.head 7 -  Set i = i + 1
.head 6 +  If sum >= 1 and (sMErr[0,1] = '1' or sMErr[7,1] = '1')
.head 7 -  Call SalModalDialog(dlg_Err, hWndMDI, 0, sStr, sFile, nRP)
.head 6 +  Else
.head 7 -  Call SalModalDialog(dlg_Err, hWndMDI, 1, sStr, sFile, nRP)
.head 6 +  If nRP = 2 ! было 1
.head 7 -  Set bOk = 2
.head 6 +  Else If nRP = 1 ! было 2
.head 7 +  ! If sum > 1 and sMErr[0,1] = '1'
.head 8 -  ! файл - в доп. дир., для ош.ОКПО-квит.
.head 8 -  Set bOk = 3
.head 7 +  ! If sum >= 1 and sMErr[0,1] != '1'
.head 8 -  ! файл - в доп. дир.
.head 8 -  Set bOk = 3
.head 7 -  Set bOk = 4
.head 6 +  Else If nRP = 3 ! новьё
.head 7 -  Set bOk = 5
.head 5 -  Set bRet = TRUE
.head 5 +  If bOk = 0 or bOk = -1 or bOk = -2
.head 6 -  Call SqlRollback(hSqlAux3())
.head 5 +  If bOk = 0 or bOk = 1 or bOk = 2 or bOk = 3 or bOk = 4 or bOk = 5
.head 6 -  Call llclose(hF)
.head 5 +  If bOk = 0 or bOk = -1 or bOk = -2
.head 6 -  ! Call MessageError('Файл ' || sFile || ': ' || sErrMes)
.head 6 -  ! Call ToLog('Файл ' || sFile || ': ' || sErrMes)
.head 6 -  Call ToLog('-' || sFile || ': ' || sErrMes)
.head 6 -  Call ToLog('')
.head 5 +  If (bOk = 0 or bOk = 1 or bOk = -2) and bcbF = 0
.head 6 -  Call BackUpFile(bOk, strPath1, sFile)
.head 5 +  If (bOk = 0 or bOk = 1) and bcbF = 1
.head 6 -  Call BackUpFile(bOk, strDopDir, sFile)
.head 5 +  If bOk = 3
.head 6 -  Call SalFileCopy(strPath1 || '\\' || sFile, strDopDir || '\\' || sFile, TRUE)
.head 6 -  Call SalFileOpen(hFile, strPath1 || '\\' || sFile, OF_Delete)
.head 5 +  If bOk = 4
.head 6 -  ! сформировать квитанцию
.head 6 -  ! Call Kvit(sFile, sErrMes, nNumStrG, sFNG, nPNG, nPNnewG)
.head 6 -  Set bRet = Kvit(sFile, sErrMes, 1, sFNG, nPNG, nPNnewG)
.head 6 -  ! создать подкаталог YYYYMMDD от BANKDATE в каталоге NOKK_BAD (sPathBad) и туда переместить пакет
.head 6 -  Set sYYYYMMDD = SalFmtFormatDateTime(GetBankDate(), 'yyyyMMdd')
.head 6 -  Call SalFileCreateDirectory(sPathBad || '\\' || sYYYYMMDD)
.head 6 -  Call SalFileCopy(strPath1 || '\\' || sFile, sPathBad || '\\' || sYYYYMMDD || '\\' || sFile, TRUE)
.head 6 -  Call SalFileOpen(hFile, strPath1 || '\\' || sFile, OF_Delete)
.head 5 +  If bOk = 5
.head 6 -  ! создать подкаталог YYYYMMDD от BANKDATE в каталоге NOKK_BAD (sPathBad) и туда переместить пакет
.head 6 -  Set sYYYYMMDD = SalFmtFormatDateTime(GetBankDate(), 'yyyyMMdd')
.head 6 -  Call SalFileCreateDirectory(sPathBad || '\\' || sYYYYMMDD)
.head 6 -  Call SalFileCopy(strPath1 || '\\' || sFile, sPathBad || '\\' || sYYYYMMDD || '\\' || sFile, TRUE)
.head 6 -  Call SalFileOpen(hFile, strPath1 || '\\' || sFile, OF_Delete)
.head 5 -  Return bRet
.head 3 +  Function: Kontrol2    ! контроль 1-го пакета (Миша)
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Number: hF
.head 5 -  String: sFile
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sTmp
.head 5 -  Long String: lsSign
.head 5 -  String: sRxxIkk
.head 5 -  Number: nN
.head 5 -  Number: nErrorSign
.head 4 +  Actions
.head 5 +  If not bPDP
.head 6 -  Return TRUE ! Убрать после с согласования с НОК
.head 5 -  !
.head 5 -  Set sRxxIkk = Spac(6)
.head 5 -  Set lsSign = Spac(64)
.head 5 +  If GetSignOn() = 0 ! ЭЦП отключена - вернуть Пусто
.head 6 -  Return TRUE
.head 5 +  If not bIni
.head 6 +  If not ccDoc.sIni()
.head 7 -  Return FALSE
.head 6 +  Else
.head 7 -  Set bIni = TRUE
.head 5 -  ! Call lllseek(hF, 102+60+64, FILE_SeekBegin)
.head 5 -  ! Call llread(hF, sRxxIkk, 6) ! имя ключа
.head 5 -  ! Call lllseek(hF, 102+130, FILE_SeekBegin)
.head 5 -  ! Call llread(hF, lsSign, 64)
.head 5 -  ! Call lllseek(hF, 0, FILE_SeekBegin)
.head 5 -  ! Set nErrorSign = RSA_ZAH0(82, hF, 1, 102, 130, 0, lsSign, sRxxIkk)
.head 5 +  ! If nErrorSign
.head 6 -  Call Debug('Файл ' || sFile || ' Ош.ЭЦП ' || Str(nErrorSign))
.head 6 -  Return FALSE
.head 5 -  ! Set sTmp = Spac(6)
.head 5 -  ! Call lllseek(hF, 102+22, FILE_SeekBegin)
.head 5 -  ! Call llread(hF, sTmp, 6) ! К-во строк в файле
.head 5 -  ! Set nN = SalStrToNumber(sTmp)
.head 5 +  ! If nN ! Проверить подпись на файл, если есть строки
.head 6 -  Call lllseek(hF, 102+60, FILE_SeekBegin)
.head 6 -  Call llread(hF, lsSign, 64)
.head 6 -  Call lllseek(hF, 0, FILE_SeekBegin)
.head 6 -  Set nErrorSign = RSA_ZAH0(82, hF, nN, 298, 444, 594, lsSign, sRxxIkk)
.head 6 +  If nErrorSign
.head 7 -  Call Debug('Файл ' || sFile || ' Ош.ЭЦП ' || Str(nErrorSign))
.head 7 -  Return FALSE
.head 5 -  Call lllseek(hF, 102+196+428, FILE_SeekBegin)
.head 5 -  Call llread(hF, sRxxIkk, 6) ! имя ключа
.head 5 -  ! Call Debug(sRxxIkk)
.head 5 -  Call lllseek(hF, 102+196+444, FILE_SeekBegin)
.head 5 -  Call llread(hF, lsSign, 64)
.head 5 -  Set nErrorSign = RSA_ZAH0(82, hF, 1, 298, 444, 0, lsSign, sRxxIkk)
.head 5 +  If nErrorSign
.head 6 -  Call Debug('Файл ' || sFile || ' Ош.ЭЦП ' || Str(nErrorSign))
.head 6 -  Return FALSE
.head 5 -  Return TRUE
.head 3 +  Function: Paket1      ! Обработка 1-го пакета
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Number: hF
.head 5 -  String: sFile
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sTmp
.head 5 -  Number: nKol
.head 5 -  Number: nTek
.head 5 -  Number: nT
.head 5 -  String: sT
.head 5 -  Number: nRRR
.head 5 -  Boolean: bGood
.head 5 -  !
.head 5 -  String: sFN
.head 5 -  Number: nPN
.head 5 -  Number: nPNnew
.head 5 -  String: sDatF
.head 5 -  String: sNumP
.head 4 +  Actions
.head 5 -  ! для каждого пакета формируем файл-квитанцию sFN с порядковым номером nPNnew (заносим в zag_nok)
  (если пакет обработан без ошибок, файл sFN удаляем из zag_nokk)
.head 5 -  Set sFN = '^D' || tbKLI.dSab || DD || '.*'
.head 5 -  Set nPN = 0
.head 5 -  Set nPNnew = 0
.head 5 -  Call SqlPrepareAndExecute(hSqlAux(), "
     SELECT rec
     INTO :nPN
     FROM ZAG_NOK
     WHERE fn=:sFN")
.head 5 -  Set bGood = not SqlFetchNext(hSqlAux(), nFetchRes)
.head 5 +  If bGood
.head 6 -  Call SqlPrepareAndExecute(hSqlAux(), "
     INSERT
     INTO ZAG_NOK (fn,rec,dat)
     VALUES (:sFN,0,sysdate)")
.head 6 -  Call SqlCommit(hSqlAux())
.head 5 -  !
.head 5 -  Call lllseek(hF, 114, FILE_SeekBegin)
.head 5 -  Set sTmp = Spac(6)
.head 5 -  Call llread(hF, sTmp, 6)
.head 5 -  Set sDatF = SalFmtFormatDateTime(SalDateConstruct(2000+Val(Subs(sTmp, 1, 2)), Val(Subs(sTmp, 3, 2)), Val(
    Subs(sTmp, 5, 2)), 0, 0, 0), 'yyyy/MM/dd')
.head 5 -  !
.head 5 -  Call lllseek(hF, 124, FILE_SeekBegin)
.head 5 -  Set sTmp = Spac(6)
.head 5 -  Call llread(hF, sTmp, 6)
.head 5 -  Set nKol = Val(sTmp)
.head 5 -  Set tbKLI.nDo = tbKLI.nDo + nKol
.head 5 -  Set nTek = 0
.head 5 +  While nTek < nKol
.head 6 -  Set sTmp = Spac(Val(sTipPDP)*90+420)
.head 6 -  Call lllseek(hF, 297+(Val(sTipPDP)*90+594)*nTek, FILE_SeekBegin)
.head 6 -  Call llread(hF, sTmp, Val(sTipPDP)*90+420)
.head 6 +  If Oplata1(sTmp, sFile, sDatF, nTek+1, sFN, nPN, nPNnew)
.head 7 -  Set nT = nTek + 1
.head 7 -  ! Call Debug(sFile)
.head 7 -  ! Call DebugN(nT)
.head 7 -  If SqlPrepareAndExecute(hSqlAux2(), "
   SELECT rec
   INTO :nRRR
   FROM ZAG_NOK
   WHERE fn=:sFile and rec=:nT") and SqlFetchNext(hSqlAux2(), nFetchRes)
.head 7 +  Else
.head 8 -  Set nRRR = 0
.head 7 -  Set bGood = nRRR=nT
.head 7 +  If not bGood
.head 8 +  If nRRR = 0
.head 9 -  Call SqlPrepareAndExecute(hSqlAux2(), "
     INSERT
     INTO ZAG_NOK (fn,rec,dat)
     VALUES (:sFile,:nT,sysdate)")
.head 9 -  Set tbKLI.nDo2 = tbKLI.nDo2 + 1 ! хорошо
.head 9 -  ! поставить COMMIT (документ оплачен + insert into zag_nokk)
.head 9 -  Call SqlCommit(hSqlAux2())
.head 9 -  ! Set sT = '+' || sFile || ': ' || Subs(sTmp, 5, 75)
.head 9 -  ! Call ToLog(sT)
.head 9 -  Call ToLog('+' || sFile || ': ' || Subs(sTmp, 5, 75))
.head 9 -  ! Call SalStatusSetText(hWndForm, sT)
.head 8 +  Else
.head 9 -  Set tbKLI.nDo1 = tbKLI.nDo1 + 1 ! плохо
.head 9 -  ! документ уже оплачен, повторно не оплачиваем (возникает при повторной обработке файла)
.head 9 -  Call SqlRollback(hSqlAux2())
.head 9 -  ! Set sT = '-' || sFile || ': ' || Subs(sTmp, 5, 75) || PutCrLf() || Spac(18) || 'повторная обработка файла'
.head 9 -  ! Call ToLog(sT)
.head 9 -  Call ToLog('-' || sFile || ': ' || Subs(sTmp, 5, 75) || PutCrLf() || Spac(18) || 'повторная обработка файла')
.head 9 -  ! Call SalStatusSetText(hWndForm, sT)
.head 7 +  Else
.head 8 -  Set tbKLI.nDo1 = tbKLI.nDo1 + 1 ! плохо
.head 8 -  ! документ уже оплачен, повторно не оплачиваем (возникает при повторной обработке файла)
.head 8 -  Call SqlRollback(hSqlAux2())
.head 8 -  ! Set sT = '-' || sFile || ': ' || Subs(sTmp, 5, 75) || PutCrLf() || Spac(18) || 'повторная обработка файла'
.head 8 -  ! Call ToLog(sT)
.head 8 -  Call ToLog('-' || sFile || ': ' || Subs(sTmp, 5, 75) || PutCrLf() || Spac(18) || 'повторная обработка файла')
.head 8 -  ! Call SalStatusSetText(hWndForm, sT)
.head 6 +  Else
.head 7 -  Set tbKLI.nDo1 = tbKLI.nDo1 + 1 ! плохо
.head 7 -  ! поставить ROLLBACK и закомментировать Return FALSE
.head 7 -  Call SqlRollback(hSqlAux2())
.head 7 -  ! Set sT = '-' || sFile || ': ' || Subs(sTmp, 5, 75) || PutCrLf() || Spac(18) || 'повторная обработка файла'
.head 7 -  ! Call ToLog(sT)
.head 7 -  Call ToLog('-' || sFile || ': ' || Subs(sTmp, 5, 75) || PutCrLf() || Spac(18) || sErrMes)
.head 7 -  ! Call SalStatusSetText(hWndForm, sT)
.head 7 -  ! Return FALSE
.head 6 -  Set nTek = nTek + 1
.head 5 +  If nPNnew != 0
.head 6 -  ! Call Debug('UPDATE ZAG_NOK ' || Str(nPNnew))
.head 6 -  Call SqlPrepareAndExecute(hSqlAux(), "
     UPDATE ZAG_NOK
     SET rec=:nPNnew
     WHERE fn=:sFN")
.head 6 -  ! Call BackUpFile(1, IifS(bcbF=0, strPath1, strDopDir), sFile)
.head 5 +  Else
.head 6 -  ! Call Debug('DELETE FROM ZAG_NOK ' || Str(nPNnew))
.head 6 -  Call SqlPrepareAndExecute(hSqlAux(), "
     DELETE FROM ZAG_NOK
     WHERE fn=:sFN")
.head 6 -  ! Call BackUpFile(0, IifS(bcbF=0, strPath1, strDopDir), sFile)
.head 5 -  Call SqlCommit(hSqlAux())
.head 5 -  Call ToLog('')
.head 5 -  ! Call SalStatusSetText(hWndForm, '')
.head 5 -  Return nPNnew=0
.head 3 +  Function: Oplata1     ! Оплата 1-го документа
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sTmp
.head 5 -  String: sFile
.head 5 -  String: sDatF
.head 5 -  !
.head 5 -  Number: nNumStr
.head 5 -  String: sFN
.head 5 -  Number: nPN
.head 5 -  Receive Number: nPNnew
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nOSTB   !! Плановый остаток
.head 5 -  Number: nOSTB8  !! Плановый неиспользованный лимит
.head 5 -  Number: nRef    !! референс (NUMBER_Null для новых)
.head 5 -  String: sTT     !! Код операции
.head 5 -  Number: nIsp
.head 5 -  String: sNMS    !! Наим. счёта
.head 5 -  Number: nVob    !! Вид обработки
.head 5 -  String: sNd     !! № док
.head 5 -  Date/Time: dDoc !! Дата док
.head 5 -  Date/Time: dPos !! Дата ввода(поступления в банк)
.head 5 -  String: sNls1   !! Счёт-А
.head 5 -  String: sNam1   !! Наим-А
.head 5 -  Number: nKv1    !! Код вал-А
.head 5 -  Number: nS1     !! Сумма-А
.head 5 -  String: sOkpo1  !! ОКПО-А
.head 5 -  String: sNls2   !! Счёт-Б
.head 5 -  String: sNam2   !! Наим-Б
.head 5 -  String: sBank2  !! МФО-Б
.head 5 -  String: sOkpo2  !! ОКПО-Б (м.б. '')
.head 5 -  String: sNazn   !! Назначение пл
.head 5 -  String: sDrec   !! Доп реквизиты
.head 5 -  Number: nI      !! счётчик
.head 5 -  !
.head 5 -  String: smToken[*]
.head 5 -  !
.head 5 -  String: sP1
.head 5 -  String: sP2
.head 4 +  Actions
.head 5 +  If Subs(sTmp, 48, 1) = '2' ! (для НОКК DK)
.head 6 -  ! проверить свой ли счёт
.head 6 -  Set sNls1 = SalStrTrimX(Subs(sTmp, 11, 14))
.head 6 -  Set nKv1 = IifN(Subs(sTmp, 388, 3)='   ', GetBaseVal(), GetKv(Subs(sTmp, 388, 3)))
.head 6 -  ! If SqlPrepareAndExecute(hSqlAux2(), '
   SELECT a.acc,a.isp,a.ostb,a.nms
   INTO :nRef,:nIsp,:nOSTB,:sNMS
   FROM accounts a, cust_acc cu, customer c
   WHERE a.nls=:sNls1 and a.kv=:nKv1 and a.pap=2 and a.acc=cu.acc and cu.rnk=c.rnk and c.sab=:tbKLI.dSab') and
   SqlFetchNext(hSqlAux2(), nFetchRes)
.head 6 -  ! --------------------------------------- !
.head 6 -  ! УБРАНО: and a.pap=2 из верхнего SELECTа !
.head 6 -  ! --------------------------------------- !
.head 6 +  If SqlPrepareAndExecute(hSqlAux2(), '
   SELECT a.acc,a.isp,a.ostb,a.nms
   INTO :nRef,:nIsp,:nOSTB,:sNMS
   FROM accounts a, cust_acc cu, customer c
   WHERE a.nls=:sNls1 and a.kv=:nKv1 and a.acc=cu.acc and cu.rnk=c.rnk and c.sab=:tbKLI.dSab') and
   SqlFetchNext(hSqlAux2(), nFetchRes)
.head 7 -  Set nVob = Val(Subs(sTmp, 65, 2))
.head 7 -  Set sNd = SalStrTrimX(StrDosToWinX(Subs(sTmp, 67, 10)))
.head 7 -  Set dDoc = IifD(Subs(sTmp, 80, 6)=Spac(6), GetBankDate(), SalDateConstruct(2000+Val(Subs(sTmp, 80, 2)), Val(
    Subs(sTmp, 82, 2)), Val(Subs(sTmp, 84, 2)), 0, 0, 0))
.head 7 -  Set dPos = SalDateCurrent() !! дата поступления в БАНК - текущая системная
.head 7 -  Set sNam1 = SalStrTrimX(StrDosToWinX(Subs(sTmp, 92, 38)))
.head 7 -  Set nS1 = Val(Subs(sTmp, 49, 16))
.head 7 -  Set sOkpo1 = SalStrTrimX(Subs(sTmp, 393, 14))
.head 7 +  If Str(Val(sOkpo1)) != sOkpo1 and (Left(sOkpo1, 1) < '0' or Left(sOkpo1, 1) > '9')
   !! есть нецифры - интерпретируем как номер паспорта
.head 8 -  Set sP1 = StrDosToWinX(sOkpo1)
.head 8 -  Set sOkpo1 = '0000000000'
.head 7 +  Else
.head 8 -  Set sP1 = ''
.head 7 +  If sOkpo1 = '0' or sOkpo1 = '' or V_Okpo(sOkpo1) != sOkpo1
.head 8 -  Set sErrMes = 'Док.' || sNd || ' не оплачен (неверен ОКПО А)'
.head 8 -  Set sMErr[0,1] = '1'
.head 8 -  ! сформировать квитанцию
.head 8 -  ! Call Kvit(sFile, sErrMes, nNumStr, sFN, nPN, nPNnew)
.head 8 -  Set nNumStrG = nNumStr
.head 8 -  Set sFNG = sFN
.head 8 -  Set nPNG = nPN
.head 8 -  Set nPNnewG = nPNnew
.head 8 -  Return FALSE
.head 7 -  Set sOkpo2 = SalStrTrimX(Subs(sTmp, 407, 14))
.head 7 +  If Str(Val(sOkpo2)) != sOkpo2 and (Left(sOkpo2, 1) < '0' or Left(sOkpo2, 1) > '9')
   !! есть нецифры - интерпретируем как номер паспорта
.head 8 -  Set sP2 = StrDosToWinX(sOkpo2)
.head 8 -  Set sOkpo2 = '0000000000'
.head 7 +  Else
.head 8 -  Set sP2 = ''
.head 7 +  If sOkpo2 = '0' or sOkpo2 = '' or V_Okpo(sOkpo2) != sOkpo2
.head 8 -  Set sErrMes = 'Док.' || sNd || ' не оплачен (неверен ОКПО Б)'
.head 8 -  Set sMErr[0,1] = '1'
.head 8 -  ! сформировать квитанцию
.head 8 -  ! Call Kvit(sFile, sErrMes, nNumStr, sFN, nPN, nPNnew)
.head 8 -  Set nNumStrG = nNumStr
.head 8 -  Set sFNG = sFN
.head 8 -  Set nPNG = nPN
.head 8 -  Set nPNnewG = nPNnew
.head 8 -  Return FALSE
.head 7 -  Set sNls2 = SalStrTrimX(Subs(sTmp, 34, 14))
.head 7 -  Set sNam2 = SalStrTrimX(StrDosToWinX(Subs(sTmp, 130, 38)))
.head 7 -  Set sBank2 = SalStrTrimX(Subs(sTmp, 25, 9))
.head 7 +  ! If sBank2 = GetBankMfo() and sOkpo2 != GetValueStr("
   SELECT c.okpo
   FROM customer c, cust_acc cu, accounts a
   WHERE a.nls='" || sNls2 || "' and a.kv=" || Str(nKv1) || " and a.acc=cu.acc and cu.rnk=c.rnk")
.head 8 -  Set sErrMes = 'Док.' || sNd || ' не оплачен (неверен счёт Б или ОКПО Б)'
.head 8 -  Set sMErr[0,1] = '1'
.head 8 -  ! сформировать квитанцию
.head 8 -  Call Kvit(sFile, sErrMes, nNumStr, sFN, nPN, nPNnew)
.head 8 -  Return FALSE
.head 7 +  If sBank2 = GetBankMfo() and not VerifyNls(sNls2, nKv1)
.head 8 -  Set sErrMes = 'Док.' || sNd || ' не оплачен (неверен счёт Б)'
.head 8 -  Set sMErr[7,1] = '1'
.head 8 -  ! сформировать квитанцию
.head 8 -  ! Call Kvit(sFile, sErrMes, nNumStr, sFN, nPN, nPNnew)
.head 8 -  Set nNumStrG = nNumStr
.head 8 -  Set sFNG = sFN
.head 8 -  Set nPNG = nPN
.head 8 -  Set nPNnewG = nPNnew
.head 8 -  Return FALSE
.head 7 +  If sBank2 = GetBankMfo() and not VerifyOkpo(sNls2, nKv1, sOkpo2)
.head 8 -  Set sErrMes = 'Док.' || sNd || ' не оплачен (неверен код ОКПО Б)'
.head 8 -  Set sMErr[0,1] = '1'
.head 8 -  ! сформировать квитанцию
.head 8 -  ! Call Kvit(sFile, sErrMes, nNumStr, sFN, nPN, nPNnew)
.head 8 -  Set nNumStrG = nNumStr
.head 8 -  Set sFNG = sFN
.head 8 -  Set nPNG = nPN
.head 8 -  Set nPNnewG = nPNnew
.head 8 -  Return FALSE
.head 7 -  !
.head 7 -  ! бюджетные платежи в случае, если сумма документа больше планового остатка, помещаются в К-2
.head 7 -  ! Нет денег
.head 7 +  If nOSTB < nS1
.head 8 -  ! Лимит
.head 8 -  Call SqlPrepareAndExecute(hSqlAux2(), T('
     SELECT a8.ostb
     INTO :nOSTB8
     FROM accounts a8, v862 v
     WHERE v.acc6=:nRef and v.acc8=a8.acc and a8.ostb>0'))
.head 8 +  If not SqlFetchNext(hSqlAux2(), nFetchRes)
.head 9 -  Set nOSTB8 = 0
.head 8 -  ! Лимит есть
.head 8 +  If nOSTB+nOSTB8 >= nS1
.head 9 -  Set sTT = 'KL' || IifS(Val(AMFO)=Val(sBank2), '3', '4')
.head 8 -  ! Лимита нет, ждите поступлений
.head 8 +  Else
.head 9 -  Set sTT = 'KL' || IifS(Val(AMFO)=Val(sBank2), '1', '2')
.head 7 -  ! Деньги есть платим
.head 7 +  Else
.head 8 -  Set sTT = 'KL' ||IifS(Val(AMFO)=Val(sBank2), '1', '2')
.head 7 -  Set sNazn = SalStrTrimX(StrDosToWinX(Subs(sTmp, 168, 160)))
.head 7 -  ! Set nI = bank('~', sNazn)
.head 7 -  Set nI = SalStrTokenize(' ' || sNazn || ' ', '', '~', smToken)
.head 7 +  If nI = 3 and bRCK and Right(SalStrTrimX(sNazn), 1) = '~'
.head 8 -  Set sNazn = smToken[0]
.head 8 -  Set sTilda = smToken[1]
.head 7 +  Else
.head 8 -  Set sTilda = ''
.head 7 -  Set sDrec = SalStrTrimX(StrDosToWinX(Subs(sTmp, 328, 60)))
.head 7 +  If Len(sP1) > 0
.head 8 -  Set sDrec = IifS(Len(sDrec)=0, '#Ф' || sP1 || '#', sDrec || 'Ф' || sP1 || '#')
.head 7 +  If Len(sP2) > 0
.head 8 -  Set sDrec = IifS(Len(sDrec)=0, '#ф' || sP2 || '#', sDrec || 'ф' || sP2 || '#')
.head 7 -  ! добавлено, возможно надо убрать ---
.head 7 -  Set nI = At('#D', sDrec)
.head 7 +  If nI > 0
.head 8 +  If SalDateConstruct(2000+Val(Subs(sDrec, nI+3, 2)), Val(Subs(sDrec, nI+5, 2)), Val(Subs(sDrec, nI+7, 2)), 0, 0, 0)
   <= GetBankDate()
.head 9 -  Set sDrec = VisStrSubstitute(sDrec, Subs(sDrec, nI, 9), '#')
.head 9 +  If sDrec = '#'
.head 10 -  Set sDrec = ''
.head 7 -  ! добавлено, возможно надо убрать ---
.head 7 -  Set nRef = NUMBER_Null
.head 7 +  If sBank2 = GetBankMfo()
.head 8 -  Set sNam1 = Subs(sNMS, 1, 38)
.head 7 -  Call ccDoc.SetDoc(nRef, sTT, 1, nVob, sNd, dDoc, dPos, GetBankDate(), GetBankDate(), sNls1, sNam1, GetBankMfo(), '',
     nKv1, nS1, sOkpo1, sNls2, sNam2, sBank2, '', nKv1, nS1, sOkpo2, sNazn, sDrec, GetIdOper(), '', NUMBER_Null, 0)
.head 7 -  ! Set ccDoc.m_nTim = 1440
.head 7 -  Set g_nTim = 1440
.head 7 -  Set ccDoc.m_nNom = nS1 - Max(nOSTB, 0)
.head 7 -  Set ccDoc.s8 = sOkpo2 !! Subs(sTmp, 407, 14)
.head 7 -  Set ccDoc.sFile = sFile
.head 7 -  Set ccDoc.sTilda = sTilda
.head 7 -  Set ccDoc.sDatF = sDatF
.head 7 -  Set ccDoc.sNumP = Str(nNumStr)
.head 7 +  If ccDoc.oDoc()
.head 8 -  Return TRUE
.head 7 +  Else
.head 8 +  If ccDoc.sMsg
.head 9 -  Set sErrMes = ccDoc.sMsg
.head 9 +  If ccDoc.sKod4
.head 10 -  Set sMErr[4,1] = ccDoc.sKod4
.head 9 +  If ccDoc.sKod5
.head 10 -  Set sMErr[5,1] = ccDoc.sKod5
.head 8 +  Else
.head 9 -  Set sErrMes = 'Док на сумму ' || Str(nS1) || ' не опл'
.head 9 -  Set sMErr[1,1]= '1'
.head 8 -  Return FALSE
.head 6 +  Else
.head 7 -  Set sErrMes = 'Счёт ' || sNls1 || '/' || Str(nKv1) || ' не доступен клиенту ' || tbKLI.nRnk
.head 7 -  Set sMErr[2,1] = '1'
.head 7 -  Return FALSE
.head 5 +  Else
.head 6 -  Set sErrMes = 'Ош DK # 2'
.head 6 -  Set sMErr[3,1] = '1'
.head 6 -  Return FALSE
.head 3 +  Function: Klient1_VIP ! Выписки 1-го счёта
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: dSab
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nInd
.head 5 -  String: pFile
.head 5 -  String: fTmp
.head 5 -  !
.head 5 -  String: sSABp
.head 5 -  String: sIndexP
.head 4 +  Actions
.head 5 -  Set nInd = 0
.head 5 -  Set strDir = GetTemplateDir() || '\\LS' || Str(nStmt) || '.QRP'
.head 5 -  Set fTmp = strTmpDir || '\\Tmp' || Right(Str(Int(100000+SalDateHour(
    SalDateCurrent())*3600+SalDateMinute(SalDateCurrent())*60+SalDateSecond(
    SalDateCurrent()))), 5) || '.tmp'
.head 5 -  Set pFile = strVipDir || '\\^#' || dSab || IifS(sDD='DD', DD, Sep98md(
    SalDateConstruct(0, Val(MM), Val(DD), 0, 0, 0))) || '.' || xxx
.head 5 +  If bEKV
.head 6 -  Call SalReportPrintToFile(hWndForm, strDir, fTmp,
    'nLim,REF,DK,S,SQ,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB,NAZ_P2,NAZ_P3,NAMO,FDAT1',
    'ACC,REF,DK,S,SQ,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB,NAZ_P2,NAZ_P3,NAMO,FDAT1',
     1, RPT_PrintAll, 1, 1, FALSE, nInd)
.head 5 +  Else
.head 6 -  Call SalReportPrintToFile(hWndForm, strDir, fTmp,
    'nLim,REF,DK,S,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB,NAZ_P2,NAZ_P3,NAMO,FDAT1',
    'ACC,REF,DK,S,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB,NAZ_P2,NAZ_P3,NAMO,FDAT1',
     1, RPT_PrintAll, 1, 1, FALSE, nInd)
.head 5 +  If nInd > 0
.head 6 -  Call Debug('Файл ' || pFile || ' Ош' || Str(nInd))
.head 6 -  Return FALSE
.head 5 -  Call BlankStringErase(fTmp)
.head 5 -  Call SalFileCopy(fTmp, pFile, TRUE)
.head 5 +  If bKORP and tbKLI.nRnkP != NUMBER_Null
.head 6 -  Set sSABp = GetValueStr("
    SELECT sab
    FROM customer
    WHERE rnk=" || Str(tbKLI.nRnkP) || " and stmt=4")
.head 6 +  If Len(sSABp) = 4
.head 7 -  Set sIndexP = T36(Val(SalFmtFormatDateTime(
    SalDateCurrent(), 'hhhhmmssmmmmmm')) / 10000)
.head 7 -  Call SalFileCopy(fTmp, Left(pFile, Len(pFile)-10) || sSABp || IifS(sDD='DD', DD, Sep98md(
     SalDateConstruct(0, Val(MM), Val(DD), 0, 0, 0))) || '.' || sIndexP, TRUE)
.head 5 -  ! Call SalFileCopy(fTmp, strPath2 || '\\^#' || dSab || DD || '.' || xxx, TRUE)
.head 5 -  Call VisFileDelete(fTmp)
.head 5 -  Return TRUE
.head 3 +  Function: Klient1_SAL ! Сальдовка 1-го клиента
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: dSab
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nInd
.head 5 -  String: pFile
.head 5 -  String: fTmp
.head 4 +  Actions
.head 5 -  Set nInd = 0
.head 5 -  Set strDir = GetTemplateDir() || '\\Sa' || Str(nStmt) || '.QRP'
.head 5 -  Set fTmp  = strPath || '\\Tmp' || Right(Str(Int(100000+SalDateHour(SalDateCurrent())*3600+SalDateMinute(
    SalDateCurrent())*60+SalDateSecond(SalDateCurrent()))), 5) || '.tmp'
.head 5 -  Set pFile = strPath || '\\^O' || dSab || DD || '.txt'
.head 5 +  If bEKV
.head 6 -  Call SalReportPrintToFile(hWndForm, strDir, fTmp,
     'REF,ACC,DK,S,SQ,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB',
     'REF,ACC,DK,S,SQ,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB', 1, RPT_PrintAll, 1, 1, FALSE, nInd)
.head 5 +  Else
.head 6 -  Call SalReportPrintToFile(hWndForm, strDir, fTmp,
     'REF,ACC,DK,S,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB',
     'REF,ACC,DK,S,ND,MFO,NLSK,NAMK,SK,NAZ_P,TT,OKPO,OKPOK,NB', 1, RPT_PrintAll, 1, 1, FALSE, nInd)
.head 5 +  If nInd > 0
.head 6 -  Call Debug('Файл ' || pFile || ' Ош' || Str(nInd))
.head 6 -  Return FALSE
.head 5 -  Call BlankStringErase(fTmp)
.head 5 -  Call SalFileCopy(fTmp, pFile, TRUE)
.head 5 -  Call VisFileDelete(fTmp)
.head 5 -  Return TRUE
.head 3 +  Function: BackUpFile
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Number: nMode
.head 5 -  String: strPath
.head 5 -  String: strFn
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sBackUpPath
.head 5 -  File Handle: hFile
.head 4 +  Actions
.head 5 +  If VisDosExist(strBKUPDir) ! do backup
.head 6 -  Set sBackUpPath = strBKUPDir || '\\' || SalFmtFormatDateTime(dDAT, 'yyMMdd') || IifS(nMode=1, '\\OK', '\\NOT')
.head 6 +  If not VisDosExist(sBackUpPath)
.head 7 +  If not SalFileCreateDirectory(sBackUpPath)
.head 8 -  Call SalMessageBox('Не могу создать каталог:' || sBackUpPath, 'Внимание', MB_IconStop)
.head 8 -  Return FALSE
.head 6 -  Call SalFileCopy(strPath || '\\' || strFn, sBackUpPath || '\\' || strFn, TRUE)
.head 6 -  ! Call Debug('Backed up as ' || sBackUpPath || '\\' || strFn)
.head 5 -  Call SalFileOpen(hFile, strPath || '\\' || strFn, OF_Delete)
.head 5 -  Return TRUE
.head 3 +  Function: BlankStringErase
.head 4 -  Description: Выбрасывает пустые строки из файла (+ Win2Dos)
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sFile
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sBuffer
.head 5 -  String: sFileTemp
.head 5 -  File Handle: hFt
.head 5 -  File Handle: hF
.head 5 -  Number: nL
.head 4 +  Actions
.head 5 +  If VisFileOpen(hF, sFile, OF_Text) < 0
.head 6 -  Return FALSE
.head 5 -  Call SalWaitCursor(TRUE)
.head 5 -  Set sFileTemp = VisFileCreateTemp('bse')
.head 5 +  If VisFileOpen(hFt, sFileTemp, OF_Create) < 0
.head 6 -  Call VisFileClose(hF)
.head 6 -  Call SalWaitCursor(FALSE)
.head 6 -  Return FALSE
.head 5 -  Set nL = 1
.head 5 +  While VisFileReadString(hF, sBuffer) = VTERR_Ok
.head 6 +  If SalStrLeftX(sBuffer, 1) = SalNumberToChar(12)
.head 7 -  Call SalStrLop(sBuffer)
.head 6 -  Set sBuffer = VisStrRightTrim(sBuffer)
.head 6 -  Set nL = SalStrLength(sBuffer)
.head 6 +  If nL > 0
.head 7 +  If VisFileWriteString(hFt, StrWinToDosX(sBuffer)) < 0
.head 8 -  Call VisFileClose(hFt)
.head 8 -  Call VisFileClose(hF)
.head 8 -  Call SalWaitCursor(FALSE)
.head 8 -  Return FALSE
.head 5 -  Call VisFileClose(hF)
.head 5 -  Call VisFileClose(hFt)
.head 5 -  Call VisFileDelete(sFile)
.head 5 -  Call VisFileRename(sFileTemp, sFile)
.head 5 -  Call SalWaitCursor(FALSE)
.head 5 -  Return TRUE
.head 3 +  Function: NASELENIE
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: ss1
.head 5 -  String: sf
.head 4 +  Actions
.head 5 -  Call SalWaitCursor(TRUE)
.head 5 -  Set sf = cF.GetFilterWhereClause(FALSE)
.head 5 -  ! главный курсор в таблицу
.head 5 +  If Len(sFilter) = 0
.head 6 -  Call SalTblPopulate(tbKLI, hSql(), "
     SELECT c.rnk,c.nmk,c.sab,c.okpo,c.rnkp,co.numb
     INTO :tbKLI.nRnk,:tbKLI.dKli,:tbKLI.dSab,:tbKLI.sOKPO,:tbKLI.nRnkP,:tbKLI.sXXX
     FROM customer c, conts co
     WHERE " || IifS(sf !="",  sf || " and ",  "") || "co.rnk=c.rnk and c.sab=co.nek and c.sab is not null and
           c.stmt=:nStmt
     ORDER BY c.sab,co.numb", TBL_FillAll)
.head 5 +  Else ! > 0
.head 6 -  Call SalTblPopulate(tbKLI, hSql(), "
     SELECT c.rnk,c.nmk,c.sab,c.okpo,c.rnkp,co.numb
     INTO :tbKLI.nRnk,:tbKLI.dKli,:tbKLI.dSab,:tbKLI.sOKPO,:tbKLI.nRnkP,:tbKLI.sXXX
     FROM customer c, conts co
     WHERE " || IifS(sf !="",  sf || " and ",  "") || "co.rnk=c.rnk and c.sab=co.nek and c.sab is not null and
           c.stmt=:nStmt and UPPER(c.sab) in (" || sFilter || ")
     ORDER BY c.sab,co.numb", TBL_FillAll)
.head 5 -  Call SalWaitCursor(FALSE)
.head 5 -  Call BitMap()
.head 5 -  Return TRUE
.head 3 +  Function: ToLog
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: sMes
.head 4 +  Static Variables
.head 5 -  File Handle: hLogFile
.head 5 -  Number: nOtl
.head 4 +  Local variables
.head 5 -  String: strFileName
.head 5 -  String: strTmpStr
.head 4 +  Actions
.head 5 -  Set strFileName = GetLogDir() || '\\' || SalStrLeftX(GetUserLoginName(), 8) || '.LOG'
.head 5 +  If not File(strFileName)
.head 6 -  Call SalFileOpen(hLogFile, strFileName, OF_Create | OF_Text | OF_Write | OF_Append | OF_Share_Deny_None)
.head 5 +  Else
.head 6 -  Call SalFileOpen(hLogFile, strFileName, OF_Text | OF_Write | OF_Append | OF_Share_Deny_None)
.head 5 +  If nOtl = 0
.head 6 +  If bDebug
.head 7 -  Call Debug('Имя файла журнала = ' || strFileName)
.head 6 -  Set nOtl = 1
.head 5 -  Set strTmpStr = SalFmtFormatDateTime(SalDateCurrent(), ddMMyy()) || ' ' || Right('0' || SalFmtFormatDateTime(
    SalDateCurrent(), 'hhhh:mm:ss'), 8) || ' ' || sMes
.head 5 -  Call SalFilePutStr(hLogFile, StrWinToDosX(strTmpStr))
.head 5 +  If bDebug
.head 6 -  Call Debug('Запись в журнал = ' || strTmpStr)
.head 5 -  Call SalFileClose(hLogFile)
.head 3 +  Function: Kvit
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sFile
.head 5 -  String: sErr
.head 5 -  Number: nNS
.head 5 -  String: sFN
.head 5 -  Number: nPN
.head 5 -  Receive Number: nPNnew
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  File Handle: hFile
.head 5 -  String: sLine
.head 5 -  String: sND3
.head 5 -  String: s
.head 5 -  String: s1
.head 5 -  Number: i
.head 5 -  !
.head 5 -  Number: nBound
.head 5 -  Number: nIndex
.head 5 -  Number: nSuf
.head 4 +  Actions
.head 5 -  !
.head 5 -  Call SalArrayGetUpperBound(smSAB, 1, nBound)
.head 5 -  Set nIndex = VisArrayFindString(smSAB, tbKLI.dSab)
.head 5 +  If nIndex >=0
.head 6 -  Set nSuf = nmSAB[nIndex] + 1
.head 6 -  Set nmSAB[nIndex] = nSuf
.head 5 +  Else
.head 6 -  Set nSuf = 1 
.head 6 -  Set smSAB[nBound+1] = tbKLI.dSab
.head 6 -  Set nmSAB[nBound+1] = nSuf
.head 5 -  !
.head 5 -  ! Set nPNnew = nPN + 1
.head 5 -  ! Set sFN = sDPath || '\\^D' || tbKLI.dSab || DD || '.' || Right('000' || Str(nPNnew), 3)
.head 5 -  Set sFN = sDPath || '\\^D' || tbKLI.dSab || DD || '.' || Right('000' || Str(nSuf), 3)
.head 5 +  If not File(sFN)
.head 6 -  Call SalFileOpen(hFile, sFN, OF_Create | OF_Text | OF_Write | OF_Append | OF_Share_Deny_None)
.head 5 +  Else
.head 6 -  Call SalFileOpen(hFile, sFN, OF_Text | OF_Write | OF_Append | OF_Share_Deny_None)
.head 5 -  Set sND3 = Right('   ' || Str(nNS), 3)
.head 5 -  Set sLine = SalFmtFormatDateTime(dDAT, 'yyyy/MM/dd') || ' ' || sFile || ' ' || sND3 || ' ' ||
    Left(sErr || Spac(140), 140)
.head 5 -  Call SalFilePutStr(hFile, StrWinToDosX(sLine))
.head 5 -  Call SalFileClose(hFile)
.head 5 -  !
.head 5 -  Return File(sFN)
.head 3 +  Function: MakeDRCK
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sDatDf
.head 5 -  String: sFileDf
.head 5 -  String: sNumDf
.head 5 -  String: sBackf
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  File Handle: hFile
.head 5 -  String: sLine
.head 5 -  Boolean: bRet
.head 4 +  Actions
.head 5 -  Set bRet = FALSE
.head 5 +  If SalFileOpen(hFile, sDPath || '\\^D' || Subs(sFileDf, 3, 10), OF_Create | OF_Text | OF_Write | OF_Share_Deny_None)
.head 6 -  Set sLine = sDatDf || ' ' || sFileDf || ' ' || Right('000' || sNumDf, 3) || ' ' || PadR(sBackf, 140)
.head 6 -  Set bRet = SalFilePutStr(hFile, StrWinToDosX(sLine))
.head 6 -  Call SalFileClose(hFile)
.head 5 -  Return bRet
.head 3 +  Function: T36
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  Number: nTime
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nmI[*]
.head 5 -  Number: nI
.head 5 -  Number: nCeloe
.head 4 +  Actions
.head 5 -  Set nI = 0
.head 5 -  Set nCeloe = nTime
.head 5 +  While nI < 3
.head 6 -  Set nmI[nI] = Mod(nCeloe, 36)
.head 6 -  Set nCeloe = Int(nCeloe / 36)
.head 6 -  Set nI = nI + 1
.head 5 -  Return C36(nmI[2]) || C36(nmI[1]) || C36(nmI[0])
.head 3 +  Function: C36
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  Number: n36
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Return Chr(n36 + IifN(n36<10, 48, 55))
.head 3 +  Function: BitMap
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Return XSalBitmapDraw(tbKLI, hBitmap, 0, 0, 18, 30.9, FALSE)
.head 3 +  Function: VerifyNls
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: sNLS
.head 5 -  Number: nKV
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Return GetValueStr("
       SELECT to_char(count(1))
       FROM accounts a
       WHERE nls='" || sNLS || "' and kv=" || Str(nKV))='1'
.head 3 +  Function: VerifyOkpo
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: sNLS
.head 5 -  Number: nKV
.head 5 -  String: sOkpo
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sOKPOreal
.head 5 -  String: sNBS
.head 5 -  Boolean: bYes
.head 4 +  Actions
.head 5 -  Set sOKPOreal = GetValueStr("
    SELECT c.okpo
    FROM customer c, cust_acc cu, accounts a
    WHERE a.nls='" || sNLS || "' and a.kv=" || Str(nKV) || " and a.acc=cu.acc and cu.rnk=c.rnk")
.head 5 -  Set bYes = FALSE
.head 5 +  If SqlPrepareAndExecute(hSql(), "
   SELECT trim(nbs)
   INTO :sNBS
   FROM kbnokk_bal")
.head 6 +  While SqlFetchNext(hSql(), nFetchRes)
.head 7 -  Set bYes = TRUE
.head 7 +  If Left(sNLS, Len(sNBS)) = sNBS
.head 8 -  Return sOkpo=sOKPOreal
.head 6 +  If bYes
.head 7 -  Return TRUE
.head 6 +  Else
.head 7 -  Return sOkpo=sOKPOreal
.head 5 +  Else
.head 6 -  Return sOkpo=sOKPOreal
.head 3 +  Function: DoHera
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Number: nKwo
.head 5 -  String: sKat
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nI
.head 4 +  Actions
.head 5 -  Set nI = 0
.head 5 +  While nI < nKwo
.head 6 -  Call SalMessageBeep(nI*2)
.head 6 -  ! Call SalMessageBeep(16)
.head 6 -  Set nI = nI + 1
.head 5 -  Call MessageNoWait('Отсутствует каталог ' || sKat || ' ...', 'ВНИМАНИЕ! Выход из программы!', 17, 1)
.head 5 -  Call SalQuit()
.head 2 +  Window Parameters
.head 3 -  Number: nStmt
.head 2 +  Window Variables
.head 3 -  : cF
.head 4 -  Class: cGenFilter
.head 3 -  String: sf
.head 3 -  Number: nInterval
.head 3 -  String: strPath
.head 3 -  String: strPath1
.head 3 -  String: strPath2
.head 3 -  String: strDir
.head 3 -  String: strDopDir
.head 3 -  String: sDPath
.head 3 -  String: strVipDir
.head 3 -  String: strTmpDir
.head 3 -  String: AMFO
.head 3 -  String: AQH
.head 3 -  String: DD
.head 3 -  String: MM
.head 3 -  String: sSql2
.head 3 -  String: sSql2a
.head 3 -  Number: nOtc
.head 3 -  String: xxx
.head 3 -  Number: TEK
.head 3 -  Number: ACC
.head 3 -  Number: REF
.head 3 -  Number: DK
.head 3 -  Number: S
.head 3 -  Number: SQ
.head 3 -  Number: nLim
.head 3 -  String: ND
.head 3 -  String: MFO
.head 3 -  String: NLSK
.head 3 -  String: NAMK
.head 3 -  String: NAMO
.head 3 -  String: SK
.head 3 -  String: OKPO
.head 3 -  String: OKPOK
.head 3 -  String: OKPOK2
.head 3 -  String: NB
.head 3 -  String: NAZ_P
.head 3 -  String: NAZ_P2
.head 3 -  String: NAZ_P3
.head 3 -  String: TT
.head 3 -  String: NLS
.head 3 -  String: ISO
.head 3 -  Date/Time: DAPP
.head 3 -  Number: OST2
.head 3 -  Number: OST2Q
.head 3 -  Number: OST1Q
.head 3 -  ! Number: OSTn
.head 3 -  Number: DOS
.head 3 -  Number: DOSQ
.head 3 -  Number: DOSNE
.head 3 -  Number: KOS
.head 3 -  Number: KOSQ
.head 3 -  : ccDoc
.head 4 -  Class: cDocNokk
.head 3 -  Number: nInd
.head 3 -  Number: nFli
.head 3 -  String: sTmp
.head 3 -  Number: nTmp
.head 3 -  String: NAMA
.head 3 -  String: NAMB
.head 3 -  String: NLSA
.head 3 -  String: NLSB
.head 3 -  String: strBKUPDir
.head 3 -  String: sErrMes
.head 3 -  Window Handle: hNOKF
.head 3 -  Date/Time: dTEDAT
.head 3 -  Date/Time: dTEDAT99999
.head 3 -  !
.head 3 -  Number: nBaseVal
.head 3 -  Date/Time: FDAT1
.head 3 -  Number: nPEREK
.head 3 -  !
.head 3 -  String: sNLS
.head 3 -  Number: nKV
.head 3 -  Boolean: bOk
.head 3 -  Number: bcbF
.head 3 -  String: sMErr[*,2]
.head 3 -  Number: nErr
.head 3 -  Date/Time: dDATtek
.head 3 -  !
.head 3 -  String: sTipPDP
.head 3 -  Boolean: bIni
.head 3 -  !
.head 3 -  Number: nRet
.head 3 -  Date/Time: dBDate
.head 3 -  String: sStatus
.head 3 -  !
.head 3 -  String: sWText
.head 3 -  !
.head 3 -  String: sTILDA
.head 3 -  String: sTilda  !! код платежа
.head 3 -  !
.head 3 -  Number: nstmt
.head 3 -  Number: nSOZDO
.head 3 -  !
.head 3 -  String: sFileFLT
.head 3 -  String: sFilter
.head 3 -  String: sLine
.head 3 -  File Handle: hF
.head 3 -  Number: nItem
.head 3 -  Number: nI
.head 3 -  String: smTemp[*]
.head 3 -  !
.head 3 -  String: sMejBank
.head 3 -  !
.head 3 -  String: sDayArc
.head 3 -  Number: nFocus
.head 3 -  !
.head 3 -  Number: nId
.head 3 -  !
.head 3 -  Boolean: bPDP
.head 3 -  String: sPDP
.head 3 -  String: sDD
.head 3 -  !
.head 3 -  String: sISO
.head 3 -  Boolean: bISO
.head 3 -  String: sNameVal
.head 3 -  Number: nKv
.head 3 -  !
.head 3 -  Boolean: bKORP
.head 3 -  Boolean: bRCK
.head 3 -  !
.head 3 -  String: sAutoEnd
.head 3 -  Number: nNumTokens
.head 3 -  String: smTokenArray[*]
.head 3 -  !
.head 3 -  String: svipDAY
.head 3 -  Boolean: bvipDAY
.head 3 -  Date/Time: dFirst
.head 3 -  String: sPlic1
.head 3 -  Number: hBitmap
.head 3 -  !
.head 3 -  String: sDebug
.head 3 -  Boolean: bDebug
.head 3 -  !
.head 3 -  String: MFOHEADER
.head 3 -  String: sMFO_bank_acc
.head 3 -  !
.head 3 -  String: sEKV
.head 3 -  Boolean: bEKV
.head 3 -  !
.head 3 -  String: sAutoDopDir
.head 3 -  Boolean: bAutoDopDir
.head 3 -  !
.head 3 -  Number: DOSPER
.head 3 -  Number: KOSPER
.head 3 -  Number: KURS
.head 3 -  !
.head 3 -  String: sKURSP
.head 3 -  Boolean: bKURSP
.head 3 -  String: sKURSB
.head 3 -  Boolean: bKURSB
.head 3 -  Number: nBSUM
.head 3 -  !
.head 3 -  String: sDREC
.head 3 -  String: sTokenArray[*]
.head 3 -  !
.head 3 -  ! Number: nSEP
.head 3 -  !
.head 3 -  String: sRckBckQue
.head 3 -  Boolean: bRckBckQue
.head 3 -  Number: nRefBck
.head 3 -  String: sDatD
.head 3 -  String: sFileD
.head 3 -  String: sNumD
.head 3 -  String: sBack
.head 3 -  String: sRefBck
.head 3 -  !
.head 3 -  String: sPathBad
.head 3 -  String: sYYYYMMDD
.head 3 -  Number: nNumStrG
.head 3 -  String: sFNG
.head 3 -  Number: nPNG
.head 3 -  Number: nPNnewG
.head 3 -  !
.head 3 -  String: smSAB[*]
.head 3 -  Number: nmSAB[*]
.head 3 -  !
.head 3 -  Number: nBeep
.head 3 -  ! Number: ZAK
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SqlPrepareAndExecute(hSql(), 'SET ROLE start1,nokk')
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Call SalUseRegistry(FALSE, '')
.head 4 -  Set bIni = FALSE
.head 4 -  Set nBaseVal = GetBaseVal()
.head 4 -  Set nId = GetUserId()
.head 4 -  Set sf = " "
.head 4 -  Call cF.Init('Conts', 'co')
.head 4 -  !
.head 4 -  Set nBeep = 713
.head 4 -  !
.head 4 -  Set rbAll = TRUE
.head 4 -  Set cb1 = 0
.head 4 -  Set cb2 = 0
.head 4 -  Set cb21 = 0
.head 4 -  Set cb3 = 0
.head 4 -  Set cbOtDo = 0
.head 4 -  Set cbZAK = 0
.head 4 -  Set sMErr[0,0] = ' - неверно указан код ОКПО (для документа сформирована квитанция);'
.head 4 -  Set sMErr[1,0] = ' - документ не оплачен;'
.head 4 -  Set sMErr[2,0] = ' - счёт не доступен клиенту;'
.head 4 -  Set sMErr[3,0] = ' - ош DK # 2;'
.head 4 -  Set sMErr[4,0] = ' - ош вставки IDB;'
.head 4 -  Set sMErr[5,0] = ' - ош вставки RCK_D;'
.head 4 -  Set sMErr[6,0] = ' - ош вставки OPERW;'
.head 4 -  Set sMErr[7,0] = ' - неверно указан счёт Б (для документа сформирована квитанция);'
.head 4 -  Set nErr = 8
.head 4 -  Set nInterval = SalGetProfileInt(INI_ElektroKlients, 'Interval', 600, GetIniFileName())
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_OUT', 'NOKK_OUT', strPath, GetIniFileName())
.head 4 -  Set strPath    = IifS(Right(strPath, 1)='/', Left(strPath, Len(strPath)-1), strPath)
.head 4 -  Set strPath    = IifS(Right(strPath, 1)='\\', Left(strPath, Len(strPath)-1), strPath)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_BAD', 'NOKK_BAD', sPathBad, GetIniFileName())
.head 4 -  Set sPathBad   = IifS(Right(sPathBad, 1)='/', Left(sPathBad, Len(sPathBad)-1), sPathBad)
.head 4 -  Set sPathBad   = IifS(Right(sPathBad, 1)='\\', Left(sPathBad, Len(sPathBad)-1), sPathBad)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_IN', 'NOKK_IN', strPath1, GetIniFileName())
.head 4 -  Set strPath1   = IifS(Right(strPath1, 1)='/', Left(strPath1, Len(strPath1)-1), strPath1)
.head 4 -  Set strPath1   = IifS(Right(strPath1, 1)='\\', Left(strPath1, Len(strPath1)-1), strPath1)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_PRINT', GetPrnDir(), strPath2, GetIniFileName())
.head 4 -  Set strPath2   = IifS(Right(strPath2, 1)='/', Left(strPath2, Len(strPath2)-1), strPath2)
.head 4 -  Set strPath2   = IifS(Right(strPath2, 1)='\\', Left(strPath2, Len(strPath2)-1), strPath2)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'BackUpDir', GetPrnDir(), strBKUPDir, GetIniFileName())
.head 4 -  Set strBKUPDir = IifS(Right(strBKUPDir, 1)='/', Left(strBKUPDir, Len(strBKUPDir)-1), strBKUPDir)
.head 4 -  Set strBKUPDir = IifS(Right(strBKUPDir, 1)='\\', Left(strBKUPDir, Len(strBKUPDir)-1), strBKUPDir)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_VipPath', GetPrnDir(), strVipDir, GetIniFileName())
.head 4 -  Set strVipDir  = IifS(Right(strVipDir, 1)='/', Left(strVipDir, Len(strVipDir)-1), strVipDir)
.head 4 -  Set strVipDir  = IifS(Right(strVipDir, 1)='\\', Left(strVipDir, Len(strVipDir)-1), strVipDir)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_TmpPath', GetPrnDir(), strTmpDir, GetIniFileName())
.head 4 -  Set strTmpDir  = IifS(Right(strTmpDir, 1)='/', Left(strTmpDir, Len(strTmpDir)-1), strTmpDir)
.head 4 -  Set strTmpDir  = IifS(Right(strTmpDir, 1)='\\', Left(strTmpDir, Len(strTmpDir)-1), strTmpDir)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'DopDir', GetPrnDir(), strDopDir, GetIniFileName())
.head 4 -  Set strDopDir  = IifS(Right(strDopDir, 1)='/', Left(strDopDir, Len(strDopDir)-1), strDopDir)
.head 4 -  Set strDopDir  = IifS(Right(strDopDir, 1)='\\', Left(strDopDir, Len(strDopDir)-1), strDopDir)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_DPath', GetPrnDir(), sDPath, GetIniFileName())
.head 4 -  Set sDPath     = IifS(Right(sDPath, 1)='/', Left(sDPath, Len(sDPath)-1), sDPath)
.head 4 -  Set sDPath     = IifS(Right(sDPath, 1)='\\', Left(sDPath, Len(sDPath)-1), sDPath)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'TipPDP', '0', sTipPDP, GetIniFileName())
.head 4 -  ! добавлено по просьбе ПОЛЯНЧУКА (красное письмо) ------------------------------------
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'FPath', '', sFileFLT, GetIniFileName())
.head 4 -  ! отбор в выписки межбанковских "электронных" документов (1 - Межбанк ПОДТВЕРЖДЕН, 0 - Межбанк НЕ подтвержден)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'MejBank', '0', sMejBank, GetIniFileName())
.head 4 -  Set rbPlus = sMejBank!='0'
.head 4 -  Set rbMinus = sMejBank='0'
.head 4 -  ! добавлено по просьбе БЫКОВА (количество дней хранения архивных файлов для просмотра)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'DayArc', '20', sDayArc, GetIniFileName())
.head 4 -  Set sDayArc = Str(Max(Val(sDayArc), 1))
.head 4 -  ! подпись включена (1), выключена (0)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'PDP', '0', sPDP, GetIniFileName())
.head 4 -  Set bPDP = IifN(Val(sPDP)=1, 1, 0)=1
.head 4 -  ! управление форматом дня в имени файла выписки (DD) или (MD)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'vipDD', 'DD', sDD, GetIniFileName())
.head 4 -  ! управление форматом кода валюты в файле выписки
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'vidISO', '0', sISO, GetIniFileName())
.head 4 -  Set bISO = sISO='1'
.head 4 -  ! передавать/НЕпередавать ЭКВИВАЛЕНТЫ в выписки по валютным счетам
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'valEKV', '0', sEKV, GetIniFileName())
.head 4 -  Set bEKV = sEKV='1'
.head 4 -  ! передавать/НЕпередавать ПЕРЕОЦЕНКУ и КУРС в выписки по валютным счетам
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'valKURSP', '0', sKURSP, GetIniFileName())
.head 4 -  Set bKURSP = sKURSP='1'
.head 4 -  ! передавать КУРС за ЕДИНИЦУ валюты ('0') или за БАЗОВУЮ СУММУ ('1')
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'valKURSB', '0', sKURSB, GetIniFileName())
.head 4 -  Set bKURSB = sKURSB='1'
.head 4 -  ! обрабатывать/НЕобрабатывать файлы из DopDir автоматом
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'AutoDopDir', '1', sAutoDopDir, GetIniFileName())
.head 4 -  Set bAutoDopDir = sAutoDopDir='1'
.head 4 -  ! флаг формирования выписок корпоративным методом
.head 4 -  Set bKORP = Val(GetGlobalOption('KB_Corpo'))=1
.head 4 -  ! флаг РЦК
.head 4 -  Set bRCK = Val(GetGlobalOption('RCK_USE'))=1
.head 4 -  ! время автоматического завершения программы (параметр AutoEnd) - формат ЧЧ:ММ:СС
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'AutoEnd', '24:00:00', sAutoEnd, GetIniFileName())
.head 4 -  Set nNumTokens = SalStrTokenize(sAutoEnd, '', ':', smTokenArray)
.head 4 -  Set nI = 0
.head 4 -  Set sAutoEnd = ''
.head 4 +  While nI <= nNumTokens
.head 5 -  Set sAutoEnd = sAutoEnd || Right('00' || smTokenArray[nI], 2) || ':'
.head 5 -  Set nI = nI + 1
.head 4 -  Set sAutoEnd = Left(sAutoEnd || Repl('00' || ':', 3), 8)
.head 4 -  ! включена или нет ОТЛАДКА
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'Debug', '0', sDebug, GetIniFileName())
.head 4 -  Set bDebug = sDebug='0'
.head 4 -  ! Call Debug(sAutoEnd)
.head 4 -  ! --------------------------------------------------------------------------------------
.head 4 -  ! параметр формирования выписок с документами предшестствующих выходных дней (vipDAY)
  vipDAY=SINGLE   - выписки отбираются строго за выбранный день (по умолчанию)
  vipDAY=MULTIPLE - выписки отбираются в следующем режиме:
                    если задан день отбора выписки, которому предшествуют выходные дни,
                    то в выписку включаются документы предшестствующих выходных дней
                    (можно использовать в случае работы банка по модели, когда головной
                    банк имеет безбалансовые отделения, которые работают в выходные дни)
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'vipDAY', 'SINGLE', svipDAY, GetIniFileName())
.head 4 -  Set bvipDAY = SalStrUpperX(svipDAY)='MULTIPLE'
.head 4 -  ! Call Debug(SalStrUpperX(svipDAY))
.head 4 -  ! --------------------------------------------------------------------------------------
.head 4 -  ! индекс расширения (один латинский или числовой символ) в имени файла выписки
  для вышестоящей организации по счетам "дочерних" организаций (НЕЛЬЗЯ ТАК !!)
.head 4 -  ! Call SalGetProfileString(INI_ElektroKlients, 'indexP', 'P', sIndexP, GetIniFileName())
.head 4 -  ! Set sIndexP = Left(sIndexP, 1)
.head 4 -  ! --------------------------------------------------------------------------------------
.head 4 -  !
.head 4 -  ! параметр необходимости формирования файлов D для снятых с визы или БЭКнутых документов RCK
.head 4 -  Call SalGetProfileString(INI_ElektroKlients, 'NOKK_rckD', '0', sRckBckQue, GetIniFileName())
.head 4 -  Set bRckBckQue = sRckBckQue='1'
.head 4 -  !
.head 4 -  Set sFilter = ''
.head 4 -  Set sLine = Spac(19200)
.head 4 +  If File(sFileFLT)
.head 5 +  If VisFileOpen(hF, sFileFLT, OF_Read) = VTERR_Ok
.head 6 +  If VisFileRead(hF, sLine, 19200) >= 4
.head 7 +  If Len(SalStrTrimX(sLine)) > 0
.head 8 -  Set nItem = SalStrTokenize(SalStrUpperX(SalStrTrimX(sLine)), '', PutCrLf(), smTemp)
.head 8 -  Set nI = 0
.head 8 +  While nI < nItem
.head 9 -  Set sFilter = sFilter || "'" || smTemp[nI] || "',"
.head 9 -  Set nI = nI + 1
.head 6 -  ! Call Debug(sLine)
.head 6 -  Call VisFileClose(hF)
.head 6 -  Set sFilter = Left(sFilter, Len(sFilter)-1)
.head 4 -  ! Call Debug(sFilter)
.head 4 -  Set dDAT = GetBankDate()
.head 4 -  Call SalGetWindowText(hWndForm, sWText, 99)
.head 4 -  Call SalSetWindowText(hWndForm, sWText || ' Банк.дата ' || SalFmtFormatDateTime(dDAT, 'dd/MM/yyyy'))
.head 4 -  Set dTEDAT = dDAT
.head 4 -  Set AMFO = GetBankMfo()
.head 4 -  Set AQH = GetBankName()
.head 4 -  ! Set nSEP = GetGlobalOptionEx('SEPNUM')
.head 4 -  Call NASELENIE()
.head 4 -  Call SalSendMsg(hWndForm, SAM_User, 0, 0)
.head 3 +  On SAM_CreateComplete
.head 4 -  Set cbOtDo = 0
.head 4 -  Set cbZAK = 0
.head 4 -  Call SalHideWindow(dfOt)
.head 4 -  Call SalHideWindow(dfDatOt)
.head 4 -  Call SalHideWindow(dfDo)
.head 4 -  Call SalHideWindow(dfDatDo)
.head 4 -  Set dfOt = 'c'
.head 4 -  Set dfDo = 'по'
.head 4 -  ! Call Debug('0')
.head 4 +  If bvipDAY
.head 5 -  Set hBitmap = XSalBitmapFromResource('bmp3')
.head 5 -  Set dfSM = 'M'
.head 5 -  Call SalColorSet(dfSM, COLOR_IndexWindowText, COLOR_Teal)
.head 4 +  Else
.head 5 -  Set hBitmap = XSalBitmapFromResource('bmp1')
.head 5 -  Set dfSM = 'S'
.head 5 -  Call SalColorSet(dfSM, COLOR_IndexWindowText, COLOR_Orchid)
.head 4 -  Call BitMap()
.head 3 +  On SAM_User
.head 4 -  Call SalTblQueryFocus(tbKLI, nFocus, hWndNULL)
.head 4 -  Set TEK = TBL_MinRow
.head 4 +  While SalTblFindNextRow(tbKLI, TEK, 0, 0)
.head 5 -  Call SalTblSetContext(tbKLI, TEK)
.head 5 -  Set tbKLI.nFile = NUMBER_Null
.head 5 -  Set tbKLI.nFile1 = NUMBER_Null
.head 5 -  Set tbKLI.nFile2 = NUMBER_Null
.head 5 -  Set tbKLI.nDo = NUMBER_Null
.head 5 -  Set tbKLI.nDo1 = NUMBER_Null
.head 5 -  Set tbKLI.nDo2 = NUMBER_Null
.head 5 -  Set tbKLI.nVip = NUMBER_Null
.head 4 -  Call SalUpdateWindow(hWndForm)
.head 4 +  If cb1 and IsBankDayOpen()
.head 5 +  If GetSignOn()
.head 6 +  If not bIni
.head 7 +  If not ccDoc.sIni()
.head 8 -  Return FALSE
.head 7 +  Else
.head 8 -  Set bIni = TRUE
.head 4 -  Call SalWaitCursor(TRUE)
.head 4 -  Set DD = SalStrRightX('0' || Str(SalDateDay(dDAT)), 2)
.head 4 -  Set MM = SalStrRightX('0' || Str(SalDateMonth(dDAT)), 2)
.head 4 +  If bAutoDopDir
.head 5 -  ! Set cbF = VisDosEnumFiles(strDopDir || '\\^@????' || DD || '.*', FA_Standard, smTemp)>0
.head 5 -  Set cbF = VisDosEnumFiles(strDopDir || '\\^@*.*', FA_Standard, smTemp)>0
.head 4 -  Call SalArraySetUpperBound(smTemp, 1, -1)
.head 4 -  Set dTime = SalDateCurrent()
.head 4 -  Set TEK = TBL_MinRow
.head 4 +  Loop
.head 5 +  If SalTblFindNextRow(tbKLI, TEK, 0, 0)
.head 6 -  Call SalTblSetContext(tbKLI, TEK)
.head 6 +  If TEK >= 0
.head 7 -  Set tbKLI.nFile = NUMBER_Null
.head 7 -  Set tbKLI.nFile1 = NUMBER_Null
.head 7 -  Set tbKLI.nFile2 = NUMBER_Null
.head 7 -  Set tbKLI.nDo = NUMBER_Null
.head 7 -  Set tbKLI.nDo1 = NUMBER_Null
.head 7 -  Set tbKLI.nDo2 = NUMBER_Null
.head 7 +  If rbAll or SalTblQueryRowFlags(tbKLI, TEK, ROW_Selected)
.head 8 -  ! платежи
.head 8 +  If cb1
.head 9 -  Call Klient1_PL(tbKLI.dSab)
.head 9 -  Call SalTblSetFocusRow(tbKLI, TEK)
.head 9 -  Call SalTblSetContext(tbKLI, TEK)
.head 9 -  Call SalUpdateWindow(hWndForm)
.head 8 -  ! выписки
.head 8 +  If cb2 or cb21
.head 9 +  If bvipDAY
.head 10 -  Call SqlPrepareAndExecute(hSqlAux2(), "
     SELECT calcdat1(to_date('" || SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')-1)+1
     INTO :dFirst
     FROM dual")
.head 10 -  Call SqlFetchNext(hSqlAux2(), nFetchRes)
.head 9 -  Set tbKLI.nVip = 0
.head 9 -  Set nOtc = 1
.head 9 -  Set xxx = tbKLI.sXXX
.head 9 -  Set OKPO = tbKLI.sOKPO
.head 9 -  Set dTEDAT = IifD(dDAT>GetBankDate(), GetBankDate(), dDAT)
.head 9 -  ! Set sSql2a = T("
    SELECT a.acc,ac.ost8/100,a.nls,a.kv
    INTO :ACC,:nLim,:sNLS,:nKV
    FROM cust_acc cu, conts co, sal a, OUTER v862 ac
    WHERE co.NUMB=:tbKLI.sXXX and co.NEK=:tbKLI.dSab and cu.rnk=:tbKLI.nRnk and a.acc=ac.acc6 (+) and
          a.nls=co.nls and a.kv=co.kv and a.acc=cu.acc and a.fdat=:dTEDAT" || IifS(cb21, " and
          a.dos+a.kos>0", ""))
.head 9 +  If bvipDAY
.head 10 -  Set sSql2a = T("
    SELECT DISTINCT a.acc,a.nls,a.kv
    INTO :ACC,:sNLS,:nKV
    FROM cust_acc cu, conts co, sal a
    WHERE co.NUMB=:tbKLI.sXXX and co.NEK=:tbKLI.dSab and cu.rnk=:tbKLI.nRnk and a.nls=co.nls and
          a.kv=co.kv and a.acc=cu.acc and a.fdat>=:dFirst and a.fdat<=:dTEDAT" || IifS(cb21, " and
          a.dos+a.kos>0", ""))
.head 9 +  Else
.head 10 -  Set sSql2a = T("
    SELECT a.acc,a.nls,a.kv
    INTO :ACC,:sNLS,:nKV
    FROM cust_acc cu, conts co, sal a
    WHERE co.NUMB=:tbKLI.sXXX and co.NEK=:tbKLI.dSab and cu.rnk=:tbKLI.nRnk and a.nls=co.nls and
          a.kv=co.kv and a.acc=cu.acc and a.fdat=:dTEDAT" || IifS(cb21, " and a.dos+a.kos>0", ""))
.head 9 +  If SqlPrepareAndExecute(hSqlAux2(), sSql2a) and
   SqlFetchNext(hSqlAux2(), nFetchRes)
.head 10 -  Set nLim = 0
.head 10 -  Set nSOZDO = 0
.head 10 -  Set DOSNE = 0
.head 10 +  If nKV = nBaseVal
.head 11 -  ! вычисление лимита для счёта <ACC>
.head 11 +  ! If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT decode(:dTEDAT,bankdate,a.lim+least(0,a.ostc),-s.ost)/100
   INTO :nLim
   FROM accounts a, sal s, acc_over o
   WHERE a.acc=:ACC and a.acc=o.acc and s.nls like '9129_' || substr(a.nls,6,9) and s.kv=:nBaseVal and
         s.fdat=:dTEDAT")
.head 12 +  If not SqlFetchNext(hSqlAux3(), nFetchRes)
.head 13 -  Set nLim = 0
.head 11 +  ! If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT (a.lim+least(0,a.ostc))/100
   INTO :nLim
   FROM accounts a, acc_over o
   WHERE a.acc=:ACC and a.acc=o.acc")
.head 12 +  If not SqlFetchNext(hSqlAux3(), nFetchRes)
.head 13 -  Set nLim = 0
.head 11 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT decode(a.tip,'BLD',0,a.lim)/100
   INTO :nLim
   FROM accounts a, acc_over o
   WHERE a.acc=:ACC and a.acc=o.acc")
.head 12 +  ! If not SqlFetchNext(hSqlAux(), nFetchRes)
.head 13 -        Set nLim = 0
.head 12 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 11 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT s.dos/100
   INTO :nSOZDO
   FROM accounts a, acc_over o, sal s
   WHERE a.acc=:ACC and a.acc in (SELECT acc
                                  FROM acc_over
                                  WHERE acc=acco) and a.acc=o.acco and s.acc=o.acc_8000 and s.fdat=:dTEDAT")
.head 12 +  ! If not SqlFetchNext(hSqlAux(), nFetchRes)
.head 13 -        Set nLim = 0
.head 12 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 11 +  If rbPlus
.head 12 +  If bvipDAY
.head 13 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT sum(o.s)/100
   INTO :DOSNE
   FROM opldok o, arc_rrp r
   WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.s>0 and r.ref=o.ref and
         r.sos<5")
.head 14 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 12 +  Else
.head 13 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT sum(o.s)/100
   INTO :DOSNE
   FROM opldok o, arc_rrp r
   WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.s>0 and r.ref=o.ref and r.sos<5")
.head 14 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 11 -  ! Call DebugN(DOSNE)
.head 11 -  Set dTEDAT99999 = dTEDAT + 0.99999
.head 11 +  If bvipDAY
.head 12 +  If bEKV
.head 13 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,0,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,
         :nstmt,:SQ,:sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and
          o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,0,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and o.s>0 and
          r.ref=o.ref and r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),0,''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and TRUNC(r.dat_a)>=:dFirst and TRUNC(r.dat_a)<=:dTEDAT
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),0,''
    FROM dual
    ORDER BY 1,2"
.head 13 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,0,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,
         :nstmt,:SQ,:sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and
          o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,0,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and o.s>0 and
          r.ref=o.ref and r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),0,''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a>=:dFirst and r.dat_a<=:dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),0,''
    FROM dual
    ORDER BY 1,2"
.head 13 -  Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,0,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,
         :nstmt,:SQ,:sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and
          o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,0,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and o.s>0 and
          r.ref=o.ref and r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,0,'',to_number(null),0,''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a>=:dFirst and r.dat_a<=:dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),0,''
    FROM dual
    ORDER BY 1,2"
.head 12 +  Else
.head 13 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,
         :nstmt,:sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and
          o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and o.s>0 and
          r.ref=o.ref and r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and TRUNC(r.dat_a)>=:dFirst and TRUNC(r.dat_a)<=:dTEDAT
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 13 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,
         :nstmt,:sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and
          o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and o.s>0 and
          r.ref=o.ref and r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a>=:dFirst and r.dat_a<=:dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 13 -  Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,
         :nstmt,:sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and
          o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat>=:dFirst and o.fdat<=:dTEDAT and o.ref=p.ref and o.s>0 and
          r.ref=o.ref and r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,0,'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a>=:dFirst and r.dat_a<=:dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 11 +  Else
.head 12 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,:nstmt,
         :sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0 and r.ref=o.ref and
          r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and TRUNC(r.dat_a)=:dTEDAT
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 12 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,:nstmt,
         :sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0 and r.ref=o.ref and
          r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a between :dTEDAT and :dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 12 -  Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,:nstmt,
         :sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0 and r.ref=o.ref and
          r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,0,'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a between :dTEDAT and :dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "', 'DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 11 -  Set bOk = TRUE
.head 10 +  Else
.head 11 +  If bvipDAY
.head 12 -  Set sPlic1 = "p_lic1(nId,dFirst,dTEDAT,sNLS)"
.head 11 +  Else
.head 12 -  Set sPlic1 = "p_lic1(nId,dTEDAT,dTEDAT,sNLS)"
.head 11 +  If SqlPLSQLCommand(hSqlAux3(), sPlic1)
.head 12 -  Call SqlCommit(hSqlAux3())
.head 12 +  If bvipDAY
.head 13 +  If bEKV
.head 14 -  Set sSql2 = "
    SELECT decode(substr(s,1,1),'-',0,1),ABS(s/100),ref,tt,nazn,nd,sk || '',mfo,nls,nlsk,namk,namk,
           fdat,0,gl.p_icurval(kv,ABS(s),fdat)/100
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:FDAT1,:nPEREK,:SQ
    FROM tmp_lic
    WHERE fdat>=:dFirst and fdat<=:dTEDAT and kv=:nKV and acc=:ACC and id=:nId
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0,0
    FROM dual
    ORDER BY 1,2"
.head 13 +  Else
.head 14 -  Set sSql2 = "
    SELECT decode(substr(s,1,1),'-',0,1),ABS(s/100),ref,tt,nazn,nd,sk || '',mfo,nls,nlsk,namk,namk,
           fdat,0
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:FDAT1,:nPEREK
    FROM tmp_lic
    WHERE fdat>=:dFirst and fdat<=:dTEDAT and kv=:nKV and acc=:ACC and id=:nId
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0
    FROM dual
    ORDER BY 1,2"
.head 12 +  Else
.head 13 +  If bEKV
.head 14 -  Set sSql2 = "
    SELECT decode(substr(s,1,1),'-',0,1),ABS(s/100),ref,tt,nazn,nd,sk || '',mfo,nls,nlsk,namk,namk,
           fdat,0,gl.p_icurval(kv,ABS(s),fdat)/100
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:FDAT1,:nPEREK,:SQ
    FROM tmp_lic
    WHERE fdat=:dTEDAT and kv=:nKV and acc=:ACC and id=:nId
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0,0
    FROM dual
    ORDER BY 1,2"
.head 13 +  Else
.head 14 -  Set sSql2 = "
    SELECT decode(substr(s,1,1),'-',0,1),ABS(s/100),ref,tt,nazn,nd,sk || '',mfo,nls,nlsk,namk,namk,
           fdat,0
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:FDAT1,:nPEREK
    FROM tmp_lic
    WHERE fdat=:dTEDAT and kv=:nKV and acc=:ACC and id=:nId
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0
    FROM dual
    ORDER BY 1,2"
.head 12 -  Set bOk = TRUE
.head 11 +  Else
.head 12 -  Call SqlRollback(hSqlAux3())
.head 12 -  Set bOk = FALSE
.head 10 +  If bOk
.head 11 -  Call Klient1_VIP(tbKLI.dSab)
.head 11 -  Call SalTblSetFocusRow(tbKLI, TEK)
.head 11 -  Call SalTblSetContext(tbKLI, TEK)
.head 11 -  Set tbKLI.nVip = tbKLI.nVip + 1
.head 11 -  Call SalUpdateWindow(hWndForm)
.head 8 -  ! сальдовка
.head 8 +  If cb3 and tbKLI.sXXX = 'TXT'
.head 9 -  Set nOtc = 2
.head 9 -  Set NAMK = tbKLI.dKli
.head 9 -  Set sSql2 = "
    SELECT t.lcv,a.nls,a.ostc/100,a.blkd,a.blkk,c.nmk
    INTO :TT,:NLSK,:S,:REF,:DK,:NAMK
    FROM accounts a, tabval t, cust_acc cu, customer c, conts co
    WHERE a.nls=co.nls and a.kv=co.kv and a.kv=t.kv and a.acc=cu.acc and cu.rnk=c.rnk and a.accc in (
          SELECT a1.acc
          FROM accounts a1, cust_acc cu1
          WHERE a1.acc=cu1.acc and cu1.rnk=:tbKLI.nRnk)
    ORDER BY 1,2"
.head 9 -  Call Klient1_SAL(tbKLI.dSab)
.head 8 -  ! выписки по дипазону дат
.head 8 +  If cbOtDo
.head 9 -  Set dTEDAT = dfDatOt
.head 9 -  Set tbKLI.nVip = 0
.head 9 -  Set dDATtek = dDAT
.head 9 +  While dTEDAT <= dfDatDo
.head 10 -  ! If dTEDAT присутствует в FDAT выполнить
.head 10 -  Set nOtc = 1
.head 10 -  Set DD = SalStrRightX('0' || Str(SalDateDay(dTEDAT)), 2)
.head 10 -  Set MM = SalStrRightX('0' || Str(SalDateMonth(dTEDAT)), 2)
.head 10 -  Set dDAT = dTEDAT
.head 10 -  Set xxx = tbKLI.sXXX
.head 10 -  Set OKPO = tbKLI.sOKPO
.head 10 -  Set sSql2a = T("
    SELECT a.acc,a.nls,a.kv
    INTO :ACC,:sNLS,:nKV
    FROM cust_acc cu, conts co, sal a
    WHERE co.NUMB=:tbKLI.sXXX and co.NEK=:tbKLI.dSab and
          cu.rnk=:tbKLI.nRnk and :dTEDAT in (SELECT fdat
                                             FROM fdat) and a.nls=co.nls and a.kv=co.kv and a.acc=cu.acc and
          a.fdat=:dTEDAT" || IifS(cb21, " and a.dos+a.kos>0", ""))
.head 10 +  If SqlPrepareAndExecute(hSqlAux2(), sSql2a) and
   SqlFetchNext(hSqlAux2(), nFetchRes)
.head 11 -  Set nLim = 0
.head 11 -  Set nSOZDO = 0
.head 11 -  Set DOSNE = 0
.head 11 +  If nKV = nBaseVal
.head 12 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT decode(a.tip,'BLD',0,a.lim)/100
   INTO :nLim
   FROM accounts a, acc_over o
   WHERE a.acc=:ACC and a.acc=o.acc")
.head 13 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 12 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT s.dos/100
   INTO :nSOZDO
   FROM accounts a, acc_over o, sal s
   WHERE a.acc=:ACC and a.acc in (SELECT acc
                                  FROM acc_over
                                  WHERE acc=acco) and a.acc=o.acco and s.acc=o.acc_8000 and
         s.fdat=:dTEDAT")
.head 13 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 12 +  If rbPlus
.head 13 +  If SqlPrepareAndExecute(hSqlAux(), "
   SELECT sum(o.s)/100
   INTO :DOSNE
   FROM opldok o, arc_rrp r
   WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.s>0 and r.ref=o.ref and r.sos<5")
.head 14 -  Call SqlFetchNext(hSqlAux(), nFetchRes)
.head 12 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,:nstmt,
         :sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0 and r.ref=o.ref and
          r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and TRUNC(r.dat_a)=:dTEDAT
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 12 -  ! Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,:nstmt,
         :sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0 and r.ref=o.ref and
          r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,decode(:nSEP,2,0,1),'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a between :dTEDAT and :dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 12 -  Set sSql2 = "
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:OKPOK,:FDAT1,:nPEREK,:OKPOK2,:nstmt,
         :sDREC
    FROM opldok o, oper p
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0" || IifS(rbPlus, "
 MINUS
    SELECT o.dk,o.s/100,o.ref,o.tt,p.nazn,p.nd,p.sk || '',p.mfob,p.nlsa,p.nlsb,p.nam_a,p.nam_b,p.id_b,
           o.fdat,0,p.id_a,o.stmt,p.d_rec
    FROM opldok o, oper p, arc_rrp r
    WHERE o.sos=5 and o.acc=:ACC and o.fdat=:dTEDAT and o.ref=p.ref and o.s>0 and r.ref=o.ref and
          r.sos<5", "") || "
 UNION ALL
    SELECT r.dk,r.s/100,r.ref,'ЗПТ',r.nazn,r.nd,'',r.mfoa,r.nlsb,r.nlsa,r.nam_b,r.nam_a,r.id_a,
           TRUNC(r.dat_a)+.5,0,'',to_number(null),''
    FROM arc_rrp r, accounts a
    WHERE r.dk>1 and r.nazns<>'33' and a.nls=r.nlsb and r.kv=:nBaseVal and a.kv=:nBaseVal and
          a.acc=:ACC and r.dat_a between :dTEDAT and :dTEDAT99999
 UNION ALL
    SELECT 5,0,0,'','','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0,'',to_number(null),''
    FROM dual
    ORDER BY 1,2"
.head 12 -  Set bOk = TRUE
.head 11 +  Else
.head 12 +  If SqlPLSQLCommand(hSqlAux3(), "p_lic1(nId,dTEDAT,dTEDAT,sNLS)")
.head 13 -  Call SqlCommit(hSqlAux3())
.head 13 +  If bEKV
.head 14 -  Set sSql2 = "
    SELECT decode(substr(s,1,1),'-',0,1),ABS(s/100),ref,tt,nazn,nd,sk || '',mfo,nls,nlsk,namk,namk,
           fdat,0,gl.p_icurval(kv,ABS(s),fdat)/100
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:FDAT1,:nPEREK,:SQ
    FROM tmp_lic
    WHERE fdat=:dTEDAT and kv=:nKV and acc=:ACC and id=:nId
    UNION ALL
    SELECT 5,0,0,'','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0,0
    FROM dual
    ORDER BY 1,2"
.head 13 +  Else
.head 14 -  Set sSql2 = "
    SELECT decode(substr(s,1,1),'-',0,1),ABS(s/100),ref,tt,nazn,nd,sk || '',mfo,nls,nlsk,namk,namk,
           fdat,0
    INTO :DK,:S,:REF,:TT,:NAZ_P,:ND,:SK,:MFO,:NLSA,:NLSB,:NAMA,:NAMB,:FDAT1,:nPEREK
    FROM tmp_lic
    WHERE fdat=:dTEDAT and kv=:nKV and acc=:ACC and id=:nId
    UNION ALL
    SELECT 5,0,0,'','','','','','','','','',TO_DATE('" ||
           SalFmtFormatDateTime(dTEDAT, 'ddMMyyyy') || "','DDMMYYYY')+.5,0
    FROM dual
    ORDER BY 1,2"
.head 13 -  Set bOk = TRUE
.head 12 +  Else
.head 13 -  Call SqlRollback(hSqlAux3())
.head 13 -  Set bOk = FALSE
.head 11 +  If bOk
.head 12 -  Call Klient1_VIP(tbKLI.dSab)
.head 12 -  Call SalTblSetFocusRow(tbKLI, TEK)
.head 12 -  Call SalTblSetContext(tbKLI, TEK)
.head 12 -  Set tbKLI.nVip = tbKLI.nVip + 1
.head 12 -  Call SalUpdateWindow(hWndForm)
.head 10 -  Set dTEDAT = dTEDAT + 1
.head 9 -  Set dDAT = dDATtek
.head 5 +  Else
.head 6 -  Break
.head 4 -  Set cbOtDo = 0
.head 4 -  Call SalTblSetFocusRow(tbKLI, nFocus)
.head 4 -  Call SalWaitCursor(FALSE)
.head 3 +  On SAM_ReportStart
.head 4 -  Return SqlPrepare(hSql(), sSql2)
.head 3 +  On SAM_ReportFetchInit
.head 4 -  Return SqlExecute(hSql())
.head 3 +  On SAM_ReportFetchNext
.head 4 +  If SqlFetchNext(hSql(), nFetchRes)
.head 5 +  If nOtc = 1 ! выписки
.head 6 -  !  FALSE ! пока не надо
.head 6 +  If FALSE
.head 7 -  ! здесь присобачить ТИЛЬДу к NAZ_P
.head 7 +  If SqlPrepareAndExecute(hSqlAux2(), T("
   SELECT value
   INTO :sTILDA
   FROM operw
   WHERE tag='RCK_D' and ref=:REF"))
.head 8 +  If not SqlFetchNext(hSqlAux2(), nFetchRes)
.head 9 -  Set sTILDA = ''
.head 7 +  Else
.head 8 -  Set sTILDA = ''
.head 7 -  Set NAZ_P = NAZ_P || IifS(Len(sTILDA)>0, '~' || sTILDA || '~', '')
.head 6 +  If nPEREK = 1 ! перекодировать
.head 7 -  Set NAZ_P = StrDosToWinX(NAZ_P)
.head 7 -  Set ND    = StrDosToWinX(ND)
.head 7 -  Set NAMA  = StrDosToWinX(NAMA)
.head 7 -  Set NAMB  = StrDosToWinX(NAMB)
.head 6 -  ! МФО, контрсчёт, его наименование для ПРОВОДКИ
.head 6 -  Set NAMK = NAMB
.head 6 -  Set NAMO = NAMA
.head 6 +  If TT = 'R01' or TT = 'D01'
.head 7 +  ! If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT nazn,ND,id_a,mfoa,nlsa,nam_a,nam_b
   INTO :NAZ_P,:ND,:OKPOK,:MFO,:NLSK,:NAMK,:NAMO
   FROM arc_rrp
   WHERE ref=:REF")
.head 8 +  If SqlFetchNext(hSqlAux3(), nFetchRes)
.head 9 +  If GetGlobalOptionEx('SEPNUM') = 2
.head 10 -  ! Set NAZ_P = NAZ_P
.head 10 -  ! Set ND = ND
.head 10 -  ! Set NAMK = NAMK
.head 10 -  ! Set NAMO = NAMO
.head 9 +  Else 
.head 10 -  Set NAZ_P = StrDosToWinX(NAZ_P)
.head 10 -  Set ND = StrDosToWinX(ND)
.head 10 -  Set NAMK = StrDosToWinX(NAMK)
.head 10 -  Set NAMO = StrDosToWinX(NAMO)
.head 7 +  ! If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT substr(decode(:nSEP,2,nazn,convert(nazn,'CL8MSWIN1251','RU8PC866')),1,200),
          substr(decode(:nSEP,2,ND,convert(ND,'CL8MSWIN1251','RU8PC866')),1,200),id_a,mfoa,nlsa,
          substr(decode(:nSEP,2,nam_a,convert(nam_a,'CL8MSWIN1251','RU8PC866')),1,200),
          substr(decode(:nSEP,2,nam_b,convert(nam_b,'CL8MSWIN1251','RU8PC866')),1,200)
   INTO :NAZ_P,:ND,:OKPOK,:MFO,:NLSK,:NAMK,:NAMO
   FROM arc_rrp
   WHERE ref=:REF")
.head 8 -  If SqlFetchNext(hSqlAux3(), nFetchRes)
.head 7 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT nazn,ND,id_a,mfoa,nlsa,nam_a,nam_b
   INTO :NAZ_P,:ND,:OKPOK,:MFO,:NLSK,:NAMK,:NAMO
   FROM arc_rrp
   WHERE ref=:REF and nvl(bis,0)<=1")
.head 8 -  If SqlFetchNext(hSqlAux3(), nFetchRes)
.head 6 +  Else If TT = '901'
.head 7 -  ! Call Debug('1 - ' || sDREC)
.head 7 +  If Len(sDREC) > 0 and Left(sDREC, 2) = '#C'
.head 8 -  ! Call Debug('2')
.head 8 -  Set sTmp = Subs(sDREC, 3, Len(sDREC)-3)
.head 8 -  Set nNumTokens = SalStrTokenize(sTmp, '', ',', sTokenArray)
.head 8 -  Set MFO = sTokenArray[0]
.head 8 -  Set NLSK = sTokenArray[1]
.head 8 -  Set NAMK = sTokenArray[2]
.head 8 +  If nNumTokens > 3
.head 9 -  Set nI = 3
.head 9 +  While nI <= nNumTokens
.head 10 -  Set NAMK = NAMK || sTokenArray[nI]
.head 10 -  Set nI = nI + 1
.head 8 -  Set OKPOK = OKPOK2
.head 6 +  Else If TT = 'ЗПТ'
.head 7 -  Set NLSK = NLSB
.head 6 +  Else
.head 7 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT fli,name
   INTO :nFli,:sTmp
   FROM tts
   WHERE tt=:TT") and SqlFetchNext(hSqlAux3(), nFetchRes)
.head 8 +  If nFli = 1 ! межбанк
.head 9 -  Set NLSK = NLSB
.head 9 -  Set NAMK = NAMB
.head 8 +  Else
.head 9 -  Set MFO = AMFO
.head 9 -  Set nTmp = -S * 100 * (2 * DK - 1)
.head 9 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT acc,NLS
   INTO :nFli,:NLSK
   FROM OPL
   WHERE REF=:REF and TT=:TT and s*(2*dk-1)=:nTmp and stmt=:nstmt") and SqlFetchNext(hSqlAux3(), nFetchRes)
.head 10 +  If SalStrTrimX(NLSK) = SalStrTrimX(NLSA)
.head 11 -  Set NAMK = NAMA
.head 11 -  Set OKPOK = OKPOK2
.head 10 +  Else If SalStrTrimX(NLSK) = SalStrTrimX(NLSB)
.head 11 -  Set NAMK = NAMB
.head 10 +  Else
.head 11 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT substr(nms,1,38)
   INTO :NAMK
   FROM accounts
   WHERE acc=:nFli")
.head 12 -  Call SqlFetchNext(hSqlAux3(), nFetchRes)
.head 11 -  Set NAZ_P = sTmp
.head 11 -  Set OKPOK = GetBankOkpoS()
.head 10 -  Set NAMO = NAMB
.head 9 +  Else
.head 10 +  If nKV = nBaseVal
.head 11 -  Set NLSK = NLSA
.head 11 -  Set NAMK = NAMA
.head 10 +  Else
.head 11 -  Set NLSK = NLSB
.head 11 -  Set NAMK = NAMB
.head 11 -  Set OKPOK = GetValueStr("
    SELECT c.okpo
    FROM customer c, accounts a, cust_acc cu
    WHERE a.nls='" || NLSK || "' and a.kv=" || Str(nKV) || " and a.acc=cu.acc and cu.rnk=c.rnk")
.head 10 -  ! Call Debug('NAMK='||NAMK)
.head 10 -  ! Call Debug('NLSK='||NLSK)
.head 6 -  ! Наименование банка-корреспондента
.head 6 -  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT nb
   INTO :NB
   FROM banks
   WHERE mfo=:MFO") and SqlFetchNext(hSqlAux3(), nFetchRes)
.head 6 +  If OKPOK = ''
.head 7 -  Set OKPOK = GetBankOkpoS()
.head 6 -  Set ND = Left(ND || Spac(10), 10) || IifS(TT='KL1' or TT='KL2', ' ', '*') || MFO || ' ' || Left(NLSK || Spac(14), 15)
    || Left(OKPOK || Spac(10), 10)
.head 6 -  Set NAZ_P2 = Subs(NAZ_P, 55, 54)
.head 6 -  Set NAZ_P3 = Subs(NAZ_P, 109, 54)
.head 6 -  Set NAZ_P = Left(NAZ_P, 54)
.head 5 -  Return TRUE
.head 4 -  Return FALSE
.head 3 +  On SAM_ReportNotify
.head 4 +  If lParam = RPT_BeforeReportHeader
.head 5 +  If nOtc = 1
.head 6 -  ! признак заключительной выписки
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'ZAK', IifN(dTEDAT!=GetBankDate() or cbZAK=1, 1, 0))
.head 6 -  !
.head 6 -  Call SalReportSetStringVar(SalNumberToWindowHandle(wParam), 'AMFO', OKPO)
.head 6 -  ! Call SalReportSetStringVar(SalNumberToWindowHandle(wParam), 'AQH', OKPO)
.head 6 -  Call SalReportSetStringVar(SalNumberToWindowHandle(wParam), 'NMK', tbKLI.dKli)
.head 6 -  ! Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,s.dos/100,s.kos/100
     INTO :NLS,:ISO,:OST2,:DOS,:KOS
     FROM sal s, tabval t
     WHERE s.fdat=:dTEDAT AND s.acc=:ACC AND s.kv=t.kv")
.head 6 -  ! Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,decode(s.nbs,'2600',decode(sign(s.ost),-1,0,s.ost),s.ost)/100,s.dos/100,s.kos/100
     INTO :NLS,:ISO,:OSTn,:OST2,:DOS,:KOS
     FROM sal s, tabval t
     WHERE s.fdat=:dTEDAT AND s.acc=:ACC AND s.kv=t.kv")
.head 6 -  !
.head 6 -  ! Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,s.dos/100,s.kos/100,t.name,t.kv,gl.p_icurval(s.kv,s.ost,s.fdat)/100,
            gl.p_icurval(s.kv,s.dos,s.fdat)/100,gl.p_icurval(s.kv,s.kos,s.fdat)/100
     INTO :NLS,:ISO,:OST2,:DOS,:KOS,:sNameVal,:nKv,:OST2Q,:DOSQ,:KOSQ
     FROM sal s, tabval t
     WHERE s.fdat=:dTEDAT and s.acc=:ACC and s.kv=t.kv")
.head 6 -  ! Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,s.dos/100,s.kos/100,t.name,t.kv,gl.p_icurval(s.kv,s.ost,s.fdat)/100,
            gl.p_icurval(s.kv,s.dos,s.fdat)/100,gl.p_icurval(s.kv,s.kos,s.fdat)/100,
            (b.dos-gl.P_ICURVAL(s.kv,s.dos,s.fdat))/100,(b.kos-gl.P_ICURVAL(s.kv,s.kos,s.fdat))/100
     INTO :NLS,:ISO,:OST2,:DOS,:KOS,:sNameVal,:nKv,:OST2Q,:DOSQ,:KOSQ,:DOSPER,:KOSPER
     FROM sal s, tabval t, salb b
     WHERE s.fdat=:dTEDAT and s.fdat=b.fdat and s.acc=:ACC and b.acc=s.acc and s.kv=t.kv")
.head 6 -  Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,s.dos/100,s.kos/100,t.name,t.kv,gl.p_icurval(s.kv,s.ost,s.fdat)/100,
            NVL(b.dos/100,0),NVL(b.kos/100,0),
            NVL((b.dos-gl.P_ICURVAL(s.kv,s.dos,s.fdat))/100,0),NVL((b.kos-gl.P_ICURVAL(s.kv,s.kos,s.fdat))/100,0)
     INTO :NLS,:ISO,:OST2,:DOS,:KOS,:sNameVal,:nKv,:OST2Q,:DOSQ,:KOSQ,:DOSPER,:KOSPER
     FROM sal s, tabval t, salb b
     WHERE s.fdat=:dTEDAT and s.fdat=b.fdat(+) and s.acc=:ACC and s.acc=b.acc(+) and s.kv=t.kv")
.head 6 +  ! If nKV = nBaseVal
.head 7 -  Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,s.dos/100,s.kos/100,t.name,t.kv,gl.p_icurval(s.kv,s.ost,s.fdat)/100,
            gl.p_icurval(s.kv,s.dos,s.fdat)/100,gl.p_icurval(s.kv,s.kos,s.fdat)/100,
            0,                                          0
     INTO :NLS,:ISO,:OST2,:DOS,:KOS,:sNameVal,:nKv,:OST2Q,:DOSQ,:KOSQ,:DOSPER,:KOSPER
     FROM sal s, tabval t
     WHERE s.fdat=:dTEDAT and s.acc=:ACC and s.kv=t.kv")
.head 6 +  ! Else ! nKV != nBaseVal
.head 7 -  Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT s.nls,t.lcv,s.ost/100,s.dos/100,s.kos/100,t.name,t.kv,gl.p_icurval(s.kv,s.ost,s.fdat)/100,
            b.dos/100,                          b.kos/100,
            (b.dos-gl.P_ICURVAL(s.kv,s.dos,s.fdat))/100,(b.kos-gl.P_ICURVAL(s.kv,s.kos,s.fdat))/100
     INTO :NLS,:ISO,:OST2,:DOS,:KOS,:sNameVal,:nKv,:OST2Q,:DOSQ,:KOSQ,:DOSPER,:KOSPER
     FROM sal s, tabval t, salb b
     WHERE s.fdat=:dTEDAT and s.fdat=b.fdat and s.acc=:ACC and b.acc=s.acc and s.kv=t.kv")
.head 6 +  If SqlFetchNext(hSqlAux3(), nFetchRes)
.head 7 +  If nKv = nBaseVal or not bEKV
.head 8 -  Set OST2Q = 0
.head 8 -  Set DOSQ = 0
.head 8 -  Set KOSQ = 0
.head 7 +  If bKURSP
.head 8 -  Set KURS = 0
.head 8 +  If nKv != nBaseVal
.head 9 +  ! If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT rate_o
   INTO :KURS
   FROM cur_rates
   WHERE vdate=(SELECT max(vdate)
                FROM cur_rates
                WHERE vdate<=:dTEDAT and kv=:nKv) and kv=:nKv")
.head 10 -  Call SqlFetchNext(hSqlAux3(), nFetchRes)
.head 9 -  Set nBSUM = 1
.head 9 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT rates.GetRateO(:nKv,:dTEDAT)
   INTO :KURS
   FROM dual")
.head 10 -  Call SqlFetchNext(hSqlAux3(), nFetchRes)
.head 10 +  If bKURSB
.head 11 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT rates.GetBsum(:nKv,:dTEDAT)
   INTO :nBSUM
   FROM dual")
.head 12 -  Call SqlFetchNext(hSqlAux3(), nFetchRes)
.head 10 -  Set KURS = KURS * nBSUM
.head 7 +  If bvipDAY and not cbOtDo
.head 8 -  Call SqlPrepareAndExecute(hSqlAux3(), "
     SELECT SUM(dos/100),SUM(kos/100)
     INTO :DOS,:KOS
     FROM sal
     WHERE fdat>=:dFirst and fdat<=:dTEDAT and acc=:ACC")
.head 8 -  Call SqlFetchNext(hSqlAux3(), nFetchRes)
.head 7 +  If bISO
.head 8 -  ! Set ISO = Right('000' || Str(nKv), 3) || ' ' || ISO || ' ' || StrWinToDosX(sNameVal)
.head 8 -  Set ISO = Right('000' || Str(nKv), 3) || ' ' || ISO || ' ' || sNameVal
.head 7 +  If bvipDAY and not cbOtDo
.head 8 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT max(fdat)
   INTO :DAPP
   FROM saldoa
   WHERE fdat<:dFirst and acc=:ACC") and SqlFetchNext(hSqlAux3(), nFetchRes)
.head 9 -  Call SalReportSetDateTimeVar(SalNumberToWindowHandle(wParam), 'DAPP', DAPP)
.head 7 +  Else
.head 8 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT max(fdat)
   INTO :DAPP
   FROM saldoa
   WHERE fdat<:dTEDAT and acc=:ACC") and SqlFetchNext(hSqlAux3(), nFetchRes)
.head 9 -  Call SalReportSetDateTimeVar(SalNumberToWindowHandle(wParam), 'DAPP', DAPP)
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute(hSqlAux3(), "
   SELECT mfo
   INTO :sMFO_bank_acc
   FROM bank_acc
   WHERE acc=:ACC") and SqlFetchNext(hSqlAux3(), nFetchRes)
.head 8 -  Set MFOHEADER = sMFO_bank_acc
.head 7 +  Else
.head 8 -  Set MFOHEADER = AMFO
.head 7 -  !
.head 7 -  Call SalReportSetStringVar(SalNumberToWindowHandle(wParam), 'MFOHEADER', MFOHEADER)
.head 7 -  Call SalReportSetStringVar(SalNumberToWindowHandle(wParam), 'NLS', NLS)
.head 7 -  Call SalReportSetStringVar(SalNumberToWindowHandle(wParam), 'ISO', ISO)
.head 7 -  Call SalReportSetDateTimeVar(SalNumberToWindowHandle(wParam), 'FDAT', dDAT)
.head 7 -  Call SalReportSetDateTimeVar(SalNumberToWindowHandle(wParam), 'TEDAT', dTEDAT)
.head 7 -  ! Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST1',
     IifN(OSTn+DOS-KOS<0, 0, OSTn+DOS-KOS))
.head 7 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST1', OST2+DOS-KOS)
.head 7 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST1Q', OST2Q+DOSQ-KOSQ)
.head 7 -  ! Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2', OST2)
.head 7 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2', OST2+DOSNE)
.head 7 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2Q', OST2Q)
.head 7 -  !
.head 7 +  If bKURSP
.head 8 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOSPER', DOSPER)
.head 8 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'KOSPER', KOSPER)
.head 8 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'KURS', KURS)
.head 4 -  ! для UPB
.head 4 -  ! If lParam = RPT_BeforeReportFooter or lParam = RPT_BeforeBreakFooter1 or
     lParam = RPT_BeforeBreakFooter2 --- такого НЕ НАДО
.head 4 +  If lParam = RPT_BeforeReportFooter
   !! or lParam = RPT_BeforeBreakFooter1 or lParam = RPT_BeforeBreakFooter2
.head 5 +  If nOtc = 1
.head 6 -  ! Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOS', DOS)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOS', DOS-DOSNE)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOSQ', DOSQ)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'KOS', KOS)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'KOSQ', KOSQ)
.head 6 -  ! Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2', OST2)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2', OST2+DOSNE)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2Q', OST2Q)
.head 4 -  ! для Aviatek
.head 4 +  If lParam = RPT_BeforeBreakFooter1
.head 5 +  If nOtc = 1
.head 6 -  ! Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOS', DOS)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOS', DOS-DOSNE)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'DOSQ', DOSQ)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'KOS', KOS)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'KOSQ', KOSQ)
.head 6 -  ! Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2', OST2)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2', OST2+DOSNE)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'OST2Q', OST2Q)
.head 6 -  Call SalReportSetNumberVar(SalNumberToWindowHandle(wParam), 'SOZDO', nSOZDO)
.head 3 +  On WM_MouseMove
.head 4 -  Call BitMap()
.head 3 +  On WM_Paint
.head 4 -  Call BitMap()
.head 3 +  ! On WM_SysCommand ! (61728)
.head 4 -  Call DebugN(wParam)
.head 4 +  If wParam = 61728
.head 5 -  Call SalSendMsg(hWndForm, WM_Paint, 0, 0)
.head 5 -  ! Call BitMap()
.head 3 +  On SAM_Close
.head 4 +  If SalMessageBox("Вы намерены прекратить работу ?", "Внимание !", MB_YesNo) = IDYES
.head 5 -  Call SalQuit()
.head 4 +  Else
.head 5 -  Return FALSE
.head 3 +  On SAM_Destroy
.head 4 +  ! If ccDoc.bSignInited
.head 5 -  Set nTmp = CLOSE_ZAH()
.head 4 +  ! If SqlPrepareAndExecute(hSqlAux2(), "
   DELETE
   FROM zag_nok
   WHERE DAT<=bankdate-20") and SqlCommitEx(hSqlAux2(), 'Очистка zag_nok')
.head 5 -  Return TRUE
.head 4 +  If SqlPrepareAndExecute(hSqlAux2(), "
   DELETE
   FROM zag_nok
   WHERE DAT<=bankdate-" || sDayArc) and SqlCommitEx(hSqlAux2(), 'Очистка zag_nok')
.head 5 -  Return TRUE
.head 4 +  Else
.head 5 -  Return FALSE
.head 1 +  Table Window: NOKF
.head 2 -  Class: cGenericTable
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Файлы за предыдущие дни
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? Class Default
.head 2 -  Visible? Class Default
.head 2 -  Display Settings
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Class Default
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Class Default
.head 3 -  Minimizable? Class Default
.head 3 -  System Menu? Class Default
.head 3 -  Resizable? Class Default
.head 3 -  Window Location and Size
.head 4 -  Left:   0.825"
.head 4 -  Top:    0.688"
.head 4 -  Width:  Class Default
.head 4 -  Width Editable? Class Default
.head 4 -  Height: Class Default
.head 4 -  Height Editable? Class Default
.head 3 -  Font Name: Class Default
.head 3 -  Font Size: Class Default
.head 3 -  Font Enhancement: Class Default
.head 3 -  Text Color: Class Default
.head 3 -  Background Color: Class Default
.head 3 -  View: Class Default
.head 3 -  Allow Row Sizing? Class Default
.head 3 -  Lines Per Row: Class Default
.head 2 -  Memory Settings
.head 3 -  Maximum Rows in Memory: 3000
.head 3 -  Discardable? Class Default
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Class Default
.head 4 -  Location? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Size: Class Default
.head 4 -  Size Editable? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 3 +  Contents
.head 4 +  Pushbutton: pbIns
.head 5 -  Class Child Ref Key: 33
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDel
.head 5 -  Class Child Ref Key: 34
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbRefresh
.head 5 -  Class Child Ref Key: 35
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbUpdate
.head 5 -  Class Child Ref Key: 36
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 58444
.head 5 -  Class Child Ref Key: 37
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbSearch
.head 5 -  Class Child Ref Key: 38
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbFilter
.head 5 -  Class Child Ref Key: 44
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDetails
.head 5 -  Class Child Ref Key: 39
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Click
.head 7 +  If not IsWindow(hNOK)
.head 8 -  Set hNOK = SalCreateWindow(NOK, hWndMDI, nStmt, NOKF.FN, NOKF.YYYYMM)
.head 4 +  Pushbutton: pbPrint
.head 5 -  Class Child Ref Key: 40
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 58445
.head 5 -  Class Child Ref Key: 41
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbExit
.head 5 -  Class Child Ref Key: 42
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 58446
.head 5 -  Class Child Ref Key: 43
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 2 +  Contents
.head 3 +  Column: FN
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Имя файла
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: String
.head 4 -  Justify: Left
.head 4 -  Width:  2.167"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: YYYYMM
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Год, месяц
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: String
.head 4 -  Justify: Left
.head 4 -  Width:  1.417"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: DAT
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Дата + время обработки
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Date/Time
.head 4 -  Justify: Center
.head 4 -  Width:  2.367"
.head 4 -  Width Editable? Yes
.head 4 -  Format: DateTime
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: nStmt
.head 2 +  Window Variables
.head 3 -  Window Handle: hNOK
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Set NOKF.strPrintFileName = 'NOKF'
.head 4 -  ! Set NOKF.strSqlPopulate = "
    SELECT fn,TRUNC(dat),to_char(dat,'YYYYMM')
    INTO :NOKF.FN,:NOKF.DAT,:NOKF.YYYYMM
    FROM zag_nok
    GROUP BY fn,TRUNC(dat),to_char(dat,'YYYYMM')
    ORDER BY 2 DESC"
.head 4 -  Set NOKF.strSqlPopulate = "
    SELECT z1.fn,z1.dat,to_char(z1.dat,'YYYYMM')
    INTO :NOKF.FN,:NOKF.DAT,:NOKF.YYYYMM
    FROM zag_nok z1
    WHERE z1.rec=(select max(z2.rec)
                  from zag_nok z2
                  where z2.fn=z1.fn)
    ORDER BY 2 DESC"
.head 4 -  Set NOKF.strSqlDelete = "
    DELETE
    FROM zag_nok
    WHERE FN=:NOKF.FN"
.head 4 -  Call SalSendClassMessage(SAM_Create, 0, 0)
.head 1 +  Table Window: NOK
.head 2 -  Class: cGenericTable
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Документы файла
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? Class Default
.head 2 -  Visible? Class Default
.head 2 -  Display Settings
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Class Default
.head 3 -  Initial State: Class Default
.head 3 -  Maximizable? Class Default
.head 3 -  Minimizable? Class Default
.head 3 -  System Menu? Class Default
.head 3 -  Resizable? Class Default
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  Class Default
.head 4 -  Width Editable? Class Default
.head 4 -  Height: Class Default
.head 4 -  Height Editable? Class Default
.head 3 -  Font Name: Class Default
.head 3 -  Font Size: Class Default
.head 3 -  Font Enhancement: Class Default
.head 3 -  Text Color: Class Default
.head 3 -  Background Color: Class Default
.head 3 -  View: Class Default
.head 3 -  Allow Row Sizing? Class Default
.head 3 -  Lines Per Row: Class Default
.head 2 -  Memory Settings
.head 3 -  Maximum Rows in Memory: Class Default
.head 3 -  Discardable? Class Default
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Class Default
.head 4 -  Location? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Size: Class Default
.head 4 -  Size Editable? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 3 +  Contents
.head 4 +  Pushbutton: pbIns
.head 5 -  Class Child Ref Key: 33
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDel
.head 5 -  Class Child Ref Key: 34
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbRefresh
.head 5 -  Class Child Ref Key: 35
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbUpdate
.head 5 -  Class Child Ref Key: 36
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 58447
.head 5 -  Class Child Ref Key: 37
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbSearch
.head 5 -  Class Child Ref Key: 38
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbFilter
.head 5 -  Class Child Ref Key: 44
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDetails
.head 5 -  Class Child Ref Key: 39
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbPrint
.head 5 -  Class Child Ref Key: 40
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 58448
.head 5 -  Class Child Ref Key: 41
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbExit
.head 5 -  Class Child Ref Key: 42
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 58449
.head 5 -  Class Child Ref Key: 43
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 2 +  Contents
.head 3 +  Column: FILE
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Файл
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: String
.head 4 -  Justify: Left
.head 4 -  Width:  2.043"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: REF
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Реф док
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Right
.head 4 -  Width:  0.871"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: ND
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Документ
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Left
.head 4 -  Width:  1.029"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: NLSA
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Счет-А
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Left
.head 4 -  Width:  1.586"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: MFOB
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: МФО-Б
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Left
.head 4 -  Width:  Default
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: NLSB
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Счет-Б
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Left
.head 4 -  Width:  1.443"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: S
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Сумма
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Right
.head 4 -  Width:  1.643"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Decimal
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: SOS
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: SOS
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Left
.head 4 -  Width:  0.557"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: nPar
.head 3 -  String: sFa
.head 3 -  String: YYYYMM
.head 2 +  Window Variables
.head 3 -  Number: nCol
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Call SalTblSetLockedColumns(hWndForm, 1)
.head 4 -  Set NOK.strPrintFileName = 'NOK'
.head 4 -  Set NOK.strFilterTblName = 'OPER'
.head 4 -  Set NOK.strSqlPopulate = "
    SELECT w.value,OPER.ref,OPER.nd,OPER.nlsa,OPER.mfob,OPER.nlsb,OPER.s/100,OPER.sos
    INTO :NOK.FILE,:NOK.REF,:NOK.ND,:NOK.NLSA,:NOK.MFOB,:NOK.NLSB,:NOK.S,:NOK.SOS
    FROM operw w, oper
    WHERE OPER.ref=w.ref and w.tag='IDF'" || IifS(sFa='*', "", "and w.value=:NOK.sFa and
          to_char(oper.PDAT,'YYYYMM')=:NOK.YYYYMM ")
.head 4 -  Call SalSendClassMessage(SAM_Create, 0, 0)
.head 3 +  On SAM_FetchRowDone
.head 4 +  If SOS = 1
.head 5 -  Set nCol = COLOR_Green
.head 4 +  Else If SOS = 5
.head 5 -  Set nCol = COLOR_Black
.head 4 +  Else If SOS = 3
.head 5 -  Set nCol = COLOR_Blue
.head 4 +  Else If SOS = -1
.head 5 -  Set nCol = COLOR_Red
.head 4 +  Else
.head 5 -  Set nCol = COLOR_Burgundy
.head 4 -  Call SalTblSetCellTextColor(REF, nCol, TRUE)
.head 4 -  Call SalTblSetCellTextColor(ND, nCol, TRUE)
.head 4 -  Call SalTblSetCellTextColor(NLSA, nCol, TRUE)
.head 4 -  Call SalTblSetCellTextColor(NLSB, nCol, TRUE)
.head 4 -  Call SalTblSetCellTextColor(MFOB, nCol, TRUE)
.head 4 -  Call SalTblSetCellTextColor(S, nCol, TRUE)
.head 4 -  Call SalTblSetCellTextColor(SOS, nCol, TRUE)
.head 1 +  Dialog Box: dlg_Err
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Внимание!
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   2.388"
.head 4 -  Top:    0.927"
.head 4 -  Width:  7.0"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 5.036"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  Multiline Field: mlMess
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  String Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Border? Yes
.head 5 -  Word Wrap? Yes
.head 5 -  Vertical Scroll? Yes
.head 5 -  Window Location and Size
.head 6 -  Left:   0.086"
.head 6 -  Top:    0.281"
.head 6 -  Width:  6.757"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 2.7"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 4 -  Message Actions
.head 3 +  Pushbutton: pbDouble2
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Создать квитанцию и удалить (в BAD)
.head 4 -  Window Location and Size
.head 5 -  Left:   1.1"
.head 5 -  Top:    3.06"
.head 5 -  Width:  4.717"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.488"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Picture File Name: \Bars98\RESOURCE\BMP\bmPositive.bmp
.head 4 -  Picture Transparent Color: None
.head 4 -  Image Style: Single
.head 4 -  Text Color: Jade
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set nRP = 1
.head 6 -  Call SalDestroyWindow(hWndForm)
.head 3 +  Pushbutton: pbDouble3
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Не создавать квитанцию и удалить (в BAD)
.head 4 -  Window Location and Size
.head 5 -  Left:   1.1"
.head 5 -  Top:    3.607"
.head 5 -  Width:  4.717"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.488"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Picture File Name: \Bars98\RESOURCE\BMP\bmNegative.bmp
.head 4 -  Picture Transparent Color: None
.head 4 -  Image Style: Single
.head 4 -  Text Color: Burgundy
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set nRP = 3
.head 6 -  Call SalDestroyWindow(hWndForm)
.head 3 +  Pushbutton: pbTimer
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cTimer
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   2.886"
.head 5 -  Top:    3.0"
.head 5 -  Width:  1.2"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.292"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? No
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call pbTimer.Init(nInterval, 0, TRUE)
.head 5 +  On UM_TimerFired
.head 6 +  ! If nPar = 1
.head 7 -  Call SalSendMsg(pbDouble2, SAM_Click, 0, 0)
.head 6 -  Call SalSendMsg(pbExit, SAM_Click, 0, 0)
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Отложить обработку до следующего цикла
.head 4 -  Window Location and Size
.head 5 -  Left:   1.1"
.head 5 -  Top:    4.155"
.head 5 -  Width:  4.717"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.488"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Picture File Name: \Bars98\RESOURCE\BMP\DISCARD.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Dark Blue
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set nRP = 2
.head 6 -  Call SalDestroyWindow(hWndForm)
.head 3 +  Data Field: df1
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.086"
.head 6 -  Top:    0.073"
.head 6 -  Width:  6.757"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.2"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? No
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: nPar
.head 3 -  String: sStr
.head 3 -  String: sFN
.head 3 -  Receive Number: nRP
.head 2 +  Window Variables
.head 3 -  Number: nInterval
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Set nInterval = 20
.head 4 -  Set df1 = 'Файл ' || sFN || ' обработан с ошибками :'
.head 4 -  ! Call SalSetFocus(pbExit)
.head 4 -  Call SalSetFocus(df1)
.head 3 +  On SAM_CreateComplete
.head 4 -  Call SalWaitCursor(TRUE)
.head 4 -  Set mlMess = sStr || 'Подробную информацию см. в log-файле -' || PutCrLf() || GetLogDir()
    || '\\' || Left(GetUserLoginName(), 8) || '.LOG'
.head 4 +  ! If nPar = 1
.head 5 -  Call SalSetWindowText(pbExit, 'Отложить')
.head 5 -  Call SalSetWindowText(pbDouble2, 'Создать квитанцию и удалить (в BAD)')
.head 5 -  ! Set mlMess = mlMess || ' Обработать файл повторно ?'
.head 4 +  ! Else
.head 5 -  ! Call SalHideWindow(pbDouble2)
.head 5 -  ! Call SalSetWindowText(pbExit, 'Утвердить')
.head 5 -  Call SalSetWindowText(pbExit, 'Отложить')
.head 5 -  Call SalSetWindowText(pbDouble2, 'Создать квитанцию и удалить (в BAD)')
.head 4 -  Call SalWaitCursor(FALSE)
