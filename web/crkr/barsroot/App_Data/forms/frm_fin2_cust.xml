<?xml version="1.0" encoding="utf-8"?>
<xmlform caption="Розрахунок фінансового стану юридичних осіб"  captiontype="OnlyTitle" version="1.0.0">
  <grids>
    <grid id="id1" title="Розрахунок фінансового стану юридичних осіб(Постанова НБУ №23)" showpagesizebox="true" pagesize="15" >
            
          <!--Фільтри-->
      <filters buttontext="Пошук" columnscount="4" caption="Пошук клієнтів">
        <filter id="fId1" caption="РНК"           field="RNK"  condition="Equal"    columnindex="1"></filter>
        <filter id="fId2" caption="OKPO"          field="OKPO" condition="Equal"    columnindex="2"></filter>
        <filter id="fId3" caption="Назва клієнта" field="NMK"  condition="LikeBoth" columnindex="3"></filter>
        <filter id="fId4" caption="Наявність договорів" field="KOL"   condition="Equal"  columnindex="4">
          <uicontrol type="DropDownList" table="(select '0' as val, 'Без договорів' as name from dual union all select '1' as val , 'З договорами' as name  from dual)"
                          keyfield="val" valuefield="name"  addemptyitem="true">
            <!--<defaultvalue type="Constant" value="1"/>-->
          </uicontrol>
        </filter>
      </filters>
      
      <datasource>
        <!-- Запрос на відображення клієнтів по доступу до рахунків-->
        <sql>
          SELECT  2 as n, c.rnk, c.rnkp as isp,
          c.okpo, c.nmk, p.RUK, s.NAME, datea,
          f0.FDAT as f0,f1.FDAT as f1,f2.FDAT as f2,f3.FDAT as f3,f4.FDAT as f4, (select sign(count(1)) from cc_deal where rnk = c.rnk and  15 > sos and 4 >vidd ) kol
          FROM fin_customer c, corps p,  stan_fin S,
          (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=0 group by OKPO) F0,
          (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=1 group by OKPO) F1,
          (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=2 group by OKPO) F2,
          (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=3 group by OKPO) F3,
          (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=4 group by OKPO) F4
          WHERE c.OKPO = f0.OKPO(+) and c.OKPO = f1.OKPO(+) and
          c.OKPO = f2.OKPO(+) and c.OKPO = f3.OKPO(+) and
          c.OKPO = f4.OKPO(+) and c.RNK = p.RNK (+) and
          c.DATE_OFF is null and
          nvl(c.k050 , '0') != '425' and
          NVL(c.crisk,0) = s.FIN (+) and
          (c.custtype =2)
          --and exists (select 1 from cc_deal where rnk = customer.rnk and  15 > sos)
          --and exists (select 1 from v_gl where dazs is null and rnk = customer.rnk and substr(nbs,1,1) in ('2', '3') )
          ORDER BY 1,2,3
        </sql>
      </datasource>

      <rowselection method ="SingleRow"/>

      <buttons>
        <button id="Bt1" type="Image" imagename="id_cards" hint="Карточка фінстану"  >
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_fin2_kart_kl" >
            <parameters>
              <parameter name="RNK" altname="rnk" datatype="Int64" type="DataField"></parameter>
            </parameters>  
          </command>
        </button>
        <button  id="instest" type="Image" hint="Створити тестового позичальника" imagename="document_add">
          <command type="PlSqlBlock" successurl="/barsroot/barsweb/dynform.aspx?form=frm_fin2_cust" checkselectedrow="false">
            <sql>
              declare
              aOKPO varchar2(8)   :=  :OKPO_;
              aNMK   varchar2(38) :=  :NMK_;
              aVED    varchar2(5)  := :VED_;
              k_ varchar2(30);
              begin

              begin
              select ved
              into k_
              from ved
              where ved= aVED and (d_close is null or d_close > sysdate);
              exception when NO_DATA_FOUND THEN
              raise_application_error(-(20000),'\ ' ||'     Не вірно вказано вид економічної діяльності',TRUE);
              end;

              if nvl(length(replace(TRANSLATE(aOKPO,'1234567890','0'),'0','')),0) > 0 then
              raise_application_error(-(20000),'\ ' ||'    Не вірно введений код ОКПО - "'||aOKPO ||'"',TRUE);
              end if;

              begin
              insert into fin_cust (okpo, nmk, ved, datea)
              values (aOKPO, aNMK, aVED, :DATEA_ );
              exception when others then
              if (sqlcode = -00001) then
              raise_application_error(-(20000),'\ ' ||'    Тестовий позичальник з кодом ОКПО '||aOKPO ||' вже створений',TRUE);
              end if;
              end;
              end;
            </sql>
            <customfields oktext="Ok" canceltext="Cancel" columnscount="1">
              <customfield datatype="String" name="OKPO_" required="true" size="8"  label="ОКПО"></customfield>
              <customfield datatype="String" name="NMK_"  required="true" size="38" label="Назва клієнта"></customfield>
              <customfield datatype="DateTime" name="DATEA_"  required="true" size="38" label="Дата реестрації підприемства"></customfield>
              <customfield datatype="String" name="VED_" required="true"  size="5"  label="КВЕД">
                <uicontrol type="DropDownList" table="(select ved, ved||' - '||name as name from ved where d_close is null or  d_close > sysdate order by ved asc)" keyfield="ved" valuefield="name"></uicontrol>
              </customfield>
            </customfields>
          </command>
        </button>
        <button id="BtDel" type="Image" imagename="delete2" hint="Видалити тестового позичальника" confirmmessage="Видалити тестового позичальника" >
          <command type="PlSqlBlock">
            <sql>
              begin
              delete fin_cust where okpo = :OKPO;
              end;
            </sql>
            <parameters>
              <parameter type="DataField" name="OKPO" ></parameter>
            </parameters>
          </command>
        </button>
        
      </buttons>
   
      
      
     <!--Опис колонок-->
      
      <fields>
        <field name="RNK" datatype="Int64" key="true" >
          <column caption="РНК"  show="true" >
                     </column>
          <layout >
            <colors scope="EntireRow">
              <color color="clPlum" operation="Less" value="0" columnindex="2" bold="true"/>
            </colors>
          </layout>
          
        </field>

        <field name="OKPO" datatype="String" key="true" >
          <column caption="ОКПО"  show="true" />
        </field>
        
        <field name="NMK" datatype="String" key="false" >
          <column caption="Назва клієнта"  show="true" />
        </field>

        <field name="RUK" datatype="String" key="false" >
          <column caption="Керівник"  show="true" />
        </field>

        <field name="name" datatype="String" key="false" size="55" >
          <column caption="Клас"  show="true" width="55" />
        </field>

        <!--<field name="NAME" datatype="String" key="false" >
          <column caption="Фін.стан з БД"  show="true" />
        </field>-->

        <field name="DATEA" datatype="DateTime" key="false" >
          <column caption="Дата реестрації підприемства"  show="true"  width="35"/>
        </field>

        <field name="F0" datatype="DateTime" key="false" >
          <column caption="Форма №0"  show="false" />
        </field>

        <field name="F1" datatype="DateTime" key="false" >
          <column caption="Форма №1"  show="true" />
        </field>

        <field name="F2" datatype="DateTime" key="false" >
          <column caption="Форма №2"  show="true" />
        </field>

        <field name="F3" datatype="DateTime" key="false" >
          <column caption="Форма №3"  show="false" />
        </field>

        <field name="F4" datatype="DateTime" key="false" >
          <column caption="Форма №4"  show="false" />
        </field>

        <field name="KOL" datatype="String" key="false" >
          <column caption="KOL"  show="false" />
        </field>

      </fields>
      
      
    </grid>
    
  </grids>
</xmlform>
