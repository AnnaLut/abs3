@using Kendo.Mvc.UI
@{
    string title = "Портфель даних реєстру";
}
<script src="~/Areas/Escr/Scripts/portfolio.js"></script>
<link href="~/Areas/Escr/Css/portfolio.css" rel="stylesheet" />
<h1>@title</h1>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Ссылки</title>
    <style type="text/css">
        A.link1 {
            font-size: 15px;
            font-weight: bold;
            color: blue;
        }
    </style>
</head>
<body>
    <p>
        <a href="/barsroot/Areas/Escr/Docs/ESCR_USR_DOCS.docx" class="link1">Завантажити інструкцію користувача</a>
    </p>
</body>
</html>


<table id="filter" class="reg-filter">
    <tr>
        <td>
            <label for="dtFrom" class="control-label">Дата з:</label>
        </td>
        <td>
            <input type="text" id="dtFrom" style="width:200px" required />
        </td>
        <td>
            <label for="dtTo" class="control-label">Дата по:</label>
        </td>
        <td>
            <input type="text" id="dtTo" style="width:200px" />
        </td>
        <td style="text-align:center">
            <button id='btnClear' class='k-button' title='Очистити всі фільтри' style="width:120px">
                <span class='pf-icon pf-16 pf-reload_rotate'></span> Очистити
            </button>
        </td>
    </tr>
    <tr>
        <td>
            <label for="ddlType" class="control-label">Тип реєстру:</label>
        </td>
        <td>
            <select id="ddlType" style="width:250px"></select>
        </td>
        <td>
            <label for="ddlView" class="control-label">Вид реєстру:</label>
        </td>
        <td>
            <select id="ddlView" style="width:250px"></select>
        </td>
        <td style="text-align:center">
            <button id='btCreate' class='k-button' style="width:120px">
                <span class='pf-icon pf-16 pf-add_button'></span> Вибрати
            </button>
        </td>
    </tr>
</table>
<div id="separator"><br /></div>
<div id="tabstrip">
    <ul>
        <li>Реєстри</li>
        <li>Список кредитів</li>
    </ul>
    <div>
        <div id="gridRegister"></div>
    </div>
    <div>
        <div id="gridEnergo"></div>
        <script id="events-template" type="text/x-kendo-template">
            <div style="width:50%">
                <div id="gridEvents"></div>
            </div>
        </script>
    </div>
</div>
<div id="dialogPeriod">
    <div class="form-group">
        <label for="message" class="control-label">Період яким згрупувати реєстр:</label>
        <table id="period" class="reg-filter">
            <tr>
                <td>
                    <label for="dtFromMsg" class="control-label">Дата з:</label>
                </td>
                <td>
                    <input type="text" id="dtFromMsg" style="width:200px" required />
                </td>
            </tr>
            <tr>
                <td>
                    <label for="dtToMsg" class="control-label">Дата по:</label>
                </td>
                <td>
                    <input type="text" id="dtToMsg" style="width:200px" />
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:right">
                    <button id='btnOk' class='k-button'>
                        <span class='pf-icon pf-16 pf-ok'></span> Зберегти
                    </button>
                    <button id='btnCancel' class='k-button'>
                        <span class='pf-icon pf-16 pf-delete_button_error'></span> Відміна
                    </button>
                </td>
            </tr>
        </table>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var tabstrip = $("#tabstrip").kendoTabStrip({
            animation: false 
        });
        tabstrip.data("kendoTabStrip").select(0);
        tabstrip.data("kendoTabStrip").tabGroup.children().eq(1).bind("click", onClickTab);
        var gridReg = $("#gridRegister").kendoGrid({
            dataSource: {
                transport: {
                    read: {
                        cache: false,
                        url: bars.config.urlContent('/escr/portfoliodata/GetRegister/'),
                    }
                },
                schema: {
                    id: "ID",
                    model: {
                        fields: {
                            ID: { type: "number" },
                            INNER_NUMBER: { type: "string" },
                            OUTER_NUMBER: { type: "string" },
                            CREATE_DATE: { type: "date" },
                            DATE_FROM: { type: "date" },
                            DATE_TO: { type: "date" },
                            REG_TYPE_ID: { type: "number" },
                            REG_TYPE_CODE: { type: "string" },
                            REG_TYPE_NAME: { type: "string" },
                            REG_KIND_ID: { type: "number" },
                            REG_KIND_CODE: { type: "string" },
                            REG_KIND_NAME: { type: "string" },
                            BRANCH: { type: "strring" },
                            REG_LEVEL: { type: "number" },
                            REG_LEVEL_CODE: { type: "string" },
                            USER_ID: { type: "number" },
                            USER_NAME: { type: "string" },
                            REG_STATUS_ID: { type: "number" },
                            REG_STATUS_CODE: { type: "string" },
                            REG_STATUS_NAME: { type: "string" },
                            REG_UNION_FLAG: { type: "boolean" },
                            CREDIT_COUNT: { type: "number" },
                            ERR_COUNT: { type: "number" },
                            VALID_STATUS: { type: "number" }
                        }
                    }
                },
                pageSize: 10
            },
            dataBound: function (e) {
                gridDataBound(e)
            },
            dataBinding: function (e) {
                uids = [];
                $("#gridRegister .k-state-selected").each(function (e) {
                    uids.push($(this).data("row-id"));
                });
            },
            toolbar: [{
                name: "btSend",
                type: "button",
                text: "<span class='pf-icon pf-16 pf-bank'></span> Відправити на ЦА"
            },
            {
                template: " | "
            },
            {
                name: "btAddGroup",
                type: "button",
                text: "<span class='pf-icon pf-16 pf-folder-favorite'></span> Згрупувати реєстри"
            },
            {
                name: "btDelGroup",
                type: "button",
                text: "<span class='pf-icon pf-16 pf-folder_open-favorite'></span> Розгрупувати реєстр"
            },
            {
                template: " | "
            },
            {
                name: "btBack",
                type: "button",
                text: "<span class='pf-icon pf-16 pf-arrow_left'></span> Перейти до формування реєстру"
            }],
            pageable: {
                refresh: true,
                pageSizes: [10, 20, 50, 100]
            },
            height: getSizeGrid,
            resizable: true,
            selectable: true,
            filterable: true,
            change: onChange,
            columns: [{
                title: "<div style='width:100%'><input name=checkAllRow class=checkRow id=selectAll type=checkbox title='Обрати все..' /></div>",
                template: "<input type=checkbox class=checkbox name=checkRow />",
                width: 30
            },
            {
                title: "Номер",
                field: "ID",
                width: 100
            },
            {
                title: "Внутрішня класифікація",
                field: "INNER_NUMBER",
                width: 200
            },
            {
                title: "Зовнішній номер",
                field: "OUTER_NUMBER",
                width: 200
            },
            {
                title: "Дата створення",
                field: "CREATE_DATE",
                format: "{0:dd.MM.yyyy HH:mm:ss}",
                width: 150
            },
            {
                title: "Початок періоду",
                field: "DATE_FROM",
                format: "{0:d}",
                width: 100
            },
            {
                title: "Кінець періоду",
                field: "DATE_TO",
                format: "{0:d}",
                width: 100
            },
            {
                title: "Тип реєстру",
                field: "REG_TYPE_NAME",
                width: 150
            },
            {
                title: "Вид реєстру",
                field: "REG_KIND_NAME",
                width: 150
            },
            {
                title: "Відділення",
                field: "BRANCH",
                width: 150
            },
            {
                title: "Відповідальний користувач",
                field: "USER_NAME",
                width: 150
            },
            {
                title: "Статус реєстру",
                field: "REG_STATUS_NAME",
                width: 100
            },
            {
                title: "Згрупований",
                field: "REG_UNION_FLAG",
                template: "#= REG_UNION_FLAG ? 'Так' : 'Ні' #",
                width: 100
            },
            {
                title: "Кіл. кредитів",
                field: "CREDIT_COUNT",
                width: 100
            },
            {
                title: "Кіл. помилкових кредитів",
                field: "ERR_COUNT",
                width: 100
            }]
        }).data("kendoGrid");

        $("#gridRegister").find('#selectAll').on('change', function () {
            var grid = $("#gridRegister");
            var checkedRows = grid.find('input[type="checkbox"][name="checkRow"]');
            var $this = $(this);
            if ($this.is(':checked')) {
                checkedRows.prop("checked", true);
                $(".k-grid-btAddGroup").removeAttr("disabled");
                $(".k-grid-btDelGroup").removeAttr("disabled");
                $(".k-grid-btSend").removeAttr("disabled");
            } else {
                checkedRows.prop("checked", false);
                $(".k-grid-btAddGroup").attr("disabled", "disabled");
                $(".k-grid-btDelGroup").attr("disabled", "disabled");
                $(".k-grid-btSend").attr("disabled", "disabled");
            }
            for (var i = 0; i < checkedRows.length; i++) {
                changeCheckRowPrtfl(checkedRows[i]);
            }
        });

        var gridEnergo = $("#gridEnergo").kendoGrid({
            dataBound: function (e) {
                var grid = e.sender;
                var data = grid.dataSource.data();
                if (data.length === 0) {
                    var colCount = grid.columns.length;
                    var message = 'немає записів або не сформовано реєстр';
                    $(e.sender.wrapper).find('tbody').append('<tr class="kendo-data-row"><td colspan="' + colCount + '" class="no-data">' + message + ' :(</td></tr>');
                }
                $(".k-grid-btDelDeal").attr("disabled", "");
            },
            detailTemplate: kendo.template($("#events-template").html()),
            detailInit: detailInit,
            resizable: true,
            filterable: true,
            selectable: true,
            height: getSizeGrid,
            change: onChangeEnergo,
            pageable: {
                refresh: true,
                pageSizes: [10, 20, 50, 100],
                buttonCount: 10
            },
            toolbar: [{
                name: "btDelDeal",
                type: "button",
                text: "<span class='pf-icon pf-16 pf-delete'></span> Видалити з реєстру"
            }],
            columns: [{
                title: "№ п/п",
                width: 50,
                field: "NUM"
            },
            {
                title: "ПІБ",
                field: "CUSTOMER_NAME",
                width: 200
            },
            {
                title: "ІНН",
                field: "CUSTOMER_OKPO",
                width: 100
            },
            {
                title: "РНК",
                field: "CUSTOMER_ID",
                width: 100
            },
            {
                title: "Місце проживання позичальника",
                columns: [{
                    title: "область",
                    field: "CUSTOMER_REGION",
                    width: 200
                },
                {
                    title: "район, нас. п., вул., буд.(кв.)",
                    field: "CUSTOMER_FULL_ADDRESS",
                    width: 250
                }]
            },
            {
                title: "Док. про субсидію",
                field: "SUBS_DOC_TYPE",
                width: 200
            },
            {
                title: "Кредитний договір",
                columns: [{
                    title: "дата",
                    field: "DEAL_DATE_FROM",
                    format: "{0:d}",
                    width: 100
                },
                {
                    title: "номер",
                    field: "DEAL_NUMBER",
                    width: 100
                },
                {
                     title: "референс",
                     field: "DEAL_ID",
                     width: 100
                 },
                {
                    title: "строк дії",
                    field: "DEAL_TERM",
                    width: 90
                }]
            },
             {
                 title: "Cуми по КД",
                 columns: [{
                     title: "Вартість товару",
                     field: "GOOD_COST",
                     format: "{0:#.00}",
                     width: 100
                 },
             {
                 title: "Вартість товару погоджена ДЕЕ",
                 field: "NEW_GOOD_COST",
                 format: "{0:#.00}",
                 width: 100
             },
             {
                 title: "Сума кредиту",
                 field: "DEAL_SUM",
                 format: "{0:#.00}",
                 width: 100
             },
             {
                 title: "Скоригована, сума кредиту",
                 field: "NEW_DEAL_SUM",
                 format: "{0:#.00}",
                 width: 100
             },
             {
                 title: "Сума відшкодування",
                 field: "COMP_SUM",
                 format: "{0:#.00}",
                 width: 100 
             },
              {
                  title: "Фактична сума відшкодування",
                  field: "NEW_COMP_SUM",
                  format: "{0:#.00}",
                  width: 100
              }]
             },
             {
                title: "Дата док.ціл.викор.",
                field: "DOC_DATE",
                format: "{0:d}",
                width: 100
            },

            {
                title: "МФО",
                field: "MFO",
                width: 60
            },
            {
                title: "Відділення",
                field: "BRANCH_CODE",
                width: 170
            },
            {
                title: "Поточний рахунок",
                field: "NLS",
                width: 150
            },
            {
                 title: "Вид реєстру",
                 width: 250,
                 field: "REG_KIND_NAME"
             },
            {
               title: "Тип реєстру",
               width: 100,
               field: "REG_TYPE_NAME"
             },
            {
                title: "Відповідальний співробітник",
                field: "USER_NAME",
                width: 200
            },
            {
                title: "Статус запису КД",
                field: "CREDIT_STATUS_NAME",
                width: 150
            },
            {
                title: "Коментар",
                field: "CREDIT_COMMENT",
                width: 200
            }]
        });

        $(".k-grid-btBack").click(function () {
            window.location = bars.config.urlContent('/escr/PortfolioData/?level=RU');
        });

        $(".k-grid-btSend").click(function () {
            bars.ui.confirm({
                text: "Ви пітверджуєте коректність даних та відправку даних до ЦА?",
                func: function () {
                    sendRegister();
                }
            });
        });
        $(".k-grid-btAddGroup").click(function () {
            $("#dialogPeriod").data("kendoWindow").open();
            //groupByRegister
        });
        $("#btnOk").click(function () {
            $("#dialogPeriod").data("kendoWindow").close();
            groupByRegister();
        });
        $("#btnCancel").click(function () {
            $("#dialogPeriod").data("kendoWindow").close();
        });
        $(".k-grid-btDelGroup").click(delGroupRegister);
        $("#gridEnergo .k-grid-btDelDeal").click(delDealRegister);

        $("#btCreate").click(create);
        $("#btnClear").click(function () {
            $("#dtFrom").data("kendoDatePicker").value("");
            $("#dtTo").data("kendoDatePicker").value("");
            $("#ddlType").data("kendoDropDownList").value("");
            $("#ddlView").data("kendoDropDownList").value("");
            create();
        });

        var dialogPeriod = $("#dialogPeriod").kendoWindow({
            title: "Період",
            modal: true,
            draggable: false,
            animation: {
                open: false
            },
            visible: false,
            width: "300px",
            //close: clickBtnOk,
            activate: function () {
                var value = new Date();
                var dateFrom = $("#dtFromMsg").data("kendoDatePicker");
                var dateTo = $("#dtToMsg").data("kendoDatePicker");
                if (value) {
                    var firstDay = new Date(value.getFullYear(), value.getMonth(), 1);
                    var lastDay = new Date(value.getFullYear(), value.getMonth() + 1, 0);
                    dateFrom.value(firstDay);
                    dateTo.value(lastDay);
                }
                else {
                    dateFrom.value("");
                    dateTo.value("");
                }
            }
        }).data("kendoWindow");
        dialogPeriod.center();

        $("#dtFromMsg").kendoMaskedTextBox({
            mask: "99.99.9999"
        }).kendoDatePicker({
            culture: "uk-UA",
            format: "dd.MM.yyyy",
            change: function () {
                var value = this.value();
                var dateTo = $("#dtToMsg").data("kendoDatePicker");
                if (value) {
                    var firstDay = new Date(value.getFullYear(), value.getMonth(), 1);
                    var lastDay = new Date(value.getFullYear(), value.getMonth() + 1, 0);
                    this.value(firstDay);
                    dateTo.value(lastDay);
                }
                else {
                    this.value("");
                    dateTo.value("");
                }
            }
        }).removeClass('k-textbox').parent().parent().removeClass('k-textbox');

        $("#dtToMsg").kendoMaskedTextBox({
            mask: "99.99.9999"
        }).kendoDatePicker({
            culture: "uk-UA",
            format: "dd.MM.yyyy",
            change: function () {
                var value = this.value();
                var dateFrom = $("#dtFromMsg").data("kendoDatePicker");
                if (value) {
                    var firstDay = new Date(value.getFullYear(), value.getMonth(), 1);
                    var lastDay = new Date(value.getFullYear(), value.getMonth() + 1, 0);
                    this.value(lastDay);
                    dateFrom.value(firstDay);
                }
                else {
                    this.value("");
                    dateTo.value("");
                }
            }
        }).removeClass('k-textbox').parent().parent().removeClass('k-textbox');

        $("#dtFrom").kendoMaskedTextBox({
            mask: "99.99.9999"
        }).kendoDatePicker({
            culture: "uk-UA",
            format: "dd.MM.yyyy",
            change: function () {
                var value = this.value();
                var dateTo = $("#dtTo").data("kendoDatePicker");
                if (value) {
                    var firstDay = new Date(value.getFullYear(), value.getMonth(), 1);
                    var lastDay = new Date(value.getFullYear(), value.getMonth() + 1, 0);
                    this.value(firstDay);
                    dateTo.value(lastDay);
                }
                else {
                    this.value("");
                    dateTo.value("");
                }
            }
        }).removeClass('k-textbox').parent().parent().removeClass('k-textbox');

        $("#dtTo").kendoMaskedTextBox({
            mask: "99.99.9999"
        }).kendoDatePicker({
            culture: "uk-UA",
            format: "dd.MM.yyyy"
        }).removeClass('k-textbox').parent().parent().removeClass('k-textbox');

        $("#ddlType").kendoDropDownList({
            dataTextField: "NAME",
            dataValueField: "CODE",
            dataSource: {
                transport: {
                    read: {
                        url: bars.config.urlContent('/escr/portfoliodata/GetProd/')
                    }
                },
                schema: {
                    model: {
                        fields: {
                            ID: { type: "number" },
                            CODE: { type: "string" },
                            NAME: { type: "string" }
                        }
                    }
                }
            },
            optionLabel: "Всі",
        });
        $("#ddlView").kendoDropDownList({
            dataTextField: "NAME",
            dataValueField: "CODE",
            dataSource: {
                transport: {
                    read: {
                        url: bars.config.urlContent('/escr/portfoliodata/GetViddRee/')
                    }
                },
                schema: {
                    model: {
                        fields: {
                            ID: { type: "number" },
                            CODE: { type: "string" },
                            NAME: { type: "string" }
                        }
                    }
                }
            },
            optionLabel: "Всі"
        });
    });
    $(window).scroll(scroll);
    $(window).resize(function () {
        resizeGrid();
    });
</script>







