<?xml version="1.0" encoding="utf-8"?>
<xmlform caption="Розрахунок фінансового стану клієнта"  captiontype="OnlyTitle" version="1.0.0" minwidth="1000" maxwidth="1000">
  <grids>
    <grid id="id1" title="Розрахунок фінансового стану клієнта(Постанова НБУ №351)" width="100"  >
            
      
      
      <datasource>
        <sql>
          select custtype, -(rel_intext+1)||lpad(lpad(okpo,10,'0'),11,'9') rnkk, rnk, okpo okpo1, (rel_intext+1)||lpad(lpad(okpo,10,'0'),11,'9') okpo, nmk, ruk, name, ved, ved1 from (
          select 6 custtype, c.rnk, c.rnk okpo, c.nmk, null ruk, null name, null ved, ved ved1, rel_intext
          from customer c, customer_rel r
          where c.rnk = R.REL_RNK
          and R.REL_INTEXT=1 and R.REL_ID in (51)
          union all
          select 6, c.id rnk, c.id okpo, c.name nmk, null ruk, null name, null ved, ved ved1, rel_intext
          from CUSTOMER_EXTERN c, customer_rel r
          where c.id = R.REL_RNK
          and R.REL_INTEXT=0 and R.REL_ID in (51)
          ) where rnk = :RNK
          ORDER BY 1,2,3
        </sql>
        <parameters>
          <parameter name="RNK" datatype="Int64" type="QueryString" altname="rnk"></parameter>
        </parameters>
        </datasource>
      <rowselection method="SingleRowServer"/>

      <!-- botons-->
      <buttons>
      <!-- КНОПКА Добавити новий звітний період-->
        <button id="Bt1" type="Image" imagename="document_add"  hint="Добавити новий звітний період">
          <command type="PlSqlBlock" successurl="/barsroot/barsweb/dynform.aspx?form=frm_fin2_kart_kontr">
            <sql>
              declare
              p_     number             := 0;
              okpo_  varchar2(12)       := :OKPO;
              dat_   date               := to_date( :DAT, 'dd/mm/yyyy');
              fm_    varchar2(1)        := :FM;
              rnk_   number             := :RNK;

              begin

              fm_ := (case when fm_ =  'P' then  ' '
              when fm_ =  'M' then  'M'
              else  'C'
              end);

              begin
              select 1
              into p_
              from fin_fm
              where okpo = okpo_
              and fdat = dat_;
              exception when no_data_found then
              p_ :=0;
              end;

              if  p_ = 0          then

              fm_ := (case when fm_='M' then (case when dat_ >= to_date('01.01.2014','dd.mm.yyyy') then 'R' else 'M' end)
              when fm_='C' then 'C'
              else (case when dat_ >= to_date('01.01.2013','dd.mm.yyyy') then 'N' else ' ' end)
              end );

              insert into fin_fm   (okpo,    fdat,     fm )
              values               (okpo_,   dat_,     fm_);

              BEGIN

              for k in (
              select * from fin_fm where okpo = okpo_ and fdat = dat_
              )
              loop


              insert into fin_rnk (fdat, idf, kod, s, okpo, branch)
              select * from
              (select k.fdat fdat, '1' idf, kod, 0 s, k.OKPO okpo, SYS_CONTEXT ('bars_context', 'user_branch') branch from fin_forma1 where kod is not null  and fm = k.fm
              union all
              select k.fdat fdat, '1' idf, kod, 0 s, k.OKPO okpo, SYS_CONTEXT ('bars_context', 'user_branch') branch from fin_forma1m where kod is not null  and fm = case when k.fm ='C'then 'R' else  k.fm end
              union all
              select k.fdat fdat, '2' idf, kod, 0 s, k.OKPO okpo, SYS_CONTEXT ('bars_context', 'user_branch') branch from fin_forma2 where kod is not null   and fm = k.fm
              union all
              select k.fdat fdat, '2' idf, kod, 0 s, k.OKPO okpo, SYS_CONTEXT ('bars_context', 'user_branch') branch from fin_forma2m where kod is not null  and fm = case when k.fm ='C'then 'R' else  k.fm end);

              end loop;
              END;
              /*    Fin_rnk_check(dat_, 1, okpo_);
              Fin_rnk_check(dat_, 2, okpo_);*/
              else null;
              end if;
              end;
            </sql>
            <customfields oktext="Ok" canceltext="Cancel" title="Добавити новий період" >
            
              <customfield name="DAT"  altname="DAT"  datatype="String"  required="true" label="Звітний період" >
                <uicontrol type="DropDownList" table="(select distinct  to_char(trunc(add_months(gl.bd, -(num-1) ), 'YYYY'), 'dd/mm/yyyy') as per, trunc(add_months(gl.bd, -(num-1) ), 'YYYY')sr from conductor where 37>num order by sr desc )" keyfield="per" valuefield="per"  addemptyitem="true"  ></uicontrol> 
              </customfield>
              
              
              <customfield name="FM"  altname="FM" datatype="String" required="true" label="Форма звітності">
                <uicontrol type="DropDownList" table="(          Select 'P' fm, 'Ф1,Ф2– великого або середнього підприємства  ' name from dual 
                                                       union all Select 'M' fm, '1М,2М– малого підприємства  '                  name from dual
                                                       union all Select 'C' fm, '1МС,2МС– малого підприємства  '                name from dual)" keyfield="FM" valuefield="name" addemptyitem="true" ></uicontrol>
              </customfield>
              
            </customfields>
            <parameters>
              <parameter name="OKPO" altname="OKPO" datatype="Int64" type="DataField"></parameter>
              <parameter name="RNK" altname="rnk" datatype="Int64" type="DataField" add2successurl="true"></parameter>
            </parameters>   
          </command>
        </button>

        <button id="Bt1Del" caption="Видалити період" type="Image" imagename="delete2">
          <command type="PlSqlBlock"  successurl="/barsroot/barsweb/dynform.aspx?form=frm_fin2_kart_kontr">
            <sql>
              DECLARE
               okpo_  varchar2(12)       := :OKPO;
               dat_   date               := to_date( :DAT1, 'dd/mm/yyyy');
               rnk_   number             := :RNK;
              begin
              for k in (
                   select * from fin_fm where okpo = okpo_ and fdat = dat_
                        )
               loop
                 delete fin_rnk where okpo = k.okpo and fdat = k.fdat;
                 delete fin_fm  where okpo = k.okpo and fdat = k.fdat;
               end loop;
              end;
            </sql>
          
            <customfields oktext="Ok" canceltext="Cancel" title="Видалити період?">
              <customfield name="DAT1"  altname="DAT1"  datatype="String"  required="true" label="Звітний період" >
                <uicontrol type="DropDownList" table="(select distinct  to_char(trunc(add_months(gl.bd, -(num-1) ), 'Q'), 'dd/mm/yyyy') as per, trunc(add_months(gl.bd, -(num-1) ), 'Q')sr from conductor where 37>num order by sr desc )" keyfield="per" valuefield="per"  addemptyitem="true"  ></uicontrol> 
              </customfield>
            </customfields>

            <parameters>
               <parameter name="OKPO" altname="OKPO" datatype="Int64" type="DataField"></parameter>
               <parameter name="RNK" altname="rnk" datatype="Int64" type="DataField" add2successurl="true"></parameter>
            </parameters>  

          </command>
          
        </button>
        
      </buttons>
      
      
      
      
     <!--Опис колонок-->
      
      <fields>
        <field name="RNK" datatype="Int64" key="true" >
          <column caption="РНК"  show="true" width="90" />
        </field>

        <field name="RNKK" datatype="Int64" key="true" >
          <column caption="РНК"  show="false" width="90" />
        </field>
        
        <field name="OKPO" datatype="String" key="true" >
          <column caption="ОКПО"  show="false" width="100" />
        </field>

        <field name="OKPO1" datatype="String" key="true" >
          <column caption="ОКПО"  show="true" width="100" />
        </field>
        
        <field name="NMK" datatype="String" key="false" >
          <column caption="Назва клієнта"  show="true"  width="450"/>
        </field>

        <field name="RUK" datatype="String" key="false" >
          <column caption="Керівник"  show="true" width="180" />
        </field>

        <field name="NAME" datatype="String" key="false" >
          <column caption="Фін.стан з БД"  show="true" width="180" />
        </field>

        <field name="VED" datatype="String" key="true" >
          <column caption="Група ВЕД"  show="false" width="180" />
        </field>

        <field name="VED1" datatype="String" key="true" >
          <column caption="ВЕД"  show="false" width="180" />
        </field>




      </fields>
      
      
    </grid>

    <grid id="Id2" title="Введені форми кліента за звітні періоди" showpagesizebox="true" pagesize="6" width="100">
            <datasource>
        <sql>
          select -okpo rnkk, okpo, fdat, fm, decode(fin_nbu.LOGK_read(fdat, okpo, 1,1), 0, 'Без помилок', 2, 'З помилками', 1, 'Не введені дані') f1 ,
          decode(fin_nbu.LOGK_read(fdat, okpo, 2,1), 0, 'Без помилок', 2, 'З помилками', 1, 'Не введені дані') f2,
          (fin_nbu.LOGK_read(fdat, okpo, 1,1)+fin_nbu.LOGK_read(fdat, okpo, 2,1)) as col, null as ved, fin_nbu.ZN_P('IPB', 6, fdat, okpo) as IPB,
          fin_zp.f_get_fin_nd (:RNK ,  0 ,  '110' , fdat,  sysdate ) kl_110,
          fin_zp.f_get_fin_nd (:RNK ,  0 ,  '080' , fdat,  sysdate ) kl_080,
          fin_zp.f_get_fin_nd (:RNK ,  0 ,  'OBS' , fdat,  sysdate ) kl_OBS,
          :RNK as rnk,
          to_char(fdat,'dd/mm/yyyy') dat,
          fin_nbu.ZN_P('KPB', 9, fdat, okpo) as KPB,
          fin_nbu.GET_KVED(-OKPO, fdat,1) as kved,
          fin_nbu.GET_VED(:RNK, fdat) as ved1,
          FIN_NBU.ZN_P('GVED', 6, fdat, okpo, null) as ved351,
          FIN_NBU.ZN_P('PIPB', 6, fdat, okpo, null) PIPB351,
          FIN_NBU.ZN_P('CLAS', 6, fdat, okpo, null) cls351
          from fin_fm
          where okpo = :OKPO
          order by fdat desc

        </sql>
        <parameters>
          <parameter name="RNK" altname="rnk" datatype="Int64" masterid="Id1" masterkeyfield="RNK" type="MasterGrid"></parameter>
          <parameter name="OKPO" altname="okpo" datatype="Decimal" masterid="Id1" masterkeyfield="OKPO" type="MasterGrid"></parameter>
          <!--<parameter name="VED" altname="ved" datatype="String" masterid="Id1" masterkeyfield="VED" type="MasterGrid"></parameter>-->
        </parameters>
      </datasource>
      <rowselection method="SingleRowServer"/>
      <buttons>

        <button id="Bt200" type="Image" imagename="table"  hint="Форма №1" caption="F1" linebreak="false">
          <command type="Redirect" url="\barsroot\credit\fin_nbu\fin_form.aspx" checkselectedrow="true">
            <parameters>
              <parameter name="OKPO" altname="okpo" datatype="Int64" type="DataField"></parameter>
              <parameter name="frm"  altname="frm"  datatype="Int64" type="Constant">
                  <defaultvalue type="Constant" value="1"/>
              </parameter>
              <parameter name="DAT" altname="dat" datatype="String" type="DataField"></parameter>
              <parameter name="RNKK"  altname="rnk"  datatype="Decimal" type="DataField" ></parameter>
              <parameter name="RNK"  altname="rnkk"  datatype="Decimal" type="DataField" ></parameter>
            </parameters>
          </command>
        </button>

        <!--КНОПКА Введення даних форми №2 -->
        <button id="Bt300" type="Image" imagename="note"  hint="Форма №2" caption="F2" >
          <command type="Redirect" url="\barsroot\credit\fin_nbu\fin_form.aspx" checkselectedrow="true">
            <parameters>
              <parameter name="OKPO" altname="okpo" datatype="Int64" type="DataField"></parameter>
              <parameter name="frm"  altname="frm"  datatype="Int64" type="Constant">
                <defaultvalue type="Constant" value="2"/>
              </parameter>
             <parameter name="DAT" altname="dat" datatype="String" type="DataField"></parameter>
              <parameter name="RNKK"  altname="rnk"  datatype="Decimal" type="DataField" ></parameter>
              <parameter name="RNK"  altname="rnkk"  datatype="Decimal" type="DataField" ></parameter>
            </parameters>
          </command>
        </button>

        <!--<button id="btIPS" type="Image" imagename="document_gear" caption="Рорахувати інтгрований показник та клас боржника"  hint="Рорахувати інтгрований показник та клас боржника" confirmmessage="Провести розрахунок" >
          <command type="PlSqlBlock" checkselectedrow="true">
            <sql>
              begin
              null;
              fin_nbu.calculation_class(:RNKK,  :FDAT);
              end;
            </sql>
            <parameters>
              <parameter name="RNKK"  altname="RNKK"  datatype="Int64" type="DataField" ></parameter>
              <parameter name="FDAT" type="DataField" ></parameter>
            </parameters>
          </command>
        </button>-->
        
        <button id="Bt351_KORP" type="Image" imagename="calculator"  hint="Розрахунок класу позичальника (351)  для нового КД" caption="Розрахунок класу позичальника (351)  для нового КД" >
          <command type="Redirect" url="\barsroot\credit\fin_nbu\credit_defolt_kons.aspx" checkselectedrow="false">
            <parameters>
              <parameter name="OKPO" altname="okpo" datatype="Int64" type="DataField"></parameter>
              <parameter name="RNKK"  altname="rnk"  datatype="Decimal" type="DataField" ></parameter>
              <parameter name="ND"  altname="ND"  datatype="Int64"  type="Constant">
                <defaultvalue type="Constant" value="-2"/>
              </parameter>
              <parameter name="RNK2" altname="rnk2" datatype="Int64" type="QueryString"  ></parameter>
          </parameters>
          </command>
        </button>

 
        <button id="BtIPS20" type="Image" imagename="document_find"  hint="Переглянути розраховані показники" caption="F2"  >
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_fin2_form_p" target="Blank"  >
            <parameters>
              <parameter name="OKPO" altname="okpo" datatype="Int64" type="DataField"></parameter>
              <parameter name="DAT" altname="dat" datatype="String" type="DataField"></parameter>
            </parameters>
          </command>
        </button>
        
      </buttons>
      
      
      <fields>
        <field name="OKPO" datatype="String" key="true">
          <column caption="OKPO клієнта" show="false" width="120"></column>
        </field>

        <field name="FDAT" datatype="DateTime" key="true">
          <column caption="Звітна дата" show="true" width="120" ></column>
        </field>

        <field name="DAT" datatype="String" key="true">
          <column caption="Звітна дата" show="false" width="120" ></column>
        </field>
        
        <field name="FM" datatype="String" key="false">
          <column caption="Тип форми звітності" show="true" width="50"></column>
        </field>
        
        <field name="F1" datatype="String" key="false">
          <column caption="Форма №1 ( “Баланс”  )" show="true" width="235"></column>
        </field>

        <field name="F2" datatype="String" key="false">
          <column caption="Форма №2 (“Звіт про фінансові результати” )" show="true" width="235"></column>
        </field>

        <field name="RNK" datatype="Int64" key="true">
          <column caption="RNK" show="false" width="70"></column>
        </field>

        <field name="RNKK" datatype="Int64" key="true">
          <column caption="RNK" show="false" width="70"></column>
        </field>        
          <field name="IPB" datatype="Decimal" key="true">
          <column caption="Інтегрований показник боржника" show="false" width="70"></column>
        </field>

        <field name="kl_110" datatype="String" key="true">
          <column caption="Клас боржника" show="false" width="70"></column>
        </field>

        <field name="kl_OBS" datatype="String" size="70"  key="true">
          <column caption="Стан обслуговування боргу" show="false" width="70"></column>
        </field>

        <field name="kl_080" datatype="String" size="70"  key="true">
          <column caption="Категорія якості" show="false" width="70"></column>
        </field>

        <field name="KPB" datatype="String" size="70"  key="true">
          <column caption="Значення показника ризику кредиту" show="false" width="70"></column>
        </field>


        <field name="KVED" datatype="String" key="true">
          <column caption="KВЕД" show="true" width="70"></column>
        </field>

        <field name="PIPB351" datatype="String" size="70"  key="true">
          <column caption="Інтегрований показник боржника п.351" show="true" width="70"></column>
        </field>
        <field name="CLS351" datatype="String" size="70"  key="true">
          <column caption="Клас п.351" show="true" width="70"></column>
        </field>

        <field name="VED351" datatype="String" key="true">
          <column caption="Група ВЕД п.351" show="true" width="70"></column>
        </field>
          
        <field name="COL" datatype="Int64"  key="false">
        <column caption="COL" show="false"></column>
          <layout>
            <colors scope="EntireRow">
              <color  color="clRed" operation="GreatEqual" value="1"/>
            </colors>
          </layout>
        </field>
        
      </fields>
      
    </grid>
   
  </grids>
  
</xmlform>
