<xmlform captiontype="OnlyTitle"   version="v.2.1.2 BitCRD" caption="Розбір картотек NLY (рахунок 2909/08)">
  <grids>
  <grid id="tNlg"  pagesize="5" showpagesizebox="true"  title="Розбір картотек NLY (рахунок 2909/08)">
    <datasource>
      <sql>
        select a.acc, a.kv, a.nls, a.nms, a.ostc/100 ost_fk, a.ostb/100 ost_pl, sum(o.s) sum_kar, count(*) kount_pl, case when a.ostb/100 = sum(o.s) then '0' else '1' end color
        FROM accounts a, v_per_nly o
        where a.acc = o.acc
        group by a.acc, a.kv, a.nls, a.nms, a.ostc/100, a.ostb/100
        order by a.nls, a.kv
      </sql>
      </datasource>
    <rowselection method="SingleRowServer"/>

    <buttons>
      <!--******перегляд оборотыв по рахунку      -->
      <button caption="    Історія рахунка   " id="Bt1_a" type="Image" imagename="notebook_preferences"  hint="Показати історію оборотів по рахунку">
        <command  type="Redirect" url="/barsroot/customerlist/showhistory.aspx" target="Blank">

          <parameters>
            <parameter type="DataField" name="ACC" altname="acc"></parameter>
            <parameter datatype="Int64" type="Constant" name="TYPE" altname="type">
              <defaultvalue type="Constant" value="1" />
            </parameter>
          </parameters>
        </command>

      </button>
      <button caption="  Перегляд оброблених документів  " id="Bt_view" type="Image" imagename="document_zoom_in" hint="Перегляд оброблених документів">
        <command  type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_nlk_ref_pay" target="Self" checkselectedrow="false" >

          <parameters>
            <parameter type="DataField" name="ACC" altname="acc"></parameter>
          </parameters>
        </command>

      </button>

      <button caption="       Віднесення на доходи 1095 днів     " id="Bt_per" type="Image" imagename="moneybag_dollar" hint="Віднесення на доходи документів які не оброблені протягом 1095 днів">
        <command  type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_per_290908_web" target="Self" checkselectedrow="false" >

          <parameters>
            <parameter type="DataField" name="ACC" altname="acc"></parameter>
          </parameters>
        </command>

      </button>
      
    </buttons>
    
    <fields>

      <field name="ACC" datatype="Int64" key="true" sort="Default" size="30">
        <column show="false" caption="Код валюти" width="10" />
        <form show="false" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="KV" datatype="Int64" key="false" sort="Default" size="30">
        <column show="true" caption="Код валюти" width="10" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="NLS" datatype="Int64" key="false" sort="Default" size="70">
        <column show="true" caption="Рахунок" />
        <form show="true" rwmode="RO">
          <uicontrol type="AutoDetect" />
        </form>
      </field>

      <field name="NMS" datatype="String" key="false" sort="Default" size="70">
        <column show="true" caption="Назва рахунка"  width="350"/>
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>
      
      <field name="ost_fk" datatype="Decimal" key="false" sort="Default" size="30">
        <column show="true" caption="Фактичний залишок" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="ost_pl" datatype="Decimal" key="false"    sort="Default" size="50">
        <column show="true" caption="Плановий залишок"  />
        <form show="true" rwmode="RO"  >
          <uicontrol type="Text" align="NotSet" />
        </form>
      </field>

      <field name="kount_pl" datatype="Int64" key="false" sort="Default" size="30" >
        <column show="true" caption="Кількість докум." width="40"  align="Right" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      
      <field name="sum_kar" datatype="Decimal" key="false" sort="Default" size="30">
        <column show="true" caption="Сума картотеки"  />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="color" datatype="String" key="false" sort="Default" size="30">
        <column show="false" caption="Сума картотеки"  />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
        <layout>
          <colors scope="Column">
            <color color="clPlum" operation="Equal" value="1" columnindex="4" bold="true"/>
            <color color="clPlum" operation="Equal" value="1" columnindex="6"  />
          </colors>
        </layout>
      </field>
      
    </fields>
    </grid>

  <grid id="tNlg2"  pagesize="20"  showpagesizebox="true"  title="Розбір рахунка " >
   <datasource>
      <sql>
        select v_per_nly.*, (s*100)   s2, case when trunc(sysdate)-datd>1095 then '1' else '0' end color,  trunc(sysdate)-datd kkol
        from v_per_nly
      </sql>
      <parameters>
        <parameter name="ACC"   masterid="tNlg"  type="MasterGrid" masterkeyfield="ACC" datatype="Int64">
      </parameter>
      </parameters>
    </datasource>
    <rowselection method="SingleRow"/>
    <buttons>
      <!--******перегляд вхідного документа      -->
      <button caption="       Перегляд       " id="Bt1" type="Image" imagename="folder" hint="Відкрит карточку вхідного документа">
        <command  type="Redirect" url="/barsroot/documentview/default.aspx" target="Blank">
          
         <parameters>
            <parameter type="DataField" name="REF" altname="ref"></parameter>
          </parameters> 
        </command>
        
      </button>



      <!-- ********** Видалити з картотеки        -->
      <button caption="Видалити з картотеки" id="Bt2" type="Image" imagename="delete2"  hint="Видалит документ з картотеки"  confirmmessage="Видалити документ з картотеки?">
        <command>
          <sql>
            delete v_per_nly where ref = :ref
          </sql>
          <parameters>
            <parameter type="DataField" name="REF"></parameter>
          </parameters>
        </command>

      </button>

      <!--<button caption="Створити документ" id="Bt3" type="Image" imagename="check2"  hint="Створити документ" >
        <command  type="Redirect" url="/barsroot/docinput/docinput.aspx?tt=024">

          <parameters>
            <parameter type="DataField" name="KVA"   altname="kv_a"></parameter>
            <parameter type="DataField" name="KVA"   altname="kv_b"></parameter>
            <parameter type="DataField" name="REF"   altname="reqv_REF92"></parameter>     
            <parameter type="DataField" name="NAZNO" altname="nazn"></parameter>
            <parameter type="DataField" name="S2"    altname="sumc_t"></parameter>
            <parameter type="DataField" name="NLSA"  altname="nls_a"></parameter>
            <parameter datatype="Int64" type="Constant" name="DK" altname="dk">
              <defaultvalue type="Constant" value="1" />
            </parameter>
            <parameter type="DataField" name="BPROC" ></parameter>
            <parameter type="DataField" name="APROC" ></parameter>
          </parameters>
        </command>


      </button>-->
      
      <!-- ********** виконати перекриття  тест з вибором операції (
           треба звязка з функцією визов строки  /barsroot/docinput/docinput.aspx?\S*      -->
      
       <button caption="Створити документ(вибір операції)" id="Bt4" type="Image" imagename="checks"  hint="Створити документ(вибір операції)" >
         <command  type="Redirect" url="/barsroot/docinput/docinput.aspx">

           <customfields oktext="OK" canceltext="End"  title="Вибір кода операції">
             <customfield  datatype="String"  name="TT" altname="tt" required="true" label="Тип операції"  >
               <uicontrol   type="DropDownList" addemptyitem="true" table="(select tt, tt||' - '||name as name from tts where tt in ('310','177','101','D66','PKR') order by tt asc)"  keyfield="TT" valuefield="name">
               </uicontrol>
             </customfield>
           </customfields>
           <parameters>
             <parameter type="DataField" name="KVA"  altname="kv_a"></parameter>
             <parameter type="DataField" name="KVA"  altname="kv_b"></parameter>
             <parameter type="DataField" name="NAZNO" altname="nazn"></parameter>
             <parameter datatype="Int64" type="Constant" name="reqv_PDV" altname="reqv_PDV">
               <defaultvalue type="Constant" value="1" />
             </parameter>
             <parameter datatype="String" type="Constant" name="reqv_TAROB" altname="reqv_TAROB">
               <defaultvalue type="Constant" value=" " />
             </parameter>
             <parameter datatype="String" type="Constant" name="reqv_TARON" altname="reqv_TARON">
               <defaultvalue type="Constant" value=" " />
             </parameter>             
             <parameter type="DataField" name="S2"    altname="sumc_t"></parameter>
             <parameter type="DataField" name="NLSA" altname="nls_a"></parameter>
             <parameter datatype="Int64" type="Constant" name="DK" altname="dk"><defaultvalue type="Constant" value="1" /></parameter>
             <parameter type="DataField" name="BPROC" ></parameter>
             <parameter type="DataField" name="APROC" ></parameter>
           </parameters>
           
        </command>

         
       </button>

     </buttons>
    
    <fields>

       <field name="REF" datatype="Int64" key="true" sort="asc" sortindex="1" size="70">
         <column show="true" caption="Референс"/>
         <form show="true" rwmode="RO">
           <uicontrol type="AutoDetect"/>
         </form>
      </field>


      <field name="NLSA" datatype="Int64" key="true" sort="Default" size="70">
        <column show="true" caption="Рахунок" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" controlwidth="60"  />
        </form>
       </field>

      <field name="S" datatype="Decimal" key="false" sort="Default" size="70">
        <column show="true" caption="Сума документу">
        </column> 
        <form show="true" rwmode="RO">
          <uicontrol type="Text" controlwidth="60" />
        </form>
      </field>

      <field name="NAZNO" datatype="String" key="true" sort="Default" size="170">
        <column show="true" caption="Призначення платежу" width="600" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" controlwidth="60" />
        </form>
      </field>

      <field name="DATD" datatype="DateTime" key="false" sort="Default" size="70">
        <column show="true" caption="Дата документа" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" controlwidth="60" />
        </form>
      </field>

      <field name="ACC" datatype="Int64" key="true" sort="Default" size="70">
        <column show="false" caption="acc" />
        <form show="false" rwmode="RO">
          <uicontrol type="Text" controlwidth="60" />
        </form>
      </field>

      <field name="APROC" datatype="String" key="true" sort="Default" size="70">
        <column show="false" caption="aPROC" />
        <form show="false" rwmode="RO">
          <uicontrol type="Text" controlwidth="60" />
        </form>
      </field>

      <field name="BPROC" datatype="String" key="true" sort="Default" size="70">
        <column show="false" caption="bPROC" />
        <form show="false" rwmode="RO">
          <uicontrol type="Text" controlwidth="60"  />
        </form>
      </field>

      <field name="KVA" datatype="Int64" key="true" sort="Default" size="70">
        <column show="false" caption="KVA" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" controlwidth="60" />
        </form>
      </field>

      <field name="S2"  key="true" sort="Default" size="70">
        <column show="false" caption="Сума kop">
        </column>
      </field>

      <field name="kkol"  key="true" sort="Default" size="70">
        <column show="true" caption="Кількість днів">
        </column> 
      </field>

      <field name="color"  key="true" sort="Default" size="70">
        <column show="false" caption="колір">
        </column>
        <layout>
          <colors scope="Column">
            <color color="clRed" bold="true" operation="Equal" value="1" columnindex="4"/>
            <color color="clRed" bold="true" operation="Equal" value="1" columnindex="5"/>
         </colors>
          
        </layout>
      </field>

    </fields>
  </grid>


</grids>
</xmlform>