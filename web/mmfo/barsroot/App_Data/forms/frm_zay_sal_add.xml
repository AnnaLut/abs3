<xmlform captiontype="OnlyTitle">
  <grids>
    <grid id="gv" pagesize="10" showpagesizebox="true" title="Заяви клієнта на ПРОДАЖ валюти" showfilter="false">
      <filters caption="Фільтри" buttontext="Знайти" columnscount="3">
        <filter caption="Валюта продажу" columnindex="1" field="KV"  condition="Equal" id="fltrFL">
          <uicontrol type="DropDownList" table="(select t.kv kv, (t.lcv||' '||t.name) name from tabval t,
                             (select user_id, kv, sort_ord from tabval_sort where user_id = USER_ID()) s
                         WHERE t.kv != 980
                         AND t.kv = s.kv(+)
                        ORDER BY s.sort_ord, t.kv)" keyfield="kv" valuefield="name" addemptyitem="false">
                <defaultvalue type="Constant" value="\QS[edb_KV_new]"></defaultvalue>
          </uicontrol>
        </filter>
        <filter caption="Заявки по Клієнт-Банку" columnindex="2" field="KB" condition="Equal" id="fltrFLB">
          <uicontrol type="DropDownList" table="(select id, name from
                                                    (select decode(id, 'YES', 1, 0) id, name from fm_yesno
                                                     union
                                                     select null id, null from dual)
                                                      order by id desc)" keyfield="id" valuefield="name" addemptyitem="false">
                <defaultvalue type="Constant" value="\QS[edb_KB_new]"></defaultvalue>
          </uicontrol>
        </filter>
        <filter caption="За валюту" columnindex="3" field="DK" condition="Equal" id="fltrKvConv">
          <uicontrol type="DropDownList" table="(select id, name from
                                                    (select decode(id, 'YES', 1, 0) id, name from fm_yesno
                                                     union
                                                     select null id, null from dual)
                                                      order by id desc)" keyfield="id" valuefield="name" addemptyitem="false">
          <defaultvalue type="Constant" value="\QS[edb_DK_new]"></defaultvalue>
          </uicontrol>
        </filter>
      </filters>
      <datasource>
        <sql>
          select
          ID,
          DK,
          SOS,
          SVIZA,
          CUST_BRANCH,
          RNK,
          NMK,
          ACC0,
          ACC1,
          NLS,
          OSTC,
          S2,
          DIG,
          S2S,
          MFO0,
          NLS0,
          KV_CONV,
          LCV_CONV,
          NLS_ACC0,
          FDAT,
          ND,
          KOM,
          SKOM,
          KURS_Z,
          KURS_F,
          VDATE,
          META,
          AIM_NAME,
          CONTRACT,
          DATC,
          NUM_VMD,
          VMD1,
          BASIS,
          DATZ,
          COMM,
          CONTACT_FIO,
          CONTACT_TEL,
          COVERED,
          KB,
          KV,
          DOC_DESC,
          DATT,
          NVL(OBZ,0) OBZ,
          f092
          from v_zay_salform
          order by fdat desc, id desc
        </sql>
      </datasource>
      <rowselection method="SingleRow"/>
      <buttons defaulttype="Button">
        <button caption="Параметри клієнтів" hint="Перегляд та редагування параметрів клієнтів" id="btnCUSTZAY" type="Image" imagename="id_cards">
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_zay_cust_zay" checkselectedrow="false" target="Blank" >
          </command>
        </button>
        <button caption="Курси ділера" hint="Перегляд курсів ділера на купівлю/продаж валюти" id="btnDilKurs" type="Image" imagename="magic_wand" >
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm.ref.zay_kv_kurs" checkselectedrow="false" target="Blank"> </command>
        </button>
        <button caption="Курси ділера" hint="Перегляд курсів ділера на конверсію валюти" id="btnDilConvKurs" type="Image" imagename="magic_wand" >
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm.ref.zay_kv_conv_kurs" checkselectedrow="false" target="Blank"> </command>
        </button>
        <button caption="Рахунки клієнта" hint="Перегляд відкритих рахунків клієнта" id="btnCUSACC" type="Image" imagename="book_open">
          <command type="Redirect" url="/barsroot/customerlist/CustAcc.aspx?type=0" target="Blank">
            <parameters>
              <parameter datatype="Int64" name="RNK" altname="rnk" type ="DataField"></parameter>
            </parameters>
          </command>
        </button>
        <button caption="Друк заявки"  hint="Сформувати друковану форму заявки" id="btnrep"  type="Image" imagename="printer" >
          <command type="FastReport" frtemplate="zay_sal" checkselectedrow="true" target="blank">
            <parameters>
              <parameter type="DataField" name="ID" altname="ZAY_ID" ></parameter>
            </parameters>
          </command>
        </button>
        <button caption="Статуси заявки" hint="Переглянути історію статусів заявки" id="btnstat"  type="Image" imagename="checks" >
          <command type="Redirect" url="dynform.aspx?form=frm_zay_statuses" checkselectedrow="true" target="Blank">
            <parameters>
              <parameter type="DataField" name="ID" altname="ID"></parameter>
            </parameters>
          </command>
        </button>
        <button caption="Архів заявок" hint="Переглянути архів заявок" id="btnrep2"  type="Image" imagename="document_find" >
          <command type="Redirect" url="/barsroot/ndi/referencebook/GetRefBookData/?accessCode=1&amp;tablename=V_ZAY_ARC" checkselectedrow="false" target="Self"></command>
        </button>
        <button caption="Додати" hint="Створити заявку" id="btnAdd" type="Image" imagename="document_add" >
          <command type="PlSqlBlock" successurl="/barsroot/barsweb/dynform.aspx?form=frm_zay_sal_add_edit" checkselectedrow="false" target="Self">
            <sql>
              begin
              null;
              end;
            </sql>
            <parameters>
              <parameter name="p_id" type="Constant" add2successurl="true">
                <defaultvalue type="Constant" value="0"></defaultvalue>
              </parameter>
            </parameters>
          </command>
        </button>
        <button caption="Редагувати" hint="Редагувати заявку" id="btnEdit" type="Image" imagename="edit" >
          <command type="PlSqlBlock" successurl="/barsroot/barsweb/dynform.aspx?form=frm_zay_sal_add_edit" checkselectedrow="true" target="Self">
            <sql>
              begin
              null;
              end;
            </sql>
            <parameters>
              <parameter name="ID" altname="p_id" type="DataField"  add2successurl="true">
              </parameter>
            </parameters>
          </command>
        </button>
        <button caption="Видалити" hint="Видалити" id ="btDel" type="Image" imagename="delete2" confirmmessage="Ви дійсно бажаєте видалити заявку?" >
          <command type="PlSqlBlock" checkselectedrow="true" successmessage="Видалено"  >
            <sql>
              declare
                l_id zayavka.id%type;
              begin
                begin
                  select id into l_id
                    from zayavka
                   where id = :ID
                     and sos = 0
                     and viza in (0,-1)
                     and rnk = :RNK;
                exception
                  when no_data_found then raise_application_error(-20000,'Видалення неможливе!');
                end;
                bars_zay.del_request(l_id, 0);
              end;
            </sql>
            <parameters>
              <parameter type="DataField" name="ID" />
              <parameter type="DataField" name="RNK" />
            </parameters>
          </command>
        </button>

        <button caption="Списати" hint="Списання " id ="btSpis" type="Image" imagename="arrow_up" confirmmessage="Ви дійсно бажаєте списати засоби?" >
          <command type="PlSqlBlock" checkselectedrow="true" successmessage="Виконано списання!"  >
            <sql>
              declare
              l_operid oper.id_o%type;
              l_ref oper.ref%type;
              l_cnt number;
              l_cnt2 number;
              begin
              if sys_context('bars_context','user_mfo')!='300465'
              then
              begin
              select 1 into l_cnt from zayavka z where z.id =:ID and z.sos != 1;
              bars_error.raise_error('ZAY',63, to_char(:ID));
              exception when no_data_found then null;
              end;

              begin
              select z.ref_sps into l_ref from zayavka z where z.id =:ID and z.ref_sps is not null;
              bars_error.raise_error('ZAY',64, to_char(:ID),to_char(l_ref));
              exception when no_data_found then null;
              end;

              begin
              select tabn into l_operid from staff$base where id=user_id;
              exception when no_data_found then l_operid:=null;
              end;
              bars_zay.pay_selling_sps (:ID, null, l_ref);
              update oper set id_o = l_operid where ref=l_ref;
              else
              raise_application_error(-20000, 'Можливо виконання тільки на рівні РУ!');
              end if;
              end;
            </sql>
            <parameters>
              <parameter type="DataField" name="ID" />
            </parameters>
          </command>
        </button>
        <button caption="Проект проводок" hint="Проект проводок " id ="btProject" type="Image" imagename="arrow_right" confirmmessage="Ви дійсно бажаєте створити макет проводок?" >
          <command type="PlSqlBlock" checkselectedrow="true" successmessage="Виконано!"  >
            <sql>
              declare
              l_operid oper.id_o%type;
              l_ref oper.ref%type;
              l_cnt number;
              begin
              if sys_context('bars_context','user_mfo')='300465' then
              begin
              select 1 into l_cnt from zayavka z, oper o where z.sos = 1 and nvl(z.ref_sps,0)=o.ref and z.id = :ID and o.sos = 5;
              raise_application_error(-20000, 'По даній заявці не оплачено документ!');
              exception when no_data_found then null;
              end;
              end if;
              begin
              select tabn into l_operid from staff$base where id=user_id;
              exception when no_data_found then l_operid:=null;
              end;
              bars_zay.pay_selling (:ID,null, null, null, l_ref);
              update oper set id_o = l_operid where ref=l_ref;
              end;
            </sql>
            <parameters>
              <parameter type="DataField" name="ID" />
            </parameters>
          </command>
        </button>
      </buttons>
      <fields>
        <field name="SOS" datatype="Int64" key="false" sort="Default">
          <column show="true" caption="Задов" align="Center" width="25"/>
          <form show="false" rwmode="RO" required="false" columnindex="1" index="16">
            <uicontrol type="CheckBox" truevalue="1" align="Center" readonly="true"/>
          </form>
        </field>
        <field name="OBZ" datatype="Boolean" key="false" sort="Default">
          <column show="true" caption="ОБЗ" align="Center" width="25"/>
          <form show="false" rwmode="RO" required="false" columnindex="1" index="16">
            <uicontrol type="CheckBox" truevalue="1" align="Center" readonly="true"/>
          </form>
        </field>
        <field name="DK" datatype="Int64" key="false" sort="Default">
          <column show="false" caption="Тип заявки" align="Center" width="25"/>
          <form show="false" rwmode="RO" required="false" columnindex="1" index="16">
            <uicontrol type="CheckBox" truevalue="1" align="Center" readonly="true"/>
          </form>
        </field>
        <field datatype="Int64" key="false" name="KB">
          <column show="true"  caption="Кл-Б" align="Center"></column>
          <form show="false" rwmode="RO" required="false" columnindex="3" index="32">
            <uicontrol type="CheckBox" truevalue="1" align="Center" readonly="true"/>
          </form>
          <layout>
            <colors scope ="EntireRow" >
              <color color="clPlum" operation="Equal" value="1"></color>
            </colors>
          </layout>
        </field>
        <field datatype="Blob" key="false" name="DOC_DESC" lobtable="v_zay_salform" lobfilename="zay\QS[ID].doc"  lobrowtext="Завантажити" >
          <column caption="Файл заявки CORP2" show ="true"></column>
        </field>
        <field datatype="Int64" key="false" name="COVERED">
          <column show="true" caption="Забезп." align="Center"></column>
          <form columnindex="3" show="false" rwmode="RO" required="false" index="20">
            <uicontrol type="CheckBox" truevalue="1" align="Center" readonly="true" />
          </form>
        </field>
        <field name="ID" key="true" datatype="Int64" >
          <column show="true" caption="№ заявки"  width="15"/>
        </field>
        <field datatype="String" key="false" name="SVIZA" sort="Default">
          <column align="Left" caption="Віза" show="true"></column>
        </field>
        <field datatype="Int64" key="true" name="RNK">
          <column align="Right" caption="РНК" show="true"></column>
        </field>
        <field datatype="String" key="false" name="NMK" >
          <column align="Left" caption="Назва клієнта" show="true" width="300"></column>
        </field>
        <field datatype="String" key="false" name="CUST_BRANCH" sort="Default">
          <column align="Left" caption="Відділення клієнта" show="true"></column>
        </field>
        <field datatype="Int64" key="false" name="ACC0">
          <column align="Left" caption="ACC0" show="false"></column>
        </field>

        <field datatype="Int64" key="true" name="KV">
          <column caption="Валюта" width ="150" show="false"></column>
        </field>
        <field datatype="Int64" key="false" name="KV_CONV">
          <column caption="KV_CONV" width ="150" show="false"></column>
        </field>
        <field datatype="String" key="false" name="LCV_CONV">
          <column caption="Валюта зарахування" width ="150" show="true" align="Center"></column>
        </field>
        <field datatype="Int64" key="false" name="MFO0">
          <column align="Center" show="true" caption="МФО зарах. коштів"></column>
        </field>
        <field datatype="Int64" key="false" name="NLS0">
          <column align="Left" caption="Рахунок зарах. коштів" show="true"></column>
        </field>
        <field datatype="Int64" key="false" name="ACC1">
          <column align="Left" caption="ACC1" show="false"></column>
        </field>
        <field datatype="Int64" key="false" name="nls">
          <column caption="Рахунок для списання ВАЛ" align="Left" show="true"></column>
        </field>
        <field datatype="Decimal" key="false" name="OSTC">
          <column align="Right" caption="Сальдо рах ВАЛ" show="true"></column>
        </field>
        <field datatype="Decimal" key="false" name="S2">
          <column caption="Сума заявки" align="Right" show="false"></column>
        </field>
        <field datatype="Decimal" key="false" name="dig">
          <column caption="dig" align="Right" show="false"></column>
        </field>
        <field datatype="Decimal" key="false" name="S2S">
          <column caption="Сума заявл.ВАЛ" align="Right" show="true"></column>
        </field>
        <field datatype="DateTime" key="false" name="FDAT">
          <column align="Center" caption="Дата заяви" show="true" ></column>
        </field>
        <field datatype="String" name="ND" key="false">
          <column align="Right" caption="Номер заявки(кл.)" show="true"></column>
        </field>
        <field datatype="Int64" key="false" name="KOM">
          <column align="Center" caption="%% коміс." show="true"></column>
        </field>
        <field datatype="Decimal" key="false" name="SKOM">
          <column align="Right" caption="або сума коміс." show="true"></column>
        </field>
        <field datatype="Int64" key="false" name="KURS_Z">
          <column show="true" align="Right" caption="Курс заяви"></column>
        </field>
        <field datatype="Int64" key="false" name="KURS_F">
          <column align="Right" show="true" caption="Курс дилера"></column>
        </field>
        <field datatype="DateTime" key="false" name="VDATE">
          <column align="Center" caption="Дата валютування" show="true"></column>
        </field>
        <field datatype="Int64" key="false" name="META">
          <column align="Right" caption="Мета" show="false"  ></column>
        </field>
        <field datatype="String" key="false" name="aim_name">
          <column align="Left" caption="Ціль продажу" show="true" width="150"></column>
        </field>
        <field datatype="String" key="false" name="f092">
          <column align="Left" caption="Мета продажу (510)" show="true" width="200"></column>
        </field>
        <field datatype="String" key="false" name="contract">
          <column align="Left" caption="Контракт/кред.логовор №" show="true" width="150"></column>
        </field>
        <field datatype="DateTime" key="false" name="DATC">
          <column align="Center" caption="Дата контракта/кред.договора" show="true" width="100"></column>
        </field>
        <field datatype="String" key="false" name="num_vmd">
          <column align="Left" caption="№ ТД/акту вик.робіт" show="true" width="150"></column>
        </field>
        <field datatype="DateTime" key="false" name="VMD1">
          <column align="Center" caption="Дата ТД/Акту" show="true" width="100"></column>
        </field>
        <field datatype="String" key="false" name="BASIS">
          <column align="Left" caption="Підстава продажу валюти"></column>
        </field>
        <field datatype="DateTime" key="false" name="DATZ">
          <column align="Center" caption="Дата зарахування" show="true"></column>
        </field>
        <field datatype="String" key="false" name="Comm" size="250">
          <column align="Left" caption="Коментар(деталі)" show="true" width="600" ></column>
        </field>
        <field datatype="String" key="false" name="Contact_fio" size="70">
          <column align="Left" caption="ПІБ контактної особи" show="true" width="150" ></column>
        </field>
        <field datatype="String" key="false" name="Contact_tel" size="20">
          <column align="Left" caption="ТЕЛ контактної особи" show="true" width="150" ></column>
        </field>
        <field datatype="DateTime" key="false" name="DATT">
          <column align="Center" caption="Остання дата дії заяви" show="true"></column>
        </field>
      </fields>
    </grid>
  </grids>
</xmlform>