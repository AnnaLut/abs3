@{
    Layout = "~/Views/Shared/_LayoutKendo.cshtml";
    ViewBag.Title = "СЕП. Блокувати/Розблокувати напрямки.";
}

<h2>@ViewBag.Title</h2>


<div id="main">
    <div id="winPass">
        <input type="password" id="winPassValue" autofocus/>
        <button id="btnOk" type="button" onclick="passValid()">Ok</button>
    </div>
    <div id="window">
        @using (Html.BeginForm("StartDirection", "SepDirection"))
        {
            @Html.RadioButton("answer", "1", true) <span> Блокувати початкові платежі</span><br />
            @Html.RadioButton("answer", "2") <span> Розблокувати початкові платежі</span><br />
            @Html.RadioButton("answer", "3") <span> Блокувати відповідні платежі</span><br />
            @Html.RadioButton("answer", "4") <span> Розблокувати відповідні платежі</span><br />
            @Html.RadioButton("answer", "5") <span> Блокувати всі напрямки</span><br />
            @Html.RadioButton("answer", "6") <span> Розблокувати всі напрямки</span><br/>
            @Html.RadioButton("answer", "7") <span> ВПС. Блокувати вхідний напрямок (Код = 1)</span><br/>
            @Html.RadioButton("answer", "8") <span> ВПС. Розблокувати вхідний напрямок</span><br />
            <br />
            <dir id="dirSubmit">
                <button id="btnSubmit" type="button" onclick="onBtnSubmitClick()">Виконати</button>
            </dir>
        }
    </div>

    <script>
    var dd = new Date().getDate();
    var mm = new Date().getMonth() + 1;
    if (dd < 10) {
        dd = '0' + dd;
    }
    if (mm < 10) {
        mm = '0' + mm;
    }
    var datePass = mm.toString() + dd.toString();

    function passValid() {
        var PassValue = document.getElementById("winPassValue").value;
        if (PassValue == datePass) {
            $("#winPass").data("kendoWindow").close();
            $("#window").data("kendoWindow").center().open(); 
        }
        else {
            bars.ui.error({ title: 'Помилка', text: 'Введено невірний пароль.' });
            $("#winPass").load(location.href + " #winPass");
        }
    }

    function refreshMainForm() {
        $("#window").data("kendoWindow").close();
        $("#winPassValue").val("");
        $("#winPass").data("kendoWindow").open();
    }

    $("#winPass").keyup(function (event) {
        if (event.keyCode == 13) {
            $("#btnOk").click();
        }
    });

    $(document).ready(function () {

        $("#window").kendoWindow({
            width: "330px",
            title: "@ViewBag.Title",
                    actions: [
                        "Maximize"
                    ],
                    visible: false
            });

            $("#winPass").kendoWindow({
                width: "210px",
                title: "Введіть пароль"
            }).data("kendoWindow").center().open();

     });

        function onBtnSubmitClick() {
            var answerResult = $('input[name=answer]:checked', '#window').val();

            var MSG_VerbLock2 = 'Блокувати ';
            var MSG_VerbUnLock2 = 'Розблокувати ';
            var MSG_Q_StartDirLock2 = '"початкові" для підлеглих РП?';
            var MSG_Q_KFilesProcess2 = 'Формувати файли "K" на учасників СЕП?';
            var MSG_Q_BackDirLock2 = '"відповідні" для підлеглих РП?';
            var MSG_Q_AllDirLock2 = 'всі напрямки для підлеглих РП?';

            switch (answerResult) {
                case "1":
                    var confirmMassage = MSG_VerbLock2 + MSG_Q_StartDirLock2;
                    break;
                case "2":
                    var confirmMassage = MSG_VerbUnLock2 + MSG_Q_StartDirLock2;
                    break;
                case "3":
                    var confirmMassage = MSG_VerbLock2 + MSG_Q_BackDirLock2;
                    break;
                case "4":
                    var confirmMassage = MSG_VerbUnLock2 + MSG_Q_BackDirLock2;
                    break;
                case "5":
                    var confirmMassage = MSG_VerbLock2 + MSG_Q_AllDirLock2;
                    break;
                case "6":
                    var confirmMassage = MSG_VerbUnLock2 + MSG_Q_AllDirLock2;
                    break;
                case "7":
                    var confirmMassage = MSG_VerbLock2 + MSG_Q_AllDirLock2; // ???
                    break;
                case "8":
                    var confirmMassage = MSG_VerbUnLock2 + MSG_Q_AllDirLock2;  // ???
                    break;
            }
            bars.ui.confirm({ text: confirmMassage },
                   function () {
                       bars.ui.loader('#window', true);
                       $.get('@Url.Action("StartDirection", "SepDirection")', { answer: answerResult }).done(function (result) { 
                           bars.ui.loader('#window', false);
                           if (result.status == 'ok')
                           {
                               if (answerResult == "2" || answerResult == "4" || answerResult == "6") {
                                   bars.ui.confirm({ text: MSG_Q_KFilesProcess2 }, function () {
                                       refreshMainForm();
                                   });
                               }
                               else {
                                   refreshMainForm();
                               }
                           }
                           else {
                               bars.ui.error({ title: 'Помилка', text: 'Помилка створення файла-флагу K у директорії: ' + result.data.Value });
                                   $("#window").data("kendoWindow").close();
                                   //$("#winPassValue").val("");
                                   //$("#winPass").data("kendoWindow").open();                              
                           }
                       });
                   });    
        }
    </script>

    <style scoped>
        #main {
            min-height: 500px;
        }

        #dirSubmit {
            text-align: center;
        }

        .armchair {
            float: left;
            margin: 30px 30px 120px 30px;
            text-align: center;
        }

        .armchair img {
            display: block;
            margin-bottom: 10px;
        }

    </style>
</div>
