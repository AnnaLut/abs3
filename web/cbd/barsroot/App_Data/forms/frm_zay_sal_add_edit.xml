<xmlform caption="\SQ[select 'Заява №'||v.id||' клієнта '||v.nmk ||' (РНК '|| v.rnk ||') на продаж валюти ' from V_ZAY_SALFORM v where id = \QS[p_id] ]" captiontype="Default">
  <customforms>
    <customform name="frmV_ZAY_SALFORM" buttonsposition="Bottom" title="" columnscount="3">
      <buttons defaulttype="Button">
        <button caption="Зберегти" hint="Зберегти зміни" id="btnSave">
          <command type="PlSqlBlock" successmessage="Дані збережено" successurl="/barsroot/barsweb/dynform.aspx?form=frm_zay_sal_add"  target="Self">
            <sql>
              declare
              l_id number := :P_ID;
              l_s2s number := :P_S2S;
              l_nd varchar2(64) := :P_ND;
              l_fdat date := :P_FDAT;
              l_kurs_z number := :P_KURS_Z;
              l_nls varchar2(20) := :P_NLS;
              l_nls0 varchar2(36) := :P_NLS0;
              l_mfo0 varchar2(20) := :P_MFO0;
              l_kom number := :P_KOM;
              l_skom number := :P_SKOM;
              l_meta number := :P_META;
              l_contract varchar2(128) := :P_CONTRACT;
              l_datc date := :P_DATC;
              l_num_vmd varchar2(128) := :P_NUM_VMD;
              l_vmd1 date := :P_VMD1;
              l_basis varchar2(128) := :P_BASIS;
              l_comm varchar2(256) := :P_COMM;
              l_contact_fio varchar2(128) := :P_CONTACT_FIO;
              l_contact_tel varchar2(64) := :P_CONTACT_TEL;
              l_rnk number := :P_RNK;
              l_kv number := :P_KV;
              l_kv_conv number := :P_KV_CONV;
              begin
              if (l_id is not null) then
              bars_zay.upd_request
              (p_id           => l_id,
              p_s2s           => l_s2s,
              p_nd            => l_nd,
              p_fdat          => l_fdat,
              p_kurs          => l_kurs_z,
              p_kv_conv       => null,
              p_nls           => l_nls,
              p_nls_acc0      => l_nls,
              p_nls0          => l_nls0,
              p_mfo0          => l_mfo0,
              p_kom           => l_kom,
              p_skom          => l_skom,
              p_meta          => l_meta,
              p_contract      => l_contract,
              p_dat2_vmd      => l_datc,
              p_num_vmd       => l_num_vmd,
              p_dat_vmd       => l_vmd1,
              p_dat5_vmd      => null,
              p_basis         => l_basis,
              p_country       => null,
              p_benefcountry  => null,
              p_bank_code     => null,
              p_bank_name     => null,
              p_product_group => null,
              p_comm          => l_comm,
              p_contactfio    => l_contact_fio,
              p_contacttel    => l_contact_tel);

              else
              if nvl(l_kv_conv,980) != 980 then

              bars_zay.create_request_ex
              (p_reqtype  => 4,
              p_custid    => l_rnk,
              p_curid     => l_kv,
              p_curconvid   => l_kv_conv,
              p_amount    => l_s2s,
              p_reqnum    => l_nd,
              p_reqdate   => l_fdat,
              p_reqrate   => l_kurs_z,
              p_nls_acc1  => l_nls,
              p_nls_acc0  => l_nls,
              p_nataccnum => l_nls0,
              p_natbnkmfo => l_mfo0,
              p_cmsprc    => l_kom,
              p_cmssum    => l_skom,
              p_taxflg    => 0,
              p_taxacc    => null,
              p_aimid     => l_meta,
              p_contractid=> null,
              p_contractnum=> l_contract,
              p_contractdat=> l_datc,
              p_custdeclnum=> l_num_vmd,
              p_custdecldat=> l_vmd1,
              p_prevdecldat => null,
              p_basis     => l_basis,
              p_countryid => null,
              p_bnfcountryid => null,
              p_bnfbankcode => null,
              p_bnfbankname => null,
              p_productgrp => null,
              p_details     => l_comm,
              p_flag   => 0,
              p_fio         => l_contact_fio,
              p_tel         => l_contact_tel,
              p_branch      => null,
              p_operid_nokk => null,
              p_reqid       => l_id);
              else
              bars_zay.create_request_ex
              (p_reqtype  => 2,
              p_custid    => l_rnk,
              p_curid     => l_kv,
              p_curconvid => null,
              p_amount    => l_s2s,
              p_reqnum    => l_nd,
              p_reqdate   => l_fdat,
              p_reqrate   => l_kurs_z,
              p_nls_acc1  => l_nls,
              p_nls_acc0  => l_nls,
              p_nataccnum => l_nls0,
              p_natbnkmfo => l_mfo0,
              p_cmsprc    => l_kom,
              p_cmssum    => l_skom,
              p_taxflg    => 0,
              p_taxacc    => null,
              p_aimid     => l_meta,
              p_contractid=> null,
              p_contractnum=> l_contract,
              p_contractdat=> l_datc,
              p_custdeclnum=> l_num_vmd,
              p_custdecldat=> l_vmd1,
              p_prevdecldat => null,
              p_basis     => l_basis,
              p_countryid => null,
              p_bnfcountryid => null,
              p_bnfbankcode => null,
              p_bnfbankname => null,
              p_productgrp => null,
              p_details     => l_comm,
              p_flag   => 0,
              p_fio         => l_contact_fio,
              p_tel         => l_contact_tel,
              p_branch      => null,
              p_operid_nokk => null,
              p_reqid       => l_id);
              end if;
              end if;
              end;
            </sql>
            <parameters>
              <parameter type="FormField" name="P_ID" />
              <parameter type="FormField" name="P_S2S" />
              <parameter type="FormField" name="P_ND" />
              <parameter type="FormField" name="P_FDAT" />
              <parameter type="FormField" name="P_KURS_Z" />
              <parameter type="FormField" name="P_NLS" />
              <parameter type="FormField" name="P_NLS0" />
              <parameter type="FormField" name="P_MFO0" />
              <parameter type="FormField" name="P_KOM" />
              <parameter type="FormField" name="P_SKOM" />
              <parameter type="FormField" name="P_META" />
              <parameter type="FormField" name="P_CONTRACT" />
              <parameter type="FormField" name="P_DATC" />
              <parameter type="FormField" name="P_NUM_VMD" />
              <parameter type="FormField" name="P_VMD1" />
              <parameter type="FormField" name="P_BASIS" />
              <parameter type="FormField" name="P_COMM" />
              <parameter type="FormField" name="P_CONTACT_FIO" />
              <parameter type="FormField" name="P_CONTACT_TEL" />
              <parameter type="FormField" name="P_RNK" />
              <parameter type="FormField" name="P_KV" />
              <parameter type="FormField" name="P_KV_CONV" />
            </parameters>
          </command>
        </button>
        <button caption="Відміна" hint="Відміна" id="btnBack" type="Button"  >
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_zay_sal_add" target="Self">
          </command>
        </button>
      </buttons>
      <datasource>
        <sql>
          select *
          from v_zay_salform
          where id = :p_id
        </sql>
        <parameters>
          <parameter type="QueryString" name="p_id" datatype="Int64" >
          </parameter>
        </parameters>
      </datasource>
      <customfields>
        <customfield name="P_ID" label="№ заявки" required="false" datatype="Int64" datasourcefield="ID" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" />
        </customfield>
        <customfield name="P_FDAT" label="Дата заяви" datatype="DateTime" required="true" datasourcefield="FDAT" columnindex="1" index="2">
          <uicontrol type="DateInput" controlwidth="149">
            <defaultvalue type="SqlText" value="select gl.bd from dual" />
          </uicontrol>
        </customfield>
        <customfield name="P_S2S" label="Сума заявл.ВАЛ" datatype="Decimal" required="true" datasourcefield="S2S" columnindex="1" index="3">
          <uicontrol type="DecimalInput" controlwidth="149" />
        </customfield>
        <customfield name="P_RNK" label="РНК" datatype="Decimal" required="true" datasourcefield="RNK" columnindex="1" index="4">
          <uicontrol type="EditableReference"  controlwidth="130" formname="frm.ref.cust_zay" formfieldname="drnk" formheight="700" formwidth="1100" >
            <rels>
              <rel destname="P_CUST_BRANCH" srcname="branch"></rel>
              <rel destname="P_NMK" srcname="nmk"></rel>
              <rel destname="P_OSTC" srcname="ostc"></rel>
              <rel destname="P_NLS" srcname="nls29"></rel>
              <rel destname="P_NLS0" srcname="nls26"></rel>
              <rel destname="P_MFO0" srcname="mfo26"></rel>
            </rels>
          </uicontrol>
        </customfield>
        <customfield name="P_KV" label="Валюта" datatype="Int64" required="true" datasourcefield="KV" columnindex="1" index="5">
          <uicontrol type="EditableReference" controlwidth="130" formname="frm.ref.zay_kv_kurs" formfieldname="kv" formheight="450" formwidth="500">
            <rels>
              <rel destname="P_KURS_Z" srcname="kurs_s"></rel>
            </rels>
          </uicontrol>
        </customfield>
        <customfield name="P_KV_CONV" label="За валюту" datatype="Int64" datasourcefield="KV_CONV" columnindex="1" index="6">
          <uicontrol type="EditableReference" controlwidth="130" formname="frm.ref.zay_kv_kurs" formfieldname="kv"  formheight="450" formwidth="500"/>
        </customfield>
        <customfield name="P_NMK" label="Назва клієнта" datatype="String" size="100" datasourcefield="NMK" columnindex="1" index="7">
          <uicontrol type="TextBox" controlwidth="150" readonly="true" />
        </customfield>
        <customfield name="P_CUST_BRANCH" label="Відділення клієнта" required="false" datatype="String" size="100" datasourcefield="CUST_BRANCH" columnindex="1" index="8">
          <uicontrol type="TextBox" controlwidth="150" readonly="true" />
        </customfield>
        <!--<customfield name="P_NLS_ACC0" label="Рахунок для зарахування коштів на продажу" datatype="String" required="true" size="100" datasourcefield="NLS_ACC0" columnindex="1" index="9">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>-->
        <customfield name="P_NLS" label="Рахунок для списання ВАЛ" required="true" datatype="String" size="100" datasourcefield="NLS" columnindex="1" index="10">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_OSTC" label="Сальдо рах ВАЛ" datatype="Decimal" datasourcefield="OSTC" columnindex="1" index="11">
          <uicontrol type="DecimalInput" controlwidth="150"  readonly="true"/>
        </customfield>
        <customfield name="P_MFO0" label="МФО зарах. коштів" datatype="String" size="100" datasourcefield="MFO0" columnindex="1" index="12">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_NLS0" label="Рахунок зарах. коштів" required="true" datatype="String" size="100" datasourcefield="NLS0" columnindex="1" index="13">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_ND" label="Номер заявки(кл.)" datatype="String" size="100" datasourcefield="ND" columnindex="2" index="1">
          <uicontrol type="TextBox" controlwidth="153" />
        </customfield>
        <customfield name="P_KOM" label="%% коміс." datatype="Decimal" datasourcefield="KOM" columnindex="2" index="2">
          <uicontrol type="DecimalInput" controlwidth="150" />
        </customfield>
        <customfield name="P_SKOM" label="або сума коміс." datatype="Decimal" datasourcefield="SKOM" columnindex="2" index="3">
          <uicontrol type="DecimalInput" controlwidth="150" />
        </customfield>
        <customfield name="P_KURS_Z" label="Курс заяви" datatype="Decimal" datasourcefield="KURS_Z" columnindex="2" index="4">
          <uicontrol type="DecimalInput" controlwidth="148" />
        </customfield>
        <customfield name="P_META" label="Мета" datatype="Decimal" required="true" datasourcefield="META" columnindex="2" index="5">
          <uicontrol type="DropDownList"  addemptyitem="true" keyfield="AIM" valuefield="NAME" table="( select AIM, to_char(aim,'09')||' '||NAME name from ZAY_AIMS where type = 2)" controlwidth="157" ></uicontrol>
        </customfield>
        <customfield name="P_CONTRACT" label="Контракт/кред.логовор №" datatype="String" size="100" datasourcefield="CONTRACT" columnindex="2" index="6">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_DATC" label="Дата контракта/кред.договора" datatype="DateTime" datasourcefield="DATC" columnindex="2" index="7">
          <uicontrol type="DateInput" controlwidth="150" />
        </customfield>
        <customfield name="P_NUM_VMD" label="№ ТД/акту вик.робіт" datatype="String" size="100" datasourcefield="NUM_VMD" columnindex="2" index="8">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_VMD1" label="Дата ТД/Акту" datatype="DateTime" datasourcefield="VMD1" columnindex="2" index="9">
          <uicontrol type="DateInput" controlwidth="150" />
        </customfield>
        <customfield name="P_BASIS" label="Підстава продажу валюти" datatype="String" size="100" datasourcefield="BASIS" columnindex="3" index="1">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_COMM" label="Коментар(деталі)" datatype="String" size="100" datasourcefield="COMM" columnindex="3" index="2">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_CONTACT_FIO" label="ПІБ контактної особи" datatype="String" size="100" datasourcefield="CONTACT_FIO" columnindex="3" index="3">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
        <customfield name="P_CONTACT_TEL" label="ТЕЛ контактної особи" datatype="String" size="100" datasourcefield="CONTACT_TEL" columnindex="3" index="4">
          <uicontrol type="TextBox" controlwidth="150" />
        </customfield>
      </customfields>
    </customform>
  </customforms>
</xmlform>