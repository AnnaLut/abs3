<xmlform captiontype="OnlyTitle"   version="v.1.1" caption="Перекриття інкасації saldo (WEB)" >
<grids>

<!--
    СТРОКА ВИЗОВА
    =================================================================
    grp -  Група перекриття    
 -->

  <grid id="tNlg2"  pagesize="10"  showpagesizebox="true"   title="Перекриття інкасації saldo (WEB)"  width="2000" >
    <filters columnscount="3" caption="Фільтр" buttontext="Пошук" width="700">
      <filter id="fId1" caption="Рах. А"  condition="LikeBoth" columnindex="1" field="NLSA">
        <uicontrol  type="IntegerInput"/>
      </filter>
      <filter id="fId2" caption="Сума"  condition="LikeBoth" columnindex="2" field="S"></filter>
      <filter id="fId3" caption="Призначення пл."  condition="LikeBoth" columnindex="3" field="NAZN"></filter>
    </filters>
       <datasource>
      <sql>
        select v.*, v.s/100 as sum
        from V_PER_WEB_OST v
        where grp=:grp and exists (select 1 from v_gl where acc = v.acc and ostc = ostb)
        and (decode(v.mfob,  f_ourmfo, 1, 0) = 1
        or (decode(v.mfob,  f_ourmfo, 1, 0) = 0 and exists (  select 1 from chklist_tts where f_in_charge = 3 and v.tt = tt)))
      </sql>
       <parameters>
         <parameter  type="QueryString" name="GRP"   altname="grp"/>
       </parameters> 
 
    </datasource>
    
    <rowselection method="CheckBox" />

    <buttons>
      <button caption="Виконати перекриття" id="Bt1_Pr" type="Button" hint="Виконання перекриття" confirmmessage="Виконати перекриття?" >
        <command type="PlSqlBlock" successmessage="Перекритя виконано">
          <sql>
            declare
            l_ref     oper.ref%type ;


            BEGIN
            for k in (
            Select i.*,  nazn as naznp
            from V_PER_WEB_OST i
            where (decode(i.mfob,  f_ourmfo, 1, 0) = 1
            or (decode(i.mfob,  f_ourmfo, 1, 0) = 0
            and exists (  select 1 from chklist_tts where f_in_charge = 3 and i.tt = tt)))
            and acc = :acc
            and exists (select 1 from v_gl where acc = i.acc and ostc = ostb)
            )
            loop

            gl.ref (l_ref);


            gl.in_doc3(ref_    => l_ref,
            tt_    => k.TT,
            vob_   => k.VOB,
            nd_    => l_ref,
            pdat_  => SYSDATE ,
            vdat_  => gl.BDATE,
            dk_    => 1,
            kv_    => k.KVA,
            s_     => k.S,
            kv2_   => k.KVB,
            s2_    => k.S,
            sk_    => null,
            data_  => gl.BDATE,
            datp_  => gl.bdate,
            nam_a_ => k.NAM_A,
            nlsa_  => k.NLSA,
            mfoa_  => gl.aMfo,
            nam_b_ => k.NAM_B,
            nlsb_  => k.NLSB,
            mfob_  => k.MFOB,
            nazn_  => substr(k.NAZNP,1,160),
            d_rec_ => null,
            id_a_  => k.OKPOA,
            id_b_  => k.OKPOB,
            id_o_  => null,
            sign_  => null,
            sos_   => 1,
            prty_  => null,
            uid_   => null);

            PAYTT(flg_ => 0,
            ref_ => l_ref,
            datv_=> gl.bdate,
            tt_  => k.TT,
            dk0_ => 1   ,
            kva_ => k.KVA,
            nls1_=> k.NLSA,
            sa_  => k.S,
            kvb_ => k.KVB ,
            nls2_=> k.NLSB,
            sb_  => k.S
            ) ;


            if substr(k.NAZNP,161,160) is not null    then
            begin
            insert into operw (ref, tag, value, kf)
            values (l_ref, 'П', substr(k.NAZNP,161,160), f_ourmfo);
            exception when dup_val_on_index then
            null;
            end;
            end if;

            update per_ink
            set  ref = l_ref
            where ref = k.REF;

            end loop;


            END;
          </sql>
          <parameters>
            <parameter   type="DataField" name="ACC"></parameter>
          </parameters>
        </command>
      </button>

      <!--<button caption="    Видалити    " id="Bt1_Del" type="Button" hint="Видалити запис" confirmmessage="Видалити виділені стрічки?" >
        <command type="PlSqlBlock" successmessage="Видалено успішно">
          <sql>
            begin
            update per_ink
              set  id = :REF
                where ref = :REF;
            END;
          </sql>
          <parameters>
              <parameter   type="DataField" name="REF"></parameter>
          </parameters>
        </command>
      </button>-->

    </buttons>
    
    <fields>

      
      <field name="VOB" datatype="Int64" key="false" sort="Default" size="30">
        <column show="false" caption="Вид. оп" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="TT" datatype="String" key="false" sort="Default" size="30">
        <column show="true" caption="Код. оп" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="NLSA" datatype="Int64" key="false" sort="Default" size="30">
        <column show="true" caption="Рах. А" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="KVA" datatype="Int64" key="false" sort="Default" size="30">
        <column show="false" caption="Вал. А" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="NLSB" datatype="String" key="false" sort="Default" size="30">
        <column show="true" caption="Рах. В" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="KVB" datatype="Int64" key="false" sort="Default" size="30">
        <column show="true" caption="Вал. В" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="MFOB" datatype="String" key="false" sort="Default" size="30">
        <column show="true" caption="МФО. В" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="S" datatype="Int64" key="false" sort="Default" size="30">
        <column show="false" caption="Сума документа" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="SUM" datatype="Decimal" key="false" sort="Default"  size="100">
        <column show="true" caption="Сума документа" width="100" align="Right"/>
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="NAM_A" datatype="String" key="false" sort="Default" size="160">
        <column show="true" caption="Платник" width="160" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="NAM_B" datatype="String" key="false" sort="Default" size="160">
        <column show="true" caption="Отримувач" width="160" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="NAZN" datatype="String" key="false" sort="Default" >
        <column show="true" caption="Призначення " width="750"  />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="OKPOA" datatype="String" key="false" sort="Default" size="30">
        <column show="false" caption="ОКПО Платник" width="30" />
        <form show="false" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="OKPOB" datatype="String" key="false" sort="Default" size="30">
        <column show="true" caption="ОКПО Отримувач" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="ACC" datatype="Int64" key="true" sort="Default" size="30">
        <column show="false" caption="Референс документа" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <field name="SS" datatype="Int64" key="false" sort="Default" size="30">
        <column show="false" caption="SS Сума документа" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>

      <!--<field name="MODE1" datatype="Int64" key="true" sort="Default" size="30">
        <column show="true" caption="MODE" width="30" />
        <form show="true" rwmode="RO">
          <uicontrol type="Text" />
        </form>
      </field>-->

    </fields>
  </grid>


</grids>
</xmlform>