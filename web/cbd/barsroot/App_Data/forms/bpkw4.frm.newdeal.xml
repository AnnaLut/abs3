<?xml version="1.0" encoding="utf-8"?>
<xmlform captiontype="OnlyTitle" caption="Реєстрація нової картки">
  <customforms>
    <customform name="frmMsg" title="Реєстрація нової картки" showborder="false" >
      <datasource>
        <sql>
          select substr(bars_ow.check_opencard(:rnk, :card_code),1,254) msg from dual
        </sql>
        <parameters>
          <parameter type="QueryString" name="rnk" datatype="Int64"></parameter>
          <parameter type="QueryString" name="card_code" datatype="String" ></parameter>
        </parameters>
      </datasource>
      <customfields>
        <customfield name="MSG" datatype="String" label="" datasourcefield="msg">
          <uicontrol type="Label" controlwidth="800" readonly="true"></uicontrol>
        </customfield>
      </customfields>
    </customform>
    <customform name="frmBpkW4Deal" buttonsposition="Top" columnscount="3">
      <datasource>
        <sql>
          select c.rnk, c.okpo, c.ctype, c.nmk, c.adr, trim(c.doc || ' ' || c.issuer) doc, c.bdayplace,
          c.nmkv_first nmkv_first, c.nmkv_last,
          p.card_code, p.sub_name, p.product_name,
          decode(p.proect_id,-1,null,p.proect_id) proect_id, p.proect_name,
          p.sh_name, p.nbs, p.ob22, p.kv,
          p.acc_rate, p.mobi_rate, p.cred_rate, p.ovr_rate, p.mm_max,
          p.proect_name work
          from v_bpk_customer c, v_w4_product p
          where c.rnk = :rnk
          and p.proect_id = :proect_id and p.card_code = :card_code
        </sql>
        <parameters>
          <parameter type="QueryString" name="rnk" datatype="Int64" ></parameter>
          <parameter type="QueryString" name="proect_id" datatype="Int64"></parameter>
          <parameter type="QueryString" name="card_code" datatype="String" ></parameter>
        </parameters>
      </datasource>
      <customfields>
        <!-- Клиент -->
        <customfield name="RNK" datatype="Int64" index="1" label="РНК" datasourcefield="rnk" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true">
          </uicontrol>
        </customfield>
        <customfield name="OKPO" datatype="String" index="2" label="ЗКПО" datasourcefield="okpo" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="CTYPE" datatype="String" index="3" label="Тип клієнта" datasourcefield="ctype" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="NMK" datatype="String" index="4" label="ПІБ (назва)" datasourcefield="nmk" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true" linescount="3"></uicontrol>
        </customfield>
        <customfield name="ADR" datatype="String" index="5" label="Адреса" datasourcefield="adr" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true" linescount="3"></uicontrol>
        </customfield>
        <customfield name="DOC" datatype="String" index="6" label="Документ" datasourcefield="doc" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true" linescount="3"></uicontrol>
        </customfield>
        <customfield name="BDAY" datatype="String" index="7" label="Дата, місце народження" datasourcefield="bdayplace" columnindex="1" groupname="Клієнт">
          <uicontrol controlwidth="170" readonly="true" linescount="3"></uicontrol>
        </customfield>
        <!-- Картка -->
        <customfield name="TERM" datatype="String" index="1" label="Кількість місяців дії" datasourcefield="mm_max" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="CARD_CODE" datatype="String" index="2" label="Код картки" datasourcefield="card_code" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true">
          </uicontrol>
        </customfield>
        <customfield name="SUB_NAME" datatype="String" index="3" label="Картка" datasourcefield="sub_name" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="PRODUCT_NAME" datatype="String" index="4" label="Продукт" datasourcefield="product_name" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true" linescount="2"></uicontrol>
        </customfield>
        <customfield name="PROECT_CODE" datatype="Int64" index="5" label="Код З/П проекту" datasourcefield="proect_id" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="PROECT_NAME" datatype="String" index="6" label="З/П проект" datasourcefield="proect_name" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true" linescount="2"></uicontrol>
        </customfield>
        <customfield name="SH_NAME" datatype="String" index="7" label="Схема рахунків" datasourcefield="sh_name" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="NBS" datatype="String" index="8" label="Балансовий рахунок" datasourcefield="nbs" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="OB22" datatype="String" index="9" label="ОБ22" datasourcefield="ob22" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="KV" datatype="String" index="10" label="Валюта" datasourcefield="kv" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="NLS" datatype="String" index="11" label="Рахунок Instant" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <!--customfield name="ACC_RATE" datatype="String" index="10" label="Відсоток на залишок" datasourcefield="acc_rate" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="MOBI_RATE" datatype="String" index="11" label="Відсоток на Моб.заощ." datasourcefield="mobi_rate" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="CRED_RATE" datatype="String" index="12" label="Відсоток на дозв.овердрафт" datasourcefield="cred_rate" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield>
        <customfield name="OVR_RATE" datatype="String" index="13" label="Відсоток на недозв.овердрафт" datasourcefield="ovr_rate" columnindex="2" groupname="Картка">
          <uicontrol controlwidth="170" readonly="true"></uicontrol>
        </customfield-->
        <!-- Way4 -->
        <customfield name="FIRST_NAME" datatype="String" required="true" index="1" label="Ім'я на картці" datasourcefield="nmkv_first" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="LAST_NAME" datatype="String" required="true" index="2" label="Прізв. на картці" datasourcefield="nmkv_last" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="SEC_NAME" datatype="String" required="true" index="3" label="Таємне слово" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="WORK" datatype="String" index="4" label="Місце роботи" datasourcefield="work" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="OFFICE" datatype="String" index="5" label="Посада" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="WDATE" datatype="DateTime" index="6" label="Дата прийняття на роботу" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170"></uicontrol>
        </customfield>
        <customfield name="BRANCH" datatype="String" required="true" index="7" label="Відділення" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="135" type="ReadOnlyReference" formname="bpkw4.ref.branch" formfieldname="branch" formwidth="500" formheight="400">
            <defaultvalue type="PlSqlFunction" value="iif_n(length(sys_context('bars_context','user_branch')),8,'*','*',sys_context('bars_context','user_branch'))"/>
            <rels>
              <rel destname="BRANCH_NAME" srcname="name"></rel>
            </rels>            
          </uicontrol>
        </customfield>
        <customfield name="BRANCH_NAME" datatype="String" index="8" label="Відділення" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170" readonly="true" linescount="2">
            <defaultvalue type="PlSqlFunction" value="iif_n(length(sys_context('bars_context','user_branch')),8,'*','*',branch_usr.get_branch_name)"/>
          </uicontrol>
        </customfield>
        <customfield name="DELIVERY_BRANCH" datatype="String" required="true" index="9" label="Адреса доставкии" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="135" type="ReadOnlyReference" formname="bpkw4.ref.branch_obu" formfieldname="branch" formwidth="500" formheight="400">
            <defaultvalue type="PlSqlFunction" value="iif_n(length(sys_context('bars_context','user_branch')),8,'*','*',sys_context('bars_context','user_branch'))"/>
            <rels>
              <rel destname="DELIVERY_BRANCH_NAME" srcname="name"></rel>
            </rels>
          </uicontrol>
        </customfield>
        <customfield name="DELIVERY_BRANCH_NAME" datatype="String" index="10" label="Адреса доставкии" columnindex="3" groupname="Way4">
          <uicontrol controlwidth="170" readonly="true" linescount="2">
            <defaultvalue type="PlSqlFunction" value="iif_n(length(sys_context('bars_context','user_branch')),8,'*','*',branch_usr.get_branch_name)"/>
          </uicontrol>
        </customfield>
      </customfields>
      <buttons defaulttype="Button">
        <button id="btnOpenCard" caption="Зареєструвати картку" hint="Реєстрація картки">
          <command type="PlSqlBlock" successmessage="Картку зареєстровано" successurl="/barsroot/barsweb/dynform.aspx?form=bpkw4.frm.portfolio">
            <sql>
              declare
              l_nd number;
              begin
              bars_ow.open_card(:RNK, :NLS, :CARD_CODE, :BRANCH,
              :FIRST_NAME, :LAST_NAME, :SEC_NAME, :WORK, :OFFICE, :WDATE, :PROECT_CODE, :TERM, :DELIVERY_BRANCH, l_nd);
              end;
            </sql>
            <parameters>
              <parameter type="FormField" name="RNK"></parameter>
              <parameter type="FormField" name="NLS"></parameter>
              <parameter type="FormField" name="CARD_CODE"></parameter>
              <parameter type="FormField" name="BRANCH"></parameter>
              <parameter type="FormField" name="FIRST_NAME"></parameter>
              <parameter type="FormField" name="LAST_NAME"></parameter>
              <parameter type="FormField" name="SEC_NAME"></parameter>
              <parameter type="FormField" name="WORK"></parameter>
              <parameter type="FormField" name="OFFICE"></parameter>
              <parameter type="FormField" name="WDATE"></parameter>
              <parameter type="FormField" name="PROECT_CODE"></parameter>
              <parameter type="FormField" name="TERM"></parameter>
              <parameter type="FormField" name="DELIVERY_BRANCH"></parameter>
            </parameters>
          </command>
        </button>
        <button id="btnBackToPortfolio" caption="Повернутися до портфелю" hint="Повернутися до портфелю">
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=bpkw4.frm.portfolio"></command>
        </button>
      </buttons>
    </customform>
  </customforms>
</xmlform>