create or replace view v_tobo_accounts_lite as
select /*+ index( s xak_accounts_branch )*/
CREATE OR REPLACE VIEW BARS.V_TOBO_ACCOUNTS_LITE
( ACC,NLS,NLSALT,KV,
  LCV,
  DIG,
  DENOM,
  KF,
  BRANCH,
  TOBO,
  NBS,
  NBS2,
  DAOS,
  DAPP,
  ISP,
  RNK,
  NMS,
  LIM,
  OST,
  OSTB,
  OSTC,
  OSTF,
  OSTQ,
  OSTX,
  DOS,
  KOS,
  DOSQ,
  KOSQ,
  PAP,
  TIP,
  VID,
  TRCN,
  MDATE,
  DAZS,
  SEC,
  ACCC,
  BLKD,
  BLKK,
  POS,
  SECI,
  SECO,
  GRP,
  OB22,
  NOTIFIER_REF,
  BDATE,
  OPT,
  DAPPQ,
  INTACCN,
  FIO,
  R011,
  R013,
  S180,
  S240,
  OKPO
) AS
   SELECT /*+ INDEX( s XAK_ACCOUNTS_BRANCH )*/
          s.acc,
          s.nls,
          s.nlsalt,
          s.kv,
          v.lcv,
          v.dig,
          v.denom,
          s.kf,
          s.branch,
          s.tobo,
          s.nbs,
          s.nbs2,
          s.daos,
          s.dapp,
          s.isp,
          s.rnk,
          s.nms,
          s.lim,
          decode(s.dapp, d.bnk_dt, s.ostc + s.dos - s.kos, s.ostc) as ost, -- остаток входящий
          s.ostb,
          s.ostc,        -- остаток исходящий
          s.ostf,
          s.ostq,
          s.ostx,
          DECODE( s.DAPP, d.BNK_DT, s.dos,  0) dos,
          DECODE( s.DAPP, d.BNK_DT, s.kos,  0) kos,
          DECODE( s.DAPP, d.BNK_DT, s.dosq, 0) dosq,
          DECODE( s.DAPP, d.BNK_DT, s.kosq, 0) kosq,
          decode( s.dapp, d.bnk_dt, s.dos,  0) dos,
          decode( s.dapp, d.bnk_dt, s.kos,  0) kos,
          decode( s.dapp, d.bnk_dt, s.dosq, 0) dosq,
          decode( s.dapp, d.bnk_dt, s.kosq, 0) kosq,
          DECODE( s.DAPP, d.BNK_DT, s.dos,  0 ) dos,
          DECODE( s.DAPP, d.BNK_DT, s.kos,  0 ) kos,
          DECODE( s.DAPP, d.BNK_DT, s.dosq, 0 ) dosq,
          DECODE( s.DAPP, d.BNK_DT, s.kosq, 0 ) kosq,
          s.pap,
          s.tip,
          s.vid,
          DECODE(s.dapp, d.BNK_DT, s.trcn, 0) trcn,
          decode(s.dapp, d.bnk_dt, s.trcn, 0) trcn,
          DECODE( s.dapp, d.BNK_DT, s.trcn, 0 ) trcn,
          s.mdate,
          s.dazs,
          s.sec,
          s.accc,
          s.blkd,
          s.blkk,
          s.pos,
          s.seci,
          s.seco,
          s.grp,
          s.ob22,
          s.notifier_ref,
          s.bdate,
          s.opt,
          s.dappq,
          acrn.fprocn( s.acc, DECODE( s.pap,  1, 0,  2, 1,  1), d.BNK_DT ) intacc,
          u.FIO,
          p.R011,
          p.R013,
          p.S180,
          p.s240,
		  c.okpo
     from      saldo s
     join      tabval$global v             on ( v.kv = s.kv )
	 join      customer c                  on c.rnk = s.rnk
     join      v_user_allowed_branches b   on ( b.branch = s.branch )
     join      staff$base u                on ( u.id = s.isp )
     left join specparam p                 on ( p.acc = s.acc )
    cross join ( select bankdate_g as bnk_dt from dual ) d

show err

grant select on bars.v_tobo_accounts_lite to bars_access_defrole;
grant select on bars.v_tobo_accounts_lite to wr_all_rights;
grant select on bars.v_tobo_accounts_lite to wr_custlist;
grant select on bars.v_tobo_accounts_lite to wr_tobo_accounts_list;
grant select on bars.v_tobo_accounts_lite to wr_viewacc;

         