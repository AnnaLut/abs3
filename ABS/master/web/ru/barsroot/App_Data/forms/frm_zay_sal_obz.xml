<?xml version="1.0" encoding="utf-8"?>
<xmlform captiontype="OnlyTitle">
<grids>
<grid id="gv1" pagesize="10" showpagesizebox="true" title ="Візування ПРІОРИТЕТНИХ заявок на ПРОДАЖ валюти">
  <filters caption="Фільтри" width="50%" buttontext="Знайти" columnscount="3">
    <filter caption="Валюта" columnindex="1" field="KV2"  condition="Equal" id="fltrKV2">
      <uicontrol type="DropDownList" table="(select t.kv kv, (t.lcv||' '||t.name) name from tabval t, 
                             (select user_id, kv, sort_ord from tabval_sort where user_id = USER_ID()) s
                         WHERE t.kv != 980 
                         AND t.kv = s.kv(+) 
                        ORDER BY s.sort_ord, t.kv)" keyfield="kv" valuefield="name" addemptyitem="false">
        <defaultvalue type="Constant" value="840"/>
      </uicontrol>
    </filter>
    <filter caption="Номер заявки" columnindex="2" field="ID"  condition="Equal" id="fltrID">
      <uicontrol type="IntegerInput"></uicontrol>
    </filter>
    <filter caption="РНК клієнта" columnindex="2" field="RNK"  condition="Equal" id="fltrRNK">
      <uicontrol type="IntegerInput"></uicontrol>
    </filter>
    <filter caption="Заявки по Клієнт-Банку" columnindex="1" field="KB" condition="Equal" id="fltrFLB">
      <uicontrol type="DropDownList" table="(select id, name from
                                                    (select decode(id, 'YES', 1, 0) id, name from fm_yesno
                                                     union 
                                                     select null id, null from dual)
                                                      order by id desc)" keyfield="id" valuefield="name" addemptyitem="false">
      </uicontrol>
    </filter>
  </filters>
  <buttons defaulttype="Button">
    <button caption="Завізувати" hint="Підтвердити заявку на продаж валюти" id="btn1" type="Image" imagename="checks" confirmmessage="Завізувати заявку?">
      <command type="PlSqlBlock" successmessage="Завізовано відмічені заявки!">
        <sql>
          Begin
            UPDATE zayavka  SET viza = 2  WHERE dk = 2  AND id = :ID;
            logger.info('ZAY.Завізовано пріоритетну заявку на продаж №'||:ID||'клієнта '||:RNK);
          end;
        </sql>
        <parameters>
          <parameter type="DataField" datatype="Int64" name="ID"></parameter>
	        <parameter type="DataField" datatype="Int64" name="RNK" >	 </parameter>   	      		  
        </parameters>
      </command>
     </button>
    <button caption="Скасувати" hint="Скасувати заявку" id="Btn2" type="Image" imagename="delete2" confirmmessage="Сторнувати заявку?">
      <command type="PlSqlBlock" successmessage="Сторновано відмічені заявки!">
        <sql>
          BEGIN
            UPDATE zayavka SET viza = -1, idback = :ReasonId  WHERE dk  = 2  AND id = :ID;
          
          logger.info('ZAY.Відмовлено в візі для заявки на продаж №'||:ID||'клієнта '||:RNK||'. Код причини '||:ReasonId);
          END;
        </sql>
        <parameters>
          <parameter datatype="Int64" type="DataField" name="ID" ></parameter>
          <parameter datatype="Int64" type="FormField" name="ReasonId"></parameter>
          <parameter type="DataField" name="RNK" datatype="Int64">	 </parameter>
        </parameters>
        <customfields oktext="Підтвердити" canceltext="Відмінити">
          <customfield datatype="Int64" label="Причина сторно заявки" name="ReasonID" altname="ReasonID">
            <uicontrol controlwidth="150"  table="zay_back" keyfield="id" valuefield="Reason" addemptyitem="false" formfieldname="ID"  type="DropDownList">
              <rels>
                <rel destname="ReasonID" srcname="id"></rel>
              </rels>
            </uicontrol>
          </customfield>
          
         </customfields>
       </command>      
    </button>
  </buttons>

  <datasource>
    <sql>
      SELECT decode(nvl(identkb,0),0,0,1) KB, lcv, kv2, dk, id, rnk, nmk, cust_branch, priorname, s2s, kurs_z, fdat
      FROM v_zay_queue
      WHERE dk          = 2
      AND sos         = 0
      AND viza        = 1
      AND priorverify = 1
      AND s2s         > 0
      AND kurs_z IS NOT NULL
      AND branch like sys_context('bars_context','user_branch')||'%'
      ORDER BY fdat, kv2, priority desc, kurs_z
    </sql>
  </datasource>
  <rowselection method="CheckBox"/>
  <fields>
    <field datatype="Int64" key="false" name="KB">
      <column show="true"  caption="Кл-Б"></column>
      <form show="false" rwmode="RO" required="false" >
        <uicontrol type="CheckBox" truevalue="1" align="Center" readonly="true"/>
      </form>
      <layout >
        <colors >
          <color color="clPlum" operation="Equal" value="1" ></color>
        </colors>
      </layout>
    </field>
    <field datatype="String" key="true" name="lcv">
      <form show="false"></form>
      <column caption="Код ВАЛ" show ="true"></column>
    </field>
    <field datatype="Int64" key="true" name="kv2">
      <form show="false"></form>
      <column caption="Код валюти" show ="false"></column>
    </field>
    <field datatype="Int64" key="false" name="dk">
      <form show="false"></form>     
      <column caption="" show ="false"></column>
    </field>
    <field datatype="Int64" key="true" name="id">
      <form show="false"></form>
      <column caption="№ заявки" show ="true"></column>
    </field>
    <field datatype="Int64" key="true" name="RNK">
      <form show="false"></form>
      <column caption="РНК клієнта" show ="false"></column>
    </field>
    <field datatype="String" key="false" name="NMK">
      <form show="false"></form>
      <column caption="Клієнт" show ="true"></column>
    </field>
    <field datatype="String" key="false" name="CUST_BRANCH">
      <form show="false"></form>
      <column caption="Відділення" show ="true"></column>
    </field>
    <field datatype="String" key="false" name="priorname">
      <form show="false"></form>
      <column caption="Пріоритет заявки" show ="true"></column>
    </field>
    <field datatype="Decimal" key="true" name="S2s">
      <form show="false"></form>
      <column caption="Сума продажу ВАЛ" show ="true"></column>
    </field>
    <field datatype="Decimal" key="true" name="KURS_Z">
      <form show="false"></form>
      <column caption="Курс заявки" show ="true"></column>
    </field>
    <field datatype="DateTime" key="true" name="fdat">
      <form show="false"></form>
      <column caption="Дата заявки" show ="true"></column>
    </field>
    
 </fields>
</grid>
</grids>
</xmlform>