<?xml version="1.0" encoding="utf-8" ?>
<xmlform captiontype="OnlyTitle">
  <grids>
    <grid id="gv" table="v_grt_events" pagesize="10" showpagesizebox="true" title="Графік подій за договором з кодом \QS[DEAL_ID]" showfilter="true">
      <datasource>
        <parameters>
          <parameter name="DEAL_ID" type="QueryString"></parameter>
        </parameters>
      </datasource>
      <filters caption="Фільтри" buttontext="Пошук" columnscount="2" >
        <filter id="f1" caption="Подія" field="TYPE_ID" condition="Equal" columnindex="1" >
          <uicontrol type="DropDownList" table="grt_event_types" addemptyitem="true" keyfield="event_id" valuefield="event_name"></uicontrol>
        </filter>
        <filter id="f2" caption="Планова дата від" field="PLANNED_DATE" allowemptyvalue="true"  columnindex="2" condition="GreatEqual">
          <uicontrol type="DateInput">
           <!-- <defaultvalue type="PlSqlFunction" value="sysdate"/> -->
          </uicontrol>
        </filter>
      </filters>
      <buttons defaulttype="Button">
        <!--
        <button id="bBack" caption="Назад"  hint="Повернутися до портфелю договорів забезпечення">
          <command type="Redirect" checkselectedrow="false" url="dynform.aspx?form=frm_grt_portfolio">
          </command>
        </button>
        -->
        <button id="btnCalc" caption="Розрахувати" hint="Розрахувати графік подій за договором">
          <command type="PlSqlBlock" checkselectedrow="false" successmessage="Графік розраховано">
            <sql>
              begin grt_mgr.build_events(:p_deal_id, :p_eventtype, :p_freq); end;
            </sql>
            <parameters>
              <parameter name="p_deal_id" type="FormField" />
              <parameter name="p_eventtype" type="FormField" />
              <parameter name="p_freq" type="FormField"  />
            </parameters>
            <customfields oktext="Розрахувати" canceltext="Відміна" title="Параметри розрахунку" >
              <customfield name="p_deal_id" label="Код договору" datatype="Int64"  >
                <uicontrol type="TextBox" readonly="true">
                  <defaultvalue type="QueryString" value="deal_id"/>
                </uicontrol>
              </customfield>
              <customfield name="p_eventtype" label="Тип події" datatype="Int64" required="true" >
                <uicontrol type="DropDownList" table="grt_event_types" addemptyitem="true" keyfield="event_id" valuefield="event_name"></uicontrol>
              </customfield>
              <customfield name="p_freq" label="Період" datatype="Int64" required="true">
                <uicontrol type="DropDownList" table="freq" addemptyitem="true" keyfield="freq" valuefield="name"></uicontrol>
              </customfield>
            </customfields>
          </command>
        </button>
      </buttons>
      <rowselection method="SingleRow" />
      <editform style="Dialog" title="{0} {1}" height="500" width="600" columnscount="1" >
        <buttons defaulttype="button">
          <button id="btnIns" caption="Додати|Зберегти|Вiдмiнити" hint="Додати рядок|Зберегти рядок|Вiдмiнити додавання" confirmmessage="">
            <command type="Insert">
              <sql>
                <sql>begin grt_mgr.insert_event(:DEAL_ID, :TYPE_ID, :PLANNED_DATE, :ACTUAL_DATE, :COMMENT_TEXT); end;</sql>
              </sql>
              <parameters>
                <parameter type="DataField" name="DEAL_ID" />
                <parameter type="DataField" name="TYPE_ID" />
                <parameter type="DataField" name="PLANNED_DATE" />
                <parameter type="DataField" name="ACTUAL_DATE" />
                <parameter type="DataField" name="COMMENT_TEXT" />
              </parameters>
            </command>
          </button>
          <button id="btnEdit" caption="Редагувати|Зберегти|Вiдмiнити" hint="Редагувати рядок|Зберегти рядок|Вiдмiнити редагування" confirmmessage="">
            <command type="Edit">
              <sql>begin grt_mgr.update_event(:ID, :ACTUAL_DATE, :COMMENT_TEXT); end;</sql>
              <parameters>
                <parameter type="DataField" name="ID" />
                <parameter type="DataField" name="ACTUAL_DATE" />
                <parameter type="DataField" name="COMMENT_TEXT" />
              </parameters>
            </command>
          </button>
          <button caption="Закрити" id="btnClose">
            <command type="Close" />
          </button>
        </buttons>
      </editform>
      <fields>
        <field name="TYPE_ID" key="false" datatype="Int64" sort="default">
          <column show="false" caption="Тип події" align="right" />
          <form show="true" rwmode="ROI" required="true" >
            <uicontrol type="DropDownList" table="grt_event_types" keyfield="event_id" valuefield="event_name" />
          </form>
        </field>
        <field name="EVENT_NAME" key="false" datatype="String" sort="default">
          <column show="true" caption="Подія" align="left" />
          <form show="false" rwmode="RW" required="true" titleindex="0">
            <uicontrol type="Text" readonly="true" />
          </form>
        </field>
        <field name="EVENT_DESCR" key="false" datatype="String" sort="default">
          <column show="false" caption="Опис події" align="left" />
          <form show="false" rwmode="RW" required="true">
            <uicontrol type="Text" />
          </form>
        </field>
        <field name="PLANNED_DATE" key="false" datatype="DateTime" sort="Asc">
          <column show="true" caption="Планова дата" align="center" />
          <form show="true" rwmode="ROI" required="true" titleindex="1" >
            <uicontrol type="DateInput"  />
          </form>
        </field>
        <field name="ACTUAL_DATE" key="false" datatype="DateTime" sort="default">
          <column show="true" caption="Фактична дата" align="center" />
          <form show="true" rwmode="RW">
            <uicontrol type="DateInput" />
          </form>
        </field>
        <field name="COMMENT_TEXT" key="false" datatype="String" sort="default">
          <column show="true" caption="Коментар користувача" align="left" />
          <form show="true" rwmode="RW">
            <uicontrol type="Text" controlwidth="250"  linescount="10"/>
          </form>
        </field>
        <field name="ID" key="true" datatype="Int64" sort="default">
          <column show="false" caption="Код події" align="right" />
          <form show="true" rwmode="RO" required="false">
            <uicontrol type="Text" readonly="true" />
          </form>
        </field>
        <field name="DEAL_ID" key="false" datatype="Int64" sort="default">
          <column show="false" caption="Код договору забезпечення" align="right" />
          <form show="true" rwmode="RO" required="false">
            <uicontrol type="Text">
              <defaultvalue type="QueryString" value="deal_id"/>
            </uicontrol>
          </form>
        </field>
      </fields>
    </grid>
  </grids>
</xmlform>
