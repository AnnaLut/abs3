<?xml version="1.0" encoding="utf-8" ?>
<xmlform caption="Формування проводок по перекреттю" >
  <customforms>
    <customform name="frm_zay_p_tt" buttonsposition="Bottom" title="" columnscount="1">
      <buttons defaulttype="Button">
        <button caption="Виконати проводки" hint="Виконати проводки" confirmmessage="Сформувати проводки?" id="btnSave">
          <command type="PlSqlBlock" successmessage="Проводки сформовано успішно." successurl="/barsroot/barsweb/dynform.aspx?form=frm_zay_p">
            <sql>
              declare
              l_sTT1 varchar2(3);
              l_sTT2 varchar2(3);
              l_nVob number;
              l_ref oper.ref%type;
              l_bd date;
              begin
              SELECT t.tt INTO l_sTT1 FROM birja b, tts t WHERE substr(b.val,1,3) = t.tt AND b.par = 'TT_PS1';
              SELECT t.tt INTO l_sTT2 FROM birja b, tts t WHERE substr(b.val,1,3) = t.tt AND b.par = 'TT_PS2';
              gl.ref(l_ref);
              l_bd := gl.bd;
              if (f_ourmfo = :p_mfov) then
              SELECT nvl(min(vob),6) INTO l_nVob FROM tts_vob WHERE tt = l_sTT1;
              gl.in_doc3 (ref_   => l_ref,
              tt_    => l_sTT1,
              dk_    => 1,
              vob_   => l_nVob,
              nd_    => substr(l_ref,1,10),
              pdat_  => sysdate,
              data_  => l_bd,
              vdat_  => l_bd,
              datp_  => l_bd,
              mfoa_  => :p_mfov,
              nlsa_  => :p_nls,
              nam_a_ => :p_nmk,
              id_a_  => :p_okpo,
              kv_    => :p_kv,
              s_     => :p_ostc*100,
              mfob_  => :p_mfov,
              nlsb_  => :p_nlsv,
              nam_b_ => :p_nmk,
              id_b_  => :p_okpo,
              kv2_   => :p_kv,
              s2_    => :p_ostc*100,
              nazn_  => :p_nazn,
              uid_   => user_id,
              d_rec_ => null,
              sk_    => null,
              id_o_  => null,
              sign_  => null,
              sos_   => 0,
              prty_  => null);
              paytt (0, l_ref, l_bd, l_sTT1, 1, :p_kv, :p_nls, :p_ostc, :p_kv, :p_nlsv, :p_ostc);
              else
              SELECT nvl(min(vob),1) INTO l_nVob FROM tts_vob WHERE tt = l_sTT2;
              gl.in_doc3 (ref_   => l_ref,
              tt_    => l_sTT2,
              dk_    => 1,
              vob_   => l_nVob,
              nd_    => substr(l_ref,1,10),
              pdat_  => sysdate,
              data_  => l_bd,
              vdat_  => l_bd,
              datp_  => l_bd,
              mfoa_  => :p_mfov,
              nlsa_  => :p_nls,
              nam_a_ => :p_nmk,
              id_a_  => :p_okpo,
              kv_    => :p_kv,
              s_     => :p_ostc*100,
              mfob_  => :p_mfov,
              nlsb_  => :p_nlsv,
              nam_b_ => :p_nmk,
              id_b_  => :p_okpo,
              kv2_   => :p_kv,
              s2_    => :p_ostc*100,
              nazn_  => :p_nazn,
              uid_   => user_id,
              d_rec_ => null,
              sk_    => null,
              id_o_  => null,
              sign_  => null,
              sos_   => 0,
              prty_  => null);
              paytt (0, l_ref, l_bd, l_sTT1, 1, :p_kv, :p_nls, :p_ostc, :p_kv, :p_nlsv, :p_ostc);
              end if;
              end;
            </sql>
            <parameters>
              <parameter type="FormField" name="P_MFOV"/>
              <parameter type="FormField" name="P_NMK"/>
              <parameter type="FormField" name="P_OKPO"/>
              <parameter type="FormField" name="P_NLSV"/>
              <parameter type="FormField" name="P_NLS"/>
              <parameter type="FormField" name="P_KV"/>
              <parameter type="FormField" name="P_OSTC"/>
              <parameter type="FormField" name="P_NAZN"/>
            </parameters>
          </command>
        </button>
        <button caption="Відміна" hint="Відміна" id="btnBack">
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_zay_p" target="Self">
          </command>
        </button>
      </buttons>
      <datasource>
        <sql>
          select rnk, nmk, okpo, mfov, nlsv, nls, kv, ostc  from v_zayp where rnk = :rnk and mfov = :mfov and nlsv = :nlsv and nls = :nls and kv = :kv
        </sql>
        <parameters>
          <parameter  type="QueryString" name="rnk" altname="rnk"/>
          <parameter  type="QueryString" name="mfov" altname="mfov"/>
          <parameter  type="QueryString" name="nlsv" altname="nlsv"/>
          <parameter  type="QueryString" name="nls" altname="nls"/>
          <parameter  type="QueryString" name="kv" altname="kv"/>
        </parameters>
      </datasource>
      <customfields>
        <customfield name="P_RNK" label="РНК клієнта" required="false" datatype="Int64" datasourcefield="RNK" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_NMK" label="Назва клієнта" required="false" datatype="String" datasourcefield="NMK" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_OKPO" label="Назва клієнта" required="false" datatype="String" datasourcefield="OKPO" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_MFOV" label="МФО" required="false" datatype="String" datasourcefield="MFOV" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_NLSV" label="Розрахунковий рахунок" required="false" datatype="String" datasourcefield="NLSV" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_NLS" label="Торговий рахунок" required="false" datatype="String" datasourcefield="NLS" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_KV" label="Валюта" required="false" datatype="String" datasourcefield="KV" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="true" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_OSTC" label="Сума перекриття" required="true" datatype="Decimal" datasourcefield="OSTC" columnindex="1" index="1">
          <uicontrol type="IntegerInput" readonly="false" controlwidth="150" align="Right"/>
        </customfield>
        <customfield name="P_NAZN" label="Призначення платежу" required="true" datatype="String" columnindex="1" index="1">
          <uicontrol type="TextBox" readonly="false" controlwidth="400" align="Right" linescount="5">
            <defaultvalue type="Constant" value="Повернення коштів, надлишково перерахованих для купівлі іноземної валюти"/>
          </uicontrol> 
        </customfield>
      </customfields>
    </customform>
  </customforms>
</xmlform>
