<?xml version="1.0" encoding="utf-8"?>
<xmlform caption="Розрахунок фінансового стану юридичних осіб"  captiontype="OnlyTitle" version="1.0.0">
  <grids>
    <grid id="id1" title="Розрахунок фінансового стану юридичних осіб(Постанова НБУ №351)"  showpagesizebox="true" pagesize="15"  >
            
          <!--Фільтри-->
      <filters buttontext="Пошук" columnscount="4" caption="Пошук клієнтів">
        <filter id="fId1" caption="РНК"           field="RNK"  condition="Equal"    columnindex="1"></filter>
        <filter id="fId2" caption="OKПO"          field="OKPO" condition="Equal"    columnindex="2"></filter>
        <filter id="fId3" caption="Назва клієнта" field="NMK"  condition="LikeBoth" columnindex="3"></filter>
        <filter id="fId4" caption="Наявність договорів" field="KOL"   condition="Equal"  columnindex="4">
          <uicontrol type="DropDownList" table="(select '0' as val, 'Без договорів' as name from dual union all select '1' as val , 'З договорами' as name  from dual)"
                          keyfield="val" valuefield="name"  addemptyitem="true">
            <defaultvalue type="Constant" value="1"/>
          </uicontrol>
        </filter>
      </filters>

      <datasource>
        <!-- Запрос на відображення клієнтів по доступу до рахунків-->
        <sql>
          <!--Select /*+ RESULT_CACHE ORDERED*/ 2 as n, c.rnk, c.rnkp as isp, c.okpo, c.nmk, cc.ruk, null name, datea,
          null f0, f1.fdat as f1, f2.fdat as f2, null f3, null f4, nvl(kol,0) kol, substr(c.branch,2,6) kf, b.name nameb
          from (select * from fin_customer where custtype = 2 and DATE_OFF is null) c
          left join corps cc on c.rnk = cc.rnk
          left join (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=1 group by OKPO) f1 on c.okpo = f1.okpo
          left join (select OKPO, max(FDAT) FDAT from FIN_RNK where IDF=2 group by OKPO) f2 on c.okpo = f2.okpo
          left join (select rnk, sign(count(1)) kol from cc_deal where 15 > sos and 4 >vidd and branch like  sys_context('bars_context','user_branch')||'%' group by rnk) v on c.rnk = v.rnk
          left join customerw w on w.rnk = c.rnk and w.tag = 'BUSSL'
          left join CUST_BUSINESS_LINE b on w.value = to_char(b.id)
          order by sign(rnk), 5-->
          Select  /*+ RESULT_CACHE */ 2 as n, c.rnk, c.rnkp as isp, c.okpo, c.nmk, cc.ruk, null name, datea,
          null f0, fm.fdat as f1, fm.fdat as f2, null f3, null f4, nvl(kol,0) kol, substr(c.branch,2,6) kf, decode(w.value,'1','ДКБ','2','ММСБ', null)  nameb
          from (select * from fin_customer where custtype = 2 and DATE_OFF is null) c
          left join corps cc on c.rnk = cc.rnk
          left join (select okpo, max(fdat) fdat from fin_fm group by okpo ) fm on to_number(c.okpo) = fm.okpo
          left join (select rnk, sign(count(1)) kol from cc_deal where 15 > sos and 4 >vidd and branch like  sys_context('bars_context','user_branch')||'%' group by rnk) v on c.rnk = v.rnk
          left join customerw w on w.rnk = c.rnk and w.tag = 'BUSSL'
          --left join CUST_BUSINESS_LINE b on b.id = decode(w.value,'1',1,'2',2, 0)
          order by sign(rnk), 5
        </sql> 
      </datasource>

      <rowselection method ="SingleRow"/>

      <buttons>
        <button id="Bt1" type="Image" imagename="id_cards" hint="Карточка фінстану"  >
          <command type="Redirect" url="/barsroot/barsweb/dynform.aspx?form=frm_fin2_kart_kl" >
            <parameters>
              <parameter name="RNK" altname="rnk" datatype="Int64" type="DataField"></parameter>
            </parameters>  
          </command>
        </button>
        <button  id="instest" type="Image" hint="Створити тестового позичальника" imagename="document_add">
          <command type="PlSqlBlock" successurl="/barsroot/barsweb/dynform.aspx?form=frm_fin2_cust" checkselectedrow="true">
            <sql>
              declare
              aOKPO varchar2(8)   :=  :OKPO_;
              aNMK   varchar2(38) :=  :NMK_;
              aVED    varchar2(5)  := :VED_;
              k_ varchar2(30);
              begin

              begin
              select ved
              into k_
              from ved
              where ved= aVED and (d_close is null or d_close > sysdate);
              exception when NO_DATA_FOUND THEN
              raise_application_error(-(20000),'\ ' ||'     Не вірно вказано вид економічної діяльності',TRUE);
              end;

              if nvl(length(replace(TRANSLATE(aOKPO,'1234567890','0'),'0','')),0) > 0 then
              raise_application_error(-(20000),'\ ' ||'    Не вірно введений код ОКПО - "'||aOKPO ||'"',TRUE);
              end if;

              begin
              insert into fin_cust (okpo, nmk, ved, datea)
              values (aOKPO, aNMK, aVED, :DATEA_ );
              exception when others then
              if (sqlcode = -00001) then
              raise_application_error(-(20000),'\ ' ||'    Тестовий позичальник з кодом ОКПО '||aOKPO ||' вже створений',TRUE);
              end if;
              end;
              end;
            </sql>
            <customfields oktext="Ok" canceltext="Cancel" columnscount="1">
              <customfield datatype="String" name="OKPO_" required="true" size="8"  label="ОКПО"></customfield>
              <customfield datatype="String" name="NMK_"  required="true" size="38" label="Назва клієнта"></customfield>
              <customfield datatype="DateTime" name="DATEA_"  required="true" size="38" label="Дата реестрації підприемства"></customfield>
              <customfield datatype="String" name="VED_" required="true"  size="5"  label="КВЕД">
                <uicontrol type="DropDownList" table="(select ved, ved||' - '||name as name from ved where d_close is null or  d_close > sysdate order by ved asc)" keyfield="ved" valuefield="name"></uicontrol>
              </customfield>
            </customfields>
          </command>
        </button>
        <button id="BtDel" type="Image" imagename="delete2" hint="Видалити тестового позичальника" confirmmessage="Видалити тестового позичальника" >
          <command type="PlSqlBlock">
            <sql>
              begin
              delete fin_cust where okpo = :OKPO;
              end;
            </sql>
            <parameters>
              <parameter type="DataField" name="OKPO" ></parameter>
            </parameters>
          </command>
        </button>
        
      </buttons>
   
      
      
     <!--Опис колонок-->
      
      <fields>
        <field name="RNK" datatype="Int64" key="true" >
          <column caption="РНК"  show="true" width="70" >
                     </column>
          <layout >
            <colors scope="EntireRow">
              <color color="clPlum" operation="Less" value="0" columnindex="2" bold="true"/>
            </colors>
          </layout>
          
        </field>

        <field name="OKPO" datatype="String" key="true"  >
          <column caption="ОКПО"  show="true"  width="70" />
        </field>
        
        <field name="NMK" datatype="String" key="false" >
          <column caption="Назва клієнта"  show="true" width="300"  />
        </field>

        <field name="RUK" datatype="String" key="false" >
          <column caption="Керівник"  show="true"  />
        </field>

        <field name="name" datatype="String" key="false" size="55" >
          <column caption="Клас"  show="false" width="55" />
        </field>

        <!--<field name="NAME" datatype="String" key="false" >
          <column caption="Фін.стан з БД"  show="true" />
        </field>-->

        <field name="DATEA" datatype="DateTime" key="false" >
          <column caption="Дата реестрації підприемства"  show="true"  width="35"/>
        </field>

        <field name="F0" datatype="DateTime" key="false" >
          <column caption="Форма №0"  show="false" />
        </field>

        <field name="F1" datatype="DateTime" key="false" >
          <column caption="Форма №1"  show="true" />
        </field>

        <field name="F2" datatype="DateTime" key="false" >
          <column caption="Форма №2"  show="true" />
        </field>

        <field name="F3" datatype="DateTime" key="false" >
          <column caption="Форма №3"  show="false" />
        </field>

        <field name="F4" datatype="DateTime" key="false" >
          <column caption="Форма №4"  show="false" />
        </field>

        <field name="KOL" datatype="String" key="false" >
          <column caption="KOL"  show="false" />
        </field>

        <field name="NAMEB" datatype="String" key="false" >
          <column caption="Бізнес-напрямок"  show="true" />
        </field>

        <field name="KF" datatype="String" key="false" >
          <column caption="МФО"  show="true" />
        </field>

      </fields>
      
      
    </grid>
    
  </grids>
</xmlform>
