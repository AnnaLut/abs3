@using Kendo.Mvc.UI
@using BarsWeb.Areas.Bills.Model
@{
    Layout = "~/Views/Shared/_LayoutKendo.cshtml";
    @* View для отображения выдержек по рещениям! *@
}
<link href="~/Areas/Bills/Css/FontsAndGridStyle.css" rel="stylesheet" />
<script>
    base_url = '/barsroot/bills/bills/DownloadReport/';
    function onExpandRow(e) {
        this.collapseRow(this.tbody.find(' > tr.k-master-row').not(e.masterRow));
    }

    function downloadReport(type) {        
        var ext_id = Ext_id();
        if (ext_id === -1)
            return;
        var url = base_url + ext_id + '?reportType=' + type;
        var win = window.open(url, '_blank');
        win.focus();
    }

    function Ext_id() {
        var grid = $('#extracts').data('kendoGrid');
        var selected = grid.select();
        if (selected.length == 0) {
            bars.ui.alert({
                text: 'Жодної строки не було вибрано',
                title: 'Увага!'
            });
            return -1;
        }
        return selected[0].childNodes[1].innerHTML;
    }    
</script>

<div class="page-header" style="margin: 10px 0 10px !important;">
    <h2 id="title">Реєстр витягів</h2>
</div>

<div id="extractsBody">
    @(Html.Kendo().Grid<Extract>()
        .Name("extracts")
        .Columns(col =>
        {
            col.Bound(x => x.Extract_number_id).Title("Номер витягу");            
            col.Bound(x => x.EXTRACT_DATE).Format("{0:dd.MM.yyyy}").Title("Дата формування витягу").HeaderHtmlAttributes(new { style = "white-space: normal" }).HtmlAttributes(new { style = "text-align: center" }).Width(200);
        })
        .Filterable()
        .ColumnMenu(x => x.Columns(false))
        .Resizable(x => x.Columns(true))
        .Reorderable(x => x.Columns(true))
        .Sortable()
        .Scrollable()
        .Selectable()
        .Pageable(page => page
                 .Refresh(true)
                 .PageSizes(new List<Int32> { 5, 10, 20, 50 })
                 .ButtonCount(10))
        .Events(x => x.DetailExpand("onExpandRow"))
        .HtmlAttributes(new { style = "min-height: 50px; height: 100%;" })
        .ToolBar(x =>
        {
        x.Template(@<text>
    <div class="col-xs-12 text-left">
        <button class="k-button" title="Завантаження реєстру виплат за рішеннями судів" onclick="downloadReport('registerpayments'); return false; this.blur();">
            <span class="k-icon k-i-pdf"></span>
        </button>
        <button class="k-button" title="Інформація про строки та обсяги сплати за фінансовими казначейськими векселями" onclick="downloadReport('paymentinfo'); return false; this.blur();">
            <span class="k-icon k-i-pdf"></span>
        </button>
        <button class="k-button" title="Звіт про кількість виданих фінансових казначейських векселів" onclick="downloadReport('billscount'); return false; this.blur();">
            <span class="k-icon k-i-pdf"></span>
        </button>
        <button class="k-button" title="АКТ приймання–передачі наданих послуг з виконання функцій генерального агента" onclick="downloadReport('agentact'); return false; this.blur();">
            <span class="k-icon k-i-pdf"></span>
        </button>
    </div>
            </text>);
        })
        .DataSource(x => x.Ajax()
            .Read(read => read.Action("Extracts_Read", "Bills"))
        )
        .ClientDetailTemplateId("list"))
</div>

<script id="list" type="text/kendo-tmpl">
    @(Html.Kendo().Grid<CA_Receivers>()
         .Name("receivers#=Extract_number_id#")
         .HtmlAttributes(new { style = "width: 100%;" })
         .Sortable()
         .Columns(col =>
         {
             col.Bound(x => x.EXP_ID).Hidden(true);
             col.Bound(x => x.STATUS).Hidden(true);
             col.Bound(x => x.NAME).Title("ПІБ/Найменування").HeaderHtmlAttributes(new { style = "white-space: normal" });
             col.Bound(x => x.AMOUNT).Title("Сума для отримання в грн").Format("{0:n2}").HeaderHtmlAttributes(new { style = "white-space: normal" }).HtmlAttributes(new { style = "text-align: right" });
             col.Bound(x => x.DOC_NO).Title("Номер документу").HeaderHtmlAttributes(new { style = "white-space: normal" });
             col.Bound(x => x.BRANCH).Title("Відділення, яке проводить роботу з отримувачем").HeaderHtmlAttributes(new { style = "white-space: normal" });
             col.Bound(x => x.EXT_STATUS).Hidden(true);
             col.Bound(x => x.EXT_STATUS_NAME).Title("Статус");
         })
         .Filterable()
         .ColumnMenu(x => x.Columns(false))
         .Resizable(x => x.Columns(true))
         .Reorderable(x => x.Columns(true))
         .Scrollable()
         .Events(x => x.DetailExpand("onExpandRow"))
         .Sortable()
         .Pageable(page => page
             .Refresh(true)
             .PageSizes(new List<Int32> { 5, 10, 20, 50 })
             .ButtonCount(10))
         .DataSource(dataSource => dataSource
             .Ajax()
             .Model(model => model.Id(x => x.EXP_ID))
             .Read(read => read.Action("CA_Extract_Receivers_read", "Bills", new { id = "#=Extract_number_id#" }))
             .PageSize(10)
         )
         .ClientDetailTemplateId("bills")
         .ToClientTemplate()
    )
</script>

<script id="bills" type="text/kendo-tmpl">  
@(Html.Kendo().Grid<BillsModel>()
     .Name("bills#=EXP_ID#")
     .HtmlAttributes(new { style = "width: 100%;" })
     .Sortable()
     .Columns(col =>
     {
         col.Bound(x => x.EXP_ID).Hidden(true);
         col.Bound(x => x.STATUS).Hidden(true);
         col.Bound(x => x.AMOUNT).Title("Сума векселю").Format("{0:n2}").HeaderHtmlAttributes(new { style = "white-space: normal" }).HtmlAttributes(new { style = "text-align: right" });
         col.Bound(x => x.STATUS_NAME).Title("Поточний статус").HeaderHtmlAttributes(new { style = "white-space: normal" });
         col.Bound(x => x.BILL_NO).Title("Серія та номер векселя").HeaderHtmlAttributes(new { style = "white-space: normal" });
         col.Bound(x => x.DT_ISSUE).Format("{0:dd.MM.yyyy}").Title("Дата випуску векселя").HeaderHtmlAttributes(new { style = "white-space: normal" }).HtmlAttributes(new { style = "text-align: center" });
         //col.Bound(x => x.HANDOUT_DATE).Format("{0:dd.MM.yyyy}").Title("Дата видачі векселю").HeaderHtmlAttributes(new { style = "white-space: normal" }).HtmlAttributes(new { style = "text-align: center" });
     })
     .Filterable()
     .Selectable()
     .Scrollable()
     .Pageable(page => page
         .Refresh(true)
         .PageSizes(new List<Int32> { 5, 10, 20, 50 })
         .ButtonCount(10))
     .DataSource(dataSource => dataSource
         .Ajax()
         .Model(model => model.Id(x => x.EXP_ID))
         .Read(read => read.Action("GetBillsByExpID", "Bills", new { id = "#=EXP_ID#" }))
         .PageSize(10)
     )
     .ToClientTemplate()
)
</script>
