@inherits System.Web.Mvc.WebViewPage
@using System.Web.Mvc.Html
@{
    if (Convert.ToBoolean(ViewBag.IsPartinal))
    {
        Layout = null;
    }
    ViewBag.Title = "Перегляд документів " + ViewBag.Type;
}
    <link href="/common/themes/modernui/css/jungGridView.css" type="text/css" rel="stylesheet" />
    <script src="/Common/jquery/jquery.maskedinput-1.3.1.js" type="text/javascript"></script>
    <script src="/common/jquery/jungGridView.js?v" type="text/javascript"></script>

<style>
    /*.inpDate
    {
        width:80px;text-align:center;
    }
    input
    {
        padding:2px 0 2px 0;
    }*/

    .mainFilter div
    {
        float:left; 
        margin:0 10px 0 0;
    }
    #viewSelDocum,#addFilterDialog
    {
        padding:5px 0 0 0;
    }

</style>

<script type="text/javascript">
    var obj = new Object; obj.SYS = null; obj.USER = null; obj.STR = ''; obj.TABLE = '';
    var dateStart = '';//начальная дата
    var dateEnd = '';//конечная дата
    var rowNumber = '10';// количество строк в таблице
    var typeDocumUserTobo = '@ViewBag.Id' ;
    var typeDocumAllIn = '1';
    var sort = 'REF';
    var sortDir = 'DESC';
    var filterSysId = null;
    var filterUserId = null;
    var filterStr='';
    

    $(document).ready(function () {
        $('#table').jungGridView({
            updateTableUrl: '/barsroot/Documents/DocumentsLoad/' + typeDocumUserTobo,
            userUpdateParamFunc: updateParam,
            buttonToUpdateId: 'btSubmitFilter',
            viewTfoot: true
        });
        //$('#btSubmitFilter').jungGridView('button', { updateTableUrl: '/barsroot/Documents/DocumentsLoad/' + typeDocumUserTobo, userUpdateParamFunc: updateParam });
        
        $('#filterDateStart, #filterDateEnd').datepicker({
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            firstDay: 1,
            dateFormat: 'dd/mm/yy',
            onClose: function (selectedDate) {
                //var text = $(this).val();
                //var patt = /^(0?[1-9]|[12][0-9]|3[01])[\/](0?[1-9]|1[012])[\/]\d{4}$/i;
                //if (!patt.test(text)) {
                    //$(this).addClass('error');
                //}
                //else {}
                try {
                    $(this).removeClass('error');
                    var dates = $('#filterDateStart, #filterDateEnd');
                    var option = this.id == 'filterDateStart' ? 'minDate' : 'maxDate',
                    instance = $(this).data('datepicker'),
                    date = $.datepicker.parseDate(
                    instance.settings.dateFormat ||
                    $.datepicker._defaults.dateFormat,
                    selectedDate, instance.settings);
                    dates.not(this).datepicker("option", option, date);
                }
                catch (e) { var t = e; $(this).addClass('error'); }
            }
        }).mask('99/99/9999');

        //$('input:submit, input:button, button').button();

    });

    function updateParam(type, pageNum) {
        if (window.filterObject !== undefined) {
            obj = filterObject;
        }
        $('#setDocumTable').removeClass('visibilityNone');
        if (type == 'start') {
            dateStart = $('#filterDateStart').val();
            dateEnd = $('#filterDateEnd').val();
            typeDocumAllIn = $('input[name=tipeDocumSeach]:checked').val();
            pageNum = 1;
            sort = 'REF';
            sortDir = 'DESC';
            if (window.filterObject !== undefined) {
                obj = filterObject;
            }
        }
        var param = {
            dStart: dateStart,
            dEnd: dateEnd,
            pageNum: pageNum,
            pageSize: $('#rowNumber').val() == undefined ? 10 : $('#rowNumber').val(),
            typeDocumInOut: typeDocumAllIn,
            sort: sort,
            sortDir: sortDir,
            filterSysId: obj.SYS ,
            filterUserId: obj.USER ,
            filterStr: obj.STR,
            filterTable:obj.TABLE
        };
        return param;
    }
    
    function viewSelDocum(ref) {
        $('#mainDocument').loader();
        $('#childDocumentContent')
            .load('/barsroot/documents/document/?id=' + ref, {},
                function () {
                    $('#mainDocument').hide().loader('remove');
                    $('#childDocument').show();
                }
            );

        /*
        $('#mainContent').hide();
        $('#child-docum').show();
        $('#child-docum-content')
            .load('/barsroot/documents/document/?id=' + ref, {},
                function () {
                    removeLoader($('#child-docum'));
            });
                          //.dialog({ autoOpen: true, position: 'center', title: 'Перегляд документа', modal: true, resizable: false, width: '600', minHeight: '500', close: function () { $(this).html(''); } });
        addLoader($('#child-docum'));*/
    }

    function viewSelDocum2(ref) {
        $('#viewSelDocum').load('/barsroot/documents/document/?id='+ref,{},function(){removeLoader($('#viewSelDocum'));})
                          .dialog({ autoOpen: true, position: 'center', title: 'Перегляд документа', modal: true, resizable: false, width: '600', minHeight: '500', close: function () { $(this).html('');} });
        addLoader($('#viewSelDocum'));
    }

    function addFilter() {
        if ($('#addFilterDialog').html() == '') {
            $('#addFilterDialog').load('/barsroot/Webservices/filter/', { table: 'oper' }, function () { removeLoader($('#addFilterDialog')); $('#addFilterDialog input[name="btSelFilter"]').click(function () { btSelFilterClick(); }); })
                                 .dialog({
                                     autoOpen: true,modal: true, resizable: false, 
                                     position: 'center', 
                                     title: 'Встановлення додаткового фільтру', 
                                     width: '600', height: '500',
                                     close: function () { /*$(this).html('');*/ },
                                     buttons: [{ text: 'Застосувати', click: function () { btSelFilterClick(); }, name: 'btSelFilter' }],
                                     open: function () { }                                 
                                 });
            addLoader($('#addFilterDialog'));
        }
        else {
            $('#addFilterDialog').dialog('open'/*{ 
                                        autoOpen: true,modal: true, resizable: false,
                                        position: 'center',
                                        title: 'Встановлення додаткового фільтру',
                                        width: '600', height: '500', 
                                        close: function () { /*$(this).html('');* / },
                                        //buttons: [{ text: 'Застосувати', click: function () { btSelFilterClick(); }, name: 'btSelFilter' }],
                                        open: function () { }                                       
                                    }*/ );
        }
    }

    function btSelFilterClick() {
        var res = CheckFilter();
        if (res) {
            filterSysId = $('table#sysFilter tbody input:checkbox:checked').first().val();
            var sf = ''; var uf = ''; var str = '';
            if (filterSysId == undefined) {
                filterSysId = null; sf = '';
            } else {
                var t = $('table#sysFilter tbody input:checkbox:checked').parent().parent().find('td[data-name="name"]').html();
                sf += '<fieldset class="filter"><legend>Системний</legend><span class="ico-cancel" onclick="removeFilter(this,\'s\');"></span>' + t + '</fieldset>';
            }
            filterUserId = $('table#userFilter tbody input:checkbox:checked').first().val();
            if (filterUserId == undefined) {
                filterUserId = null; uf = '';
            } else {
                var et = $('table#userFilter tbody input:checkbox:checked').parent().parent().find('td[data-name="name"]').html();
                uf += '<fieldset class="filter"><legend>Фільтр користувача</legend><span class="ico-cancel" onclick="removeFilter(this,\'u\');"></span>' + et + '</fieldset>';
            }
            if ($('#filterString tbody tr').length > 0) {
                var rows = $('#filterString tbody tr');
                var strhtml = '';
                rows.each(function (i, e) {
                    strhtml += $(e).find('td select option:selected').eq(0).html() + ' ';
                    strhtml += $(e).find('td select option:selected').eq(1).html() + ' ';
                    strhtml += $(e).find('td select option:selected').eq(2).html() + ' ';
                    strhtml += $(e).find('td input[type="text"]').val() + ' ';
                });
                str += '<fieldset class="filter"><legend>Додатковий фільтр</legend><span class="ico-cancel" onclick="removeFilter(this,\'str\');"></span>' + strhtml + '</fieldset>';
            }

            if (sf + uf + str == '')
                $('#fieldsetNewFilter .filterContent').html('<span class="dim">Додатковий фільтр не встановлено</span>');
            else
                $('#fieldsetNewFilter div.filterContent').html(sf + uf + str);
        }
        var test = GetCustFilter();
        updateFilterObjrct(function () { $('#btSubmitFilter').click(); });
    }

    function removeFilter(elem,filt) {
        $(elem).parent().remove();
        if ($('#fieldsetNewFilter .filterContent').html() == '') {
            $('#fieldsetNewFilter .filterContent').html('<span class="dim">Додатковий фільтр не встановлено</span>');
        }
        if (filt == 's') {
            $('table#sysFilter tbody tr td input:checkbox').removeAttr('checked');
            $('table#sysFilter tbody tr td div.checkbox').removeClass('checked');
            filterSysId = null;
        }
        if (filt == 'u') {
            $('table#userFilter tbody tr td input:checkbox').removeAttr('checked');
            $('table#userFilter tbody tr td div.checkbox').removeClass('checked');
            filterUserId = null;
        }

        if (filt == 'str') {
            delAllRow();
        }

        updateFilterObjrct();
        $('#btSubmitFilter').click();
    }

    function printSelectDocum() {
        //addLoader($('#table'));
        var arrayElem = $('#table table tbody input:checkbox:checked').clone();
        if (arrayElem.length > 0) {
            var form = $('<form/>');
            form.attr({ 'action': '/barsroot/Documents/GetFileForPrint/', 'method': 'post', 'style': 'display:none' });
            form.html(arrayElem.slice(0,20));
            $('body').append(form);
            form.submit();
            form.remove();
        }
    }

    function exportToExel() {
        //addLoader($('#table'));
        var arrayElem = $('#table table tr').clone();
        var newTable = $('<table/>');
        newTable.attr('name', 'table');
        newTable.append(arrayElem);
        var form = $('<form/>');
        form.attr({ 'action': '/barsroot/Documents/ExportToExcel/', 'method': 'post', 'style': 'display:none' });
        form.html(newTable);
        $('body').append(form);
        form.submit();
        form.remove();
    }

</script>

<h1>Перегляд документів  @ViewBag.Type</h1>
@*<h2 style="margin-left:10px;"><span class="ico-filter16"></span>Основний фільтр</h2>*@
<div>              
    @*<div id="MainContent_pnFilter">*@
    <style>
        .speedSeach table {
        border-collapse:collapse;

        }
        .speedSeach table tr{
            padding:0px ;
            /*background-color:#808080;*/
            /*color:#fff*/
        }
        .speedSeach table tr td {
            padding:0px ;
            border:1px solid #808080;
        }
        .speedSeach table select {
            /*border: 0px none;
            padding: 3px 12px 5px 12px;
            color: #fff;*/
            font-size: 13px;

        }
        .speedSeach table input{
            padding:2px 4px;
        }
        div.select {
            height: 20px;
            overflow: hidden;
        }
        div.select select {
            font-weight:600;
            /*font-size:14px;*/
            height:24px;
            margin:-2px -2px -2px -2px;
            /*background-color:#2771ea;*/
            padding: 5px;
            border: 0px solid #ccc;
            padding: 3px 12px 5px 12px;
        }
    </style>@*
    <div class="speedSeach" style="margin-top:20px;">
        <table>
            <tr>
                <td style="padding-left:10px;padding-right:10px;background-color:#808080;color:#fff; ">
                    Швидкий пошук
                </td>
                <td style="/*background-color:#2771ea;*/padding-left:10px;padding-right:10px;border-right:1px solid #808080">
                    <div class="select">
                        <select>
                            <option>Референс</option>
                            <option>Дата</option>
                        </select>
                    </div>
                </td>
                <td style="/*background-color:#2771ea;*/padding-left:10px;padding-right:10px;">
                    <div class="select">
                        <select>
                            <option>=</option>
                            <option><</option>
                            <option>></option>
                            <option>like</option>
                            <option>=</option>
                            <option><</option>
                        </select>
                    </div>
                </td>
                <td><input type="text" /></td>
                <td><button class="green" onclick="alert('test');">Пошук</button></td>
            </tr>
        </table>
        <div class="dim" style="font-size:12px;">
            При використанні швидкого пошуку додатковий фільтр не враховується
        </div>
    </div>*@
		<fieldset style="margin:15px;border:0px solid red;">
			<legend>
				<span class="ico-filter16"></span>Основний фільтр
			</legend>
            <div style="margin:5px 10px 10px 20px" class="mainFilter" id="mainFilter">
                <div >
                    @*<span style="display:inline-block;">Період </span>*@
                    <span style="display:inline-block;margin-right:0px;">Період з:<br/>
                        <input onkeydown="" class="date" id="filterDateStart" type="text" value="@DateTime.Now.ToShortDateString()"/>
                    </span>
                    <span style="display:inline-block;margin-right:0px;">по:<br/>
                        <input onkeydown="" class="date" id="filterDateEnd" type="text" value="@DateTime.Now.ToShortDateString()"/>
                    </span> 
                </div>
                <div style="margin-top:10px;">
                    <span style="word-wrap:normal;white-space: nowrap;">
                        <input checked="checked" name="tipeDocumSeach" id="RadioAllDoc" value="1" type="radio" />
                        <label for="RadioAllDoc">всі документи</label>
                    </span>
                    <br/>
                    <span style="word-wrap:normal;white-space: nowrap;">
                        <input name="tipeDocumSeach" id="RadioInDoc" value="2" type="radio" />
                        <label for="RadioInDoc">отримані документи</label>
                    </span>
                </div>
            </div> 
		</fieldset>
	@*</div>*@
    <fieldset id="fieldsetNewFilter" style="margin:15px;border:0px solid red;">
        <legend class="txtBtn" onclick="addFilter();">
            <span class="ico-filter16"></span>Додатковий фільтр
        </legend>
        <div class="filterContent" style="margin:5px 10px 10px 20px">
            <span class="dim">Додатковий фільтр не встановлено</span>
        </div>
        <div id="addFilterDialog" class="dialog" style="display:none;"></div>
    </fieldset>

    <div style="margin:5px 0 0 0px;">
         <input id="btSubmitFilter" value="Переглянути" type="button" class="green" style="margin:0px 0 0 0;" />
    </div>

    <div style="margin:10px 0 0 0px;">
        @*{var myTable = new barsroot.HtmlHelpers();}*@
        <div class="visibilityNone" id="setDocumTable" >
            <div id="viewSelDocum" class="dialog" style="display:none;"></div>
            @barsroot.HtmlHelpers.CreateTable(capTableBtn:new string[,]{/*{"rfr",""},{"xls","exportToExel();"},{"prn","printSelectDocum();"}*/},
                                columnName: new string[,]{/*{"checkbox",""},*/{"",""},{"Реф","REF"}, {"Вик","USERID"},{"№ док","ND"},{"Рах-А","NLSA"},{"Сума","S_"},{"Вал","LCV"},{"Дата вал.","VDAT"},{"Сума(вал В)","S2_"},{"Вал(В)","LCV2"},{"МФО(В)","MFOB"},{"Рах-В","NLSB"},{"Д/К","DK"},{"СКП","SK"},{"Дата док.","DATD"},{"Призначення платежу","NAZN"},{"ОП","SOS"},{"Код безб.від.","TOBO"}})
        </div>  
    </div>
</div>

<script src="/Common/Script/BarsIe.js" type="text/javascript"></script>
<script src="/Common/Script/Sign.js" type="text/javascript"></script>