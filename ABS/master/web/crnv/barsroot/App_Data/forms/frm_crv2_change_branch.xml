<?xml version="1.0" encoding="utf-8"?>
<xmlform caption="Претенденти на зміну бранча для 2625/22">
<grids>
  <grid id="gv1" pagesize="10" showpagesizebox="true" title ="Список претендентів">

  <filters caption="Фільтри" buttontext="Пошук" columnscount="2">

    <filter caption="Рахунок" columnindex="2" field="NLS" condition="Equal" id="fltNLS">
      <uicontrol type="IntegerInput" controlwidth="200"></uicontrol>
    </filter>
    <filter caption="ІНН" columnindex="2" field="OKPO" condition="Equal" id="fltOKPO">
      <uicontrol type="IntegerInput" controlwidth="200"></uicontrol>
    </filter>
    <filter caption="Назва рахунку" columnindex="1" field="NMK" condition="LikeBoth" id="fltNMK">
      <uicontrol type="TextBox" controlwidth="200"></uicontrol>
    </filter>
    <filter caption="Бранч рахунку" columnindex="1" field="OLD_BRANCH" condition="LikeBoth" id="fltBR">
      <uicontrol type="TextBox" controlwidth="200"></uicontrol>
    </filter>
   </filters>
  <buttons>
    <button caption="Змінити БРАНЧ" hint="Змінити бранч відміченим рахункам" id="1" type="Button" confirmmessage="Змінити відміченим рахункам бранч?">
      <command type="PlSqlBlock" successmessage="Змінено бранчі для відмічених рахунків!">
        <sql>
          begin
          update accounts
          set tobo=:NEW_BRANCH
          where acc=:ACC;
          logger.info('CRV2 ACC='||:ACC||', OLD_BRANCH ='||:OLD_BRANCH||', NEW_BRANCH='||:NEW_BRANCH);
          commit;
          end;
        </sql>
        <parameters>
          <parameter altname="ACC" datatype="Int64" name="ACC" type="DataField"></parameter>
          <parameter altname="OLD_BRANCH" datatype="Int64" name="OLD_BRANCH" type="DataField"></parameter>
          <parameter altname="NEW_BRANCH" datatype="Int64" name="NEW_BRANCH" type="DataField"></parameter>
        </parameters>
      </command>
    </button>
   </buttons>
  <datasource>
    <sql>
      select distinct a.acc, substr(a.nms,1,38) nmk, c.okpo, a.nls, a.kv,  a.branch old_branch , z.branch new_branch
      from CUSTOMERW w, customer c, accounts a,
      ( SELECT TRIM (REPLACE (SUBSTR (d_rec, 15), '#', '')) crv_rnk,
      SUBSTR (a.nlsb, 8, 3) fff, c.branch
      FROM arc_rrp a, accounts b, branch c
      WHERE EXISTS
      (SELECT 1
      FROM tzapros
      WHERE     rec = a.rec
      AND STMP >= gl.bd-4
      AND gl.bd>=STMP)
      AND a.dk = 3
      AND a.nlsb LIKE '2906_90___12'
      AND a.kv = 980
      AND a.mfoa = '300465'
      AND a.nlsa = '290642012'
      AND a.nlsb = b.nls
      AND a.kv = b.kv
      and  c.branch like  '/______/______/___'||SUBSTR (a.nlsb, 8, 3)||'/'
      and date_closed  is null
      ) z
      where w.tag  = 'RVRNK'
      and w.value = z.crv_rnk
      and w.rnk  = c.rnk
      and c.rnk  = a.rnk
      and a.nbs  = '2625'
      and a.ob22 = '22'
      and dazs is null and a.kv =980
      and a.branch !=z.branch
      and a.branch like sys_context('bars_context','user_branch')||'%'
     order by nmk
    </sql>
   </datasource>

  <rowselection method="CheckBox"/>

  <fields>
    <field datatype="Int64" key="true" name="ACC">
      <column caption="ACC" show ="false"></column>
    </field>
    <field datatype="String" key="false" name="NMK">
      <column caption="Назва рахунку" show ="true"></column>
    </field>
    <field datatype="Int64" key="false" name="OKPO">
      <column caption="ІНН клієнта" show ="true"></column>
    </field>
    <field datatype="Int64" key="false" name="NLS">
      <column caption="Номер рахунку" show ="true"></column>
    </field>
    <field datatype="Int64" key="false" name="KV">
      <column caption="Валюта" show ="true"></column>
    </field>
    <field datatype="String" key="true" name="OLD_BRANCH" >
      <column caption="Бранч рахунку" show ="true"></column>
    </field>
    <field datatype="String" key="true" name="NEW_BRANCH" >
      <column caption="Бранч який повинен бути" show ="true"></column>
    </field>
  </fields>
</grid>
</grids>
</xmlform>