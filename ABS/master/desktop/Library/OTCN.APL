.head 0 +  Application Description: ! OTCN.APL - Выходные формы НБУ и ДПА
! ООО Унити-Барс (C) 1997-2004
! Разработчики: Сыропоршнев Д.Л., Овчарук А.В.
! ///////////////////////////////////////////
.head 1 -  Outline Version - 4.0.26
.head 1 +  Design-time Settings
.data VIEWINFO
0000: 6F00000003000000 FFFF01000D004347 5458566965775374 6174650400010000
0020: 0000000000410100 002C000000030000 0003000000FFFFFF FFFFFFFFFFF8FFFF
0040: FFE1FFFFFF000000 00000000000C0400 005F020000010000 0000000000010000
0060: 000F4170706C6963 6174696F6E497465 6D04000000075769 6E646F77730C6672
0080: 6D5F46696C65734E 62750946756E6374 696F6E730863686B 426E6B4474000001
00A0: 8002000200000000 000000000000002C 0000000000000001 000000FFFFFFFFFF
00C0: FFFFFFF8FFFFFFE2 FFFFFF3200000032 0000001F0400009D 0200000000000000
00E0: 000000050000000F 4170706C69636174 696F6E4974656D07 57696E646F77730C
0100: 66726D5F46696C65 734E62750D436869 6C642057696E646F 77730B706246696C
0120: 655374616D700000 0000
.enddata
.data DT_MAKERUNDLG
0000: 0200000000001C51 3A5C424152533938 5C4C494252415259 5C4162736170692E
0020: 646C6C1C513A5C42 41525339385C4C49 42524152595C4162 736170692E617063
0040: 00000101011C513A 5C4241525339385C 4C4942524152595C 4162736170692E72
0060: 756E1C513A5C4241 525339385C4C4942 524152595C416273 6170692E646C6C1C
0080: 513A5C4241525339 385C4C4942524152 595C416273617069 2E61706300000101
00A0: 01145C6261727339 385C62696E5C6F74 636E2E617064165C 6261727339385C62
00C0: 696E5C4162736170 692E646C6C165C62 61727339385C6269 6E5C416273617069
00E0: 2E61706300000101 01001C513A5C4241 525339385C4C4942 524152595C416273
0100: 6170692E646C6C1C 513A5C4241525339 385C4C4942524152 595C416273617069
0120: 2E61706300000101 01
.enddata
.head 2 -  Outline Window State: Normal
.head 2 +  Outline Window Location and Size
.data VIEWINFO
0000: 6600040003002D00 0000000000000000 0000B71E5D0E0500 1D00FFFF4D61696E
0020: 0000000000000000 0000000000000000 0000003B00010000 00000000000000E9
0040: 1E800A00008600FF FF496E7465726E61 6C2046756E637469 6F6E730000000000
0060: 0000000000000000 0000000000003200 0100000000000000 0000E91E800A0000
0080: DF00FFFF56617269 61626C6573000000 0000000000000000 0000000000000000
00A0: 3000010000000000 00000000F51E100D 0000F400FFFF436C 6173736573000000
00C0: 0000000000000000 0000000000000000
.enddata
.data VIEWSIZE
0000: D000
.enddata
.head 3 -  Left:   -0.013"
.head 3 -  Top:    0.0"
.head 3 -  Width:  8.013"
.head 3 -  Height: 4.969"
.head 2 +  Options Box Location
.data VIEWINFO
0000: 1018B80BB80B2500
.enddata
.data VIEWSIZE
0000: 0800
.enddata
.head 3 -  Visible? Yes
.head 3 -  Left:   4.15"
.head 3 -  Top:    1.885"
.head 3 -  Width:  3.8"
.head 3 -  Height: 2.073"
.head 2 +  Class Editor Location
.head 3 -  Visible? No
.head 3 -  Left:   0.575"
.head 3 -  Top:    0.094"
.head 3 -  Width:  5.063"
.head 3 -  Height: 2.719"
.head 2 +  Tool Palette Location
.head 3 -  Visible? No
.head 3 -  Left:   6.388"
.head 3 -  Top:    0.729"
.head 2 -  Fully Qualified External References? Yes
.head 2 -  Reject Multiple Window Instances? No
.head 2 -  Enable Runtime Checks Of External References? Yes
.head 2 -  Use Release 4.0 Scope Rules? No
.head 1 +  Libraries
.head 2 -  Dynalib: Global.apd
.head 2 -  Dynalib: Message.apd
.head 2 -  Dynalib: Absapi.apd
.head 2 -  Dynalib: Nsiapi.apd
.head 2 -  Dynalib: PRINTAPI.apd
.head 2 -  Dynalib: MSOFFICE.apd
.head 2 -  Dynalib: docview.apd
.head 2 -  Dynalib: custacnt.apd
.head 2 -  Dynalib: cc_input.apd
.head 2 -  Dynalib: otcndpa.apd
.head 2 -  !
.head 2 -  File Include: Constant.apl
.head 2 -  File Include: Genbutn.apl
.head 2 -  File Include: Genfcls.apl
.head 2 -  File Include: Genemnu.apl
.head 2 -  File Include: Gentbl.apl
.head 2 -  File Include: GentblD.apl
.head 2 -  File Include: Genlist.apl
.head 2 -  File Include: Genlabel.apl
.head 2 -  File Include: Winapi.apl
.head 2 -  File Include: Winbars2.apl
.head 2 -  File Include: SqlNsi.apl
.head 2 -  File Include: Vtfile.APL
.head 2 -  File Include: Vtcal.apl
.head 2 -  File Include: Vtmeter.apl
.head 2 -  File Include: Vttblwin.apl
.head 2 -  File Include: Vtsplit.apl
.head 2 -  File Include: Vtlbx.apl
.head 2 -  File Include: Vtdos.apl
.head 2 -  File Include: Vtmsgbox.apl
.head 2 -  File Include: Signfile.apl
.head 2 -  File Include: Strfnc.apl
.head 2 -  File Include: Xsaltlb.apl
.head 2 -  File Include: Xsalcpt.apl
.head 2 -  File Include: XSALSPL.APL
.head 1 +  Global Declarations
.head 2 +  Window Defaults
.head 3 +  Tool Bar
.head 4 -  Display Style? Etched
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Form Window
.head 4 -  Display Style? Etched
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Dialog Box
.head 4 -  Display Style? Etched
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: System Default
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Default
.head 3 +  Top Level Table Window
.head 4 -  Font Name: Arial Cyr
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: System Default
.head 4 -  Background Color: System Window Color
.head 3 +  Data Field
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Multiline Field
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Spin Field
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Background Text
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Pushbutton
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 3 +  Radio Button
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Check Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Option Button
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 3 +  Group Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Child Table Window
.head 4 -  Font Name: Arial Cyr
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: System Window Color
.head 3 +  List Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Combo Box
.head 4 -  Font Name: Use Parent
.head 4 -  Font Size: Use Parent
.head 4 -  Font Enhancement: Use Parent
.head 4 -  Text Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 3 +  Line
.head 4 -  Line Color: Use Parent
.head 3 +  Frame
.head 4 -  Border Color: Use Parent
.head 4 -  Background Color: 3D Face Color
.head 3 +  Picture
.head 4 -  Border Color: Use Parent
.head 4 -  Background Color: Use Parent
.head 2 +  Formats
.head 3 -  Number: 0'%'
.head 3 -  Number: #0
.head 3 -  Number: ###000
.head 3 -  Number: ###000;'($'###000')'
.head 3 -  Date/Time: hh:mm:ss AMPM
.head 3 -  Date/Time: M/d/yy
.head 3 -  Date/Time: MM-dd-yy
.head 3 -  Date/Time: dd-MMM-yyyy
.head 3 -  Date/Time: MMM d, yyyy
.head 3 -  Date/Time: MMM d, yyyy hh:mm AMPM
.head 3 -  Date/Time: MMMM d, yyyy hh:mm AMPM
.head 3 -  Input: 99/99/99
.head 3 -  Number: ###00000
.head 3 -  Date/Time: dd/MM/yyyy
.head 3 -  Date/Time: dd/MM/yy
.head 3 -  Date/Time: dd
.head 3 -  Date/Time: dd-MM-yyyy
.head 3 -  Date/Time: ddMMyy
.head 3 -  Date/Time: yy/MM/dd
.head 2 +  External Functions
.head 3 +  Library name: MsVcrt.Dll
.head 4 +  Function: _open_osfhandle
.head 5 -  Description: Преобразуем хэндл ОС в хэгл С ран-тайм
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: INT
.head 5 +  Parameters
.head 6 -  Number: LONG
.head 6 -  Number: INT
.head 3 +  Library name: IctBob.Dll
.head 4 +  Function: llopen
.head 5 -  Description: открытие файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: HANDLE
.head 5 +  Parameters
.head 6 -  ! первый параметр: имя файла,
  второй: тип открытия
.head 6 -  String: LPCSTR
.head 6 -  Number: INT
.head 4 +  Function: llcreat
.head 5 -  Description: создание файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: HANDLE
.head 5 +  Parameters
.head 6 -  ! первый параметр: имя файла,
  второй: тип открытия
.head 6 -  String: LPCSTR
.head 6 -  Number: INT
.head 4 +  Function: llclose
.head 5 -  Description: закрытие файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: HANDLE
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 4 +  Function: llread
.head 5 -  Description: чтение файла (C++)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: UINT
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 6 -  String: LPVOID
.head 6 -  Number: UINT
.head 4 +  Function: llwrite
.head 5 -  Description:
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: UINT
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 6 -  String: LPVOID
.head 6 -  Number: UINT
.head 4 +  Function: lllseek
.head 5 -  Description:
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Number: LONG
.head 5 +  Parameters
.head 6 -  Number: HANDLE
.head 6 -  Number: LONG
.head 6 -  Number: INT
.head 4 +  ! Function: llstr2str
.head 5 -                Description: преобразование строки HEXtoBIN
.head 5 -                Export Ordinal: 0
.head 5 -                Returns
.head 5 +                Parameters
.head 6 -                String: LPSTR
.head 6 -                Receive String: LPVOID
.head 6 -                Number: ULONG
.head 3 +  Library name: HARAKIRI.DLL
.head 4 +  Function: DeleteBadSymbols
.head 5 -  Description: Удаляет из файла отчета ненужные символы
и добавляет в него Esc-последовательности
Параметры:
	Имя файла,
	Строка Esc-последовательностей
	Флаг удаления символа с кодом 12
	Флаг удаления пустых строк (3 и более пустых строки заменяются одной)
.head 5 -  Export Ordinal: 0
.head 5 +  Returns
.head 6 -  Boolean: BOOL
.head 5 +  Parameters
.head 6 -  String: LPSTR
.head 6 -  String: LPSTR
.head 6 -  Boolean: BOOL
.head 6 -  Boolean: BOOL
.head 3 +  ! Library name: WinToDosDLL.dll
.head 4 +     Function: ConvertFile
.head 5 -     Description: Конверт WIN - UKG
.head 5 -     Export Ordinal: 0
.head 5 +     Returns 
.head 6 -     Number: INT
.head 5 +     Parameters 
.head 6 -     String: LPSTR
.head 6 -     String: LPSTR
.head 2 +  Constants
.data CCDATA
0000: 3000000000000000 0000000000000000 00000000
.enddata
.data CCSIZE
0000: 1400
.enddata
.head 3 +  System
.head 3 +  User
.head 4 -  Number: COLOR_STOP  =0 ! параметр для цвета окраски для счетов с несквитованным файлом
.head 4 -  Number: COLOR_BLOCK =1 ! параметр для цвета окраски блокированных счетов
.head 4 -  Number: COLOR_NO_R  =2  ! нет квитанции подтверждения @R
.head 4 -  Number: COLOR_NO_I  =3  ! нет квитанции подтверждения @I
.head 4 -  !
.head 4 -  !
.head 4 -  ! Форматы экспорта (Обязательно должны быть описаны в справочнике rep_types)
.head 4 -  Number: EXP_DBF_DOS =11   
.head 4 -  Number: EXP_DBF_WIN =12
.head 4 -  Number: EXP_DBF_UKG =13
.head 4 -  !
.head 4 -  Number: EXP_XML_WIN =14   
.head 4 -  Number: EXP_XML_UTF =15
.head 4 -  !
.head 4 -  Number: EXP_NULL_OUTPUT =17 ! Не выводит ни в какой приемник
.head 4 -  !
.head 4 -  Number: EXP_BLOB = 18 !Экспорт блобов в файлв из отчетов
.head 4 -  ! Number: BLOB_TEXT = 22
.head 4 -  ! Number: BLOB_BYTE = 23
.head 2 +  Resources
.head 3 +  Icon: icon_Folder1
.head 4 -  File Name: \Bars98\Resource\Ico\Folder.ico
.head 3 +  Icon: icon_Folder2
.head 4 -  File Name: \Bars98\Resource\Ico\Folderop.ico
.head 2 +  Variables
.data RESOURCE 0 0 1 3251786390
0000: BA00000048000000 0000000000000000 020000070000009D 010000E0010D0000
0020: 00FF3FAA01BA0001 00FFFF08B7010002 040000FE00FFA3BB 010002FB00FF8FBF
0040: 0100EE0200FF3FC3 01BA000100FFFF88 D00100030400FE00 FF03
.enddata
.head 3 -  Boolean: fInitLib
.head 3 -  Window Handle: hWnd0
.head 3 -  ! //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
.head 3 -  !
.head 3 -  String: G_CURR_REP_FILENAME ! Глобальная переменная , которая 
.head 3 -  Window Handle: hWinZ
.head 3 -  String: strFileName
.head 3 -  String: strRepDate
.head 3 -  String: strBankDate
.head 3 -  !
.head 3 -  Boolean: bTblLicSep
.head 3 -  Boolean: bTblLicOdb
.head 3 -  Boolean: bTblLicIsp
.head 3 -  !
.head 3 -  Boolean: bFrmBalans
.head 3 -  Boolean: bFrmBalansS
.head 3 -  Boolean: bSKP
.head 3 -  Boolean: bFrmMonth
.head 3 -  Boolean: bFrmSaldo
.head 3 -  !
.head 3 -  String: strBind
.head 3 -  String: strInput
.head 3 -  String: strDir
.head 3 -  !
.head 3 -  Window Handle: hWndLicParent
.head 3 -  !
.head 3 -  Number: nRowType
.head 3 -  Number: nFetchRes
.head 3 -  !
.head 3 -  String: sBind[254]
.head 3 -  Number: nBind[254]
.head 3 -  Date/Time: dBind[254]
.head 3 -  !
.head 3 -  ! Для целей глобальной отладки
.head 3 -  Boolean: DebuggingOn
.head 3 -  ! Показывать или нет сообщение об окончании выполнения отчета
.head 3 -  Boolean: ShowEndReportMessageOn
.head 3 -  !
.head 3 -  ! Для .NET
.head 3 -  ! Режим .NET
.head 3 -  Boolean: fDotNetMode
.head 3 -  ! Код возврата
.head 3 -  Number: nExitCode
.head 3 -  !
.head 3 -  ! Файл результата экспорта кат. запроса
.head 3 -  ! Для DBF, Отчет, текст
.head 3 -  String: sCatQueryResult
.head 3 -  Boolean: fRtf
.head 3 -  ! -- счетчик прочитанных записей 
.head 3 -  Number: nRowCount
.head 3 -  ! Таблица для экспорта каталогизированного запроса
.head 3 -  Window Handle: hCatQueryTbl
.head 3 -  !
.head 3 -  Number: SESSION_ID
.head 3 -  String: strTraceFile
.head 3 -  Boolean: isTracing
.head 3 -  Boolean: isOk
.head 2 +  Internal Functions
.head 3 +  Function: showEndReportMessage
.head 4 -  Description: Показать сообщение о том, что печатный отчет уже выполнился
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: sFileName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nSecondsToWait
.head 5 -  String: sMessage
.head 5 -  String: sTmp
.head 4 +  Actions
.head 5 -  Set nSecondsToWait = 60
.head 5 -  !
.head 5 -  Set sMessage  = 'Выгрузка кат. запроса' 
.head 5 +  If sFileName != STRING_Null
.head 6 -  Set sMessage  = sMessage||' в '|| sFileName 
.head 5 -  Set sMessage  = sMessage||' завершена!'
.head 5 -  Call MessageNoWait(sMessage , 'Экспорт', nSecondsToWait, 0)
.head 5 -  ! Получить параметр пользоваттеля. который готоврит видимости данного сообщения
.head 3 +  Function: getAttentionColor
.head 4 -  Description: Отдать цвет по заказу
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  Number: nWhat  
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 +  If nWhat = COLOR_STOP
.head 6 -  Return SalColorFromRGB( 255,205,255 )
.head 5 +  If nWhat = COLOR_BLOCK
.head 6 -  Return SalColorFromRGB( 255,210,205 )
.head 5 +  If nWhat = COLOR_NO_R
.head 6 -  Return SalColorFromRGB( 255, 255, 150 )
.head 5 +  If nWhat = COLOR_NO_I
.head 6 -  Return SalColorFromRGB( 205,255,255 )
.head 3 +  Function: OtcnIni
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strPathToLangResources
.head 5 -  String: strLangId
.head 5 -  !
.head 5 -  String: strFileName
.head 4 +  Actions
.head 5 +  If NOT fInitLib
.head 6 -  Set strPathToLangResources = GetLangPath()
.head 6 -  Set strLangId = GetLang()
.head 6 -  Set strFileName = strPathToLangResources || "\\" || strLangId || "\\otcn.lng"
.head 6 -  !
.head 6 +  If (NOT strLangId) OR (NOT CurrentLangTable.InitFromFile( strFileName, strLangId ))
.head 7 -  Call CurrentLangTable.Init()
.head 7 -  !
.head 7 -  Call CurrentLangTable.AddAtom('cTAt', 'Внимание!')
.head 7 -  Call CurrentLangTable.AddAtom('cTErr','Ошибка!')
.head 7 -  ! ====================================================
.head 7 -  ! winQueryList
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.cTWndTitle','Каталогизированые запросы')
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.cTMenu','Запрос')
.head 7 -  ! Columns
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.tblQueryList.colKODZ','Код')
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.tblQueryList.colQName','Наименование запроса')
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.tblQueryList.colQRFile','Файл результата')
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.tblQueryList.colQText','Текст запроса')
.head 7 -  ! Err
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.cTErrFileName','Не задано имя файла результата!~Задайте его и повторите экспорт.')
.head 7 -  ! Constant
.head 7 -  Call CurrentLangTable.AddAtom('winQueryList.cTResult','Результат запроса')
.head 7 -  ! ====================================================
.head 7 -  ! dlg_BindSet
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSet.cTWndTitle','Параметры запроса...')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSet.pbRef','Справочник')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSet.pbOk','Утвердить')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSet.pbCancel','Отменить')
.head 7 -  ! Columns
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSet.tblBinds.colBindName','Параметр')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSet.tblBinds.colVal','Значение')
.head 7 -  ! ====================================================
.head 7 -  ! dlg_BindSetDat
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.cTWndTitle','Параметры запроса...')
.head 7 -  ! bg
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.bgFrom','С даты')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.bgTo','По дату')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.bgOn','На дату')
.head 7 -  ! pb
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.pbRef','Справочник')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.pbOk','Утвердить')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.pbCancel','Отменить')
.head 7 -  ! Columns
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.tblBinds.colBindName','Параметр')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.tblBinds.colVal','Значение')
.head 7 -  !
.head 7 -  Call CurrentLangTable.AddAtom('dlg_BindSetDat.cTMsgDat','Нет доступных дат для выбора')
.head 7 -  ! ====================================================
.head 7 -  ! tbl_BindSQL
.head 7 -  Call CurrentLangTable.AddAtom('tbl_BindSQL.cTErrNsi','Невозможно выполнить население справочника')
.head 7 -  Call CurrentLangTable.AddAtom('tbl_BindSQL.cTNsi','Справочник')
.head 7 -  Call CurrentLangTable.AddAtom('tbl_BindSQL.cTNsiNotBMD','не описан в Базе Мета Данных')
.head 7 -  ! ====================================================
.head 7 -  ! dlg_LoadDbf
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTWndTitle','Загрузка файла')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.pbRun','Выполнить')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.pbExit','Отменить')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.pbChoose','Выбрать...')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cbTransCode','Перекодировать из кодировки OEM (DOS) в ANSI (WIN)')
.head 7 -  !
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTBtnDelNew','НОВАЯ')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTBtnNoDelNew','ЗАМЕНА')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTBtnNo','ОТКАЗ')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTBtnNoDelPlusNew1','НОВЫЕ ДАННЫЕ')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTBtnNoDelPlusNew2','ДОБАВИТЬ')
.head 7 -  ! Msg
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsgTable','Таблица')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg11','уже существует (пустая) !')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg12','Удалить таблицу')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg13','и создать НОВУЮ ?')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg21','уже существует c данными !')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg22','Удалить таблицу и создать НОВУЮ')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg23','НЕ удалять таблицу, УДАЛИТЬ старые данные')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg24','НЕ удалять таблицу, добавить ТОЛЬКО НОВЫЕ данные')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg25','НЕ удалять таблицу, добавить ВСЕ данные')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg26','Имя таблицы должно включать хотя бы один не числовой символ,')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsg27','имя таблицы не должно начинаться с цифры')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsgFileOk','Обработка файла завершена!')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsgNotDropTable','Не удалось удалить таблицу')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsgNotCreateTable','Не удалось создать таблицу')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsgDel','Невозможно удалить записи из таблицы')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTMsgIns','Невозможно всавить запись в таблицу')
.head 7 -  ! Err
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTErrDir','Не удалось переити в каталог')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTErrDB','Нет доступа к базе данных')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTErrFileOpen','Не удалось открыть файл')
.head 7 -  ! Constant
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTLoadFile','Загрузка файла')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTConfirm','Подтверждение')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTQuery','ЗАПРОС')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTLoad','Загрузка')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTImport','Импорт')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTSelect','Выбор')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTNotImport','Пользователь отказался от импорта таблицы')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTDropSynonym','Удаление синонима')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTDropTable','Удаление таблицы')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTCreateTable','Создание таблицы')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTDelete','Удаление записей из таблицы')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTInsert','Добавление записей в таблицу')
.head 7 -  Call CurrentLangTable.AddAtom('dlg_LoadDbf.cTSynonym','создание синонима, роли, выдача привелегий')
.head 7 -  ! ====================================================
.head 7 -  ! ExportCatQuery
.head 7 -  ! Msg
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTMsgDebugFileNmae','Имя файла вычесленно в')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTMsgDebugQuery','Основной запрос с подставленными параметрами')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTMsgDebugParams','Полные параметры передаваемые в дочерний зарос')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTMsgDebugFileNameD','Имя файла доч. запроса вычесленно в')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTMsgDebugQueryD','Запрос с подставленными параметрами')
.head 7 -  ! Err
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrNotFileName','Не задано имя формируемого файла!')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrFileName','Ошибка при вычислении имени файла')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrSegment','Ошибка при установке сегмента отката')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrExecProc','Ошибка при выполнении процедуры')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrSQL','Не могу подготовить SQL выражение')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrFunc99','Внешний вызов функции ExportCatQuery с параметром 99 запрещен!')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrExportFormat','Неизвестный формат экспорта каталогизированных запросов #')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrQueryNotFound','Каталогизированный запрос со следующим кодом не найден #')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTErrQueryParams','Нельзя прочитать параметры запроса #')
.head 7 -  !
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTToLog1','Експорт запроса ид.')
.head 7 -  Call CurrentLangTable.AddAtom('ExportCatQuery.cTToLog2','с параметрами')
.head 7 -  ! ====================================================
.head 7 -  ! GetRepParamsStr
.head 7 -  Call CurrentLangTable.AddAtom('GetRepParamsStr.cTDat','Дата')
.head 7 -  ! ====================================================
.head 6 -  !
.head 6 -  Set fInitLib = TRUE
.head 5 -  ! Call CurrentLangTable.SaveToFile('C:\\TEMP\\otcn_.lng','RUS')
.head 5 -  Return fInitLib
.head 3 +  Function: MakeTraceFileName	! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Set strTraceFile = VisFileCreateTemp ('rep')
.head 5 -  ! Set strTraceFile = 'c:\\rep_gen.trc'
.head 3 +  Function: SetTracing		! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Boolean: flag
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Set isTracing = flag
.head 3 +  Function: TraceMessage		! __exported
.head 4 -  Description: трассировка в файл
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: strMessage
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  File Handle: hTraceFile
.head 5 -  String: strCurDate
.head 5 -  Number: nErrorCode
.head 5 -  String: strReopen
.head 4 +  Actions
.head 5 +  If isTracing
.head 6 -  Set isOk = SalFileOpen( hTraceFile, strTraceFile, OF_Exist)
.head 6 +  If not isOk
.head 7 -  Set isOk = SalFileOpen( hTraceFile, strTraceFile, OF_Create|OF_Text|OF_Write)
.head 7 -  Call SalFileClose (hTraceFile)
.head 6 -  Set isOk = SalFileOpen( hTraceFile, strTraceFile, OF_Append|OF_Text|OF_Write)
.head 6 -  Call SalDateToStr( SalDateCurrent(  ), strCurDate )
.head 6 -  Call SalFilePutStr (hTraceFile, strCurDate || ': '
||strMessage)
.head 6 -  Call SalFileClose (hTraceFile)
.head 3 +  Function: ShowFilesNbu       	! __exported
.head 4 -  Description: Функция формирования файлов отчетности НБУ
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call SalCreateWindow(frm_FilesNbu, hW, 0, 0)
.head 3 +  Function: ShowFilesInt       	! __exported
.head 4 -  Description: Функция формирования файлов внутренней отчетности банка
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call SalCreateWindow(frm_FilesNbu, hW, 1, 0)
.head 3 +  Function: PrintSpecial	     	! __exported
.head 4 -  Description: Специальная печать файлов отчетности
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Return SalModalDialog( dlg_SpecialReport, hWndMDI )
.head 3 -  !
.head 3 +  Function: ShowFilesNI        	! __exported
.head 4 -  Description: Функция формирования файлов отчетности НИ
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call OtcnDpa(hW, 0, 0, '', '')
.head 3 +  Function: ShowFilesNIByID    	! __exported
.head 4 -  Description: Функция формирования файлов отчетности НИ
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 5 -  String: strTypeList
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 +  If strTypeList = 'WFM'
.head 6 -  Call OtcnDpa(hW, 1, 0, '', '')
.head 5 +  Else If SalStrScan(strTypeList, '#') != -1
.head 6 -  Call OtcnDpa(hW, 0, 0, '', 
Subs(strTypeList, SalStrScan(strTypeList, '#')+1, Len(strTypeList)-SalStrScan(strTypeList, '#')))
.head 5 +  Else
.head 6 -  Call OtcnDpa(hW, 0, 0, strTypeList, '')
.head 3 -  !
.head 3 +  Function: ShowTicketsNI	     	! __exported
.head 4 -  Description: функция просмотра квитанций на файлы отчетности НИ и НБУ
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 5 -  String: strTicDir
.head 5 -  String: strTicMask
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call ShowDpaTickets(hW, FALSE, strTicDir, strTicMask, '', '')
.head 3 +  Function: ProcTicketsNI	     	! __exported
.head 4 -  Description: функция обработки квитанций на файлы отчетности НИ и НБУ
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 5 -  String: strTicDir
.head 5 -  String: strTicMask
.head 5 -  String: strZagTable
.head 5 -  String: strLinesTable
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call ShowDpaTickets(hW, TRUE, strTicDir, strTicMask, strZagTable, strLinesTable)
.head 3 +  Function: ProcCusListFile    	! __exported
.head 4 -  Description: обработать файл ^U для налоговой (список подозрительных клиентов)
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Return SalModalDialog( dlg_LoadDPAList, hWndMDI )
.head 3 -  !
.head 3 +  Function: ZAPROS             	! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call ZAPROS1( hW, NUMBER_Null ) 
.head 3 +  Function: ZAPROS1             	! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 5 -  Number: KODZ
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 +  If not IsWindow(hWinZ)
.head 6 -  Set hWinZ = SalCreateWindow( winQueryList, hW , KODZ )
.head 5 +  Else
.head 6 -  Call SalBringWindowToTop ( hWinZ )
.head 3 +  Function: Imp_KL_NBU         	! __exported
.head 4 -  Description: Функция импорта справочников отчетности НБУ
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sTmp
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  ! Call SalModalDialog( dlg_LoadDbf, hW, STRING_Null )
.head 5 -  Call SalModalDialog( dlg_LoadDbf, hW, 0, NUMBER_Null, STRING_Null, sTmp )
.head 3 +  Function: Imp_Dbf_New       	! __exported
.head 4 -  Description: Функция импорта dbf с расширенным набором параметров
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW ! хандлер вызывающего окна
.head 5 -  Number: nPar1 ! Особенности обработки табл в БД
.head 5 -  Number: nPar2 ! Резерв
.head 5 -  String: sPar1 ! Маска файлов
.head 5 -  String: sPar2 ! Резерв
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sTmp
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call SalModalDialog( dlg_LoadDbf, hW, nPar1, nPar2, sPar1, sTmp )
.head 5 -  ! Set sFile_Ret = sTmp
.head 3 +  Function: Imp_Dbf_Ret       	! __exported
.head 4 -  Description: Функция импорта dbf с расширенным набором параметров
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hW ! хандлер вызывающего окна
.head 5 -  Receive String: sFile_Ret ! Имя обработанного файла
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sTmp
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call SalModalDialog( dlg_LoadDbf, hW, 0, NUMBER_Null, STRING_Null, sTmp )
.head 5 -  Set sFile_Ret = sTmp
.head 3 +  Function: Otcn			! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Window Handle: hWndParent
.head 5 -  Number: nMode
.head 5 -  Number: nPar1
.head 5 -  Number: nPar2
.head 5 -  String: sPar1
.head 5 -  String: sPar2
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Window Handle: hWnd
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 +  Select Case nMode
.head 6 +  Case 0
.head 7 +  If sPar1 = ''
.head 8 -  Call SalMessageBox('Не задан список кат.запросов для формирования отчетов!', 'Внимание!', MB_IconAsterisk)
.head 8 -  Break
.head 7 +  If not IsWindow(hWnd0)
.head 8 -  Set hWnd0 = SalCreateWindow(frmSEBXml, hWndParent, sPar1)
.head 7 +  Else
.head 8 -  Call SalBringWindowToTop(hWnd0)
.head 7 -  Break
.head 6 +  Case 1
.head 7 -  Call SalCreateWindow(frm_FilesNbu, hWndParent, 0, nPar1)
.head 7 -  Break
.head 6 +  Case 2 ! Редактирование отчетных групп для выпискок
.head 7 -  Set hWnd =  SalCreateWindow(spl_RepGroups, hWndParent, 1)
.head 7 -  Break
.head 6 +  Default
.head 7 -  Break
.head 3 -  !
.head 3 +  Function: CreateFileName
.head 4 -  Description: Создать имя файла отчетности
.head 4 +  Returns
.head 5 -  String: strFileName
.head 4 +  Parameters
.head 5 -  String: sFPrefix
.head 5 -  String: sNumFile
.head 5 -  String: sEBox
.head 5 -  String: sGCode
.head 5 -  Date/Time: RepDate
.head 5 -  String: Period
.head 5 -  String: sCQNum
.head 5 -  Number: nMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sLocalName
.head 5 -  String: Period_o
.head 5 -  String: sDebugDate
.head 5 -  !
.head 5 -  Date/Time: dtExtDate
.head 5 -  Number: nPeriod
.head 5 -  !
.head 5 -  Number: nDayN
.head 5 -  Number: nMonthN
.head 5 -  Number: nI
.head 4 +  Actions
.head 5 +  If NOT sFPrefix
.head 6 +  Select Case nMode
.head 7 +  Case 0
.head 8 -  Set sFPrefix = '#'
.head 8 -  Break
.head 7 +  Case 1
.head 8 -  Set sFPrefix = '@'
.head 8 -  Break
.head 7 +  Default
.head 8 -  Set sFPrefix = '#'
.head 8 -  Break
.head 5 -  Set sLocalName =  SalStrLeftX( sFPrefix, 1) ||  sNumFile  ||
    SalStrTrimX( SalStrUpperX( sEBox )) || 
    GetCharForDigit( SalDateMonth ( SalDateCurrent() ) ) ||
    GetCharForDigit( SalDateDay   ( SalDateCurrent() ) ) ||
    '.' || SalStrUpperX(SalStrLeftX( sGCode, 1))
.head 5 -  !
.head 5 -  Set dtExtDate = RepDate
.head 5 -  Set nDayN   = SalDateDay( RepDate )
.head 5 -  Set nMonthN = SalDateMonth( RepDate )
.head 5 -  Set Period_o = Period
.head 5 -  Call SalStrFirstC( Period, nPeriod )
.head 5 +  Select Case nPeriod
.head 6 +  Case 53      ! Once in 5 day
.head 7 -  Set nI = Int( nDayN / 5 )
.head 7 +  If Mod( nDayN, 5)
.head 8 -  Set nI = nI + 1
.head 7 +  If nI = 6
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate + 6 )
.head 7 +  Else
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate ) + (nI * 5) + 1
.head 7 -  Break
.head 6 +  Case 68      ! Daily
.head 7 -  Set dtExtDate = CorrectDate( 980, dtExtDate + 1, dtExtDate + 365 )
.head 7 -  Break
.head 6 +  Case 80	     ! HalfMonth
.head 7 +  If nDayN < 16
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate ) + 15
.head 7 +  Else
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate + 16 )
.head 7 -  Break
.head 6 +  Case 84	     ! Декада
.head 7 +  If nDayN < 11
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate ) + 10
.head 7 +  Else If nDayN < 21
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate ) + 20
.head 7 +  Else
.head 8 -  Set nI = 32 - nDayN
.head 8 -  Set dtExtDate = SalDateMonthBegin( dtExtDate + nI )
.head 7 -  Break
.head 6 +  Case 87      ! Weekly
.head 7 -  Set dtExtDate = CorrectDate( 980, SalDateWeekBegin( dtExtDate + 7 ), dtExtDate + 365 )
.head 7 -  Break
.head 6 +  Default
.head 7 -  Set nI = 32 - nDayN
.head 7 -  Set dtExtDate = SalDateMonthBegin( dtExtDate + nI )
.head 7 -  Break
.head 5 -  !
.head 5 -  ! Call Debug(sLocalName)
.head 5 -  ! Call DebugN(SalDateDay(dtExtDate))
.head 5 -  ! Call Debug(GetCharForDigit(SalDateDay(dtExtDate)))
.head 5 +  If SalStrScan('MQHY', SalStrTrimX( SalStrUpperX( Period_o )) ) != -1
.head 6 -  Set sLocalName = sLocalName || GetCharForDigit( SalDateMonth( dtExtDate ) )
.head 5 +  Else
.head 6 -  Set sLocalName = sLocalName || GetCharForDigit( SalDateDay  ( dtExtDate ) )
.head 5 -  Set sLocalName = sLocalName || sCQNum
.head 5 -  Return sLocalName
.head 3 +  Function: CreateServiceLine
.head 4 -  Description: Создать служебную запись файла отчетности
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  File Handle: hFile
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strLine
.head 4 +  Actions
.head 5 -  Call SalFilePutStr( hFile, SalStrRepeatX( ' ', 100 ) )
.head 5 -  Return TRUE
.head 3 +  Function: CreateHeadLine
.head 4 -  Description: Создать служебную запись файла отчетности
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  File Handle: hFile
.head 5 -  String: sRDate
.head 5 -  String: sPeriod
.head 5 -  String: sGCode
.head 5 -  String: sMFO
.head 5 -  String: sMsmt
.head 5 -  Boolean: bTurnSign
.head 5 -  Number: nCnt
.head 5 -  String: sFileName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strLine
.head 5 -  Date/Time: dtRDate	
.head 5 -  Number: nPeriodCode	! Код символа периода
.head 5 -  Number: nDayN
.head 5 -  Number: nMonthN
.head 5 -  Number: nI
.head 5 -  !
.head 5 -  String: sSuperDate	! Дата (период отчетности)
.head 5 -  String: sStartDate	! Дата начала отчетного периода
.head 5 -  String: sStopDate	! Дата окончания отчетного перода
.head 5 -  !
.head 5 -  String: sRepCode
.head 5 -  Number: nParamCount
.head 4 +  Actions
.head 5 -  Set dtRDate = SalFmtFormatStrDateTime(sRDate, 'MM/dd/yyyy')
.head 5 -  Set nDayN   = SalDateDay( dtRDate )
.head 5 -  Set nMonthN = SalDateMonth( dtRDate )
.head 5 -  ! ******************
.head 5 -  Set sStopDate = SalFmtFormatDateTime( dtRDate, 'ddMMyyyy' )
.head 5 -  !
.head 5 -  Call SalStrFirstC( sPeriod, nPeriodCode )
.head 5 -  ! Call DebugN(nPeriodCode)
.head 5 +  Select Case nPeriodCode
.head 6 +  Case 53      ! Once in 5 day
.head 7 -  Set nI = Int( nDayN / 5 )
.head 7 +  If Mod( nDayN, 5)
.head 8 -  Set nI = nI + 1
.head 7 -  !
.head 7 -  Set sStartDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate ) + ((nI-1) * 5), 'ddMMyyyy' )
.head 7 +  If nI = 6
.head 8 -  Set dtRDate = SalDateMonthBegin( dtRDate + 6 )
.head 7 +  Else
.head 8 -  Set dtRDate = SalDateMonthBegin( dtRDate ) + (nI * 5) + 1
.head 7 -  Break
.head 6 +  Case 68      ! Daily
.head 7 -  Set sStartDate = sStopDate
.head 7 -  Set dtRDate = CorrectDate( 980, dtRDate + 1, dtRDate + 365 )
.head 7 -  Break
.head 6 +  Case 80	 ! HalfMonth
.head 7 +  If nDayN < 16
.head 8 -  Set sStartDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate ), 'ddMMyyyy' )
.head 8 -  Set dtRDate = SalDateMonthBegin( dtRDate ) + 15
.head 7 +  Else
.head 8 -  Set sStartDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate ) + 15, 'ddMMyyyy' )
.head 8 -  Set dtRDate = SalDateMonthBegin( dtRDate + 16 )
.head 7 -  Break
.head 6 +  Case 87      ! Weekly
.head 7 -  Set sStartDate = SalFmtFormatDateTime( SalDateWeekBegin( dtRDate ), 'ddMMyyyy' )
.head 7 -  Set dtRDate = CorrectDate( 980, SalDateWeekBegin( dtRDate + 7 ), dtRDate + 365 )
.head 7 -  Break
.head 6 +  Case 77      ! Monthly 
.head 7 -  Set sStartDate = '01' || SalStrRightX( sStopDate, 6 )
.head 7 -  Set nI = 32 - nDayN
.head 7 -  Set dtRDate = SalDateMonthBegin( dtRDate + nI )
.head 7 -  ! Если месячный файл содержит данные только по остаткам
.head 7 +  If SalStrScan(GetGlobalOption("SFOTCN"),SalStrMidX(sFileName,1,2)) = -1
.head 8 -  Set sStartDate = sStopDate 
.head 7 -  Break
.head 6 +  Case 81      ! 1/4 year 
.head 7 -  Set sStartDate = SalFmtFormatDateTime(
     SalDateConstruct (SalDateYear(dtRDate),SalDateMonth(dtRDate)-2,1,0,0,0),'ddMMyyyy')
.head 7 -  Set nI = 32 - nDayN
.head 7 -  Set dtRDate = SalDateMonthBegin( dtRDate + nI )
.head 7 -  Break
.head 6 +  Case 84      ! 10 days 
.head 7 -  !
.head 7 +  If nDayN >= 1   AND nDayN<11 
.head 8 -  Set sStartDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate ) , 'ddMMyyyy' ) 
.head 8 -  ! Set sStopDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate )+9 , 'ddMMyyyy' ) 
.head 8 -  Set dtRDate= SalDateMonthBegin( dtRDate )+10 
.head 7 +  Else If nDayN >= 11 AND nDayN < 21 
.head 8 -  Set sStartDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate )+10 , 'ddMMyyyy' ) 
.head 8 -  ! Set sStopDate = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate )+19 , 'ddMMyyyy' ) 
.head 8 -  Set dtRDate= SalDateMonthBegin( dtRDate )+20
.head 7 +  If nDayN >= 21 AND nDayN <= 31 
.head 8 -  Set sStartDate   = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate )+20 , 'ddMMyyyy' ) 
.head 8 -  ! Set sStopDate   = SalFmtFormatDateTime( SalDateMonthBegin( dtRDate+31 )-1 , 'ddMMyyyy' ) 
.head 8 -  Set dtRDate = SalDateMonthBegin( dtRDate +15)
.head 7 -  Break
.head 6 +  Default
.head 7 -  Set nI = 32 - nDayN
.head 7 -  Set sStartDate = sStopDate
.head 7 -  Set dtRDate = SalDateMonthBegin( dtRDate + nI )
.head 7 -  Break
.head 5 +  If bTurnSign
.head 6 -  Set sStartDate = '01' || SalStrRightX( sStopDate, 6 )
.head 5 -  Set sSuperDate = SalFmtFormatDateTime( dtRDate, 'ddMMyyyy' )
.head 5 -  ! ******************
.head 5 -  Set sRepCode = SalStrMidX( sFileName, 1, 2 )
.head 5 +  If sRepCode != 'AA' AND sRepCode != 'BB' AND sRepCode != 'CC' AND sRepCode != 'LL' AND sRepCode != 'DD' AND sRepCode != 'VV'
.head 6 -  Set strLine = sGCode || '='
.head 5 -  Set strLine = strLine || sSuperDate || '=' || sStartDate || '=' || sStopDate ||
    '=' || SalFmtFormatDateTime(SalDateCurrent(), 'ddMMyyyy') || '=' || Right('0' ||
    SalFmtFormatDateTime(SalDateCurrent(), 'hhhhmm'), 4) || '=' || sMFO || '=' || sMsmt
    || '=' || Right(Repl('0', 9) || SalNumberToStrX(nCnt, 0), 9 ) || '=' ||
    sFileName || '=' 
.head 5 +  If sRepCode = 'AA' OR sRepCode = 'BB' OR sRepCode = 'CC' OR sRepCode = 'LL' OR sRepCode = 'DD' OR sRepCode = 'VV'
.head 6 -  Set strLine = strLine || SalStrRepeatX( ' ', 64) || '='
.head 5 -  Set strLine = strLine || SalStrRepeatX( ' ', 6) || '=' || SalStrRepeatX( ' ', 64)
.head 5 +  If SalFilePutStr( hFile, strLine )
.head 6 -  Return TRUE
.head 5 -  !
.head 5 -  Return FALSE
.head 3 +  Function: CreateHeadLineEx
.head 4 -  Description: Создать Дополнительную служебную запись файла отчетности - Подзаголовок
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  File Handle: hFile
.head 5 -  String: sR
.head 5 -  String: sMFO
.head 5 -  Boolean: b2Eqv
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strLine
.head 4 +  Actions
.head 5 -  ! //////////////////////////////////////////////////////////////////////////////////////////////////////////////
.head 5 -  !
.head 5 -  ! НАЧАЛО изменения 26.11.2004
.head 5 +  If SalStrLength( SalStrTrimX( sMFO ) ) = 0
.head 6 -  Return FALSE
.head 5 +  If b2Eqv
.head 6 +  If SalStrLength( SalStrTrimX( sMFO ) ) = 13
.head 7 -  Set sMFO='0' || sMFO
.head 6 -  Set strLine = '#' || SalStrLeftX(sR, 1) || '=' || SalStrLeftX( SalStrTrimX( sMFO ) ,2)
.head 6 +  If SalStrLength( SalStrTrimX( sMFO ) ) > 2
.head 7 -  Set strLine = strLine || '=' || SalStrMidX( SalStrTrimX( sMFO ),2,12)
.head 5 +  Else
.head 6 -  Set strLine = '#' || SalStrLeftX(sR, 1) || '=' || SalStrTrimX( sMFO ) 
.head 5 +  If SalFilePutStr( hFile, strLine )
.head 6 -  Return TRUE
.head 5 -  ! КОНЕЦ изменения 26.11.2004
.head 5 -  Return FALSE
.head 5 -  !
.head 5 -  ! //////////////////////////////////////////////////////////////////////////////////////////////////////////////
.head 3 +  Function: CreateInfoLine
.head 4 -  Description: Создать информационную запись файла отчетности
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  File Handle: hFile
.head 5 -  String: sCodeBody
.head 5 -  String: sCodeVal
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strLine
.head 4 +  Actions
.head 5 -  Return SalFilePutStr( hFile, StrWinToDosX(sCodeBody) || '=' || StrWinToDosX(sCodeVal) )
.head 3 +  Function: uf_get_file
.head 4 -  Description: Принять файл отчетности НБУ.
.head 4 +  Returns
.head 5 -  Number: nn
.head 4 +  Parameters
.head 5 -  String: strFileName
.head 5 -  ! MMddyyyy
.head 5 -  String: strRepDate
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  File Handle: inFile
.head 5 -  String: strBuffer
.head 5 -  Number: i
.head 5 -  Number: nStrLen
.head 5 -  Number: nStrNum
.head 5 -  Number: nOffset
.head 5 -  String: strParsed[*]
.head 5 -  String: strFNameBody
.head 5 -  Number: nExists
.head 5 -  Number: nErr
.head 5 -  !
.head 5 -  Number: nIsResident
.head 5 -  Number: nFileID
.head 5 -  Number: nNBUCode
.head 5 -  Number: nChar
.head 5 -  Number: nVal
.head 5 -  Number: nBuf
.head 5 -  Boolean: bRet
.head 5 -  !
.head 5 -  Boolean: flag_OF_MFO
.head 5 -  String: sSqlTxt
.head 5 -  String: strVal
.head 5 -  String: sFName
.head 5 -  String: sSAB
.head 4 +  Actions
.head 5 -  Call SalWaitCursor ( TRUE )
.head 5 +  If not SalFileOpen ( inFile, strFileName, OF_Read )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalMessageBox ( 'Ошибка открытия файла ' || strFileName  , 'Ошибка', MB_Ok | MB_IconHand )
.head 6 -  Return -1
.head 5 +  If not SalFileGetStr ( inFile, strBuffer, 256 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Ошибка чтения файла ' || strFileName  , 'Ошибка', MB_Ok | MB_IconHand )
.head 6 -  Return -1
.head 5 -  Set sFName=SalStrRightX(strFileName,12)
.head 5 -  Set flag_OF_MFO=FALSE
.head 5 -  Set sSqlTxt = T("select val INTO :strVal from params where par='OFOTCN'")
.head 5 +  If SqlPrepareAndExecute(hSql(), sSqlTxt)
.head 6 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 6 +  If strVal  != STRING_Null and strVal = '1'
.head 7 -  Set flag_OF_MFO = TRUE
.head 5 -  ! Служебная строка
.head 5 +  If SalStrLength ( strBuffer ) != 100
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Служебная]', MB_Ok | MB_IconHand )
.head 6 -  Return -1
.head 5 -  Set nStrNum = 1
.head 5 +  If SalStrLeftX(sFName,1)='F'
.head 6 +  While SalFileGetStr ( inFile, strBuffer, 256 )
.head 7 -  Set nStrNum = nStrNum + 1
.head 7 -  Set nStrLen   = SalStrLength ( strBuffer )
.head 7 -  Set strBuffer = StrDosToWinX ( strBuffer )
.head 7 -  ! Заглавная строка
.head 7 +  If nStrNum = 2 AND SalStrLeftX(strFileName,1)='F' AND nStrLen != 212
.head 8 -  Call SalWaitCursor( FALSE )
.head 8 -  Call SalFileClose ( inFile )
.head 8 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Заголовок]', MB_Ok | MB_IconHand )
.head 8 -  Return -1
.head 7 -  ! Заголовок файла
.head 7 +  If nStrNum = 2
.head 8 -  Set i = SalStrTokenize( SalStrUpperX( strBuffer ), '', '=', strParsed )
.head 8 +  If i < 12
.head 9 -  Call SalWaitCursor( FALSE )
.head 9 -  Call SalFileClose ( inFile )
.head 9 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Заголовок]', MB_Ok | MB_IconHand )
.head 9 -  Return -1
.head 8 +  If strParsed[5] = GetBankMfo(  ) AND Not flag_OF_MFO
.head 9 -  Call SalWaitCursor( FALSE )
.head 9 -  Call SalFileClose ( inFile )
.head 9 -  Call SalMessageBox ( 'Файл ' || strFileName || ' от нашего МФО ('|| strParsed[5] ||')!'  , 'Ошибка', MB_Ok | MB_IconHand )
.head 9 -  Return -1
.head 8 +  If strParsed[5] != GetBankMfo(  )
.head 9 -  Set sSqlTxt = T("select count(*) INTO :nVal from v_branch where mfo='"||strParsed[5]||"'")
.head 9 +  If SqlPrepareAndExecute(hSql(), sSqlTxt)
.head 10 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 10 +  If nVal  = 0
.head 11 -  Call SalWaitCursor( FALSE )
.head 11 -  Call SalFileClose ( inFile )
.head 11 -  Call SalMessageBox ( 'Файл ' || strFileName || ' от МФО, которого нет в списке филиалов ('|| strParsed[5] ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 11 -  Return -1
.head 8 +  If flag_OF_MFO
.head 9 -  Set sSqlTxt = T("select substr(sab, 2, 3) INTO :sSAB from v_branch where mfo='"||strParsed[5]||"'" )
.head 9 +  If SqlPrepareAndExecute(hSql(), sSqlTxt)
.head 10 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 10 +  If sSAB != SalStrMidX(sFName, 3, 3)
.head 11 -  Call SalWaitCursor( FALSE )
.head 11 -  Call SalFileClose ( inFile )
.head 11 -  Call SalMessageBox ( 'Ошибка в имени файла ' || strFileName || ' (неправильно указан сегмент UUU - ожидается '|| sSAB ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 11 -  Return -1
.head 9 +  If sFName  != strParsed[8] 
.head 10 -  Call SalWaitCursor( FALSE )
.head 10 -  Call SalFileClose ( inFile )
.head 10 -  Call SalMessageBox ( 'Не совпадает имя импортируемого файла ' || strFileName || ' и имя файла в заголовной строке ('||  strParsed[8]  ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 10 -  Return -1
.head 8 -  ! Проверка уникальности файла
.head 8 -  ! Берем имя файла без расширения и 2х последних символов в имени.
.head 8 -  Set strFNameBody = SalStrLeftX( strParsed[8], 6 )
.head 8 +  If NOT SqlPrepareAndExecute ( hSql(), 'select file_id into :nExists from rnbu_in_files
where (substr(file_name,1,6) = :strFNameBody) and
      (init_date = :strParsed[1]) and
      (last_date = :strParsed[2]) and
      (mfo = :strParsed[5])' )
.head 9 -  Call SalWaitCursor( FALSE )
.head 9 -  Call SalFileClose ( inFile )
.head 9 -  Return -1
.head 8 +  If SqlFetchNext ( hSql(), nErr ) AND nExists > 0
.head 9 -  Call SalWaitCursor ( FALSE )
.head 9 +  If SalMessageBox ( 'Файл №' || SalStrMidX ( strParsed[8], 1, 2 ) ||
		' за дату ' || strParsed[2] || ' от банка с МФО ' || strParsed[5] ||
		' уже принят. Заменить ?'
, 'Внимание !', MB_YesNo | MB_IconQuestion ) = IDNO
.head 10 -  Set nFileID = nExists
.head 10 -  Call SalFileClose ( inFile )
.head 10 -  Return nFileID  !! Возвращается значение ПК нашего файла :)
.head 9 +  Else
.head 10 -  Call SqlPrepareAndExecute ( hSql (), 'delete from RNBU_IN_INF_RECORDS where file_id = :nExists' )
.head 10 -  Call SaveInfoToLog( 'Замена файла: Удаление детальных записей файла с id = ' || SalNumberToStrX( nExists, 0 ) )
.head 10 -  Call SqlPrepareAndExecute ( hSql (), 'delete from RNBU_IN_FILES where file_id = :nExists' )
.head 10 -  Call SaveInfoToLog( 'Замена файла: Удаление заголовка файла с id = ' || SalNumberToStrX( nExists, 0 ) )
.head 9 -  Call SalWaitCursor ( TRUE )
.head 8 -  ! Запись заголовка
.head 8 -  Call SqlPrepareAndExecute ( hSql (), "insert into RNBU_IN_FILES (FILE_ID, FILE_KEY, NEXT_DATE, INIT_DATE, LAST_DATE, FORM_DATE, FORM_TIME, MFO, UNIT, INF_ROW_COUNT, FILE_NAME)
	values (0, '03', :strParsed[0], :strParsed[1], :strParsed[2], :strParsed[3], :strParsed[4], :strParsed[5], :strParsed[6], :strParsed[7], :strParsed[8]) " )
.head 8 +  If SqlPrepareAndExecute( hSql (), 'select S_RNBU_IN_FILES.currval into :nFileID from dual' )
.head 9 -  Call SqlFetchNext ( hSql (), nErr )
.head 7 -  ! Детальные строки
.head 7 +  If nStrNum > 2
.head 8 +  If SalStrLength( SalStrTrimX( strBuffer )) = 0	! Пустая строка - скипаем.
.head 9 -  Set nStrNum = nStrNum - 1
.head 8 +  Else
.head 9 -  Set i = SalStrTokenize( strBuffer, '', '=', strParsed )
.head 9 +  If i < 1
.head 10 -  Call SalWaitCursor( FALSE )
.head 10 -  Call SalFileClose ( inFile )
.head 10 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответствует формату!', 'Ошибка [Строки]', MB_Ok | MB_IconHand )
.head 10 -  Return -1
.head 9 +  If i < 2	! Для показателя типа "ххххх="
.head 10 -  Set strParsed[1]=' '
.head 9 +  If ( SalStrLeftX ( strParsed[0], 1 ) = '#' ) !  Код МФО или области
.head 10 -  Set nNBUCode = SalStrToNumber(strParsed[1])
.head 10 -  Set nStrNum = nStrNum - 1
.head 9 +  Else
.head 10 -  Call SqlPrepareAndExecute( hSql (),
'insert into RNBU_IN_INF_RECORDS (RECORD_ID, FILE_ID, ISRESIDENT, NBUCODE, PARAMETER, VALUE)
	values (0, :nFileID, :nIsResident, :nNBUCode, :strParsed[0], :strParsed[1])' )
.head 5 +  Else
.head 6 -  ! Позиционируемся на начале заглавной строки (перед этим суж. строка 100 + символы конца строки
.head 6 -  Call SalFileSeek ( inFile, 102, FILE_SeekBegin )
.head 6 -  Set strBuffer=STRING_Null
.head 6 -  Set i=1
.head 6 -  ! Читаем 148 + символы конца строки  + один символ из подзаглавной строки для проверки
.head 6 +  Loop
.head 7 +  If i>151
.head 8 -  Break
.head 7 -  Set bRet = SalFileGetC (  inFile, nChar)
.head 7 +  If bRet = FALSE
.head 8 -  Break
.head 7 +  If i<=148
.head 8 -  Set strBuffer = strBuffer || SalNumberToChar (nChar)
.head 7 +  Else
.head 8 -  ! Проверка на правильность стуктуры файла (заглавная строка оканчивается  CR/LF и след. символ за ней - '#')
.head 8 +  If (i=149 and SalNumberLow (nChar) != 13) or (i=150 and SalNumberLow (nChar) != 10) or (i=151 and SalNumberToChar (nChar)!='#')
.head 9 -  Call SalWaitCursor( FALSE )
.head 9 -  Call SalFileClose ( inFile )
.head 9 -  Call SalMessageBox ( 'Заглавная строка файла ' || strFileName || ' не соответствует формату!', 'Ошибка [Проверка 1]', MB_Ok | MB_IconHand )
.head 9 -  Return -1
.head 7 -  Set i=i+1
.head 6 -  Set nStrLen = i
.head 6 -  Set nStrNum = nStrNum + 1
.head 6 -  Set strBuffer = StrDosToWinX ( strBuffer )
.head 6 -  ! Проверка на правильность стуктуры файла (длина заглавной строки = 148)
.head 6 +  If SalStrLeftX(SalStrRightX(SalStrTrimX(strFileName),12),1)='#' and nStrLen < 148
.head 7 -  Call SalWaitCursor( FALSE )
.head 7 -  Call SalFileClose ( inFile )
.head 7 -  Call SalMessageBox ( 'Заглавная строка файла ' || strFileName || ' не соответствует формату!', 'Ошибка [Проверка 2]', MB_Ok | MB_IconHand )
.head 7 -  Return -1
.head 6 -  ! Заголовок файла (берем только заглавную строку)
.head 6 -  Set strBuffer = SalStrLeftX(strBuffer, 148)
.head 6 +  If nStrNum = 2
.head 7 -  Set i = SalStrTokenize( SalStrUpperX( strBuffer ), '', '=', strParsed )
.head 7 +  If i < 12
.head 8 -  Call SalWaitCursor( FALSE )
.head 8 -  Call SalFileClose ( inFile )
.head 8 -  Call SalMessageBox ( strParsed[6] || ' Заглавная строка файла ' || strFileName || ' не соответствует формату!', 'Ошибка [Проверка 3]', MB_Ok | MB_IconHand )
.head 8 -  Return -1
.head 7 +  If strParsed[6] = GetBankMfo(  ) AND Not flag_OF_MFO
.head 8 -  Call SalWaitCursor( FALSE )
.head 8 -  Call SalFileClose ( inFile )
.head 8 -  Call SalMessageBox ( 'Файл ' || strFileName || ' от нашего МФО ('|| strParsed[6] ||')!'  , 'Ошибка', MB_Ok | MB_IconHand )
.head 8 -  Return -1
.head 7 +  If strParsed[6] != GetBankMfo(  )
.head 8 -  Set sSqlTxt = T("select count(*) INTO :nVal from v_branch where mfo='"||strParsed[6]||"'")
.head 8 +  If SqlPrepareAndExecute(hSql(), sSqlTxt)
.head 9 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 9 +  If nVal  = 0
.head 10 -  Call SalWaitCursor( FALSE )
.head 10 -  Call SalFileClose ( inFile )
.head 10 -  Call SalMessageBox ( 'Файл ' || strFileName || ' от МФО, которого нет в списке филиалов ('|| strParsed[6] ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 10 -  Return -1
.head 7 +  If flag_OF_MFO
.head 8 -  Set sSqlTxt = T("select substr(sab, 2, 3) INTO :sSAB from v_branch where mfo='"||strParsed[6]||"'" )
.head 8 +  If SqlPrepareAndExecute(hSql(), sSqlTxt)
.head 9 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 9 +  If sSAB != SalStrMidX(sFName, 3, 3)
.head 10 -  Call SalWaitCursor( FALSE )
.head 10 -  Call SalFileClose ( inFile )
.head 10 -  Call SalMessageBox ( 'Ошибка в имени файла ' || strFileName || ' (неправильно указан сегмент UUU - ожидается '|| sSAB ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 10 -  Return -1
.head 8 +  If sFName  != strParsed[9] 
.head 9 -  Call SalWaitCursor( FALSE )
.head 9 -  Call SalFileClose ( inFile )
.head 9 -  Call SalMessageBox ( 'Не совпадает имя импортируемого файла ' || strFileName || ' и имя файла в заголовной строке ('||  strParsed[9]  ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 9 -  Return -1
.head 7 +  If strParsed[3] != SalStrMidX(strRepDate, 3, 2) || SalStrMidX(strRepDate, 0, 2) || SalStrMidX(strRepDate, 6, 4)
.head 8 -  Call SalWaitCursor( FALSE )
.head 8 -  Call SalFileClose ( inFile )
.head 8 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не за ту дату ('|| 
SalStrMidX(strParsed[3], 0, 2) || '/'|| SalStrMidX(strParsed[3], 2, 2) || '/'|| SalStrMidX(strParsed[3], 4, 4) ||')! ' ||
'Нужно за дату ' || SalStrMidX(strRepDate, 3, 2) || '/' || SalStrMidX(strRepDate, 0, 2) || '/' || SalStrMidX(strRepDate, 6, 4) || '!', 'Ошибка', MB_Ok | MB_IconHand )
.head 8 -  Return -1
.head 7 -  ! Проверка уникальности файла
.head 7 -  ! Берем имя файла без расширения и 2х последних символов в имени.
.head 7 -  Set strFNameBody = SalStrLeftX( strParsed[9], 6 )
.head 7 +  If NOT SqlPrepareAndExecute ( hSql(), 'select file_id into :nExists from rnbu_in_files
where (substr(file_name,1,6) = :strFNameBody) and
      (init_date = :strParsed[2]) and
      (last_date = :strParsed[3]) and
      (mfo = :strParsed[6])' )
.head 8 -  Call SalWaitCursor( FALSE )
.head 8 -  Call SalFileClose ( inFile )
.head 8 -  Return -1
.head 7 +  If SqlFetchNext ( hSql(), nErr ) AND nExists > 0
.head 8 -  Call SalWaitCursor ( FALSE )
.head 8 +  If SalMessageBox ( 'Файл №' || SalStrMidX ( strParsed[9], 1, 2 ) ||
		' за дату ' || SalStrMidX(strParsed[3], 0, 2) || '/'|| SalStrMidX(strParsed[3], 2, 2) || '/'|| SalStrMidX(strParsed[3], 4, 4) || ' от банка с МФО ' || strParsed[6] ||
		' уже принят. Заменить ?'
, 'Внимание !', MB_YesNo | MB_IconQuestion ) = IDNO
.head 9 -  Set nFileID = nExists
.head 9 -  Call SalFileClose ( inFile )
.head 9 -  Return nFileID  !! Возвращается значение ПК нашего файла :)
.head 8 +  Else
.head 9 -  Call SqlPrepareAndExecute ( hSql (), 'delete from RNBU_IN_INF_RECORDS where file_id = :nExists' )
.head 9 -  Call SaveInfoToLog( 'Замена файла: Удаление детальных записей файла с id = ' || SalNumberToStrX( nExists, 0 ) )
.head 9 -  Call SqlPrepareAndExecute ( hSql (), 'delete from RNBU_IN_FILES where file_id = :nExists' )
.head 9 -  Call SaveInfoToLog( 'Замена файла: Удаление заголовка файла с id = ' || SalNumberToStrX( nExists, 0 ) )
.head 8 -  Call SalWaitCursor ( TRUE )
.head 7 -  ! Запись заголовка
.head 7 -  Call SqlPrepareAndExecute ( hSql (), 'insert into RNBU_IN_FILES (FILE_ID, FILE_KEY, NEXT_DATE, INIT_DATE, LAST_DATE, FORM_DATE, FORM_TIME, MFO, UNIT, INF_ROW_COUNT, FILE_NAME, SPARE1, SPARE2)
	values (0, :strParsed[0], :strParsed[1], :strParsed[2], :strParsed[3], :strParsed[4], :strParsed[5], :strParsed[6], :strParsed[7], :strParsed[8], :strParsed[9], :strParsed[10], :strParsed[11]) ' )
.head 7 +  If SqlPrepareAndExecute( hSql (), 'select S_RNBU_IN_FILES.currval into :nFileID from dual' )
.head 8 -  Call SqlFetchNext ( hSql (), nErr )
.head 6 -  ! Детальные строки
.head 6 -  Call SalFileSeek ( inFile, 252, FILE_SeekBegin )
.head 6 +  While SalFileGetStr ( inFile, strBuffer, 256 )
.head 7 -  Set nStrNum = nStrNum + 1
.head 7 -  Set nStrLen   = SalStrLength ( strBuffer )
.head 7 -  Set strBuffer = StrDosToWinX ( strBuffer )
.head 7 +  If nStrNum > 2
.head 8 +  If SalStrLength( SalStrTrimX( strBuffer )) = 0	! Пустая строка - скипаем.
.head 9 -  Set nStrNum = nStrNum - 1
.head 8 +  Else
.head 9 -  Set i = SalStrTokenize( strBuffer, '', '=', strParsed )
.head 9 +  If i < 1
.head 10 -  Call SalWaitCursor( FALSE )
.head 10 -  Call SalFileClose ( inFile )
.head 10 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Строки]', MB_Ok | MB_IconHand )
.head 10 -  Return -1
.head 9 +  If i < 2	! Для показателя типа "ххххх="
.head 10 -  Set strParsed[1]=' '
.head 9 +  If ( SalStrLeftX ( strParsed[0], 1 ) = '#' ) !  Код МФО или области
.head 10 +  If i = 3
.head 11 -  Set nNBUCode = SalStrToNumber( strParsed[1] || strParsed[2])
.head 10 +  Else
.head 11 -  Set nNBUCode = SalStrToNumber(strParsed[1])
.head 10 +  If GetBankMfo(  ) = '300335' or GetBankMfo(  ) = '380805'
.head 11 -  Set sSqlTxt = T("select count(*) INTO :nVal from V_MFO_NBUC where NBUC='" || SalNumberToStrX(nNBUCode,0) || "'")
.head 11 +  If SqlPrepareAndExecute(hSql(), sSqlTxt)
.head 12 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 12 +  If nVal  = 0
.head 13 -  Call SalWaitCursor( FALSE )
.head 13 -  Call SalFileClose ( inFile )
.head 13 -  Call SalMessageBox ( 'В файле ' || strFileName || ' информация от подразделения, которого нет в справочнике SPR_B040  ('|| SalNumberToStrX(nNBUCode,0)  ||')!'   , 'Ошибка', MB_Ok | MB_IconHand )
.head 13 -  Return -1
.head 10 -  Set nStrNum = nStrNum - 1
.head 9 +  Else
.head 10 -  Call SqlPrepareAndExecute( hSql (),
'insert into RNBU_IN_INF_RECORDS (RECORD_ID, FILE_ID, ISRESIDENT, NBUCODE, PARAMETER, VALUE)
	values (0, :nFileID, :nIsResident, :nNBUCode, :strParsed[0], :strParsed[1])' )
.head 5 +  If nStrNum <= 2 ! Файл был пустой.
.head 6 -  ! Call Debug('Пустой')
.head 6 -  Call SqlPrepareAndExecute( hSql (), 'insert into RNBU_IN_INF_RECORDS (RECORD_ID, FILE_ID, ISRESIDENT, NBUCODE, PARAMETER, VALUE)
	values (0, :nFileID, :nIsResident, :nNBUCode, NULL, NULL )' )
.head 5 -  Call SalFileClose ( inFile )
.head 5 -  Call SqlCommitEx ( hSql(), 'Успешный прием файла отчетности ' || strFileName )
.head 5 -  Call SalWaitCursor ( FALSE )
.head 5 -  Call SalMessageBox ('Файл ' || strFileName || ' принят', 'Сообщение', MB_Ok | MB_IconExclamation)
.head 5 -  Return nFileID
.head 3 +  Function: uf_get_fileheader
.head 4 -  Description: Разобрать заголовок файла отчета
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: strFileName
.head 5 -  Receive String: strHeaderAttr[*]
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  File Handle: inFile
.head 5 -  String: strBuffer
.head 5 -  Number: i
.head 4 +  Actions
.head 5 +  If not SalFileOpen ( inFile, strFileName, OF_Read )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalMessageBox ( 'Ошибка открытия файла ' || strFileName  , 'Ошибка', MB_Ok | MB_IconHand )
.head 6 -  Return FALSE
.head 5 -  ! Служебная строка
.head 5 +  If not SalFileGetStr ( inFile, strBuffer, 256 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Ошибка чтения файла ' || strFileName  , 'Ошибка', MB_Ok | MB_IconHand )
.head 6 -  Return FALSE
.head 5 +  If SalStrLength ( strBuffer ) != 100
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Служебная]', MB_Ok | MB_IconHand )
.head 6 -  Return FALSE
.head 5 -  ! Заголовок
.head 5 +  If not SalFileGetStr ( inFile, strBuffer, 256 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Ошибка чтения файла ' || strFileName  , 'Ошибка', MB_Ok | MB_IconHand )
.head 6 -  Return FALSE
.head 5 +  If (SalStrLeftX(strFileName,1)='#' AND SalStrLength ( strBuffer ) != 148) OR (SalStrLeftX(strFileName,1)='F' AND SalStrLength ( strBuffer ) != 212)
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Заголовок]', MB_Ok | MB_IconHand )
.head 6 -  Return FALSE
.head 5 -  Set i = SalStrTokenize( SalStrUpperX( strBuffer ), '', '=', strHeaderAttr )
.head 5 +  If i < 12
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalFileClose ( inFile )
.head 6 -  Call SalMessageBox ( 'Файл ' || strFileName || ' не соответсвует формату!', 'Ошибка [Заголовок]', MB_Ok | MB_IconHand )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  Call SalFileClose ( inFile )
.head 5 -  Return TRUE
.head 3 +  Function: uf_get_report
.head 4 -  Description: Выбрать номер отчета
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: strTabName
.head 5 -  Receive String: strCode
.head 5 -  Receive String: strSchema
.head 5 -  Receive String: strName
.head 5 -  Number: nMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strC
.head 5 -  String: strS
.head 5 -  String: strN
.head 4 +  Actions
.head 5 +  If SalModalDialog( dlg_GetReportForm, hWndForm, strTabName, strC, strS, strN, nMode )
.head 6 -  Set strCode = strC
.head 6 -  Set strName = strN
.head 6 -  Set strSchema = strS
.head 6 -  Return TRUE
.head 5 +  Else
.head 6 -  Return FALSE
.head 3 +  Function: FunBackUpFile
.head 4 -  Description: Забэкапить файл в подкаталог дня.
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: strSrcFile
.head 5 -  String: strBkpDir
.head 5 -  Boolean: fIn
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strFName
.head 5 -  String: strFExt
.head 5 -  String: strFDrv
.head 5 -  String: strFPath
.head 5 -  !
.head 5 -  String: strBckPath
.head 5 -  String: strDayDir
.head 5 -  String: strDDir
.head 4 +  Actions
.head 5 -  Set strDayDir = SalFmtFormatDateTime( SalDateCurrent( ), 'yyMMdd' )
.head 5 +  If fIn
.head 6 -  Set strDDir = 'In'
.head 5 +  Else
.head 6 -  Set strDDir = 'Out'
.head 5 -  Call VisDosSplitPath( strSrcFile, strFDrv, strFPath, strFName, strFExt )
.head 5 -  Set strBckPath = strBkpDir || '\\' || strDayDir || '\\' || strDDir || '\\' || strFName || strFExt 
.head 5 -  !
.head 5 +  If NOT VisDosExist( strBkpDir || '\\' || strDayDir || '\\' || strDDir )
.head 6 +  If VisDosMakeAllDir( strBkpDir || '\\' || strDayDir || '\\' || strDDir ) != VTERR_Ok
.head 7 -  Call SalMessageBox( 'Невозможно создать каталог копий - ' || 
strBkpDir || '\\' || strDayDir || '\\' || strDDir, 'Ошибка', MB_Ok )
.head 7 -  Call SaveErrorToLog( 'Невозможно создать каталог копий - ' || 
strBkpDir || '\\' || strDayDir || '\\' || strDDir )
.head 7 -  Return FALSE
.head 5 +  If SalFileCopy( strSrcFile, strBckPath, TRUE ) != FILE_CopyOK
.head 6 -  Call SalMessageBox( 'Невозможно скопировать файл из ' || strSrcFile || ' в ' || strBckPath, 'Ошибка', MB_Ok )
.head 6 -  Call SaveErrorToLog( 'Невозможно скопировать файл из ' || strSrcFile || ' в ' || strBckPath )
.head 6 -  Return FALSE
.head 5 -  Call SaveInfoToLog( 'Файл ' || strSrcFile || ' перемещен в архив дня ' || strBckPath )
.head 5 -  Return TRUE
.head 3 -  !
.head 3 -  ! By Eve
.head 3 +  Function: ShowVQB	     	! __exported
.head 4 -  Description: Запуск визуального построителя запросов
и передача параметров соединения
.head 4 -  Returns
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  : cParamsFetcher
.head 6 -  Class: cABSConnect
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Call XConnectGetParams( cParamsFetcher )
.head 5 -  Call SaveInfoToLog( 'Запущен визуальный построитель запросов' )
.head 5 -  Call SalLoadApp( 'vqb.exe', GetDBMS() || ' ' || cParamsFetcher.strDBName || ' ' ||
cParamsFetcher.strUserName || ' ' || cParamsFetcher.strPassword )
.head 5 -  ! Call SalCreateWindow( frm_Debug, hWndMDI )
.head 3 -  ! Експорт Запроса в *.dbf файл
.head 3 +  Function: ExportToDbf
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Имя таблицы
.head 5 -  Receive String: sTable
.head 5 -  ! <Не обязательный параметр>
.head 5 -  ! Часть SQL`я создания таблицы, содержащая список полей и их типы данных
.head 5 -  ! для экспорта в заданную структуру (без скобок)
.head 5 -  String: sCreateList
.head 5 -  ! Перекодировка в DOS
.head 5 -  Boolean: fTo_DOS
.head 5 -  ! Показывать диалоги: запрос на удаление, окно результата 
.head 5 -  Boolean: fShow_Dialogs
.head 5 -  ! Удалять существующий файл (или дописывать)
.head 5 -  Boolean: fDelete_Old
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 +  ! Промежуточные Бинд-переменные
.head 6 -  ! String: sBind[50]
.head 6 -  ! Number: nBind[50]
.head 6 -  ! Date/Time: dBind[50]
.head 5 -  ! SQL Выражения
.head 5 -  String: sCreate
.head 5 -  String: sCreate1
.head 5 -  String: sSelect
.head 5 -  String: sInsert
.head 5 -  String: sInsert1
.head 5 -  ! Путь к файлу
.head 5 -  String: sPath
.head 5 -  ! Создавать ли файл *.dbf для экспорта или дописать в имеющийся
.head 5 -  Boolean: bCreaFile
.head 5 -  ! Целевой SQL
.head 5 -  Sql Handle: hSqlExp
.head 5 -  ! Удалить, Сохранить, Выйти 
.head 5 -  Number: YNC
.head 5 -  ! Кол-во добавленных записей 
.head 5 -  Number: nRecCount
.head 5 -  ! End-Of-Line
.head 5 -  String: sEOL
.head 5 -  ! Temporary
.head 5 -  Number: nExpFetchRes
.head 5 -  Date/Time: dTmp
.head 5 -  Number: j
.head 5 -  !
.head 5 -  String: tDrive
.head 5 -  String: tDir
.head 5 -  String: tBase
.head 5 -  String: tExt
.head 5 -  ! Имя табл. для создания
.head 5 -  String: sCreateTable
.head 5 -  !
.head 5 -  File Handle: hFileTemp
.head 4 +  Actions
.head 5 -  ! Общие положения:
1) драйвера ODBC - Centura DBASE drivers не могут создавать и 
удалять dbf`ы с расширением не dbf
2) а вставлять могут...
.head 5 -  ! Init VAR
.head 5 -  Set sCatQueryResult=''
.head 5 -  Set fRtf=FALSE
.head 5 -  Set sEOL=SalNumberToChar( 13 ) || SalNumberToChar( 10 )
.head 5 -  ! Получаема каталог экспорта
.head 5 +  If SalStrScan( sTable, ':' ) != -1 OR SalStrScan( sTable, '.' ) != -1
.head 6 -  ! Если задан полный путь или расширение
.head 6 -  Call VisDosSplitPath( sTable, tDrive, tDir, tBase, tExt )
.head 6 -  Set sPath=tDrive || tDir
.head 6 +  If NOT sPath
.head 7 -  Set sPath=GetPrnDir()
.head 6 +  If tExt!='.'
.head 7 -  Set sTable=tBase || tExt
.head 6 +  Else
.head 7 -  ! Меняем расширение на dbf, если оно не указано явно
.head 7 -  Set sTable=tBase || '.dbf'
.head 6 -  Set sCreateTable=tBase
.head 5 +  Else
.head 6 -  ! Если задан только файл
.head 6 -  Set sPath=GetPrnDir()
.head 6 -  Set sCreateTable=sTable
.head 5 -  ! Подготавливаем выражение
.head 5 +  If NOT SqlPrepare( hSqlImp, sSqlStmt  )
.head 6 -  Call MessageAttention('Не могу подготовить SQL:' || sSqlStmt )
.head 5 -  ! Создаем выражение на СОЗДАНИЕ
.head 5 -  Call SqlGetAllStatements( hSqlImp, sCreateTable, RDBMS_dBase, sCreate, sSelect, sInsert1 )
.head 5 -  ! Создаем выражение на ВСТАВКУ
.head 5 -  Call SqlGetAllStatements( hSqlImp, sTable, RDBMS_dBase, sCreate1, sSelect, sInsert )
.head 5 +  If sCreateList
.head 6 -  Set sCreate='CREATE TABLE ' || sCreateTable || '(' || sCreateList || ')'
.head 5 -  ! Устанавливаем текущий каталог
.head 5 +  If SalFileSetCurrentDirectory(sPath)
.head 6 -  Set SqlDatabase='dBase_Files'
.head 6 -  ! Соединяемся
.head 6 +  If SqlConnect(hSqlExp) 
.head 7 +  Loop
.head 8 -  Set bCreaFile=TRUE
.head 8 -  ! Проверяем наличие файла
.head 8 +  If SalFileGetDateTime(sPath || '\\' || sTable, dTmp) !! уже существует
.head 9 +  If fDelete_Old
.head 10 -  Set YNC=IDYES
.head 9 +  Else
.head 10 -  Set YNC=IDNO
.head 9 +  If fShow_Dialogs
.head 10 -  Set YNC=SalMessageBox("Удалить данные ?","Файл "|| sTable ||" уже существует !", MB_YesNoCancel | MB_IconHand )
.head 9 +  If YNC=IDNO     !! NO     - Дописать файл
.head 10 -  Set bCreaFile=FALSE
.head 9 +  If YNC=IDCANCEL !! CANCEL - Выйти
.head 10 -  Break
.head 9 +  If YNC=IDYES    !! YES    - Удалить данные 
.head 10 +  When SqlError
.head 11 -  Call SqlDisconnect(hSqlExp)
.head 11 -  Return FALSE
.head 10 +  If sCreateTable!=sTable
.head 11 +  If SalFileGetDateTime(sPath || '\\' || sTable, dTmp) !! файл существует
.head 12 -  ! Удаляем на...
.head 12 -  Call VisFileDelete( sPath || '\\' || sTable )
.head 10 +  Else
.head 11 -  Call SqlPrepareAndExecute(hSqlExp,'DROP TABLE "'|| sTable || '"' )
.head 11 -  Call SqlClose(hSqlExp)
.head 8 -  ! Создает файл если нужно
.head 8 +  If bCreaFile
.head 9 +  If SalFileGetDateTime(sPath || '\\' || sCreateTable || '.dbf', dTmp) !! dbf существует
.head 10 -  ! Удаляем на...
.head 10 -  Call VisFileDelete( sPath || '\\' || sCreateTable || '.dbf' )
.head 9 +  If SqlPrepareAndExecute(hSqlExp, sCreate )
.head 10 -  Call SqlClose(hSqlExp)
.head 10 +  If sCreateTable!=sTable
.head 11 -  Call VisFileRename( sPath || '\\' || sCreateTable || '.dbf', sPath || '\\' || sTable )
.head 9 +  Else
.head 10 -  Call SqlDisconnect(hSqlExp)
.head 10 -  Return FALSE
.head 8 +  If SqlPrepareAndExecute( hSqlImp, sSqlStmt )
.head 9 -  Set nRecCount=0
.head 9 +  While SqlFetchNext( hSqlImp, nExpFetchRes ) AND nExpFetchRes=FETCH_Ok
.head 10 +  If fTo_DOS
.head 11 -  Set j=0
.head 11 +  While j<50
.head 12 +  If sBind[j]
.head 13 -  Set sBind[j]=StrWinToDosX( sBind[j] )
.head 12 -  Set j=j+1
.head 10 +  If NOT SqlPrepareAndExecute( hSqlExp, sInsert )
.head 11 -  Call SqlDisconnect(hSqlExp)
.head 11 -  Return FALSE
.head 10 -  Call SqlClose(hSqlExp)
.head 10 -  Set nRecCount=nRecCount+1
.head 9 +  ! If fShow_Dialogs
.head 10 -     Call SalMessageBox( "Выгрузка в " || sPath ||"\\"|| sTable 
|| " завершена! " || sEOL || 
SalNumberToStrX( nRecCount, 0 )|| " записей добавлено.", "Экспорт", MB_Ok)
.head 9 -  Call SaveInfoToLog('Выгрузка кат. запроса в '|| sTable || ' завершена!')
.head 9 -  Set sTable=sPath || '\\' || sTable
.head 9 -  Set sCatQueryResult=''
.head 8 +  Else
.head 9 -  Call MessageAttention('SQL вырадение не может быть выполненно: ' || sSqlStmt)
.head 8 -  Break
.head 7 -  Call SqlDisconnect(hSqlExp)
.head 6 +  Else
.head 7 -  Call MessageAttention('Ошибка подсоединения к Базе данных:'|| SqlDatabase)
.head 5 +  Else
.head 6 -  Call MessageAttention('Нет каталога: ' ||   sPath)
.head 5 -  Call SalWaitCursor(FALSE)
.head 3 -  !
.head 3 -  ! Выгрузка в файл для DotNet
.head 3 +  Function: ExportToReport
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! hWnd окна обработчика сообщений отчета
.head 5 -  Window Handle: hMessageWind
.head 5 -  ! Имя файла шаблона отчета
.head 5 -  String: sTemplate
.head 5 -  ! Имя целевого файла
.head 5 -  Receive String: sDestFile
.head 5 -  ! В формате RTF
.head 5 -  Boolean: IsRtf
.head 5 -  ! Показывать сообщение
.head 5 -  Boolean: fShowMes
.head 5 -  ! Флаг Удалять пустые строки
.head 5 -  Boolean: bDeleteNullString
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  ! Создавать ли файл *.dbf для экспорта или дописать в имеющийся
.head 5 -  Boolean: bCreaFile
.head 5 -  ! Temporary
.head 5 -  Number: nReportRes
.head 5 -  String: sBindVars
.head 5 -  String: sReportVars
.head 5 -  ! File
.head 5 -  File Handle: hFile
.head 5 -  Number: nPrintFlags
.head 4 +  Actions
.head 5 +  If not SalFileOpen(hFile, sTemplate, OF_Exist)
.head 6 +  If fDotNetMode
.head 7 -  Set nExitCode = 7
.head 6 +  Else
.head 7 -  ! Call SalMessageBox('Файл шаблона отчета не существует!' || sTemplate, 'Ошибка', MB_Ok | MB_IconStop)
.head 7 -  Call MessageNoWait('Файл шаблона отчета не существует!' || sTemplate, 'Ошибка', 60, 1)
.head 6 -  Return FALSE
.head 5 -  Set sCatQueryResult = ''
.head 5 -  ! Подготавливаем выражение
.head 5 +  If not SqlPrepare(hSqlImp, sSqlStmt)
.head 6 +  If fDotNetMode
.head 7 -  Set nExitCode = 8
.head 6 +  Else
.head 7 -  Call MessageAttention('Не могу подготовить SQL:' || sSqlStmt)
.head 5 -  ! Создаем списки переменных
.head 5 -  Call SqlGetReportVarList(hSqlImp, sBindVars, sReportVars)
.head 5 -  ! Если файл без полного пути кидаем его в каталог печати
.head 5 +  If not fDotNetMode
.head 6 -  Set sDestFile = PrepareFileName(sDestFile)
.head 5 +  Loop
.head 6 +  If SqlPrepareAndExecute(hSqlImp, sSqlStmt)
.head 7 -  Set nReportRes = 1
.head 7 +  If IsRtf and not fDotNetMode
.head 8 -  Set sDestFile = SubstExt(sDestFile, 'rtf', TRUE)
.head 7 -  Set nRowCount = 0
.head 7 -  Set nPrintFlags = RPT_PrintAll
.head 7 +  If fDotNetMode
.head 8 -  Set nPrintFlags = nPrintFlags | RPT_PrintNoErrors
.head 7 +  If SalReportPrintToFile(hMessageWind, sTemplate, sDestFile, sBindVars, sReportVars, 1, nPrintFlags, 1, 1, IsRtf,
   nReportRes)
.head 8 -  Set sCatQueryResult = sDestFile
.head 8 +  If not IsRtf 
.head 9 +  If fDotNetMode
.head 10 -  Call DeleteBadSymbols(sDestFile, '', TRUE, bDeleteNullString)
.head 9 +  Else
.head 10 -  Call zarez12Del(sDestFile, NUMBER_Null, '', bDeleteNullString)
.head 8 -  Set fRtf = IsRtf
.head 8 +  If fShowMes
.head 9 -  ! Call SalMessageBox('Выгрузка кат. запроса в ' || sCatQueryResult || ' завершена!' , 'Экспорт',
  MB_Ok | MB_IconAsterisk)
.head 9 -  ! Call MessageNoWait('Выгрузка кат. запроса в ' || sCatQueryResult || ' завершена!' , 'Экспорт', 60, 0)
.head 8 -  ! ! - если файл создался но данных нету - удалим файл
.head 8 +  If nRowCount = 0 and VisFileFind(sDestFile)
.head 9 +  If VisFileDelete(sDestFile) < 0 and not fDotNetMode
.head 10 -  ! Call SalMessageBox('Не могу удалить файл нулевой длинны - ' || sDestFile, 'Внимание', 0)
.head 10 -  Call MessageNoWait('Не могу удалить файл нулевой длинны - ' || sDestFile, 'Внимание', 60, 1)
.head 10 -  Break
.head 8 -  Break
.head 7 +  Else
.head 8 +  If fDotNetMode
.head 9 -  Set nExitCode = 100 + nReportRes
.head 8 +  Else
.head 9 -  ! Call SalMessageBox('Ошибка #' || SalNumberToStrX(nReportRes, 0) , 'Экспорт', MB_Ok | MB_IconStop)
.head 9 -  Call MessageNoWait('Ошибка #' || SalNumberToStrX(nReportRes, 0) , 'Экспорт', 60, 1)
.head 9 -  Return FALSE
.head 6 +  Else
.head 7 +  If fDotNetMode
.head 8 -  Set nExitCode = 9
.head 7 +  Else
.head 8 -  Call MessageAttention('SQL выражение не может быть выполненно: ' || sSqlStmt)
.head 6 -  !
.head 6 -  Break
.head 5 -  Return TRUE
.head 3 -  !
.head 3 -  ! (ANNY) Ескпорт в текст. файл с разделителями 
.head 3 +  Function: ExportToTxtDelim
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSql
.head 5 -  ! Исходный SQL
.head 5 -  Long String: lsSqlStmt
.head 5 -  ! Строка описания полей
.head 5 -  Long String: lsFieldDesc
.head 5 -  ! Имя файла экспорта
.head 5 -  String: sDBFileName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  : cColDesc[200]
.head 6 -  Class: cColumnDelimDescriptor
.head 5 -  Number: nCols
.head 5 -  Number: i
.head 5 -  Number: nRow
.head 5 -  Long String: lsPreparedStmt
.head 5 -  Long String: lsFileLine
.head 5 -  !
.head 5 -  Number: nError
.head 5 -  Number: nErrorPos
.head 5 -  Number: nReturn
.head 5 -  Date/Time: dReturn
.head 5 -  Window Handle: hWndReturn
.head 5 -  String: strContext
.head 5 -  String: strDelimeter
.head 5 -  File Handle: hFileIn
.head 5 -  String: sErrMsg
.head 4 +  Actions
.head 5 -  ! Откроем файл для записи
.head 5 -  ! SalFileOpen ( hFileIn, sDBFileName, OF_Write )
.head 5 +  If not  SalFileOpen ( hFileIn, sDBFileName, OF_Write )
.head 6 -  ! SalFileOpen ( hFileIn, 'D:\BARS98\PRINT\txt.txx'sDBFileName, OF_Write )
.head 6 -  Call SalMessageBox(' Невозможно открыть для записи файл '|| sDBFileName, 'Внимание!',0)
.head 6 -  Call SalWaitCursor (FALSE )
.head 6 -  Return -1
.head 5 -  Set nCols = SqlDescribe( hSql, cColDesc )
.head 5 -  Call SqlCorrectColumnName( nCols, cColDesc )
.head 5 +  If GetColsDelimDescription(cColDesc, nCols, lsFieldDesc, strDelimeter, sErrMsg)<0
.head 6 -  Call SalMessageBox(sErrMsg, 'Внимание', MB_Ok|MB_IconStop)
.head 6 -  Return -1
.head 5 -  ! Подготовим строку для выгрузки в текстовый файл
! 
.head 5 -  !
.head 5 -  ! Call Debug (cColDesc[1].toString())
.head 5 -  ! Call Debug (cColDesc[2].toString())
.head 5 -  ! Call Debug (cColDesc[3].toString())
.head 5 -  ! Call Debug (cColDesc[4].toString())
.head 5 -  ! Call Debug (cColDesc[5].toString())
.head 5 -  ! Call Debug (cColDesc[6].toString())
.head 5 -  Set lsPreparedStmt = SqlGetStatement("'"||strDelimeter||"'",cColDesc,nCols,'SELECT_DELIM')
.head 5 -  ! Выполняем сам запрос
.head 5 +  If SqlPrepareAndExecute( hSql, lsSqlStmt )
.head 6 +  While SqlFetchNext( hSql, nRow ) AND nRow=FETCH_Ok
.head 7 -  Set strContext=SalContextCurrent()
.head 7 -  ! Получим форматированную строку для файла
.head 7 -  ! Call Debug('Before Evaluate sBind[0]=' || sBind[0] || '  lsPreparedStmt=' || lsPreparedStmt)
.head 7 +  If SalCompileAndEvaluate( lsPreparedStmt, nError, nErrorPos, nReturn, 
                          lsFileLine, dReturn, hWndReturn, FALSE, strContext )= EVAL_String
.head 8 -  Call SalFilePutStr ( hFileIn,  lsFileLine )
.head 5 +  Else
.head 6 -  Call MessageAttention('SQL вырадение не может быть выполненно: ' || lsSqlStmt)
.head 6 -  Return -1
.head 5 -  ! закроем файл экспорта
.head 5 +  If not SalFileClose ( hFileIn )
.head 6 -  Call SalMessageBox(' Не возможно закрыть файл '||sDBFileName, 'Внимание!',0)
.head 6 -  Call SalWaitCursor (FALSE )
.head 6 -  Return -1
.head 3 -  !
.head 3 -  !
.head 3 +  Function: LoadDBFfile
.head 4 -  Description: Загрузить файл в переменную пакета bars_dbf.G_EXCH_BLOB
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  ! SQL соединение
.head 5 -  Sql Handle: hSqlHandle
.head 5 -  ! Имя файла загружаемого в БД
.head 5 -  String: strFileName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  ! Файл
.head 5 -  File Handle: hFile
.head 5 -  ! Ошибка при открытии файла
.head 5 -  Number: nErrCode
.head 5 -  ! Буфер чтения файла
.head 5 -  Long String: sBuffer
.head 5 -  ! Максимальный размер буфера (3999)
.head 5 -  Number: nBufferSize
.head 5 -  ! Количество прочитанных байт
.head 5 -  Number: nBytesRead
.head 4 +  Actions
.head 5 -  ! Это максимальный теоритический предел для вставки в БД
.head 5 -  Set nBufferSize = 3999
.head 5 -  ! Здесь мы удаляем даные из временной таблицы
.head 5 -  ! Открываем файл для чтения
.head 5 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary | OF_Read)
.head 5 +  If nErrCode
.head 6 -  Call MessageError('Не удалось открыть файл ' || strFileName)
.head 6 -  Return FALSE
.head 5 -  ! В цикле по частям вычитываем файл и складываем его во временую таблицу БД
.head 5 +  Loop
.head 6 +  If SalStrSetBufferLength(sBuffer, nBufferSize+1)
.head 7 -  Set nBytesRead = VisFileRead(hFile, sBuffer, nBufferSize)
.head 7 -  Call SalStrSetBufferLength(sBuffer, nBytesRead+1)
.head 7 +  If nBytesRead
.head 8 +  If not SqlPLSQLCommand(hSql(),"bars_dbf.set_buffer(sBuffer)")
.head 9 -  Call SalMessageBox( 'Ошибка импорта DBF файла', '', MB_Ok | MB_IconAsterisk )
.head 9 -  Call SqlRollback(hSqlHandle)
.head 9 -  Return FALSE
.head 8 +  If nBytesRead < nBufferSize
.head 9 -  Break
.head 7 +  Else
.head 8 -  Break
.head 6 +  Else
.head 7 -  Return FALSE
.head 5 -  ! Закрываем файл
.head 5 -  Call VisFileClose(hFile)
.head 5 -  ! Сохраняем изменения
.head 5 -  Call SqlCommit(hSqlHandle)
.head 5 -  Return TRUE
.head 3 +  Function: DownloadDBFfile
.head 4 -  Description: Выгрузить в файл значение переменной пакета bars_dbf, которая содержит текст DBF файла
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  ! SQL соединение
.head 5 -  Sql Handle: hSqlHandle
.head 5 -  ! Имя файла загружаемого в БД
.head 5 -  String: strFileName
.head 5 -  ! Дозаписать файл или создать новый (OF_Create  или OF_Append)
.head 5 -  Number: nFileOpenMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  ! Файл
.head 5 -  File Handle: hFile
.head 5 -  ! Ошибка при открытии файла
.head 5 -  Number: nErrCode
.head 5 -  ! Буфер чтения файла
.head 5 -  Long String: sBuffer
.head 5 -  ! Максимальный размер буфера
.head 5 -  Number: nBufferSize
.head 5 -  ! Начало чтения буфера
.head 5 -  Number: nOffset
.head 5 -  ! Количество байт в LOBе
.head 5 -  Number: nLobSize
.head 5 -  ! Количество байт, записанное в файл
.head 5 -  Number: nBytesWrote
.head 4 +  Actions
.head 5 -  ! Это максимальный теоритический предел
.head 5 -  Set nBufferSize = 3999
.head 5 -  Set nOffset = 1
.head 5 -  !
.head 5 -  !
.head 5 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary |OF_Share_Deny_Read|nFileOpenMode)
.head 5 +  If (nFileOpenMode = OF_Append and nErrCode = -2)  ! файла еще нету - создать
.head 6 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary | OF_Create)
.head 5 +  If nErrCode
.head 6 -  Call SalMessageBox( 'Ошибка открытия файла: '||SalNumberToStrX(nErrCode,0), '', MB_Ok | MB_IconAsterisk )
.head 6 -  Call SqlRollback(hSqlHandle)
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 -  ! В цикле по частям вычитываем файл
.head 6 +  Loop
.head 7 +  If SalStrSetBufferLength(sBuffer, nBufferSize+1)
.head 8 +  If SqlPLSQLCommand(hSqlHandle,"bars_dbf.get_buffer(sBuffer, nLobSize, nOffset, nBufferSize )")
.head 9 +  If nLobSize = 0
.head 10 -  ! Call Debug('Следующий кусок - пустой')
.head 10 -  Break
.head 9 -  ! Call Debug('Кусок размером в ' || SalNumberToStrX(nLobSize, 0))
.head 9 -  Set nBytesWrote = VisFileWrite(hFile, sBuffer, nLobSize)
.head 8 +  Else
.head 9 -  Call SalMessageBox( 'Невозможно выполнить процедуру bars_dbf.get_buffer', '', MB_Ok | MB_IconAsterisk )
.head 9 -  Call SqlRollback(hSqlHandle)
.head 9 -  Return FALSE
.head 7 +  Else
.head 8 -  Call SalMessageBox( 'Невозможно установить размер буффера', '', MB_Ok | MB_IconAsterisk )
.head 8 -  Call SqlRollback(hSqlHandle)
.head 8 -  Return FALSE
.head 7 -  Set nOffset = nOffset + nBufferSize
.head 5 -  ! Закрываем файл
.head 5 -  Call VisFileClose(hFile)
.head 5 -  Return TRUE
.head 3 +  Function: DownloadXMLfile
.head 4 -  Description: Выгрузить в файл значение переменной пакета bars_report.G_RESULT_CLOB, 
которая содержит текст XML файла
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  ! SQL соединение
.head 5 -  Sql Handle: hSqlHandle
.head 5 -  ! Имя файла 
.head 5 -  String: strFileName
.head 5 -  ! Дозаписать файл или создать новый (OF_Create  или OF_Append)
.head 5 -  Number: nFileOpenMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  ! Файл
.head 5 -  File Handle: hFile
.head 5 -  ! Ошибка при открытии файла
.head 5 -  Number: nErrCode
.head 5 -  ! Буфер чтения файла
.head 5 -  Long String: sBuffer
.head 5 -  ! Максимальный размер буфера
.head 5 -  Number: nBufferSize
.head 5 -  ! Начало чтения буфера
.head 5 -  Number: nOffset
.head 5 -  ! Количество байт в LOBе
.head 5 -  Number: nLobSize
.head 5 -  ! Количество байт, записанное в файл
.head 5 -  Number: nBytesWrote
.head 4 +  Actions
.head 5 -  ! Это максимальный теоритический предел
.head 5 -  Set nBufferSize = 2000
.head 5 -  Set nOffset = 1
.head 5 -  !
.head 5 -  !
.head 5 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary | nFileOpenMode)
.head 5 +  If (nFileOpenMode = OF_Append and nErrCode = -2)  ! файла еще нету - создать
.head 6 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary | OF_Create)
.head 5 +  If nErrCode
.head 6 -  Call SalMessageBox( 'Ошибка открытия файла: '||SalNumberToStrX(nErrCode,0), '', MB_Ok | MB_IconAsterisk )
.head 6 -  Call SqlRollback(hSqlHandle)
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 -  ! В цикле по частям вычитываем файл
.head 6 +  Loop
.head 7 +  If SalStrSetBufferLength(sBuffer, nBufferSize+1)
.head 8 +  If SqlPLSQLCommand(hSqlHandle,"bars_report.get_buffer(sBuffer, nLobSize, nOffset, nBufferSize )")
.head 9 +  If nLobSize = 0
.head 10 -  ! Call Debug('Следующий кусок - пустой')
.head 10 -  Break
.head 9 -  ! Call Debug('Кусок размером в ' || SalNumberToStrX(nLobSize, 0))
.head 9 -  Set nBytesWrote = VisFileWrite(hFile, sBuffer, nLobSize)
.head 8 +  Else
.head 9 -  Call SalMessageBox( 'Невозможно выполнить процедуру bars_dbf.get_buffer', '', MB_Ok | MB_IconAsterisk )
.head 9 -  Call SqlRollback(hSqlHandle)
.head 9 -  Return FALSE
.head 7 +  Else
.head 8 -  Call SalMessageBox( 'Невозможно установить размер буффера', '', MB_Ok | MB_IconAsterisk )
.head 8 -  Call SqlRollback(hSqlHandle)
.head 8 -  Return FALSE
.head 7 -  Set nOffset = nOffset + nBufferSize
.head 5 -  ! Закрываем файл
.head 5 -  Call VisFileClose(hFile)
.head 5 -  Return TRUE
.head 3 +  Function: DownloadBLOBfile
.head 4 -  Description: Выгрузить в файл значение переменной пакета bars_report.G_RESULT_BLOB, 
которая содержит BLOB результат
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  ! SQL соединение
.head 5 -  Sql Handle: hSqlHandle
.head 5 -  ! Имя файла 
.head 5 -  String: strFileName
.head 5 -  ! Дозаписать файл или создать новый (OF_Create  или OF_Append)
.head 5 -  Number: nFileOpenMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  ! Файл
.head 5 -  File Handle: hFile
.head 5 -  ! Ошибка при открытии файла
.head 5 -  Number: nErrCode
.head 5 -  ! Буфер чтения файла
.head 5 -  Long String: sBuffer
.head 5 -  ! Максимальный размер буфера
.head 5 -  Number: nBufferSize
.head 5 -  ! Начало чтения буфера
.head 5 -  Number: nOffset
.head 5 -  ! Количество байт в LOBе
.head 5 -  Number: nLobSize
.head 5 -  ! Количество байт, записанное в файл
.head 5 -  Number: nBytesWrote
.head 4 +  Actions
.head 5 -  ! Это максимальный теоритический предел
.head 5 -  Set nBufferSize = 2000
.head 5 -  Set nOffset = 1
.head 5 -  !
.head 5 -  !
.head 5 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary | nFileOpenMode)
.head 5 +  If (nFileOpenMode = OF_Append and nErrCode = -2)  ! файла еще нету - создать
.head 6 -  Set nErrCode = VisFileOpen(hFile, strFileName, OF_Binary | OF_Create)
.head 5 +  If nErrCode
.head 6 -  Call SalMessageBox( 'Ошибка открытия файла: '||SalNumberToStrX(nErrCode,0), '', MB_Ok | MB_IconAsterisk )
.head 6 -  Call SqlRollback(hSqlHandle)
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 -  ! В цикле по частям вычитываем файл
.head 6 +  ! If NOT SqlSetLongBindDatatype(1, BLOB_BYTE)
.head 7 -     Return FALSE
.head 6 +  Loop
.head 7 +  If SalStrSetBufferLength(sBuffer, nBufferSize+1)
.head 8 +  If SqlPLSQLCommand(hSqlHandle,"bars_report.get_blob_buffer(sBuffer, nLobSize, nOffset, nBufferSize )")
.head 9 +  If nLobSize = 0
.head 10 -  ! Call Debug('Следующий кусок - пустой')
.head 10 -  Break
.head 9 -  ! Call Debug('Кусок размером в ' || SalNumberToStrX(nLobSize, 0))
.head 9 -  Set nBytesWrote = VisFileWrite(hFile, sBuffer, nLobSize)
.head 8 +  Else
.head 9 -  Call SalMessageBox( 'Невозможно выполнить процедуру bars_report.get_blob_buffer', '', MB_Ok | MB_IconAsterisk )
.head 9 -  Call SqlRollback(hSqlHandle)
.head 9 -  Return FALSE
.head 7 +  Else
.head 8 -  Call SalMessageBox( 'Невозможно установить размер буффера', '', MB_Ok | MB_IconAsterisk )
.head 8 -  Call SqlRollback(hSqlHandle)
.head 8 -  Return FALSE
.head 7 -  Set nOffset = nOffset + nBufferSize
.head 6 +  ! If SqlPrepare(hSqlHandle, 'SELECT '||strDataLen||','||strDataField ||' INTO :nLobSize, :sBuffer FROM TMP_LOB ORDER BY ID')
.head 7 +     If strSelector='B'
.head 8 +     If NOT SqlSetLongBindDatatype(2, BLOB_BYTE)
.head 9 -     Return FALSE
.head 7 +     Else If strSelector='C'
.head 8 +     If NOT SqlSetLongBindDatatype(2, BLOB_TEXT)
.head 9 -     Return FALSE
.head 7 -  !
.head 7 +     If SqlExecute(hSqlHandle)
.head 8 +     Loop 
.head 9 +     If SalStrSetBufferLength(sBuffer, nBufferSize+1)
.head 10 +     If SqlFetchNext(hSqlHandle, nFetchRes)
.head 11 -     Set nBytesWrote = VisFileWrite(hFile, sBuffer, nLobSize)
.head 10 +     Else 
.head 11 -     Break 
.head 9 +     Else 
.head 10 -  Call Debug('SalStrSetBufferLength - ailed')
.head 10 -     Return FALSE
.head 7 +     Else 
.head 8 -     Call SqlRollback(hSqlHandle)
.head 8 -     Return FALSE
.head 5 -  ! Закрываем файл
.head 5 -  Call VisFileClose(hFile)
.head 5 -  Return TRUE
.head 3 -  ! (ANNY) Ескпорт в DBF файл без dbase Centura driver (пакет bars_dbf) текст.
.head 3 +  Function: ExportToDbfBars
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Имя исходящего dbf файла
.head 5 -  Receive String: sDbfFileName
.head 5 -  ! <Не обязательный параметр>
.head 5 -  ! Часть SQL`я создания таблицы, содержащая список полей и их типы данных
.head 5 -  ! для экспорта в заданную структуру (без скобок)
.head 5 -  String: sCreateList
.head 5 -  ! Перекодировка в DOS
.head 5 -  Number: nExpFormat
.head 5 -  !
.head 5 -  ! Формировать ли файлы, если нету дннных (0-нет не содавать, 1-слздавать)
.head 5 -  Number: nCreateEmptyFiles
.head 5 -  !
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 +  ! Промежуточные Бинд-переменные
.head 6 -  ! String: sBind[50]
.head 6 -  ! Number: nBind[50]
.head 6 -  ! Date/Time: dBind[50]
.head 5 -  ! SQL Выражения
.head 5 -  ! Путь к файлу
.head 5 -  String: sPath
.head 5 -  ! Целевой SQL
.head 5 -  Sql Handle: hSqlExp
.head 5 -  !
.head 5 -  String: tDrive
.head 5 -  String: tDir
.head 5 -  String: tBase
.head 5 -  String: tExt
.head 5 -  File Handle: hFileTemp
.head 5 -  ! String: sTableName
.head 5 -  ! String: sWhereClause
.head 5 -  String: sEncode
.head 5 -  ! Number: nFromClausePos
.head 5 -  ! Number: nWhereClausePos
.head 5 -  Number: nSelectedRowsCount
.head 5 -  !
.head 4 +  Actions
.head 5 -  Call SalWaitCursor(TRUE)
.head 5 -  ! Получаема каталог экспорта
.head 5 +  If SalStrScan( sDbfFileName, ':' ) != -1 OR SalStrScan( sDbfFileName, '.' ) != -1
.head 6 -  ! Если задан полный путь или расширение
.head 6 -  Call VisDosSplitPath( sDbfFileName, tDrive, tDir, tBase, tExt )
.head 6 -  Set sPath=tDrive || tDir
.head 6 +  If NOT sPath
.head 7 -  Set sPath=GetPrnDir()
.head 6 +  If tExt!='.'
.head 7 -  Set sDbfFileName=tBase || tExt
.head 6 +  Else
.head 7 -  ! Меняем расширение на dbf, если оно не указано явно
.head 7 -  Set sDbfFileName=tBase || '.dbf'
.head 5 +  Else
.head 6 -  ! Если задан только файл
.head 6 -  Set sPath=GetPrnDir()
.head 5 -  !
.head 5 +  Select Case nExpFormat
.head 6 +  Case EXP_DBF_DOS
.head 7 -  Set sEncode='DOS'
.head 7 -  Break
.head 6 +  Case EXP_DBF_WIN
.head 7 -  Set sEncode='WIN'
.head 7 -  Break
.head 6 +  Case EXP_DBF_UKG
.head 7 -  Set sEncode='UKG'
.head 7 -  Break
.head 6 +  Default
.head 7 -  Break
.head 5 -  !
.head 5 -  !
.head 5 -  ! Выгрузить тектс дбф в переменную
.head 5 +  If not SqlPLSQLCommand(hSql(),"bars_dbf.dbf_from_sqldesc(sSqlStmt, sCreateList, sEncode)")
.head 6 -  Call SalMessageBox( 'Ошибка формирования DBF файла', '', MB_Ok | MB_IconAsterisk )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  ! Получитькол-во выбранных строк
.head 5 +  If not SqlPLSQLCommand(hSql(),"bars_dbf.get_exported_rowscount(nSelectedRowsCount)")
.head 6 -  Call SalMessageBox('Ошибка получения кол-ва выбранных данных','Внимание!',MB_Ok|MB_IconAsterisk)
.head 5 -  !
.head 5 -  ! ! выгрузка переменной пакета bars_dbf в файл
.head 5 +  If nSelectedRowsCount > 0 OR nCreateEmptyFiles=1
.head 6 +  If not DownloadDBFfile(hSql(), sPath || '\\' || sDbfFileName, OF_Create)
.head 7 -  Call SalMessageBox( 'Ошибка выгрузки данных в файл', '', MB_Ok | MB_IconAsterisk )
.head 7 -  Return FALSE
.head 5 -  !
.head 5 -  Call SalWaitCursor(FALSE)
.head 3 -  ! (ANNY) Ескпорт в двоичный файл Из типа BLOB
.head 3 +  Function: ExportToBLOBFile
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Имя исходящего файла
.head 5 -  Receive String: sFileName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 +  ! Промежуточные Бинд-переменные
.head 6 -  ! String: sBind[50]
.head 6 -  ! Number: nBind[50]
.head 6 -  ! Date/Time: dBind[50]
.head 5 -  ! SQL Выражения
.head 5 -  ! Путь к файлу
.head 5 -  String: sPath
.head 5 -  ! Целевой SQL
.head 5 -  Sql Handle: hSqlExp
.head 5 -  !
.head 5 -  String: tDrive
.head 5 -  String: tDir
.head 5 -  String: tBase
.head 5 -  String: tExt
.head 5 -  File Handle: hFileTemp
.head 5 -  String: sEncode
.head 5 -  !
.head 4 +  Actions
.head 5 -  Call SalWaitCursor(TRUE)
.head 5 -  ! Получаема каталог экспорта
.head 5 +  If SalStrScan( sFileName, ':' ) != -1 OR SalStrScan( sFileName, '.' ) != -1
.head 6 -  ! Если задан полный путь или расширение
.head 6 -  Call VisDosSplitPath( sFileName, tDrive, tDir, tBase, tExt )
.head 6 -  Set sPath=tDrive || tDir
.head 6 +  If NOT sPath
.head 7 -  Set sPath=GetPrnDir()
.head 6 +  If tExt!='.'
.head 7 -  Set sFileName=tBase || tExt
.head 6 +  Else
.head 7 -  ! Меняем расширение на blb, если оно не указано явно
.head 7 -  Set sFileName=tBase || '.blb'
.head 5 +  Else
.head 6 -  ! Если задан только файл
.head 6 -  Set sPath=GetPrnDir()
.head 5 -  !
.head 5 -  !
.head 5 +  If not SqlPLSQLCommand(hSql(),"bars_report.exec_blob_report(sSqlStmt)")
.head 6 -  Call SalMessageBox( 'Ошибка формирования файла', '', MB_Ok | MB_IconAsterisk )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  ! ! выгрузка переменной пакета bars_report.G_RESULT_BLOB в файл
.head 5 +  If not DownloadBLOBfile(hSql(), sPath || '\\' || sFileName, OF_Create)
.head 6 -  Call SalMessageBox( 'Ошибка выгрузки данных в файл', '', MB_Ok | MB_IconAsterisk )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  Call SalWaitCursor(FALSE)
.head 3 -  ! (ANNY) Ескпорт в XML файл через clob переменную.
.head 3 +  Function: ExportToXMLCLOB
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Имя исходящего файла
.head 5 -  Receive String: sXMLFileName
.head 5 -  ! Сдесь находится информация о кдировке WIN или UTF
.head 5 -  Number: nExpFormat
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 +  ! Промежуточные Бинд-переменные
.head 6 -  ! String: sBind[50]
.head 6 -  ! Number: nBind[50]
.head 6 -  ! Date/Time: dBind[50]
.head 5 -  ! SQL Выражения
.head 5 -  ! Путь к файлу
.head 5 -  String: sPath
.head 5 -  ! Целевой SQL
.head 5 -  Sql Handle: hSqlExp
.head 5 -  !
.head 5 -  String: tDrive
.head 5 -  String: tDir
.head 5 -  String: tBase
.head 5 -  String: tExt
.head 5 -  File Handle: hFileTemp
.head 5 -  String: sEncode
.head 5 -  !
.head 4 +  Actions
.head 5 -  Call SalWaitCursor(TRUE)
.head 5 -  ! Получаема каталог экспорта
.head 5 +  If SalStrScan( sXMLFileName, ':' ) != -1 OR SalStrScan( sXMLFileName, '.' ) != -1
.head 6 -  ! Если задан полный путь или расширение
.head 6 -  Call VisDosSplitPath( sXMLFileName, tDrive, tDir, tBase, tExt )
.head 6 -  Set sPath=tDrive || tDir
.head 6 +  If NOT sPath
.head 7 -  Set sPath=GetPrnDir()
.head 6 +  If tExt!='.'
.head 7 -  Set sXMLFileName=tBase || tExt
.head 6 +  Else
.head 7 -  ! Меняем расширение на dbf, если оно не указано явно
.head 7 -  Set sXMLFileName=tBase || '.xml'
.head 5 +  Else
.head 6 -  ! Если задан только файл
.head 6 -  Set sPath=GetPrnDir()
.head 5 -  !
.head 5 +  Select Case nExpFormat
.head 6 +  Case EXP_XML_WIN
.head 7 -  Set sEncode='windows-1251'
.head 7 -  Break
.head 6 +  Case EXP_XML_UTF
.head 7 -  Set sEncode='utf-8'
.head 7 -  Break
.head 6 +  Default
.head 7 -  Break
.head 5 -  !
.head 5 +  If not SqlPLSQLCommand(hSql(),"bars_report.exec_xml_report(sSqlStmt, sEncode)")
.head 6 -  Call SalMessageBox( 'Ошибка формирования XML файла', '', MB_Ok | MB_IconAsterisk )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  ! ! выгрузка переменной пакета bars_report.G_RESULT_CLOB в файл
.head 5 +  If not DownloadXMLfile(hSql(), sPath || '\\' || sXMLFileName, OF_Create)
.head 6 -  Call SalMessageBox( 'Ошибка выгрузки данных в файл', '', MB_Ok | MB_IconAsterisk )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  Call SalWaitCursor(FALSE)
.head 3 -  !
.head 3 -  ! Разорать описание полей для выгрузки в файл с разделителями в структуру
.head 3 +  Function: GetColsDelimDescription 
.head 4 -  Description: Вычитывает разделители
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  : cColDesc[200]
.head 6 -  Class: cColumnDelimDescriptor
.head 5 -  Number: nCols
.head 5 -  Long String: lsFieldDelim
.head 5 -  Receive String: sDelimeter
.head 5 -  Receive String: sErrMsg
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sToken[200]
.head 5 -  Number: i
.head 5 -  Number: nPos
.head 5 -  String: sFieldName
.head 5 -  String: sFieldDesc
.head 5 -  String: sDelimField
.head 5 -  Number: nDelimFieldPos
.head 5 -  Number: nChrFieldPos
.head 5 -  String: sParams[10]
.head 5 -  String: sChrString
.head 5 -  String: sChr
.head 5 -  Number: nParamCou
.head 5 -  Number: nTokenCols
.head 5 -  Number: nLeftBrecket
.head 5 -  Number: nRightBrecket
.head 5 -  String: sTmp
.head 5 -  String: sHlpMessage
.head 4 +  Actions
.head 5 -  ! Кол-во полей + поле Delim
.head 5 -  Set nDelimFieldPos = SalStrScan(lsFieldDelim,'Delim=') 
.head 5 -  Set sHlpMessage =  "Описание поля должно соответствовать шаблону C[1,'x',R,ddmmyyyy], где"||PutCrLf()||
              'C - наименование поля' ||PutCrLf()||
              '1 - длинна поля' ||PutCrLf()||
              'x - символ, которым дополнять поле до указанной длинны' ||PutCrLf()||
              'R - выравнивание, может содержать: R(вправо), L(влево)' ||PutCrLf()||
              'ddMMyyy - формат для даты (centur-овский)'
.head 5 +  If nDelimFieldPos = 0 
.head 6 -  Set sErrMsg = 'В структуре описания должно быть описание разделителя: Delim='
.head 6 -  Return -1
.head 5 -  !
.head 5 -  ! есть описание символа через ascii код в виде  Delim=chr(09)  табуляция)
.head 5 -  Set nChrFieldPos = SalStrScan(SalStrLowerX(lsFieldDelim),'chr')
.head 5 +  If nChrFieldPos > 0
.head 6 -  Set nLeftBrecket  = SalStrScan(SalStrLowerX(lsFieldDelim),'(')
.head 6 -  Set nRightBrecket  = SalStrScan(SalStrLowerX(lsFieldDelim),')')
.head 6 +  If nLeftBrecket= 0 OR nRightBrecket = 0
.head 7 -  Set sErrMsg = 'Для описания разделителя через функцию CHR используйте синтаксис Delim=chr(09)'
.head 7 -  Return -1
.head 6 -  Set sChrString = SalStrMidX(lsFieldDelim,nLeftBrecket +1,nRightBrecket-nLeftBrecket-1)
.head 6 -  Set sDelimeter = SalNumberToChar(  SalStrToNumber(sChrString))
.head 5 +  Else
.head 6 -  Set sDelimeter = SalStrMidX(lsFieldDelim, nDelimFieldPos+SalStrLength('Delim=')+1,1)
.head 5 -  !
.head 5 +  If sDelimeter = ''
.head 6 -  Set sErrMsg = 'Не указан символ разделителя после конструкции Delim='
.head 6 -  Return -1
.head 5 -  !
.head 5 -  !
.head 5 -  Set lsFieldDelim = SalStrTrimX(SalStrLeftX(lsFieldDelim, nDelimFieldPos))
.head 5 -  ! Отсеч все символы после описания последнего поля (например перевод каретки)
.head 5 -  Set lsFieldDelim = SalStrLeftX(lsFieldDelim, VisStrScanReverse(lsFieldDelim,-1,';') +1 )
.head 5 -  !
.head 5 -  Set nTokenCols  = SalStrTokenize(lsFieldDelim, '',';',sToken)
.head 5 +  If nTokenCols != nCols
.head 6 -  Set sErrMsg = 'Колличество колонок в запросе ('||SalNumberToStrX(nCols,0)||')  не совпадает с колличеством колонок, указанных в описании структуры ('||SalNumberToStrX(nTokenCols,0)||')'
.head 6 -  Return -1
.head 5 -  !
.head 5 -  !
.head 5 -  !
.head 5 -  Set i=0
.head 5 +  While i<nCols 
.head 6 -  Set nPos = SalStrScan(sToken[i], Chr(10))
.head 6 +  If nPos  > -1
.head 7 -  Set sToken[i] = SalStrReplaceX ( sToken[i], nPos, 1, ' ' )
.head 6 -  Set nPos = SalStrScan(sToken[i], Chr(13))
.head 6 +  If nPos  > -1
.head 7 -  Set sToken[i] = SalStrReplaceX ( sToken[i], nPos, 1, ' ' )
.head 6 -  !
.head 6 -  Set sToken[i] = StrTrimAll(sToken[i], FALSE)
.head 6 +  If SalStrLength(sToken[i]) < SalStrLength("C[1,' ',R]")
.head 7 -  Set sErrMsg = 'Размер описания колонки меньше минимального.'||PutCrLf()||sHlpMessage              
.head 7 -  Return -1
.head 6 -  !
.head 6 -  Set nPos = SalStrScan(sToken[i], '[')
.head 6 +  If nPos  = 0 OR SalStrScan(sToken[i], ']') = 0 
.head 7 -  Set sErrMsg = 'Описание поля должно содержаться в квадратных кавычках'||PutCrLf()||sHlpMessage             
.head 7 -  Return -1
.head 6 -  !
.head 6 -  Set sFieldName = SalStrUpperX(SalStrTrimX(SalStrLeftX(sToken[i], nPos)))
.head 6 +  If sFieldName != SalStrUpperX(cColDesc[i].strColName)
.head 7 -  Set sErrMsg = 'Для поля №'||SalNumberToStrX(i+1,0)||' наименование поля в описании '||sFieldName||
              ' не соответствует наименованию поля в запросе '||SalStrUpperX(cColDesc[i].strColName)             
.head 7 -  Return -1
.head 6 -  !
.head 6 -  !
.head 6 -  Set sFieldDesc = SalStrMidX(sToken[i], nPos+1,  SalStrScan(sToken[i], ']')-nPos-1 )
.head 6 -  Set nParamCou = SalStrTokenize(sFieldDesc, '',',',sParams)
.head 6 -  !
.head 6 +  If nParamCou < 3 OR nParamCou > 4
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' должно быть описано минимум 3, максимум 4 параметра описания в квадратных кавычках'
.head 7 -  Return -1
.head 6 -  !
.head 6 -  !
.head 6 -  Set sParams[0] = SalStrTrimX(sParams[0])
.head 6 -  Set sParams[1] = SalStrTrimX(sParams[1])
.head 6 -  Set sParams[2] = SalStrTrimX(sParams[2])
.head 6 -  !
.head 6 -  !
.head 6 +  If sParams[0]=''
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' первый параметр описания - пуст, а должен указывать на длину поля'
.head 7 -  Return -1
.head 6 -  !
.head 6 +  If sParams[1]=''
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' второй параметр описания - пуст, а должен указывать на символ, которым дополнить поле до указанной длинны'
.head 7 -  Return -1
.head 6 +  If SalStrLength(sParams[1]) != 3
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' второй параметр описания должен быть заключен в одинарные кавычки и содержать один символ, которым нужно дополнять поле до указанной длинны'
.head 7 -  Return -1
.head 6 +  If SalStrLeftX(sParams[1],1) != "'" OR SalStrRightX(sParams[1],1) != "'"
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' второй параметр описания должен быть заключен в одинарные кавычки'
.head 7 -  Return -1
.head 6 -  !
.head 6 -  !
.head 6 +  If sParams[2]=''
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' третий параметр - пуст, должен указывать на выравнивание в поле, может принимать одно из значений R()'
.head 7 -  Return -1
.head 6 +  If sParams[2]!='R' AND sParams[2]!='L' 
.head 7 -  Set sErrMsg = 'Для поля '||sFieldName||' третий параметр должен указывать на выравнивание в поле, может принимать одно из значений R()'
.head 7 -  Return -1
.head 6 -  !
.head 6 -  !
.head 6 -  Set cColDesc[i].nWidth   =SalStrToNumber(sParams[0])
.head 6 -  Set cColDesc[i].sBlankChr=sParams[1]
.head 6 -  Set cColDesc[i].sAlign   =sParams[2]
.head 6 -  !
.head 6 -  !
.head 6 +  If cColDesc[i].nColType=DTYPE_DATETIME OR
   cColDesc[i].nColType=DTYPE_DATE  OR
   cColDesc[i].nColType=DTYPE_TIME
.head 7 +  If nParamCou>3 
.head 8 -  Set cColDesc[i].sSpec =sParams[3]
.head 7 -  ! Формат даты не указан - по умолчанию поставим 'DDMMYYYY'
.head 7 +  Else
.head 8 -  Set cColDesc[i].sSpec ="'ddMMyyyy'"
.head 6 -  !
.head 6 -  !
.head 6 -  Set i=i+1
.head 5 -  ! Разделитель полей
.head 5 -  !
.head 5 +  ! While k<nCols
.head 6 -     Set i=0
.head 6 -     Set k=k+1
.head 5 -  Return 0
.head 3 -  ! Экспорт в текстовый файл по шаблону (Ivan)
.head 3 +  Function: ExportToTextTemplate
.head 4 -  Description: Экспорт в текстовый файл по шаблону
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSql
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Шаблон файла
.head 5 -  String: sTemplate
.head 5 -  ! Имя файла экспорта
.head 5 -  String: sReportFileName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  ! Desc
.head 5 -  : iCols[200]
.head 6 -  Class: cSqlColumnDescriptor
.head 5 -  Number: nColumnСount
.head 5 -  ! Indexes
.head 5 -  Number: i
.head 5 -  Number: j
.head 5 -  ! File parts
.head 5 -  String: sHeader
.head 5 -  String: sDetailOri
.head 5 -  String: sDetail
.head 5 -  String: sAllDetails
.head 5 -  String: sFooter
.head 5 -  String: sFile
.head 5 -  ! Header subst. flag
.head 5 -  Boolean: fHead
.head 5 -  Number: nFetchRes
.head 5 -  ! File
.head 5 -  File Handle: hFile
.head 5 -  String: sEOL
.head 4 +  Actions
.head 5 -  !
.head 5 +  If NOT sTemplate
.head 6 -  Return FALSE
.head 5 -  Set sReportFileName=PrepareFileName(sReportFileName)
.head 5 -  ! Разделить шаблон на части
.head 5 -  Set j=VisStrScanReverse( sTemplate, -1, '->' )
.head 5 -  Set sFooter=SalStrMidX( sTemplate, j+2, SalStrLength(sTemplate) )
.head 5 -  Set i=VisStrScanReverse( sTemplate, j-1, '->' )
.head 5 -  Set sDetailOri=SalStrMidX( sTemplate, i+2, j-i-2 )
.head 5 -  Set sHeader=SalStrMidX( sTemplate, 0, i-1 )
.head 5 +  If DebuggingOn
.head 6 -  Call Debug("Экспортируем в файл: " || sReportFileName)
.head 6 -  Call Debug("Заголовок: '" || sHeader || "'")
.head 6 -  Call Debug("Детальный блок: '" || sDetailOri || "'")
.head 6 -  Call Debug("Окончание: '" || sFooter || "'")
.head 5 -  ! Готовлю описание SQL
.head 5 +  If SqlPrepare( hSql, sSqlStmt )
.head 6 -  ! Описание
.head 6 -  Set nColumnСount=SqlDescribe( hSql, iCols )
.head 6 -  Call SqlCorrectColumnName( nColumnСount, iCols )
.head 6 -  Set fHead=FALSE
.head 6 -  Set sEOL=SalNumberToChar( 13 ) || SalNumberToChar( 10 )
.head 6 -  Set sAllDetails=sEOL
.head 6 -  ! Итерации по набору данных
.head 6 +  If SqlExecute( hSql )
.head 7 +  While SqlFetchNext( hSql, nFetchRes )
.head 8 -  ! Заменить все в заголовке и окончании
.head 8 +  If NOT fHead
.head 9 -  Set sHeader=ApplyQueryFields( sHeader, iCols, nColumnСount )
.head 9 -  Set sFooter=ApplyQueryFields( sFooter, iCols, nColumnСount )
.head 9 -  Set fHead=TRUE
.head 9 +  If DebuggingOn
.head 10 -  Call Debug('Измененный заголовок: ' || sHeader)
.head 10 -  Call Debug('Измененное окончание:' || sFooter)
.head 8 -  Set sDetail=ApplyQueryFields( sDetailOri, iCols, nColumnСount )
.head 8 +  If DebuggingOn
.head 9 -  Call Debug('Измененный детальный блок:' || sDetail)
.head 8 -  Set sAllDetails=sAllDetails || sDetail || sEOL
.head 6 -  ! Составление файла из частей и выгрузка в файл
.head 6 +  If SalFileOpen( hFile, sReportFileName, OF_Create | OF_ReadWrite )
.head 7 -  Set sFile=sHeader || sAllDetails || sFooter
.head 7 -  Call SalFileWrite( hFile, sFile, SalStrLength(sFile) )
.head 7 -  Call SalFileClose( hFile )
.head 6 +  Else
.head 7 -  Call SalMessageBox( 'Создать файл: ' || sReportFileName , 'Ошибка', 0 )
.head 5 +  Else
.head 6 -  Call SalMessageBox( 'Не могу подготовить SQL выражение: ' || sSqlStmt , 'Ошибка', 0 )
.head 3 -  !
.head 3 +  Function: FieldByName
.head 4 -  Description: Получение значения функции по имени
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  : cDescriptor[200]
.head 6 -  Class: cSqlColumnDescriptor
.head 5 -  Number: nColumnCount
.head 5 -  String: sFieldName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sValue
.head 5 -  Number: i
.head 5 -  Number: Index
.head 5 -  Number: nWidth
.head 4 +  Actions
.head 5 -  Set i = 0
.head 5 -  Set Index = NUMBER_Null
.head 5 +  While i < nColumnCount
.head 6 +  If SalStrUpperX( cDescriptor[i].strColName )=SalStrUpperX( sFieldName )
.head 7 -  Set Index = i
.head 7 -  Break
.head 6 -  Set i = i + 1
.head 5 +  If Index != NUMBER_Null
.head 6 +  If cDescriptor[i].sBindName='s'
.head 7 -  Set sValue=sBind[cDescriptor[i].nBindIndex]
.head 6 +  Else If cDescriptor[i].sBindName='n'
.head 7 -  Set sValue=SalNumberToStrX( nBind[cDescriptor[i].nBindIndex], 0 )
.head 6 +  Else If cDescriptor[i].sBindName='d'
.head 7 -  Call SalDateToStr( dBind[cDescriptor[i].nBindIndex], sValue )
.head 6 +  Else
.head 7 -  Set sValue=''
.head 6 -  Set sValue=PadR( sValue, cDescriptor[i].nColLength )
.head 5 +  ! If DebuggingOn
.head 6 -  Call Debug(sFieldName || '=' || sValue)
.head 5 -  Return sValue
.head 3 -  ! Добавление к пути файла каталога печати если файл задан без 
полного пути
.head 3 +  Function: PrepareFileName
.head 4 -  Description: Подготовка имени файла к экспорту:
Если файл без пути добавляется каталог печати
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  String: sFilePath
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sResult
.head 4 +  Actions
.head 5 -  ! SalStrScan здесь работать отказывается
.head 5 +  If VisStrScanReverse( sFilePath, -1, '\\' ) = -1
.head 6 -  ! Получаем каталог экспорта
.head 6 -  Set sResult=GetPrnDir() || '\\' || sFilePath
.head 5 +  Else
.head 6 -  Set sResult=sFilePath
.head 5 -  Return sResult
.head 3 -  !
.head 3 +  Function: ReadCatQueryRegs
.head 4 -  Description: Чтение параметров отладки из реестра для функции ExportCatQuery
.head 4 -  Returns
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call SalUseRegistry(TRUE, GetCompanyName())
.head 5 -  Set DebuggingOn = SalGetProfileInt( INI_Print, 'DebugCatQuery', 0, GetProductName() )
.head 5 -  Set ShowEndReportMessageOn= SalGetProfileInt( INI_Print, 'ShowRepEndMessage', 0, GetProductName() )
.head 3 -  !
.head 3 +  Function: ExportToOffice
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Columns types
.head 5 -  String: sColTypes[*]
.head 5 -  ! hWnd окна таблицы
.head 5 -  Window Handle: hTableWind
.head 5 -  ! Формат 1 - Excel 2 - Word
.head 5 -  Number: nFormat
.head 5 -  ! Наименование кат. запроса
.head 5 -  String: strReportName
.head 5 -  ! Режим открытия Word (1-NoPrint, 0-Normal)
.head 5 -  Number: nMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sQueryName
.head 4 +  Actions
.head 5 -  Call ExportToOfficeFN(hSqlImp, '', sSqlStmt, sColTypes, hTableWind, nFormat, strReportName, nMode)
.head 3 +  Function: ExportToOfficeFN
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Имя файла для выгрузки - с полным путем
.head 5 -  String: sFileName
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! Columns types
.head 5 -  String: sColTypes[*]
.head 5 -  ! hWnd окна таблицы
.head 5 -  Window Handle: hTableWind
.head 5 -  ! Формат 1 - Excel 2 - Word
.head 5 -  Number: nFormat
.head 5 -  ! Наименование кат. запроса
.head 5 -  String: strReportName
.head 5 -  ! Режим открытия Word (1-NoPrint, 0-Normal)
.head 5 -  Number: nMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sQueryName
.head 4 +  Actions
.head 5 -  ! Создаем списки переменных
.head 5 +  Loop
.head 6 +  ! If DebuggingOn
.head 7 -  Call Debug('Экспорт в Офис...')
.head 6 +  If SalTblPopulate(hTableWind, hSqlImp, sSqlStmt, TBL_FillAll)
.head 7 +  ! If DebuggingOn
.head 8 -  Call Debug('Таблица успешно населена выражением:
' || sSqlStmt)
.head 7 +  If nFormat = 1
.head 8 -  Call msoSetIncludeAllColumns(TRUE)
.head 8 -  Call xlsExportTableFN(hTableWind, sFileName, strReportName, '', sColTypes)
.head 8 -  Call msoSetIncludeAllColumns(FALSE)
.head 7 +  Else If nFormat = 2
.head 8 -  Call msoSetIncludeAllColumns(TRUE)
.head 8 -  Call wrdExportTableMode(hTableWind, strReportName, '', nMode)
.head 8 -  Call msoSetIncludeAllColumns(FALSE)
.head 7 +  Else
.head 8 -  Call MessageAttention('Неизвестный формат для экспорта в Офис: '|| 
SalNumberToStrX( nFormat, 0 ))
.head 6 +  Else
.head 7 -  Call MessageAttention('Не могу населить временную таблицу для экспорта выражением: ' || sSqlStmt)
.head 6 -  !
.head 6 -  Call msoSetIncludeAllColumns(FALSE)
.head 6 -  Break
.head 3 +  Function: ExportToInternalTable
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Connect
.head 5 -  Sql Handle: hSqlImp
.head 5 -  ! Исходный SQL
.head 5 -  String: sSqlStmt
.head 5 -  ! hWnd окна таблицы
.head 5 -  Window Handle: hTableWind
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  ! Создаем списки переменных
.head 5 +  Loop
.head 6 +  If SalTblPopulate( hTableWind, hSqlImp, sSqlStmt, TBL_FillAll )
.head 7 +  If DebuggingOn
.head 8 -  Call Debug('Таблица успешно населена выражением:
' || sSqlStmt)
.head 6 -  !
.head 6 -  Break
.head 3 -  ! Получение даты в формате "dd month Year y." на украинском языке
.head 3 +  Function: DateAsPlainUkr
.head 4 -  Description: Получение даты в формате "dd month Year y." на украинском языке
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  Date/Time: dDate
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: Result
.head 5 -  Number: nFetchRes
.head 4 +  Actions
.head 5 -  Set Result=''
.head 5 +  If SqlPrepareAndExecute( hSqlAux(), 'SELECT SUBSTR(F_DAT_LIT(:dDate), 1, 50) INTO :Result FROM DUAL' )
.head 6 -  Call SqlFetchNext(  hSqlAux(), nFetchRes )
.head 5 -  Return SalStrTrimX( Result )
.head 3 +  Function: DateAsPlainUkr2
.head 4 -  Description: Получение даты в формате "dd month Year y." на украинском языке
с использованием hSql_ как параметра
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  Sql Handle: hSql_
.head 5 -  Date/Time: dDate
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: Result
.head 5 -  Number: nFetchRes
.head 4 +  Actions
.head 5 -  Set Result=''
.head 5 +  If SqlPrepareAndExecute( hSql_, 'SELECT SUBSTR(F_DAT_LIT(:dDate), 1, 50) INTO :Result FROM DUAL' )
.head 6 -  Call SqlFetchNext(  hSql_, nFetchRes )
.head 5 -  Return SalStrTrimX( Result )
.head 3 -  !
.head 3 -  ! --------------------------------------------------------
.head 3 -  ! <ExportCatQueryMain>
.head 3 -  ! Главная функция по печати и выполнению кат. запросов
.head 3 -  ! Все функции печати отчетов должны наследоваться от данной функции
.head 3 -  ! --------------------------------------------------------
.head 3 +  Function: ExportCatQueryMain
.head 4 -  Description: Выполнить экспорт каталогизированного запроса
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Ссылка на соединение с базой (hSql())
.head 5 -  : cRep
.head 6 -  Class: cABSConnect
.head 5 -  ! Код запроса
.head 5 -  Number: nKODZ
.head 5 -  ! Файл запроса с полным путем
.head 5 -  String: sFileName
.head 5 -  ! Формат (описан в справочнике rep_types - смотри скрипт в VSS)
.head 5 -  Number: nFormat
.head 5 -  ! Параметры отчета, упакованные в строку с помощью класса cParams
(может быть пустым) Если fAskParams=TRUE то значения из sParams прибавляются к введенным,
но их значения по не устанавливаются по умолчанию в диалоге ввода параметров
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  Boolean: fAskParams
.head 5 -  ! Удалять пустые строки отчета
.head 5 -  Boolean: bDeleteOnNullString
.head 5 -  ! Режим открытия приложения для просмотра отчета (1-NoPrint, 0-Normal)
.head 5 -  Number: nMode	
.head 5 -  ! Код печатного отчета
.head 5 -  Number: nReportKod
.head 4 +  Static Variables
.head 5 -  Boolean: fRBS
.head 5 -  Number: nLevel
.head 5 -  ! Complex
.head 5 -  : cCnc
.head 6 -  Class: cABSConnect
.head 4 +  Local variables
.head 5 -  Long String: lsSQLText
.head 5 -  String: sSQLText
.head 5 -  Long String: lsCreate_Stmt1
.head 5 -  Long String: lsCreate_Stmt2
.head 5 -  String: sCreate_Stmt
.head 5 -  Long String: lsBindList
.head 5 -  String: sBindList
.head 5 -  Long String: lsBindSQL
.head 5 -  String: sBindSQL
.head 5 -  !
.head 5 -  Long String: lsDefault_Vars
.head 5 -  String: sDefault_Vars
.head 5 -  String: sForm_Proc
.head 5 -  Number: nKodR
.head 5 -  String: sDBFileName
.head 5 -  String: sDBFileNameOri
.head 5 -  String: sDBFileNamePrev
.head 5 -  String: sDBFileNameTmp
.head 5 -  String: sFileNameSql
.head 5 -  String: sTmpFileName
.head 5 -  !
.head 5 -  String: strRBSName
.head 5 -  !
.head 5 -  Boolean: fTo_DOS
.head 5 -  Number: nFetchRes
.head 5 -  String: sRpt_Template
.head 5 -  Number: nBindsCount
.head 5 -  : cPar
.head 6 -  Class: cParams
.head 5 -  Number: i
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  String: sExportedFileName
.head 5 -  !
.head 5 -  Window Handle: hWndRpt
.head 5 -  String: sDrive
.head 5 -  String: sDir
.head 5 -  String: sBase
.head 5 -  String: sExt
.head 5 -  !
.head 5 -  Date/Time: dDate1
.head 5 -  Date/Time: dDate2
.head 5 -  ! Complex
.head 5 -  String: sMainParams
.head 5 -  String: sAuxParams
.head 5 -  String: sAuxParamsExp
.head 5 -  Boolean: fStarted
.head 5 -  File Handle: hFile
.head 5 -  ! Для CompileAndEval
.head 5 -  Number: nError
.head 5 -  Number: nErrorPos
.head 5 -  Number: nReturn
.head 5 -  Date/Time: dReturn
.head 5 -  Window Handle: hWndReturn
.head 5 -  String: strContext
.head 5 -  String: strQueryParams
.head 5 -  String: strCatQueryName
.head 5 -  !
.head 5 -  : cCnc1
.head 6 -  Class: cABSConnect
.head 5 -  : cCnc2
.head 6 -  Class: cABSConnect
.head 5 -  String: sColTypes[*]  ! Список типов колонок для выгрузки в Excel
.head 5 -  Number: nCreateEmptyFiles
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 +  If nFormat = -1
.head 6 -  Call ExportXML(nKODZ, sFileName, sParams, fAskParams)
.head 6 -  Return TRUE
.head 5 -  ! Работа в режиме рекурсии
.head 5 +  If NOT nLevel
.head 6 -  Set nLevel = 0
.head 6 -  Call ReadCatQueryRegs()
.head 5 +  If nLevel = 0
.head 6 -  ! Для того, чтобы не делать ROLLBACK внутри FETCH
.head 6 -  Set fRBS = FALSE
.head 6 -  Call WaitCursorOn()
.head 6 -  ! Call XConnectGetParams(cCnc)
.head 6 +  ! If NOT cCnc.Connect()
.head 7 -      Return FALSE
.head 6 -  Call cCnc.Clone(cRep, TRUE)
.head 5 -  ! Параметры отчета
.head 5 +  If SqlPrepareAndExecute(cRep.hSql(), "
   SELECT NAMEF, SUBSTR(CREATE_STMT,1,2000), SUBSTR(CREATE_STMT,2001,2000), BINDVARS, DEFAULT_VARS, FORM_PROC, KODR,
          RPT_TEMPLATE, BIND_SQL, NAME
   INTO   :sDBFileName, :lsCreate_Stmt1, :lsCreate_Stmt2, :lsBindList, :lsDefault_Vars, :sForm_Proc, :nKodR,
          :sRpt_Template, :lsBindSQL, :strCatQueryName
   FROM   zapros
   WHERE  kodz=:nKODZ")
.head 6 +  If SqlFetchNext(cRep.hSql(), nFetchRes)
.head 7 -  Call SqlClose(cRep.hSql())
.head 7 -  Set lsSQLText = GetStringFromClob(cRep.hSql(), 'zapros', 'kodz', 'txt', nKODZ, '', '')
.head 7 +  If NOT sDBFileName AND NOT sFileName AND NOT
   (nFormat = 8 OR nFormat = 9 OR nFormat = 99 OR nFormat = EXP_NULL_OUTPUT)
.head 8 -  Call WaitCursorOff()
.head 8 -  ! Call SalMessageBox('Не задано имя формируемого файла!', 'Ошибка', MB_IconStop | MB_Ok)
.head 8 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrNotFileName'), 
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 -  Return FALSE
.head 7 -  ! Текст SQL
.head 7 -  Set sSQLText = lsSQLText
.head 7 -  ! Выраж. на создание
.head 7 -  Set sCreate_Stmt = lsCreate_Stmt1 || lsCreate_Stmt2
.head 7 -  ! Бинд-переменные
.head 7 -  Set sBindList = lsBindList
.head 7 -  Set sDefault_Vars = lsDefault_Vars
.head 7 -  Set sBindSQL = lsBindSQL
.head 7 -  ! Уст. параметров
.head 7 +  If fAskParams
.head 8 -  ! Вызов диалога параметров
.head 8 -  ! Разбор параметров
.head 8 -  Set nBindsCount = GetQueryBindsList(sBindList, sBindSQL, sBinds)
.head 8 -  ! Диалог
.head 8 +  If nBindsCount > 0 
.head 9 -  ! Установка умолч. значений параметров
.head 9 +  If sDefault_Vars
.head 10 -  Call cPar.SetParams(sDefault_Vars)
.head 10 -  Set i = 0
.head 10 +  While i < nBindsCount
.head 11 +  If cPar.IndexOf(sBinds[i].sName) >= 0
.head 12 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 12 -  ! Set sBinds[i].sSemantic=sBinds[i].sName
.head 12 +  If At(':sFdat1', sBinds[i].sName) > 0
.head 13 -  Set sBinds[i].sSemantic = VisStrSubstitute(sBinds[i].sName, ':sFdat1', 'Дата с (за)')
.head 12 +  If At(':sFdat2', sBinds[i].sName) > 0
.head 13 -  Set sBinds[i].sSemantic = VisStrSubstitute(sBinds[i].sName, ':sFdat2', 'Дата по')
.head 12 -  ! Call Debug(sBinds[i].sName)
.head 11 -  Set i = i + 1
.head 10 -  Call cPar.Clear()
.head 9 -  ! Вызов диалога
.head 9 +  If NOT SetQueryBinds(hWndMDI, sBinds, nBindsCount, nReportKod)
.head 10 -  Call WaitCursorOff()
.head 10 -  Return FALSE
.head 9 -  Call WaitCursorOn()
.head 8 -  ! Добавление параметров переданных в sParams
.head 8 +  If sParams
.head 9 -  Call cPar.Clear()
.head 9 -  Call cPar.SetParams(sParams)
.head 9 -  Set i = 0
.head 9 +  While i < nBindsCount
.head 10 +  If cPar.IndexOf(sBinds[i].sName) >= 0
.head 11 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 10 -  Set i = i + 1
.head 9 -  ! Параметры даты	
.head 9 +  If cPar.IndexOf(':sFdat1') >= 0
.head 10 -  Set dDate1 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat1'), 'dd/MM/yyyy')
.head 9 +  If cPar.IndexOf(':sFdat2') >= 0
.head 10 -  Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat2'), 'dd/MM/yyyy')
.head 8 -  ! Внедрение значений параметров в SQL
.head 8 -  Set sSQLText = ApplyQueryBinds(sSQLText, sBinds, nBindsCount)
.head 7 +  Else If sParams
.head 8 -  ! Заполнение параметров из переменной
.head 8 -  Set nBindsCount = GetQueryBindsList(sBindList, '', sBinds)
.head 8 -  Call cPar.SetParams(sParams)
.head 8 -  Set i = 0
.head 8 +  While i < nBindsCount
.head 9 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 9 -  Set i = i + 1
.head 8 -  ! Параметры даты
.head 8 +  If cPar.IndexOf(':sFdat1') >= 0
.head 9 -  Set dDate1 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat1'), 'dd/MM/yyyy')
.head 8 +  If cPar.IndexOf(':sFdat2') >= 0
.head 9 -  Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat2'), 'dd/MM/yyyy')
.head 8 -  Set sSQLText = ApplyQueryBinds(sSQLText, sBinds, nBindsCount)
.head 7 -  ! Уст. формат даты
.head 7 +  If SalStrTrimX(SalStrUpperX(GetDBMS())) = 'ORACLE'
.head 8 -  Call SqlPrepareAndExecute(cRep.hSql(), "ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY'")
.head 8 -  Call SqlClose(cRep.hSql())
.head 7 -  ! Установка имени файла
.head 7 +  If sFileName != STRING_Null
.head 8 -  Set sDBFileName = sFileName
.head 7 -  Set sDBFileName = SalStrTrimX(sDBFileName)
.head 7 -  ! Сохраняем оригинальную формулу
.head 7 -  Set sDBFileNameOri = sDBFileName
.head 7 -  ! Формула имени файла
.head 7 +  If SalStrLeftX(sDBFileName, 1) = '=' AND NOT nKodR
.head 8 -  Set sDBFileName = ApplyQueryBinds(SalStrRightX(sDBFileName, SalStrLength(sDBFileName)-1), sBinds, nBindsCount)
.head 8 -  Set sFileNameSql = 'SELECT ' || sDBFileName || ' INTO :sDBFileName FROM DUAL'
.head 8 +  If VisStrScanReverse(sDBFileName, -1, ':') < 0 or
   (VisStrScanReverse(sDBFileName, -1, ':') >= 0 and VisStrScanReverse(sDBFileName, -1, ':\\') >= 0)
.head 9 -  ! If SqlPrepareAndExecute(cRep.hSql(), sFileNameSql)
.head 9 -  ! Call Debug('sDBFileName do = ' || sDBFileName)
.head 9 -  ! Call Debug('sFileNameSql = ' || sFileNameSql)
.head 9 +  If SqlPrepareAndExecute(cRep.hSql(), sFileNameSql)
.head 10 -  ! Call Debug('before SqlFetchNext')
.head 10 -  Call SqlFetchNext(cRep.hSql(), nFetchRes)
.head 10 -  ! Call Debug('after SqlFetchNext')
.head 10 -  ! Call Debug('sFileNameSql error = ' || sFileNameSql)
.head 10 -  ! Call Debug('sDBFileName posle = ' || sDBFileName)
.head 10 -  Call SqlClose(cRep.hSql())
.head 10 +  If DebuggingOn
.head 11 -  ! Call Debug('Имя файла вычислено в: ' || sDBFileName)
.head 11 -  Call Debug(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTMsgDebugFileNmae') || ': ' || sDBFileName)
.head 9 +  Else
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SaveInfoToLog('otcn(0): sFileNameSql = ' || sFileNameSql)
.head 10 -  ! Call SalMessageBox('Ошибка при вычислении имени файла:
' || sFileNameSql, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrFileName') || ':' || PutCrLf() ||
     sFileNameSql, CurrentLangTable.GetAtomTitle('cTErr') || ' (sql error)', MB_IconStop | MB_Ok)
.head 10 -  Return FALSE
.head 8 +  Else
.head 9 -  Call WaitCursorOff()
.head 9 -  ! Call SaveInfoToLog('otcn(1): sFileNameSql = ' || sFileNameSql)
.head 9 -  ! Call SalMessageBox('Ошибка при вычислении имени файла:
' || sFileNameSql, 'Ошибка', MB_IconStop | MB_Ok)
.head 9 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrFileName') || ':' || PutCrLf() ||
     sFileNameSql, CurrentLangTable.GetAtomTitle('cTErr') || ' (синтаксис)', MB_IconStop | MB_Ok)
.head 9 -  Return FALSE
.head 7 -  ! Проц. формирования
.head 7 +  If sForm_Proc
.head 8 -  Set sForm_Proc = ApplyQueryBinds(sForm_Proc, sBinds, nBindsCount)
.head 8 -  ! Вызываем проц. формирования
.head 8 +  If SalStrTrimX(SalStrUpperX(GetDBMS())) = 'ORACLE'
.head 9 -  !
.head 9 -  Set strRBSName = GetGlobalOption('RNBURBCK')
.head 9 +  If NOT fRBS AND strRBSName
.head 10 -  ! Кончаем транзакцию (если вдруг была),
.head 10 -  ! чтобы не было ошибок с set transaction...
.head 10 -  Call SqlRollback(cRep.hSql())
.head 10 -  Call SqlClose(cRep.hSql())
.head 10 +  If NOT SqlPrepareAndExecute(cRep.hSql(), 'SET TRANSACTION USE ROLLBACK SEGMENT ' || strRBSName)
.head 11 -  Call WaitCursorOff()
.head 11 -  ! Call SalMessageBox('Ошибка при установке сегмента отката:' || strRBSName, 'Ошибка', MB_IconStop | MB_Ok)
.head 11 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSegment') || ':' || strRBSName,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 11 -  Return FALSE
.head 10 -  Call SqlClose(cRep.hSql())
.head 10 -  Set fRBS = TRUE
.head 9 +  If NOT SqlPrepareAndExecute(cRep.hSql(), 'BEGIN ' || sForm_Proc || '; END;')
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox( 'Ошибка при выполнении процедуры:
' || sForm_Proc, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrExecProc') || ':' || PutCrLf() ||
     sForm_Proc, CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 10 -  Return FALSE
.head 9 -  Call SqlClose(cRep.hSql())
.head 7 -  ! Сохраняю все параметры в переменной
.head 7 -  Set sMainParams = ''
.head 7 +  If nBindsCount AND nKodR
.head 8 -  Call cPar.Clear()
.head 8 -  Set i = 0
.head 8 +  While i < nBindsCount
.head 9 -  Call cPar.SetAsString(sBinds[i].sName, sBinds[i].sVal)
.head 9 -  Set i = i + 1
.head 8 -  Set sMainParams = cPar.GetParams()
.head 7 -  ! Имя временного файла
.head 7 +  If nKodR
.head 8 -  Set sDBFileNameTmp = GetPrnDir() || '\\' || 'tmp' || SalNumberToStrX(GetUserId(), 0) || '.tmp'
.head 8 -  ! Удаляем врем. файл если он есть
.head 8 -  Call VisFileDelete(sDBFileNameTmp)
.head 7 -  ! <<<<<<<<< Подготовка данных и SQL выражения завершена
.head 7 -  ! !!!!!!!!!!!!!!!!!
.head 7 -  ! Обрабатываем сложный запрос
.head 7 +  If nKodR
.head 8 -  !
.head 8 +  If DebuggingOn
.head 9 -  ! Call Debug('Основной запрос с подставленными параметрами: ' || sSQLText)
.head 9 -  Call Debug(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTMsgDebugQuery') || ': ' || sSQLText)
.head 8 -  ! Call SaveInfoToLog( 'Експорт запроса ид. ' || SalNumberToStrX(nKODZ, 0) || ' с параметрами: ' || 
     GetBindsAsString(sBinds, nBindsCount))
.head 8 -  Call SaveInfoToLog(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTToLog1') || ' ' || SalNumberToStrX(nKODZ, 0) ||
     ' ' || CurrentLangTable.GetAtomTitle('ExportCatQuery.cTToLog2') || ': ' ||
     GetBindsAsString(sBinds, nBindsCount))
.head 8 -  !
.head 8 +  Loop
.head 9 -  ! Подготавливаем выражение
.head 9 +  If NOT SqlPrepare(cCnc.hSql(), sSQLText)
.head 10 -  ! Call MessageAttention('Не могу подготовить SQL:' || sSQLText)
.head 10 -  Call MessageAttention(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || sSQLText)
.head 10 -  Break
.head 9 -  ! Создаем выражение для помещения результатов запроса в строку параметров
.head 9 -  Call SqlGetParamsExpr(cCnc.hSql(), sAuxParamsExp)
.head 9 -  ! Прибавляем целевые переменные (INTO) к запросу
.head 9 -  Call SqlAddIntoStatement(cCnc.hSql(), sSQLText)
.head 9 -  Set fStarted = FALSE
.head 9 -  Set sDBFileNamePrev = ''
.head 9 -  ! Выполняем SQL выражение
.head 9 +  If SqlPrepareAndExecute(cCnc.hSql(), sSQLText)
.head 10 +  While SqlFetchNext(cCnc.hSql(), nFetchRes)
.head 11 -  Set strContext = SalContextCurrent()
.head 11 -  !
.head 11 -  ! Замена символа апострофа в биндах
.head 11 -  Set i = 0
.head 11 +  While i < nBindsCount
.head 12 +  If sBinds[i].sType = 'S'
.head 13 -  Set sBind[i]=VisStrSubstitute (sBind[i],"'", "`")
.head 12 -  Set i = i + 1
.head 11 -  !
.head 11 -  ! Помещаем рез. запроса в строку параметров
.head 11 +  If SalCompileAndEvaluate(sAuxParamsExp, nError, nErrorPos, nReturn, sAuxParams, dReturn, hWndReturn, FALSE,
   strContext) = EVAL_String
.head 12 -  ! Сливаем параметры в одну переменную
.head 12 +  If sMainParams
.head 13 -  Set sAuxParams = sMainParams || ',' || sAuxParams
.head 12 +  If DebuggingOn
.head 13 -  ! Call Debug('Полные параметры передаваемые в дочерний зарос: ' || sAuxParams)
.head 13 -  Call Debug(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTMsgDebugParams') || ': ' || sAuxParams)
.head 12 -  ! Населяем список переменных
.head 12 -  Set nBindsCount = CreateBindsList(sAuxParams, sBinds)
.head 12 -  ! Вычисляем имя файла
.head 12 +  If SalStrLeftX(sDBFileNameOri, 1) = '='
.head 13 -  Set sDBFileName = ApplyQueryBinds(SalStrRightX(sDBFileNameOri, SalStrLength(sDBFileNameOri)-1), sBinds,
    nBindsCount)
.head 13 -  Set sFileNameSql = 'SELECT ' || sDBFileName || ' INTO :sDBFileName FROM DUAL'
.head 13 +  If SqlPrepareAndExecute(cRep.hSql(), sFileNameSql)
.head 14 -  Call SqlFetchNext(cRep.hSql(), nFetchRes)
.head 14 -  Call SqlClose(cRep.hSql())
.head 13 +  Else
.head 14 -  Call WaitCursorOff()
.head 14 -  ! Call SaveInfoToLog('otcn(2): sFileNameSql = ' || sFileNameSql)
.head 14 -  ! Call SalMessageBox( 'Ошибка при вычислении имени файла:
' || sFileNameSql, 'Ошибка', MB_IconStop | MB_Ok)
.head 14 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrFileName') || ':' || PutCrLf()
     || sFileNameSql, CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 14 -  Break
.head 12 -  ! Добавляем к имени файла путь
.head 12 -  Set sDBFileName = PrepareFileName(sDBFileName)
.head 12 +  If DebuggingOn
.head 13 -  ! Call Debug('Имя файла доч. запроса вычислено в: ' || sDBFileName)
.head 13 -  Call Debug(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTMsgDebugFileNameD') || ': ' || sDBFileName)
.head 12 -  ! Call Debug('FileName=' || sDBFileName)
.head 12 -  ! Зовем экспорт
.head 12 +  If FALSE AND SalFileOpen(hFile, sDBFileName, OF_Exist)
.head 13 -  ! Если файл есть - дописываем
.head 13 -  Set nLevel = nLevel + 1
.head 13 +  If nFormat = 1 OR nFormat = 2
.head 14 -  ! DBF - дописываем в конец
.head 14 -  Call ExportCatQueryMain(cRep, nKodR, sDBFileName, nFormat+3, sAuxParams, FALSE, bDeleteOnNullString,
     nMode, nReportKod)
.head 14 -  Call SqlClose(cRep.hSql())
.head 13 +  Else If nFormat = 4 OR nFormat = 5
.head 14 -  ! DBF - дописываем в конец
.head 14 -  Call ExportCatQueryMain(cRep, nKodR, sDBFileName, nFormat, sAuxParams, FALSE, bDeleteOnNullString,
      nMode, nReportKod)
.head 14 -  Call SqlClose(cRep.hSql())
.head 13 -  ! Експорт в текст. файл с разделителямми
.head 13 +  Else If nFormat = 7
.head 14 -  Call ExportCatQueryMain(cRep, nKodR, sDBFileName, nFormat, sAuxParams, FALSE, bDeleteOnNullString,
     nMode, nReportKod)
.head 14 -  Call SqlClose(cRep.hSql())
.head 13 -  !
.head 13 +  Else
.head 14 -  ! С остальными обыкновенно
.head 14 -  Call ExportCatQueryMain(cRep, nKodR, sDBFileNameTmp, nFormat, sAuxParams, FALSE, bDeleteOnNullString,
     nMode, nReportKod)
.head 14 -  Call SqlClose(cRep.hSql())
.head 14 -  If NOT VisFileAppend(sDBFileNameTmp, sDBFileName)
.head 14 -  If NOT VisFileDelete(sDBFileNameTmp)
.head 13 -  Set nLevel = nLevel - 1
.head 12 +  Else
.head 13 -  ! Если файла нет - создаем
.head 13 -  Set nLevel = nLevel + 1
.head 13 -  Call ExportCatQueryMain(cRep, nKodR, sDBFileName, nFormat, sAuxParams, FALSE, bDeleteOnNullString,
     nMode, nReportKod)
.head 13 -  Call SqlClose(cRep.hSql())
.head 13 -  Set nLevel = nLevel - 1
.head 12 +  If NOT fStarted
.head 13 -  Set fStarted = TRUE
.head 12 -  Set sDBFileNamePrev = sDBFileName
.head 9 -  Break
.head 8 -  ! Сохран. имени файла
.head 8 -  Set sCatQueryResult = sDBFileName
.head 8 -  ! Откат
.head 8 +  If nLevel = 0 AND fRBS
.head 9 -  ! После формирования говорим ROLLBACK
.head 9 -  ! для удаления данных временных таблиц
.head 9 -  Call SqlRollback(cRep.hSql())
.head 9 -  Call SqlClose(cRep.hSql())
.head 9 -  Call WaitCursorOff()
.head 7 -  ! Генерим выходные файлы
.head 7 +  Else
.head 8 -  ! Експорт запроса ид. nKODZ  с параметрами: GetBindsAsString(sBinds, nBindsCount)
.head 8 -  Call SaveInfoToLog(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTToLog1') || ' ' || SalNumberToStrX(nKODZ, 0) || ' ' || 
     CurrentLangTable.GetAtomTitle('ExportCatQuery.cTToLog2') || ': ' || GetBindsAsString(sBinds, nBindsCount))
.head 8 -  ! Установка соединений для winReportDummy
.head 8 +  If TRUE
.head 9 -  ! Call XConnectGetParams(cCnc1)
.head 9 -  ! Call cCnc1.Connect()
.head 9 -  ! Call cCnc2.Clone(cCnc1, TRUE)
.head 9 -  Call cCnc1.Clone(cRep, TRUE)
.head 9 -  Call cCnc2.Clone(cRep, TRUE)
.head 8 +  If DebuggingOn
.head 9 -  ! Call Debug('Запрос с подставленными параметрами: ' || sSQLText)
.head 9 -  Call Debug(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTMsgDebugQueryD') || ': ' || sSQLText)
.head 8 -  ! DBF
.head 8 +  If nFormat = 1 OR nFormat = 2
.head 9 +  If nFormat = 1
.head 10 -  Set fTo_DOS = TRUE
.head 9 +  Else
.head 10 -  Set fTo_DOS = FALSE
.head 9 +  If SqlPrepare(cRep.hSql(), sSQLText)
.head 10 -  Call SqlAddIntoStatement(cRep.hSql(), sSQLText)
.head 10 -  Call ExportToDbf(cRep.hSql(), sSQLText, sDBFileName, sCreate_Stmt, fTo_DOS, FALSE, TRUE)
.head 10 -  Call SqlClose(cRep.hSql())
.head 10 -  Set sExportedFileName = sDBFileName
.head 9 +  Else
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox('Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 -  ! Report TXT or RTF
.head 8 +  Else If nFormat = 3 OR nFormat = 6 OR nFormat = 16
.head 9 -  ! Set hWndRpt = SalCreateWindow(winQueryList, hWndMDI)
.head 9 +  If SqlPrepare(cRep.hSql(), sSQLText)
.head 10 -  Set hWndRpt = SalCreateWindow(winReportDummy, hWndNULL, nKODZ, dDate1, dDate2, cRep.hSql(), cCnc1.hSql(),
    cCnc2.hSql(), nReportKod)
.head 10 -  Call SqlAddIntoStatement(cRep.hSql(), sSQLText)
.head 10 +  If ExportToReport(cRep.hSql(), sSQLText, hWndRpt, GetTemplateDir() || '\\' || sRpt_Template, sDBFileName,
   nFormat=6, fAskParams, bDeleteOnNullString)
.head 11 -  Call SalDestroyWindow(hWndRpt)
.head 10 -  !
.head 10 -  Call SqlClose(cRep.hSql())
.head 10 -  ! перекодировать в ДОС
.head 10 +  If nFormat = 16 AND VisFileGetSize(sDBFileName) > 0
.head 11 -  Set sTmpFileName = GetPrnDir() || '\\temp_uniconv.txt'
.head 11 -  !
.head 11 -  ! Set nReturn = ConvertFile(sDBFileName, sTmpFileName)
.head 11 -  !
.head 11 +  ! If nReturn = 0
.head 12 -  If VisFileCopy(sTmpFileName, sDBFileName) = 1
.head 12 +  Else 
.head 13 -  Call SalMessageBox('Невозможно переименовать файл: c' || sTmpFileName || ' в ' | |sDBFileName,
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 11 +  If (SalLoadAppAndWait('uniconv.exe -wd ' || sDBFileName || ' ' || sTmpFileName, Window_NotVisible,
   nReturn) = TRUE)
.head 12 -  If VisFileCopy(sTmpFileName, sDBFileName) = 1
.head 12 +  Else
.head 13 -  Call WaitCursorOff()
.head 13 -  Call SalMessageBox('Невозможно переименовать файл: c' || sTmpFileName || ' в ' || sDBFileName,
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 11 +  Else
.head 12 -  Call WaitCursorOff()
.head 12 -  Call SalMessageBox('Ошибка выполнения утилиты uniconv.exe. (Проверте ее наличие ав каталоге BIN)',
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 10 -  Set sExportedFileName = sDBFileName
.head 9 +  Else
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox( 'Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 -  ! Append DBF
.head 8 +  Else If nFormat = 4 OR nFormat = 5
.head 9 +  If nFormat = 4
.head 10 -  Set fTo_DOS = TRUE
.head 9 +  Else
.head 10 -  Set fTo_DOS = FALSE
.head 9 +  If SqlPrepare(cRep.hSql(), sSQLText)
.head 10 -  Call SqlAddIntoStatement(cRep.hSql(), sSQLText)
.head 10 -  Call ExportToDbf(cRep.hSql(), sSQLText, sDBFileName, sCreate_Stmt, fTo_DOS, FALSE, FALSE)
.head 10 -  Call SqlClose(cRep.hSql())
.head 9 +  Else
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox( 'Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 9 -  Set sExportedFileName = sDBFileName
.head 8 -  ! Експорт в текст. файл с разделителямми
.head 8 +  Else If nFormat = 7
.head 9 +  If SqlPrepare(cRep.hSql(), sSQLText)
.head 10 -  Call SqlAddIntoStatement(cRep.hSql(), sSQLText)
.head 10 +  If SalStrScan(sDBFileName, ':') = -1 ! указан файл без пути
.head 11 -  Set sDBFileName = GetPrnDir() || '\\' || sDBFileName
.head 10 +  If ExportToTxtDelim(cRep.hSql(), sSQLText, sCreate_Stmt, sDBFileName) < 0
.head 11 -  Call Debug('Ошибка выполнения функции')
.head 11 -  Call SqlClose(cRep.hSql())
.head 11 -  Call cCnc1.Disconnect()
.head 11 -  Call cCnc2.Disconnect()
.head 11 -  Return -1
.head 10 -  Call SqlClose(cRep.hSql())
.head 10 -  Set sExportedFileName = sDBFileName
.head 9 +  Else
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox( 'Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 +  Else If nFormat = 10
.head 9 +  If SqlPrepare(cRep.hSql(), sSQLText)
.head 10 -  Call SqlAddIntoStatement(cRep.hSql(), sSQLText)
.head 10 -  Call ExportToTextTemplate(cRep.hSql(), sSQLText, sCreate_Stmt, sDBFileName)
.head 10 -  Call SqlClose(cRep.hSql())
.head 9 +  Else
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox( 'Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 9 -  Set sExportedFileName = sDBFileName
.head 8 -  ! Экспорт в Office
.head 8 +  Else If nFormat = 8 OR nFormat = 9
.head 9 -  !
.head 9 -  Set hWndRpt = SalCreateWindow(winReportDummy, hWndNULL, nKODZ, dDate1, dDate2, cRep.hSql(), cCnc1.hSql(),
    cCnc2.hSql(), nReportKod)
.head 9 -  ! Подготавливаем выражение
.head 9 +  If NOT SqlPrepare(cCnc.hSql(), sSQLText)
.head 10 -  ! Call MessageAttention('Не могу подготовить SQL:' || sSQLText)
.head 10 -  Call MessageAttention(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || sSQLText)
.head 10 -  Return FALSE
.head 9 -  ! sColTypes - Строка типов колонок для выгрузки в Excel
.head 9 -  Call SqlGetColTypes(cCnc.hSql(), sColTypes)
.head 9 -  ! Закрываем курсор
.head 9 -  Call SqlClose(cCnc.hSql())
.head 9 -  ! nFormat 1 - Excel 2 - Word (nFormat-7)
.head 9 -  Call ExportToOfficeFN(cRep.hSql(), sFileName, sSQLText, sColTypes, hWndRpt, nFormat-7, strCatQueryName, nMode)
.head 9 -  Call SalDestroyWindow(hWndRpt)
.head 9 -  Call SqlClose(cRep.hSql())
.head 9 -  Set sExportedFileName = sFileName
.head 8 -  ! ! DBF (через bars_dbf)
.head 8 +  Else If nFormat = EXP_DBF_DOS OR nFormat = EXP_DBF_WIN OR nFormat = EXP_DBF_UKG
.head 9 +  If nReportKod = 0
.head 10 +  If not SqlPrepareAndExecute(hSql(), "
   select emptyfiles
   into   :nCreateEmptyFiles
   from   reports
   where  id=:nReportKod") and SqlFetchNext(hSql(), nFetchRes)
.head 11 -  Call WaitCursorOff()
.head 11 -  Call SalMessageBox('Невозможно получить информацию по отчету № ' || SalNumberToStrX(nReportKod, 0),
     'Ошибка', MB_IconStop | MB_Ok)
.head 10 +  Else
.head 11 -  Set nCreateEmptyFiles = 1
.head 9 -  Call ExportToDbfBars(hSql(), sSQLText, sDBFileName, sCreate_Stmt, nFormat, nCreateEmptyFiles)
.head 9 -  Call SqlClose(hSql())
.head 9 -  Set sExportedFileName = sDBFileName
.head 8 -  ! XML через clob
.head 8 +  Else If nFormat = EXP_XML_WIN OR nFormat = EXP_XML_UTF 
.head 9 -  Call ExportToXMLCLOB(hSql(), sSQLText, sDBFileName, nFormat)
.head 9 -  Call SqlClose(hSql())
.head 9 -  Set sExportedFileName = sDBFileName
.head 9 +  ! Else
.head 10 -  ! Call SalMessageBox( 'Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox( CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 -  ! BLOB
.head 8 +  Else If nFormat = EXP_BLOB 
.head 9 -  Call ExportToBLOBFile(hSql(), sSQLText, sDBFileName)
.head 9 -  Call SqlClose(hSql())
.head 9 -  Set sExportedFileName = sDBFileName
.head 9 +  ! Else
.head 10 -  ! Call SalMessageBox( 'Не могу подготовить SQL выражение:
' || sSQLText, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox( CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrSQL') || ':' || PutCrLf() || sSQLText,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 +  Else If nFormat = EXP_NULL_OUTPUT
.head 9 -  Call SqlCommit(cRep.hSql())
.head 9 -  Call SqlClose(cRep.hSql())
.head 9 -  ! Цель данного формата - просто выполнить функции и процедуры (которые в свою очередь наполняют нужные таблицы)
.head 9 -  Set sExportedFileName = ''
.head 8 +  Else If nFormat = 99
.head 9 +  If hCatQueryTbl = hWndNULL
.head 10 -  Call WaitCursorOff()
.head 10 -  ! Call SalMessageBox('Внешний вызов функции ExportCatQuery с параметром 99 запрещен!', 'Ошибка',
  MB_IconStop | MB_Ok)
.head 10 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrFunc99'), 
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 9 +  Else
.head 10 -  Call ExportToInternalTable(cRep.hSql(), sSQLText, hCatQueryTbl)
.head 10 -  Set hCatQueryTbl = hWndNULL
.head 9 -  Call SqlClose(cRep.hSql())
.head 8 +  Else
.head 9 -  Call WaitCursorOff()
.head 9 -  ! Call SalMessageBox('Неизвестный формат экспорта каталогизированных запросов #' || SalNumberToStrX(nFormat, 0),
     'Ошибка', MB_IconStop | MB_Ok)
.head 9 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrExportFormat') ||
     SalNumberToStrX(nFormat, 0), CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 -  ! Друк звітів у електронний архів
.head 8 +  If GetGlobalOptionEx("EAPRINT") = 1 and sExportedFileName and VisFileGetSize(sExportedFileName) > 0
.head 9 -  Call SqlPrepareAndExecute(cRep.hSql(), "
     select 1
     into   :i
     from   ea_reports
     where  kodz=:nKODZ and active='Y'")
.head 9 +  If SqlFetchNext(cRep.hSql(), nFetchRes)
.head 10 -  Call VisDosSplitPath(sExportedFileName, sDrive, sDir, sBase, sExt)
.head 10 -  Set sTmpFileName = sBase || sExt
.head 10 -  ! Импорт файла
.head 10 +  If not PutFileToTmpLob(cRep.hSql(), sExportedFileName, 'B')
.head 11 -  Return FALSE
.head 10 +  If not SqlPLSQLCommand(cRep.hSql(), "set_eareportdata(nKODZ, sTmpFileName)")
.head 11 -  Return FALSE
.head 8 -  ! Закрытие соединений для winReportDummy
.head 8 +  If TRUE
.head 9 -  Call cCnc1.Disconnect()
.head 9 -  Call cCnc2.Disconnect()
.head 8 -  Set G_CURR_REP_FILENAME = sExportedFileName
.head 6 +  Else
.head 7 -  Call WaitCursorOff()
.head 7 -  ! Call SalMessageBox('Каталогизированный запрос со следующим кодом не найден #' || SalNumberToStrX(nKODZ, 0) || '!',
     'Ошибка', MB_IconStop | MB_Ok)
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrQueryNotFound') || SalNumberToStrX(nKODZ,0) ||
     '!', CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 5 +  Else
.head 6 -  Call WaitCursorOff()
.head 6 -  ! Call SalMessageBox('Нельзя прочитать параметры запроса #' || SalNumberToStrX(nKODZ, 0) || '!', 'Ошибка',
  MB_IconStop | MB_Ok)
.head 6 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrQueryParams') || SalNumberToStrX(nKODZ, 0) ||
     '!', CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 5 +  If nLevel = 0
.head 6 -  Call cCnc.Disconnect()
.head 6 -  Call WaitCursorOff()
.head 3 -  ! Ф-ция для выполнения в виде функции в operlist + выполнение кат.запросов в форме редактирования кат.запросов
.head 3 +  Function: ExportCatQuery	! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Код запроса
.head 5 -  Number: nKODZ
.head 5 -  ! Файл запроса с полным путем
.head 5 -  String: sFileName
.head 5 -  ! Формат
.head 5 -  Number: nFormat
.head 5 -  ! Параметры отчета, упакованные в строку с помощью класса cParams
(может быть пустым) Если fAskParams=TRUE то значения из sParams 
прибавляются к введенным, но их значения по не устанавливаются по 
умолчанию в диалоге ввода параметров
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  Boolean: fAskParams
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  ! Call ExportCatQueryDel(nKODZ, sFileName, nFormat, sParams, fAskParams, TRUE)
.head 5 -  Call ExportCatQueryEx(nKODZ, sFileName, nFormat, sParams, fAskParams, TRUE)
.head 5 +  If ShowEndReportMessageOn = 1
.head 6 -  If showEndReportMessage(G_CURR_REP_FILENAME)
.head 3 -  ! Ф-ция для выполнения в repbank (главная форма)
.head 3 +  Function: ExportCatQueryRep	! __exported
.head 4 -  Description: Выполнить экспорт каталогизированного запроса
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  : cRep
.head 6 -  Class: cABSConnect
.head 5 -  ! Код запроса
.head 5 -  Number: nKODZ
.head 5 -  ! Файл запроса с полным путем
.head 5 -  String: sFileName
.head 5 -  ! Формат
.head 5 -  Number: nFormat
.head 5 -  ! Параметры отчета, упакованные в строку с помощью класса cParams
(может быть пустым) Если fAskParams=TRUE то значения из sParams 
прибавляются к введенным, но их значения по не устанавливаются по 
умолчанию в диалоге ввода параметров
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  Boolean: fAskParams
.head 5 -  ! Удалять пустые строки отчета
.head 5 -  Boolean: bDeleteOnNullString
.head 5 -  ! Режим открытия приложения для просмотра отчета (1-NoPrint, 0-Normal)
.head 5 -  Number: nMode	
.head 5 -  ! Код печатного отчета
.head 5 -  Number: nReportKod
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call ExportCatQueryMain(cRep, nKODZ,sFileName,nFormat,sParams,fAskParams,bDeleteOnNullString,nMode,nReportKod)
.head 5 +  If ShowEndReportMessageOn = 1
.head 6 -  If showEndReportMessage(G_CURR_REP_FILENAME)
.head 3 -  ! функция используется в списке задач по-расписанию (устаревшая, можно использовать ExportCatQuery)
.head 3 +  Function: ExportCatQueryRepAuto	! __exported
.head 4 -  Description: Выполнить экспорт каталогизированного запроса (avtomat)
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  Number: nKODZ
.head 5 -  ! Файл запроса с полным путем
.head 5 -  String: sFileName
.head 5 -  Number: nFormat
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  Boolean: fAskParams
.head 5 -  ! Удалять пустые строки отчета
.head 5 -  Boolean: bDeleteOnNullString
.head 5 -  ! Режим открытия приложения для просмотра отчета (1-NoPrint, 0-Normal)
.head 5 -  Number: nMode
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  : cCnc1
.head 6 -  Class: cABSConnect
.head 4 +  Actions
.head 5 -  Call XConnectGetParams( cCnc1 )
.head 5 -  Call cCnc1.Connect()
.head 5 -  Call ExportCatQueryMain(cCnc1, nKODZ,sFileName,nFormat,sParams,fAskParams,bDeleteOnNullString,nMode, 0)
.head 5 -  Call cCnc1.Disconnect()
.head 3 -  ! функция-попытка все унифицировать (неудавшаяся)
.head 3 +  Function: ExportCatQueryEx	! __exported
.head 4 -  Description:
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Код запроса
.head 5 -  Number: nKODZ
.head 5 -  ! Файл запроса с полным путем
.head 5 -  Receive String: sFileName
.head 5 -  ! Формат
.head 5 -  Number: nFormat
.head 5 -  ! Параметры отчета, упакованные в строку с помощью класса cParams
(может быть пустым) Если fAskParams=TRUE то значения из sParams 
прибавляются к введенным, но их значения по не устанавливаются по 
умолчанию в диалоге ввода параметров
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  Boolean: fAskParams
.head 5 -  ! Удалять пустые строки отчета
.head 5 -  Boolean: bDelOnNull
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  : cCnc1
.head 6 -  Class: cABSConnect
.head 4 +  Actions
.head 5 -  Call XConnectGetParams( cCnc1 )
.head 5 -  Call cCnc1.Connect()
.head 5 -  Call ExportCatQueryMain(cCnc1, nKODZ,sFileName,nFormat,sParams,fAskParams,bDelOnNull,0,0)
.head 5 -  Call cCnc1.Disconnect()
.head 3 -  !
.head 3 -  !
.head 3 -  !
.head 3 +  Function: ExportCatQueryDotNet	! __exported
.head 4 -  Description: Выполнить экспорт каталогизированного запроса
Формат:
3-REPORT (*.txt)
6-REPORT (*.rtf)
7-REPORT (с разделителями)
y-REPORT (что-то еще)
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  ! Хендлы SQL
.head 5 -  Sql Handle: hSql
.head 5 -  !
.head 5 -  Sql Handle: hSqlAux
.head 5 -  !
.head 5 -  Sql Handle: hSqlEx
.head 5 -  ! Код сессии
.head 5 -  Number: nSessionId
.head 5 -  ! Формат
.head 5 -  Number: nFormat
.head 5 -  ! Файл запроса с полным путем
.head 5 -  String: sReportFileName
.head 5 -  ! ! Каталог шаблонов отчетов
.head 5 -  String: sTemplateDir
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Long String: lsSQLText
.head 5 -  String: sSQLText
.head 5 -  !
.head 5 -  Number: nFetchRes
.head 5 -  String: sRpt_Template
.head 5 -  !
.head 5 -  Window Handle: hWndRpt
.head 5 -  !
.head 5 -  Date/Time: dDate1
.head 5 -  Date/Time: dDate2
.head 5 -  !
.head 5 -  ! Код запроса
.head 5 -  Number: nKODZ
.head 5 -  !
.head 5 -  Number: nResult
.head 5 -  Number: nReportKod
.head 5 -  Long String: lsFieldDesc
.head 5 -  Number: nRow
.head 4 +  Actions
.head 5 -  Set nReportKod=0
.head 5 -  Call TraceMessage('Start ExportCatQueryDotNet()')
.head 5 -  Call OtcnIni()
.head 5 -  ! Поиск сессии
.head 5 +  If SqlPrepareAndExecute( hSql, '
SELECT INT_SQL, QUERY_ID, TEMPLATE, DATE1, DATE2
INTO :lsSQLText, :nKODZ, :sRpt_Template, :dDate1, :dDate2
FROM RS_TMP_SESSION_DATA WHERE SESSION_ID = :nSessionId' )
.head 6 +  If SqlFetchNext( hSql, nFetchRes )
.head 7 -  Call SqlClose( hSql )
.head 7 -  ! Текст SQL
.head 7 -  Set sSQLText=lsSQLText
.head 7 -  ! Report TXT or RTF
.head 7 -  !
.head 7 -  Call TraceMessage('nFormat = '||SalNumberToStrX(nFormat,0))
.head 7 +  If nFormat=3 OR nFormat=6
.head 8 -  Call TraceMessage('nFormat=3 OR nFormat=6')
.head 8 -  Set hWndRpt=SalCreateWindow( winReportDummy, hWndNULL, nKODZ, dDate1, dDate2, hSql, hSqlAux, hSqlEx, nReportKod ) 
.head 8 -  Call SqlPrepare( hSql, sSQLText  )
.head 8 -  Call SqlAddIntoStatement( hSql, sSQLText )
.head 8 -  ! Подготовка глобальных параметров для вызова ExportToReport
.head 8 -  Set nExitCode=0
.head 8 -  Set fDotNetMode=TRUE
.head 8 -  Set SESSION_ID=nSessionId
.head 8 -  Call ExportToReport( 
hSql, 
sSQLText,
hWndRpt,
sTemplateDir || '\\' || sRpt_Template, 
sReportFileName, 
nFormat=6, 
FALSE, 
TRUE)
.head 8 -  Set nResult=nExitCode
.head 8 -  Call SalDestroyWindow( hWndRpt )
.head 8 -  Call SqlClose( hSql )
.head 7 +  Else
.head 8 +  If nFormat=7
.head 9 -  Call TraceMessage('nFormat=7')
.head 9 -  Set nExitCode=0
.head 9 -  Set fDotNetMode=TRUE
.head 9 -  Set SESSION_ID=nSessionId
.head 9 -  !
.head 9 -  Call TraceMessage('Before select from zapros nSessionId='||SalNumberToStrX(nSessionId,2))
.head 9 -  ! Найти описание формата для отчета для данной сессии
.head 9 +  If SqlPrepareAndExecute(hSqlAux,
"select create_stmt
   into :lsFieldDesc  
   from zapros z, reports r, cbirep_queries c 
  where c.rep_id  = r.id 
    and form = 'frm_UniReport' 
    and substr(param, 1, instr(param, ',')-1) = to_char(z.kodz)
    and session_id = :nSessionId
 ")

.head 10 -  Call TraceMessage('After prepare select from zapros')
.head 10 +  If SqlFetchNext(hSqlAux, nRow) 
.head 11 -  Call SqlPrepare( hSql, sSQLText  )
.head 11 -  Call TraceMessage(sSQLText)
.head 11 -  Call SqlAddIntoStatement( hSql, sSQLText )
.head 11 -  Set nResult = ExportToTxtDelim(hSql, sSQLText,lsFieldDesc, sReportFileName)
.head 11 -  Call SqlClose( hSqlAux )
.head 11 -  Return nResult
.head 10 +  Else
.head 11 -  Set nResult=66
.head 11 -  Return nResult
.head 9 +  Else
.head 10 -  Set nResult=55
.head 10 -  Return nResult
.head 8 +  Else
.head 9 -  Set nResult=44
.head 9 -  Return nResult
.head 7 -  !
.head 6 +  Else
.head 7 -  Set nResult=6
.head 7 -  Return nResult
.head 5 +  Else
.head 6 -  Call TraceMessage('Failed to select from RS_TMP_SESSION_DATA')
.head 6 -  Set nResult=6
.head 6 -  Return nResult
.head 5 -  Call TraceMessage('Finish ExportCatQueryDotNet()')
.head 3 +  Function: GetCatQueryResult	! __exported
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  String:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Return sCatQueryResult
.head 3 +  Function: ExportRepData		! __exported
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Number: nSId
.head 5 -  Receive String: sRet
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nRepId
.head 5 -  Long String: lsRepXmlParams
.head 5 -  !
.head 5 -  String: sRepParam
.head 5 -  String: sRepMask
.head 5 -  String: sRepNameF
.head 5 -  Long String: lsRepBindVars
.head 5 -  Long String: lsRepBindSql
.head 5 -  String: sBindList
.head 5 -  String: sBindSql
.head 5 -  Number: nBindsCount
.head 5 -  : cBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  : cPar
.head 6 -  Class: cParams
.head 5 -  !
.head 5 -  String: smRepParam[*]
.head 5 -  Number: nFormat
.head 5 -  Boolean: fOverrideFilename
.head 5 -  String: sFileNameSql
.head 5 -  !
.head 5 -  String: sOutFile
.head 5 -  String: strDateFrom
.head 4 +  Actions
.head 5 -  Set sRet = ''
.head 5 -  ! Читаем параметры отчета
.head 5 -  Call SqlSetLongBindDatatype(2, 22)
.head 5 -  Call SqlPrepareAndExecute(hSql(),
"select rep_id, xml_params
   into :nRepId, :lsRepXmlParams
   from v_cbirep_represults
  where session_id = :nSId")
.head 5 +  If not SqlFetchNext(hSql(), nFetchRes)
.head 6 -  Return FALSE
.head 5 -  ! Читаем параметры кат. запроса
.head 5 -  Call SqlSetLongBindDatatype(4, 22)
.head 5 -  Call SqlSetLongBindDatatype(5, 22)
.head 5 -  Call SqlPrepareAndExecute(hSql(),
"select param, mask, namef, bindvars, bind_sql
   into :sRepParam, :sRepMask, :sRepNameF,
        :lsRepBindVars, :lsRepBindSql
   from v_cbirep_repparams
  where rep_id = :nRepId")
.head 5 +  If not SqlFetchNext(hSql(), nFetchRes)
.head 6 -  Return FALSE
.head 5 -  ! Разбор параметров кат.запроса
.head 5 -  Set sBindList = lsRepBindVars
.head 5 -  Set sBindSql  = lsRepBindSql
.head 5 -  Set nBindsCount = GetQueryBindsList(sBindList, sBindSql, cBinds)
.head 5 -  ! Читаем установленные параметры кат.запроса
.head 5 -  Call GetRepParams(lsRepXmlParams, cBinds, nBindsCount, strDateFrom)
.head 5 -  ! Парметры отчета (reports.param)
.head 5 -  Call SalStrTokenize(sRepParam, '', ',', smRepParam)
.head 5 -  Set nFormat = Val(smRepParam[1])
.head 5 -  Set fOverrideFilename = IifN(smRepParam[6]='TRUE', 1, 0)
.head 5 -  !
.head 5 -  ! == Имя выходного файла
.head 5 -  Set sOutFile = ''
.head 5 -  ! Для fOverrideFilename=FALSE имя файла расчитывается по стандартной формуле или берется из mask
.head 5 +  If (nFormat = 3 or nFormat = 6) and not fOverrideFilename
.head 6 +  ! If nFormat = 6 and not strFileNameRtf
.head 7 -      Set sOutFile = VisStrSubstitute(strFileNameTxt, '.txt', '.rtf')
.head 6 +  ! Else If nFormat = 3 and not strFileNameTxt
.head 7 -      Set sOutFile = VisStrSubstitute(strFileNameRtf, '.rtf', '.txt')
.head 6 +  ! Else
.head 7 -      Set sOutFile = IifS(nFormat=6, strFileNameRtf, strFileNameTxt)
.head 6 -  Set sOutFile = GetPrnDir() || '\\' ||
    IifS(sRepMask=STRING_Null,
       NumberToStrFormat(nRepId, 3, '0', TRUE) ||
       GetCharForDigit(SalStrToNumber(SalStrMidX(strDateFrom, 0, 2))) ||
       GetCharForDigit(SalStrToNumber(SalStrMidX(strDateFrom, 3, 2))) ||
       NumberToStrFormat(GetUserId(), 3, '0', TRUE),
    sRepMask) || IifS(nFormat=6, '.rtf', '.txt')
.head 5 -  ! иначе - из настроек кат. запроса
.head 5 +  Else
.head 6 -  ! Формула имени файла
.head 6 +  If SalStrLeftX(sRepNameF, 1) = '='
.head 7 -  Set sOutFile = ApplyQueryBinds(SalStrRightX(sRepNameF, SalStrLength(sRepNameF) - 1), cBinds, nBindsCount )
.head 7 -  Set sFileNameSql = 'SELECT ' || sOutFile || ' INTO :sOutFile FROM DUAL '
.head 7 +  If SqlPrepareAndExecute(hSql(), sFileNameSql)
.head 8 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 7 +  Else
.head 8 -  ! Call SaveInfoToLog('otcn(3): sFileNameSql = ' || sFileNameSql)
.head 8 -  ! Ошибка при вычислении имени файла: sFileNameSql
.head 8 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('ExportCatQuery.cTErrFileName') || ':' || PutCrLf() || sFileNameSql,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 8 -  Return FALSE
.head 5 -  ! rep_gen.exe  PRAVEX 533 3 C:\WINDOWS\TEMP\CbiReports\Report43_user19_12463812517886050.txt C:\Inetpub\wwwrootPRAVEX\TEMPLATE.RPT true C:\WINDOWS\TEMP\rep_gen.trc
 
rep_gen.exe - должен лежать в папке бин и быть виден по путям
PRAVEX - имя базы, должен быть в tnsnames.ora и sql.ini
3 - формат отчета (3 - txt, 6 - rtf)
C:\WINDOWS\TEMP\CbiReports\Report43_user19_12463812517886050.txt - полный путь к результирующему файлу
C:\Inetpub\wwwrootPRAVEX\TEMPLATE.RPT - путь к папке шаблонов
true - включить/выключить трассу
C:\WINDOWS\TEMP\rep_gen.trc - путь к файлу трассы (сейчас не работает)
.head 5 +  If not sOutFile
.head 6 -  Call SalMessageBox('Не определено имя выходного файла!', 
     CurrentLangTable.GetAtomTitle('cTErr'), MB_IconStop | MB_Ok)
.head 6 -  Return FALSE
.head 5 +  If not SalLoadApp('rep_gen.exe',
     SqlDatabase      || ' ' ||
     Str(nSId)        || ' ' ||
     Str(nFormat)     || ' ' ||
     sOutFile         || ' ' ||
     GetTemplateDir() || ' ' ||
     'false'          || ' ' ||
     GetPrnDir() || '\\rep_gen.trc' )
.head 6 -  Return FALSE
.head 5 -  Set sRet = sOutFile
.head 5 -  Return TRUE
.head 3 -  ! Внутр. функции
.head 3 +  Function: SetQueryBinds
.head 4 -  Description: Устанавливает значения бинд переменных
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Window Handle: hWnd_
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Number: nBNum
.head 5 -  Number: nReportKod  ! Код друкованого звіту
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 +  If nBNum = 0
.head 6 -  Return TRUE
.head 5 +  Else
.head 6 -  Return SalModalDialog( dlg_BindSet, hWnd_, sBinds, nBNum )
.head 3 +  Function: SetQueryBindsDat	! __exported
.head 4 -  Description: Устанавливает значения бинд переменных
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Window Handle: hWnd
.head 5 -  ! cQueryBind: sBinds[*]
.winattr class :
.head 6 -  Class: cQueryBind
.end
.head 5 -  ! Number: nBNum
.head 5 -  String: sParams
.head 5 -  Long String: lsBindVars
.head 5 -  Long String: lsDefVars
.head 5 -  Long String: lsBindSql
.head 5 -  Receive Long String: lsXmlParams
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Long String: lsTmp
.head 5 -  Number: nRet
.head 4 +  Actions
.head 5 +  If sParams = '' and lsBindVars = ''
.head 6 -  Return TRUE
.head 5 +  Else
.head 6 -  Set lsTmp = lsXmlParams
.head 6 -  Set nRet = SalModalDialog(dlg_BindSetDat, hWnd, sParams, lsBindVars, lsDefVars, lsBindSql, lsTmp)
.head 6 -  Set lsXmlParams = lsTmp
.head 6 -  Return nRet
.head 3 +  Function: GetQueryBindsList
.head 4 -  Description: Получить список бинд переменных запроса (до/переписать)
с установкой 
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  String: sParams
.head 5 -  String: sParamsSQL ! Описание SQL для параметра
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nBNum
.head 5 -  Number: nCount
.head 5 -  String: strBindName
.head 5 -  : P
.head 6 -  Class: cParams
.head 5 -  : ParamSQL
.head 6 -  Class: cParams
.head 4 +  Actions
.head 5 -  Set nBNum = 0
.head 5 -  Call P.Clear( )
.head 5 -  Call ParamSQL.Clear( )
.head 5 +  If sParams != ''
.head 6 -  Call P.SetParams( sParams )
.head 5 +  If sParamsSQL != ''
.head 6 -  Call ParamSQL.SetParams( sParamsSQL )
.head 5 -  !
.head 5 -  Set nCount = P.ParamsCount()
.head 5 +  While nBNum < nCount
.head 6 -  Set strBindName = P.ParamName( nBNum )
.head 6 -  Set sBinds[nBNum].sName = strBindName
.head 6 -  Set sBinds[nBNum].sType = 'S'
.head 6 -  Set sBinds[nBNum].sSemantic = P.GetAsString( strBindName )
.head 6 -  Set sBinds[nBNum].sVal = ''
.head 6 +  If ParamSQL.IndexOf( strBindName ) > -1
.head 7 -  Set sBinds[nBNum].sDescSQL = ParamSQL.GetAsString( strBindName )
.head 6 +  Else
.head 7 -  Set sBinds[nBNum].sDescSQL = ''
.head 6 -  !
.head 6 -  Set nBNum = nBNum + 1
.head 5 -  Return nCount
.head 3 +  Function: CreateBindsList
.head 4 -  Description: Получить список бинд переменных запроса
.head 4 +  Returns
.head 5 -  Number:
.head 4 +  Parameters
.head 5 -  String: sParams
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nBNum
.head 5 -  Number: nCount
.head 5 -  String: strBindName
.head 5 -  : P
.head 6 -  Class: cParams
.head 4 +  Actions
.head 5 -  Set nBNum = 0
.head 5 -  Call P.Clear( )
.head 5 -  Call SalArraySetUpperBound( sBinds, 1, -1 )
.head 5 +  If sParams != ''
.head 6 -  Call P.SetParams( sParams )
.head 5 -  Set nCount = P.ParamsCount()
.head 5 +  While nBNum < nCount
.head 6 -  Set strBindName = P.ParamName( nBNum )
.head 6 -  Set sBinds[nBNum].sName = strBindName
.head 6 -  Set sBinds[nBNum].sType = 'S'
.head 6 -  Set sBinds[nBNum].sSemantic = ''
.head 6 -  Set sBinds[nBNum].sVal = P.GetAsString( strBindName )
.head 6 -  !
.head 6 -  Set nBNum = nBNum + 1
.head 5 -  Return nCount
.head 3 +  Function: ApplyQueryBinds
.head 4 -  Description: Заменяет бинды на их значения
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  String: sQuery
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Number: nBNum
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: ni
.head 5 -  String: sNewQuery
.head 4 +  Actions
.head 5 -  Set ni = 0
.head 5 -  Set sNewQuery = VisStrRightTrim( VisStrLeftTrim( sQuery ))
.head 5 +  Loop
.head 6 +  If ni >= nBNum
.head 7 -  Break
.head 6 +  If sBinds[ni].sType = 'D'
.head 7 +  If SalStrTrimX(SalStrUpperX(GetDBMS()))='ORACLE'
.head 8 -  Set sNewQuery = VisStrSubstitute( sNewQuery, sBinds[ni].sName, 'TO_DATE(\'' || sBinds[ni].sVal || '\',\'DD/MM/YYYY\')' )
.head 7 +  Else
.head 8 -  Set sNewQuery = VisStrSubstitute( sNewQuery, sBinds[ni].sName, 'date(\'' || sBinds[ni].sVal || '\')' )
.head 6 +  Else If sBinds[ni].sType = 'N'
.head 7 -  Set sNewQuery = VisStrSubstitute( sNewQuery, sBinds[ni].sName, sBinds[ni].sVal )
.head 6 +  Else
.head 7 -  ! Передача значения на прямую в SQL (Изменение структуры)
.head 7 +  If SalStrLength( sBinds[ni].sName )>=10 AND SalStrUpperX( SalStrRightX( sBinds[ni].sName, 8 ) )='_PDTOSQL'
.head 8 -  Set sNewQuery = VisStrSubstitute( sNewQuery, sBinds[ni].sName, sBinds[ni].sVal )
.head 7 -  ! Строковый параметр
.head 7 +  Else
.head 8 -  Set sNewQuery = VisStrSubstitute( sNewQuery, sBinds[ni].sName, '\'' || sBinds[ni].sVal || '\'' )
.head 6 -  Set ni = ni + 1
.head 5 -  Return sNewQuery
.head 3 +  Function: ApplyQueryFields
.head 4 -  Description: Заменяет поля на их значения
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  String: sText
.head 5 -  : iCols[200]
.head 6 -  Class: cSqlColumnDescriptor
.head 5 -  Number: nColumnСount
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: i
.head 5 -  String: sResult
.head 4 +  Actions
.head 5 -  Set i = 0
.head 5 -  Set sResult = VisStrRightTrim( VisStrLeftTrim( sText ))
.head 5 +  While i < nColumnСount
.head 6 -  Set sResult = VisStrSubstitute( 
  sResult, 
  ':' || iCols[i].strColName, 
  FieldByName( iCols, nColumnСount, iCols[i].strColName ) )
.head 6 -  Set i = i + 1
.head 5 -  Return sResult
.head 3 +  Function: SubstExt
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  String: sFilename
.head 5 -  String: sNewExt
.head 5 -  ! Заменять только если расширение отсутствует
.head 5 -  Boolean: fSubstWhenNoExt
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: tDrive
.head 5 -  String: tDir
.head 5 -  String: tBase
.head 5 -  String: tExt
.head 4 +  Actions
.head 5 -  Call VisDosSplitPath( sFilename, tDrive, tDir, tBase, tExt )
.head 5 +  If sNewExt
.head 6 +  If NOT fSubstWhenNoExt OR NOT tExt
.head 7 -  Return VisDosMakePath(tDrive, tDir, tBase, '.' || sNewExt)
.head 6 +  Else
.head 7 -  Return sFilename
.head 5 +  Else
.head 6 -  Return VisDosMakePath(tDrive, tDir, tBase, '' )
.head 3 +  Function: GetBindsAsString
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Number: nBindsCount
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: i
.head 5 -  String: sResult
.head 4 +  Actions
.head 5 -  Set i=0
.head 5 -  Set sResult = ''
.head 5 +  While i<nBindsCount
.head 6 +  If sBinds[i].sSemantic
.head 7 -  Set sResult = sResult || sBinds[i].sSemantic || 
' = "' || sBinds[i].sVal || '" '
.head 6 +  Else
.head 7 -  Set sResult = sResult || sBinds[i].sName || 
' = "' || sBinds[i].sVal || '" '
.head 6 -  Set i = i + 1
.head 5 -  Return sResult
.head 3 +  Function: ExportXML		! __exported
.head 4 -  Description: Для версий ORACLE 9.2 и выше!!!
(вариант с параметрами)
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  ! Код запроса
.head 5 -  Number: nKODZ
.head 5 -  ! Файл запроса с полным путем
.head 5 -  String: sFileName
.head 5 -  ! Параметры отчета, упакованные в строку с помощью класса cParams
(может быть пустым) Если fAskParams=TRUE то значения из sParams
прибавляются к введенным, но их значения по не устанавливаются по
умолчанию в диалоге ввода параметров
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  Boolean: fAskParams
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Long String: lsSQLText
.head 5 -  Long String: sSQLText
.head 5 -  Long String: lsBindList
.head 5 -  Long String: sBindList
.head 5 -  Long String: lsBindSQL
.head 5 -  Long String: sBindSQL
.head 5 -  Long String: lsDefault_Vars
.head 5 -  Long String: sDefault_Vars
.head 5 -  String: sForm_Proc
.head 5 -  !
.head 5 -  Number: nKodR
.head 5 -  String: sDBFileName
.head 5 -  String: sFileNameSql
.head 5 -  Number: nBindsCount
.head 5 -  : cPar
.head 6 -  Class: cParams
.head 5 -  Number: i
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Date/Time: dDate1
.head 5 -  Date/Time: dDate2
.head 5 -  ! Complex
.head 5 -  String: sMainParams
.head 5 -  String: sAuxParams
.head 5 -  String: sAuxParamsExp
.head 5 -  !
.head 5 -  Number: nL
.head 5 -  Number: nKod
.head 5 -  Number: nNum
.head 5 -  File Handle: hF
.head 5 -  Long String: sXML
.head 5 -  Long String: sXMLParams
.head 5 -  Long String: sXMLBlock
.head 5 -  Long String: sXMLSelect
.head 5 -  Long String: sXMLXsl
.head 5 -  Number: ni
.head 5 -  !
.head 5 -  Long String: lsValidateRes
.head 5 -  String: sXsdLog
.head 5 -  String: sXsdLogFileName
.head 5 -  String: msTmpPar[*]
.head 5 -  Number: nTokenize
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 +  If NOT SqlPrepareAndExecute(hSql(), 
"SELECT namef, dbms_lob.getlength(xsl_data), kodr
 INTO :sDBFileName, :nL, :nKodR
 FROM zapros WHERE kodz=:nKODZ") 
.head 6 -  Call Debug('Неуспешное выполнение запроса SELECT FROM ZAPROS')
.head 6 -  Call WaitCursorOff()
.head 6 -  Return FALSE
.head 5 +  If NOT SqlFetchNext(hSql(), nFetchRes)
.head 6 -  Call Debug('Нет запроса с № ' || Str(nKODZ))
.head 6 -  Call WaitCursorOff()
.head 6 -  Return FALSE
.head 5 +  If nL = 0 OR nL = NUMBER_Null
.head 6 -  Call SalMessageBox('Отсутствует XSL-выражение для запроса №' || SalNumberToStrX(nKODZ, 0) || '!' || PutCrLf() ||
     'Невозможно создать XML-отчет.', 'Внимание!', MB_IconStop | MB_Ok)
.head 6 -  Call WaitCursorOff()
.head 6 -  Return FALSE
.head 5 +  If NOT sDBFileName AND NOT sFileName
.head 6 -  Call SalMessageBox('Не задано имя формируемого файла!', 'Ошибка', MB_IconStop | MB_Ok)
.head 6 -  Return FALSE
.head 5 +  If sDBFileName = '' AND sFileName != ''
.head 6 -  Set sDBFileName = sFileName
.head 5 -  Set sXMLParams = 
'<?xml version = "1.0" encoding = "windows-1251"?>'||
'<PARAMS xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="params.xsd">'
.head 5 -  Set sXMLXsl = ''
.head 5 -  Set nKod = nKODZ
.head 5 +  Loop
.head 6 -  Call SqlPrepareAndExecute(hSql(), 
"SELECT BINDVARS, DEFAULT_VARS, FORM_PROC, KODR, BIND_SQL
 INTO :lsBindList, :lsDefault_Vars, :sForm_Proc, :nKodR, :lsBindSQL
 FROM zapros WHERE kodz=:nKod")
.head 6 +  If NOT SqlFetchNext(hSql(), nFetchRes)
.head 7 -  Call Debug('Нет запроса с № ' || Str(nKod))
.head 7 -  Call WaitCursorOff()
.head 7 -  Return FALSE
.head 6 -  ! Бинд-переменные
.head 6 -  Set sBindList = lsBindList
.head 6 -  Set sDefault_Vars = lsDefault_Vars
.head 6 -  Set sBindSQL = lsBindSQL
.head 6 -  ! Текст SQL
.head 6 -  Set lsSQLText = GetStringFromClob(hSql(), 'zapros', 'kodz', 'txt', nKod, '', '')
.head 6 -  Set sSQLText  = lsSQLText
.head 6 -  !
.head 6 -  Set sXMLBlock  = ''
.head 6 -  Set sXMLSelect = ''
.head 6 -  ! Уст. параметров
.head 6 +  If fAskParams
.head 7 -  ! Вызов диалога параметров
.head 7 -  ! Разбор параметров
.head 7 -  Set nBindsCount = GetQueryBindsList(sBindList, sBindSQL, sBinds)
.head 7 -  ! Диалог
.head 7 +  If nBindsCount > 0
.head 8 -  ! Установка умолч. значений параметров
.head 8 +  If sDefault_Vars
.head 9 -  Call cPar.SetParams(sDefault_Vars)
.head 9 -  Set i = 0
.head 9 +  While i < nBindsCount
.head 10 +  If cPar.IndexOf(sBinds[i].sName) >= 0
.head 11 -  Set sBinds[i].sVal=cPar.GetAsString(sBinds[i].sName)
.head 11 -  ! Set sBinds[i].sSemantic=sBinds[i].sName
.head 11 +  If At(':sFdat1', sBinds[i].sName) > 0
.head 12 -  Set sBinds[i].sSemantic = VisStrSubstitute(sBinds[i].sName, ':sFdat1', 'Дата с (за)')
.head 11 +  If At(':sFdat2', sBinds[i].sName) > 0
.head 12 -  Set sBinds[i].sSemantic = VisStrSubstitute(sBinds[i].sName, ':sFdat2', 'Дата по')
.head 10 -  Set i = i + 1
.head 9 -  Call cPar.Clear()
.head 8 -  ! Вызов диалога
.head 8 +  If NOT SetQueryBinds(hWndMDI, sBinds, nBindsCount,0)
.head 9 -  Call WaitCursorOff()
.head 9 -  Return FALSE
.head 8 -  Call WaitCursorOn()
.head 7 -  ! Добавление параметров переданных в sParams
.head 7 +  If sParams
.head 8 -  Call cPar.Clear()
.head 8 -  Call cPar.SetParams(sParams)
.head 8 -  Set i = 0
.head 8 +  While i < nBindsCount
.head 9 +  If cPar.IndexOf(sBinds[i].sName) >= 0
.head 10 -  Set sBinds[i].sVal=cPar.GetAsString(sBinds[i].sName)
.head 9 -  Set i = i + 1
.head 8 -  ! Параметры даты
.head 8 +  If cPar.IndexOf(':sFdat1') >= 0
.head 9 -  Set dDate1 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat1'), 'dd/MM/yyyy')
.head 8 +  If cPar.IndexOf(':sFdat2') >= 0
.head 9 -  Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat2'), 'dd/MM/yyyy')
.head 7 -  ! Внедрение значений параметров в SQL
.head 7 -  ! Set sSQLText = ApplyQueryBinds( sSQLText, sBinds, nBindsCount )
.head 7 -  ! ==========================
.head 7 -  Set ni = 0
.head 7 -  Set nNum = 1
.head 7 +  Loop
.head 8 +  If ni >= nBindsCount
.head 9 +  If sXMLSelect != ''
.head 10 -  Set sXMLSelect = sXMLSelect || '</PARAMSET>'
.head 9 -  Break
.head 8 +  If SalStrScan(sSQLText, sBinds[ni].sName) >= 0
.head 9 +  If sXMLSelect = ''
.head 10 -  Set sXMLSelect = '<PARAMSET kodz="' || Str(nKod) || '" type="select">'
.head 9 -  Set sXMLSelect = sXMLSelect || 
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1) || '</NAME>' ||
  '<VALUE>' || sBinds[ni].sVal || '</VALUE>' ||
'</PARAM>'
.head 9 -  Set nNum = nNum + 1
.head 8 -  Set ni = ni + 1
.head 7 -  ! ==========================
.head 7 -  ! Передаем параметры в XSL_DATA
.head 7 +  If nKod = nKODZ
.head 8 -  Set ni = 0
.head 8 -  Set nNum = 1
.head 8 +  Loop
.head 9 +  If ni >= nBindsCount
.head 10 +  If sXMLXsl != ''
.head 11 -  Set sXMLXsl = sXMLXsl || '</PARAMSET>'
.head 10 -  Break
.head 9 +  If sXMLXsl = ''
.head 10 -  Set sXMLXsl = '<PARAMSET kodz="' || Str(nKod) || '" type="xsl">'
.head 9 -  Set sXMLXsl = sXMLXsl || 
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1) || '</NAME>' ||
  '<VALUE>' || sBinds[ni].sVal || '</VALUE>' ||
'</PARAM>'
.head 9 -  Set nNum = nNum + 1
.head 9 -  Set ni = ni + 1
.head 7 -  ! ==========================
.head 6 +  Else If sParams
.head 7 -  ! Заполнение параметров из переменной
.head 7 -  Set nBindsCount = GetQueryBindsList(sBindList, '', sBinds)
.head 7 -  Call cPar.SetParams(sParams)
.head 7 -  Set i = 0
.head 7 +  While i < nBindsCount
.head 8 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 8 -  Set i = i + 1
.head 7 -  ! Параметры даты
.head 7 +  If cPar.IndexOf(':sFdat1') >= 0
.head 8 -  Set dDate1 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat1'), 'dd/MM/yyyy')
.head 7 +  If cPar.IndexOf(':sFdat2') >= 0
.head 8 -  Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat2'), 'dd/MM/yyyy')
.head 7 -  ! Set sSQLText = ApplyQueryBinds( sSQLText, sBinds, nBindsCount )
.head 7 -  ! ==========================
.head 7 -  Set ni = 0
.head 7 -  Set nNum = 1
.head 7 +  Loop
.head 8 +  If ni >= nBindsCount
.head 9 +  If sXMLSelect != ''
.head 10 -  Set sXMLSelect = sXMLSelect || '</PARAMSET>'
.head 9 -  Break
.head 8 +  If SalStrScan(sSQLText, sBinds[ni].sName) >= 0
.head 9 +  If sXMLSelect = ''
.head 10 -  Set sXMLSelect = '<PARAMSET kodz="' || Str(nKod) || '" type="select">'
.head 9 -  Set sXMLSelect = sXMLSelect || 
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1) || '</NAME>' ||
  '<VALUE>' || sBinds[ni].sVal || '</VALUE>' ||
'</PARAM>'
.head 9 -  Set nNum = nNum + 1
.head 8 -  Set ni = ni + 1
.head 7 -  ! ==========================
.head 7 -  ! Передаем параметры в XSL_DATA
.head 7 +  If nKod = nKODZ
.head 8 -  Set ni = 0
.head 8 -  Set nNum = 1
.head 8 +  Loop
.head 9 +  If ni >= nBindsCount
.head 10 +  If sXMLXsl != ''
.head 11 -  Set sXMLXsl = sXMLXsl || '</PARAMSET>'
.head 10 -  Break
.head 9 +  If sXMLXsl = ''
.head 10 -  Set sXMLXsl = '<PARAMSET kodz="' || Str(nKod) || '" type="xsl">'
.head 9 -  Set sXMLXsl = sXMLXsl || 
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1) || '</NAME>' ||
  '<VALUE>' || sBinds[ni].sVal || '</VALUE>' ||
'</PARAM>'
.head 9 -  Set nNum = nNum + 1
.head 9 -  Set ni = ni + 1
.head 7 -  ! ==========================
.head 6 -  ! Формула имени файла
.head 6 +  If nKod=nKODZ AND SalStrLeftX( sDBFileName, 1 ) = '='
.head 7 -  Set sDBFileName = ApplyQueryBinds( SalStrRightX(sDBFileName, SalStrLength(sDBFileName) - 1 ), sBinds, nBindsCount)
.head 7 -  Set sFileNameSql = 'SELECT ' || sDBFileName || ' INTO :sDBFileName FROM DUAL '
.head 7 +  If SqlPrepareAndExecute(hSql(), sFileNameSql)
.head 8 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 8 -  Call SqlClose(hSql())
.head 7 +  Else
.head 8 -  Call SalMessageBox('Ошибка при вычислении имени файла:' || PutCrLf() || sFileNameSql, 'Ошибка', MB_IconStop | MB_Ok)
.head 8 -  Return FALSE
.head 6 -  ! Проц. формирования
.head 6 +  If sForm_Proc
.head 7 -  Set sForm_Proc = ApplyQueryBinds(sForm_Proc, sBinds, nBindsCount)
.head 7 -  Set ni = 0
.head 7 -  Set nNum = 1
.head 7 +  Loop
.head 8 +  If ni >= nBindsCount
.head 9 +  If sXMLBlock != ''
.head 10 -  Set sXMLBlock = sXMLBlock || '</PARAMSET>'
.head 9 -  Break
.head 8 +  If SalStrScan(sForm_Proc, sBinds[ni].sName) >= 0
.head 9 +  If sXMLBlock = ''
.head 10 -  Set sXMLBlock = '<PARAMSET kodz="' || Str(nKod) || '" type="block">'
.head 9 -  Set sXMLBlock = sXMLBlock || 
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1) || '</NAME>' ||
  '<VALUE>' || sBinds[ni].sVal || '</VALUE>' ||
'</PARAM>'
.head 9 -  Set nNum = nNum + 1
.head 8 -  Set ni = ni + 1
.head 6 -  ! Сохраняю все параметры в переменной
.head 6 -  ! ????????????
.head 6 -  Set sMainParams = ''
.head 6 +  If nBindsCount AND nKodR
.head 7 -  Call cPar.Clear()
.head 7 -  Set i = 0
.head 7 +  While i < nBindsCount
.head 8 -  Call cPar.SetAsString(sBinds[i].sName, sBinds[i].sVal)
.head 8 -  Set i = i + 1
.head 7 -  Set sMainParams = cPar.GetParams()
.head 6 -  ! ????????????
.head 6 -  Set sXMLParams = sXMLParams || sXMLBlock || sXMLSelect
.head 6 -  Set nKod = nKodR
.head 6 +  If nKodR = NUMBER_Null
.head 7 -  Break
.head 5 -  Set sXMLParams = sXMLParams || sXMLXsl || '</PARAMS>'
.head 5 -  ! Call MessageError(sXMLParams)
.head 5 -  ! Return FALSE
.head 5 -  Set lsValidateRes = ''
.head 5 +  If NOT SqlPLSQLCommand(hSql(), "otcxml_par(nKODZ,sXMLParams,lsValidateRes)")
.head 6 -  Call Debug('Неуспешное выполнение процедуры otcxml_par')
.head 6 -  Call SqlRollback(hSql())
.head 6 -  Call WaitCursorOff()
.head 6 -  Return FALSE
.head 5 -  ! Создаем файл 
.head 5 +  If SqlPrepareAndExecute(hSql(), 
"SELECT dbms_lob.getlength(xml_data) INTO :nL 
 FROM xml_storage WHERE uri=to_char(:nKODZ)") AND 
   SqlFetchNext(hSql(),nFetchRes)
.head 6 +  If nL > 0
.head 7 +  If NOT SalFileOpen(hF, sDBFileName, OF_Create|OF_Write|OF_Text)
.head 8 -  Call SalMessageBox('Невозможно создать файл: ' || PutCrLf() || sDBFileName, 'Ошибка', MB_IconStop | MB_Ok)
.head 8 -  Call WaitCursorOff()
.head 8 -  Return FALSE
.head 7 -  Call SqlSetLongBindDatatype(1, 22)
.head 7 -  Set i = 1
.head 7 +  While i <= nL
.head 8 -  Call SqlPrepareAndExecute(hSql(), 
"SELECT dbms_lob.substr((select xml_data from xml_storage where uri=to_char(:nKODZ)),2000,:i)
 INTO :sXML FROM dual")
.head 8 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 8 -  Call SalFileSeek(hF, i-1, FILE_SeekBegin)
.head 8 -  Call SalFileWrite(hF, sXML, Len(sXML))
.head 8 -  Set i = i + 2000
.head 7 -  Call SalFileClose(hF)
.head 5 +  If lsValidateRes
.head 6 -  Set sXsdLog = GetGlobalOption('XSD_LOG')
.head 6 +  If sXsdLog
.head 7 -  Set sXsdLogFileName = sDBFileName
.head 7 -  Set nTokenize = SalStrTokenize(sDBFileName, '', Chr(92), msTmpPar)
.head 7 -  Set sXsdLogFileName = SalStrLeftX(msTmpPar[nTokenize-1], Len(msTmpPar[nTokenize-1])-3) || 'log'
.head 7 +  If SalFileOpen(hF, sXsdLog||'\\'||sXsdLogFileName, OF_Create|OF_Write|OF_Text)
.head 8 -  Call SalFileWrite(hF, lsValidateRes, Len(lsValidateRes))
.head 8 -  Call SalFileClose(hF)
.head 7 +  Else
.head 8 -  Call SalMessageBox('Невозможно создать файл: ' || PutCrLf() || sXsdLog||'\\'||sXsdLogFileName, 'Ошибка', MB_IconStop | MB_Ok)
.head 5 -  !
.head 5 -  Call SqlCommit(hSql())
.head 3 +  Function: ExportXML_SEB		! __exported
.head 4 -  Description: Только для банка СЭБ!!!
Печать пакета xml-отчетов
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  ! Список запросов
.head 5 -  String: sListKodz
.head 5 -  ! Параметры отчета, упакованные в строку с помощью класса cParams
(может быть пустым) Если fAskParams=TRUE то значения из sParams
прибавляются к введенным, но их значения по не устанавливаются по
умолчанию в диалоге ввода параметров
.head 5 -  String: sParams
.head 5 -  ! Спрашивать значения параметров, а не брать их из sParams
.head 5 -  ! Boolean: fAskParams
.head 5 -  ! Тип отчета D/F (Delta/Full)
.head 5 -  String: sKodDF
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nKODZ
.head 5 -  String: sFileName
.head 5 -  Boolean: fAskParams
.head 5 -  String: smListKodz[*]
.head 5 -  Number: nNumKodz
.head 5 -  String: sPathXmlFN
.head 5 -  String: sXmlFN
.head 5 -  String: sFNNote
.head 5 -  String: smTmp[*]
.head 5 -  Number: nNumTmp
.head 5 -  String: pName
.head 5 -  String: pValue
.head 5 -  Number: nIFile
.head 5 -  Boolean: bAskParams
.head 5 -  Number: nFirstKodz
.head 5 -  !
.head 5 -  Long String: lsSQLText
.head 5 -  Long String: sSQLText
.head 5 -  Long String: lsBindList
.head 5 -  Long String: sBindList
.head 5 -  Long String: lsBindSQL
.head 5 -  Long String: sBindSQL
.head 5 -  Long String: lsDefault_Vars
.head 5 -  Long String: sDefault_Vars
.head 5 -  String: sForm_Proc
.head 5 -  !
.head 5 -  Number: nKodR
.head 5 -  String: sDBFileName
.head 5 -  String: sFileNameSql
.head 5 -  Number: nBindsCount
.head 5 -  : cPar
.head 6 -  Class: cParams
.head 5 -  Number: i
.head 5 -  : sBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Date/Time: dDate1
.head 5 -  Date/Time: dDate2
.head 5 -  ! Complex
.head 5 -  String: sMainParams
.head 5 -  String: sAuxParams
.head 5 -  String: sAuxParamsExp
.head 5 -  !
.head 5 -  Number: nL
.head 5 -  Number: nKod
.head 5 -  Number: nNum
.head 5 -  File Handle: hF
.head 5 -  Long String: sXML
.head 5 -  Long String: sXMLParams
.head 5 -  Long String: sXMLBlock
.head 5 -  Long String: sXMLSelect
.head 5 -  Long String: sXMLXsl
.head 5 -  Number: ni
.head 5 -  !
.head 5 -  Long String: lsValidateRes
.head 5 -  String: sXsdLog
.head 5 -  String: sXsdLogFileName
.head 5 -  String: msTmpPar[*]
.head 5 -  Number: nTokenize
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Set nNumKodz = SalStrTokenize(sListKodz, '', ',', smListKodz)
.head 5 +  If nNumKodz > 0
.head 6 -  Set sXmlFN = ''
.head 6 -  Set fAskParams = TRUE
.head 6 -  Set bAskParams = TRUE
.head 6 -  Set sXMLXsl    = ''
.head 6 -  Set sXMLBlock  = ''
.head 6 -  Set sXMLSelect = ''
.head 6 -  Set nFirstKodz = Val(smListKodz[0])
.head 6 -  Set nIFile = 0
.head 6 +  While nIFile < nNumKodz
.head 7 -  ! формирование отчета
.head 7 -  Set nKODZ = Val(smListKodz[nIFile])
.head 7 -  Set sXMLParams =
'<?xml version = "1.0" encoding = "windows-1251"?>'||
'<PARAMS xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="params.xsd">'
.head 7 -  !
.head 7 +  If NOT SqlPrepareAndExecute(hSql(), 
"SELECT namef, dbms_lob.getlength(xsl_data), kodr
 INTO :sDBFileName, :nL, :nKodR
 FROM zapros WHERE kodz=:nKODZ")
.head 8 -  Call Debug('Неуспешное выполнение запроса SELECT FROM ZAPROS')
.head 8 -  Call WaitCursorOff()
.head 8 -  Return FALSE
.head 7 +  If NOT SqlFetchNext(hSql(), nFetchRes)
.head 8 -  Call Debug('Нет запроса с № ' || Str(nKODZ))
.head 8 -  Call WaitCursorOff()
.head 8 -  Return FALSE
.head 7 +  If nL = 0 OR nL = NUMBER_Null
.head 8 -  Call SalMessageBox('Отсутствует XSL-выражение для запроса №' || SalNumberToStrX( nKODZ, 0 ) || '!' || PutCrLf() ||
     'Невозможно создать XML-отчет.', 'Внимание!', MB_IconStop | MB_Ok)
.head 8 -  Call WaitCursorOff()
.head 8 -  Return FALSE
.head 7 +  If NOT sDBFileName AND NOT sFileName
.head 8 -  Call SalMessageBox('Не задано имя формируемого файла!', 'Ошибка', MB_IconStop | MB_Ok)
.head 8 -  Return FALSE
.head 7 +  If sDBFileName = '' AND sFileName != ''
.head 8 -  Set sDBFileName = sFileName
.head 7 -  Set nKod = nKODZ
.head 7 +  Loop
.head 8 -  Call SqlPrepareAndExecute(hSql(),
"SELECT BINDVARS, DEFAULT_VARS, FORM_PROC, KODR, BIND_SQL
 INTO :lsBindList, :lsDefault_Vars, :sForm_Proc, :nKodR, :lsBindSQL
 FROM zapros WHERE kodz=:nKod" )
.head 8 +  If NOT SqlFetchNext(hSql(), nFetchRes)
.head 9 -  Call Debug('Нет запроса с № ' || Str(nKod))
.head 9 -  Call WaitCursorOff(  )
.head 9 -  Return FALSE
.head 8 -  ! Текст SQL
.head 8 -  Set lsSQLText = GetStringFromClob(hSql(), 'zapros', 'kodz', 'txt', nKod, '', '')
.head 8 -  Set sSQLText  = lsSQLText
.head 8 -  !
.head 8 -  ! Set sXMLSelect = ''
.head 8 -  ! Уст. параметров
.head 8 +  If fAskParams
.head 9 -  Set sXMLSelect = ''
.head 9 -  ! Бинд-переменные
.head 9 -  Set sBindList = lsBindList
.head 9 -  Set sDefault_Vars = lsDefault_Vars
.head 9 -  Set sBindSQL = lsBindSQL
.head 9 -  ! Вызов диалога параметров
.head 9 -  ! Разбор параметров
.head 9 -  Set nBindsCount = GetQueryBindsList(sBindList, sBindSQL, sBinds)
.head 9 -  ! Диалог
.head 9 +  If nBindsCount>0
.head 10 -  ! Установка умолч. значений параметров
.head 10 +  If sDefault_Vars
.head 11 -  Call cPar.SetParams(sDefault_Vars)
.head 11 -  Set i = 0
.head 11 +  While i < nBindsCount
.head 12 +  If cPar.IndexOf(sBinds[i].sName) >= 0
.head 13 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 13 -  ! Set sBinds[i].sSemantic=sBinds[i].sName
.head 13 +  If At(':sFdat1', sBinds[i].sName) > 0
.head 14 -  Set sBinds[i].sSemantic = VisStrSubstitute(sBinds[i].sName, ':sFdat1', 'Дата с (за)')
.head 13 +  If At(':sFdat2', sBinds[i].sName) > 0
.head 14 -  Set sBinds[i].sSemantic = VisStrSubstitute(sBinds[i].sName, ':sFdat2', 'Дата по')
.head 12 -  Set i = i + 1
.head 11 -  Call cPar.Clear()
.head 10 -  ! Вызов диалога
.head 10 +  If NOT SetQueryBinds(hWndMDI, sBinds, nBindsCount, 0)
.head 11 -  Call WaitCursorOff()
.head 11 -  Return FALSE
.head 10 -  Call WaitCursorOn()
.head 9 -  ! Добавление параметров переданных в sParams
.head 9 +  If sParams
.head 10 -  Call cPar.Clear()
.head 10 -  Call cPar.SetParams(sParams)
.head 10 -  Set i = 0
.head 10 +  While i < nBindsCount
.head 11 +  If cPar.IndexOf(sBinds[i].sName) >= 0
.head 12 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 11 -  Set i = i + 1
.head 10 -  ! Параметры даты
.head 10 +  If cPar.IndexOf(':sFdat1') >= 0
.head 11 -  Set dDate1 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat1'), 'dd/MM/yyyy')
.head 10 +  If cPar.IndexOf(':sFdat2') >= 0
.head 11 -  Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat2'), 'dd/MM/yyyy')
.head 9 -  ! Внедрение значений параметров в SQL
.head 9 -  ! Set sSQLText = ApplyQueryBinds( sSQLText, sBinds, nBindsCount )
.head 9 -  ! ==========================
.head 9 -  Set ni = 0
.head 9 -  Set nNum = 1
.head 9 +  Loop
.head 10 +  If ni >= nBindsCount
.head 11 +  If sXMLSelect != ''
.head 12 -  Set sXMLSelect = sXMLSelect || '</PARAMSET>'
.head 11 -  Break
.head 10 +  If SalStrScan(sSQLText, sBinds[ni].sName) >= 0
.head 11 +  If sXMLSelect = ''
.head 12 -  Set sXMLSelect = '<PARAMSET kodz="' || Str(nKod) || '" type="select">'
.head 11 -  Set pName  = Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1)
.head 11 -  Set pValue = IifS(SalStrUpperX(pName)='P_DELTA', sKodDF, sBinds[ni].sVal)
.head 11 -  Set sXMLSelect = sXMLSelect ||
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || pName || '</NAME>' ||
  '<VALUE>' || pValue || '</VALUE>' ||
'</PARAM>'
.head 11 -  Set nNum = nNum + 1
.head 10 -  Set ni = ni + 1
.head 9 -  ! ==========================
.head 9 -  ! Передаем параметры в XSL_DATA
.head 9 +  If nKod = nKODZ
.head 10 -  Set ni = 0
.head 10 -  Set nNum = 1
.head 10 +  Loop
.head 11 +  If ni >= nBindsCount
.head 12 +  If sXMLXsl != ''
.head 13 -  Set sXMLXsl = sXMLXsl || '</PARAMSET>'
.head 12 -  Break
.head 11 +  If sXMLXsl = ''
.head 12 -  Set sXMLXsl = '<PARAMSET kodz="' || Str(nKod) || '" type="xsl">'
.head 11 -  Set pName  = Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1)
.head 11 -  Set pValue = IifS(SalStrUpperX(pName)='P_DELTA', sKodDF, sBinds[ni].sVal)
.head 11 -  Set sXMLXsl = sXMLXsl ||
'<PARAM num="' || Str(nNum) || '">'||
  '<NAME>' || pName || '</NAME>' ||
  '<VALUE>' || pValue || '</VALUE>' ||
'</PARAM>'
.head 11 -  Set nNum = nNum + 1
.head 11 -  Set ni = ni + 1
.head 9 -  ! ==========================
.head 9 -  Set fAskParams = FALSE
.head 9 -  ! признак, что параметры уже спрашивались
.head 9 -  Set bAskParams = FALSE
.head 9 -  ! ==========================
.head 8 +  Else If sParams and bAskParams
.head 9 -  Set sXMLSelect = ''
.head 9 -  ! Заполнение параметров из переменной
.head 9 -  Set nBindsCount = GetQueryBindsList(sBindList, '', sBinds)
.head 9 -  Call cPar.SetParams(sParams)
.head 9 -  Set i = 0
.head 9 +  While i < nBindsCount
.head 10 -  Set sBinds[i].sVal = cPar.GetAsString(sBinds[i].sName)
.head 10 -  Set i = i + 1
.head 9 -  ! Параметры даты
.head 9 +  If cPar.IndexOf(':sFdat1') >= 0
.head 10 -  Set dDate1 = SalFmtFormatStrDateTime(cPar.GetAsString( ':sFdat1'), 'dd/MM/yyyy')
.head 9 +  If cPar.IndexOf(':sFdat2') >= 0
.head 10 -  Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString( ':sFdat2'), 'dd/MM/yyyy')
.head 9 -  ! Set sSQLText = ApplyQueryBinds( sSQLText, sBinds, nBindsCount )
.head 9 -  ! ==========================
.head 9 -  Set ni = 0
.head 9 -  Set nNum = 1
.head 9 +  Loop
.head 10 +  If ni >= nBindsCount
.head 11 +  If sXMLSelect != ''
.head 12 -  Set sXMLSelect = sXMLSelect || '</PARAMSET>'
.head 11 -  Break
.head 10 +  If SalStrScan( sSQLText, sBinds[ni].sName ) >= 0
.head 11 +  If sXMLSelect = ''
.head 12 -  Set sXMLSelect = '<PARAMSET kodz="' || Str(nKod) || '" type="select">'
.head 11 -  Set pName  = Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1)
.head 11 -  Set pValue = IifS(SalStrUpperX(pName)='P_DELTA', sKodDF, sBinds[ni].sVal)
.head 11 -  Set sXMLSelect = sXMLSelect ||
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || pName || '</NAME>' ||
  '<VALUE>' || pValue || '</VALUE>' ||
'</PARAM>'
.head 11 -  Set nNum = nNum + 1
.head 10 -  Set ni = ni + 1
.head 9 -  ! ==========================
.head 9 -  ! Передаем параметры в XSL_DATA
.head 9 +  If nKod = nKODZ
.head 10 -  Set ni = 0
.head 10 -  Set nNum = 1
.head 10 +  Loop
.head 11 +  If ni >= nBindsCount
.head 12 +  If sXMLXsl != ''
.head 13 -  Set sXMLXsl = sXMLXsl || '</PARAMSET>'
.head 12 -  Break
.head 11 +  If sXMLXsl = ''
.head 12 -  Set sXMLXsl = '<PARAMSET kodz="' || Str(nKod) || '" type="xsl">'
.head 11 -  Set pName  = Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1)
.head 11 -  Set pValue = IifS(SalStrUpperX(pName)='P_DELTA', sKodDF, sBinds[ni].sVal)
.head 11 -  Set sXMLXsl = sXMLXsl ||
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || pName || '</NAME>' ||
  '<VALUE>' || pValue || '</VALUE>' ||
'</PARAM>'
.head 11 -  Set nNum = nNum + 1
.head 11 -  Set ni = ni + 1
.head 9 -  ! ==========================
.head 8 -  ! Формула имени файла
.head 8 +  If nKod = nKODZ AND SalStrLeftX(sDBFileName, 1) = '='
.head 9 -  Set sDBFileName = ApplyQueryBinds(SalStrRightX(sDBFileName, SalStrLength(sDBFileName) - 1 ), sBinds, nBindsCount)
.head 9 -  Set sFileNameSql = 'SELECT ' || sDBFileName || ' INTO :sDBFileName FROM DUAL '
.head 9 +  If SqlPrepareAndExecute(hSql(), sFileNameSql)
.head 10 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 10 -  Call SqlClose(hSql())
.head 9 +  Else
.head 10 -  Call SalMessageBox('Ошибка при вычислении имени файла:' || PutCrLf() || sFileNameSql, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Return FALSE
.head 8 -  ! Проц. формирования
.head 8 -  Set sXMLBlock = ''
.head 8 +  If sForm_Proc
.head 9 -  Set sForm_Proc = ApplyQueryBinds(sForm_Proc, sBinds, nBindsCount)
.head 9 -  Set ni = 0
.head 9 -  Set nNum = 1
.head 9 +  Loop
.head 10 -  ! Call Debug('sBinds[ni].sName =' || sBinds[ni].sName)
.head 10 +  If ni >= nBindsCount
.head 11 +  If sXMLBlock != ''
.head 12 -  Set sXMLBlock = sXMLBlock || '</PARAMSET>'
.head 11 -  Break
.head 10 +  If SalStrScan(sForm_Proc, sBinds[ni].sName) >= 0
.head 11 +  If sXMLBlock = ''
.head 12 -  Set sXMLBlock = '<PARAMSET kodz="' || Str(nKod) || '" type="block">'
.head 11 -  Set pName  = Subs(sBinds[ni].sName,2,Len(sBinds[ni].sName)-1)
.head 11 -  Set pValue = IifS(SalStrUpperX(pName)='P_DELTA', sKodDF, sBinds[ni].sVal)
.head 11 -  Set sXMLBlock = sXMLBlock ||
'<PARAM num="' || Str(nNum) || '">' ||
  '<NAME>' || pName || '</NAME>' ||
  '<VALUE>' || pValue || '</VALUE>' ||
'</PARAM>'
.head 11 -  Set nNum = nNum + 1
.head 10 -  Set ni = ni + 1
.head 8 -  ! Сохраняю все параметры в переменной
.head 8 -  ! ????????????
.head 8 -  Set sMainParams = ''
.head 8 +  If nBindsCount AND nKodR
.head 9 -  Call cPar.Clear()
.head 9 -  Set i = 0
.head 9 +  While i < nBindsCount
.head 10 -  Call cPar.SetAsString(sBinds[i].sName, sBinds[i].sVal)
.head 10 -  Set i = i + 1
.head 9 -  Set sMainParams=cPar.GetParams()
.head 8 -  ! ????????????
.head 8 -  Set sXMLParams = sXMLParams || sXMLBlock || sXMLSelect
.head 8 -  Set nKod = nKodR
.head 8 +  If nKodR = NUMBER_Null
.head 9 -  Break
.head 7 -  Set sXMLParams = sXMLParams || sXMLXsl || '</PARAMS>'
.head 7 -  ! Call MessageError(sXMLParams)
.head 7 -  ! Return FALSE
.head 7 -  Set lsValidateRes = ''
.head 7 -  Set sXMLParams = VisStrSubstitute(sXMLParams, 'kodz="' || Str(nFirstKodz) || '"', 'kodz="' || Str(nKODZ) || '"' )
.head 7 -  ! Call Debug(sXMLParams)
.head 7 +  If NOT SqlPLSQLCommand(hSql(), "otcxml_par(nKODZ,sXMLParams,lsValidateRes)" )
.head 8 -  Call Debug('Неуспешное выполнение процедуры otcxml_par')
.head 8 -  Call SqlRollback(hSql())
.head 8 -  Call WaitCursorOff()
.head 8 -  Return FALSE
.head 7 -  ! Создаем файл
.head 7 +  If SqlPrepareAndExecute(hSql(),
"SELECT dbms_lob.getlength(xml_data) INTO :nL
 FROM xml_storage WHERE uri=to_char(:nKODZ)") AND
   SqlFetchNext(hSql(),nFetchRes)
.head 8 +  If nL > 0
.head 9 +  If NOT SalFileOpen(hF, sDBFileName, OF_Create|OF_Write|OF_Text)
.head 10 -  Call SalMessageBox('Невозможно создать файл:' || PutCrLf() || sDBFileName, 'Ошибка', MB_IconStop | MB_Ok)
.head 10 -  Call WaitCursorOff()
.head 10 -  Return FALSE
.head 9 -  Call SqlSetLongBindDatatype(1, 22)
.head 9 -  Set i = 1
.head 9 +  While i <= nL
.head 10 -  Call SqlPrepareAndExecute(hSql(), 
"SELECT dbms_lob.substr((select xml_data from xml_storage where uri=to_char(:nKODZ)),2000,:i)
 INTO :sXML FROM dual")
.head 10 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 10 -  Call SalFileSeek(hF, i-1, FILE_SeekBegin)
.head 10 -  Call SalFileWrite(hF, sXML, Len(sXML))
.head 10 -  Set i = i + 2000
.head 9 -  Call SalFileClose(hF)
.head 7 +  If lsValidateRes
.head 8 -  Set sXsdLog = GetGlobalOption('XSD_LOG')
.head 8 +  If sXsdLog
.head 9 -  Set sXsdLogFileName = sDBFileName
.head 9 -  Set nTokenize = SalStrTokenize(sDBFileName, '', Chr(92), msTmpPar)
.head 9 -  Set sXsdLogFileName = SalStrLeftX(msTmpPar[nTokenize-1], Len(msTmpPar[nTokenize-1])-3) || 'log'
.head 9 +  If SalFileOpen(hF, sXsdLog||'\\'||sXsdLogFileName, OF_Create|OF_Write|OF_Text)
.head 10 -  Call SalFileWrite(hF, lsValidateRes, Len(lsValidateRes))
.head 10 -  Call SalFileClose(hF)
.head 9 +  Else
.head 10 -  Call SalMessageBox( 'Невозможно создать файл:' || PutCrLf() || sXsdLog||'\\'||sXsdLogFileName, 'Ошибка', MB_IconStop | MB_Ok)
.head 7 -  !
.head 7 -  Set nNumTmp = SalStrTokenize(sDBFileName, '', Chr(92), smTmp)
.head 7 -  Set sXmlFN = sXmlFN || IifS(sXmlFN='', '', ',') || smTmp[nNumTmp-1]
.head 7 -  Set sPathXmlFN = Subs(sDBFileName, 1, Len(sDBFileName)-Len(smTmp[nNumTmp-1]))
.head 7 -  !
.head 7 -  Set nIFile = nIFile + 1
.head 7 +  ! If i = nNumKodz and nKodDF = 3 and bForm = FALSE
.head 8 -      Set i = 0
.head 8 -      Set sKodDF = 'F'
.head 8 -      Set bForm = TRUE
.head 6 -  ! Формирование NOTE
.head 6 +  If NOT SqlPLSQLCommand(hSql(), "seb_otcxml.p_getNoteXml(sXmlFN)")
.head 7 -  Call Debug('Неуспешное выполнение процедуры proc p_getNoteXml !')
.head 7 -  Call SqlRollback(hSql())
.head 7 -  Call WaitCursorOff()
.head 7 -  Return FALSE
.head 6 -  ! Создаем файл
.head 6 +  If SqlPrepareAndExecute(hSql(), "SELECT dbms_lob.getlength(dd) INTO :nL FROM tmp_xml_data") AND
   SqlFetchNext(hSql(),nFetchRes)
.head 7 +  If nL > 0
.head 8 -  ! Имя файла Note
.head 8 -  Set sFNNote = ApplyQueryBinds("'" || sPathXmlFN || "\UA_'||to_char(sysdate,'YYYYMMDD')||'_'||SUBSTR('0000'||:Param0,-4)||'_NOTE.xml'", sBinds, nBindsCount)
.head 8 -  Set sFileNameSql = 'SELECT ' || sFNNote || ' INTO :sFNNote FROM DUAL '
.head 8 +  If SqlPrepareAndExecute(hSql(), sFileNameSql)
.head 9 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 9 -  Call SqlClose(hSql())
.head 8 +  Else
.head 9 -  Call SalMessageBox('Ошибка при вычислении имени файла:' || PutCrLf() || sFileNameSql, 'Ошибка', MB_IconStop | MB_Ok)
.head 9 -  Return FALSE
.head 8 -  !
.head 8 +  If NOT SalFileOpen(hF, sFNNote, OF_Create|OF_Write|OF_Text)
.head 9 -  Call SalMessageBox( 'Невозможно создать файл:' || PutCrLf() || sDBFileName, 'Ошибка', MB_IconStop | MB_Ok)
.head 9 -  Call WaitCursorOff()
.head 9 -  Return FALSE
.head 8 -  Call SqlSetLongBindDatatype(1, 22)
.head 8 -  Set i = 1
.head 8 +  While i <= nL
.head 9 -  Call SqlPrepareAndExecute(hSql(), "SELECT dbms_lob.substr((select dd from tmp_xml_data),2000,:i) INTO :sXML FROM dual")
.head 9 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 9 -  Call SalFileSeek(hF, i-1, FILE_SeekBegin)
.head 9 -  Call SalFileWrite(hF, sXML, Len(sXML))
.head 9 -  Set i = i + 2000
.head 8 -  Call SalFileClose(hF)
.head 5 -  Call SqlCommit(hSql())
.head 5 -  Call WaitCursorOff()
.head 5 -  Return TRUE
.head 3 +  Function: GetRepParams
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Long String: lsXmlParams
.head 5 -  : cBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Number: nBindsCount
.head 5 -  Receive String: sDateFrom
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Long String: lsTmp
.head 5 -  Number: nNum
.head 5 -  String: smParams[*]
.head 5 -  String: sParams
.head 5 -  Number: i
.head 5 -  Number: j
.head 5 -  Number: nPosID
.head 5 -  Number: nPosVal
.head 5 -  String: sParam
.head 5 -  String: sValue
.head 5 -  : cPar
.head 6 -  Class: cParams
.head 4 +  Actions
.head 5 -  Set lsTmp = lsXmlParams
.head 5 +  If lsTmp
.head 6 -  Set sParams = ''
.head 6 -  Set nNum = SalStrTokenize(lsTmp, '<', '>', smParams)
.head 6 -  Set i = 0
.head 6 -  Set j = 0
.head 6 +  While i < nNum
.head 7 +  If SalStrScan(smParams[i], 'ReportParams') = -1
.head 8 -  Set nPosID  = SalStrScan(smParams[i], 'ID="')
.head 8 -  Set nPosVal = SalStrScan(smParams[i], 'Value="')
.head 8 +  If nPosID = -1
.head 9 -  Break
.head 8 -  Set sParam = Subs(smParams[i], nPosID+5, nPosVal-nPosID-6)
.head 8 -  Set sValue = Subs(smParams[i], nPosVal+8, Len(smParams[i])-nPosVal-10)
.head 8 -  Set sParams = sParams || IifS(sParams = '', "", ",") ||
    sParam || "='" || sValue || "'"
.head 8 -  Set j = j + 1
.head 7 -  Set i = i + 1
.head 6 +  If sParams
.head 7 -  Call cPar.Clear()
.head 7 -  Call cPar.SetParams(sParams)
.head 7 -  Set i = 0
.head 7 +  While i < nBindsCount
.head 8 +  If cPar.IndexOf(cBinds[i].sName) >= 0
.head 9 -  Set cBinds[i].sVal = cPar.GetAsString(cBinds[i].sName)
.head 8 -  Set i = i + 1
.head 7 -  ! Параметры даты
.head 7 +  If cPar.IndexOf(':sFdat1') >= 0
.head 8 -  Set sDateFrom = cPar.GetAsString(':sFdat1')
.head 7 +  ! If cPar.IndexOf(':sFdat2') >= 0
.head 8 -     Set dDate2 = SalFmtFormatStrDateTime(cPar.GetAsString(':sFdat2'), 'dd/MM/yyyy')
.head 5 -  Return TRUE
.head 3 +  Function: GetRepParamsStr	! __exported
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  Number: nRepId
.head 5 -  Long String: lsRepXmlParams
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Long String: lsBindList
.head 5 -  Long String: lsBindSql
.head 5 -  !
.head 5 -  : cBinds[*]
.head 6 -  Class: cQueryBind
.head 5 -  Number: nBindsCount
.head 5 -  !
.head 5 -  String: strDateFrom
.head 5 -  Number: i
.head 5 -  String: sRet
.head 4 +  Actions
.head 5 -  Call OtcnIni()
.head 5 -  Set sRet = ''
.head 5 -  Call SqlSetLongBindDatatype(1, 22)
.head 5 -  Call SqlSetLongBindDatatype(2, 22)
.head 5 -  Call SqlPrepareAndExecute(hSql(), 
"select bindvars, bind_sql
   into :lsBindList, :lsBindSql
   from v_cbirep_repparams
  where rep_id = :nRepId")
.head 5 +  If SqlFetchNext(hSql(), nFetchRes)
.head 6 -  Set nBindsCount = GetQueryBindsList(lsBindList, lsBindSql, cBinds)
.head 6 -  ! Читаем установленные параметры кат.запроса
.head 6 -  Call GetRepParams(lsRepXmlParams, cBinds, nBindsCount, strDateFrom)
.head 6 -  !
.head 6 -  Set i = 0
.head 6 +  While i < nBindsCount
.head 7 -  ! Дата1, Дата2
.head 7 -  Set sRet = sRet || IifS(sRet='', "", ",") || 
    IifS(cBinds[i].sName=':sFdat1', CurrentLangTable.GetAtomTitle('GetRepParamsStr.cTDat') || '1',
    IifS(cBinds[i].sName=':sFdat2', CurrentLangTable.GetAtomTitle('GetRepParamsStr.cTDat') || '2', 
    cBinds[i].sSemantic)) || "='" || cBinds[i].sVal || "'"
.head 7 -  !
.head 7 -  Set i = i + 1
.head 5 -  Return sRet
.head 3 -  !
.head 2 +  Named Menus
.head 3 +  Menu: popupFImpExist
.head 4 -  Resource Id: 57847
.head 4 -  Title: NoMoreTitle
.head 4 -  Description: Всплывающее меню для таблицы сущствующих файлов 
для консолидации
.head 4 -  Enabled when:
.head 4 -  Status Text:
.head 4 -  Menu Item Name:
.head 4 +  Menu Item: Перечитать
.head 5 -  Resource Id: 57849
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalWaitCursor( TRUE )
.head 6 -  Call SalSendMsg( dlg_FileImport.tblFileExists, SAM_Create, 0, 0 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 5 -  Menu Item Name:
.head 4 -  Menu Separator
.head 4 +  Menu Item: Удалить
.head 5 -  Resource Id: 57848
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg( dlg_FileImport.pbDelete, SAM_Click, 0, 0 )
.head 5 -  Menu Item Name:
.head 3 +  Menu: popupFImpToDo
.head 4 -  Resource Id: 57850
.head 4 -  Title: NoMoreTitle
.head 4 -  Description: Всплывающее меню для таблицы возможных файлов 
для консолидации
.head 4 -  Enabled when:
.head 4 -  Status Text:
.head 4 -  Menu Item Name:
.head 4 +  Menu Item: Перечитать
.head 5 -  Resource Id: 57853
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalWaitCursor( TRUE )
.head 6 -  Call SalSendMsg( dlg_FileImport.tblFile4Import, SAM_Create, 0, 0 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 5 -  Menu Item Name:
.head 4 -  Menu Separator
.head 4 +  Menu Item: Импортировать все
.head 5 -  Resource Id: 57852
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg( dlg_FileImport.pbAll, SAM_Click, 0, 0 )
.head 5 -  Menu Item Name:
.head 4 +  Menu Item: Импортировать выделенные
.head 5 -  Resource Id: 57851
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg( dlg_FileImport.pbSelected, SAM_Click, 0, 0 )
.head 5 -  Menu Item Name:
.head 2 +  Class Definitions
.data RESOURCE 0 0 1 1394641701
0000: 9102000039010000 0000000000000000 0200000400FFFF01 00160000436C6173
0020: 73566172004F7574 6C696E6552006567 496E666F41003C00 000D630052616469
0040: 6F4C69730074426F 7886000000F00500 0000E0010D000000 FF3F0D00B9000100
0060: FFFFE01A00000001 FE00FF8327000000 01FB00FF0F340000 00EE0100FF3F0180
0080: 004E000000010000 000009635369676E 4669006C65A00000 0006003C0000010D
00A0: FB00FF6F0D00EE01 00FFBF1AB9000100 FFFFE6270001FE00 FF9B340001FB00FF
00C0: 4F410000EE0100FF 3F01800022000000 02000000C00A6347 656E460074657274
00E0: 0000000479000002 44040000010000FF E08001000000DF04 D800010D00FF7F11
0100: 700000000200FFFF C11500000001FD00 FFC7018022000003 0000000B6347E344
0120: 4669CF0004DE0002 D1000100003F8001 F9000037040001F6 0D00FFDF11DC0002
0140: 00FF7F1573000100 FFFF01
.enddata
.head 3 -  !
.head 3 +  Functional Class: cQueryBind
.head 4 -  Description: Описывает структуру бинд-переменных
.head 4 -  Derived From
.head 4 -  Class Variables
.head 4 +  Instance Variables
.head 5 -  String: sName
.head 5 -  String: sSemantic
.head 5 -  String: sType
.head 5 -  String: sVal
.head 5 -  String: sDescSQL    ! SQL строка, которая описывает параметр
.head 4 -  Functions
.head 3 +  Form Window Class: cGenericTableSpl3
.data INHERITPROPS
0000: 0100
.enddata
.data CLASSPROPS
0000: 56543A53706C6974 746572002B000100 00000000000090B0 A800C8D8D8005880
0020: 7800020000000000 0000010000000100 0000000000000001 00000000
.enddata
.data CLASSPROPSSIZE
0000: 3C00
.enddata
.head 4 -  Title:
.head 4 -  Icon File:
.head 4 -  Accesories Enabled? Yes
.head 4 -  Visible? Class Default
.head 4 -  Display Settings
.head 5 -  Display Style? Default
.head 5 -  Visible at Design time? Yes
.head 5 -  Automatically Created at Runtime? No
.head 5 -  Initial State: Normal
.head 5 -  Maximizable? Class Default
.head 5 -  Minimizable? Class Default
.head 5 -  System Menu? Class Default
.head 5 -  Resizable? Class Default
.head 5 -  Window Location and Size
.head 6 -  Left:  
.head 6 -  Top:   
.head 6 -  Width:  15.017"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 7.345"
.head 6 -  Height Editable? Class Default
.head 5 -  Form Size
.head 6 -  Width:  Class Default
.head 6 -  Height: Class Default
.head 6 -  Number of Pages: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 4 -  Next Class Child Key: 36
.head 4 -  List in Tool Palette? Yes
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Description:
.head 4 -  Derived From
.head 4 -  Menu
.head 4 +  Tool Bar
.head 5 -  Display Settings
.head 6 -  Display Style? Class Default
.head 6 -  Location? Class Default
.head 6 -  Visible? Class Default
.head 6 -  Size: 0.427"
.head 6 -  Size Editable? Class Default
.head 6 -  Font Name: Class Default
.head 6 -  Font Size: Class Default
.head 6 -  Font Enhancement: Class Default
.head 6 -  Text Color: Class Default
.head 6 -  Background Color: Class Default
.head 5 +  Contents
.head 6 +  Pushbutton: pbIns
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 15
.head 7 -  Class: ctb_pbInsert
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   0.133"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name: \BARS98\RESOURCE\BMP\Insert.bmp
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Вставить новую запись'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(tbl, UM_Insert, 0, 0)
.head 6 +  Pushbutton: pbDel
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 16
.head 7 -  Class: ctb_pbDelete
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   0.583"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Пометить/Снять пометку на удаление'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(tbl, UM_Delete, 0, 0)
.head 6 +  Pushbutton: pbRefresh
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 17
.head 7 -  Class: ctb_pbRefresh
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   1.033"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Перечитать записи в таблице'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(tbl, UM_Populate, 0, 0)
.head 6 +  Pushbutton: pbUpdate
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 18
.head 7 -  Class: ctb_pbUpdate
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   1.483"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Сохранить значения в базе данных'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(tbl, UM_Update, 0, 0)
.head 6 -  Line
.head 7 -  Resource Id: 53117
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 19
.head 7 -  Class:
.head 7 -  Coordinates
.head 8 -  Begin X:  1.983"
.head 8 -  Begin Y:  0.417"
.head 8 -  End X:  1.983"
.head 8 -  End Y:  0.0"
.head 7 -  Visible? Yes
.head 7 -  Line Style: Etched
.head 7 -  Line Thickness: 1
.head 7 -  Line Color: 3D Shadow Color
.head 6 +  Pushbutton: pbSearch
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 20
.head 7 -  Class: ctb_pbSearch
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   2.083"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Поиск по значению первичного ключа'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(hWndForm, UM_Search, 0, 0)
.head 6 +  Pushbutton: pbFilter
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 21
.head 7 -  Class: ctb_pbFilter
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   2.533"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Установить фильтр...'
.head 8 +  On SAM_Click
.head 9 +  If SetQueryFilter(tbl.cF)
.head 10 -  Call SalPostMsg(tbl, UM_Populate, 0, 0)
.head 6 +  Pushbutton: pbDetails
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 31
.head 7 -  Class: ctb_pbDetail
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   2.983"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Class Default
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Подробная информация для строки таблицы'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(tbl, UM_DoubleClick, 0, 0)
.head 6 +  Pushbutton: pbPrint
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 22
.head 7 -  Class: ctb_pbPrint
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   3.433"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: F5
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name: \BARS98\RESOURCE\BMP\print.bmp
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Печать таблицы'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(hWndForm, UM_Print, 0, 0)
.head 6 -  Line
.head 7 -  Resource Id: 53118
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 23
.head 7 -  Class:
.head 7 -  Coordinates
.head 8 -  Begin X:  3.933"
.head 8 -  Begin Y:  0.417"
.head 8 -  End X:  3.933"
.head 8 -  End Y:  0.0"
.head 7 -  Visible? Yes
.head 7 -  Line Style: Etched
.head 7 -  Line Thickness: 1
.head 7 -  Line Color: 3D Shadow Color
.head 6 +  Pushbutton: pbExit
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 25
.head 7 -  Class: ctb_pbCancel
.head 7 -  Property Template:
.head 7 -  Class DLL Name:
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   4.083"
.head 8 -  Top:    0.06"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Keyboard Accelerator: Esc
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Picture File Name:
.head 7 -  Picture Transparent Color: Class Default
.head 7 -  Image Style: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 +  Message Actions
.head 8 +  On SAM_Create
.head 9 -  Set strTip = 'Завершить работу'
.head 8 +  On SAM_Click
.head 9 -  Call SalSendMsg(hWndForm, UM_Close, 0, 0)
.head 6 -  Line
.head 7 -  Resource Id: 53119
.head 7 -  Class Child Ref Key: 0
.head 7 -  Class ChildKey: 26
.head 7 -  Class:
.head 7 -  Coordinates
.head 8 -  Begin X:  4.633"
.head 8 -  Begin Y:  0.417"
.head 8 -  End X:  4.633"
.head 8 -  End Y:  0.0"
.head 7 -  Visible? Yes
.head 7 -  Line Style: Etched
.head 7 -  Line Thickness: 1
.head 7 -  Line Color: 3D Shadow Color
.head 4 +  Contents
.head 5 +  Child Table: tbl
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 28
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Display Settings
.head 7 -  Window Location and Size
.head 8 -  Left:   0.1"
.head 8 -  Top:    0.071"
.head 8 -  Width:  5.683"
.head 8 -  Width Editable? Yes
.head 8 -  Height: 5.083"
.head 8 -  Height Editable? Yes
.head 7 -  Visible? Yes
.head 7 -  Font Name: Default
.head 7 -  Font Size: Default
.head 7 -  Font Enhancement: Default
.head 7 -  Text Color: Default
.head 7 -  Background Color: System Window Color
.head 7 -  View: Table
.head 7 -  Allow Row Sizing? No
.head 7 -  Lines Per Row: Default
.head 6 -  Memory Settings
.head 7 -  Maximum Rows in Memory: Default
.head 7 -  Discardable? No
.head 6 -  Contents
.head 6 +  Functions
.head 7 +  Function: GetFirstEditableColumn
.head 8 -  Description: Получить первую редактируюмую колонку
.head 8 +  Returns
.head 9 -  Window Handle:
.head 8 +  Parameters
.head 9 -  Window Handle: hWndTbl
.head 8 -  Static Variables
.head 8 +  Local variables
.head 9 -  Number: nCol
.head 9 -  Window Handle: hWndCol
.head 8 +  Actions
.head 9 -  Set nCol=1
.head 9 +  Loop
.head 10 -  Set hWndCol = SalTblGetColumnWindow(hWndTbl, nCol, COL_GetPos)
.head 10 +  If hWndCol=hWndNULL
.head 11 -  Break
.head 10 +  If SalTblQueryColumnFlags(hWndCol, COL_Editable) AND
SalIsWindowVisible(hWndCol)
.head 11 -  Break
.head 10 -  Set nCol=nCol+1
.head 9 -  Return hWndCol
.head 6 +  Window Variables
.head 7 -  Window Handle: hCol
.head 7 -  !
.head 7 -  : cCstTab1
.head 8 -  Class: cABSTab
.head 7 -  : cMain
.head 8 -  Class: cABSConnect
.head 7 -  : cF
.head 8 -  Class: cGenFilter
.head 7 -  : cQ
.head 8 -  Class: cGenQuery
.head 7 -  String: strDSql
.head 6 +  Message Actions
.head 7 +  On UM_Create
.head 8 +  If nTabInstance1
.head 9 -  Call cCstTab1.Init(hWndItem, nTabInstance1, GetUserLoginName(), NOT fNoReposition1)
.head 7 +  On UM_Insert
.head 8 +  If NOT SalTblAnyRows(hWndForm, ROW_New, 0)
.head 9 -  Call SalTblDefineSplitWindow(hWndForm, 3, TBL_Split_Adjustable)
.head 8 -  Set nRow = SalTblInsertRow(hWndForm, TBL_MinRow)
.head 8 -  Set hCol = GetFirstEditableColumn(hWndForm)
.head 8 -  Call SalTblSetContext(hWndForm, nRow)
.head 8 -  Call SalTblSetFocusCell(hWndForm, nRow, hCol, 0, 1)
.head 7 +  On UM_Delete
.head 8 -  Set nRow = TBL_MinRow
.head 8 +  While SalTblFindNextRow(hWndForm, nRow, ROW_Selected, 0)
.head 9 +  If NOT SalTblQueryRowFlags(hWndForm, nRow, ROW_New)
.head 10 -  Call SalTblSetRowFlags(hWndForm, nRow, ROW_MarkDeleted,
not SalTblQueryRowFlags(hWndForm, nRow, ROW_MarkDeleted))
.head 9 +  Else
.head 10 -  Call SalTblDeleteRow(hWndForm, nRow, TBL_NoAdjust)
.head 7 +  On UM_Populate
.head 8 +  If strSqlPopulate != ''
.head 9 +  If fFilterAtStart
.head 10 -  Call SetQueryFilter(cF)
.head 10 -  Set fFilterAtStart = NOT fFilterAtStart
.head 9 -  Call tbl.cQ.Init(strSqlPopulate)
.head 9 -  Call SalWaitCursor(TRUE)
.head 9 -  Call SalTblDefineSplitWindow(hWndForm, 0, FALSE)
.head 9 -  Set strDSql = cQ.GetFullSQLString(cF)
.head 9 -  Call SalTblPopulate(hWndForm, cMain.hSql(), T(strDSql), TBL_FillAll)
.head 9 -  Call SalTblSetContext(hWndForm, 0)
.head 9 -  Call SalPostMsg(hWndForm, SAM_TblDoDetails, 0, 0)
.head 9 -  Call SalWaitCursor(FALSE)
.head 7 +  On UM_Update
.head 8 -  Call SalWaitCursor(TRUE)
.head 8 -  Call SaveInfoToLog(MSG_SaveDataRef() || ' ' || strTitleAux)
.head 8 +  If strSqlDelete != ''
.head 9 -  Call SqlPrepare(cMain.hSql(), T(strSqlDelete))
.head 9 -  Call SalTblDoDeletes(hWndForm, cMain.hSql(), ROW_MarkDeleted)
.head 8 +  If strSqlInsert != ''
.head 9 -  Call SqlPrepare(cMain.hSql(), T(strSqlInsert))
.head 9 -  Call SalTblDoInserts(hWndForm, cMain.hSql(), TRUE)
.head 8 +  If strSqlUpdate != ''
.head 9 -  Call SqlPrepare(cMain.hSql(), T(strSqlUpdate))
.head 9 -  Call SalTblDoUpdates(hWndForm, cMain.hSql(), TRUE)
.head 8 -  Call SqlCommit(cMain.hSql())
.head 8 -  Call SalTblDefineSplitWindow(hWndForm, 0, FALSE)
.head 8 -  Call SalPostMsg(hWndForm, UM_Populate, 0, 0)
.head 8 -  Call SalWaitCursor(FALSE)
.head 7 +  On UM_DoubleClick
.head 8 -  Call SalSendMsg(SalParentWindow(hWndForm), UM_DoubleClick, wParam, lParam)
.head 7 +  On SAM_ContextMenu
.head 8 +  If nFlags & GT_ReadOnly
.head 9 -  Call SalTrackPopupMenu(hWndForm, 'popupEditP', TPM_CursorX | TPM_CursorY | TPM_CenterAlign, 0, 0)
.head 8 +  Else
.head 9 -  Call SalTrackPopupMenu(hWndForm, 'popupEditF', TPM_CursorX | TPM_CursorY | TPM_CenterAlign, 0, 0)
.head 7 +  On SAM_EndCellTab
.head 8 -  Call SalSendMsg(hWndForm, UM_Insert, 0, 0)
.head 8 -  Return TRUE
.head 7 +  On SAM_CaptionDoubleClick
.head 8 -  Call SalTblSortRows(hWndForm,SalTblQueryColumnID(SalNumberToWindowHandle(wParam)), TBL_SortIncreasing)
.head 7 +  On SAM_CornerClick
.head 8 +  If nTabInstance1
.head 9 -  Call SetTblColumnStatus( hWndItem, cCstTab1 )
.head 7 +  On WM_Paint
.head 8 -  Call cCstTab1.MarkTableAsCustomisable(  )
.head 7 +  On SAM_Destroy
.head 8 -  Call cCstTab1.Destructor(  )
.head 7 +  On SAM_TblDoDetails
.head 8 -  Call SalSendMsg( tbl2, UM_Populate, 0, 0 )
.head 5 +  ! cXSalHSplitter: ccSplitter
.head 6 -        Message Actions
.head 5 +  Custom Control: ccSplitter
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 36
.head 6 -  Class: cXSalVSplitter
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Display Settings
.head 7 -  DLL Name:
.head 7 -  MS Windows Class Name:
.head 7 -  Style:  Class Default
.head 7 -  ExStyle:  Class Default
.head 7 -  Title:
.head 7 -  Window Location and Size
.head 8 -  Left:   0.0"
.head 8 -  Top:    0.0"
.head 8 -  Width:  Class Default
.head 8 -  Width Editable? Class Default
.head 8 -  Height: Class Default
.head 8 -  Height Editable? Class Default
.head 7 -  Visible? Class Default
.head 7 -  Border? Class Default
.head 7 -  Etched Border? Class Default
.head 7 -  Hollow? Class Default
.head 7 -  Vertical Scroll? Class Default
.head 7 -  Horizontal Scroll? Class Default
.head 7 -  Tab Stop? Class Default
.head 7 -  Tile To Parent? Yes
.head 7 -  Font Name: Class Default
.head 7 -  Font Size: Class Default
.head 7 -  Font Enhancement: Class Default
.head 7 -  Text Color: Class Default
.head 7 -  Background Color: Class Default
.head 7 -  DLL Settings
.head 6 -  Message Actions
.head 5 +  Child Table: tbl2
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 35
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Display Settings
.head 7 -  Window Location and Size
.head 8 -  Left:   6.933"
.head 8 -  Top:    0.107"
.head 8 -  Width:  5.5"
.head 8 -  Width Editable? Yes
.head 8 -  Height: 5.0"
.head 8 -  Height Editable? Yes
.head 7 -  Visible? Yes
.head 7 -  Font Name: Default
.head 7 -  Font Size: Default
.head 7 -  Font Enhancement: Default
.head 7 -  Text Color: Default
.head 7 -  Background Color: Default
.head 7 -  View: Table
.head 7 -  Allow Row Sizing? No
.head 7 -  Lines Per Row: Default
.head 6 -  Memory Settings
.head 7 -  Maximum Rows in Memory: 2000
.head 7 -  Discardable? No
.head 6 -  Contents
.head 6 -  Functions
.head 6 +  Window Variables
.head 7 -  Boolean: bSortOrd
.head 7 -  : cCstTab2
.head 8 -  Class: cABSTab
.head 7 -  String: strSqlPopulate	! Строка SQL SELECT
.head 7 -  String: strSqlInsert	! Строка SQL INSERT
.head 7 -  String: strSqlDelete	! Строка SQL DELETE
.head 7 -  String: strSqlUpdate	! Строка SQL UPDATE
.head 6 +  Message Actions
.head 7 +  On UM_Create
.head 8 -  Call SalSendMsgToChildren( hWndForm, UM_QueryLabelText, 0, 0 )
.head 8 +  If nTabInstance2
.head 9 -  Call cCstTab2.Init(hWndItem, nTabInstance2, GetUserLoginName(), NOT fNoReposition2)
.head 7 +  On UM_Populate
.head 8 -  Call SalWaitCursor(TRUE)
.head 8 -  Call SalTblPopulate(hWndForm, hSql(), T(strSqlPopulate),TBL_FillAll)
.head 8 -  Call SalWaitCursor(FALSE)
.head 7 +  On SAM_ColumnSelectClick
.head 8 -  Call SalTblSetColumnFlags( SalNumberToWindowHandle(wParam), COL_Selected, FALSE )
.head 8 -  Set bSortOrd = not bSortOrd
.head 8 -  Call SalTblSortRows(tbl2, SalTblQueryColumnID(SalNumberToWindowHandle(wParam)), bSortOrd)
.head 7 +  On SAM_CornerClick
.head 8 +  If nTabInstance2
.head 9 -  Call SetTblColumnStatus( hWndItem, cCstTab2 )
.head 7 +  On SAM_ContextMenu
.head 8 -  Call SalTblQueryFocus( hWndForm, nRow, hWndCol )
.head 8 +  If SalTblQueryRowFlags ( hWndForm, nRow, ROW_Selected )
.head 9 -  Call Fun_SumCol()
.head 8 +  Else
.head 9 +  If nFlags & GT_ReadOnly
.head 10 -  Call SalTrackPopupMenu(hWndForm, 'popupEditP', TPM_CursorX | TPM_CursorY | TPM_CenterAlign, 0, 0)
.head 9 +  Else
.head 10 -  Call SalTrackPopupMenu(hWndForm, 'popupEditF', TPM_CursorX | TPM_CursorY | TPM_CenterAlign, 0, 0)
.head 7 +  On WM_Paint
.head 8 -  Call cCstTab2.MarkTableAsCustomisable(  )
.head 7 +  On SAM_Destroy
.head 8 -  Call cCstTab2.Destructor(  )
.head 4 -  Class Variables
.head 4 +  Instance Variables
.head 5 -  ! Параметры класса:
.head 5 -  ! NB: описание переменных -- аналогично cGenericTable (см.!)
.head 5 -  Number: nFlags
.head 5 -  String: strSqlPopulate
.head 5 -  String: strSqlInsert
.head 5 -  String: strSqlDelete
.head 5 -  String: strSqlUpdate
.head 5 -  String: strFilterTblName ! Имя основной таблицы для фильтра
.head 5 -  String: strTitleAux
.head 5 -  String: strPrintFileName ! Имя файла печати (без путей)
.head 5 -  Boolean: fFilterAtStart  ! Начинать население таблицы с фильтра
.head 5 -  Number: nTabInstance1    ! Номер варианта таблицы 1 для динамической настройки
.head 5 -  Number: nTabInstance2    ! Номер варианта таблицы 1 для динамической настройки
.head 5 -  Boolean: fNoReposition1  ! Не использовать настройку положения колонок для таб 1
.head 5 -  Boolean: fNoReposition2  ! Не использовать настройку положения колонок для таб 1
.head 5 -  ! Внутренние переменные:
.head 5 -  Number: nRow
.head 5 -  String: strOldTitle
.head 5 -  ! ! ! Координаты и размер окна
.head 5 -  Number: nWinX
.head 5 -  Number: nWinY
.head 5 -  Number: nWinW
.head 5 -  Number: nWinH
.head 5 -  ! ! Для суммирования колонок
.head 5 -  Window Handle: hWndCol
.head 4 +  Functions
.head 5 +  Function: ReturnValue
.head 6 -  Description:
.head 6 +  Returns
.head 7 -  Number: nRes
.head 6 -  Parameters
.head 6 -  Static Variables
.head 6 -  Local variables
.head 6 +  Actions
.head 7 -  Return 999
.head 5 +  Function: ReInitQueryString
.head 6 -  Description: Переинициализировать служебные SQL строки
.head 6 +  Returns
.head 7 -  Boolean:
.head 6 -  Parameters
.head 6 -  Static Variables
.head 6 -  Local variables
.head 6 +  Actions
.head 7 +  If strSqlPopulate != ''
.head 8 -  Call tbl.cQ.Init(strSqlPopulate)
.head 5 +  Function: Fun_SumCol
.head 6 -  Description: Сумирует SELECTED колонку
.head 6 -  Returns
.head 6 -  Parameters
.head 6 -  Static Variables
.head 6 +  Local variables
.head 7 -  Window Handle: hWndCol
.head 7 -  String: strTitle
.head 7 -  String: strSuma
.head 7 -  Number: nX
.head 7 -  Number: nY
.head 7 -  Number: nW
.head 7 -  Number: nH
.head 6 +  Actions
.head 7 -  Call GetWindowRect( hWndForm, nX, nY, nW, nH )
.head 7 -  Call SalTblObjectsFromPoint( hWndForm, wParam-nX, lParam-nY, nH, hWndCol, nH )
.head 7 -  Set strTitle=PadR(' ',100  )
.head 7 -  Call SalTblGetColumnTitle ( hWndCol, strTitle, 100 )
.head 7 +  If SalIsValidNumber( hWndCol )
.head 8 -  Set nH=SalTblColumnSum( hWndForm, SalTblQueryColumnID( hWndCol ), ROW_Selected, 0 )
.head 8 +  If nH
.head 9 -  Set strTitle=SalStrTrimX(strTitle)
.head 9 -  Set strSuma=SalStrTrimX(SalFmtFormatNumber ( nH, 'Default' ))
.head 9 -  Set nH = SalNumberMax( SalStrLength( strTitle ), SalStrLength( strSuma ) )
.head 9 -  Call XSalTooltipSetColors( COLOR_Black, COLOR_Yellow )
.head 9 -  Call XSalTooltipShow( hWndForm, strTitle ||PutLf()||PadL(strSuma,nH))
.head 9 -  Call XSalTooltipSetColors( COLOR_Black, COLOR_White )
.head 5 +  ! Function: GetFirstEditableColumn
.head 6 -      Description: Получить первую редактируюмую колонку
.head 6 +      Returns
.head 7 -      Window Handle:
.head 6 +      Parameters
.head 7 -      Window Handle: hWndTbl
.head 6 -      Static Variables
.head 6 +      Local variables
.head 7 -      Number: nCol
.head 7 -      Window Handle: hWndCol
.head 6 +      Actions
.head 7 -      Set nCol=1
.head 7 +      Loop
.head 8 -      Set hWndCol = SalTblGetColumnWindow(hWndTbl, nCol, COL_GetPos)
.head 8 +      If hWndCol=hWndNULL
.head 9 -      Break
.head 8 +      If SalTblQueryColumnFlags(hWndCol, COL_Editable) AND
SalIsWindowVisible(hWndCol)
.head 9 -      Break
.head 8 -      Set nCol=nCol+1
.head 7 -      Return hWndCol
.head 4 +  Message Actions
.head 5 +  On UM_Create
.head 6 -  Call SalWaitCursor(TRUE)
.head 6 -  Call XConnectGetParams(tbl.cMain)
.head 6 +  If NOT tbl.cMain.Connect()
.head 7 -  Call SalWaitCursor(FALSE)
.head 7 -  Call SalDestroyWindow(hWndForm)
.head 6 -  !
.head 6 -  Call XSalTooltipSetUserDefault()
.head 6 -  Call SaveInfoToLog(MSG_Invoke() || strTitleAux)
.head 6 +  If strTitleAux != ''
.head 7 -  Call SalGetWindowText(hWndForm, strOldTitle, 256)
.head 7 -  Call SalSetWindowText(hWndForm, strOldTitle || ': [' || strTitleAux || ']')
.head 6 -  !
.head 6 +  If strFilterTblName != ''
.head 7 -  Call tbl.cF.Init(strFilterTblName, strFilterTblName)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbFilter)
.head 6 -  !
.head 6 +  If nFlags & GT_NoIns
.head 7 -  Call SalDisableWindow(pbIns)
.head 6 +  If nFlags & GT_NoDel
.head 7 -  Call SalDisableWindow(pbDel)
.head 6 +  If nFlags & GT_NoUpd
.head 7 -  Call SalDisableWindow(pbUpdate)
.head 6 -  Call ccSplitter.setBarPosition( 800 )
.head 6 -  Call ccSplitter.setLeftFrame( tbl )
.head 6 -  Call ccSplitter.setRightFrame( tbl2 )
.head 5 +  On SAM_CreateComplete
.head 6 -  Call SalWaitCursor(FALSE)
.head 6 +  If strFilterTblName
.head 7 -  Call SalSendMsg(pbFilter, SAM_Click, 0, 0)
.head 6 +  Else
.head 7 -  Call SalSendMsg(tbl, UM_Populate, 0, 0)
.head 5 -  On UM_DoubleClick
.head 5 +  On UM_Print
.head 6 +  If strPrintFileName
.head 7 -  Call SalGetWindowText(tbl, strOldTitle, 100)
.head 7 -  Call TablePrint(tbl, strOldTitle, GetPrnDir() || '\\' || strPrintFileName, '')
.head 5 +  On UM_Search
.head 6 -  Call TblFindString(tbl,  DFIND_First)
.head 5 +  On UM_Close
.head 6 +  If SalTblAnyRows(tbl, ROW_Edited | ROW_MarkDeleted | ROW_New, 0)
.head 7 -  Call SalMessageBeep(MB_IconQuestion)
.head 7 +  If SalMessageBox('В таблице присутсвуют несохраненные изменения. Игнорировать их?',
'Внимание!', MB_IconQuestion | MB_YesNo) != IDYES
.head 8 -  Return FALSE
.head 6 -  Call SalDestroyWindow(hWndForm)
.head 5 +  On SAM_Destroy
.head 6 +  If tbl.cMain.IsConnected()
.head 7 -  Call tbl.cMain.Disconnect()
.head 6 -  Call SaveInfoToLog('Выход из диалога: ' || strTitleAux)
.head 2 +  Default Classes
.head 3 -  MDI Window: cBaseMDI
.head 3 -  Form Window:
.head 3 -  Dialog Box:
.head 3 -  Table Window:
.head 3 -  Quest Window:
.head 3 -  Data Field:
.head 3 -  Spin Field:
.head 3 -  Multiline Field:
.head 3 -  Pushbutton: ctb_pbFilter
.head 3 -  Radio Button:
.head 3 -  Option Button:
.head 3 -  Check Box:
.head 3 -  Child Table:
.head 3 -  Quest Child Window: cQuickDatabase
.head 3 -  List Box:
.head 3 -  Combo Box: cGenComboBox_NumId
.head 3 -  Picture:
.head 3 -  Vertical Scroll Bar:
.head 3 -  Horizontal Scroll Bar:
.head 3 -  Column:
.head 3 -  Background Text:
.head 3 -  Group Box:
.head 3 -  Line:
.head 3 -  Frame:
.head 3 -  Custom Control:
.head 2 -  Application Actions
.head 1 +  Form Window: spl_RepGroups
.head 2 -  Class: cGenericTableSpl3
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Конструктор звітних груп виписок
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? Class Default
.head 2 -  Visible? Class Default
.head 2 -  Display Settings
.head 3 -  Display Style? Class Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Class Default
.head 3 -  Initial State: Class Default
.head 3 -  Maximizable? Class Default
.head 3 -  Minimizable? Class Default
.head 3 -  System Menu? Class Default
.head 3 -  Resizable? Class Default
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  Class Default
.head 4 -  Width Editable? Class Default
.head 4 -  Height: Class Default
.head 4 -  Height Editable? Class Default
.head 3 -  Form Size
.head 4 -  Width:  Class Default
.head 4 -  Height: Class Default
.head 4 -  Number of Pages: Class Default
.head 3 -  Font Name: Class Default
.head 3 -  Font Size: Class Default
.head 3 -  Font Enhancement: Class Default
.head 3 -  Text Color: Class Default
.head 3 -  Background Color: Class Default
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Class Default
.head 4 -  Location? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Size: Class Default
.head 4 -  Size Editable? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 3 +  Contents
.head 4 +  Pushbutton: pbIns
.head 5 -  Class Child Ref Key: 15
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Click
.head 7 -  Call SalSendMsg( hWndLost, UM_Insert, 0, 0 )
.head 4 +  Pushbutton: pbDel
.head 5 -  Class Child Ref Key: 16
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Click
.head 7 -  Call SalSendMsg( hWndLost, UM_Delete, 0, 0 )
.head 4 +  Pushbutton: pbRefresh
.head 5 -  Class Child Ref Key: 17
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbUpdate
.head 5 -  Class Child Ref Key: 18
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Click
.head 7 -  Call SalSendMsg( hWndLost, UM_Update, 0, 0 )
.head 7 -  Call SalSendMsg( tbl2,     UM_Update, 0, 0 )
.head 7 -  Call SalSendMsg( tbl,      UM_Update, 0, 0 )
.head 4 -  Line
.head 5 -  Resource Id: 46248
.head 5 -  Class Child Ref Key: 19
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbSearch
.head 5 -  Class Child Ref Key: 20
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbFilter
.head 5 -  Class Child Ref Key: 21
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDetails
.head 5 -  Class Child Ref Key: 31
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name: \BARS98\RESOURCE\BMP\BOOK.BMP
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Click
.head 7 -  Call FunNSIEditControlled( "rep_otchgrp", cmbGroups, SAM_Create )
.head 4 +  Pushbutton: pbPrint
.head 5 -  Class Child Ref Key: 22
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 46249
.head 5 -  Class Child Ref Key: 23
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbExit
.head 5 -  Class Child Ref Key: 25
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 46250
.head 5 -  Class Child Ref Key: 26
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableSpl3
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 -  Background Text: Гр.:
.head 5 -  Resource Id: 46251
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class:
.head 5 -  Window Location and Size
.head 6 -  Left:   4.883"
.head 6 -  Top:    0.119"
.head 6 -  Width:  0.65"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Justify: Right
.head 5 -  Font Name: Default
.head 5 -  Font Size: 10
.head 5 -  Font Enhancement: Bold
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 4 +  Combo Box: cmbGroups
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenComboBox_NumId
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Window Location and Size
.head 6 -  Left:   5.583"
.head 6 -  Top:    0.095"
.head 6 -  Width:  4.9"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 5.524"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Editable? No
.head 5 -  String Type: Class Default
.head 5 -  Maximum Data Length: Class Default
.head 5 -  Sorted? Class Default
.head 5 -  Always Show List? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Bold
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: System Window Color
.head 5 -  Input Mask: Class Default
.head 5 -  List Initialization
.head 5 +  Message Actions
.head 6 +  On SAM_Create
.head 7 +  If cmbGroups.Init( hWndItem )
.head 8 -  Call cmbGroups.Populate( hSql(), 'otchgrp', "substr(otchgrp||'-'||name,1,20)", 'rep_otchgrp', 'ORDER BY name' )
.head 8 -  Call cmbGroups.SetSelectById( nGrp )
.head 6 +  On SAM_Click
.head 7 -  Call SalSendClassMessage( SAM_Click, 0, 0 )
.head 7 -  Set nGrp=cmbGroups.nCurrentId
.head 7 -  Set nI = 0
.head 7 -  Call SalSendMsg( tbl, UM_Populate, 0, 0 )
.head 2 +  Contents
.head 3 +  Child Table: tbl
.head 4 -  Class Child Ref Key: 28
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cGenericTableSpl3
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  View: Class Default
.head 5 -  Allow Row Sizing? Class Default
.head 5 -  Lines Per Row: Class Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Class Default
.head 5 -  Discardable? Class Default
.head 4 +  Contents
.head 5 +  Column: accgrp
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: № гр.
рах.
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.967"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: accgrp_name
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Назва групи рахунків
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  2.783"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 +  Message Actions
.head 7 +  ! On SAM_DoubleClick
.head 8 +          If bInsertingMode AND (nChooseState=1)
.head 9 -          Set bTmp=FALSE
.head 9 -          Call SalModalDialog( dlg_RepReference, tbl_RepGroups,
2, cConn.hSql(),
nTmp, sTmp, sTmp2, bTmp)
.head 9 +          If bTmp
.head 10 -          Set tbl_RepGroups.accgrp=nTmp
.head 10 -          Set tbl_RepGroups.accgrp_name=sTmp
.head 10 -          Set tbl_RepGroups.accgrp_filemask=sTmp2
.head 5 +  Column: accgrp_filemask
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Префікс
імені файлу
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  1.633"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: accgrp_dir
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Каталог формування
файлу
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  2.7"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 +  Window Variables
.head 5 -  Number: x
.head 4 +  Message Actions
.head 5 +  On UM_Populate
.head 6 -  Set spl_RepGroups.strSqlPopulate=
" SELECT  a.accgrp, a.name, a.filemask, a.grpdir
    INTO :spl_RepGroups.tbl.accgrp,
         :spl_RepGroups.tbl.accgrp_name,
         :spl_RepGroups.tbl.accgrp_filemask,
         :spl_RepGroups.tbl.accgrp_dir
    FROM  rep_otchgrp o, rep_accgrp a, rep_accg_otchg t
   WHERE o.otchgrp=t.otchgrp AND a.accgrp=t.accgrp AND o.otchgrp=:nGrp
   ORDER BY o.otchgrp, a.accgrp "
.head 6 -  Call SalTblDefineSplitWindow(hWndForm, 0, FALSE)
.head 6 -  Call SalSendClassMessage(UM_Populate, 0, 0)
.head 6 -  Call VisTblAutoSizeColumn(hWndForm, tbl.accgrp_name)
.head 6 -  ! ! Установить на старое место
.head 6 -  Set nRow = VisTblFindNumber (tbl, 0, tbl.accgrp, nID)
.head 6 +  If nRow=-1
.head 7 -  Call SalTblSetContext( hWndForm, 0 )
.head 6 +  Else
.head 7 -  Call SalTblSetContext( hWndForm, nRow )
.head 7 -  Call SalTblSetRowFlags( hWndForm, nRow, ROW_Selected, TRUE )
.head 7 -  Call SalTblSetFocusRow( hWndForm, nRow )
.head 6 -  Call SalSendMsg(tbl, SAM_TblDoDetails, 0, 0)
.head 5 +  On SAM_TblDoDetails
.head 6 -  Call SalSendMsg(tbl2,UM_Populate,0,0)
.head 5 +  On SAM_KillFocus
.head 6 -  Set hWndLost=hWndForm
.head 6 -  Set nID=tbl.accgrp
.head 5 +  ! On SAM_Create
.head 6 -       Set spl_RepGroups.strSqlDelete='DELETE FROM rep_accg_otchg
                   WHERE accgrp=:spl_RepGroups.tbl.accgrp AND otchgrp=:nGrp'
.head 6 -       Set spl_RepGroups.strSqlInsert='
BEGIN
 INSERT INTO rep_accgrp (accgrp, name, filemask, grpdir)
     VALUES( :spl_RepGroups.tbl.accgrp,
             :spl_RepGroups.tbl.accgrp_name,
             :spl_RepGroups.tbl.accgrp_filemask,
             :spl_RepGroups.tbl.accgrp_dir );
END;'
.head 6 +  ! If SqlPrepareAndExecute(cConn.hSql(),
   " INSERT INTO rep_accgrp (accgrp, name, filemask, grpdir)
     VALUES( :nTmp,
             :tbl_RepGroups.accgrp_name,
             :tbl_RepGroups.accgrp_filemask,
             :tbl_RepGroups.accgrp_dir   ) ")
.head 7 +       If not SqlPrepareAndExecute(cConn.hSql(),
        " INSERT INTO rep_accg_otchg (accgrp, otchgrp)
          VALUES (:nTmp, :tbl_RepGroups.otchgrp) ")
.head 8 -       Set sErrMsg='Ошибка вставки в таблицу rep_accg_otchg'
.head 8 -       Return -1
.head 6 -  ! Set strSqlUpdate='
 UPDATE specparam SET idg=:colIdg,ids=:colIds,sps=nvl(:colSps,1)  WHERE acc=:colAcc'
.head 6 -       Call SalSendClassMessage( SAM_Create, 0, 0 )
.head 5 +  On UM_Update
.head 6 -  Call SalWaitCursor(TRUE)
.head 6 -  ! INSERT
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow ( hWndForm, nRow, ROW_New, 0 )
.head 7 -  Call SalTblSetContext( hWndForm, nRow )
.head 7 -  !
.head 7 -  Call SqlPrepareAndExecute( cMain.hSql(),
"SELECT accgrp, name, filemask, grpdir
   INTO :spl_RepGroups.tbl.accgrp,
        :spl_RepGroups.tbl.accgrp_name,
        :spl_RepGroups.tbl.accgrp_filemask,
        :spl_RepGroups.tbl.accgrp_dir FROM rep_accgrp
  WHERE accgrp=:spl_RepGroups.tbl.accgrp")
.head 7 +  If not SqlFetchNext( cMain.hSql(), nFetchRes )
.head 8 +  If not SqlPrepareAndExecute(cMain.hSql(),
   "INSERT INTO rep_accgrp (accgrp, name, filemask, grpdir)
     VALUES( :spl_RepGroups.tbl.accgrp,
             :spl_RepGroups.tbl.accgrp_name,
             :spl_RepGroups.tbl.accgrp_filemask,
             :spl_RepGroups.tbl.accgrp_dir )")
.head 9 -  Break
.head 7 +  If not SqlPrepareAndExecute(cMain.hSql(),
        " INSERT INTO rep_accg_otchg (accgrp, otchgrp)
          VALUES (:spl_RepGroups.tbl.accgrp, :nGrp) ")
.head 8 -  Break
.head 7 -  Call SqlCommit(cMain.hSql())
.head 6 -  Call SqlRollback(cMain.hSql())
.head 6 -  ! DELETE
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow ( hWndForm, nRow, ROW_MarkDeleted, 0 )
.head 7 -  Call SalTblSetContext( hWndForm, nRow )
.head 7 -  !
.head 7 -  Call SqlPrepareAndExecute( cMain.hSql(),
"SELECT count(*) INTO :x FROM rep_accg_otchg
  WHERE accgrp=:spl_RepGroups.tbl.accgrp")
.head 7 -  Call SqlFetchNext( cMain.hSql(), nFetchRes )
.head 7 +  If not SqlPrepareAndExecute(cMain.hSql(),
  "DELETE FROM rep_accg_otchg
    WHERE accgrp=:spl_RepGroups.tbl.accgrp AND otchgrp=:nGrp")
.head 8 -  Break
.head 7 -  !
.head 7 +  If x = 1
.head 8 +  If not SqlPrepareAndExecute(cMain.hSql(),
  "DELETE FROM rep_acc WHERE accgrp=:spl_RepGroups.tbl.accgrp")
.head 9 -  Break
.head 8 +  If not SqlPrepareAndExecute(cMain.hSql(),
  "DELETE FROM rep_accgrp WHERE accgrp=:spl_RepGroups.tbl.accgrp")
.head 9 -  Break
.head 7 -  Call SqlCommit(cMain.hSql())
.head 6 -  Call SqlRollback(cMain.hSql())
.head 6 -  ! UPDATE
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow ( hWndForm, nRow, ROW_Edited, 0 )
.head 7 -  Call SalTblSetContext( hWndForm, nRow )
.head 7 +  If not SqlPrepareAndExecute(cMain.hSql(),
  "UPDATE rep_accgrp
      SET name    =:spl_RepGroups.tbl.accgrp_name,
         filemask =:spl_RepGroups.tbl.accgrp_filemask,
         grpdir   =:spl_RepGroups.tbl.accgrp_dir
    WHERE  accgrp =:spl_RepGroups.tbl.accgrp")
.head 8 -  Break
.head 7 -  Call SqlCommit(cMain.hSql())
.head 6 -  Call SqlRollback(cMain.hSql())
.head 6 -  Call SalSendMsg(tbl, UM_Populate, 0, 0)
.head 6 -  Call SalWaitCursor(FALSE)
.head 3 +  Custom Control: ccSplitter
.head 4 -  Class Child Ref Key: 36
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cGenericTableSpl3
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  DLL Settings
.head 4 -  Message Actions
.head 3 +  Child Table: tbl2
.head 4 -  Class Child Ref Key: 35
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cGenericTableSpl3
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  View: Class Default
.head 5 -  Allow Row Sizing? Class Default
.head 5 -  Lines Per Row: Class Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Class Default
.head 5 -  Discardable? Class Default
.head 4 +  Contents
.head 5 +  ! Column: accgrp
.winattr
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: № группы
 счетов
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.967"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.end
.head 6 -        List Values
.head 6 -        Message Actions
.head 5 +  Column: nlsmask
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Маска чи номер
рахунку
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  2.4"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colRowId
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title:
.head 6 -  Visible? No
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: kv
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Валюта
(0-всі)
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.917"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: branch
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Відділення
.head 6 -  Visible? Class Default
.head 6 -  Editable? Class Default
.head 6 -  Maximum Data Length: Class Default
.head 6 -  Data Type: Class Default
.head 6 -  Justify: Class Default
.head 6 -  Width:  3.0"
.head 6 -  Width Editable? Class Default
.head 6 -  Format: Class Default
.head 6 -  Country: Class Default
.head 6 -  Input Mask: Class Default
.head 6 -  Cell Options
.head 7 -  Cell Type? Class Default
.head 7 -  Multiline Cell? Class Default
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Class Default
.head 8 -  Vertical Scroll? Class Default
.head 8 -  Auto Drop Down? Class Default
.head 8 -  Allow Text Editing? Class Default
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Class Default
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 +  Message Actions
.head 5 +  On UM_Populate
.head 6 -  Set strSqlPopulate=
 " select a.nlsmask,a.rowid, a.kv, a.branch
     into :spl_RepGroups.tbl2.nlsmask, :spl_RepGroups.tbl2.colRowId, 
          :spl_RepGroups.tbl2.kv, :spl_RepGroups.tbl2.branch
     from rep_acc a
    where a.accgrp=:spl_RepGroups.tbl.accgrp
    order by a.accgrp, a.nlsmask"
.head 6 -  Call SalTblDefineSplitWindow(hWndForm, 0, FALSE)
.head 6 -  Call SalSendClassMessage(UM_Populate, 0, 0)
.head 6 -  !
.head 6 -  Call VisTblAutoSizeColumn(hWndForm, hWndNULL)
.head 6 -  ! ! Установить на старое место
.head 6 -  Set nRow = VisTblFindString (tbl2, 0, tbl2.nlsmask, sID)
.head 6 +  If nRow=-1
.head 7 -  Call SalTblSetContext( hWndForm, 0 )
.head 6 +  Else
.head 7 -  Call SalTblSetContext( hWndForm, nRow )
.head 7 -  Call SalTblSetRowFlags( hWndForm, nRow, ROW_Selected, TRUE )
.head 7 -  Call SalTblSetFocusRow( hWndForm, nRow )
.head 5 +  On SAM_KillFocus
.head 6 -  Set hWndLost=hWndForm
.head 6 -  Set sID=tbl2.nlsmask
.head 5 +  On UM_Insert
.head 6 +  If not SalTblAnyRows(hWndForm, ROW_New, 0)
.head 7 -  Call SalTblDefineSplitWindow(hWndForm, 3, TBL_Split_Adjustable)
.head 6 -  Set nRow = SalTblInsertRow(hWndForm, TBL_MinRow)
.head 6 -  Call SalTblSetContext(hWndForm, nRow)
.head 6 -  Call SalTblSetFocusCell(hWndForm, nRow, tbl.GetFirstEditableColumn(hWndForm), 0, 1)
.head 5 +  On UM_Delete
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow(hWndForm, nRow, ROW_Selected, 0)
.head 7 +  If NOT SalTblQueryRowFlags(hWndForm, nRow, ROW_New)
.head 8 -  Call SalTblSetRowFlags(hWndForm, nRow, ROW_MarkDeleted,
     not SalTblQueryRowFlags(hWndForm, nRow, ROW_MarkDeleted))
.head 7 +  Else
.head 8 -  Call SalTblDeleteRow(hWndForm, nRow, TBL_NoAdjust)
.head 5 +  On SAM_Create
.head 6 -  Set strSqlDelete='delete from rep_acc
                  where accgrp  = :spl_RepGroups.tbl.accgrp 
                    and nlsmask = :spl_RepGroups.tbl2.nlsmask
                    and branch  = :spl_RepGroups.tbl2.branch'
.head 6 -  Set strSqlInsert='insert into rep_acc(accgrp, nlsmask, kv, branch)
                  values (:spl_RepGroups.tbl.accgrp,:spl_RepGroups.tbl2.nlsmask,
                          :spl_RepGroups.tbl2.kv, ,:spl_RepGroups.tbl2.branch)'
.head 6 -  Set strSqlUpdate='update rep_acc 
                     set nlsmask = :spl_RepGroups.tbl2.nlsmask, 
                         kv = :spl_RepGroups.tbl2.kv,
                         branch = :spl_RepGroups.tbl2.branch 
                   where rowid=:spl_RepGroups.tbl2.colRowId'
.head 6 -  Call SalSendClassMessage( SAM_Create, 0, 0 )
.head 5 +  On UM_Update
.head 6 -  Call SalWaitCursor(TRUE)
.head 6 +  If strSqlDelete != ''
.head 7 -  Call SqlPrepare(tbl.cMain.hSql(), T(strSqlDelete))
.head 7 -  Call SalTblDoDeletes(hWndForm, tbl.cMain.hSql(), ROW_MarkDeleted)
.head 6 +  If strSqlInsert != ''
.head 7 -  Call SqlPrepare(tbl.cMain.hSql(), T(strSqlInsert))
.head 7 -  Call SalTblDoInserts(hWndForm, tbl.cMain.hSql(), TRUE)
.head 6 +  If strSqlUpdate != ''
.head 7 -  Call SqlPrepare(tbl.cMain.hSql(), T(strSqlUpdate))
.head 7 -  Call SalTblDoUpdates(hWndForm, tbl.cMain.hSql(), TRUE)
.head 6 -  Call SqlCommit(tbl.cMain.hSql())
.head 6 -  Call SalTblDefineSplitWindow(hWndForm, 0, FALSE)
.head 6 -  Call SalSendMsg(hWndForm, UM_Populate, 0, 0)
.head 6 -  Call SalWaitCursor(FALSE)
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: nPar
.head 2 +  Window Variables
.head 3 -  Number: nI
.head 3 -  Number: nGrp
.head 3 -  Number: nRow
.head 3 -  Number: nID
.head 3 -  String: sID
.head 3 -  Window Handle: hWndLost
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalWaitCursor(TRUE)
.head 4 -  Call PrepareWindowEx( hWndForm )
.head 4 -  Call SetWindowFullSize( hWndForm )
.head 4 -  ! Call ShowApdVersion('06')
.head 4 -  Set spl_RepGroups.nFlags=GT_NoRet
.head 4 -  Set spl_RepGroups.nTabInstance1 = 1
.head 4 -  Set spl_RepGroups.nTabInstance2 = 1
.head 4 -  Set fFilterAtStart=FALSE
.head 4 -  ! Set strFilterTblName = 'accounts'
.head 4 -  ! Set strPrintFileName = 'VYP.txt'
.head 4 -  Call SalTblSetTableFlags(tbl, TBL_Flag_SingleSelection, TRUE)
.head 4 -  ! Созданием списка операций для обработки
.head 4 -  Call SalSendClassMessage(SAM_Create, 0, 0)
.head 4 -  ! Call ccSplitter.setBarPosition( 650 )
.head 4 -  ! Call tbl.cF.Init(strFilterTblName, 'a')
.head 1 +  Dialog Box: dlg_LoadDbf
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Загрузка файла
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   1.738"
.head 4 -  Top:    1.188"
.head 4 -  Width:  7.2"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 2.452"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Загрузка файлов dbf в таблицы б.д. (MIK+IVAN)
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? No
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  !
.head 3 +  Custom Control: ccProgressBar
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cMeter
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   0.143"
.head 6 -  Top:    1.107"
.head 6 -  Width:  6.829"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 0.281"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Dark Blue
.head 5 -  Background Color: 3D Face Color
.head 5 -  DLL Settings
.head 4 +  Message Actions
.head 5 +  ! On SAM_Create
.head 6 -      Call SalSetFocus(hWndItem)
.head 3 -  !
.head 3 -  Frame
.head 4 -  Resource Id: 7525
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   -0.017"
.head 5 -  Top:    -0.012"
.head 5 -  Width:  7.15"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 1.0"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Data Field: dfPath
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.171"
.head 6 -  Top:    0.156"
.head 6 -  Width:  5.186"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SalSetFocus(hWndItem)
.head 3 +  Pushbutton: pbChoose
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выбрать...
.head 4 -  Window Location and Size
.head 5 -  Left:   5.486"
.head 5 -  Top:    0.135"
.head 5 -  Width:  1.429"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.292"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: Enter
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: None
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalDlgOpenFile(hWndForm, 'Open File', strFilters, 2, nIndex, strFile, dfPath)
.head 3 +  Check Box: cbTransCode
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cCheckBoxLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Перекодировать из кодировки OEM (DOS) в ANSI (WIN)
.head 4 -  Window Location and Size
.head 5 -  Left:   0.183"
.head 5 -  Top:    0.595"
.head 5 -  Width:  6.057"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 -  Frame
.head 4 -  Resource Id: 7526
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   -0.017"
.head 5 -  Top:    0.988"
.head 5 -  Width:  7.15"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.531"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 -  Frame
.head 4 -  Resource Id: 7527
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   -0.017"
.head 5 -  Top:    1.5"
.head 5 -  Width:  7.15"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.667"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pbRun
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выполнить
.head 4 -  Window Location and Size
.head 5 -  Left:   1.533"
.head 5 -  Top:    1.571"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.452"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\EXECUTE.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set fOpen = TRUE
.head 6 +  If dfPath = STRING_Null or dfPath = ''
.head 7 -  Set fOpen = SalDlgOpenFile(hWndForm, 'Open File', strFilters, 2, nIndex, strFile, dfPath)
.head 6 +  Else
.head 7 -  Call VisDosSplitPath(dfPath, tmp01, tmp02, tmp03, tmp04)
.head 7 -  Set strFile = tmp03 || tmp04
.head 7 +  If not strFile
.head 8 -  Set fOpen = SalDlgOpenFile(hWndForm, 'Open File', strFilters, 2, nIndex, strFile, dfPath)
.head 6 +  If fOpen
.head 7 -  ! Call SalMessageBox(strFile, dfPath, MB_OK)
.head 7 +  If SalFileSetCurrentDirectory(SalStrLeftX(dfPath, SalStrScan(dfPath,strFile)-1))
.head 8 -  ! Call SalSetWindowText(hWndForm, 'Загрузка файла ' || dfPath)
.head 8 -  Call SalSetWindowText(hWndForm, CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTWndTitle') || ' ' || dfPath)
.head 8 -  Call CreTabSqlFromDbf(strFile, cbTransCode)
.head 7 +  Else
.head 8 -  ! Call SalMessageBox('Не удалось переити в каталог' || PutCrLf() || dfPath, '', MB_OK)
.head 8 -  Call SalMessageBox('Не удалось переити в каталог' || PutCrLf() || dfPath, '', MB_OK)
.head 7 -  ! локальная примочка для банка Аваль
.head 7 -  ! предназначена для для дополнительной обработки классификатора BAT файлом
.head 7 +  If GetBankMfo() = '380805'
.head 8 -  Call SalLoadApp('klsync.bat' , dfPath)
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Отменить
.head 4 -  Window Location and Size
.head 5 -  Left:   4.167"
.head 5 -  Top:    1.571"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.452"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\DISCARD.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog(hWndForm, 0)
.head 2 +  Functions
.head 3 +  Function: CreTabSqlFromDbf
.head 4 -  Description: Создание таблиы из DFB-файла
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sDbf
.head 5 -  Boolean: bTrans
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Sql Handle: hSqlOdbc
.head 5 -  File Handle: hFile
.head 5 -  String: sBuf
.head 5 -  String: sItem
.head 5 -  String: sTyp
.head 5 -  String: sLen1
.head 5 -  String: sLen2
.head 5 -  Number: i
.head 5 -  Number: j
.head 5 -  Number: nLen1
.head 5 -  Number: nLen2
.head 5 -  String: sSqlItm
.head 5 -  String: sSqlSel
.head 5 -  String: sSqlBin
.head 5 -  String: sTab
.head 5 -  Number: NTmp[*]
.head 5 -  Number: LTmp[*]		! -boolean (0/1) dbf(F/T)
.head 5 -  String: CTmp[*]
.head 5 -  Date/Time: DTmp[*]
.head 5 -  Number: nRec
.head 5 -  Number: nDelta
.head 5 -  Number: nFetchRes
.head 5 -  Number: nBound
.head 5 -  Boolean: fRecreate
.head 5 -  Boolean: fExists
.head 5 -  ! Boolean: fInsertRow
.head 5 -  Number: nRowsCount
.head 5 -  Number: nRow
.head 5 -  Number: nChoose
.head 5 -  !
.head 5 -  String: sSqlDel
.head 5 -  Number: nKp
.head 5 -  Number: nKv
.head 5 -  Number: nI
.head 5 -  String: smPer[*]
.head 5 -  String: smVal[*]
.head 5 -  Boolean: bDel
.head 5 -  Boolean: bDelZ
.head 5 -  !
.head 5 -  String: sTable
.head 5 -  String: sSqlText
.head 5 -  String: sSynonym
.head 5 -  String: sRole
.head 5 -  String: sGrant
.head 5 -  String: sPolicy
.head 5 -  String: sValues
.head 5 -  String: sImpMod
.head 5 -  String: sErrMessage
.head 4 +  Actions
.head 5 -  ! Импорт sDbf
.head 5 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTImport') || " " || sDbf)
.head 5 +  If not checkForValidTableName(sDbf, sErrMessage)
.head 6 -  Call SalMessageBox(sErrMessage, CurrentLangTable.GetAtomTitle('cTAt'), MB_IconStop | MB_Ok)
.head 6 -  Call SaveInfoToLog(AppCode || sErrMessage)
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 +  If SalFileOpen(hFile, sDbf, OF_Read)
.head 7 -  ! Читаем структуру таблицы dbf
.head 7 -  Call SalFileRead(hFile, sBuf, 32)
.head 7 -  Set sSqlItm = ''
.head 7 -  Set j = 0
.head 7 +  While SalFileRead(hFile, sBuf, 32) > 0
.head 8 -  Set sItem = SalStrTrimX(sBuf)
.head 8 +  If SalStrLop(sBuf) = 13
.head 9 -  Set sSqlItm = sSqlItm || ')'
.head 9 -  Break
.head 8 +  Else
.head 9 +  If SalStrLength(sSqlItm) = 0
.head 10 -  Set i = SalStrLength(sDbf)
.head 10 +  While i > 0
.head 11 +  If SalStrMidX(sDbf, i-1, 1) = '\\' or SalStrMidX(sDbf, i-1, 1) = ':'
.head 12 -  Break
.head 11 -  Set i = i - 1
.head 10 -  Set sTab = SalStrMidX(sDbf, i, SalStrLength(sDbf) - i)
.head 10 -  Set i = SalStrScan(sTab, '.')
.head 10 +  If i >= 0
.head 11 -  Set sTab = SalStrLeftX(sTab, SalStrScan(sTab, '.'))
.head 10 -  Set sSqlItm = '('
.head 10 -  Set sSqlSel = ''
.head 10 -  Set sSqlBin = ''
.head 9 +  Else
.head 10 -  Set sSqlItm = sSqlItm || ','
.head 10 -  Set sSqlSel = sSqlSel || ','
.head 10 -  Set sSqlBin = sSqlBin || ','
.head 8 -  Set i = 0
.head 8 +  While i < 10
.head 9 -  Call SalStrLop(sBuf)
.head 9 -  Set i = i + 1
.head 8 -  Set sTyp = SalNumberToChar(SalStrLop(sBuf))
.head 8 +  If not (sTyp = 'C' OR sTyp = 'N' OR sTyp = 'D' OR sTyp = 'L')
.head 9 -  Set sSqlItm = SalStrMidX(sSqlItm, 0, SalStrLength(sSqlItm)-2)
.head 9 -  Set sSqlSel = SalStrMidX(sSqlSel, 0, SalStrLength(sSqlSel)-1)
.head 9 -  Set sSqlBin = SalStrMidX(sSqlBin, 0, SalStrLength(sSqlBin)-1)
.head 8 -  Set i = 0
.head 8 +  While i < 4
.head 9 -  Call SalStrLop(sBuf)
.head 9 -  Set i = i + 1
.head 8 -  Set nLen1 = SalStrLop(sBuf)
.head 8 -  Set sLen1 = SalNumberToStrX(nLen1, 0)
.head 8 -  Set nLen2 = SalStrLop(sBuf)
.head 8 -  Set sLen2 = SalNumberToStrX(nLen2, 0)
.head 8 +  If sTyp = 'C' OR sTyp = 'N' OR sTyp = 'D' OR sTyp = 'L'
.head 9 -  Set sSqlBin = sSqlBin || ':' || sTyp || 'Tmp[' || SalNumberToStrX(j, 0) || ']'
.head 9 -  Set j = j + 1
.head 9 +  If sTyp = 'C'
.head 10 +  If nLen1 < 11
.head 11 -  Set sTyp = 'CHAR'
.head 10 +  Else
.head 11 -  Set sTyp = 'VARCHAR'
.head 9 +  Else If sTyp = 'N'
.head 10 +  If nLen1 < 5 and nLen2 = 0
.head 11 -  Set sTyp = 'SMALLINT'
.head 11 -  Set sLen1 = ''
.head 10 +  Else If nLen1 < 10 and nLen2 = 0
.head 11 -  Set sTyp = 'INTEGER'
.head 11 -  Set sLen1 = ''
.head 10 +  Else
.head 11 -  Set sTyp = 'DECIMAL'
.head 11 -  Set sLen1 = sLen1 || ',' || sLen2
.head 9 +  Else If sTyp = 'D'
.head 10 -  Set sTyp = 'DATE'
.head 10 -  Set sLen1 = ''
.head 9 +  Else If sTyp = 'L'
.head 10 -  Set sTyp = 'CHAR'
.head 10 -  Set sLen1 = '1'
.head 9 +  If sLen1 = ''
.head 10 -  Set sSqlItm = sSqlItm || sItem || ' ' || sTyp
.head 9 +  Else
.head 10 -  Set sSqlItm = sSqlItm || sItem || ' ' || sTyp || '(' || sLen1 || ')'
.head 9 -  Set sSqlSel = sSqlSel || sItem
.head 7 +  If hFile
.head 8 -  Call SalFileClose(hFile)
.head 7 -  !
.head 7 -  Set SqlDatabase = 'dBase_Files'
.head 7 +  If SqlConnect(hSqlOdbc)
.head 8 -  Set fExists   = FALSE
.head 8 -  Set fRecreate = FALSE
.head 8 -  Set bDel      = FALSE
.head 8 -  Set bDelZ     = FALSE
.head 8 -  Set sImpMod   = ''
.head 8 -  !
.head 8 -  ! Есть таблица?
.head 8 +  If TableExists(sTab)
.head 9 -  Set fExists = TRUE
.head 9 -  ! Для nMode=2 читаем Режим импорта
.head 9 +  If nMode = 2
.head 10 -  ! Режим импорта
.head 10 -  Call SqlPrepareAndExecute(hSql(), "select impmod into :sImpMod from dbf_imp_tabs where upper(tabname) = upper(:sTab)")
.head 10 +  If not SqlFetchNext(hSql(), nFetchRes)
.head 11 -  Call SalMessageBox("В справочнике допустимых таблиц для импорта таблица " || sTab || " не обнаружена", "Внимание", 0)
.head 11 -  Call SaveInfoToLog(AppCode || "В справочнике допустимых таблиц для импорта таблица " || sTab || " не обнаружена")
.head 11 -  Return FALSE
.head 10 -  ! C - drop+create+insert
.head 10 +  If sImpMod = 'C'
.head 11 -  Set fRecreate = TRUE
.head 10 -  ! I - delete+insert
.head 10 +  Else If sImpMod = 'I'
.head 11 -  Set bDel  = TRUE
.head 10 -  ! A - insert
.head 9 -  ! смотрим есть ли записи в таблице
.head 9 +  If SqlPrepareAndExecute(hSql(), 'SELECT count(*) INTO :nRowsCount FROM ' || sTab)
.head 10 -  Call SqlFetchNext(hSql(), nRow)
.head 9 -  ! если нету строк - drop-нуть или оставить
.head 9 +  If nRowsCount = 0
.head 10 +  If nMode = 0
or nMode = 2 and sImpMod = ''
.head 11 -  ! Таблица sTab уже существует (пустая) !
  Удалить таблицу sTab и создать НОВУЮ ?
.head 11 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgTable') || ' ' || sTab || ' ' ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg11') || PutCrLf() ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg12') || ' ' || sTab || ' ' ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg13'))
.head 11 +  If SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgTable') || ' ' || sTab || ' ' ||
   CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg11') || PutCrLf() ||
   CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg12') || ' ' || sTab || ' ' ||
   CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg13'),
   CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTConfirm'), MB_YesNo | MB_IconExclamation) = IDYES
.head 12 -  Set fRecreate = TRUE
.head 12 -  Set bDel  = FALSE
.head 12 -  Set bDelZ = FALSE
.head 11 +  Else
.head 12 -  ! Пользователь отказался от импорта таблицы sTab
.head 12 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTNotImport') || " " || sTab)
.head 12 -  Return FALSE
.head 9 -  ! если есть строки - drop-нуть или просто удалить записи?
.head 9 +  Else If nMode != 2
     or nMode  = 2 and sImpMod = ''
.head 10 -  Call VisMessageSetBkgdColor(COLOR_Salmon)
.head 10 -  Set hBtns[0] = hBtnDelNew
.head 10 -  Set hBtns[1] = hBtnNoDelNew
.head 10 -  Set hBtns[2] = hBtnNo | MBF_DefButton
.head 10 -  Set hBtns[3] = hBtnNoDelPlusNew1
.head 10 -  Set hBtns[4] = hBtnNoDelPlusNew2
.head 10 -  ! Таблица sTab уже существует c данными !
                   НОВАЯ - Удалить таблицу и создать НОВУЮ
                 ЗАМЕНА - НЕ удалять таблицу, УДАЛИТЬ старые данные
  НОВЫЕ ДАННЫЕ - НЕ удалять таблицу, добавить ТОЛЬКО НОВЫЕ данные
            ДОБАВИТЬ - НЕ удалять таблицу, добавить ВСЕ данные
.head 10 +  If nMode = 1
.head 11 -  Set nChoose = VisMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgTable') || ' ' || sTab || ' ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg21') || PutCrLf() || PutCrLf() ||
    '                 ' || PutCrLf() ||
    '               ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelNew') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg23') || PutCrLf() ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew1') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg24') || PutCrLf() ||
    '          ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew2') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg25'),
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTQuery'), MBF_IconQuestion, hBtns, 5)
.head 10 +  Else
.head 11 -  Set nChoose = VisMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgTable') || ' ' || sTab || ' ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg21') || PutCrLf() || PutCrLf() ||
    '                 ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnDelNew') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg22') || PutCrLf() ||
    '               ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelNew') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg23') || PutCrLf() ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew1') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg24') || PutCrLf() ||
    '          ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew2') || ' - ' ||
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg25'),
  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTQuery'), MBF_IconQuestion, hBtns, 5)
.head 10 +  If nChoose = 0	! drop + create + insert
.head 11 +  If nMode = 1
.head 12 -  Return TRUE
.head 11 -  ! Выбор: НОВАЯ - Удалить таблицу и создать НОВУЮ
.head 11 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTSelect') || ": " ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnDelNew') || ' - ' ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg22'))
.head 11 -  Set fRecreate = TRUE
.head 11 -  Set bDel  = FALSE
.head 11 -  Set bDelZ = FALSE
.head 10 +  If nChoose = 1	! delete + insert
.head 11 -  ! Выбор: ЗАМЕНА - НЕ удалять таблицу, УДАЛИТЬ старые данные
.head 11 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTSelect') || ": " ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelNew') || ' - ' ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg23'))
.head 11 -  Set fRecreate = FALSE
.head 11 -  Set bDel  = TRUE
.head 11 -  Set bDelZ = FALSE
.head 10 +  If nChoose = 2	! exit
.head 11 -  ! Пользователь отказался от импорта таблицы sTab
.head 11 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTNotImport') || " " || sTab)
.head 11 -  Return FALSE
.head 10 +  If nChoose = 3	! удаляем по условию (удаляются те строки, кот. есть в файле), добавляем весь файл
.head 11 -  ! Выбор: НОВЫЕ ДАННЫЕ - НЕ удалять таблицу, добавить ТОЛЬКО НОВЫЕ данные
.head 11 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTSelect') || ": " ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew1') || ' - ' ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg24'))
.head 11 -  Set fRecreate = FALSE
.head 11 -  Set bDel  = FALSE
.head 11 -  Set bDelZ = TRUE
.head 10 +  If nChoose = 4	! insert
.head 11 -  ! Выбор: ДОБАВИТЬ - НЕ удалять таблицу, добавить ВСЕ данные
.head 11 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTSelect') || ": " ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew2') || ' - ' ||
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg25'))
.head 11 -  Set fRecreate = FALSE
.head 11 -  Set bDel  = FALSE
.head 11 -  Set bDelZ = FALSE
.head 8 -  ! Таблицы нет - пересоздать (для nMode=0,2; для nMode=1 не пересоздаем)
.head 8 +  Else If nMode = 0 or nMode = 2
.head 9 -  Set fExists   = FALSE
.head 9 -  Set fRecreate = TRUE
.head 8 -  !
.head 8 -  ! Удаляем синоним (nMode=2 - схема без синонимов)
.head 8 +  If nMode != 2
.head 9 -  ! Удаление синонима sTab
.head 9 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTDropSynonym') || " " || sTab)
.head 9 -  ! -- begin: drop synonym
.head 9 -  Set sTable   = STRING_Null
.head 9 -  Set sSqlText = STRING_Null
.head 9 -  Set sSynonym = sTab
.head 9 -  Set sRole    = STRING_Null
.head 9 -  Set sGrant   = STRING_Null
.head 9 -  Set sPolicy  = STRING_Null
.head 9 +  If not SqlPLSQLCommand(hSql(), "p_make_table(5, sTable, sSqlText, sSynonym, sRole, sGrant, sPolicy)")
.head 10 -  ! Не удалось удалить синоним sTab
.head 10 -  Call SqlRollbackEx(hSql(), AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgNotDropSynonym') || " " || sTab)
.head 10 -  Return FALSE
.head 9 -  ! -- end: drop synonym
.head 8 -  !
.head 8 -  ! пересоздать таблицу
.head 8 +  If fRecreate
.head 9 -  ! если таблица есть - drop
.head 9 +  If fExists
.head 10 -  ! Удаление таблицы sTab
.head 10 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTDropTable') || " " || sTab)
.head 10 -  ! -- begin: drop table
.head 10 +  If nMode = 2
.head 11 -  ! drop table, role, delete from policy_table
.head 11 -  Set sTable   = sTab
.head 11 -  Set sSqlText = STRING_Null
.head 11 -  Set sSynonym = STRING_Null
.head 11 -  Set sRole    = sTab
.head 11 -  Set sGrant   = STRING_Null
.head 11 -  Set sPolicy  = sTab
.head 10 +  Else
.head 11 -  ! drop table, synonym, role
.head 11 -  Set sTable   = sTab
.head 11 -  Set sSqlText = STRING_Null
.head 11 -  Set sSynonym = sTab
.head 11 -  Set sRole    = sTab
.head 11 -  Set sGrant   = STRING_Null
.head 11 -  Set sPolicy  = STRING_Null
.head 10 +  If not SqlPLSQLCommand(hSql(), "p_make_table(5, sTable, sSqlText, sSynonym, sRole, sGrant, sPolicy)")
.head 11 -  ! Не удалось удалить таблицу sTab
.head 11 -  Call SqlRollbackEx(hSql(), AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgNotDropTable') || " " || sTab)
.head 11 -  Return FALSE
.head 10 -  ! -- end: drop table
.head 9 -  ! Создание таблицы sTab
.head 9 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTCreateTable') || " " || sTab)
.head 9 -  ! -- begin: create table
.head 9 +  If nMode = 2
.head 10 -  ! create table, role, grant, add to policy_table
.head 10 -  Set sTable   = sTab
.head 10 -  Set sSqlText = sSqlItm
.head 10 -  Set sSynonym = STRING_Null
.head 10 -  Set sRole    = sTab
.head 10 -  Set sGrant   = "select on " || sTab || " to start1"
.head 10 -  Set sPolicy  = "(table_name, repl_type) values(upper('" || sTab || "'), 'N')"
.head 9 +  Else
.head 10 -  ! create table, synonym, role, grant
.head 10 -  Set sTable   = sTab
.head 10 -  Set sSqlText = sSqlItm
.head 10 -  Set sSynonym = sTab
.head 10 -  Set sRole    = sTab
.head 10 -  Set sGrant   = "select on " || sTab || " to start1"
.head 10 -  Set sPolicy  = STRING_Null
.head 9 +  If not SqlPLSQLCommand(hSql(), "p_make_table(1, sTable, sSqlText, sSynonym, sRole, sGrant, sPolicy)")
.head 10 -  ! Не удалось создать таблицу sTab
.head 10 -  Call SqlRollbackEx(hSql(), AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgNotCreateTable') || " " || sTab)
.head 10 -  Return FALSE
.head 9 -  ! -- end: create table
.head 8 -  ! удалить записи, если нужно
.head 8 +  Else If bDel
.head 9 -  ! Удаление записей из таблицы sTab
.head 9 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTDelete') || " " || sTab)
.head 9 -  ! -- begin: delete from tbl
.head 9 -  Set sTable   = sTab
.head 9 -  Set sSqlText = STRING_Null
.head 9 -  Set sSynonym = STRING_Null
.head 9 -  Set sRole    = STRING_Null
.head 9 -  Set sGrant   = STRING_Null
.head 9 -  Set sPolicy  = STRING_Null
.head 9 +  If not SqlPLSQLCommand(hSql(), "p_make_table(4, sTable, sSqlText, sSynonym, sRole, sGrant, sPolicy)")
.head 10 -  ! Невозможно удалить записи из таблицы sTab
.head 10 -  Call SqlRollbackEx(hSql(), AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgDel') || ' ' || sTab)
.head 10 -  Return FALSE
.head 9 -  ! -- end: delete from tbl
.head 8 -  !
.head 8 -  ! Читаем кол-во строк в dbf
.head 8 -  Call SqlPrepareAndExecute(hSqlOdbc, 'SELECT count(*) FROM ' || sTab || ' INTO :nRec')
.head 8 -  Call SqlFetchNext(hSqlOdbc, nFetchRes)
.head 8 +  If nRec > 0
.head 9 -  Set i = 0
.head 9 -  Set nDelta = 100/nRec
.head 9 -  ! Добавление записей в таблицу sTab
.head 9 -  Call SaveInfoToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTInsert') || " " || sTab)
.head 9 -  Call SqlPrepareAndExecute(hSqlOdbc, 'SELECT ' || sSqlSel || ' INTO ' || sSqlBin || ' FROM ' || sTab)
.head 9 +  While SqlFetchNext(hSqlOdbc, nFetchRes)
.head 10 -  ! Trim + перекодировка, если нужна
.head 10 -  Set j = 0
.head 10 -  Call SalArrayGetUpperBound(CTmp, 1, nBound)
.head 10 +  While j <= nBound
.head 11 +  If SalStrLength(CTmp[j]) > 0
.head 12 -  Set CTmp[j] = SalStrTrimX(IifS(bTrans, StrDosToWinX(CTmp[j]), CTmp[j]))
.head 11 -  Set j = j + 1
.head 10 -  !
.head 10 -  ! nKp - кол-во переменных из select
.head 10 -  Set nKp = SalStrTokenize(sSqlSel, '', ',', smPer)
.head 10 -  ! nKv - кол-во бинд-переменных из into
.head 10 -  Set nKv = SalStrTokenize(sSqlBin, '', ',', smVal)
.head 10 -  Call SalArrayGetUpperBound(smVal, 1, nBound)
.head 10 -  !
.head 10 -  ! delete по условию (замена)
.head 10 +  If bDelZ
.head 11 -  ! sSqlDel - условие where для delete
.head 11 -  Set sSqlDel = ''
.head 11 +  If nKp = nKv
.head 12 -  Set nI = 0
.head 12 +  While nI < nKp
.head 13 -  ! Тип L не проверяем, он вообще никак не импортится
.head 13 +  If SalStrMidX(smVal[nI], 1, 1) != 'L'
.head 14 -  Set sSqlDel = sSqlDel || smPer[nI] ||
IifS(

   SalStrMidX(smVal[nI], 1, 1)='N' and NTmp[nI]=NUMBER_Null
or SalStrMidX(smVal[nI], 1, 1)='D' and DTmp[nI]=DATETIME_Null
or SalStrMidX(smVal[nI], 1, 1)='C' and CTmp[nI]=STRING_Null,

" is null ",

"=" ||
IifS(SalStrMidX(smVal[nI], 1, 1)='N',
     VisStrSubstitute(Str(NTmp[nI]), ",", "."),
     IifS(SalStrMidX(smVal[nI], 1, 1)='D',
          "to_date('" || SalFmtFormatDateTime(DTmp[nI],'dd/MM/yyyy') || "','dd/MM/yyyy')",
          "'" || VisStrSubstitute(CTmp[nI], "'", "''") || "'" ) )

)  || " and "
.head 13 -  Set nI = nI + 1
.head 12 -  Set sSqlDel = Left(sSqlDel, Len(sSqlDel)-5)
.head 11 -  !
.head 11 +  If sSqlDel
.head 12 -  ! -- begin: delete
.head 12 -  Set sTable   = sTab
.head 12 -  Set sSqlText = "WHERE " || sSqlDel
.head 12 -  Set sSynonym = STRING_Null
.head 12 -  Set sRole    = STRING_Null
.head 12 -  Set sGrant   = STRING_Null
.head 12 -  Set sPolicy  = STRING_Null
.head 12 +  If not SqlPLSQLCommand(hSql(), "p_make_table(4, sTable, sSqlText, sSynonym, sRole, sGrant, sPolicy)")
.head 13 -  ! Невозможно удалить записи из таблицы sTab
.head 13 -  Call SqlRollbackEx(hSql(), AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgDel') || ' ' || sTab)
.head 13 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgDel') || ' ' || sTab,
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTLoad'), MB_IconAsterisk | MB_Ok)
.head 13 -  Return FALSE
.head 12 -  ! -- end: delete
.head 10 -  !
.head 10 -  ! определяем значения values для insert
.head 10 -  Set sValues = ''
.head 10 -  Set j = 0
.head 10 +  While j <= nBound
.head 11 -  Set sValues = IifS(sValues='', "", sValues||",") ||
    IifS(SalStrMidX(smVal[j], 1, 1)='N',
         IifS(NTmp[j]=NUMBER_Null,
              "null",
              VisStrSubstitute(Str(NTmp[j]),",",".")),
         IifS(SalStrMidX(smVal[j], 1, 1)='D',
              "to_date('" || SalFmtFormatDateTime(DTmp[j],'dd/MM/yyyy') || "','dd/MM/yyyy')",
              "'" || VisStrSubstitute(CTmp[j], "'", "''") || "'"))
.head 11 -  Set j = j + 1
.head 10 -  ! -- begin: insert
.head 10 -  Set sTable   = sTab
.head 10 -  Set sSqlText = "(" || sSqlSel || ") VALUES(" || sValues || ")"
.head 10 -  Set sSynonym = STRING_Null
.head 10 -  Set sRole    = STRING_Null
.head 10 -  Set sGrant   = STRING_Null
.head 10 -  Set sPolicy  = STRING_Null
.head 10 +  If not SqlPLSQLCommand(hSql(), "p_make_table(2, sTable, sSqlText, sSynonym, sRole, sGrant, sPolicy)")
.head 11 -  ! Невозможно всавить запись в таблицу sTab
.head 11 -  Call SqlRollbackEx(hSql(), AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgIns') || " " || sTab)
.head 11 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgIns') || " " || sTab,
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTLoad'), MB_IconAsterisk | MB_Ok)
.head 11 -  Return FALSE
.head 10 -  ! -- end: insert
.head 10 -  Set i = i + nDelta
.head 10 -  Call ccProgressBar.SetProgress(i)
.head 8 -  Call SqlCommit(hSql())
.head 8 -  Call ccProgressBar.SetProgress(100)
.head 8 -  Call SqlDisconnect(hSqlOdbc)
.head 8 -  !
.head 8 -  Call SalMessageBeep(MB_IconAsterisk)
.head 8 -  ! Обработка файла завершена
.head 8 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgFileOk'),
     CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTLoad'), MB_IconAsterisk | MB_Ok)
.head 8 -  Call SaveInfoToLog(AppCode || sDbf || " - " || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsgFileOk'))
.head 8 -  Set sFile_Ret = strFile
.head 7 +  Else
.head 8 -  ! Нет доступа к базе данных: SqlDatabase
.head 8 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTErrDB') || ': ' || SqlDatabase,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_OK)
.head 8 -  Call SaveErrorToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTErrDB') || ': ' || SqlDatabase)
.head 8 -  Return FALSE
.head 6 +  Else
.head 7 -  ! Не удалось открыть файл: sDbf
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTErrFileOpen') || ': ' || sDbf,
     CurrentLangTable.GetAtomTitle('cTErr'), MB_OK)
.head 7 -  Call SaveErrorToLog(AppCode || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTErrFileOpen') || ': ' || sDbf)
.head 7 -  Return FALSE
.head 6 -  Return TRUE
.head 3 +  Function: TableExists
.head 4 -  Description: Находит таблицу по синониму или в схеме текущего ползователя
Возвращает True если таблица есть
Параметр sTabName возвращает полностью квалифицированное имя таблицы
OWNER.TABLE
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Receive String: sTabName
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nFetchRes
.head 5 -  String: sOwner
.head 5 -  String: sTable
.head 5 -  Number: nExists
.head 4 +  Actions
.head 5 +  If SqlPrepareAndExecute(hSql(), "select f_tableexists(:sTabName) into :nExists from dual")
and SqlFetchNext(hSql(), nFetchRes)
.head 6 -  Return nExists
.head 5 -  Return FALSE
.head 3 +  Function: checkForValidTableName
.head 4 -  Description: Проверить имя таблицы, которая будет создана по имени DBF файла - валидная или нет
.head 4 -  Returns
.head 4 +  Parameters
.head 5 -  String: sDBFFileName
.head 5 -  Receive String: sErrMessgae
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nChrCode
.head 4 +  Actions
.head 5 -  ! Если певый сивол  - цыфра - вылетаем
.head 5 -  Call SalStrFirstC(sDBFFileName, nChrCode)
.head 5 +  If nChrCode >= 48 and nChrCode <= 57
.head 6 -  Set sErrMessgae = CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg26')||PutCrLf()||
                  CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTMsg27')||PutCrLf()
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 -  Return TRUE
.head 2 +  Window Parameters
.head 3 -  Number: nMode	! Особенности обработки табл в БД :
        NUMBER_Null или 0 - по-старому,
        1 - без DROP таблицы в БД
        2 - по-новому (ПРАВЭКС - без public synonym, со справочником допустимых таблиц для импорта)
.head 3 -  Number: nPar2	! Резерв
.head 3 -  String: sFn	! Маска файлов
.head 3 -  Receive String: sFile_Ret	! Имя обработанного файла
.head 2 +  Window Variables
.head 3 -  String: AppCode
.head 3 -  Number: nIndex
.head 3 -  String: strFilters[2]
.head 3 -  String: strFile
.head 3 -  Boolean: fOpen
.head 3 -  String: tmp01
.head 3 -  String: tmp02
.head 3 -  String: tmp03
.head 3 -  String: tmp04
.head 3 -  !
.head 3 -  Number: hBtnDelNew
.head 3 -  Number: hBtnNoDelNew
.head 3 -  Number: hBtnNoDelPlusNew1
.head 3 -  Number: hBtnNoDelPlusNew2
.head 3 -  Number: hBtnNo
.head 3 -  Number: hBtns[*]
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalSendMsgToChildren( hWndForm, UM_QueryLabelText, 0, 0 )
.head 4 -  ! Загрузка файла sFn
.head 4 -  Call SalSetWindowText(hWndForm, CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTWndTitle'))
.head 4 -  Call PrepareWindowEx(hWndForm)
.head 4 -  Set AppCode = "IMPDBF. "
.head 4 -  Set dfPath = sFn
.head 4 -  Set strFilters[0] = 'Data Base Files (*.dbf)'
.head 4 -  Set strFilters[1] = sFn||'*.dbf'
.head 4 -  Call WaitCursorOn()
.head 3 +  On SAM_CreateComplete
.head 4 -  ! '&0.НОВАЯ'
.head 4 +  If nMode = 0 or nMode = 2
.head 5 -  Set hBtnDelNew = VisMessageLoadButton('&0.' || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnDelNew'), 0)
.head 4 +  Else
.head 5 -  Set hBtnDelNew = VisMessageLoadButton('', 0)
.head 4 -  ! '&1.ЗАМЕНА'
.head 4 -  Set hBtnNoDelNew = VisMessageLoadButton('&1.' || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelNew'), 1)
.head 4 -  ! '&2.ОТКАЗ'
.head 4 -  Set hBtnNo = VisMessageLoadButton('&2.' || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNo'), 2)
.head 4 -  ! '&3.НОВЫЕ ДАННЫЕ'
.head 4 -  Set hBtnNoDelPlusNew1 = VisMessageLoadButton('&3.' || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew1'), 3)
.head 4 -  ! '&4.ДОБАВИТЬ'
.head 4 -  Set hBtnNoDelPlusNew2 = VisMessageLoadButton('&4.' || CurrentLangTable.GetAtomTitle('dlg_LoadDbf.cTBtnNoDelPlusNew2'), 4)
.head 4 -  Call WaitCursorOff()
.head 3 +  On SAM_Destroy
.head 4 -  Call VisMessageFreeButton(hBtnDelNew)
.head 4 -  Call VisMessageFreeButton(hBtnNoDelNew)
.head 4 -  Call VisMessageFreeButton(hBtnNoDelPlusNew1)
.head 4 -  Call VisMessageFreeButton(hBtnNoDelPlusNew2)
.head 4 -  Call VisMessageFreeButton(hBtnNo)
.head 4 -  ! Disactivation of function's role, which activated for calling window
.head 4 +  If SalStrTrimX(SalStrUpperX(GetDBMS())) = 'ORACLE'
.head 5 -  Call XRoleUnset(hSql(), 'Imp_KL_NBU(hWndMDI)')
.head 4 -  Call WaitCursorOff()
.head 1 -  !
.head 1 +  Dialog Box: dlg_LoadDPAList
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Прием файла @U [Контрагенты на контроле НИ]
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   1.738"
.head 4 -  Top:    1.188"
.head 4 -  Width:  7.229"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 2.238"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Обработка файла подозрительных контрагентов НИ
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? No
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Frame
.head 4 -  Resource Id: 29253
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.086"
.head 5 -  Top:    0.052"
.head 5 -  Width:  6.957"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.476"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Data Field: dfPath
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.171"
.head 6 -  Top:    0.156"
.head 6 -  Width:  5.186"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Pushbutton: pbChoose
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выбрать...
.head 4 -  Window Location and Size
.head 5 -  Left:   5.486"
.head 5 -  Top:    0.135"
.head 5 -  Width:  1.429"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.292"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: None
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalDlgOpenFile ( hWndForm, 'Выбрать файл...', strFilters, 2, nIndex, strFile, dfPath )
.head 6 +  If SalStrUpperX( SalStrLeftX( strFile, 2 )) != '@U'
.head 7 -  Call SalMessageBeep ( MB_IconStop )
.head 7 -  Call SalMessageBox( 'Неверное имя файла!', 'Ошибка!', MB_Ok )
.head 7 -  Set dfPath = ''
.head 3 -  Frame
.head 4 -  Resource Id: 29254
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.086"
.head 5 -  Top:    0.607"
.head 5 -  Width:  6.957"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.531"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Custom Control: ccProgressBar
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cMeter
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   0.143"
.head 6 -  Top:    0.726"
.head 6 -  Width:  6.783"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 0.281"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Dark Blue
.head 5 -  Background Color: 3D Face Color
.head 5 -  DLL Settings
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SalSetFocus( hWndItem )
.head 3 -  !
.head 3 +  Pushbutton: pbRun
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbExecute
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выполнить
.head 4 -  Window Location and Size
.head 5 -  Left:   1.317"
.head 5 -  Top:    1.298"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Yes
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If dfPath = STRING_Null OR dfPath = ''
.head 7 +  If SalDlgOpenFile ( hWndForm,'Выбрать файл...', strFilters, 2, nIndex, strFile, dfPath )
.head 8 +  If SalStrUpperX( SalStrLeftX( strFile, 2 )) != '@U'
.head 9 -  Call SalMessageBeep ( MB_IconStop )
.head 9 -  Call SalMessageBox( 'Неверное имя файла!', 'Ошибка!', MB_Ok )
.head 9 -  Set dfPath = ''
.head 9 -  Return FALSE
.head 8 -  Call SalMessageBox(strFile, dfPath, MB_OK)
.head 8 -  Call SalSetWindowText( hWndForm, 'Прием файла ' || dfPath)
.head 8 -  Call FunImportDPAList( dfPath )
.head 6 +  Else
.head 7 -  Call FunImportDPAList( dfPath )
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   4.15"
.head 5 -  Top:    1.298"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog( hWndForm, 0 )
.head 2 +  Functions
.head 3 +  Function: FunImportDPAList
.head 4 -  Description: Собственно импорт файла @U
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: strFilePath
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  File Handle: hF
.head 5 -  String: strBuffer
.head 5 -  !
.head 5 -  String: strHFName
.head 5 -  String: strHMfo
.head 5 -  Number: nHLines
.head 5 -  Boolean: fProcError
.head 5 -  !
.head 5 -  Number: nIterator
.head 5 -  String: strOKPO
.head 5 -  Number: nTgr
.head 5 -  Number: nAct
.head 5 -  Number: nObl
.head 4 +  Actions
.head 5 +  If NOT SalFileOpen( hF, strFilePath, OF_Read | OF_Text )
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Невозможно открыть файл ' || strFilePath )
.head 6 -  Call SalMessageBox( 'Невозможно открыть файл ' || strFilePath, 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Return FALSE
.head 5 -  ! Проверить структуру файла
.head 5 +  If NOT SalFileGetStr( hF, strBuffer, 10240 )
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( '(SLine) Ошибка чтения из файла ' || strFilePath )
.head 6 -  Call SalMessageBox( '(SLine) Ошибка чтения из файла ' || strFilePath, 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 +  If strBuffer != SalStrRepeatX( ' ', 100 )
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Нарушение структуры файла! (Service Line)' )
.head 6 -  Call SalMessageBox( 'Нарушение структуры файла! (Service Line)', 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 +  If NOT SalFileGetStr( hF, strBuffer, 10240 )
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( '(Header) Ошибка чтения из файла ' || strFilePath )
.head 6 -  Call SalMessageBox( '(Header) Ошибка чтения из файла ' || strFilePath, 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 +  If SalStrLength( strBuffer ) < 60
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Нарушение структуры файла! (Header Line)' )
.head 6 -  Call SalMessageBox( 'Нарушение структуры файла! (Header Line)', 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 -  ! -
.head 5 -  Set strHFName = SalStrUpperX( SalStrLeftX( strBuffer, 12 ))
.head 5 -  Set nHLines   = SalStrToNumber( SalStrMidX( strBuffer, 22, 6 ))
.head 5 -  Set strHMfo   = SalStrMidX( strBuffer, 54, 6 )
.head 5 +  If strHFName != SalStrUpperX( SalStrRightX( strFilePath, 12 ))
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Несовпадение имени файла с именем в заголовке! (Header Line)' )
.head 6 -  Call SalMessageBox( 'Несовпадение имени файла с именем в заголовке! (Header Line)', 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 +  If nHLines <= 0
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Нет детальных строк! ' || strFilePath )
.head 6 -  Call SalMessageBox( 'Нет детальных строк!', 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 +  If strHMfo != GetBankMfo(  )
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Файл не для нашего МФО! ' || strFilePath )
.head 6 -  Call SalMessageBox( 'Файл не для нашего МФО!', 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Call SalFileClose( hF )
.head 6 -  Return FALSE
.head 5 -  !
.head 5 -  Set nIterator = 1
.head 5 +  While nIterator <= nHLines
.head 6 +  If NOT SalFileGetStr( hF, strBuffer, 10240 )
.head 7 -  Call SalMessageBeep( MB_IconStop )
.head 7 -  Call SaveErrorToLog( '(Line) Ошибка чтения из файла ' || strFilePath )
.head 7 -  Call SalMessageBox( '(Line) Ошибка чтения из файла ' || strFilePath, 'Ошибка!', MB_IconStop | MB_Ok )
.head 7 -  Call SalFileClose( hF )
.head 7 -  Return FALSE
.head 6 -  Set strOKPO = SalStrTrimX( SalStrLeftX( strBuffer, 14 ))
.head 6 -  Set nTgr    = SalStrToNumber( SalStrMidX( strBuffer, 14, 1 ))
.head 6 -  Set nAct    = SalStrToNumber( SalStrMidX( strBuffer, 15, 1 ))
.head 6 -  Set nObl    = SalStrToNumber( SalStrMidX( strBuffer, 16, 2 ))
.head 6 +  Select Case nAct
.head 7 +  Case 1		! Добавить контрагента
.head 8 +  If NOT SqlPrepareAndExecute( hSql(), 'INSERT INTO list_dpa (kod, dat_vkl, c_reg) VALUES (:strOKPO, bankdate, :nObl)')
.head 9 -  Set fProcError = TRUE
.head 8 -  Call SqlPrepareAndExecute( hSql(), T( 'UPDATE list_dpa l SET (l.rnk,l.nmk)=(SELECT c.rnk, c.nmk FROM customer WHERE TRIM( c.okpo ) = TRIM( l.kod ))' ))
.head 8 -  Break
.head 7 +  Case 2		! Удалить  контрагента
.head 8 +  If NOT SqlPrepareAndExecute( hSql(), 'DELETE FROM list_dpa WHERE kod=:strOKPO' )
.head 9 -  Set fProcError = TRUE
.head 8 -  Break
.head 7 +  Default
.head 8 -  Break
.head 6 +  If fProcError
.head 7 -  Break
.head 6 -  Call ccProgressBar.SetProgress( nIterator / nHLines )
.head 6 -  Set nIterator = nIterator + 1
.head 5 -  Call SalFileClose( hF )
.head 5 +  If fProcError
.head 6 -  Call ccProgressBar.SetProgress( 0 )
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Файла ' || strFilePath || 'не обработан!')
.head 6 -  Call SalMessageBox( 'Ошибка обработки файла ' || strFilePath, 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 -  Call SqlCommitEx( hSql(), 'Обработка файла ' || strFilePath || ' закончена' )
.head 6 -  Call FunBackUpFile( strFilePath, strBackup, TRUE )
.head 6 -  Return TRUE
.head 2 -  Window Parameters
.head 2 +  Window Variables
.head 3 -  Number: nIndex
.head 3 -  String: strFilters[2]
.head 3 -  String: strFile
.head 3 -  !
.head 3 -  String: strInbound
.head 3 -  String: strBackup
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call PrepareWindowEx( hWndForm )
.head 4 -  !
.head 4 -  Call SalUseRegistry( FALSE, '' )
.head 4 -  Call SalGetProfileString( INI_Directory, 'BackupDir',   GetPrnDir(), strBackup,  GetIniFileName() )
.head 4 -  Call SalGetProfileString( INI_Directory, 'TicketsDir',  GetPrnDir(), strInbound, GetIniFileName() )
.head 4 -  !
.head 4 -  Set dfPath = strInbound || '\\'
.head 4 -  Set strFilters[0]='Список контрагентов для НИ (@U*.*)'
.head 4 -  Set strFilters[1]='*.*'
.head 4 -  Call WaitCursorOn()
.head 3 +  On SAM_CreateComplete
.head 4 -  Call WaitCursorOff()
.head 1 -  !
.head 1 +  Form Window: frm_FilesNbu
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Отчетность
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Yes
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Yes
.head 3 -  Minimizable? Yes
.head 3 -  System Menu? Yes
.head 3 -  Resizable? Yes
.head 3 -  Window Location and Size
.head 4 -  Left:   0.81"
.head 4 -  Top:    0.675"
.head 4 -  Width:  11.333"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 6.202"
.head 4 -  Height Editable? Yes
.head 3 -  Form Size
.head 4 -  Width:  Default
.head 4 -  Height: Default
.head 4 -  Number of Pages: Dynamic
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Формирование файлов отчетности для НБУ
.head 2 +  Named Menus
.head 3 +  Menu: menuNBURep
.head 4 -  Resource Id: 50932
.head 4 -  Title: Отчетность НБУ
.head 4 -  Description:
.head 4 -  Enabled when:
.head 4 -  Status Text:
.head 4 -  Menu Item Name:
.head 4 +  Menu Item: Задать &дату...
.head 5 -  Resource Id: 50460
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSetFocus( hWndForm.frm_FilesNbu.calReportDate )
.head 5 -  Menu Item Name:
.head 4 +  Menu Item: Выбрать &отчет...
.head 5 -  Resource Id: 50461
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg(hWndForm.frm_FilesNbu.pbGetReport, SAM_Click, 0, 0) 
.head 5 -  Menu Item Name:
.head 4 -  Menu Separator
.head 4 +  Menu Item: &Сформировать
.head 5 -  Resource Id: 50462
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when: fRepNumSet
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg(hWndForm.frm_FilesNbu.pbExecute, SAM_Click, 0, 0) 
.head 5 -  Menu Item Name:
.head 4 +  Menu Item: Создать &файл отчета
.head 5 -  Resource Id: 50463
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when: fRepPopulate
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg(hWndForm.frm_FilesNbu.pbFileStamp, SAM_Click, 0, 0) 
.head 5 -  Menu Item Name:
.head 4 +  Popup Menu: &Экспорт
.head 5 -  Resource Id: 50464
.head 5 -  Enabled when: fRepPopulate
.head 5 -  Status Text:
.head 5 -  Menu Item Name:
.head 5 +  Menu Item: В файл (*.txt, *.xls, *.doc)
.head 6 -  Resource Id: 50465
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text:
.head 6 +  Menu Settings
.head 7 -  Enabled when: fRepPopulate
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Call SalSendMsg(hWndForm.frm_FilesNbu.pbDetPrint, SAM_Click, 0, 0)
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: В dbf-файл
.head 6 -  Resource Id: 50466
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text:
.head 6 +  Menu Settings
.head 7 -  Enabled when: fRepPopulate
.head 7 -  Checked when:
.head 6 -  Menu Actions
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: В текстовый файл с разделителями
.head 6 -  Resource Id: 50467
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text:
.head 6 +  Menu Settings
.head 7 -  Enabled when: fRepPopulate
.head 7 -  Checked when:
.head 6 -  Menu Actions
.head 6 -  Menu Item Name:
.head 4 -  Menu Separator
.head 4 +  Menu Item: &Добавить строку
.head 5 -  Resource Id: 50468
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when: fRepPopulate
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg( hWndForm.frm_FilesNbu.pbInsert, SAM_Click, 0, 0)
.head 5 -  Menu Item Name:
.head 4 +  Menu Item: &Удалить строку
.head 5 -  Resource Id: 50469
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when: fRepPopulate
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg(hWndForm.frm_FilesNbu.pbDelete, SAM_Click, 0, 0)
.head 5 -  Menu Item Name:
.head 4 +  Menu Item: Со&хранить изменения
.head 5 -  Resource Id: 50470
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when: fRepPopulate AND SalIsWindowEnabled( pbUpdate )
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalSendMsg(hWndForm.frm_FilesNbu.pbUpdate, SAM_Click, 0, 0)
.head 5 -  Menu Item Name:
.head 4 -  Menu Separator
.head 4 +  Menu Item: В&ыход
.head 5 -  Resource Id: 50459
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalPostMsg(hWndForm.frm_FilesNbu.pbExit, SAM_Click, 0, 0)
.head 5 -  Menu Item Name:
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? No
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Frame
.head 4 -  Resource Id: 37424
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.0"
.head 5 -  Top:    0.0"
.head 5 -  Width:  10.157"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.427"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 -  Background Text: Дата звіту
.head 4 -  Resource Id: 37425
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   -0.017"
.head 5 -  Top:    0.125"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Right
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Custom Control: calReportDate
.data CLASSPROPSSIZE
0000: 4200
.enddata
.data CLASSPROPS
0000: 56543A43616C656E 646172436F6D626F 426F78002B000100 0000010101010001
0020: 0200000001010101 0101000000000000 01000000000A6464 2F4D4D2F79797979
0040: 0000
.enddata
.data INHERITPROPS
0000: 0100
.enddata
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cCalendarDropDown
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   1.483"
.head 6 -  Top:    0.094"
.head 6 -  Width:  1.567"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  DLL Settings
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call GetMonthArray( strMonth )
.head 6 -  Call GetWeekDayArray( strWeekDays )
.head 6 -  Call calReportDate.SetMonthText( strMonth )
.head 6 -  Call calReportDate.SetWeekDayText( strWeekDays )
.head 5 +  On SAM_CustControlCmd
.head 6 +  If wParam = 2
.head 7 +  If fRepPopulate
.head 8 -  Call SalMessageBeep(MB_IconQuestion)
.head 8 +  If SalMessageBox('Сформувати звіт за іншу дату?', 'Увага!', MB_IconQuestion | MB_YesNo) = IDNO
.head 9 -  Call SalSetWindowText(calReportDate, SalFmtFormatDateTime(SalFmtFormatStrDateTime(sDatMDY, 'MM/dd/yyyy'), 'dd/MM/yyyy'))
.head 9 -  Return FALSE
.head 7 -  Call SalWaitCursor(FALSE)
.head 7 -  Call SalGetWindowText(calReportDate, sDatF, 10)
.head 7 -  Set dDatF = SalFmtFormatStrDateTime(sDatF, 'dd/MM/yyyy')
.head 7 -  Set sDatMDY = SalFmtFormatDateTime(dDatF, 'MM/dd/yyyy')
.head 7 -  Set strTblPop = ''
.head 7 -  Set fRepPopulate = FALSE
.head 7 +  If fRepNumSet
.head 8 +  If FunMakeColSetNSQLStr(Rep_Code, dDatF, nNumColInPKey, strTblPop, SalStrTrimX(Rep_ProcName)='', FALSE)
.head 9 -  ! Call SalEnableWindow(pbExecute)
.head 9 -  ! Call SalWaitCursor(TRUE)
.head 9 -  Call SalSendMsg(tblDta, SAM_User, 0, 0)
.head 6 -  Call SalWaitCursor(FALSE)
.head 5 +  On UM_NoFontChange
.head 6 -  Return TRUE
.head 3 +  Pushbutton: pbGetReport
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbPlainButton
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Звіт...
.head 4 -  Window Location and Size
.head 5 -  Left:   3.143"
.head 5 -  Top:    0.083"
.head 5 -  Width:  1.286"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If uf_get_report(strF00Table, dfRepNum, Rep_GCode, dfRepSemantic, nRunMode)
.head 7 -  Set Rep_Code  = SalStrTrimX(dfRepNum)
.head 7 -  Set Rep_GCode = SalStrTrimX(Rep_GCode)
.head 7 -  !
.head 7 -  Set sSqlTxt = T(
"SELECT uuu, aa, zzz, nn, path_o, period, datf,nvl(nom,'z'), r, kodf_ext, 
        p.name, f_pref, type_znap, prock, " || IifS(nRunMode=0, "pr_tobo ","null ") || 
"  INTO :Rep_EBox, :Rep_GNum, :Rep_MFO, :Rep_Msrm, :Rep_Path,
        :Rep_Period, :Rep_LDate, :sRep_CQNum, :Rep_Resident, :Rep_CodeExt, 
        :Rep_ProcName, :Rep_FPrefix, :Rep_TypeZnap, :Rep_ProcK, :Rep_PrTobo 
   FROM " || strF00Table || " k, rep_proc p
  WHERE k.procc = p.procc AND trim(kodf) = :Rep_Code AND a017 = :Rep_GCode")
.head 7 +  If SqlPrepareAndExecute(C.hSql(), sSqlTxt)
.head 8 -  Call SqlFetchNext(C.hSql(), nFetchRes)
.head 7 -  !
.head 7 -  !
.head 7 +  If Rep_PrTobo != NUMBER_Null
.head 8 -  Set flag_tpf_OTCN = FALSE
.head 8 -  Set sSqlTxt = T("select val INTO :tpf_OTCN from params where par='TPF_OTCN'")
.head 8 +  If SqlPrepareAndExecute(C.hSql(), sSqlTxt)
.head 9 -  Call SqlFetchNext(C.hSql(), nFetchRes)
.head 9 +  If tpf_OTCN != STRING_Null
.head 10 -  Set sSqlTxt = T("select 1 INTO :flag_tpf_OTCN from dual where :Rep_PrTobo  in ("||tpf_OTCN||")")
.head 10 +  If SqlPrepareAndExecute(C.hSql(), sSqlTxt)
.head 11 -  Call SqlFetchNext(C.hSql(), nFetchRes)
.head 8 +  Else
.head 9 -  Set flag_tpf_OTCN = FALSE
.head 7 -  Set sCQNumTmp = sRep_CQNum
.head 7 -  Call SalStrFirstC(sCQNumTmp,nCharNum)
.head 7 +  If nCharNum >= 48 AND nCharNum <=57
.head 8 -  Set Rep_CQNum = nCharNum-48
.head 7 +  Else If nCharNum >= 97 
.head 8 -  Set Rep_CQNum = nCharNum-87
.head 7 -  ! Call DebugN(Rep_CQNum)
.head 7 -  ! Call Debug(sRep_CQNum)
.head 7 -  Set Rep_CQNum = Rep_CQNum + 1
.head 7 +  If SalFmtFormatDateTime(Rep_LDate, 'dd/MM/yyyy') != SalFmtFormatDateTime(SalDateCurrent(), 'dd/MM/yyyy')
.head 8 -  Set Rep_CQNum = 1
.head 8 -  Set sRep_CQNum = SalNumberToChar(49)
.head 7 +  Else
.head 8 +  If Rep_CQNum = NUMBER_Null OR Rep_CQNum > 35
.head 9 -  Set Rep_CQNum = 1
.head 9 -  Set sRep_CQNum = SalNumberToChar(49)
.head 8 +  Else If Rep_CQNum > 9 AND Rep_CQNum<=35
.head 9 -  Set sRep_CQNum = SalNumberToChar(87+Rep_CQNum)
.head 8 +  Else
.head 9 -  Set sRep_CQNum=SalNumberToChar(48+Rep_CQNum)
.head 8 -  ! Set Rep_CQNum = Rep_CQNum + 1
.head 7 -  Set fRepPopulate = FALSE
.head 7 -  !
.head 7 -  Set strTblPop  = ''
.head 7 -  Set fRepNumSet = TRUE
.head 7 +  If FunMakeColSetNSQLStr(Rep_Code, dDatF, nNumColInPKey, strTblPop, SalStrTrimX(Rep_ProcName)='' , TRUE)
.head 8 -  ! Call SalEnableWindow(pbExecute)
.head 8 -  ! Кнопки
.head 8 -  ! Call SalEnableWindow(pbDetPrint)
.head 8 -  ! Call SalEnableWindow(pbFileStamp)
.head 8 -  ! Call SalEnableWindow(pbInsert)
.head 8 -  ! Call SalEnableWindow(pbDelete)
.head 8 -  ! Call SalDisableWindow(pbProtocol)
.head 8 +  ! If obCommonReport
.head 9 -     Call SalEnableWindow(pbExists)
.head 9 -     Call SalEnableWindow(pbImport)
.head 8 +  ! Else
.head 9 -     Call SalDisableWindow(pbExists)
.head 9 -     Call SalDisableWindow(pbImport)
.head 9 -     Call SalEnableWindow(pbUpdate)
.head 8 +  ! If Rep_ProcK
.head 9 -     Call SalEnableWindow(pbCheckOnProck)
.head 8 +  ! Else
.head 9 -     Call SalDisableWindow(pbCheckOnProck)
.head 8 -  Call SalSendMsg(tblDta, SAM_User, 0, 0)
.head 3 +  Data Field: dfRepNum
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   4.514"
.head 6 -  Top:    0.083"
.head 6 -  Width:  0.6"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Data Field: dfRepSemantic
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   5.157"
.head 6 -  Top:    0.083"
.head 6 -  Width:  4.729"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 -  Frame
.head 4 -  Resource Id: 37426
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.0"
.head 5 -  Top:    0.405"
.head 5 -  Width:  10.157"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.427"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pb_XML
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbSwitch
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   5.05"
.head 5 -  Top:    0.452"
.head 5 -  Width:  0.43"
.head 5 -  Width Editable? No
.head 5 -  Height: 0.317"
.head 5 -  Height Editable? No
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: None
.head 4 -  Picture File Name: D:\BARS98\RESOURCE\BMP\xml_file.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  ! Сформувати XML файл
.head 6 -  Set strTip = CurrentLangTable.GetAtomTitle('frm_FilesNbu.pb_XML')
.head 5 +  On SAM_Click
.head 6 -  If SalMessageBox(CurrentLangTable.GetAtomTitle('frm_FilesNbu.CreateXmlQuestion'), 
                 CurrentLangTable.GetAtomTitle('cTAt'), 
                 MB_IconQuestion|MB_YesNo) = IDYES
.head 6 -  Call SalWaitCursor(TRUE)
.head 6 -  ! ! Створення файлу
.head 6 -  Set strFileName = Rep_Path || '\\' || dfRepNum ||'X.xml'
.head 6 +  If not SalFileOpen( hFile, strFileName, OF_Create | OF_ReadWrite)
.head 7 -  Call SalWaitCursor(FALSE)
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('frm_FilesNbu.OpenFileFailed')||" "||strFileName||"!",
                   CurrentLangTable.GetAtomTitle('cTErr'),
                   MB_IconStop)
.head 6 +  Else
.head 7 -  Call SqlSetLongBindDatatype( 1, 22 )
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute( hSql(),
"SELECT column_value 
   INTO :sXmlRow
   FROM table (BARS.F_NBU_RPT_XML_ROW( :Rep_Code, :dDatF ))" )
.head 8 +  While SqlFetchNext( hSql(), nFetchRes )
.head 9 -  ! SalFilePutStr( hFile, sXmlRow )
.head 9 -  Set sXmlRow = sXmlRow || PutCrLf()
.head 9 -  Call SalFileWrite( hFile, sXmlRow, SalStrLength(sXmlRow) )
.head 7 -  Call SalFileClose(hFile)
.head 7 -  Call SalWaitCursor(FALSE)
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('frm_FilesNbu.CreateFileDone')||" "||strFileName||"!",
                   CurrentLangTable.GetAtomTitle('cTAt'),
                   MB_IconInformation)
.head 3 -  Line
.head 4 -  Resource Id: 18980
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Coordinates
.head 5 -  Begin X:  5.75"
.head 5 -  Begin Y:  0.405"
.head 5 -  End X:  5.75"
.head 5 -  End Y:  0.81"
.head 4 -  Visible? Yes
.head 4 -  Line Style: Etched
.head 4 -  Line Thickness: 1
.head 4 -  Line Color: 3D Shadow Color
.head 3 -  Line
.head 4 -  Resource Id: 18982
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Coordinates
.head 5 -  Begin X:  8.2"
.head 5 -  Begin Y:  0.405"
.head 5 -  End X:  8.2"
.head 5 -  End Y:  0.81"
.head 4 -  Visible? Yes
.head 4 -  Line Style: Etched
.head 4 -  Line Thickness: 1
.head 4 -  Line Color: 3D Shadow Color
.head 3 -  Line
.head 4 -  Resource Id: 60075
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Coordinates
.head 5 -  Begin X:  6.233"
.head 5 -  Begin Y:  0.405"
.head 5 -  End X:  6.233"
.head 5 -  End Y:  0.81"
.head 4 -  Visible? Yes
.head 4 -  Line Style: Etched
.head 4 -  Line Thickness: 1
.head 4 -  Line Color: 3D Shadow Color
.head 3 -  Line
.head 4 -  Resource Id: 18981
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Coordinates
.head 5 -  Begin X:  4.033"
.head 5 -  Begin Y:  0.405"
.head 5 -  End X:  4.033"
.head 5 -  End Y:  0.81"
.head 4 -  Visible? Yes
.head 4 -  Line Style: Etched
.head 4 -  Line Thickness: 1
.head 4 -  Line Color: 3D Shadow Color
.head 3 -  Line
.head 4 -  Resource Id: 18979
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Coordinates
.head 5 -  Begin X:  2.5"
.head 5 -  Begin Y:  0.405"
.head 5 -  End X:  2.5"
.head 5 -  End Y:  0.81"
.head 4 -  Visible? Yes
.head 4 -  Line Style: Etched
.head 4 -  Line Thickness: 1
.head 4 -  Line Color: 3D Shadow Color
.head 3 +  Option Button: obPersonalReport	! Власний звіт
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.114"
.head 5 -  Top:    0.458"
.head 5 -  Width:  0.429"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.313"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Rep_solo.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Button Style: Radio
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_TooltipSetText
.head 6 -  Return XSalTooltipSetText( lParam, 'Власний звіт' )
.head 5 +  On UM_NoFontChange
.head 6 -  Return TRUE
.head 5 +  On SAM_Click
.head 6 +  If fRepNumSet
.head 7 -  Set fRepPopulate = FALSE
.head 7 -  ! Call SalDisableWindow( pbExists )
.head 7 -  ! Call SalDisableWindow( pbImport )
.head 7 -  ! Call SalEnableWindow( pbInsert )
.head 7 -  ! Call SalEnableWindow( pbDelete )
.head 7 -  ! Call SalEnableWindow( pbUpdate )
.head 7 +  If FunMakeColSetNSQLStr( Rep_Code, dDatF, nNumColInPKey, strTblPop, SalStrTrimX(Rep_ProcName)='', FALSE )
.head 8 -  ! Call SalEnableWindow( pbExecute )
.head 3 +  Option Button: obCommonReport	! Консолідований звіт
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.557"
.head 5 -  Top:    0.458"
.head 5 -  Width:  0.429"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.313"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Rep_join.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Button Style: Radio
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_TooltipSetText
.head 6 -  Return XSalTooltipSetText( lParam, 'Консолідований звіт' )
.head 5 +  On UM_NoFontChange
.head 6 -  Return TRUE
.head 5 +  On SAM_Click
.head 6 +  If fRepNumSet
.head 7 -  Set fRepPopulate = FALSE
.head 7 -  ! Call SalEnableWindow( pbExists )
.head 7 -  ! Call SalEnableWindow( pbImport )
.head 7 -  ! Call SalDisableWindow( pbInsert )
.head 7 -  ! Call SalDisableWindow( pbDelete )
.head 7 -  ! Call SalDisableWindow( pbUpdate )
.head 7 +  If FunMakeColSetNSQLStr( Rep_Code, dDatF, nNumColInPKey, strTblPop, SalStrTrimX(Rep_ProcName)='', FALSE )
.head 8 -  ! Call SalEnableWindow( pbExecute )
.head 3 +  Pushbutton: pbArchive		! Вибрати файл з архіву
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbBrowse
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.983"
.head 5 -  Top:    0.458"
.head 5 -  Width:  0.429"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.313"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \bars98\RESOURCE\BMP\Books.bmp
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Вибрати файл з архіву'
.head 5 +  On SAM_Click
.head 6 -  Call SalHideWindow(hColWndFlMod)
.head 6 +  If SalModalDialog(dlg_Archive, hWndForm, nRunMode, Rep_Code, dtLastRepDate)
.head 7 -  Set dDatF = dtLastRepDate
.head 7 -  Call SalSetWindowText(calReportDate, SalFmtFormatDateTime(dDatF, 'dd/MM/yyyy'))
.head 7 +  If FunMakeColSetNSQLStr(Rep_Code, dDatF, nNumColInPKey, strTblPop, SalStrTrimX(Rep_ProcName)='', FALSE)
.head 8 -  Call SalSendMsg(tblDta, SAM_User, 0, 0)
.head 8 +  If obPersonalReport
.head 9 -  ! Call SalShowWindow(hColWndFlMod)
.head 6 +  Else
.head 7 -  Call checkFlagBlk(Rep_Code, dDatF)
.head 3 +  Pushbutton: pbExecute	! Наповнити таблицю даними для звіту
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbExecute
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   1.55"
.head 5 -  Top:    0.458"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Наповнити таблицю даними для звіту'
.head 5 +  On SAM_Click
.head 6 -  Call SalHideWindow(hColWndErrMsg)
.head 6 -  Call SalHideWindow(hColWndFlMod)
.head 6 +  If bPROTCN and obCommonReport
.head 7 +  If not SqlPrepareAndExecute(hSql(),
"select count(*) into :nCount
   from v_branch v
  where not exists (SELECT 1 FROM rnbu_in_files r
        WHERE v.mfo=r.mfo AND 
        r.file_name like '#" || Rep_Code || "%' AND 
        r.last_date = '" || SalStrMidX( sDatMDY, 3, 2 ) || SalStrLeftX( sDatMDY, 2) || SalStrRightX( sDatMDY, 4 ) || "')")
.head 8 -  Return FALSE
.head 7 +  If not SqlFetchNext(hSql(), nFetchRes)
.head 8 -  Return FALSE
.head 7 +  If nCount > 0
.head 8 -  Call SalMessageBox("Не всі файли філій завантажені! ", "Увага!", MB_IconStop)
.head 8 -  Return FALSE
.head 6 +  If ( chkBnkDt( dDatF ) ) ! Заборона формувати за дати після переходу на новий план рахункуів НБУ
.head 7 +  If SalStrTrimX(Rep_ProcName) = '' OR SalMessageBox('Виконати формування?', 'Фомування звітів', MB_OkCancel) = IDOK
.head 8 -  Call SalWaitCursor(TRUE)
.head 8 -  Set fRepPopulate = TRUE
.head 8 -  Call SqlPrepareAndExecute(C.hSql(), 'DELETE FROM ' || strTRCTable || ' WHERE userid = user_id')
.head 8 -  Call SqlCommit(C.hSql())
.head 8 -  ! Проверим, ассоциирована ли процедура формирования отчета к форме
.head 8 +  If SalStrTrimX(Rep_ProcName) != ''
.head 9 -  ! Проверим, а есть ли уже готовые данные...
.head 9 -  Set nRow = 0
.head 9 -  Set fNeedToReform = TRUE
.head 9 -  Call SqlPrepareAndExecute(C.hSql(), 'SELECT count(*) INTO :nRow FROM ' || strTMPTable || ' WHERE kodf = :Rep_Code AND datf = :dDatF')
.head 9 -  Call SqlFetchNext(C.hSql(), nFetchRes)
.head 9 +  If obPersonalReport
.head 10 +  If nRow > 0
.head 11 +  If SalMessageBox('Переформувати звіт?', 'Увага!', MB_IconQuestion | MB_YesNo ) = IDNO
.head 12 -  Set fNeedToReform = FALSE
.head 9 +  Else
.head 10 -  Set fNeedToReform = FALSE
.head 9 +  If fNeedToReform
.head 10 -  Call F_otcn(SalStrTrimX(SalStrLowerX(Rep_ProcName)), sDatMDY)
.head 10 +  If SqlPrepareAndExecute(C.hSql(), 'UPDATE ' || strTMPTable || ' SET nbuc = DECODE(nbuc,null,:Rep_MFO,0,:Rep_MFO,nbuc) WHERE kodf = :Rep_Code AND datf = :dDatF')
.head 11 -  Call SqlCommit(C.hSql())
.head 10 +  Else
.head 11 -  Call SqlRollback(C.hSql())
.head 10 +  If SqlPrepareAndExecute( C.hSql(), 'UPDATE rnbu_trace SET nbuc = DECODE(nbuc,null,:Rep_MFO,0,:Rep_MFO,nbuc) WHERE userid  = user_id')
.head 11 -  Call SqlCommit(C.hSql())
.head 10 +  Else
.head 11 -  Call SqlRollback(C.hSql())
.head 8 -  ! Случай ручного формирования
.head 8 +  Else
.head 9 +  If obCommonReport
.head 10 +  If SqlPrepareAndExecute(C.hSql(), 'SELECT max(datf) INTO :dtLastRepDate FROM ' || strTMPTable || ' WHERE kodf = :Rep_Code AND datf <= :dDatF')
.head 11 -  Call SqlFetchNext(C.hSql(), nFetchRes)
.head 10 +  If dtLastRepDate
.head 11 -  Call FunMakeColSetNSQLStr(Rep_Code, dtLastRepDate, nNumColInPKey, strTblPop, SalStrTrimX(Rep_ProcName)='', FALSE)
.head 9 +  Else
.head 10 +  If not SalModalDialog(dlg_SetDatZ, hWndForm, dDatZ)
.head 11 -  Return FALSE
.head 10 -  Call SalWaitCursor(TRUE)
.head 10 +  If not SqlPLSQLCommand(hSql(), "p_f00(dDatF, dDatZ, Rep_Code)")
.head 11 -  Call SqlRollback(hSql())
.head 10 +  Else
.head 11 -  Call SqlCommit(hSql())
.head 10 -  Call SalWaitCursor(FALSE)
.head 8 -  ! Call SalEnableWindow(pbInsert)
.head 8 -  ! Call SalEnableWindow(pbDelete)
.head 8 -  ! Call SalEnableWindow(pbDetPrint)
.head 8 -  ! Call SalEnableWindow(pbFileStamp)
.head 8 +  ! If obPersonalReport
.head 9 -     Call SalEnableWindow(pbProtocol)
.head 9 -     Call SalEnableWindow(pbUpdate)
.head 9 -     Call SalDisableWindow(pbImport)
.head 8 +  ! Else
.head 9 -     Call SalDisableWindow(pbInsert)
.head 9 -     Call SalEnableWindow(pbImport)
.head 9 -     Call SalDisableWindow(pbDelete)
.head 9 -     Call SalDisableWindow(pbUpdate)
.head 9 -     Call SalDisableWindow(pbProtocol)
.head 8 +  If Rep_ProcK
.head 9 -  Call SalEnableWindow(pbCheckOnProck)
.head 8 +  Else
.head 9 -  Call SalDisableWindow(pbCheckOnProck)
.head 8 -  !
.head 8 -  Call SalWaitCursor(FALSE)
.head 8 -  Call SalSendMsg(tblDta, SAM_User, 0, 0)
.head 8 -  Call SalWaitCursor(FALSE)
.head 3 +  Pushbutton: pbFilter		! Встановити фільтр
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbFilter
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   2.0"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Встановити фільтр'
.head 5 +  On SAM_Click
.head 6 +  If SetQueryFilter(cF)
.head 7 -  Call SalSendMsg(tblDta, SAM_User, 0, 0)
.head 3 +  Pushbutton: pbInsert		! Вставити новий запис
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbInsert
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   2.633"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Insert.bmp
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Вставити новий запис'
.head 5 +  On SAM_Click
.head 6 +  If SalTblDefineSplitWindow ( tblDta, 3, TBL_Split_Adjustable )
.head 7 -  Set nRow = SalTblInsertRow( tblDta, TBL_MinRow )
.head 7 -  Set nCountLine = nCountLine + 1
.head 7 -  Call SalTblSetContext( tblDta, nRow )
.head 7 -  Call SalTblSetFocusCell ( tblDta, nRow, tblDta#1, 0, 0 )
.head 3 +  Pushbutton: pbDelete		! Видалити запис
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbDelete
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   3.067"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Видалити запис'
.head 5 +  On SAM_Click
.head 6 -  Call SalTblSetFlagsAnyRows ( tblDta, ROW_MarkDeleted, TRUE, ROW_Selected, 0 )
.head 3 +  Pushbutton: pbUpdate		! Зберегти записи в базі
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbUpdate
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   3.5"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Зберегти записи в базі'
.head 5 +  On SAM_Click
.head 6 +  If obPersonalReport
.head 7 -  Call SalWaitCursor( TRUE )
.head 7 -  !
.head 7 -  Set strSqlDel = 'DELETE FROM ' || strTMPTable || ' WHERE rowid = :tblDta#' || SalNumberToStrX(nNumCol+1, 0)
.head 7 -  Call SqlPrepare ( C.hSql(), strSqlDel )
.head 7 -  !
.head 7 -  Call SalTblDoDeletes ( tblDta, C.hSql(), ROW_MarkDeleted )
.head 7 -  ! Call SqlPrepareAndExecute( C.hSql(), 'DELETE FROM ' || strTMPTable || ' WHERE kodf = :Rep_Code  AND datf = ' || DateInQuery( sDat ))
.head 7 -  !
.head 7 -  Set nRow = TBL_MinRow
.head 7 +  While SalTblFindNextRow( tblDta, nRow, ROW_Edited | ROW_New, 0 )
.head 8 -  Call SalTblFetchRow( tblDta, nRow )
.head 8 -  Set nI = 1
.head 8 -  Set strKey = ''
.head 8 -  Set strNbuc = ''
.head 8 -  Set strVal = ''
.head 8 +  While nI <= nNumCol
.head 9 -  Call SalTblGetColumnText( tblDta, 
SalTblQueryColumnID( SalTblGetColumnWindow( tblDta, nI, COL_GetPos )), strTemp )
.head 9 -  ! Set strKey = strKey || SalStrTrimX(strTemp)
.head 9 +  If sMIsCode[nI] = '1' or sMIsCode[nI] = '3' or sMIsCode[nI] = '4'
.head 10 -  Set strKey = strKey || SalStrTrimX(strTemp)
.head 9 +  Else If sMIsCode[nI] = '0'  
.head 10 -  Set strNbuc=strNbuc || SalStrTrimX(strTemp)
.head 9 +  Else
.head 10 -  Set strVal  = SalStrTrimX(strTemp)
.head 9 -  Set nI = nI + 1
.head 8 +  If strNbuc = ''
.head 9 -  Set strNbuc=Rep_MFO
.head 8 +  If SalTblQueryRowFlags(tblDta, nRow, ROW_New ) and SalStrTrimX(strKey) !=''
.head 9 +  If NOT SqlPrepareAndExecute( C.hSql(), T('INSERT INTO ' || strTMPTable || ' (nbuc, kodf, datf, kodp, znap, fl_mod) 
    VALUES (:strNbuc, :Rep_Code,  :dDatF, :strKey, :strVal, 1)') )
.head 10 -  Break
.head 8 +  If SalTblQueryRowFlags(tblDta, nRow, ROW_Edited ) and SalStrTrimX(strKey) !=''
.head 9 +  If NOT SqlPrepareAndExecute( C.hSql(), T('UPDATE ' || strTMPTable || 
		'  SET  kodp = :strKey, znap = :strVal, fl_mod = 1 ' ||
   		'  WHERE rowid = :tblDta#' || SalNumberToStrX(nNumCol+1, 0)) )
.head 10 -  Break
.head 7 -  Call SqlCommit( C.hSql() )
.head 7 -  Call SalTblSetFlagsAnyRows( tblDta, ROW_New, FALSE, ROW_New, 0 )
.head 7 -  Call SalTblSetFlagsAnyRows( tblDta, ROW_Edited, FALSE, ROW_Edited, 0 )
.head 7 -  Call SalWaitCursor( FALSE )
.head 7 -  Call SalSendMsg( tblDta, SAM_User, 0, 0 )
.head 7 -  Call SalWaitCursor( FALSE )
.head 7 -  Call SalTblDefineSplitWindow ( tblDta, 0, TBL_Split_Adjustable )
.head 3 +  Pushbutton: pbDetPrint		! Надрукувати файл з розшифровкою реквізитів
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbPrint
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   4.183"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\print.bmp
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Надрукувати файл з розшифровкою реквізитів'
.head 5 +  On SAM_Click
.head 6 -  Call TablePrint( tblDta, 'Файл звітності НБУ № ' || Rep_Code || 
IifS( Rep_CodeExt!='', ' (' || Rep_CodeExt || ') ', ' '  ) || 'за ' || sDatMDY, 
GetPrnDir() || '/NBUREP' || Rep_Code || '.TXT', ''  )
.head 3 +  Pushbutton: pbFileStamp	! Сформувати файл звіту
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbSwitch
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   4.617"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Сформувати файл звіту'
.head 5 +  On SAM_Click
.head 6 -  Set strFileName = CreateFileName(Rep_FPrefix, IifS(Rep_CodeExt != '', Rep_CodeExt,
    Rep_Code), Rep_EBox, Rep_GCode, SalFmtFormatStrDateTime(sDatMDY, 'MM/dd/yyyy'),
    Rep_Period, sRep_CQNum, nRunMode)
.head 6 -  Set strFileName = Rep_Path || '\\' || strFileName
.head 6 +  If MessageQuestion('Сформувати звіт ' || IifS(Rep_CodeExt != '', Rep_CodeExt,
   Rep_Code) || '? [' || strFileName|| ']') = IDNO
.head 7 -  Return FALSE
.head 6 -  !
.head 6 -  Call WaitCursorOn()
.head 6 -  ! Расчитываем количество инф строк с проверкой пустых записей
.head 6 -  Set nRowNum = TBL_MinRow
.head 6 -  Set nCountLine = 0
.head 6 -  ! Call SalMessageBox ( 'nNumColInPKey - '||SalNumberToStrX(nNumColInPKey, 0), 'Info', MB_Ok )
.head 6 +  While SalTblFindNextRow(tblDta, nRowNum, 0, 0)
.head 7 -  Call SalTblSetContext(tblDta, nCountLine)
.head 7 -  Call SalTblGetColumnText(tblDta, SalTblQueryColumnID(
     SalTblGetColumnWindow(tblDta, nNumColInPKey, COL_GetPos)), strTemp)
.head 7 +  ! If strTemp != STRING_Null
.head 8 -     Set nCountLine = nCountLine + 1
.head 7 -  ! считаем все строки
.head 7 -  Set nCountLine = nCountLine + 1
.head 6 -  !
.head 6 +  If SalFileOpen(hFile, strFileName, OF_Create | OF_ReadWrite | OF_Share_Exclusive)
.head 7 -  !
.head 7 -  ! Служебная строка
.head 7 -  Call CreateServiceLine(hFile)
.head 7 -  !
.head 7 -  ! Заголовок
.head 7 -  Call CreateHeadLine(hFile, sDatMDY, Rep_Period, Rep_GNum, GetBankMfo(), Rep_Msrm,
     (Rep_Code = '02'), nCountLine, SalStrRightX(strFileName, 12))
.head 7 -  !
.head 7 -  ! Подзаголовок 
.head 7 +  If obPersonalReport and not sBANKTYPE = 'AVAL'
.head 8 +  If Rep_Code = 'AA' or Rep_Code = 'BB' or Rep_Code = 'CC' or Rep_Code = 'LL'
.head 9 -  ! Set strLine = '#' || SalStrLeftX(sR, 1) || '=' || SalStrTrimX('0' || sMFO) 
.head 9 -  ! Call SalFilePutStr(hFile, '#' || SalStrLeftX(Rep_Resident, 1) || '=' ||
     SalStrTrimX('0' || Rep_MFO))
.head 9 -  Call SalFilePutStr(hFile, '#' || SalStrLeftX(Rep_Resident, 1) || '=' ||
     SalStrRightX(SalStrTrimX('00' || Rep_MFO),3))
.head 8 +  Else
.head 9 -  Call CreateHeadLineEx(hFile, Rep_Resident, Rep_MFO, flag_tpf_OTCN)
.head 7 -  !
.head 7 -  Set nRow = TBL_MinRow ! Сохранение информационных строк
.head 7 -  ! Для Аваль собственный отчет с разбивкой по областям (как консолидированный)
.head 7 +  If obCommonReport or sBANKTYPE = 'AVAL'
.head 8 -  Set strSubMFO = ''
.head 8 -  Set strSubMFOList = ''
.head 8 -  Set nExclCol = nExclCol + 1
.head 8 +  If obCommonReport
.head 9 -  Set nDod = 0
.head 8 +  Else
.head 9 -  Set nDod = 1
.head 7 +  Else
.head 8 -  Set nDod = 0
.head 7 +  Loop
.head 8 +  If SalTblFindNextRow(tblDta, nRow, 0, 0)
.head 9 -  Call SalTblFetchRow(tblDta, nRow)
.head 9 -  ! Для Аваль собственный отчет с разбивкой по областям (как консолидированный)
.head 9 +  If obCommonReport or sBANKTYPE = 'AVAL'
.head 10 +  If strSubMFO != tblDta#1
.head 11 -  Set strSubMFO = tblDta#1
.head 11 +  If strSubMFOList
.head 12 -  Set strSubMFOList = strSubMFOList || ','
.head 11 -  Set strSubMFOList = strSubMFOList || strSubMFO
.head 11 -  ! Очередной подзаголовок
.head 11 -  Call CreateHeadLineEx(hFile, Rep_Resident, strSubMFO, flag_tpf_OTCN)
.head 10 -  Set nI = 2
.head 9 +  Else
.head 10 -  Set nI = 1
.head 9 -  Set strKey = ''
.head 9 -  Set strVal = ''
.head 9 +  While nI <= nNumCol + nDod
.head 10 -  Call SalTblGetColumnText( tblDta, 
SalTblQueryColumnID( SalTblGetColumnWindow( tblDta, nI, COL_GetPos )), strTemp )
.head 10 -  ! Set strKey = strKey || SalStrTrimX(strTemp)
.head 10 +  If sMIsCode[nI] = '1'  
.head 11 -  Set strKey = strKey || SalStrTrimX(strTemp)
.head 10 +  Else If sMIsCode[nI] = '2'  
.head 11 +  If Rep_Code = '1P'
.head 12 -  Set strVal = strTemp
.head 11 +  Else
.head 12 -  Set strVal = SalStrTrimX(strTemp)
.head 10 -  Set nI = nI + 1
.head 9 -  !
.head 9 +  If strKey
.head 10 -  Call CreateInfoLine(hFile, strKey, strVal)
.head 8 +  Else
.head 9 -  Break
.head 7 -  !
.head 7 -  ! Добавим строки для "пустых" файлов (для всех, кроме консолидированных, где  Rep_PrTobo=0) 
.head 7 +  ! If nCountLine = 0 
.head 8 -  ! Call CreateHeadLineEx(hFile, Rep_Resident, Rep_MFO, flag_tpf_OTCN)
.head 7 +  If obCommonReport or sBANKTYPE = 'AVAL'
.head 8 -  ! С разбивкой по областям, МФО или подразделениям
.head 8 +  If ( Rep_PrTobo = NUMBER_Null or Rep_PrTobo != 0)
.head 9 -  ! Если не было сформировано пока ни одной строки по подразделению
.head 9 +  If strSubMFOList = STRING_Null
.head 10 -  Set sSqlTxt =  ' SELECT distinct nbuc
   	         INTO :strSubMFO
   	         FROM v_banks_report
   	         WHERE kodp is null and znap is null and
		       nbuc is not null and
		       kodf=:Rep_Code and 
         		       datf=:dDatF'
.head 9 -  ! Были строки по подразделениям - доформировываем те, по котрым не было строк
.head 9 +  Else
.head 10 -  Set sSqlTxt =  ' SELECT distinct nbuc
   	         INTO :strSubMFO
   	         FROM v_banks_report
   	         WHERE kodp is null and znap is null  and kodf=:Rep_Code and datf=:dDatF' 
                            || ' and nbuc not in ( select nbuc 
                                                     from v_banks_report
			            where  kodp is not null 
                                                                and znap is not null
                                                                and kodf=:Rep_Code
                                                                and datf=:dDatF)'
.head 8 -  ! Консолидированный в целом по банку
.head 8 +  Else
.head 9 -  Set sSqlTxt =  ' SELECT zzz
   	         INTO :strSubMFO
   	         FROM kl_f00
   	         WHERE  trim(kodf)=:Rep_Code AND a017 = :Rep_GCode' ||
			 ' and not exists ( select 1
                                                                     from v_banks_report
			     	     where  kodp is not null 
                                                                         and znap is not null
                                                                         and kodf=:Rep_Code
                                                                         and datf=:dDatF)'
.head 8 -  !
.head 8 +  If SqlPrepareAndExecute(C.hSql(), sSqlTxt)
.head 9 +  While SqlFetchNext(C.hSql(), nFetchRes)
.head 10 -  Call CreateHeadLineEx(hFile, Rep_Resident, strSubMFO, flag_tpf_OTCN)
.head 8 -  ! Безбалансовые отделения Главного банка (или филиала, если файл формируется в филиале)
.head 8 +  If ( Rep_PrTobo != NUMBER_Null or Rep_PrTobo > 0)
.head 9 -  Set sSqlTxt =  ' SELECT distinct trim(nbuc) nbuc
   	         INTO :strSubMFO
   	         FROM table(bars.otcn_pkg.f_RET_EMPT_NBUC(:Rep_PrTobo , :dDatF, :Rep_Code)) '
.head 9 -  !
.head 9 +  If SqlPrepareAndExecute(C.hSql(), sSqlTxt)
.head 10 +  While SqlFetchNext(C.hSql(), nFetchRes)
.head 11 -  Call CreateHeadLineEx(hFile, Rep_Resident, strSubMFO, flag_tpf_OTCN)
.head 7 -  !
.head 7 -  ! Call Debug(strSubMFOList)
.head 7 -  ! закрываем файл перед наложением ЭЦП
.head 7 -  Call SalFileClose(hFile)
.head 7 -  ! Если это фонд, то подпишем
.head 7 -  Call SalUseRegistry(FALSE, GetCompanyName())
.head 7 -  Call SalGetProfileString('Digital Signature', 'ReportsSignOn', '0',
     strReportsSignOn, GetIniFileName())
.head 7 -  Call SalGetProfileString('Digital Signature', 'FondSignOn', '0', strFondSignOn,
     GetIniFileName())
.head 7 +  ! If strReportsSignOn='1' AND GetSignOn()
.head 8 +      If Rep_Code = 'AA' OR Rep_Code = 'BB' OR Rep_Code = 'CC'
.head 9 -      Call SalUseRegistry( FALSE, GetCompanyName() )
.head 9 -      Call SalGetProfileString( 'Digital Signature', 'DebugSFFKey', SalStrRightX(SalStrUpperX(SalStrTrimX(GetBankSab())),3)||'SFF', strSFFKey, GetIniFileName() )
.head 9 -      Call SalGetProfileString( 'Digital Signature', 'DebugKeyDate', SalFmtFormatDateTime( SalDateCurrent(), 'yyyy/MM/dd hhhh:mm:ss' ), strSFFDate, GetIniFileName() )
.head 9 -      Call FSign.SetVariables( 'NBU', GetOpenKeyDir(), GetSecretKeyDrv(), strSFFKey, strSFFDate, 3 )
.head 9 +      If FSign.Init() 
.head 10 -  ! открываем файл
.head 10 -      Set nCFile = _sopen( strFileName, OF_ReadWrite|OF_Binary, 0x00000010, 0x00000180)
.head 10 +      If -1 = nCFile
.head 11 -      Call Debug('Ошибка открытия файла для наложения ЭЦП')
.head 11 -      Return -1
.head 10 -      Set nlsSign = 64
.head 10 -      Set nSignBufLen = _lseek( nCFile, 0, SEEK_End ) - 252
.head 10 -      Call SalStrSetBufferLength( lsSign, nlsSign )
.head 10 -      Call FSign.SignFile( nCFile, 1, 252, nSignBufLen, nSignBufLen, nlsSign, lsSign )
.head 10 -      Call _lseek( nCFile, 85+102, SEEK_Begin )
.head 10 -      Call _write( nCFile, lsSign, nlsSign )
.head 10 -      Call _lseek( nCFile, 78+102, SEEK_Begin )
.head 10 -      Call _write( nCFile, strSFFKey, 6 )
.head 10 -      Call FSign.Deinit()
.head 10 -  ! закрываем файл
.head 10 -      Call _close( nCFile )
.head 8 +      Else 
.head 9 -      Call SalUseRegistry( FALSE, GetCompanyName() )
.head 9 -      Call SalGetProfileString( 'Digital Signature', 'ReportsSecretKey', SalStrRightX(SalStrUpperX(SalStrTrimX(GetBankSab())),3)||'SFF', strSFFKey, GetIniFileName() )
.head 9 -      Call SalGetProfileString( 'Digital Signature', 'DebugKeyDate', SalFmtFormatDateTime( SalDateCurrent(), 'yyyy/MM/dd hhhh:mm:ss' ), strSFFDate, GetIniFileName() )
.head 9 -      Call FSign.SetVariables( 'NBU', GetOpenKeyDir(), GetSecretKeyDrv(), strSFFKey, strSFFDate, 3 )
.head 9 +      If FSign.Init() 
.head 10 -  ! открываем файл
.head 10 -      Set nCFile = _sopen( strFileName, OF_ReadWrite|OF_Binary, 0x00000010, 0x00000180)
.head 10 +      If -1 = nCFile
.head 11 -      Call Debug('Ошибка открытия файла для наложения ЭЦП')
.head 11 -      Return -1
.head 10 -      Set nlsSign = 64
.head 10 -      Set nSignBufLen = _lseek( nCFile, 0, SEEK_End ) - 252
.head 10 -      Call SalStrSetBufferLength( lsSign, nlsSign )
.head 10 -      Call FSign.SignFile( nCFile, 1, 252, nSignBufLen, nSignBufLen, nlsSign, lsSign )
.head 10 -      Call _lseek( nCFile, 85+102, SEEK_Begin )
.head 10 -      Call _write( nCFile, lsSign, nlsSign )
.head 10 -      Call _lseek( nCFile, 78+102, SEEK_Begin )
.head 10 -      Call _write( nCFile, strSFFKey, 6 )
.head 10 -      Call FSign.Deinit()
.head 10 -  ! закрываем файл
.head 10 -      Call _close( nCFile )
.head 7 -  ! Подпись файлов НБУ и файлов для фонда гарантирования
.head 7 +  If strFondSignOn = '1' and GetSignOn() and (Rep_Code = 'AA' or Rep_Code = 'BB' or
   Rep_Code = 'CC' or Rep_Code = 'LL' or Rep_Code = 'DD' or Rep_Code = 'VV')
.head 8 -  Call SalUseRegistry(FALSE, GetCompanyName())
.head 8 -  Call SalGetProfileString('Digital Signature', 'DebugSFFKey',
     SalStrRightX(SalStrUpperX(SalStrTrimX(GetBankSab())), 3) || 'SFF', strSFFKey,
     GetIniFileName())
.head 8 -  Call SalGetProfileString('Digital Signature', 'DebugKeyDate',
     SalFmtFormatDateTime(SalDateCurrent(), 'yyyy/MM/dd hhhh:mm:ss'), strSFFDate,
     GetIniFileName())
.head 8 -  Call FSign.SetVariables('NBU', GetOpenKeyDir(), GetSecretKeyDrv(), strSFFKey,
     strSFFDate, 3)
.head 8 +  If FSign.Init()
.head 9 -  !
.head 9 -  ! ВАРИАНТ 1
.head 9 -  !
.head 9 -  ! открываем файл
.head 9 -  Set nCFile = _sopen(strFileName, OF_ReadWrite | OF_Binary, 0x00000010,
    0x00000180)
.head 9 -  ! Call DebugN(nCFile)
.head 9 +  If nCFile = -1
.head 10 -  Call Debug('Ошибка открытия файла для наложения ЭЦП')
.head 10 -  Return -1
.head 9 -  Set nlsSign = 64
.head 9 -  Set nSignBufLen = _lseek(nCFile, 0, SEEK_End) - 314
.head 9 -  ! Call DebugN(nSignBufLen)
.head 9 -  Call SalStrSetBufferLength(lsSign, nlsSign)
.head 9 -  Call FSign.SignFile(nCFile, 1, 314, nSignBufLen, nSignBufLen, nlsSign, lsSign)
.head 9 -  Call _close(nCFile)
.head 9 -  ! Call _lseek(nCFile, 74+102, SEEK_Begin)
.head 9 -  ! Call _write(nCFile, lsSign, nlsSign)
.head 9 -  Set nI = llopen(strFileName, 2)
.head 9 -  Call lllseek(nI, 74+102, 0)
.head 9 -  Call llwrite(nI, lsSign, nlsSign)
.head 9 -  Call llclose(nI)
.head 9 -  Set nCFile = _sopen(strFileName, OF_ReadWrite | OF_Binary, 0x00000010,
    0x00000180)
.head 9 -  Call _lseek(nCFile, 139+102, SEEK_Begin)
.head 9 -  Call _write(nCFile, strSFFKey, 6)
.head 9 -  Call SalStrSetBufferLength(lsSign, nlsSign)
.head 9 -  Call FSign.SignFile(nCFile, 1, 102, 146, 146, nlsSign, lsSign)
.head 9 -  Call _close(nCFile)
.head 9 -  !
.head 9 -  ! Set nI = llcreat('c:\\temp\\aaa.aaa', 2)
.head 9 -  ! Call llwrite(nI, lsSign, nlsSign)
.head 9 -  ! Call llclose(nI)
.head 9 -  !
.head 9 -  ! Call _lseek(nCFile, 102+146, SEEK_Begin)
.head 9 -  ! Call _write(nCFile, lsSign, nlsSign)
.head 9 -  ! Call _close(nCFile) ! закрываем файл
.head 9 -  Set nI = llopen(strFileName, 2)
.head 9 -  Call lllseek(nI, 102+146, 0)
.head 9 -  Call llwrite(nI, lsSign, nlsSign)
.head 9 -  Call llclose(nI)
.head 9 -  Call FSign.Deinit()
.head 9 -  !
.head 9 -  ! ВАРИАНТ 2 (ни хрена не работает)
.head 9 -  !
.head 9 -  ! открываем файл
.head 9 -  ! Set nCFile = llopen(strFileName, 2)
.head 9 -  ! Call DebugN(nCFile)
.head 9 +  ! If nCFile = -1
.head 10 -      Call Debug('Ошибка открытия файла для наложения ЭЦП')
.head 10 -      Return -1
.head 9 -  ! Set nlsSign = 64
.head 9 -  ! Set nSignBufLen = lllseek(nCFile, 0, 2) - 314
.head 9 -  ! Call DebugN(nSignBufLen)
.head 9 -  ! Call SalStrSetBufferLength(lsSign, nlsSign)
.head 9 -  ! Call FSign.SignFile(nCFile, 1, 314, nSignBufLen, nSignBufLen, nlsSign, lsSign)
.head 9 -  ! Call lllseek(nCFile, 74+102, 0)
.head 9 -  ! Call llwrite(nCFile, lsSign, nlsSign)
.head 9 -  ! Call lllseek(nCFile, 139+102, 0)
.head 9 -  ! Call llwrite(nCFile, strSFFKey, 6)
.head 9 -  ! Call SalStrSetBufferLength(lsSign, nlsSign)
.head 9 -  ! Call FSign.SignFile(nCFile, 1, 102, 146, 146, nlsSign, lsSign)
.head 9 -  ! Call lllseek(nCFile, 102+146, 0)
.head 9 -  ! Call llwrite(nCFile, lsSign, nlsSign)
.head 9 -  ! Call FSign.Deinit()
.head 9 -  ! Call llclose(nCFile) ! закрываем файл
.head 7 +  Else If strReportsSignOn = '1' and GetSignOn()
.head 8 -  Call SalUseRegistry(FALSE, GetCompanyName())
.head 8 -  ! вынесено в отдельную ветку
.head 8 -  !
.head 8 -  Call SalGetProfileString('Digital Signature', 'ReportsSecretKey',
     SalStrRightX(SalStrUpperX(SalStrTrimX(GetBankSab())), 3) || 'S' || UserIdTo2DigitId( GetUserId() ), strSFFKey,
     GetIniFileName())
.head 8 -  !
.head 8 -  Call SalGetProfileString('Digital Signature', 'DebugKeyDate',
     SalFmtFormatDateTime(SalDateCurrent(), 'yyyy/MM/dd hhhh:mm:ss'), strSFFDate,
     GetIniFileName())
.head 8 -  Call FSign.SetVariables('NBU', GetOpenKeyDir(), GetSecretKeyDrv(), strSFFKey,
     strSFFDate, 3)
.head 8 +  If FSign.Init() 
.head 9 -  ! пропишем ID ключа + 64 пробела вместо ЭЦП
.head 9 -  Set nI = llopen(strFileName, 2)
.head 9 -  Set nlsSign = 64
.head 9 -  Set lsSign = SalStrRepeatX( ' ', nlsSign )
.head 9 -  Call lllseek(nI, 84+102, 0)
.head 9 -  Call llwrite(nI, lsSign, nlsSign)
.head 9 -  Call lllseek(nI, 77+102, 0)
.head 9 -  Call llwrite(nI, strSFFKey, 6)
.head 9 -  Call llclose(nI)
.head 9 -  ! открываем файл
.head 9 -  Set nCFile = _sopen(strFileName, OF_ReadWrite | OF_Binary, 0x00000010,
    0x00000180)
.head 9 +  If nCFile = -1
.head 10 -  Call Debug('Ошибка открытия файла для наложения ЭЦП')
.head 10 -  Return -1
.head 9 -  Set nlsSign = 64
.head 9 -  Set nSignBufLen = _lseek(nCFile, 0, SEEK_End)
.head 9 -  Call SalStrSetBufferLength(lsSign, nlsSign)
.head 9 -  Set nErrorSign = FSign.SignFile(nCFile, 1, 0, nSignBufLen, nSignBufLen,
    nlsSign, lsSign)
.head 9 +  If nErrorSign = 0
.head 10 -  ! с 85-й позиции - подпись
.head 10 -  ! Call _lseek(nCFile, 84+102, SEEK_Begin)
.head 10 -  ! Call _write(nCFile, lsSign, nlsSign)
.head 10 -  ! с 78-й позиции - ид. ключа
.head 10 -  ! Call _lseek(nCFile, 77+102, SEEK_Begin)
.head 10 -  ! Call _write(nCFile, strSFFKey, 6)
.head 10 -  !
.head 10 -  Call _close(nCFile)
.head 10 -  Set nI = llopen(strFileName, 2)
.head 10 -  !
.head 10 -  Call lllseek(nI, 84+102, 0)
.head 10 -  Call llwrite(nI, lsSign, nlsSign)
.head 10 -  !
.head 10 -  ! Call lllseek(nI, 77+102, 0)
.head 10 -  ! Call llwrite(nI, strSFFKey, 6)
.head 10 -  Call llclose(nI)
.head 9 +  Else
.head 10 -  Call MessageAttention('>> RSA. Ошибка наложения ЭЦП: ' ||
     NumberToStr(nErrorSign))
.head 10 -  Return -1
.head 9 -  Call FSign.Deinit()
.head 9 -  ! закрываем файл
.head 9 -  ! Call _close(nCFile)
.head 8 +  Else
.head 9 -  Return -1
.head 7 -  ! update db records in table kl_f00
.head 7 -  Call SqlPrepareAndExecute(C.hSql(), T('
     UPDATE ' || strF00Table || '
     SET datf = today , nom=:sRep_CQNum
     WHERE kodf=:Rep_Code'))
.head 7 -  Call SqlCommit(C.hSql())
.head 7 -  Set Rep_CQNum = Rep_CQNum + 1
.head 7 +  If Rep_CQNum > 35
.head 8 -  Set Rep_CQNum = 1
.head 8 -  Set sRep_CQNum = SalNumberToChar(49)
.head 7 +  Else If Rep_CQNum > 9 AND Rep_CQNum<=35
.head 8 -  Set sRep_CQNum = SalNumberToChar(87+Rep_CQNum)
.head 7 +  Else
.head 8 -  Set sRep_CQNum=SalNumberToChar(48+Rep_CQNum)
.head 7 -  !
.head 7 -  Call MessageInfoEx('Файл звітності ' || strFileName || ' успішно сформовано')
.head 6 +  Else
.head 7 -  Call MessageInfoEx('Помилка створення файлу ' || strFileName)
.head 6 -  !
.head 6 -  Call WaitCursorOff()
.head 3 +  Pushbutton: pbExists		! Філії Банку
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbDetail
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   5.867"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Філії Банку'
.head 5 +  On SAM_Click
.head 6 -  Call SalModalDialog ( dlg_Ask, hWndForm, IifS( Rep_CodeExt!='', Rep_CodeExt, Rep_Code ), sDatMDY)
.head 3 -  ! ! Сухова
.head 3 +  Pushbutton: pbImport		! Імпорт файлів філій
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cTBarButton
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   6.3"
.head 5 -  Top:    0.452"
.head 5 -  Width:  0.429"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.321"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: None
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Doc_in.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Імпорт файлів філій'
.head 5 +  On SAM_Click
.head 6 -  ! FileBranch
.head 6 -  Call SalModalDialog( dlg_FileImport, hWndForm, IifS( Rep_CodeExt!='', Rep_CodeExt, Rep_Code ), sDatMDY)
.head 3 -  !
.head 3 +  Pushbutton: pbProtocol		! Проглянути протокол формування
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cTBarButton
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   6.967"
.head 5 -  Top:    0.452"
.head 5 -  Width:  0.429"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.321"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: None
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Logfile.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Проглянути протокол формування'
.head 5 +  On SAM_Click
.head 6 +  If SalTblAnyRows(hWndForm.frm_FilesNbu.tblDta, ROW_Selected, 0)
.head 7 -  Set strKey = tblDta.MakeKeyString(nNumColInPKey)
.head 7 -  Call SalCreateWindow(tbl_FileNbuTrace, hWndMDI, sTraceTable, strSTCTable, Rep_Code, dDatF, strKey, sNbuc, Rep_TypeZnap)
.head 6 +  Else
.head 7 -  Call SalCreateWindow(tbl_FileNbuTrace, hWndMDI, sTraceTable, strSTCTable, Rep_Code, dDatF, '', sNbuc, Rep_TypeZnap)
.head 3 +  Pushbutton: pbCheck		! Проглянути контрольні точки формування
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbChilds
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   7.4"
.head 5 -  Top:    0.452"
.head 5 -  Width:  0.4"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Проглянути контрольні точки формування'
.head 5 +  On SAM_Click
.head 6 -  Call SalModalDialog(dlg_OtcnCh, hWndForm, Rep_Code)
.head 3 +  Pushbutton: pbCheckOnProck	! Контроль
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbOk
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   7.817"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\K.BMP
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Контроль'
.head 5 +  On SAM_Click
.head 6 +  If Rep_ProcK
.head 7 -  Call SqlPrepareAndExecute(hSql(), "select name into :sProckName from rep_proc where procc = :Rep_ProcK")
.head 7 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 7 +  If sProckName
.head 8 -  Call SalWaitCursor(TRUE)
.head 8 -  ! Call F_otcn(SalStrTrimX(SalStrLowerX(sProckName)), sDat)
.head 8 +  If not SqlPLSQLCommand(hSql(), sProckName || "(Rep_Code, dDatF)")
.head 9 -  Call SqlRollback(hSql())
.head 8 +  Else
.head 9 -  Call SqlCommit(hSql())
.head 9 -  Set bCheckProcK = TRUE
.head 9 -  Call SalShowWindow(hColWndErrMsg)
.head 9 -  Call SalSendMsg(tblDta, SAM_User, 0, 0)
.head 8 -  Call SalWaitCursor(FALSE)
.head 3 +  Pushbutton: pbToArc		! Зберегти в архів
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbOk
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   8.267"
.head 5 -  Top:    0.452"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\PACH.BMP
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Зберегти в архів'
.head 5 +  On SAM_Click
.head 6 +  If SalMessageBox("Зберегти файл в архів?", "Увага!", MB_IconQuestion | MB_YesNo) = IDYES
.head 7 -  Call SalWaitCursor(TRUE)
.head 7 +  If SqlPLSQLCommand(hSql(), "otc_save_arch(Rep_Code,dDatF,nRunMode)")
.head 8 -  Call SqlCommitEx(hSql(), "Файл " || Rep_Code || " за " || SalFmtFormatDateTime(dDatF, 'dd.MM.yyyy') || " збережено в архів")
.head 8 -  Call SalMessageBox("Файл " || Rep_Code || " за " || SalFmtFormatDateTime(dDatF, 'dd.MM.yyyy') || " збережено в архів", "Повідомлення", MB_IconAsterisk | MB_Ok)
.head 8 -  Call SalDisableWindow(pbExecute)
.head 8 -  Call SalDisableWindow(pbInsert)
.head 8 -  Call SalDisableWindow(pbDelete)
.head 8 -  Call SalDisableWindow(pbUpdate)
.head 8 -  Call SalDisableWindow(pbCheckOnProck)
.head 8 -  Call SalDisableWindow(pbToArc)
.head 7 +  Else
.head 8 -  Call SqlRollbackEx(hSql(), "Помилка збереження в архів файла " || Rep_Code)
.head 7 -  Call SalWaitCursor(FALSE)
.head 3 -  !
.head 3 +  Pushbutton: pbExit		! Завершити роботу
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   8.917"
.head 5 -  Top:    0.452"
.head 5 -  Width:  0.43"
.head 5 -  Width Editable? No
.head 5 -  Height: 0.317"
.head 5 -  Height Editable? No
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Discard.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Завершити роботу'
.head 5 +  On SAM_Click
.head 6 -  Call SalDestroyWindow (hWndForm)
.head 3 -  !
.head 3 +  Child Table: tblDta
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.0"
.head 6 -  Top:    0.85"
.head 6 -  Width:  10.157"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 4.99"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: MS Sans Serif
.head 5 -  Font Size: 8
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: 200000
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  ! cColumnLabeled: colErrMsg
.head 6 -     List Values 
.head 6 -     Message Actions 
.head 4 +  Functions
.head 5 +  Function: MakeKeyString
.head 6 -  Description: Сформировать показатель из разрозненого набора
.head 6 +  Returns
.head 7 -  String:
.head 6 +  Parameters
.head 7 -  Number: nColInKey
.head 6 -  Static Variables
.head 6 +  Local variables
.head 7 -  String: strKey
.head 7 -  String: strTemp
.head 7 -  String: strObl
.head 7 -  Number: nI
.head 6 +  Actions
.head 7 -  Set strKey = ''
.head 7 -  Set nI = 1
.head 7 -  Set sNbuc=''
.head 7 +  While nI <= nNumCol
.head 8 -  Call SalTblGetColumnText(tblDta, SalTblQueryColumnID(SalTblGetColumnWindow(tblDta, nI, COL_GetPos)), strTemp)
.head 8 +  If sMIsCode[nI] = '1' or sMIsCode[nI] = '3' or sMIsCode[nI] = '4'  
.head 9 -  Set strKey = strKey || SalStrTrimX(strTemp)
.head 8 +  Else If sMIsCode[nI] = '0'  
.head 9 -  Set sNbuc = sNbuc || SalStrTrimX(strTemp)
.head 8 -  Set nI = nI + 1
.head 7 -  ! Call Debug(sNbuc)
.head 7 -  ! Call Debug(strKey)
.head 7 -  ! Call Debug(strObl)
.head 7 -  Return strKey
.head 4 -  Window Variables
.head 4 +  Message Actions
.head 5 +  On SAM_User
.head 6 -  Call SalWaitCursor(TRUE)
.head 6 -  Set nCountLine = 0
.head 6 -  Call SalTblDefineSplitWindow(hWndForm, 0, FALSE)
.head 6 +  If bPROTCN and obCommonReport
.head 7 +  If not SqlPrepareAndExecute(hSql(),
"select count(*) into :nCount
   from v_branch v
  where not exists (SELECT 1 FROM rnbu_in_files r
        WHERE v.mfo=r.mfo AND 
        r.file_name like '#" || Rep_Code || "%' AND 
        r.last_date = '" || SalStrMidX( sDatMDY, 3, 2 ) || SalStrLeftX( sDatMDY, 2) || SalStrRightX( sDatMDY, 4 ) || "')")
.head 8 -  Return FALSE
.head 7 +  If not SqlFetchNext(hSql(), nFetchRes)
.head 8 -  Return FALSE
.head 7 +  If nCount > 0
.head 8 -  Call SalMessageBox("Не всі файли філіалів завантажено! ", "Увага!", MB_IconStop)
.head 8 -  Return FALSE
.head 6 +  If Rep_Action = 91 AND obCommonReport
.head 7 +  If SqlPrepareAndExecute( C.hSql(), "BEGIN p_kons_t91(TO_DATE('" || sDatMDY || "', 'MM/DD/YYYY'),  '"|| Rep_Code ||"', '"|| Rep_GCode || "'); END;" )
.head 8 -  Call SqlCommitEx( C.hSql(), 'Подготовка данных для консолидированного отчета '|| Rep_Code )
.head 6 -  Set strDSql = cQ.GetFullSQLString(cF)
.head 6 -  Call SalTblPopulate(hWndForm, CT.hSql(), T(strDSql) , TBL_FillAll)
.head 6 -  Call VisTblAutoSizeColumn(tblDta, hWndNULL)
.head 6 -  Set bCheckProcK = FALSE
.head 6 +  If obPersonalReport and SalStrRightX(sTraceTable,5) != "_ARCH"
.head 7 +  If GetValueStr("select to_char(count(*)) from " || strTRCTable || " where userid = user_id") != '0'
.head 8 -  Call SalEnableWindow(pbToArc)
.head 6 -  Call SalWaitCursor(FALSE)
.head 5 +  On SAM_FetchRowDone
.head 6 -  Set nCountLine = nCountLine + 1
.head 6 +  If Rep_ProcK and bCheckProcK
.head 7 -  ! Значение поля
.head 7 -  Call SalGetWindowText(hColWndErrMsg, sErrMsg, 254)
.head 7 +  If sErrMsg
.head 8 -  Call XSalTblSetRowBackColor(hWndForm, lParam, SalColorFromRGB(255,200,200))
.head 5 +  On SAM_DoubleClick
.head 6 -  Set strKey = MakeKeyString(nNumColInPKey)
.head 6 -  ! Call Debug(strKey)
.head 6 -  Call SalCreateWindow(tbl_FileNbuTrace, hWndMDI, sTraceTable, strSTCTable, Rep_Code, dDatF, strKey, sNbuc, Rep_TypeZnap)
.head 2 +  Functions
.head 3 +  Function: FunMakeColSetNSQLStr
.head 4 -  Description: Создать набор колонок для расшифровки показателей
и строки "населения" и сохранения таблицы
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sFCode
.head 5 -  Date/Time: dFDat
.head 5 -  Receive Number: nColInKey
.head 5 -  Receive String: strPopulate
.head 5 -  Boolean: fManual
.head 5 -  Boolean: fExport
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nNum
.head 5 -  Number: nNbuC
.head 5 -  String: strColName
.head 5 -  String: strColVal
.head 5 -  String: strIsCode
.head 5 -  Number: nAtr
.head 5 -  !
.head 5 -  Number: nColId
.head 5 -  String: strSelect
.head 5 -  String: strInto
.head 5 -  String: strOrderBy
.head 5 -  Window Handle: hWndCol
.head 5 -  String: sAvalSelect
.head 5 -  String: sAvalInto
.head 5 -  !
.head 5 -  String: sUserTblName
.head 4 +  Actions
.head 5 -  Call SalTblDestroyColumns(tblDta)
.head 5 -  ! == Кнопки-1
.head 5 -  Call SalEnableWindow(pbArchive)
.head 5 -  Call SalDisableWindow(pbDetPrint)
.head 5 -  Call SalDisableWindow(pbFileStamp)
.head 5 -  Call SalDisableWindow(pb_XML)
.head 5 -  Call SalDisableWindow(pbCheck)
.head 5 -  Call SalDisableWindow(pbCheckOnProck)
.head 5 -  Call SalDisableWindow(pbToArc)
.head 5 -  ! == проверка: есть данные за день?
.head 5 -  Call SqlPrepareAndExecute(C.hSql(), T("SELECT Fdat FROM Fdat WHERE Fdat = :dFDat"))
.head 5 +  If not fManual AND not SqlFetchNext(C.hSql(), nFetchRes)
.head 6 -  Call SalMessageBeep(MB_IconStop)
.head 6 -  Call SalMessageBox("Дані за день відсутні!", "Увага!", MB_Ok)
.head 6 -  Return FALSE
.head 5 -  ! == Кнопки-2
.head 5 -  Call SalEnableWindow(pbProtocol)
.head 5 +  If obCommonReport
.head 6 -  Call SalEnableWindow(pbExecute)
.head 6 -  Call SalEnableWindow(pbExists)
.head 6 -  Call SalEnableWindow(pbImport)
.head 6 -  Call SalDisableWindow(pbInsert)
.head 6 -  Call SalDisableWindow(pbDelete)
.head 6 -  Call SalDisableWindow(pbUpdate)
.head 6 -  Call SalDisableWindow(pbArchive)
.head 5 +  Else
.head 6 -  Call SalEnableWindow(pbInsert)
.head 6 -  Call SalEnableWindow(pbDelete)
.head 6 -  Call SalEnableWindow(pbUpdate)
.head 6 -  Call SalDisableWindow(pbExists)
.head 6 -  Call SalDisableWindow(pbImport)
.head 5 -  ! == Кнопки-3: проверка: данные за день в архиве или нет?
.head 5 -  Call checkFlagBlk(sFCode, dFDat)
.head 5 -  ! ==
.head 5 -  Call SalEnableWindow(pbDetPrint)
.head 5 -  Call SalEnableWindow(pbFileStamp)
.head 5 -  Call SalEnableWindow(pb_XML)
.head 5 -  Call SalEnableWindow(pbCheck)
.head 5 -  ! == Для консолид.файла всегда д.б. открыта кнопка "Сформировать" и закрыты кнопки работы с архивом
.head 5 +  If obCommonReport
.head 6 -  Call SalEnableWindow(pbExecute)
.head 6 -  Call SalDisableWindow(pbArchive)
.head 6 -  ! Call SalDisableWindow(pbToArc)
.head 5 -  ! ==
.head 5 -  Set nNum = 0
.head 5 -  Set Rep_Action  = 0
.head 5 -  Set strSelect   = ''
.head 5 -  Set strInto     = ''
.head 5 -  Set strOrderBy  = ''
.head 5 -  Set sAvalSelect = ''
.head 5 -  Set sAvalInto   = ''
.head 5 -  Set Rep_Table   = ''
.head 5 -  !
.head 5 +  If obCommonReport        ! Консолидированый отчет
.head 6 -  Set nNum = nNum + 1
.head 6 +  If NOT SalTblCreateColumn( tblDta, nNum, 1.2, 9, 'Код' || PutCrLf() || 'області /' || PutCrLf() || ' МФО /' || PutCrLf() || 'підрозділу' )
.head 7 -  Return FALSE
.head 6 -  ! Set strSelect = strSelect ||'nbuc'
.head 6 -  ! Set strSelect = strSelect ||"ltrim(substr(decode(kodf,'AA','0','BB','0','CC','0',chr(32))||nbuc,-3))"
.head 6 +  If sFCode = 'AA' OR sFCode = 'BB' OR sFCode = 'CC' or sFCode = 'LL'
.head 7 -  Set strSelect = strSelect || "ltrim(substr('00'||nbuc,-3))"
.head 6 +  Else
.head 7 -  Set strSelect = strSelect || 'nbuc'
.head 6 -  Set strInto = strInto || ':tblDta#' || SalNumberToStrX(nNum, 0)
.head 6 -  Set strOrderBy = strOrderBy || SalNumberToStrX( nNum, 0 )
.head 6 -  ! внутренняя отчетность-Сбербанк
.head 6 +  If nRunMode = 1 and GetGlobalOption("BANKTYPE") = 'SBER'
.head 7 -  Call SqlPrepareAndExecute( C.hSql(),T(
"SELECT t1.kod, t0.view_name INTO :Rep_Action, :Rep_Table FROM rnbu_1_int t1, rnbu_0_int t0
 WHERE t0.kod=t1.kod AND t1.kodf = :sFCode"))
.head 7 -  Call SqlFetchNext( C.hSql(), nFetchRes )
.head 7 +  If NOT Rep_Table
.head 8 -  Set Rep_Table  = 'v_banks_report1_int'
.head 6 +  Else
.head 7 -  Call SqlPrepareAndExecute( C.hSql(),T(
"SELECT t1.kod, t0.view_name INTO :Rep_Action, :Rep_Table FROM rnbu_1 t1, rnbu_0 t0
 WHERE t0.kod=t1.kod AND t1.kodf = :sFCode"))
.head 7 -  Call SqlFetchNext( C.hSql(), nFetchRes )
.head 7 +  If NOT Rep_Table
.head 8 -  Set Rep_Table  = 'v_banks_report1'
.head 6 +  If Rep_Action = NUMBER_Null OR Rep_Action = 0
.head 7 -  Set Rep_Action = 1 
.head 6 -  !
.head 6 -  Call SalDisableWindow(pbFilter)
.head 5 +  Else
.head 6 -  Set Rep_Table  = strTMPTable
.head 6 -  Set Rep_Action = 0
.head 6 +  If sBANKTYPE = 'AVAL'
.head 7 -  Set nNum = nNum + 1
.head 7 -  Set nColId = SalTblCreateColumn( tblDta, nNum, 1.2, 9, 'Код' || PutCrLf() || 'области' )
.head 7 +  If NOT nColId
.head 8 -  Return FALSE
.head 7 -  Call SalHideWindow(SalTblGetColumnWindow(tblDta, nColId, COL_GetID))
.head 6 -  !
.head 6 +  If SqlPLSQLCommand(hSql(), "p_formstru(sFCode, strTMPTable, strSTCTable, sUserTblName)")
.head 7 -  Set Rep_Table = sUserTblName
.head 6 -  Call cF.Init(Rep_Table, Rep_Table)
.head 6 -  Call SalEnableWindow(pbFilter)
.head 5 -  !
.head 5 -  ! ***** ? Обработать переменную Rep_Action ? *****
.head 5 -  !
.head 5 -  Set nExclCol  = NUMBER_Null
.head 5 -  Set nColInKey = 0
.head 5 +  If SqlPrepareAndExecute(C.hSql(), T(
"SELECT natr, name, lower(replace(val,' ')),  
    (case when instr(lower(val), 'kodp')>0 and nvl(iscode, -1)=0  then 4
          when instr(lower(val), 'kodp')>0 and nvl(iscode, -1)<>1 then 3 
          when instr(lower(val), 'kodp')>0 and nvl(iscode, -1)=1  then 1
          when instr(lower(val), 'znap')>0 then 2
          else 0
     end), 
    (case when instr(lower(val), 'nbuc')>0 then 1
          else 0
     end)
    INTO :nAtr, :strColName, :strColVal, :strIsCode, :nNbuC
    FROM " || strSTCTable || "
    WHERE kodf = :sFCode ORDER BY natr"))
.head 6 +  While SqlFetchNext( C.hSql(), nFetchRes )
.head 7 +  If NOT (obCommonReport and nNbuC = 1) 
.head 8 -  Set nNum = nNum + 1
.head 8 -  Set sMIsCode[nNum] = strIsCode
.head 8 +  If SalStrToNumber( strIsCode ) = 1
.head 9 -  Set strColName = strColName || PutCrLf() || '(код)'
.head 9 -  Set nColInKey = nColInKey + 1
.head 8 +  Else If SalStrToNumber( strIsCode ) = 2
.head 9 -  Set nZnapCol=nNum
.head 8 -  !
.head 8 -  Set strColName = VisStrSubstitute( strColName, '~', PutCrLf() )
.head 8 -  Set nColId = SalTblCreateColumn( tblDta, nNum, 1.8, IifN(strIsCode='2',250,70), strColName )
.head 8 +  If NOT nColId
.head 9 -  Return FALSE
.head 8 +  Else If SalStrToNumber( strIsCode ) = 4
.head 9 -  Set hWndCol = SalTblGetColumnWindow ( tblDta, nColId, COL_GetID)
.head 9 -  Call SalHideWindow(hWndCol)
.head 8 -  !
.head 8 +  If strSelect != ''
.head 9 -  Set strSelect = strSelect || ', '
.head 8 -  Set strSelect = strSelect || strColVal
.head 8 -  !
.head 8 +  If strInto != ''
.head 9 -  Set strInto = strInto || ', '
.head 8 -  Set strInto = strInto || ':tblDta#' || SalNumberToStrX(nNum, 0)
.head 8 -  !
.head 8 +  If obPersonalReport and sBANKTYPE = 'AVAL' and nNbuC = 1
.head 9 -  Set sAvalSelect = sAvalSelect || IifS(sAvalSelect='', '', '||') || strColVal
.head 9 -  Set sAvalInto   =  ':tblDta#1' 
.head 6 +  If NOT obCommonReport
.head 7 -  Set nNum = nNum+1
.head 7 -  Set sMIsCode[nNum] = '4'
.head 7 -  !
.head 7 -  Set strColName = 'colRowid'
.head 7 -  Set nColId = SalTblCreateColumn( tblDta, nNum, 1.8, 70, strColName )
.head 7 +  If NOT nColId
.head 8 -  Return FALSE
.head 7 +  Else
.head 8 -  Set hWndCol = SalTblGetColumnWindow ( tblDta, nColId, COL_GetID)
.head 8 -  Call SalHideWindow(hWndCol)
.head 7 -  !
.head 7 -  Set strSelect = strSelect || ', rowid'
.head 7 -  !
.head 7 -  Set strInto = strInto || ', ' ||':tblDta#' || SalNumberToStrX(nNum, 0)
.head 7 -  !
.head 7 +  If sBANKTYPE = 'AVAL'
.head 8 -  Set strSelect = IifS(sAvalSelect='', 'nbuc, ', sAvalSelect || ',') || strSelect
.head 8 -  Set strInto   = IifS(sAvalInto='',    ':tblDta#1, ', sAvalInto   || ',') || strInto
.head 8 -  Set strOrderBy  = '1'
.head 7 -  !
.head 7 -  Set nNumCol = nNum-1
.head 6 +  Else
.head 7 -  Set nNumCol = nNum
.head 6 -  !
.head 6 +  If SqlPrepareAndExecute(C.hSql(), T(
'SELECT val INTO :strColVal
   FROM ' || strSTCTable || '
  WHERE kodf = :sFCode AND iscode = 1
  ORDER BY code_sort, natr'))
.head 7 +  While SqlFetchNext( C.hSql(), nFetchRes )
.head 8 +  If strOrderBy != ''
.head 9 -  Set strOrderBy = strOrderBy || ', '
.head 8 -  Set strOrderBy = strOrderBy || SalStrTrimX( strColVal )
.head 5 -  ! Call Debug(strSelect)
.head 5 +  If nNum = 0
.head 6 -  Return FALSE
.head 5 -  ! == err_msg
.head 5 -  Set nNum = nNum + 1
.head 5 -  Set nColIdErrMsg  = SalTblCreateColumn(tblDta, nNum, 4, 254, 'Текст помилки')
.head 5 -  Set hColWndErrMsg = SalTblGetColumnWindow(tblDta, nColIdErrMsg, COL_GetID)
.head 5 -  Call SalHideWindow(hColWndErrMsg)
.head 5 -  Call SalDisableWindow(hColWndErrMsg)
.head 5 -  Set strSelect = strSelect || ', substr(err_msg,1,254)'
.head 5 -  Set strInto   = strInto   || ', :tblDta#' || SalNumberToStrX(nNum, 0)
.head 5 -  ! == fl_mod
.head 5 -  Set nNum = nNum + 1
.head 5 -  Set nColIdFlMod  = SalTblCreateColumn(tblDta, nNum, 1.2, 1, 'Ознака' || PutCrLf() || 'редагування')
.head 5 -  Set hColWndFlMod = SalTblGetColumnWindow(tblDta, nColIdFlMod, COL_GetID)
.head 5 -  Call SalTblSetColumnFlags(hColWndFlMod, COL_CenterJustify, TRUE)
.head 5 -  Call SalHideWindow(hColWndFlMod)
.head 5 -  Call SalDisableWindow(hColWndFlMod)
.head 5 -  Set strSelect = strSelect || ', fl_mod'
.head 5 -  Set strInto   = strInto   || ', :tblDta#' || SalNumberToStrX(nNum, 0)
.head 5 -  ! ==
.head 5 -  ! Set strPopulate = 
'SELECT ' || strSelect || ', substr(err_msg,1,254) INTO ' || strInto || ', :tblDta.colErrMsg FROM ' || Rep_Table ||
' WHERE kodf = \'' || sFCode || '\' AND datf = ' || DateInQuery( sRDat ) ||
' ORDER BY ' || strOrderBy
.head 5 -  Set strPopulate = 
'SELECT ' || strSelect || ' INTO ' || strInto || ' FROM ' || Rep_Table ||
' WHERE kodf = \'' || sFCode || '\' AND datf = ' || DateInQuery(SalFmtFormatDateTime(dFDat, 'MM/dd/yyyy')) ||
' ORDER BY ' || strOrderBy
.head 5 -  Call cQ.Init(strPopulate)
.head 5 -  ! Call SaveInfoToLog('NBURep=>' || strPopulate)
.head 5 -  ! Call Debug(strPopulate)
.head 5 -  Return TRUE
.head 3 +  Function: checkFlagBlk
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: sFCode
.head 5 -  Date/Time: dFDat
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Number: nCount
.head 4 +  Actions
.head 5 -  ! == проверка: данные за день в архиве или нет?
.head 5 -  Call SqlPrepareAndExecute(hSql(), 
"select count(*) into :nCount
   from v_otcn_flag_blk
  where tp = :nRunMode and kodf = :sFCode and datf = :dFDat")
.head 5 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 5 -  ! == Кнопки-3
.head 5 -  ! == данные в архиве: закрываем "Сформировать файл" и "Сохранить в архив", открываем "Выбрать из архива"
.head 5 +  If nCount
.head 6 -  Set sTraceTable = strTRCTable || IifS(nRunMode=1, '_INT', '') || '_ARCH'
.head 6 -  Call SalDisableWindow(pbExecute)
.head 6 -  Call SalDisableWindow(pbInsert)
.head 6 -  Call SalDisableWindow(pbDelete)
.head 6 -  Call SalDisableWindow(pbUpdate)
.head 6 -  Call SalDisableWindow(pbCheckOnProck)
.head 6 +  If Rep_ProcK
.head 7 -  Call SalEnableWindow(pbCheckOnProck)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbCheckOnProck)
.head 5 +  Else
.head 6 -  Set sTraceTable = strTRCTable
.head 6 -  Call SalEnableWindow(pbExecute)
.head 5 -  Return TRUE
.head 3 +  Function: chkBnkDt
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  Date/Time: rpt_dt
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Date/Time: sys_dt
.head 5 -  Date/Time: lmt_dt
.head 4 +  Actions
.head 5 -  Set sys_dt = SalDateCurrent()
.head 5 -  Set lmt_dt = SalDateConstruct ( 2017, 12, 15, 0, 0, 0 )
.head 5 +  If ( ( sys_dt > lmt_dt ) and ( rpt_dt > lmt_dt ) )
.head 6 -  Call SalMessageBox( 'Заборонено формувати файли за дату білшу від ' || SalFmtFormatDateTime(lmt_dt,'dd/MM/yyyy'), 'Помилка', MB_IconStop )
.head 6 -  Return FALSE
.head 5 +  Else
.head 6 -  Return TRUE
.head 2 +  Window Parameters
.head 3 -  Number: nRunMode
.head 3 -  ! Режим работы:
.head 3 -  ! 0 - Отчетность НБУ
.head 3 -  ! 1 - Внутренняя отчетность банка
.head 3 -  ! ... - далее посмотрим
.head 3 -  Number: nParRep
.head 3 -  ! Доступ:
.head 3 -  ! 0 - Собственный + Консолидированый отчет
.head 3 -  ! 1 - Собственный отчет
.head 3 -  ! 2 - Консолидированый отчет
.head 2 +  Window Variables
.head 3 -  : C
.head 4 -  Class: cABSConnect
.head 3 -  : CT
.head 4 -  Class: cABSConnect
.head 3 -  : cQ
.head 4 -  Class: cGenQuery
.head 3 -  : cF
.head 4 -  Class: cGenFilter
.head 3 -  : TRepMenu
.head 4 -  Class: cChildMenuEngine
.head 3 -  String: sBANKTYPE
.head 3 -  !
.head 3 -  Number: bPROTCN
.head 3 -  String: strTemp
.head 3 -  String: strTblPop
.head 3 -  String: strDSql
.head 3 -  String: sDatMDY		! Дата формирования файла (строка MM/dd/yyyy)
.head 3 -  String: sDatF		! Дата формирования файла (строка dd/MM/yyyy)
.head 3 -  Date/Time: dDatF	! Дата формирования файла
.head 3 -  Date/Time: dDatZ	! Дата загрузки файла
.head 3 -  !
.head 3 -  ! переменные для хранения названий таблиц отчетности. (НБУ/Внутр)
.head 3 -  String: strF00Table
.head 3 -  String: strTRCTable
.head 3 -  String: strTMPTable
.head 3 -  String: strSTCTable
.head 3 -  String: sTraceTable
.head 3 -  String: sFilterTable
.head 3 -  !
.head 3 -  String: strMonth[12]
.head 3 -  String: strWeekDays[7]
.head 3 -  !
.head 3 -  String: Rep_Code
.head 3 -  String: Rep_CodeExt
.head 3 -  String: Rep_EBox
.head 3 -  String: Rep_GCode
.head 3 -  String: Rep_GNum
.head 3 -  String: Rep_MFO
.head 3 -  String: Rep_Msrm
.head 3 -  String: Rep_Path
.head 3 -  String: Rep_Period
.head 3 -  Date/Time: Rep_LDate
.head 3 -  Number: Rep_CQNum
.head 3 -  String: sRep_CQNum 
.head 3 -  String: sCQNumTmp
.head 3 -  Number: nCharNum
.head 3 -  String: Rep_Resident
.head 3 -  String: Rep_ProcName
.head 3 -  String: Rep_Table
.head 3 -  Number: Rep_Action
.head 3 -  String: Rep_FPrefix
.head 3 -  String: Rep_TypeZnap
.head 3 -  Number: Rep_ProcK
.head 3 -  Number: Rep_PrTobo
.head 3 -  String: sProckName
.head 3 -  String: tpf_OTCN
.head 3 -  Boolean: flag_tpf_OTCN
.head 3 -  Number: nNumColInPKey
.head 3 -  String: strSubMFO
.head 3 -  String: strSubMFOList
.head 3 -  Number: nCodeArea
.head 3 -  !
.head 3 -  String: strKey
.head 3 -  String: strVal
.head 3 -  Number: nI
.head 3 -  !
.head 3 -  File Handle: hFile
.head 3 -  Number: nCFile
.head 3 -  String: strFileName
.head 3 -  : FSign
.head 4 -  Class: cSignFile
.head 3 -  Number: nSignBufLen
.head 3 -  ! Long String: lsSign
.head 3 -  String: lsSign
.head 3 -  Number: nlsSign
.head 3 -  String: strSFFKey
.head 3 -  String: strSFFDate
.head 3 -  String: strReportsSignOn
.head 3 -  String: strFondSignOn
.head 3 -  Number: nErrorSign
.head 3 -  !
.head 3 -  Number: nRow
.head 3 -  Number: nCountLine
.head 3 -  Date/Time: dtLastRepDate
.head 3 -  !
.head 3 -  Boolean: fRepNumSet
.head 3 -  Boolean: fRepPopulate
.head 3 -  Boolean: fNeedToReform
.head 3 -  !
.head 3 -  Number: nWinWidth
.head 3 -  Number: nWinHeigh
.head 3 -  !
.head 3 -  Number: nNumCol
.head 3 -  Number: nExclCol
.head 3 -  Number: nZnapCol
.head 3 -  String: sNbuc
.head 3 -  Number: nRowNum
.head 3 -  Number: nColIdErrMsg
.head 3 -  Window Handle: hColWndErrMsg
.head 3 -  Number: nColIdFlMod
.head 3 -  Window Handle: hColWndFlMod
.head 3 -  String: sErrMsg
.head 3 -  Boolean: bCheckProcK
.head 3 -  !
.head 3 -  String: sSqlTxt
.head 3 -  String: sMIsCode[*]
.head 3 -  Number: nDod
.head 3 -  !
.head 3 -  String: strNbuc
.head 3 -  !
.head 3 -  String: strSqlIns
.head 3 -  String: strSqlUpd
.head 3 -  String: strSqlDel
.head 3 -  Number: nCount
.head 3 -  Long String: sXmlRow
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call WaitCursorOn()
.head 4 -  Call XConnectGetParams(C)
.head 4 +  If C.Connect()
.head 5 -  Call CT.Clone(C, TRUE)
.head 5 -  Call SetWindowFullSize(hWndForm)
.head 5 -  Call SetWindowFont(hWndForm)
.head 5 -  Call XSalTooltipSetUserDefault()
.head 5 -  Call TRepMenu.Init(hWndForm, 'menuNBURep', 'Отчетность')
.head 5 -  !
.head 5 -  Set bPROTCN = GetGlobalOption('PROTCN') = '1'
.head 5 -  ! BANKTYPE - банк
.head 5 -  Set sBANKTYPE = GetGlobalOption('BANKTYPE')
.head 5 -  ! Для Аваль собственный отчет с разбивкой по областям (как консолидированный)
.head 5 -  !
.head 5 -  Set fRepNumSet   = FALSE
.head 5 -  Set fRepPopulate = FALSE
.head 5 -  Set bCheckProcK  = FALSE
.head 5 -  !
.head 5 -  Call SalDisableWindow(pbArchive)
.head 5 -  Call SalDisableWindow(pbExecute)
.head 5 -  Call SalDisableWindow(pbInsert)
.head 5 -  Call SalDisableWindow(pbDelete)
.head 5 -  Call SalDisableWindow(pbUpdate)
.head 5 -  Call SalDisableWindow(pbDetPrint)
.head 5 -  Call SalDisableWindow(pbFileStamp)
.head 5 -  Call SalDisableWindow(pb_XML)
.head 5 -  Call SalDisableWindow(pbExists)
.head 5 -  Call SalDisableWindow(pbProtocol)
.head 5 -  Call SalDisableWindow(pbCheck)
.head 5 -  Call SalDisableWindow(pbCheckOnProck)
.head 5 -  Call SalDisableWindow(pbToArc)
.head 5 -  !
.head 5 -  Set dDatF = SalDateCurrent()
.head 5 -  Set sDatF = SalFmtFormatDateTime(dDatF, 'dd/MM/yyyy')
.head 5 -  Set sDatMDY = SalFmtFormatDateTime(dDatF, 'MM/dd/yyyy')
.head 5 -  !
.head 5 +  Select Case nRunMode
.head 6 +  Case 0
.head 7 -  Call SalSetWindowText(hWndForm, 'Звітність НБУ.')
.head 7 -  Set strF00Table = 'KL_F00'
.head 7 -  Set strSTCTable = 'FORM_STRU'
.head 7 -  Set strTMPTable = 'TMP_NBU'
.head 7 -  Set strTRCTable = 'RNBU_TRACE'
.head 7 -  Break
.head 6 +  Case 1
.head 7 -  Call SalSetWindowText(hWndForm, 'Внутрішня Звітність.')
.head 7 +  If GetGlobalOption("BANKTYPE") != 'SBER'
.head 8 -  Call SalDisableWindow(obCommonReport)
.head 7 -  Set strF00Table = 'KL_F00_INT'
.head 7 -  Set strSTCTable = 'FORM_STRU_INT'
.head 7 -  Set strTMPTable = 'TMP_IREP'
.head 7 -  Set strTRCTable = 'RNBU_TRACE'
.head 7 -  Break
.head 6 +  Default
.head 7 -  Call SalMessageBeep(MB_IconStop)
.head 7 -  Call SalMessageBox('Помилковий параметр визову: Режим.', 'Помилка', MB_IconStop | MB_Ok)
.head 7 -  Call SalDestroyWindow(hWndForm)
.head 7 -  Break
.head 5 +  Select Case nParRep
.head 6 +  Case 1
.head 7 -  Set obPersonalReport = TRUE
.head 7 -  Call SalDisableWindow(obCommonReport)
.head 7 -  Break
.head 6 +  Case 2
.head 7 -  Set obCommonReport = TRUE
.head 7 -  Call SalDisableWindow(obPersonalReport)
.head 7 -  Break
.head 6 +  Default
.head 7 -  Break
.head 5 -  Set sTraceTable  = strTRCTable
.head 5 -  !
.head 5 -  Call SalDisableWindow(pbFilter)
.head 5 -  Call SalSetFocus(pbGetReport)
.head 4 +  Else
.head 5 -  Call SalDestroyWindow(hWndForm)
.head 3 +  On SAM_CreateComplete
.head 4 -  Call WaitCursorOff()
.head 3 +  On SAM_Activate
.head 4 -  Call TRepMenu.Enable( wParam )
.head 3 +  On UM_MenuComponentShow
.head 4 -  Call TRepMenu.ShowMenu( wParam, lParam )
.head 3 +  On SAM_Destroy
.head 4 -  Call TRepMenu.Kill(  )
.head 4 -  ! ! ! Disactivation of  function's role, which activated for calling window
.head 4 +  If SalStrTrimX(SalStrUpperX(GetDBMS())) = 'ORACLE'
.head 5 -  Call XRoleUnset(C.hSql(),'ShowFilesNbu(hWndMDI)')
.head 4 -  Call C.Disconnect()
.head 4 -  Call CT.Disconnect()
.head 4 -  Call SalSetFocus( SalParentWindow( hWndForm ) )
.head 3 +  On WM_Size
.head 4 -  Call SalGetWindowSize(hWndForm, nWinWidth, nWinHeigh)
.head 4 -  Call SalSetWindowSize(hWndForm.frm_FilesNbu.tblDta, nWinWidth-0.15, nWinHeigh-1.6)
.head 1 +  Table Window: tbl_FileNbuTrace
.head 2 -  Class: cGenericTable
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Базова виборка формування
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? Class Default
.head 2 -  Visible? Class Default
.head 2 -  Display Settings
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Class Default
.head 3 -  Initial State: Class Default
.head 3 -  Maximizable? Class Default
.head 3 -  Minimizable? Class Default
.head 3 -  System Menu? Class Default
.head 3 -  Resizable? Class Default
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  Class Default
.head 4 -  Width Editable? Class Default
.head 4 -  Height: Class Default
.head 4 -  Height Editable? Class Default
.head 3 -  Font Name: Class Default
.head 3 -  Font Size: Class Default
.head 3 -  Font Enhancement: Class Default
.head 3 -  Text Color: Class Default
.head 3 -  Background Color: Class Default
.head 3 -  View: Class Default
.head 3 -  Allow Row Sizing? Class Default
.head 3 -  Lines Per Row: Class Default
.head 2 -  Memory Settings
.head 3 -  Maximum Rows in Memory: 200000
.head 3 -  Discardable? Class Default
.head 2 -  Description: Просмотр трассы формирования файла отчетности
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Class Default
.head 4 -  Location? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Size: Class Default
.head 4 -  Size Editable? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 3 +  Contents
.head 4 +  Pushbutton: pbIns
.head 5 -  Class Child Ref Key: 33
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDel
.head 5 -  Class Child Ref Key: 34
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbRefresh
.head 5 -  Class Child Ref Key: 35
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbUpdate
.head 5 -  Class Child Ref Key: 36
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 43385
.head 5 -  Class Child Ref Key: 37
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  6.55"
.head 6 -  Begin Y:  -0.036"
.head 6 -  End X:  6.55"
.head 6 -  End Y:  0.429"
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbSearch
.head 5 -  Class Child Ref Key: 38
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbFilter
.head 5 -  Class Child Ref Key: 44
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbPrint	! F5
.head 5 -  Class Child Ref Key: 40
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   2.933"
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 43386
.head 5 -  Class Child Ref Key: 41
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  3.467"
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  3.467"
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbDetails	! F3 - Перегляд документу
.head 5 -  Class Child Ref Key: 39
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   3.6"
.head 6 -  Top:    0.071"
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: F3
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Create
.head 7 -  Set strTip = 'F3-Перегляд документу'
.head 6 +  On SAM_Click
.head 7 +  If nRefColID != -1 and strRef
.head 8 -  Call DocViewContentsEx(hWndMDI, Val(strRef))
.head 4 +  Pushbutton: pbCustomer		! F4 - Картка клієнта
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class: ctb_pbChilds
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   4.033"
.head 6 -  Top:    0.071"
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: F4
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name: \BARS98\RESOURCE\BMP\USER.BMP
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Create
.head 7 -  Set strTip = 'F4-Картка клієнта'
.head 6 +  On SAM_Click
.head 7 +  If nRnkColID != -1 and strRnk
.head 8 +  If SqlPrepareAndExecute(hSql(), "select custtype into :nCustType from customer where rnk = :strRnk") and
   SqlFetchNext(hSql(), nFetchRes)
.head 9 +  Select Case nCustType
.head 10 +  Case 1
.head 11 -  Call EditCustBanks(Val(strRnk), CVIEW_ReadOnly, hWndForm)
.head 11 -  Break
.head 10 +  Case 2
.head 11 -  Call EditCustCorps(Val(strRnk), CVIEW_ReadOnly, hWndForm)
.head 11 -  Break
.head 10 +  Case 3
.head 11 -  Call EditCustPerson(Val(strRnk), CVIEW_ReadOnly, hWndForm)
.head 11 -  Break
.head 10 +  Default
.head 11 -  Break
.head 4 +  Pushbutton: pbAccount			! F6 - Картка рахунку
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class: ctb_pbChilds
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   4.483"
.head 6 -  Top:    0.071"
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: F6
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name: \BARS98\RESOURCE\BMP\BOOK.BMP
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Create
.head 7 -  Set strTip = 'F6-Картка рахунку'
.head 6 +  On SAM_Click
.head 7 +  If colAcc
.head 8 -  Call OperWithAccount(AVIEW_ALL, colAcc, Val(strRnk), ACCESS_READONLY)
.head 4 +  Pushbutton: pbAccHistory		! F7 - Історія рахунку
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class: ctb_pbChilds
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   4.917"
.head 6 -  Top:    0.071"
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: F7
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name: \BARS98\RESOURCE\BMP\BOOKS.BMP
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Create
.head 7 -  Set strTip = 'F7-Історія рахунку'
.head 6 +  On SAM_Click
.head 7 +  If colAcc
.head 8 -  Call Show_Sal_Day_P(colAcc, STRING_Null, NUMBER_Null, GetBankDate(), GetBankDate())
.head 4 +  Pushbutton: pbKd			! F8 - Параметри КД
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class: ctb_pbChilds
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   5.367"
.head 6 -  Top:    0.071"
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: F8
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name: \BARS98\RESOURCE\BMP\VIEW.BMP
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Create
.head 7 -  Set strTip = 'F8-Параметри КД'
.head 6 +  On SAM_Click
.head 7 +  If nNkdColID != -1 and strNkd
.head 8 -  Set nCustType = 0
.head 8 +  If nRnkColID != -1 and strRnk
.head 9 -  Call SqlPrepareAndExecute(hSql(), "select custtype into :nCustType from customer where rnk = :strRnk")
.head 9 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 8 -  Call Sel017с(90, Val(strNkd), nCustType, 0, '', '', '', 0, 0)
.head 4 -  Line
.head 5 -  Resource Id: 7879
.head 5 -  Class Child Ref Key: 0
.head 5 -  Class ChildKey: 0
.head 5 -  Class:
.head 5 -  Coordinates
.head 6 -  Begin X:  5.9"
.head 6 -  Begin Y:  -0.048"
.head 6 -  End X:  5.9"
.head 6 -  End Y:  0.417"
.head 5 -  Visible? Yes
.head 5 -  Line Style: Etched
.head 5 -  Line Thickness: 1
.head 5 -  Line Color: 3D Shadow Color
.head 4 +  Pushbutton: pbExit
.head 5 -  Class Child Ref Key: 42
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   6.017"
.head 6 -  Top:    0.071"
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 43387
.head 5 -  Class Child Ref Key: 43
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTable
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 2 +  Contents
.head 3 +  Column: colTobo
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Відділення
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: String
.head 4 -  Justify: Left
.head 4 -  Width:  2.0"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: colNls
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Номер рахунку
.head 4 -  Visible? Yes
.head 4 -  Editable? Yes
.head 4 -  Maximum Data Length: 20
.head 4 -  Data Type: String
.head 4 -  Justify: Left
.head 4 -  Width:  1.843"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 +  Message Actions
.head 5 +  On SAM_SetFocus
.head 6 -  Set sTmp = MyValue
.head 5 +  On SAM_AnyEdit
.head 6 -  Set MyValue = sTmp
.head 6 -  Call SalTblSetRowFlags(hWndForm, SalTblQueryContext(hWndForm), ROW_Edited, FALSE)
.head 3 +  Column: colCCy
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Вал
юта
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: 3
.head 4 -  Data Type: Number
.head 4 -  Justify: Center
.head 4 -  Width:  0.671"
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: colODate
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Робоча
дата
.head 4 -  Visible? Yes
.head 4 -  Editable? No
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Date/Time
.head 4 -  Justify: Center
.head 4 -  Width:  Default
.head 4 -  Width Editable? Yes
.head 4 -  Format: Date
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 3 +  Column: colAcc
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: ACC
.head 4 -  Visible? No
.head 4 -  Editable? Yes
.head 4 -  Maximum Data Length: Default
.head 4 -  Data Type: Number
.head 4 -  Justify: Left
.head 4 -  Width:  Default
.head 4 -  Width Editable? Yes
.head 4 -  Format: Unformatted
.head 4 -  Country: Default
.head 4 -  Input Mask: Unformatted
.head 4 -  Cell Options
.head 5 -  Cell Type? Standard
.head 5 -  Multiline Cell? No
.head 5 -  Cell DropDownList
.head 6 -  Sorted? Yes
.head 6 -  Vertical Scroll? Yes
.head 6 -  Auto Drop Down? No
.head 6 -  Allow Text Editing? Yes
.head 5 -  Cell CheckBox
.head 6 -  Check Value:
.head 6 -  Uncheck Value:
.head 6 -  Ignore Case? Yes
.head 4 -  List Values
.head 4 -  Message Actions
.head 2 +  Functions
.head 3 +  Function: MakePopulateStringAndColumns
.head 4 -  Description: Создает строку населения таблицы и
раскручивает по колонкам Код показателя и значение
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  : C
.head 6 -  Class: cABSConnect
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strTable
.head 5 -  String: strCond
.head 5 -  String: strCondArc
.head 5 -  String: strFields
.head 5 -  String: strBinds
.head 5 -  Number: nUserId
.head 5 -  Number: nCount
.head 5 -  Number: nColId
.head 5 -  Window Handle: hCol
.head 5 -  !
.head 5 -  Number: nAtr
.head 5 -  String: strColName
.head 5 -  String: strColVal
.head 5 -  String: strIsCode
.head 5 -  Number: nSort
.head 5 -  String: sObl 
.head 5 -  Number: nCountRnk
.head 5 -  Number: nCountNd
.head 5 -  Number: nCountRef
.head 4 +  Actions
.head 5 -  Set nZnapColID = -1
.head 5 -  Set nRefColID  = -1
.head 5 -  Set nRnkColID  = -1
.head 5 -  Set nNkdColID  = -1
.head 5 -  Set strRef     = STRING_Null
.head 5 -  Set strCond    = STRING_Null
.head 5 -  Set strCondArc = IifS(SalStrScan(strTraceTabName,'_ARCH')=-1, "",
    " and " || strFilterTblName || ".kodf ='" || strFCode || "'" ||
    " and " || strFilterTblName || ".datf = " || DateInQuery(SalFmtFormatDateTime(dFDat, 'MM/dd/yyyy')))
.head 5 -  Set strFields = IifS(nHAVETOBO=2, strFilterTblName || ".tobo", "null") || ", " || strFilterTblName || ".acc, " || strFilterTblName || ".nls, " || strFilterTblName || ".kv, " || strFilterTblName || ".odate"
.head 5 -  Set strBinds  = ':hWndForm.tbl_FileNbuTrace.colTobo, :hWndForm.tbl_FileNbuTrace.colAcc, ' || 
    ':hWndForm.tbl_FileNbuTrace.colNls, :hWndForm.tbl_FileNbuTrace.colCCy, :hWndForm.tbl_FileNbuTrace.colODate'
.head 5 -  Set strTable = "( select * from " || strFilterTblName || " ) " || strFilterTblName
.head 5 -  Set sSortItem = STRING_Null
.head 5 -  !
.head 5 -  Set nUserId = GetUserId()
.head 5 -  Set nCount = 6
.head 5 -  !
.head 5 -  Call SqlPrepareAndExecute( C.hSql(), 
T('SELECT natr, name, val, iscode, code_sort 
    INTO :nAtr, :strColName, :strColVal, :strIsCode, :nSort
    FROM ' || strFormStruTabName || '
    WHERE kodf = :strFCode ORDER BY code_sort'))
.head 5 +  While SqlFetchNext( C.hSql(), nFetchRes )
.head 6 +  If SalStrToNumber(strIsCode) != 0
.head 7 -  Set strColName = strColName || PutCrLf() || '(код)'
.head 6 -  Call AddColumn("COL_P" || Str(nAtr), strColName, FALSE, nCount, nColId, strFields,strBinds)
.head 6 +  If SalStrLowerX(strColVal) = 'znap'
.head 7 -  Set nZnapColID = nColId
.head 6 +  If nSort != NUMBER_Null
.head 7 +  If sSortItem != ''
.head 8 -  Set sSortItem = sSortItem || ", "
.head 7 -  Set sSortItem = sSortItem || strColVal
.head 5 -  !
.head 5 +  If nCount = 5
.head 6 -  Return ''
.head 5 +  If sKodObl != STRING_Null
.head 6 -  Set sObl = " AND nbuc= '" || sKodObl || "'"
.head 5 +  Else
.head 6 -  Set sObl = ""
.head 5 -  !
.head 5 +  If sSortItem != ''
.head 6 -  Set sSortItem = sSortItem || ", "
.head 5 -  Set sSortItem = sSortItem || strFilterTblName || ".nls, " || strFilterTblName || ".kv, " || strFilterTblName || ".odate"
.head 5 -  !
.head 5 -  Call SqlPrepareAndExecute(hSql(),
"select sum(decode(rnk, null, 0, 1)),
        sum(decode(nd,  null, 0, 1)),
        sum(decode(ref, null, 0, 1))
   into :nCountRnk, :nCountNd, :nCountRef
   from " || strFilterTblName || "
  where 1=1" || strCondArc ||
        IifS(strCodeItem='', "", " and kodp = :strCodeItem"))
.head 5 -  Call SqlFetchNext(hSql(), nFetchRes)
.head 5 -  !
.head 5 -  Call AddColumn(strFilterTblName || ".rnk", "Реєстр. номер~контрагента", TRUE, nCount, nColId, strFields, strBinds)
.head 5 -  Set nRnkColID = nColId
.head 5 +  If nCountRnk > 0
.head 6 -  Call AddColumn("c.okpo", "ІНН~контрагента", FALSE, nCount, nColId, strFields, strBinds)
.head 6 -  Call AddColumn("c.nmk", "ПІБ (назва)~контрагента", FALSE, nCount, nColId, strFields, strBinds)
.head 6 -  Set strTable = strTable || ", customer c"
.head 6 -  Set strCond  = strCond  || " and " || strFilterTblName || ".rnk = c.rnk(+)"
.head 5 -  !
.head 5 -  Call AddColumn("to_char(" || strFilterTblName || ".mdate, 'dd/mm/yyyy')", "Дата~погашення", TRUE, nCount, nColId, strFields, strBinds)
.head 5 -  !
.head 5 -  Call AddColumn(strFilterTblName || ".isp", "Код відп.~виконавця", TRUE, nCount, nColId, strFields, strBinds)
.head 5 -  !
.head 5 -  Call AddColumn(strFilterTblName || ".nd", "Номер кред.~договору", TRUE, nCount, nColId, strFields, strBinds)
.head 5 -  Set nNkdColID = nColId
.head 5 +  If nCountNd > 0
.head 6 -  Call AddColumn("d.cc_id", "Ід.~договору", FALSE, nCount, nColId, strFields, strBinds)
.head 6 -  Call AddColumn("to_char(d.sdate, 'dd/mm/yyyy')", "Дата~заключення~договору", TRUE, nCount, nColId, strFields, strBinds)
.head 6 -  Call AddColumn("to_char(d.wdate, 'dd/mm/yyyy')", "Дата~завершення~договору", TRUE, nCount, nColId, strFields, strBinds)
.head 6 -  Set strTable = strTable || ", cc_deal d"
.head 6 -  Set strCond  = strCond  || " and " || strFilterTblName || ".nd = d.nd(+)"
.head 5 -  !
.head 5 -  Call AddColumn(strFilterTblName || ".ref", "Номер~документу", TRUE, nCount, nColId, strFields, strBinds)
.head 5 -  Set nRefColID = nColId
.head 5 +  If nCountRef > 0
.head 6 -  Call AddColumn("to_char(o.vdat, 'dd/mm/yyyy')", "Дата~валютування", TRUE, nCount, nColId, strFields, strBinds)
.head 6 -  Call AddColumn("o.dk", "Д/К", TRUE, nCount, nColId, strFields, strBinds)
.head 6 -  Call AddColumn("o.nlsa", "Рахунок-А", FALSE, nCount, nColId, strFields, strBinds)
.head 6 -  Call AddColumn("o.nlsb", "Рахунок-Б", FALSE, nCount, nColId, strFields, strBinds)
.head 6 -  Set strTable = strTable || ", oper o"
.head 6 -  Set strCond  = strCond  || " and " || strFilterTblName || ".ref = o.ref(+)"
.head 5 -  !
.head 5 -  Call AddColumn(strFilterTblName || ".comm", "Коментар", FALSE, nCount, nColId, strFields, strBinds)
.head 5 -  !
.head 5 -  Return 
"SELECT " || strFields || 
"  INTO " || strBinds ||
"  FROM " || strTable ||
" WHERE 1=1 " || sObl || strCond || strCondArc || IifS(strCodeItem='', "", " and " || strFilterTblName || ".kodp = :strCodeItem")
.head 3 +  Function: AddColumn
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  String: strColumn
.head 5 -  String: strColName
.head 5 -  Boolean: bRightJustify
.head 5 -  Receive Number: nCount
.head 5 -  Receive Number: nColId
.head 5 -  Receive String: strFields
.head 5 -  Receive String: strBinds
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  Window Handle: hCol
.head 4 +  Actions
.head 5 -  Set strFields  = strFields || ", " || strColumn
.head 5 -  Set strBinds   = strBinds  || ", " || ":hWndForm.tbl_FileNbuTrace#" || SalNumberToStrX(nCount, 0)
.head 5 -  Set strColName = VisStrSubstitute(strColName, '~', PutCrLf())
.head 5 -  Set nColId = SalTblCreateColumn(hWndForm, nCount, 1.5, 25, strColName)
.head 5 -  Set hCol   = SalTblGetColumnWindow(hWndForm, nColId, COL_GetID)
.head 5 -  Call SalTblSetColumnFlags(hCol, COL_Editable, FALSE)
.head 5 +  If bRightJustify
.head 6 -  Call SalTblSetColumnFlags(hCol, COL_RightJustify, TRUE)
.head 5 -  Set nCount = nCount+1
.head 5 -  Return TRUE
.head 2 +  Window Parameters
.head 3 -  String: strTraceTabName
.head 3 -  String: strFormStruTabName
.head 3 -  String: strFCode 
.head 3 -  Date/Time: dFDat
.head 3 -  String: strCodeItem
.head 3 -  String: sKodObl
.head 3 -  String: sTypeZnap
.head 2 +  Window Variables
.head 3 -  String: sBANKTYPE
.head 3 -  Number: nHAVETOBO
.head 3 -  : Trace
.head 4 -  Class: cABSConnect
.head 3 -  ! cGenFilter: cTDocF
.head 3 -  String: sSortItem
.head 3 -  String: sDFilter
.head 3 -  Number: nZnapColID
.head 3 -  Number: nRefColID
.head 3 -  Number: nRnkColID
.head 3 -  Number: nNkdColID
.head 3 -  String: strRef
.head 3 -  String: strRnk
.head 3 -  String: strNkd
.head 3 -  Number: nCustType
.head 3 -  Number: nCount
.head 3 -  ! Number: nCurRow
.head 3 -  ! Window Handle: hCurCol
.head 3 -  String: sTmp
.head 3 -  String: sUserTblName
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call XConnectGetParams( Trace )
.head 4 +  If NOT Trace.Connect()
.head 5 -  Return FALSE
.head 4 -  Set nFlags = GT_NoRet | GT_ReadOnly
.head 4 -  Call PrepareWindowEx(hWndForm)
.head 4 -  Call SetWindowFullSize(hWndForm)
.head 4 -  ! BANKTYPE - банк
.head 4 -  Set sBANKTYPE = GetGlobalOption('BANKTYPE')
.head 4 -  Set nHAVETOBO = GetGlobalOptionEx('HAVETOBO')
.head 4 +  If nHAVETOBO != 2
.head 5 -  Call SalHideWindow(colTobo)
.head 4 +  If strCodeItem != ''
.head 5 -  Set strTitleAux = 'Показатель ' || strCodeItem
.head 5 -  ! Set strSqlPopulate = strSqlPopulate || " AND kodp = '" || strCodeItem || "'" 
.head 4 -  !
.head 4 -  Set strPrintFileName = 'Reptrace.txt'
.head 4 -  Set strFilterTblName = strTraceTabName
.head 4 +  If SqlPLSQLCommand(hSql(), 'p_formstru(strFCode, strTraceTabName, strFormStruTabName, sUserTblName)')
.head 5 -  Set strFilterTblName = sUserTblName
.head 4 -  ! Set strSqlPopulate = strSqlPopulate || ' ORDER BY '|| sSortItem
.head 4 -  !
.head 4 -  ! Call Debug(strSqlPopulate)
.head 4 -  Call SalDisableWindow(pbDetails)
.head 4 -  Call SalDisableWindow(pbCustomer)
.head 4 -  Call SalDisableWindow(pbAccount)
.head 4 -  Call SalDisableWindow(pbAccHistory)
.head 4 -  Call SalDisableWindow(pbKd)
.head 4 -  !
.head 4 -  Call SalSendClassMessage( SAM_Create, 0, 0 )
.head 4 -  !
.head 4 -  Set strSqlPopulate = MakePopulateStringAndColumns(Trace)
.head 3 +  On SAM_CreateComplete
.head 4 +  If strCodeItem = ''
.head 5 -  Call SalSendMsg( pbFilter, SAM_Click, 0, 0 )
.head 4 -  Call SalSendMsg( hWndForm, UM_Populate, 0, 0 )
.head 3 +  On UM_Populate
.head 4 -  Set nCount = 0
.head 4 -  ! Call SalSendClassMessage(UM_Populate, 0, 0)
.head 4 -  !
.head 4 -  Call SalWaitCursor(TRUE)
.head 4 -  Set sDFilter = cF.GetFilterWhereClause(FALSE)
.head 4 -  Set strDSql = strSqlPopulate || IifS(sDFilter='', "", " and " || sDFilter) || " ORDER BY " || sSortItem
.head 4 -  ! Set strDSql = cQ.GetFullSQLString(cF)
.head 4 -  ! Call BindList.ActivateBinds()
.head 4 -  Call SalTblPopulate(hWndForm, hSql(), strDSql, TBL_FillAll)
.head 4 -  ! Call SalTblSetContext(hWndForm, 0)
.head 4 -  ! Call SalPostMsg(hWndForm, SAM_TblDoDetails, 0, 0)
.head 4 -  Call SalWaitCursor(FALSE)
.head 4 -  !
.head 4 -  Call VisTblAutoSizeColumn(hWndForm, hWndNULL)
.head 4 -  Call SalTblDefineSplitWindow(hWndForm, 1, TBL_Split_Adjustable)
.head 4 -  Call SalTblFetchRow(hWndForm, SalTblInsertRow(hWndForm, TBL_MinSplitRow))
.head 4 -  Call SalTblSetFlagsAnyRows(hWndForm, ROW_New, FALSE, 0, 0)
.head 4 -  Set colNls = 'Всього: ' || Str(nCount)
.head 4 +  If sTypeZnap = 'N' and nZnapColID != -1
.head 5 -  Call SalTblSetColumnText(hWndForm, nZnapColID, Str(SalTblColumnSum(hWndForm, nZnapColID, 0, 0)))
.head 4 -  Call SalTblSetFocusRow(hWndForm, 0)
.head 4 -  Call SalTblSetContext(hWndForm, 0)
.head 4 -  Call SalPostMsg(hWndForm, SAM_TblDoDetails, 0, 0)
.head 3 +  On SAM_FetchRowDone
.head 4 -  Set nCount = nCount + 1
.head 3 +  On SAM_TblDoDetails
.head 4 +  If sBANKTYPE != 'AVAL'
.head 5 +  If nRefColID != -1
.head 6 -  Call SalTblGetColumnText(hWndForm, nRefColID, strRef)
.head 6 +  If strRef
.head 7 -  Call SalEnableWindow(pbDetails)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbDetails)
.head 5 +  If nRnkColID != -1
.head 6 -  Call SalTblGetColumnText(hWndForm, nRnkColID, strRnk)
.head 6 +  If strRnk
.head 7 -  Call SalEnableWindow(pbCustomer)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbCustomer)
.head 5 +  If nNkdColID != -1
.head 6 -  Call SalTblGetColumnText(hWndForm, nNkdColID, strNkd)
.head 6 +  If strNkd
.head 7 -  Call SalEnableWindow(pbKd)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbKd)
.head 5 +  If colAcc
.head 6 -  Call SalEnableWindow(pbAccount)
.head 6 -  Call SalEnableWindow(pbAccHistory)
.head 5 +  Else
.head 6 -  Call SalDisableWindow(pbAccount)
.head 6 -  Call SalDisableWindow(pbAccHistory)
.head 3 +  On UM_Print
.head 4 -  ! Для файла A7 печатаем ACC
.head 4 +  If strFCode = 'A7'
.head 5 -  Call SalShowWindow(colAcc)
.head 4 -  Call SalSendClassMessage(UM_Print, 0, 0)
.head 4 +  If strFCode = 'A7'
.head 5 -  Call SalHideWindow(colAcc)
.head 3 +  On SAM_Destroy
.head 4 +  If Trace.IsConnected()
.head 5 -  Call Trace.Disconnect()
.head 4 -  Call SalSendClassMessage( SAM_Destroy, 0, 0 )
.head 3 +  ! On SAM_DoubleClick
.head 4 +     If nRefColID != -1 and strRef and sBANKTYPE != 'AVAL'
.head 5 -     Call DocViewContentsEx(hWndMDI, Val(strRef))
.head 3 +  ! On SAM_SetFocus
.head 4 -     Call SalTblQueryFocus(hWndForm, nCurRow, hCurCol)
.head 4 -     Call SalGetWindowText(hCurCol, sTmp, SalGetMaxDataLength(hCurCol))
.head 3 +  ! On SAM_AnyEdit
.head 4 -     Call SalSetWindowText(hCurCol, sTmp)
.head 4 -     Call SalTblSetRowFlags(hWndForm, SalTblQueryContext(hWndForm), ROW_Edited, FALSE)
.head 1 +  Dialog Box: dlg_GetReportForm
.head 2 -  Class: cGenericTableDlg
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Форми звітності
.head 2 -  Accesories Enabled? Class Default
.head 2 -  Visible? Class Default
.head 2 -  Display Settings
.head 3 -  Display Style? Class Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Class Default
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  10.733"
.head 4 -  Width Editable? Class Default
.head 4 -  Height: 6.536"
.head 4 -  Height Editable? Class Default
.head 3 -  Absolute Screen Location? Class Default
.head 3 -  Font Name: Class Default
.head 3 -  Font Size: Class Default
.head 3 -  Font Enhancement: Class Default
.head 3 -  Text Color: Class Default
.head 3 -  Background Color: Class Default
.head 2 -  Description: Получить номер формы отчета
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Class Default
.head 4 -  Location? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Size: Class Default
.head 4 -  Size Editable? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 3 +  Contents
.head 4 +  Pushbutton: pbIns
.head 5 -  Class Child Ref Key: 11
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDel
.head 5 -  Class Child Ref Key: 12
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbRefresh
.head 5 -  Class Child Ref Key: 20
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbUpdate
.head 5 -  Class Child Ref Key: 15
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 7679
.head 5 -  Class Child Ref Key: 19
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbSearch
.head 5 -  Class Child Ref Key: 13
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbFilter
.head 5 -  Class Child Ref Key: 23
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbPrint
.head 5 -  Class Child Ref Key: 14
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 7680
.head 5 -  Class Child Ref Key: 21
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbOk
.head 5 -  Class Child Ref Key: 16
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbExit
.head 5 -  Class Child Ref Key: 17
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 7681
.head 5 -  Class Child Ref Key: 22
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 2 +  Contents
.head 3 +  Child Table: tbl
.head 4 -  Class Child Ref Key: 8
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cGenericTableDlg
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  10.617"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 5.548"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  View: Class Default
.head 5 -  Allow Row Sizing? Class Default
.head 5 -  Lines Per Row: Class Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Class Default
.head 5 -  Discardable? Class Default
.head 4 +  Contents
.head 5 +  Column: colPrefix
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Префикс
формы
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 1
.head 6 -  Data Type: String
.head 6 -  Justify: Right
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colCodeForm
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Код
форми
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 2
.head 6 -  Data Type: String
.head 6 -  Justify: Right
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colCodeScheme
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Код схеми
надання
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 1
.head 6 -  Data Type: String
.head 6 -  Justify: Center
.head 6 -  Width:  1.717"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colCodePeriod
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Періодич
ність
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 1
.head 6 -  Data Type: String
.head 6 -  Justify: Center
.head 6 -  Width:  1.033"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colFormName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Назва форми
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  5.967"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 -  Message Actions
.head 2 +  Functions
.head 3 +  Function: ReturnValue
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Number: nRes
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 -  Local variables
.head 4 +  Actions
.head 5 -  Set strReport = tbl.colCodeForm
.head 5 -  Set strSchema = tbl.colCodeScheme
.head 5 -  Set strName   = tbl.colFormName
.head 5 -  Return 1
.head 2 +  Window Parameters
.head 3 -  String: strF00Table
.head 3 -  Receive String: strReport
.head 3 -  Receive String: strSchema
.head 3 -  Receive String: strName
.head 3 -  Number: nMode
.head 2 +  Window Variables
.head 3 -  String: sSecureWhere
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalWaitCursor( TRUE )
.head 4 -  Call SalCenterWindow( hWndForm )
.head 4 -  Set dlg_GetReportForm.nFlags = GT_ReadOnly
.head 4 -  Set sSecureWhere = ''
.head 4 +  Select Case nMode
.head 5 +  Case 0	! отчетность НБУ
.head 6 +  If EnhancedSecurity()
.head 7 -  Set sSecureWhere = 
" WHERE (kodf, a017) IN 
        (SELECT kodf, a017 FROM staff_klf00
          WHERE NVL(approve,0)=1 AND date_is_valid(adate1,adate2,rdate1,rdate2)=1 
               AND (id=USER_ID OR id IN 
                      (SELECT id_whom FROM staff_substitute                           
                        WHERE id_who=USER_ID AND 
                              date_is_valid(date_start, date_finish, NULL, NULL)='1'))
                   )"
.head 6 +  Else
.head 7 -  Set sSecureWhere = " WHERE (kodf, a017) IN 
                         (SELECT kodf, a017 FROM staff_klf00
                           WHERE id=USER_ID OR id IN 
                                   (SELECT id_whom FROM staff_substitute                           
                                    WHERE id_who=USER_ID )
                       ) "
.head 6 -  !
.head 6 -  Break
.head 5 +  Default
.head 6 -  Break
.head 4 -  Set dlg_GetReportForm.strSqlPopulate = 
"SELECT unique kodf, a017, period, semantic 
 INTO :colCodeForm, :colCodeScheme, :colCodePeriod, :colFormName 
 FROM " || strF00Table || sSecureWhere || " ORDER BY 1, 2, 3"
.head 4 -  Call SalSendClassMessage( SAM_Create, wParam, lParam )
.head 1 +  Dialog Box: dlg_Ask
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Консолидация
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? No
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   0.54"
.head 4 -  Top:    0.317"
.head 4 -  Width:  11.786"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 5.656"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Доступные к консолидации филиалы.
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Etched
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: 0.427"
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Group Box: Все филиалы 
.head 4 -  Resource Id: 18983
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.043"
.head 5 -  Top:    0.01"
.head 5 -  Width:  5.786"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 4.719"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: 10
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Child Table: tblAllMFO
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.114"
.head 6 -  Top:    0.25"
.head 6 -  Width:  5.629"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 4.4"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: 8
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: 3D Shadow Color
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Default
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colMFO
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: МФО
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 9
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.914"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colBanksName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Наименование Филиала
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.486"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strSql = 
'select mfo, translate (nb,\'Ўў•\', \'Іії\') into :colMFO, :colBanksName
    from v_branch order by mfo'
.head 6 -  Call SalTblPopulate ( tblAllMFO, Validate.hSql (), strSql, TBL_FillAll)
.head 5 +  On SAM_SetFocus
.head 6 -  Call SalDisableWindow( pbDelete )
.head 3 -  Group Box: Филиалы, включенные в консолидацию 
.head 4 -  Resource Id: 18984
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   5.843"
.head 5 -  Top:    0.01"
.head 5 -  Width:  5.786"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 4.719"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: 10
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Child Table: tblPresentMFO
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   5.929"
.head 6 -  Top:    0.25"
.head 6 -  Width:  5.629"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 4.4"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Default
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colMFO
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: МФО
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 9
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  0.929"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colBanksName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Наименование Филиала
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.514"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strSql = 
'select r.mfo, translate (f.nb,\'Ўў•\', \'Іії\')
 into 
    :colMFO,
    :colBanksName
 from 
    RNBU_IN_FILES r,
    v_branch f
 where
    substr (r.FILE_NAME, 2,2) = :strRepNum and
    r.last_date = to_char (to_date (:strRepDate, \'dd/mm/yyyy\'), \'ddmmyyyy\') and
    r.mfo = f.mfo order by mfo'
.head 6 -  Call SalTblPopulate ( tblPresentMFO, Validate.hSql (), strSql, TBL_FillAll)
.head 5 +  On SAM_SetFocus
.head 6 -  Call SalEnableWindow( pbDelete )
.head 3 +  Pushbutton: pbImport
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Добавить
.head 4 -  Window Location and Size
.head 5 -  Left:   2.886"
.head 5 -  Top:    4.823"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.448"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Doc_in.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If SalModalDialog( dlg_FileImport, hWndForm, strRepNum, strRepDate  )
.head 7 -  Call SalPostMsg( tblPresentMFO, SAM_Create, 0, 0 ) 
.head 3 +  Pushbutton: pbDelete
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbDelete
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   5.086"
.head 5 -  Top:    4.823"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow( tblPresentMFO, nRow, ROW_Selected, 0 )
.head 7 -  Call SalTblFetchRow( tblPresentMFO, nRow )
.head 7 -  Call SqlPrepareAndExecute( Validate.hSql(), 
'SELECT file_id INTO :nFile_Id FROM rnbu_in_files 
	WHERE substr(file_name,2,2)=:strRepNum AND mfo=:tblPresentMFO.colMFO' )
.head 7 -  Call SqlFetchNext( Validate.hSql(), nFetchRes )
.head 7 +  If nFile_Id != NUMBER_Null
.head 8 -  Call SqlPrepareAndExecute( Validate.hSql(), 'DELETE FROM rnbu_in_inf_records WHERE file_id=:nFile_Id' )
.head 8 -  Call SqlPrepareAndExecute( Validate.hSql(), 'DELETE FROM rnbu_in_files WHERE file_id=:nFile_Id' )
.head 8 -  Call SaveInfoToLog( 'Удаление записей из таблиц консолидации для МФО ' || tblPresentMFO.colMFO || ' и файла #' || strRepNum )
.head 6 -  Call SqlCommit( Validate.hSql() )
.head 6 -  Call SalPostMsg( tblPresentMFO, SAM_Create, 0, 0 )
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Завершить
.head 4 -  Window Location and Size
.head 5 -  Left:   7.286"
.head 5 -  Top:    4.823"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: MS Sans Serif
.head 4 -  Font Size: 8
.head 4 -  Font Enhancement: None
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog ( hWndForm, 0 )
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  String: strRepNum
.head 3 -  String: strRepDate
.head 2 +  Window Variables
.head 3 -  String: strSql
.head 3 -  Number: nRow
.head 3 -  !
.head 3 -  Number: nFile_Id
.head 3 -  !
.head 3 -  : Validate
.head 4 -  Class: cABSConnect
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow ( hWndForm )
.head 4 -  Call SalSetWindowText( hWndForm, 
	'Консолидация: Файл отчетности ' || 
         IifS(strRepNum='AA' OR strRepNum='BB' OR strRepNum='CC' OR strRepNum='LL','F','#') || 
         strRepNum || ', Дата отчета: ' || strRepDate  )
.head 4 -  Call SetWindowFont( hWndForm )
.head 4 -  Call XConnectGetParams ( Validate )
.head 4 -  Call Validate.Connect ()
.head 1 +  Dialog Box: dlg_FileImport
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Импорт файлов-отчетов
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  7.767"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 5.607"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Group Box: Существующие файлы 
.head 4 -  Resource Id: 6419
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.0"
.head 5 -  Top:    0.0"
.head 5 -  Width:  7.617"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 1.952"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: 10
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Child Table: tblFileExists
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.05"
.head 6 -  Top:    0.262"
.head 6 -  Width:  7.483"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 1.595"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Default
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colFileId
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: ID
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colMFO
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: МФО
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 12
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  1.05"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Наименование
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.933"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colFileName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Файл
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 12
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  1.583"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 +  If strRepNum='AA' OR strRepNum='BB' OR strRepNum='CC' OR strRepNum='LL'
.head 7 -  Call SalTblPopulate( hWndItem, cImport.hSql(), 
"SELECT r.file_id, r.mfo, v.nb, r.file_name 
 INTO :colFileId, :colMFO, :colName, :colFileName 
 FROM rnbu_in_files r, v_branch v 
 WHERE v.mfo=r.mfo AND 
       r.file_name like 'F" || strRepNum || "%' AND 
       r.last_date = '" || SalStrMidX( strRepDate, 3, 2 ) || SalStrLeftX( strRepDate, 2) || SalStrRightX( strRepDate, 4 ) || "'", 
TBL_FillAll )
.head 6 +  Else
.head 7 -  Call SalTblPopulate( hWndItem, cImport.hSql(), 
"SELECT r.file_id, r.mfo, v.nb, r.file_name 
 INTO :colFileId, :colMFO, :colName, :colFileName 
 FROM rnbu_in_files r, v_branch v 
 WHERE v.mfo=r.mfo AND 
       r.file_name like '#" || strRepNum || "%' AND 
       r.last_date = '" || SalStrMidX( strRepDate, 3, 2 ) || SalStrLeftX( strRepDate, 2) || SalStrRightX( strRepDate, 4 ) || "'", 
TBL_FillAll )
.head 6 -  ! Call SalTblPopulate( hWndItem, cImport.hSql(), 
"SELECT r.file_id, r.mfo, v.nb, r.file_name 
 INTO :colFileId, :colMFO, :colName, :colFileName 
 FROM rnbu_in_files r, v_branch v 
 WHERE v.mfo=r.mfo AND 
       r.file_name like '#" || strRepNum || "%' AND 
       r.last_date = '" || SalStrLeftX( strRepDate, 2) || SalStrMidX( strRepDate, 3, 2 ) || SalStrRightX( strRepDate, 4 ) || "'", 
TBL_FillAll )
.head 6 -  Call VisTblAutoSizeColumn( hWndItem, colFileName )
.head 5 +  On SAM_SetFocus
.head 6 -  Call SalEnableWindow( pbDelete )
.head 3 -  Group Box: Доступные файлы 
.head 4 -  Resource Id: 48315
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.0"
.head 5 -  Top:    1.976"
.head 5 -  Width:  7.617"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 2.595"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: 10
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Child Table: tblFile4Import
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.05"
.head 6 -  Top:    2.19"
.head 6 -  Width:  7.483"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 2.333"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Default
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colMFO
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: МФО
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 12
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  1.05"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Наименование
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.933"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colFileName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Файл
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 12
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  1.583"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 +  Window Variables
.head 5 -  String: sMFO
.head 5 -  String: sSAB
.head 5 -  String: sNB
.head 5 -  !
.head 5 -  String: sTmpMask
.head 5 -  String: sFiles[*]
.head 5 -  String: sFHAttr[*]
.head 5 -  Number: nFCount
.head 5 -  Number: nI
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SqlPrepareAndExecute( cImport.hSql(), 
'SELECT mfo, sab, nb INTO :sMFO, :sSAB, :sNB FROM v_branch' )
.head 6 -  Call SalTblReset( hWndItem )
.head 6 +  While SqlFetchNext( cImport.hSql(), nFetchRes )
.head 7 -  ! Set sTmpMask = '#' || strRepNum || SalStrMidX( sSAB, 1, 3) ||
GetCharForDigit( SalDateMonth ( SalDateCurrent() )) ||
GetCharForDigit( SalDateDay   ( SalDateCurrent() )) ||
'.*'
.head 7 +  If strRepNum='AA' OR strRepNum='BB' OR strRepNum='CC' OR strRepNum='LL'
.head 8 -  Set sTmpMask = 'F' || strRepNum || SalStrMidX( sSAB, 1, 3) || '??.*'
.head 7 +  Else
.head 8 -  Set sTmpMask = '#' || strRepNum || SalStrMidX( sSAB, 1, 3) || '??.*'
.head 7 -  ! Set sTmpMask = '#' || strRepNum || SalStrMidX( sSAB, 1, 3) || '??.*'
.head 7 -  Set nFCount = VisDosEnumFiles( strDir || '\\' || sTmpMask, 0, sFiles )
.head 7 +  If nFCount > 0
.head 8 -  Set nI = 0
.head 8 +  While nI < nFCount
.head 9 +  If NOT uf_get_fileheader( strDir || '\\' || sFiles[nI], sFHAttr )
.head 10 -  Call SalWaitCursor( TRUE )
.head 9 +  Else
.head 10 -  ! Check the last_date in the interval
.head 10 +  If strRepNum='AA' OR strRepNum='BB' OR strRepNum='CC' OR strRepNum='LL'
.head 11 -  Set nArray=2
.head 10 +  Else
.head 11 -  Set nArray=3
.head 10 +  If sFHAttr[nArray] = SalStrLeftX( strRepDate, 2) || SalStrMidX( strRepDate, 3, 2 ) || SalStrRightX( strRepDate, 4 )
.head 11 -  Set nRow = SalTblInsertRow( hWndItem, TBL_MaxRow )
.head 11 +  If nRow != TBL_Error
.head 12 -  Call SalTblSetRowFlags( hWndItem, nRow, ROW_New, FALSE )
.head 12 -  Call SalTblSetContext( hWndItem, nRow )
.head 12 -  Set colMFO  = sMFO
.head 12 -  Set colName = sNB
.head 12 -  Set colFileName = sFiles[nI]
.head 9 -  Set nI = nI + 1
.head 6 -  Call VisTblAutoSizeColumn( hWndItem, colFileName )
.head 5 +  On SAM_SetFocus
.head 6 -  Call SalDisableWindow( pbDelete )
.head 3 +  Pushbutton: pbDelete
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbDelete
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.067"
.head 5 -  Top:    4.667"
.head 5 -  Width:  1.467"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If SalTblAnyRows( tblFileExists, ROW_Selected, 0 )
.head 7 -  Call SalMessageBeep( MB_IconAsterisk )
.head 7 +  If SalMessageBox( 'Вы хотите удалить отмеченные файлы из системы консолидации?', 'Внимание!', MB_YesNo | MB_IconQuestion ) = IDYES
.head 8 -  Call SalWaitCursor( TRUE )
.head 8 -  Set nRow = TBL_MinRow
.head 8 +  While SalTblFindNextRow( tblFileExists, nRow, ROW_Selected, 0 )
.head 9 -  Call SalTblSetContext( tblFileExists, nRow )
.head 9 +  If SqlPrepareAndExecute ( hSql (), 'delete from RNBU_IN_INF_RECORDS where file_id = :tblFileExists.colFileId' )
.head 10 -  Call SaveInfoToLog( 'Замена файла: Удаление детальных записей файла с id = ' || SalNumberToStrX( tblFileExists.colFileId, 0 ) )
.head 10 +  If SqlPrepareAndExecute ( hSql (), 'delete from RNBU_IN_FILES where file_id = :tblFileExists.colFileId' )
.head 11 -  Call SaveInfoToLog( 'Замена файла: Удаление заголовка файла с id = ' || SalNumberToStrX( tblFileExists.colFileId, 0 ) )
.head 8 -  Call SqlCommitEx( hSql(), 'Удаление импортированных файлов из системы консолидации' )
.head 8 -  Call SalSendMsg( tblFileExists, SAM_Create, 0, 0 )
.head 8 -  Call SalSendMsg( tblFile4Import, SAM_Create, 0, 0 )
.head 8 -  Call SalWaitCursor( FALSE )
.head 3 +  Pushbutton: pbFile
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbDetail
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Файл...
.head 4 -  Window Location and Size
.head 5 -  Left:   1.583"
.head 5 -  Top:    4.667"
.head 5 -  Width:  1.467"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set strBranchPath = strDir
.head 6 -  Call SalDlgOpenFile( hWndForm, 'Импорт файлов отчетности', strFilters, 4, nIndex, strFileName, strBranchPath )
.head 6 +  If strFileName
.head 7 -  Call uf_get_file( strBranchPath, strRepDate)
.head 7 -  Call SalWaitCursor( TRUE )
.head 7 -  Call SalSendMsg( tblFileExists, SAM_Create, 0, 0 )
.head 7 -  Call SalWaitCursor( FALSE )
.head 3 +  Pushbutton: pbAll
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbOk
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Все!
.head 4 -  Window Location and Size
.head 5 -  Left:   3.1"
.head 5 -  Top:    4.667"
.head 5 -  Width:  1.467"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow( tblFile4Import, nRow, 0, 0 )
.head 7 -  Call SalTblFetchRow( tblFile4Import, nRow )
.head 7 -  Call uf_get_file( strDir || '\\' || tblFile4Import.colFileName, strRepDate)
.head 6 -  Call SalWaitCursor( TRUE )
.head 6 -  Call SalSendMsg( tblFileExists, SAM_Create, 0, 0 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 3 +  Pushbutton: pbSelected
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Выбранные
.head 4 -  Window Location and Size
.head 5 -  Left:   4.617"
.head 5 -  Top:    4.667"
.head 5 -  Width:  1.467"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.448"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Select.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Set nRow = TBL_MinRow
.head 6 +  While SalTblFindNextRow( tblFile4Import, nRow, ROW_Selected, 0 )
.head 7 -  Call SalTblFetchRow( tblFile4Import, nRow )
.head 7 -  Call uf_get_file( strDir || '\\' || tblFile4Import.colFileName, strRepDate )
.head 6 -  Call SalWaitCursor( TRUE )
.head 6 -  Call SalSendMsg( tblFileExists, SAM_Create, 0, 0 )
.head 6 -  Call SalWaitCursor( FALSE )
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   6.133"
.head 5 -  Top:    4.667"
.head 5 -  Width:  1.467"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog( hWndForm, 0 )
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  String: strRepNum
.head 3 -  String: strRepDate	! Дата формирования файла (строка MM/dd/yyyy)
.head 2 +  Window Variables
.head 3 -  : cImport
.head 4 -  Class: cABSConnect
.head 3 -  !
.head 3 -  String: strDir
.head 3 -  !
.head 3 -  String: strBranchPath
.head 3 -  String: strFileName
.head 3 -  String: strFilters[4]
.head 3 -  Number: nIndex
.head 3 -  !
.head 3 -  Number: nRow
.head 3 -  Number: nArray
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call XConnectGetParams( cImport )
.head 4 +  If NOT cImport.Connect()
.head 5 -  Call SalEndDialog( hWndForm, 0 )
.head 4 -  Call SalCenterWindow( hWndForm )
.head 4 -  Call PrepareWindow( hWndForm )
.head 4 -  Call SalSetWindowText( hWndForm, 
	'Импорт файлов-отчетов: Файл ' || 
         IifS(strRepNum='AA' OR strRepNum='BB' OR strRepNum='CC' OR strRepNum='LL','F','#') || 
         strRepNum || ', Дата отчета: ' || SalStrMidX( strRepDate, 3, 2 ) || '/' || SalStrLeftX( strRepDate, 2) || '/' || SalStrRightX( strRepDate, 4 )  )
.head 4 -  !
.head 4 -  Call SalUseRegistry(FALSE, '')
.head 4 -  Call SalGetProfileString('Import', 'FileBranch', GetDir()||'\\OTCN\\BRANCHES', strDir, GetIniFileName() )
.head 4 -  !
.head 4 -  Set strFilters[0] = 'Файлы отчетности'
.head 4 +  If strRepNum='AA' OR strRepNum='BB' OR strRepNum='CC' OR strRepNum='LL'
.head 5 -  Set strFilters[1] = 'F*.*'
.head 4 +  Else
.head 5 -  Set strFilters[1] = '#*.*'
.head 4 -  Set strFilters[2] = 'Все файлы'
.head 4 -  Set strFilters[3] = '*.*'
.head 4 -  Set nIndex = 1
.head 4 -  Call SalContextMenuSetPopup( tblFile4Import, 'popupFImpToDo', 0 )
.head 4 -  Call SalContextMenuSetPopup( tblFileExists, 'popupFImpExist', 0 )
.head 3 +  On SAM_CreateComplete
.head 4 -  Call SalWaitCursor( FALSE )
.head 3 +  On SAM_Close
.head 4 -  Call SalEndDialog( hWndForm, 0 )
.head 3 +  On SAM_Destroy
.head 4 +  If cImport.IsConnected(  )
.head 5 -  Call cImport.Disconnect(  )
.head 1 +  Dialog Box: dlg_SpecialReport
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Спец. печать файлов отчетности
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  6.967"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 2.167"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Печать на основе отчетных файлов
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Background Text: Каталог печати:
.head 4 -  Resource Id: 56059
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.083"
.head 5 -  Top:    0.143"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Data Field: dfPrintDir
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   1.667"
.head 6 -  Top:    0.107"
.head 6 -  Width:  5.033"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Highlight Color
.head 5 -  Input Mask: Unformatted
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set MyValue = GetPrnDir()
.head 3 -  Background Text: На основании файла НБУ:
.head 4 -  Resource Id: 56060
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.067"
.head 5 -  Top:    0.524"
.head 5 -  Width:  2.367"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Combo Box: cmbBase
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cGenComboBox_NumId
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Window Location and Size
.head 5 -  Left:   2.517"
.head 5 -  Top:    0.488"
.head 5 -  Width:  4.2"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 1.345"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Editable? Class Default
.head 4 -  String Type: Class Default
.head 4 -  Maximum Data Length: Class Default
.head 4 -  Sorted? Class Default
.head 4 -  Always Show List? Class Default
.head 4 -  Vertical Scroll? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 -  Input Mask: Class Default
.head 4 -  List Initialization
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 +  If cmbBase.Init( hWndItem )
.head 7 -  Call cmbBase.Add( 12, '#12 - отчет по символам кассплана' )
.head 7 -  Call cmbBase.Add( 13, '#13 - отчет по символам кассплана (мес)' )
.head 7 -  Call cmbBase.Add( 32, '#32 - данные о п/о и покупке/продаже вал.')
.head 7 -  Call cmbBase.Add( 92, '#92 - отчет по символам кассплана' )
.head 7 -  Call cmbBase.Add( 93, '#93 - отчет по символам кассплана (мес)' )
.head 7 -  !
.head 7 -  Call cmbBase.SetSelectById( 12 )
.head 3 -  Background Text: За отчетную дату:
.head 4 -  Resource Id: 56061
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.067"
.head 5 -  Top:    0.798"
.head 5 -  Width:  2.367"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Data Field: dfDate
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Date/Time
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   2.517"
.head 6 -  Top:    0.762"
.head 6 -  Width:  1.3"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Center
.head 5 -  Format: Date
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set MyValue = GetBankDate(  )
.head 3 +  Pushbutton: pbPrint
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbPrint
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   1.083"
.head 5 -  Top:    1.226"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalWaitCursor( TRUE )
.head 6 -  Set strReportFile = dfPrintDir || '\\file#' || 
SalStrRightX( '000' || SalNumberToStrX( cmbBase.GetCurrentKey(), 0 ), 3) || '.txt' 
.head 6 -  Call SaveInfoToLog( 'Формирование отчета ' || strReportFile )
.head 6 +  If NOT SalFileOpen( hFile, strReportFile, OF_Text | OF_Write )
.head 7 -  Call SalMessageBeep( MB_IconStop )
.head 7 -  Call SaveErrorToLog( 'Невозможно открыть файл ' || strReportFile )
.head 7 -  Call SalWaitCursor( FALSE )
.head 7 -  Call SalMessageBox( 'Невозможно открыть файл ' || strReportFile, 'Ошибка!', MB_IconStop | MB_Ok )
.head 7 -  Return FALSE
.head 6 -  Call SalFilePutStr( hFile, 'Дата та час друку: ' || SalFmtFormatDateTime( SalDateCurrent(), 'dd/MM/yyyy hhhh:mm'))
.head 6 -  Call SalFilePutStr( hFile, GetBankName() || '   ' || GetBankMfo())
.head 6 -  Call SalFilePutStr( hFile, '')
.head 6 -  !
.head 6 +  If NOT FunPrintDetailString( hFile, cmbBase.GetCurrentKey(), dfDate )
.head 7 -  Call SalWaitCursor( FALSE )
.head 7 -  Call SalFileClose( hFile )
.head 7 -  Call SalFileOpen( hFile, strReportFile, OF_Delete )
.head 7 -  Return FALSE
.head 6 -  !
.head 6 -  Call SalFilePutStr( hFile, '')
.head 6 -  Call SalFilePutStr( hFile, 'Керівник:' )
.head 6 -  Call SalFilePutStr( hFile, '')
.head 6 -  Call SalFilePutStr( hFile, 'Головний бухгалтер:' )
.head 6 -  Call SalFilePutStr( hFile, '')
.head 6 -  Call SalFilePutStr( hFile, 'Відповідальний виконавець:' )
.head 6 -  Call SalFilePutStr( hFile, '')
.head 6 -  !
.head 6 -  Call SalFileClose( hFile )
.head 6 -  Call SalMessageBeep( MB_IconAsterisk )
.head 6 -  Call SaveInfoToLog( 'Файл ' || strReportFile || ' сформирован' )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalMessageBox( 'Файл ' || strReportFile || ' сформирован', 'Отчет', MB_IconAsterisk | MB_Ok )
.head 6 -  !
.head 6 -  Call SalMessageBeep( MB_IconQuestion )
.head 6 +  If SalMessageBox( 'Вывести файл на принтер?', 'Печать', MB_IconQuestion | MB_YesNo ) = IDYES
.head 7 -  Call SaveInfoToLog( 'Печать отчета ' || strReportFile )
.head 7 -  Call DosDirectPrint( strReportFile )
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   4.2"
.head 5 -  Top:    1.202"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SaveInfoToLog( 'Завершение работы функции спец. печати файлов отчетности.' )
.head 6 -  Call SalEndDialog( hWndForm, 0 )
.head 2 +  Functions
.head 3 +  Function: FunPrintDetailString
.head 4 -  Description: Печать детальных строк файла
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 +  Parameters
.head 5 -  File Handle: hF
.head 5 -  Number: nFileId
.head 5 -  Date/Time: dtReport
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: strRepMfo
.head 5 -  String: strRepProc
.head 5 -  !
.head 5 -  String: strItemCode
.head 5 -  String: strItemVal
.head 5 -  String: name_k
.head 5 -  Number: nSumm
.head 5 -  String: strPrevICode
.head 4 +  Actions
.head 5 +  If SqlPrepareAndExecute( hSql(), 'SELECT zzz, p.name INTO :strRepMfo, :strRepProc 
FROM kl_f00 k, rep_proc p WHERE k.procc=p.procc AND kodf=:nFileId' )
.head 6 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 5 -  !
.head 5 -  ! Call F_otcn(SalStrTrimX(SalStrLowerX(strRepProc)), SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' ))
.head 5 +  ! If SqlPrepareAndExecute( hSql(), 'UPDATE tmp_nbu SET nbuc = :strRepMfo WHERE kodf = :nFileId AND datf = ' || 
   DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' )) )
.head 6 -      Call SqlCommit( hSql() )
.head 5 -  !
.head 5 +  If SqlPrepareAndExecute( hSql(), 'SELECT count(*) INTO :nSumm FROM tmp_nbu 
WHERE kodf = :nFileId AND datf = ' || DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' )) )
.head 6 -  Call SqlFetchNext( hSql(), nFetchRes )
.head 5 +  If NOT nSumm
.head 6 -  Call SalMessageBeep( MB_IconStop )
.head 6 -  Call SaveErrorToLog( 'Нет записей для данного файла' )
.head 6 -  Call SalWaitCursor( FALSE )
.head 6 -  Call SalMessageBox( 'Нет записей для данного файла. Сформируйте отчет за указанную дату из функции "Отчетность НБУ"', 'Ошибка!', MB_IconStop | MB_Ok )
.head 6 -  Return FALSE
.head 5 +  Select Case nFileId
.head 6 +  Case 12
.head 7 -  Call SalFilePutStr( hF, 'Показники та значення файлу 12 ф. 747д за ' || 
SalFmtFormatDateTime( dtReport, 'dd/MM/yyyy' ) )
.head 7 -  Call SalFilePutStr( hF, '' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, '| Символ кас. |      Сума      |' )
.head 7 -  Call SalFilePutStr( hF, '|   оборотів  |                |' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, 'Код обл. управління або МФО ' || strRepMfo )
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute( hSql(), 'SELECT kodp, znap INTO :strItemCode, :strItemVal 
FROM tmp_nbu WHERE kodf=:nFileId and datf=' || 
DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' ))  || ' ORDER BY kodp')
.head 8 -  Set strPrevICode = '0'
.head 8 -  Set nSumm = 0
.head 8 +  While SqlFetchNext( hSql(), nFetchRes )
.head 9 +  If SalStrToNumber( strPrevICode ) < 40 AND SalStrToNumber( strItemCode ) >= 40
.head 10 -  Call SalFilePutStr( hF, 'Усього по надходженням' )
.head 10 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 10 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 10 -  Set nSumm = 0
.head 9 -  Call SalFilePutStr( hF, PadL(SalStrTrimX( strItemCode ), 14) || ' ' || PadL( SalNumberToStrX(SalStrToNumber(strItemVal)/100, 2), 16 ))
.head 9 -  Set nSumm = nSumm + SalStrToNumber( strItemVal )
.head 9 -  Set strPrevICode = strItemCode
.head 8 -  Call SalFilePutStr( hF, 'Усього по видаткам' )
.head 8 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 8 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  !
.head 7 -  Break
.head 6 +  Case 13
.head 7 -  Call SalFilePutStr( hF, 'Показники та значення файлу 13 ф. 748 за ' || 
SalFmtFormatDateTime( dtReport, 'dd/MM/yyyy' ) )
.head 7 -  Call SalFilePutStr( hF, '' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, '| Символ кас. |      Сума      |' )
.head 7 -  Call SalFilePutStr( hF, '|   оборотів  |                |' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, 'Код обл. управління або МФО ' || strRepMfo )
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute( hSql(), 'SELECT kodp, znap INTO :strItemCode, :strItemVal 
FROM tmp_nbu WHERE kodf=:nFileId and datf=' || 
DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' ))  || ' ORDER BY kodp')
.head 8 -  Set strPrevICode = '0'
.head 8 -  Set nSumm = 0
.head 8 +  While SqlFetchNext( hSql(), nFetchRes )
.head 9 +  If SalStrToNumber( strPrevICode ) < 40 AND SalStrToNumber( strItemCode ) >= 40
.head 10 -  Call SalFilePutStr( hF, 'Усього по надходженням' )
.head 10 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 10 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 10 -  Set nSumm = 0
.head 9 -  Call SalFilePutStr( hF, PadL(SalStrTrimX( strItemCode ), 14) || ' ' || PadL( SalNumberToStrX(SalStrToNumber(strItemVal)/100, 2), 16 ))
.head 9 -  Set nSumm = nSumm + SalStrToNumber( strItemVal )
.head 9 -  Set strPrevICode = strItemCode
.head 8 -  Call SalFilePutStr( hF, 'Усього по видаткам' )
.head 8 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 8 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  !
.head 7 -  Break
.head 6 +  Case 32
.head 7 -  Call SalFilePutStr( hF, 'Показники та значення файлу 32 ф. 526 за ' || 
SalFmtFormatDateTime( dtReport, 'dd/MM/yyyy' ) )
.head 7 -  Call SalFilePutStr( hF, '' )
.head 7 -  Call SalFilePutStr( hF, '---------------------------------------------------------------------------' )
.head 7 -  Call SalFilePutStr( hF, '| Код  |Код|                    Назва                    |Кiль-|   Сума   |' )
.head 7 -  Call SalFilePutStr( hF, '|валюти|   |                   показника                 |кiсть|          |' )
.head 7 -  Call SalFilePutStr( hF, '---------------------------------------------------------------------------' )
.head 7 -  Call SalFilePutStr( hF, 'Код обл. управління або МФО ' || strRepMfo )
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute( hSql(), 'SELECT kodp, znap INTO :strItemCode, :strItemVal 
FROM tmp_nbu WHERE kodf=:nFileId and datf=' || 
DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' ))  || ' ORDER BY Substr(kodp,2,3)')
.head 8 +  While SqlFetchNext( hSql(), nFetchRes )
.head 9 -  Set name_k = 'название кода показателя'
.head 9 +  If SqlPrepareAndExecute( hSqlAux(), 'SELECT naim INTO :name_k FROM kf32 WHERE 
kod=\'' || SalStrMidX(SalStrTrimX( strItemCode ), 1, 3) || '\'' )
.head 10 -  Call SqlFetchNext( hSqlAux(), nFetchRes )
.head 10 -  Call SalFilePutStr( hF, '   ' || Subs(SalStrTrimX( strItemCode ), 5, 3) || '  ' || 
Subs(SalStrTrimX( strItemCode), 2, 3) || ' ' || 
PadL(SalStrTrimX(name_k),45) || 
IifS(Subs(SalStrTrimX(strItemCode),5,3)='000',PadL(SalStrTrimX(strItemVal), 7),'       ') || 
IifS(Subs(SalStrTrimX(strItemCode),5,3)='000',' ',PadL( SalStrTrimX(strItemVal), 10 )))
.head 8 -  Call SalFilePutStr( hF, '---------------------------------------------------------------------------' )
.head 8 -  !
.head 7 -  Break
.head 6 +  Case 92
.head 7 -  Call SalFilePutStr( hF, 'Показники та значення файлу 92 ф. 747д за ' || 
SalFmtFormatDateTime( dtReport, 'dd/MM/yyyy' ) )
.head 7 -  Call SalFilePutStr( hF, '' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, '| Символ кас. |      Сума      |' )
.head 7 -  Call SalFilePutStr( hF, '|   оборотів  |                |' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, 'Код обл. управління або МФО ' || strRepMfo )
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute( hSql(), 'SELECT kodp, znap INTO :strItemCode, :strItemVal 
FROM tmp_nbu WHERE kodf=:nFileId and datf=' || 
DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' ))  || ' ORDER BY kodp')
.head 8 -  Set strPrevICode = '0'
.head 8 -  Set nSumm = 0
.head 8 +  While SqlFetchNext( hSql(), nFetchRes )
.head 9 +  If SalStrToNumber( strPrevICode ) < 40 AND SalStrToNumber( strItemCode ) >= 40
.head 10 -  Call SalFilePutStr( hF, 'Усього по надходженням' )
.head 10 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 10 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 10 -  Set nSumm = 0
.head 9 -  Call SalFilePutStr( hF, PadL(SalStrTrimX( strItemCode ), 14) || ' ' || PadL( SalNumberToStrX(SalStrToNumber(strItemVal)/100, 2), 16 ))
.head 9 -  Set nSumm = nSumm + SalStrToNumber( strItemVal )
.head 9 -  Set strPrevICode = strItemCode
.head 8 -  Call SalFilePutStr( hF, 'Усього по видаткам' )
.head 8 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 8 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  !
.head 7 -  Break
.head 6 +  Case 93
.head 7 -  Call SalFilePutStr( hF, 'Показники та значення файлу 93 ф. 748 за ' || 
SalFmtFormatDateTime( dtReport, 'dd/MM/yyyy' ) )
.head 7 -  Call SalFilePutStr( hF, '' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, '| Символ кас. |      Сума      |' )
.head 7 -  Call SalFilePutStr( hF, '|   оборотів  |                |' )
.head 7 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  Call SalFilePutStr( hF, 'Код обл. управління або МФО ' || strRepMfo )
.head 7 -  !
.head 7 +  If SqlPrepareAndExecute( hSql(), 'SELECT kodp, znap INTO :strItemCode, :strItemVal 
FROM tmp_nbu WHERE kodf=:nFileId and datf=' || 
DateInQuery( SalFmtFormatDateTime( dtReport, 'MM/dd/yyyy' ))  || ' ORDER BY kodp')
.head 8 -  Set strPrevICode = '0'
.head 8 -  Set nSumm = 0
.head 8 +  While SqlFetchNext( hSql(), nFetchRes )
.head 9 +  If SalStrToNumber( strPrevICode ) < 40 AND SalStrToNumber( strItemCode ) >= 40
.head 10 -  Call SalFilePutStr( hF, 'Усього по надходженням' )
.head 10 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 10 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 10 -  Set nSumm = 0
.head 9 -  Call SalFilePutStr( hF, PadL(SalStrTrimX( strItemCode ), 14) || ' ' || PadL( SalNumberToStrX(SalStrToNumber(strItemVal)/100, 2), 16 ))
.head 9 -  Set nSumm = nSumm + SalStrToNumber( strItemVal )
.head 9 -  Set strPrevICode = strItemCode
.head 8 -  Call SalFilePutStr( hF, 'Усього по видаткам' )
.head 8 -  Call SalFilePutStr( hF, PadL( SalNumberToStrX(nSumm/100, 2), 31 ) )
.head 8 -  Call SalFilePutStr( hF, '--------------------------------' )
.head 7 -  !
.head 7 -  Break
.head 6 +  Default
.head 7 -  Return FALSE
.head 7 -  Break
.head 5 -  !
.head 5 -  Return TRUE
.head 2 -  Window Parameters
.head 2 +  Window Variables
.head 3 -  String: strReportFile
.head 3 -  File Handle: hFile
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call PrepareWindow( hWndForm )
.head 4 -  Call SalCenterWindow( hWndForm )
.head 3 +  On SAM_CreateComplete
.head 4 -  Call SalWaitCursor( FALSE )
.head 1 -  !
.head 1 +  Form Window: winQueryList
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Каталогизированые запросы
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? Yes
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Yes
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Yes
.head 3 -  Minimizable? Yes
.head 3 -  System Menu? Yes
.head 3 -  Resizable? Yes
.head 3 -  Window Location and Size
.head 4 -  Left:   0.08"
.head 4 -  Top:    0.067"
.head 4 -  Width:  12.183"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 6.524"
.head 4 -  Height Editable? Yes
.head 3 -  Form Size
.head 4 -  Width:  Default
.head 4 -  Height: Default
.head 4 -  Number of Pages: Dynamic
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Запуск каталогизированых запросов
.head 2 +  Named Menus
.head 3 +  Menu: menuQuery
.head 4 -  Resource Id: 42596
.head 4 -  Title:
.head 4 -  Description:
.head 4 -  Enabled when:
.head 4 -  Status Text:
.head 4 -  Menu Item Name:
.head 4 +  Menu Item: &Перечитать c фильтром
.head 5 -  Resource Id: 42603
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text: Население списка каталогизированных запросов с наложением фильтра
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalPostMsg( tblQueryList, SAM_Create, 0, 0 )
.head 5 -  Menu Item Name:
.head 4 +  Menu Item: &Выполнить
.head 5 -  Resource Id: 42597
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text: Населить таблицу результатом выполнения выбранного каталогизированного запроса
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Set sCatQueryResult=''
.head 6 -  Set hCatQueryTbl=tblResult
.head 6 -  Call ExportCatQuery( tblQueryList.colKODZ, '', 99, '', TRUE )
.head 6 -  Set fPopulate=SalTblAnyRows( tblResult, 0, 0 )
.head 5 -  Menu Item Name:
.head 4 +  Popup Menu: &Экспорт
.head 5 -  Resource Id: 42598
.head 5 -  Enabled when:
.head 5 -  Status Text: Экспорт запросов
.head 5 -  Menu Item Name:
.head 5 +  Menu Item: Файл - таблица (*.txt, *.xls, *.doc)
.head 6 -  Resource Id: 42599
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Выгрузка содержимого населенной таблицы в выбраный формат
.head 6 +  Menu Settings
.head 7 -  Enabled when: fPopulate
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call TablePrint( tblResult, tblQueryList.colQName, 
GetPrnDir() || '\\' || hWndForm.winQueryList.tblQueryList.colQRFile, '' )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Текстовый файл с разделителем (*.txt)
.head 6 -  Resource Id: 42600
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Выгрузка содержимого населенной таблицы в текстовый файл с разделителями
.head 6 +  Menu Settings
.head 7 -  Enabled when: fPopulate
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 +  If not tblQueryList.colQRFile
.head 8 -  ! Call SalMessageBox( 'Не задано имя файла результата!
Задайте его и повторите экспорт.', 'Ошибка', MB_Ok | MB_IconStop )
.head 8 -  Call SalMessageBox( CurrentLangTable.GetAtomTitle('winQueryList.cTErrFileName'), 
  CurrentLangTable.GetAtomTitle('cTErr'), MB_Ok | MB_IconStop )
.head 8 -  Return FALSE
.head 7 -  Call Table_TXT(hWndForm.winQueryList.tblResult, '', 
GetPrnDir() || '\\' || hWndForm.winQueryList.tblQueryList.colQRFile, '' )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Файл *.dbf (DOS кодировка)
.head 6 -  Resource Id: 8460
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Экспорт в dbf файл с кодировкой строк CP866
.head 6 +  Menu Settings
.head 7 -  Enabled when:
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call ExportCatQuery( tblQueryList.colKODZ, tblQueryList.colQRFile, 1, '', TRUE )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Файл *.dbf (Windows кодировка)
.head 6 -  Resource Id: 8461
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Экспорт в dbf файл с кодировкой строк Win1251
.head 6 +  Menu Settings
.head 7 -  Enabled when:
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call ExportCatQuery( tblQueryList.colKODZ, tblQueryList.colQRFile, 2, '', TRUE )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Отчет (*.txt)
.head 6 -  Resource Id: 42779
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Экспорт в отчет *.txt по шаблону
.head 6 +  Menu Settings
.head 7 -  Enabled when: fHasReport
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call ExportCatQuery( tblQueryList.colKODZ, tblQueryList.colQRFile, 3, '', TRUE )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Отчет (*.rtf)
.head 6 -  Resource Id: 32653
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Экспорт в отчет *.rtf по шаблону
.head 6 +  Menu Settings
.head 7 -  Enabled when: fHasReport
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call ExportCatQuery( tblQueryList.colKODZ, '', 6, '', TRUE )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Напрямую в MS Excel
.head 6 -  Resource Id: 29590
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Выгрузка напрямую в MS Excel без населения таблицы
.head 6 +  Menu Settings
.head 7 -  Enabled when:
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call ExportCatQuery( tblQueryList.colKODZ, '', 8, '', TRUE )
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Напрямую в MS Word
.head 6 -  Resource Id: 29589
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text: Выгрузка напрямую в MS Word без населения таблицы
.head 6 +  Menu Settings
.head 7 -  Enabled when:
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Set sCatQueryResult=''
.head 7 -  Call ExportCatQuery( tblQueryList.colKODZ, '', 9, '', TRUE )
.head 6 -  Menu Item Name:
.head 4 +  Popup Menu: Просмотр/Печать
.head 5 -  Resource Id: 30189
.head 5 -  Enabled when: sCatQueryResult
.head 5 -  Status Text: Просмотр/Печать сформированного отчета
.head 5 -  Menu Item Name:
.head 5 +  Menu Item: Просмотр
.head 6 -  Resource Id: 30191
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text:
.head 6 +  Menu Settings
.head 7 -  Enabled when:
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Call DirectView(sCatQueryResult)
.head 6 -  Menu Item Name:
.head 5 +  Menu Item: Печать
.head 6 -  Resource Id: 30190
.head 6 -  Keyboard Accelerator: (none)
.head 6 -  Status Text:
.head 6 +  Menu Settings
.head 7 -  Enabled when:
.head 7 -  Checked when:
.head 6 +  Menu Actions
.head 7 -  Call DosDirectPrint(sCatQueryResult)
.head 6 -  Menu Item Name:
.head 4 -  Menu Separator
.head 4 +  Menu Item: В&ыход
.head 5 -  Resource Id: 42602
.head 5 -  Keyboard Accelerator: (none)
.head 5 -  Status Text:
.head 5 +  Menu Settings
.head 6 -  Enabled when:
.head 6 -  Checked when:
.head 5 +  Menu Actions
.head 6 -  Call SalDestroyWindow( hWndForm )
.head 5 -  Menu Item Name:
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? No
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  Child Table: tblQueryList
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.0"
.head 6 -  Top:    0.0"
.head 6 -  Width:  10.7"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 1.427"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: 5000
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colKODZ
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Код
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  0.95"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colKODR
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title:
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  7.429"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colQName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Наименование запроса
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 254
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  7.067"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colQRFile
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Файл результата
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: 254
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  2.571"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colQText
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Текст запроса
.head 6 -  Visible? No
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: 10000
.head 6 -  Data Type: Long String
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colQBindList
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title:
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 4000
.head 6 -  Data Type: Long String
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colCreate_Stmt
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Create Statement
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 4000
.head 6 -  Data Type: Long String
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colReportTemplate
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Create Statement
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 254
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 +  Window Variables
.head 5 -  Number: nUserId
.head 5 -  String: sFiltr
.head 5 -  String: sWhere
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SalSendMsgToChildren( hWndForm, UM_QueryLabelText, 0, 0 )
.head 6 -  Set nUserId = GetUserId(  )
.head 6 -  Set strParams = ''
.head 6 -  ! Set Long Bind
.head 6 -  ! Call SqlSetLongBindDatatype( 3, 22 )
.head 6 -  ! Call SqlSetLongBindDatatype( 4, 22 )
.head 6 +  If KODZ != NUMBER_Null
.head 7 -  Set sWhere = 'KODZ=:KODZ'
.head 7 -  Set DebuggingOn = TRUE
.head 7 -  Call SalWaitCursor( TRUE )
.head 7 -  Call SalTblPopulate( tblQueryList, Main.hSql(), 
T("SELECT kodz, kodr, name,namef,bindvars,create_stmt, rpt_template 
   INTO :colKODZ,
        :colKODR,
        :colQName,
        :colQRFile,
        :colQBindList,  
        :colCreate_Stmt,
        :colReportTemplate 
   FROM ZAPROS WHERE KODZ=:KODZ" ), TBL_FillAll )
.head 6 -  !
.head 6 -  !
.head 6 -  ! Номер пользователя -1 - это Все пользователи
.head 6 +  Else If SetQueryFilter( cF ) 
.head 7 -  Set sFiltr = ""
.head 7 -  Set sFiltr = cF.GetFilterWhereClause( FALSE )
.head 7 -  Set sWhere = 
IifS( sFiltr ="", "", sFiltr ||" and ") || 
" kodz in (select kodz from zapros_users where user_id=:nUserId or user_id=-1) 
    and kodz not in (select distinct kodr from zapros where kodr is not null) 
    order by kodz "
.head 7 -  Call SalWaitCursor( TRUE )
.head 7 -  Call SalTblPopulate( tblQueryList, Main.hSql(), 
T("SELECT kodz, kodr, name,namef,bindvars,create_stmt, rpt_template 
   INTO :colKODZ,
        :colKODR,
        :colQName,
        :colQRFile,
        :colQBindList,  
        :colCreate_Stmt,
        :colReportTemplate 
   FROM ZAPROS WHERE " || sWhere ), TBL_FillAll )
.head 6 -  Call SalWaitCursor( FALSE )
.head 5 +  On SAM_DoubleClick
.head 6 -  Set sCatQueryResult=''
.head 6 -  Set hCatQueryTbl=tblResult
.head 6 -  Call ExportCatQuery( tblQueryList.colKODZ, '', 99, '', TRUE )
.head 6 -  Set fPopulate=SalTblAnyRows( tblResult, 0, 0 )
.head 5 +  On SAM_TblDoDetails
.head 6 -  Call SalTblDestroyColumns( tblResult )
.head 6 -  Set fPopulate = FALSE
.head 6 -  Set fHasReport = colReportTemplate OR colKODR
.head 3 +  Data Field: dfBackgroundText
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? No
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.0"
.head 6 -  Top:    1.438"
.head 6 -  Width:  4.2"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.2"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? No
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: 3D Face Color
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Child Table: tblResult
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.0"
.head 6 -  Top:    1.625"
.head 6 -  Width:  10.7"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 3.948"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: 36000
.head 5 -  Discardable? Yes
.head 4 -  Contents
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 +  Message Actions
.head 5 +  On SAM_FetchRowDone
.head 6 -  Set nRSetCount = nRSetCount + 1
.head 6 -  Call SalTblSetRowFlags( hWndItem, lParam, ROW_New, TRUE)
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: KODZ
.head 2 +  Window Variables
.head 3 -  : cF
.head 4 -  Class: cGenFilter
.head 3 -  : Main
.head 4 -  Class: cABSConnect
.head 3 -  : Qr
.head 4 -  Class: cABSConnect
.head 3 -  : QMenu
.head 4 -  Class: cChildMenuEngine
.head 3 -  : Par
.head 4 -  Class: cParams
.head 3 -  String: strParams
.head 3 -  !
.head 3 -  Number: nWinWidth
.head 3 -  Number: nWinHeigh
.head 3 -  !
.head 3 -  Number: nFocusRow
.head 3 -  Window Handle: hWndFocusCol
.head 3 -  Number: nRSetCount
.head 3 -  Number: nRSetCol
.head 3 -  !
.head 3 -  : sBinds[32]   ! Список бинд-переменных
.head 4 -  Class: cQueryBind
.head 3 -  !
.head 3 -  Boolean: fPopulate
.head 3 -  !
.head 3 -  String: sModifiedSQL
.head 3 -  Boolean: fModified
.head 3 -  Boolean: fHasReport
.head 3 -  !
.head 3 -  Number: nBindsCount
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SetWindowFont(hWndForm)
.head 4 -  Call SalSendMsgToChildren(hWndForm, UM_QueryLabelText, 0, 0)
.head 4 -  Call SalSetWindowText(hWndForm, CurrentLangTable.GetAtomTitle('winQueryList.cTWndTitle'))
.head 4 -  Call cF.Init('ZAPROS', 'ZAPROS')
.head 4 -  Set sCatQueryResult=''
.head 4 -  Call XConnectGetParams(Main)
.head 4 +  If Main.Connect()
.head 5 -  Call Qr.Clone( Main, TRUE )
.head 5 -  ! Call QMenu.Init( hWndForm, 'menuQuery', 'Запрос' )
.head 5 -  Call QMenu.Init( hWndForm, 'menuQuery', CurrentLangTable.GetAtomTitle('winQueryList.cTMenu') )
.head 5 -  Call SetWindowFullSize( hWndForm )
.head 5 -  Call SetWindowFont( hWndForm )
.head 5 +  If SalStrTrimX( SalStrUpperX( GetDBMS())) = 'ORACLE'
.head 6 -  Call SqlPrepareAndExecute( Main.hSql(), "ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY'")
.head 5 -  ! Set dfBackgroundText = 'Результат запроса:'
.head 5 -  Set dfBackgroundText = CurrentLangTable.GetAtomTitle('winQueryList.cTResult') || ':'
.head 5 -  Set fPopulate = FALSE
.head 5 -  Set fHasReport = FALSE
.head 4 +  Else
.head 5 -  Call SalDestroyWindow( hWndForm )
.head 3 +  On SAM_CreateComplete
.head 4 -  Call SalWaitCursor( FALSE )
.head 4 -  Call SalSendMsg( tblQueryList, SAM_TblDoDetails, 0, 0 )
.head 3 +  On SAM_Activate
.head 4 -  Call QMenu.Enable( wParam )
.head 3 +  On UM_MenuComponentShow
.head 4 -  Call QMenu.ShowMenu( wParam, lParam )
.head 3 +  On WM_Size
.head 4 -  Call SalGetWindowSize( hWndForm, nWinWidth, nWinHeigh )
.head 4 -  Call SalSetWindowSize( hWndForm.winQueryList.tblQueryList, nWinWidth-0.2, nWinHeigh/3 )
.head 4 -  Call SalSetWindowLoc( hWndForm.winQueryList.dfBackgroundText, 0.1, nWinHeigh/3 )
.head 4 -  Call SalSetWindowLoc( hWndForm.winQueryList.tblResult, 0, nWinHeigh/3+0.2 )
.head 4 -  Call SalSetWindowSize( hWndForm.winQueryList.tblResult, nWinWidth-0.2, nWinHeigh*2/3-1 )
.head 3 +  On SAM_Destroy
.head 4 -  Call QMenu.Kill(  )
.head 4 -  Call Qr.Disconnect()
.head 4 -  ! ! ! Disactivation of  function's role, which activated for calling window
.head 4 +  If SalStrTrimX(SalStrUpperX(GetDBMS())) = 'ORACLE'
.head 5 -  Call XRoleUnset(Main.hSql(),'ZAPROS(hWndMDI)')
.head 4 -  Call Main.Disconnect()
.head 4 -  Call ReadCatQueryRegs()
.head 4 -  Call SalSetFocus( SalParentWindow( hWndForm ))
.head 3 -  On SAM_ReportStart
.head 3 -  On SAM_ReportFetchInit
.head 3 +  On SAM_ReportFetchNext
.head 4 +  If SqlFetchNext(hSql(), nFetchRes)
.head 5 -  Return TRUE
.head 4 +  Else
.head 5 -  Return FALSE
.head 3 +  On SAM_ReportFinish
.head 4 -  Call SqlClose( hSql() )
.head 1 +  Table Window: winReportDummy
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title:
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? No
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? No
.head 3 -  Minimizable? No
.head 3 -  System Menu? No
.head 3 -  Resizable? No
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  2.317"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 0.452"
.head 4 -  Height Editable? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 3 -  View: Table
.head 3 -  Allow Row Sizing? No
.head 3 -  Lines Per Row: Default
.head 2 -  Memory Settings
.head 3 -  Maximum Rows in Memory: 1000000
.head 3 -  Discardable? Yes
.head 2 -  Description: Вспомогательное окно обрабатывающее события 
при генерации отчета
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  ! Child Table: tblFakeTable
.head 4 -      Contents 
.head 4 -      Functions 
.head 4 -      Window Variables 
.head 4 -      Message Actions 
.head 2 +  Functions
.head 3 +  Function: GetAttrValue
.head 4 -  Description: Получение значения атрибута
.head 4 +  Returns
.head 5 -  String:
.head 4 +  Parameters
.head 5 -  ! Конект
.head 5 -  Sql Handle: hSql
.head 5 -  ! Имя атрибута
.head 5 -  String: sAttrId
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sAttrSelectSQL
.head 5 -  String: sValue
.head 5 -  Number: nFetchRes
.head 5 -  Number: nValue
.head 4 +  Actions
.head 5 +  If SqlPrepareAndExecute( hSql, '
SELECT SQL_TEXT
INTO :sAttrSelectSQL
FROM ZAPROS_ATTR
WHERE upper(ID)=:sAttrId' )
.head 6 +  If SqlFetchNext( hSql, nFetchRes )
.head 7 -  Call SqlClose( hSql )
.head 7 -  Set sAttrSelectSQL=SalStrTrimX( sAttrSelectSQL )
.head 7 +  If sAttrSelectSQL
.head 8 +  When SqlError
.head 9 -  Call SalMessageBox( 'Ошибка при получении значения переменной ' || sAttrId,
'Ошибка', MB_Ok | MB_IconStop )
.head 8 +  If SqlPrepareAndExecute( hSql,sAttrSelectSQL )
.head 9 +  If SqlFetchNext( hSql, nFetchRes )
.head 10 -  Call SqlClose( hSql )
.head 10 -  Return SalStrTrimX( sValue )
.head 5 -  Return ''
.head 2 +  Window Parameters
.head 3 -  ! Код запроса
.head 3 -  Number: nKODZ
.head 3 -  ! Дата начала
.head 3 -  Date/Time: sDate1
.head 3 -  ! Дата конца
.head 3 -  Date/Time: sDate2
.head 3 -  ! SQL хендлы для получения значений переменных
.head 3 -  Sql Handle: hSqlMain_
.head 3 -  Sql Handle: hSql_
.head 3 -  Sql Handle: hSqlAux_
.head 3 -  ! код печатного отчета
.head 3 -  Number: nReportKod
.head 2 +  Window Variables
.head 3 -  Number: nFetchRes
.head 3 -  : cCnc1
.head 4 -  Class: cABSConnect
.head 3 -  : cCnc2
.head 4 -  Class: cABSConnect
.head 3 -  String: sAttrId
.head 3 -  String: sAttrValue
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalSetWindowLoc( hWndForm, -10, -10 )
.head 4 -  Call SalSetWindowSize( hWndForm, 0, 0 )
.head 4 -  ! Call XConnectGetParams( cCnc1 )
.head 4 -  ! Call cCnc1.Connect()
.head 4 -  ! Call cCnc2.Clone( cCnc1, TRUE )
.head 4 -  ! Set hSql_=cCnc1.hSql()
.head 4 -  ! Set hSqlAux_=cCnc2.hSql()
.head 4 -  Call SalHideWindow( hWndForm )
.head 3 -  On SAM_ReportStart
.head 3 +  On SAM_ReportFetchInit
.head 4 -  Call SalSendMsg( hWndForm, SAM_User, wParam, 0 )
.head 3 +  On SAM_ReportFetchNext
.head 4 +  If SqlFetchNext(hSqlMain_, nFetchRes)
.head 5 -  Set nRowCount=nRowCount+1
.head 5 -  Return TRUE
.head 4 +  Else
.head 5 -  Return FALSE
.head 3 +  On SAM_ReportFinish
.head 4 -  Call SqlClose( hSqlMain_ )
.head 3 +  On SAM_User
.head 4 -  ! Перед началом формирования передаем значения всех переменных
.head 4 -  ! Даты
.head 4 -  ! Call SalMessageBox( SalFmtFormatDateTime( sDate1, 'dd/MM/yyyy' ), 'dat1', MB_Ok )
.head 4 -  ! Call SalMessageBox( SalFmtFormatDateTime( sDate2, 'dd/MM/yyyy' ), 'dat2', MB_Ok )
.head 4 -  Call SalReportSetStringVar( SalNumberToWindowHandle(wParam), 'SDAT1',
	SalFmtFormatDateTime( sDate1, 'dd/MM/yyyy' ) )
.head 4 -  Call SalReportSetStringVar( SalNumberToWindowHandle(wParam), 'SDAT2',
	SalFmtFormatDateTime( sDate2, 'dd/MM/yyyy' ) )
.head 4 -  Call SalReportSetStringVar( SalNumberToWindowHandle(wParam), 'STR_DAT1',
	DateAsPlainUkr2(hSql_, sDate1) )
.head 4 -  Call SalReportSetStringVar( SalNumberToWindowHandle(wParam), 'STR_DAT2',
	DateAsPlainUkr2(hSql_, sDate2) )
.head 4 -  ! Переменные
.head 4 -  ! .NET
.head 4 +  If fDotNetMode
.head 5 +  If SqlPrepareAndExecute( hSql_, "
SELECT UPPER(ATTR_NAME), ATTR_VALUE INTO :sAttrId, :sAttrValue FROM RS_TMP_REPORT_ATTR 
WHERE 
  SESSION_ID = :SESSION_ID
ORDER BY ATTR_NAME" )
.head 6 +  While SqlFetchNext( hSql_, nFetchRes )
.head 7 +  If sAttrValue
.head 8 -  Call SalReportSetStringVar( SalNumberToWindowHandle(wParam), sAttrId, sAttrValue )
.head 6 -  Call SqlClose( hSql_ )
.head 4 -  ! АБС 2 уровня
.head 4 +  Else
.head 5 +  If SqlPrepareAndExecute( hSql_, "
SELECT UPPER(id) INTO :sAttrId FROM ZAPROS_ATTR 
WHERE 
  KODZ IS NULL OR (KODZ IS NOT NULL AND KODZ=:nKODZ)
ORDER BY id" )
.head 6 +  While SqlFetchNext( hSql_, nFetchRes )
.head 7 -  Set sAttrValue=GetAttrValue( hSqlAux_, sAttrId )
.head 7 +  If sAttrValue
.head 8 -  Call SalReportSetStringVar( SalNumberToWindowHandle(wParam), sAttrId, sAttrValue )
.head 6 -  Call SqlClose( hSql_ )
.head 3 +  On SAM_Destroy
.head 4 -  ! Call cCnc1.Disconnect()
.head 4 -  ! Call cCnc2.Disconnect()
.head 1 +  Dialog Box: dlg_BindSet
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Параметры запроса...
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  7.5"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 3.65"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Назначение параметров запроса
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  Child Table: tblBinds
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.1"
.head 6 -  Top:    0.05"
.head 6 -  Width:  7.2"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 2.5"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Default
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colN
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Num
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colBindName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Параметр
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  2.4"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colVal
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Значение
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.0"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 +  Message Actions
.head 7 +  On SAM_AnyEdit
.head 8 +  If B[colN].sDescSQL != ''
.head 9 -  Set colVal = sTmp
.head 9 -  Call SalSendMsg(colVal, SAM_DoubleClick, 0, 0)
.head 7 +  On SAM_Validate
.head 8 -  Set B[colN].sVal = colVal
.head 8 -  Return VALIDATE_Ok
.head 7 -  ! По двойному клику - показать таблицу-справочник для параметра
.head 7 +  On SAM_DoubleClick
.head 8 +  If B[colN].sDescSQL != ''
.head 9 -  Call SalCreateWindow(tbl_BindSQL, hWndForm, 0, B[colN])
.head 7 +  On SAM_SetFocus
.head 8 -  Set sTmp = colVal
.head 4 +  Functions
.head 5 +  ! Function: GetParamsVals
.head 6 -     Description: ! для данного отчета взять информацию по уже вводимым значениям параметров
.head 6 -     Returns 
.head 6 +     Parameters 
.head 7 -     Receive String: sParamdVals[*]
.head 7 -     Number: nReportKod !Номер печатного отчета
.head 6 -     Static Variables 
.head 6 +     Local variables 
.head 7 -     String: sRegisryParamName
.head 7 -     String: sRegisryParamVal
.head 6 +     Actions 
.head 7 -     Call SalUseRegistry(TRUE, GetCompanyName())
.head 7 -     Set sRegisryParamName = SalNumberToStrX(nReportKod, 0)||'_'||GetUserLognName()
.head 7 -  Call Debug('параметр поиска' || sRegisryParam)
.head 7 -     Call SalGetProfileString('reports', sRegisryParamName, '', sRegisryParamVal, GetProductName())
.head 4 +  Window Variables
.head 5 -  Number: nRowNew
.head 5 -  Boolean: fHasParams
.head 5 -  String: sTmp
.head 5 -  ! sParamsVals[1] - значення для першого параметру,(значення через ';;') напр. 2600%;;1;;2560%
.head 5 -  ! ...
.head 5 -  ! sParamsVals[n] - перелік значень для N параметру
.head 5 -  String: sParamsVals[*] ! Вектор параметров уже вводимых знвчений.
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SalSendMsgToChildren( hWndForm, UM_QueryLabelText, 0, 0 )
.head 6 -  Set ni = 0
.head 6 -  Set fHasParams=FALSE
.head 6 +  Loop
.head 7 +  If ni >= nBNum
.head 8 -  Break
.head 7 +  If DebuggingOn AND NOT B[ni].sSemantic
.head 8 -  Set B[ni].sSemantic=B[ni].sName
.head 7 +  If B[ni].sSemantic
.head 8 -  Set nRowNew = SalTblInsertRow( hWndItem, TBL_MaxRow )
.head 8 -  Call SalTblSetRowFlags( hWndItem, nRowNew, ROW_New, FALSE )
.head 8 -  Call SalTblSetContext( hWndItem, nRowNew )
.head 8 -  Set colN = ni
.head 8 -  Set colBindName = B[ni].sSemantic
.head 8 -  Set colVal  = B[ni].sVal
.head 8 +  If NOT fHasParams
.head 9 -  Set fHasParams=TRUE
.head 7 -  Set ni = ni + 1
.head 6 +  If NOT fHasParams
.head 7 -  Call SalEndDialog(dlg_BindSet, 1)
.head 7 -  Return FALSE
.head 6 -  Call SalSetFocus(hWndForm)
.head 6 -  Call SalTblSetFocusRow(hWndForm, 0)
.head 6 -  Call SalTblSetFocusCell(hWndForm, 0, colVal, 0, 0)
.head 6 -  Call SalSendMsg(hWndForm, SAM_TblDoDetails, 0, 0)
.head 5 +  On SAM_TblDoDetails
.head 6 +  If B[colN].sDescSQL != ''
.head 7 -  Call SalEnableWindow(pbRef)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbRef)
.head 3 -  Frame
.head 4 -  Resource Id: 57864
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.1"
.head 5 -  Top:    2.6"
.head 5 -  Width:  7.2"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.7"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: Default
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pbRef
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Справочник
.head 4 -  Window Location and Size
.head 5 -  Left:   0.3"
.head 5 -  Top:    2.7"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.45"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\OPEN.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalSendMsg(tblBinds.colVal, SAM_DoubleClick, 0, 0)
.head 3 +  Pushbutton: pbOk
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Утвердить
.head 4 -  Window Location and Size
.head 5 -  Left:   4.0"
.head 5 -  Top:    2.7"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.452"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Enter
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\APPLY.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog(hWndForm, 1)
.head 3 +  Pushbutton: pbCancel
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Отменить
.head 4 -  Window Location and Size
.head 5 -  Left:   5.6"
.head 5 -  Top:    2.7"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.452"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\DISCARD.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog(hWndForm, 0)
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  : B[*]
.head 4 -  Class: cQueryBind
.head 3 -  Number: nBNum
.head 2 +  Window Variables
.head 3 -  Number: ni
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Call SetWindowFont(hWndForm)
.head 4 -  Call SalSendMsgToChildren(hWndForm, UM_QueryLabelText, 0, 0)
.head 4 -  Call SalSetWindowText(hWndForm, CurrentLangTable.GetAtomTitle('dlg_BindSet.cTWndTitle'))
.head 4 -  Call SalMapEnterToTab(TRUE)
.head 4 -  Call WaitCursorOff()
.head 3 +  On SAM_Destroy
.head 4 -  Call SalMapEnterToTab(FALSE)
.head 4 -  Call WaitCursorOn()
.head 1 +  Dialog Box: dlg_BindSetDat
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Параметры запроса...
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  8.467"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 4.05"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description: Назначение параметров запроса
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Background Text: С даты
.head 4 -  Resource Id: 24247
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.0"
.head 5 -  Top:    0.15"
.head 5 -  Width:  1.2"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Right
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Data Field: bgFrom
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cLabelControl
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Class Default
.head 5 -  Data Type: Class Default
.head 5 -  Editable? Class Default
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   Default
.head 6 -  Top:    Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Justify: Class Default
.head 5 -  Format: Class Default
.head 5 -  Country: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Input Mask: Class Default
.head 4 -  Message Actions
.head 3 +  Custom Control: cCalendarFrom
.data CLASSPROPSSIZE
0000: 4200
.enddata
.data CLASSPROPS
0000: 56543A43616C656E 646172436F6D626F 426F78002B000100 0000010101010000
0020: 0200000001010101 0101000000000000 01000000000A6464 2F4D4D2F79797979
0040: 0000
.enddata
.data INHERITPROPS
0000: 0100
.enddata
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cCalendarDropDown
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   1.3"
.head 6 -  Top:    0.1"
.head 6 -  Width:  2.4"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: 10
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  DLL Settings
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call GetMonthArray(strMonth)
.head 6 -  Call GetWeekDayArray(strWeekDays)
.head 6 -  Call cCalendarFrom.SetMonthText(strMonth)
.head 6 -  Call cCalendarFrom.SetWeekDayText(strWeekDays)
.head 6 -  ! ! - - - - - - - - - - - - Инициализация дат календаря  cCalendarFrom - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  - -
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Sunday,    SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Monday,    SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Tuesday,   SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Wednesday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Thursday,  SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Friday,    SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Saturday,  SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_OneTime, GetBankDate(), DAY_Unset,    SEQ_Unset, COLOR_Blue,  COLOR_Cyan, TRUE)
.head 6 -  Call SqlPrepareAndExecute(hSql(), "select fdat into :dSelect from fdat")
.head 6 -  Set i = 0
.head 6 +  While SqlFetchNext(hSql(), nFetchRes)
.head 7 -  Call cCalendarFrom.SpecialDate(SPECIAL_OneTime, dSelect,  DAY_Unset, SEQ_Unset, COLOR_Blue, COLOR_Cyan, TRUE)
.head 7 -  Set i = i + 1
.head 6 +  If i = 0
.head 7 -  ! Нет доступных дат для выбора
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_BindSetDat.cTMsgDat'),
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 6 -  Call SalSetWindowText(cCalendarFrom,  strBankDate)
.head 3 -  Background Text: По дату
.head 4 -  Resource Id: 24248
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   4.0"
.head 5 -  Top:    0.15"
.head 5 -  Width:  1.2"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Right
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Data Field: bgTo
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cLabelControl
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Class Default
.head 5 -  Data Type: Class Default
.head 5 -  Editable? Class Default
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   Default
.head 6 -  Top:    Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Justify: Class Default
.head 5 -  Format: Class Default
.head 5 -  Country: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Input Mask: Class Default
.head 4 -  Message Actions
.head 3 +  Custom Control: cCalendarTo
.data CLASSPROPSSIZE
0000: 4200
.enddata
.data CLASSPROPS
0000: 56543A43616C656E 646172436F6D626F 426F78002B000100 0000010101010000
0020: 0200000001010101 0101000000000000 01000000000A6464 2F4D4D2F79797979
0040: 0000
.enddata
.data INHERITPROPS
0000: 0100
.enddata
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cCalendarDropDown
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   5.3"
.head 6 -  Top:    0.1"
.head 6 -  Width:  2.4"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: 10
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  DLL Settings
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call GetMonthArray(strMonth)
.head 6 -  Call GetWeekDayArray(strWeekDays)
.head 6 -  Call cCalendarTo.SetMonthText(strMonth)
.head 6 -  Call cCalendarTo.SetWeekDayText(strWeekDays)
.head 6 -  ! ! - - - - - - - - - - - - Инициализация дат календаря  cCalendarTo - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  - -
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Sunday,    SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Monday,    SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Tuesday,   SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Wednesday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Thursday,  SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Friday,    SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_Weekly,  DATETIME_Null, DAY_Saturday,  SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarTo.SpecialDate(SPECIAL_OneTime, GetBankDate(), DAY_Unset,     SEQ_Unset, COLOR_Blue,  COLOR_Cyan, TRUE)
.head 6 -  Call SqlPrepareAndExecute(hSql(), "select fdat into :dSelect from fdat")
.head 6 -  Set i = 0
.head 6 +  While SqlFetchNext(hSql(), nFetchRes)
.head 7 -  Call cCalendarTo.SpecialDate(SPECIAL_OneTime, dSelect,  DAY_Unset, SEQ_Unset, COLOR_Blue, COLOR_Cyan, TRUE)
.head 7 -  Set i = i + 1
.head 6 +  If i = 0
.head 7 -  ! Нет доступных дат для выбора
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('dlg_BindSetDat.cTMsgDat'),
     CurrentLangTable.GetAtomTitle('cTAt'),0)
.head 6 -  Call SalSetWindowText(cCalendarTo, strBankDate)
.head 3 +  Child Table: tblBinds
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.1"
.head 6 -  Top:    0.45"
.head 6 -  Width:  8.167"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 2.5"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: Default
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colN
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Num
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colBindName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Параметр
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.783"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colVal
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class: cColumnLabeled
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Значение
.head 6 -  Visible? Yes
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.617"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 +  Message Actions
.head 7 +  On SAM_AnyEdit
.head 8 +  If cBinds[colN].sDescSQL != ''
.head 9 -  Set colVal = sTmp
.head 9 -  Call SalSendMsg(colVal, SAM_DoubleClick, 0, 0)
.head 7 +  On SAM_Validate
.head 8 -  Set cBinds[colN].sVal = colVal
.head 8 -  Return VALIDATE_Ok
.head 7 -  ! По двойному клику - показать таблицу-справочник для параметра
.head 7 +  On SAM_DoubleClick
.head 8 +  If cBinds[colN].sDescSQL != ''
.head 9 -  Call SalCreateWindow(tbl_BindSQL, hWndForm, 1, cBinds[colN])
.head 7 +  On SAM_SetFocus
.head 8 -  Set sTmp = colVal
.head 4 -  Functions
.head 4 +  Window Variables
.head 5 -  Number: nRowNew
.head 5 -  Boolean: fHasParams
.head 5 -  String: sTmp
.head 5 -  Boolean: bFdat1
.head 5 -  Boolean: bFdat2
.head 5 -  Boolean: bParams
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SalSendMsgToChildren(hWndForm, UM_QueryLabelText, 0, 0)
.head 5 +  On UM_Populate
.head 6 -  Call SalSendMsgToChildren(hWndForm, UM_QueryLabelText, 0, 0)
.head 6 -  Set ni = 0
.head 6 -  Set fHasParams = FALSE
.head 6 -  Set bFdat1  = FALSE
.head 6 -  Set bFdat2  = FALSE
.head 6 -  Set bParams = FALSE
.head 6 +  Loop
.head 7 +  If ni >= nBindsNum
.head 8 -  Break
.head 7 +  If cBinds[ni].sName = ':sFdat1'
.head 8 -  Set bFdat1 = TRUE
.head 8 -  Call SalShowWindowAndLabel(bgFrom)
.head 8 -  Call SalShowWindow(cCalendarFrom)
.head 8 +  If NOT fHasParams
.head 9 -  Set fHasParams=TRUE
.head 7 +  Else If cBinds[ni].sName = ':sFdat2'
.head 8 -  Set bFdat2 = TRUE
.head 8 -  Call SalShowWindowAndLabel(bgTo)
.head 8 -  Call SalShowWindow(cCalendarTo)
.head 8 +  If NOT fHasParams
.head 9 -  Set fHasParams=TRUE
.head 7 +  Else If cBinds[ni].sSemantic
.head 8 -  Set bParams = TRUE
.head 8 -  Set nRowNew = SalTblInsertRow(hWndForm, TBL_MaxRow)
.head 8 -  Call SalTblSetRowFlags(hWndForm, nRowNew, ROW_New, FALSE)
.head 8 -  Call SalTblSetContext(hWndForm, nRowNew)
.head 8 -  Set colN = ni
.head 8 -  Set colBindName = cBinds[ni].sSemantic
.head 8 -  Set colVal = cBinds[ni].sVal
.head 8 +  If NOT fHasParams
.head 9 -  Set fHasParams=TRUE
.head 7 -  Set ni = ni + 1
.head 6 +  If NOT fHasParams
.head 7 -  Call SalEndDialog(dlg_BindSetDat, 1)
.head 7 -  Return FALSE
.head 6 -  !
.head 6 -  Call VisTblAutoSizeColumn(hWndForm, colBindName)
.head 6 -  !
.head 6 +  If bFdat1 and not bFdat2
.head 7 -  Call SalSetWindowLabelText(bgFrom, 'На дату')
.head 7 -  Call SalHideWindowAndLabel(bgTo)
.head 7 -  Call SalHideWindow(cCalendarTo)
.head 6 +  If not bParams
.head 7 -  Call SalHideWindow(hWndForm)
.head 6 -  Call SalSetFocus(hWndForm)
.head 6 -  Call SalTblSetFocusRow(hWndForm, 0)
.head 6 -  Call SalTblSetFocusCell(hWndForm, 0, colVal, 0, 0)
.head 6 -  Call SalSendMsg(hWndForm, SAM_TblDoDetails, 0, 0)
.head 5 +  On SAM_TblDoDetails
.head 6 +  If cBinds[colN].sDescSQL != ''
.head 7 -  Call SalEnableWindow(pbRef)
.head 6 +  Else
.head 7 -  Call SalDisableWindow(pbRef)
.head 3 -  Frame
.head 4 -  Resource Id: 24249
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.1"
.head 5 -  Top:    3.0"
.head 5 -  Width:  8.167"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.7"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: Default
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pbRef
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Справочник
.head 4 -  Window Location and Size
.head 5 -  Left:   0.3"
.head 5 -  Top:    3.1"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.45"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\OPEN.BMP
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalSendMsg(tblBinds.colVal, SAM_DoubleClick, 0, 0)
.head 3 +  Pushbutton: pbOk
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Утвердить
.head 4 -  Window Location and Size
.head 5 -  Left:   5.05"
.head 5 -  Top:    3.071"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.452"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Enter
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\APPLY.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call setXmlParams()
.head 6 -  Call SalEndDialog(hWndForm, 1)
.head 3 +  Pushbutton: pbCancel
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cPushButtonLabeled
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Отменить
.head 4 -  Window Location and Size
.head 5 -  Left:   6.65"
.head 5 -  Top:    3.071"
.head 5 -  Width:  1.5"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: 0.452"
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\DISCARD.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog(hWndForm, 0)
.head 2 +  Functions
.head 3 +  ! Function: GetQueryBindsList
.head 4 -     Description: Получить список бинд переменных запроса (до/переписать)
с установкой
.head 4 +     Returns 
.head 5 -     Number: 
.head 4 +     Parameters 
.head 5 -     String: sParams
.head 5 -     String: sParamsSQL ! Описание SQL для параметра
.head 5 -     : sBinds[*]
.head 4 -     Static Variables 
.head 4 +     Local variables 
.head 5 -     Number: nBNum
.head 5 -     Number: nCount
.head 5 -     String: strBindName
.head 5 -     : P
.head 5 -     : ParamSQL
.head 4 +     Actions 
.head 5 -     Set nBNum = 0
.head 5 -     Call P.Clear( )
.head 5 -     Call ParamSQL.Clear()
.head 5 +     If sParams != ''
.head 6 -     Call P.SetParams(sParams)
.head 5 +     If sParamsSQL != ''
.head 6 -     Call ParamSQL.SetParams(sParamsSQL)
.head 5 -  !
.head 5 -     Set nCount = P.ParamsCount()
.head 5 +     While nBNum < nCount
.head 6 -     Set strBindName = P.ParamName(nBNum)
.head 6 -     Set sBinds[nBNum].sName = strBindName
.head 6 -     Set sBinds[nBNum].sType = 'S'
.head 6 -     Set sBinds[nBNum].sSemantic = P.GetAsString(strBindName)
.head 6 -     Set sBinds[nBNum].sVal = ''
.head 6 +     If ParamSQL.IndexOf(strBindName) > -1
.head 7 -     Set sBinds[nBNum].sDescSQL = ParamSQL.GetAsString(strBindName)
.head 6 +     Else 
.head 7 -     Set sBinds[nBNum].sDescSQL = ''
.head 6 -  !
.head 6 -     Set nBNum = nBNum + 1
.head 5 -     Return nCount
.head 3 +  Function: setXmlParams
.head 4 -  Description:
.head 4 +  Returns
.head 5 -  Boolean:
.head 4 -  Parameters
.head 4 -  Static Variables
.head 4 +  Local variables
.head 5 -  String: sDat
.head 4 +  Actions
.head 5 -  Set lsXmlParams = ''
.head 5 -  Set i = 0
.head 5 +  While i < nBindsNum
.head 6 +  If cBinds[i].sName = ':sFdat1'
.head 7 -  Call SalGetWindowText(cCalendarFrom, sDat, 12)
.head 7 -  Set lsXmlParams = lsXmlParams || '<Param ID="' || cBinds[i].sName || '" Value="' || sDat || '" />'
.head 6 +  Else If cBinds[i].sName = ':sFdat2'
.head 7 -  Call SalGetWindowText(cCalendarTo, sDat, 12)
.head 7 -  Set lsXmlParams = lsXmlParams || '<Param ID="' || cBinds[i].sName || '" Value="' || sDat || '" />'
.head 6 +  Else
.head 7 -  Set lsXmlParams = lsXmlParams || '<Param ID="' || cBinds[i].sName || '" Value="' || cBinds[i].sVal || '" />'
.head 6 -  Set i = i + 1
.head 5 +  If lsXmlParams
.head 6 -  Set lsXmlParams = '<ReportParams>' || lsXmlParams || '</ReportParams>'
.head 5 -  Return TRUE
.head 2 +  Window Parameters
.head 3 -  String: sParams
.head 3 -  Long String: lsBindVars
.head 3 -  Long String: lsDefVars
.head 3 -  Long String: lsBindSql
.head 3 -  Receive Long String: lsXmlParams
.head 2 +  Window Variables
.head 3 -  : cBinds[*]
.head 4 -  Class: cQueryBind
.head 3 -  : cPar
.head 4 -  Class: cParams
.head 3 -  String: sParam
.head 3 -  Number: nBindsNum
.head 3 -  Number: ni
.head 3 -  String: InParam[*]
.head 3 -  Number: i
.head 3 -  Date/Time: dSelect
.head 3 -  !
.head 3 -  String: sBindList
.head 3 -  String: sDefVars
.head 3 -  String: sBindSql
.head 3 -  !
.head 3 -  String: strMonth[12]	!! Наименов. месяце для календаря
.head 3 -  String: strWeekDays[7]	!! Дни недели для календаря

.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Call SetWindowFont(hWndForm)
.head 4 -  Call SalSendMsgToChildren(hWndForm, UM_QueryLabelText, 0, 0)
.head 4 -  Call SalSetWindowText(hWndForm, CurrentLangTable.GetAtomTitle('dlg_BindSetDat.cTWndTitle'))
.head 4 -  Call SalMapEnterToTab(TRUE)
.head 4 -  ! Разбор параметров
.head 4 -  Set sBindList = lsBindVars
.head 4 -  Set sDefVars  = lsDefVars
.head 4 -  Set sBindSql  = lsBindSql
.head 4 -  Set nBindsNum = GetQueryBindsList(sBindList, sBindSql, cBinds)
.head 4 -  ! Установка умолч. значений параметров
.head 4 +  If sDefVars
.head 5 -  Call cPar.SetParams(sDefVars)
.head 5 -  Set i = 0
.head 5 +  While i < nBindsNum
.head 6 +  If cPar.IndexOf(cBinds[i].sName) >= 0
.head 7 -  Set cBinds[i].sVal = cPar.GetAsString(cBinds[i].sName)
.head 7 -  ! Set sBinds[i].sSemantic=sBinds[i].sName
.head 7 +  If At(':sFdat1', cBinds[i].sName) > 0
.head 8 -  Set cBinds[i].sSemantic = VisStrSubstitute(cBinds[i].sName, ':sFdat1', 'Дата с (за)')
.head 7 +  If At(':sFdat2', cBinds[i].sName) > 0
.head 8 -  Set cBinds[i].sSemantic = VisStrSubstitute(cBinds[i].sName, ':sFdat2', 'Дата по')
.head 7 -  ! Call Debug(sBinds[i].sName)
.head 6 -  Set i = i + 1
.head 5 -  Call cPar.Clear()
.head 4 -  ! Добавление параметров переданных в sParams
.head 4 -  Call SalStrTokenize(sParams, '', ',', InParam)
.head 4 -  Set sParam = InParam[4]
.head 4 +  If sParam
.head 5 -  Call cPar.SetParams(sParam)
.head 5 -  Set i = 0
.head 5 +  While i < nBindsNum
.head 6 +  If cPar.IndexOf(cBinds[i].sName) >= 0
.head 7 -  Set cBinds[i].sVal = cPar.GetAsString(cBinds[i].sName)
.head 6 -  Set i = i + 1
.head 4 -  Call WaitCursorOff()
.head 4 -  Call SalSendMsg(tblBinds, UM_Populate, 0, 0)
.head 3 +  On SAM_Destroy
.head 4 -  Call SalMapEnterToTab(FALSE)
.head 1 +  Form Window: frm_Debug
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Тест кат. запросов
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? No
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Yes
.head 3 -  Minimizable? Yes
.head 3 -  System Menu? Yes
.head 3 -  Resizable? Yes
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  9.65"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 3.5"
.head 4 -  Height Editable? Yes
.head 3 -  Form Size
.head 4 -  Width:  Default
.head 4 -  Height: Default
.head 4 -  Number of Pages: Dynamic
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  Data Field: dfCD
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Number
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.817"
.head 6 -  Top:    0.131"
.head 6 -  Width:  2.217"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Data Field: dfFile
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.817"
.head 6 -  Top:    0.381"
.head 6 -  Width:  2.217"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Data Field: dfFormat
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Number
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.817"
.head 6 -  Top:    0.631"
.head 6 -  Width:  2.217"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 +  Data Field: dfParams
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: String
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   3.817"
.head 6 -  Top:    0.881"
.head 6 -  Width:  2.217"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Left
.head 5 -  Format: Unformatted
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 -  Background Text: Код запроса
.head 4 -  Resource Id: 21738
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.417"
.head 5 -  Top:    0.167"
.head 5 -  Width:  3.033"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Background Text: Имя файла для экспорта
.head 4 -  Resource Id: 21739
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.417"
.head 5 -  Top:    0.417"
.head 5 -  Width:  3.017"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Background Text: Формат
.head 4 -  Resource Id: 21740
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.35"
.head 5 -  Top:    0.667"
.head 5 -  Width:  3.017"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Background Text: Параметры
.head 4 -  Resource Id: 21741
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.367"
.head 5 -  Top:    0.917"
.head 5 -  Width:  3.017"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Background Text: Формат:
0-Текст с разделителями 	(пока не реализованно)
1-DBF DOS пересоздает файл
2-DBF WIN пересоздает файл
3-REPORT (*.txt)
4-DBF DOS дописывать в конец существующего файла
5-DBF WIN дописывать в конец существующего файла
6-REPORT (*.rtf)
8-Excel			(пока не реализованно)
9-Word			(пока не реализованно)
.head 4 -  Resource Id: 21742
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.367"
.head 5 -  Top:    1.25"
.head 5 -  Width:  8.583"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 1.774"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Left
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pbExp
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Экспорт
.head 4 -  Window Location and Size
.head 5 -  Left:   6.167"
.head 5 -  Top:    0.143"
.head 5 -  Width:  3.133"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.298"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: None
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call ExportCatQuery( dfCD, dfFile, dfFormat, dfParams, FALSE )
.head 3 +  Pushbutton: pbExpPar
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Экспорт с параметрами
.head 4 -  Window Location and Size
.head 5 -  Left:   6.183"
.head 5 -  Top:    0.476"
.head 5 -  Width:  3.1"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.298"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: (none)
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: None
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call ExportCatQuery( dfCD, dfFile, dfFormat, dfParams, TRUE )
.head 2 -  Functions
.head 2 -  Window Parameters
.head 2 -  Window Variables
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow( hWndForm )
.head 4 -  Set dfCD=110
.head 4 -  Set dfFile='D:\\BARS\\PRINT\\eee'
.head 4 -  Set dfParams=":sDat='18/12/2001'"
.head 4 -  Set dfFormat=3
.head 1 +  Dialog Box: dlg_Archive
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Архів файлів звітності
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? No
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  6.95"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 3.2"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? No
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: 0.548"
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 +  Child Table: tblFileList
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   0.0"
.head 6 -  Top:    0.0"
.head 6 -  Width:  6.9"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 2.2"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  View: Table
.head 5 -  Allow Row Sizing? No
.head 5 -  Lines Per Row: Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: 20000
.head 5 -  Discardable? Yes
.head 4 +  Contents
.head 5 +  Column: colFileName
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Файл
.head 6 -  Visible? No
.head 6 -  Editable? Yes
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.167"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 +  Message Actions
.head 7 -  On SAM_AnyEdit
.head 5 +  Column: colData
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Дата
звіту
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Date/Time
.head 6 -  Justify: Center
.head 6 -  Width:  1.2"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Date
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colFio
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Хто формував
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  3.0"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colDatBlk
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Дата
архівації
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Date/Time
.head 6 -  Justify: Center
.head 6 -  Width:  1.2"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Date
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 +  Window Variables
.head 5 -  String: strFilter
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call SalTblSetTableFlags(tblFileList, TBL_Flag_SingleSelection, TRUE)
.head 6 -  Call SalSendMsg(hWndForm, UM_Populate, 0, 0)
.head 5 +  On UM_Populate
.head 6 -  Call SalTblPopulate(hWndForm, hSql(),
"select kodf, datf, fio, dat_blk
   into :colFileName, :colData, :colFio, :colDatBlk
   from v_otcn_flag_blk
  where kodf = :Rep_Code
    and tp   = :nRMode
  order by datf desc", TBL_FillAll)
.head 6 -  Call SalSetFocus(hWndForm)
.head 6 -  Call SalTblSetFocusRow(hWndForm, 0)
.head 6 -  Call SalTblSetContext(hWndForm, 0)
.head 6 -  Call SalSendMsg(hWndForm, SAM_TblDoDetails, 0, 0)
.head 5 +  On SAM_TblDoDetails
.head 6 +  If colData
.head 7 -  Call SalEnableWindow(pbDelete)
.head 7 -  Call SalEnableWindow(pbOk)
.head 5 +  On SAM_DoubleClick
.head 6 -  Call SalSendMsg(pbOk, SAM_Click, 0, 0)
.head 3 -  !
.head 3 +  Pushbutton: pbDelete
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbDelete
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Видалити
.head 4 -  Window Location and Size
.head 5 -  Left:   2.6"
.head 5 -  Top:    2.3"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If tblFileList.colData
.head 7 +  If SalMessageBox("Вилучити файл " || Rep_Code || " за " || SalFmtFormatDateTime(tblFileList.colData, 'dd.MM.yyyy')  || " з архіву?", "Увага!", MB_IconQuestion | MB_YesNo) = IDYES
.head 8 -  Call SalWaitCursor(TRUE)
.head 8 +  If SqlPLSQLCommand(hSql(), "otc_del_arch(Rep_Code,tblFileList.colData,nRMode)")
.head 9 -  Call SqlCommitEx(hSql(), "Вилучено файл " || Rep_Code || " за " || SalFmtFormatDateTime(tblFileList.colData, 'dd.MM.yyyy')  || " з архіву")
.head 9 -  Call SalSendMsg(tblFileList, UM_Populate, 0, 0)
.head 8 +  Else
.head 9 -  Call SqlRollbackEx(hSql(), "Помилка вилучення файлу " || Rep_Code || " за " || SalFmtFormatDateTime(tblFileList.colData, 'dd.MM.yyyy')  || " з архіву")
.head 8 -  Call SalWaitCursor(FALSE)
.head 3 +  Pushbutton: pbOk
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbOk
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Вибрати
.head 4 -  Window Location and Size
.head 5 -  Left:   4.0"
.head 5 -  Top:    2.3"
.head 5 -  Width:  1.2"
.head 5 -  Width Editable? No
.head 5 -  Height: 0.45"
.head 5 -  Height Editable? No
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\APPLY.BMP
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Вибрати файл'
.head 5 +  On SAM_Click
.head 6 +  If tblFileList.colData
.head 7 -  Set dRetDat = tblFileList.colData
.head 7 -  Call SalEndDialog(hWndForm, TRUE)
.head 6 -  ! Set frm_FilesNbu.Rep_Code = tblFileList.colFileName
.head 6 -  ! Set frm_FilesNbu.dfRepNum = tblFileList.colFileName
.head 6 -  ! Set strTempFName = SalStrTrimX(tblFileList.colFileName)
.head 6 -  ! Set hsqlTemp = hSql()
.head 6 +  ! If SqlPrepareAndExecute(hsqlTemp, "select semantic from kl_f00 into :strFileSem where kodf=:strTempFName")
.head 7 -     Call SqlFetchNext(hsqlTemp, nRez)
.head 6 -  ! Set frm_FilesNbu.dfRepSemantic = strFileSem
.head 6 -  ! Call SalSetWindowText(frm_FilesNbu.calReportDate,
     SalFmtFormatDateTime(SalFmtFormatStrDateTime(tblFileList.colData , 'dd.MM.yyyy'), 'dd/MM/yyyy'))
.head 3 +  Pushbutton: pbExit
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: ctb_pbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Відмінити
.head 4 -  Window Location and Size
.head 5 -  Left:   5.4"
.head 5 -  Top:    2.3"
.head 5 -  Width:  1.2"
.head 5 -  Width Editable? No
.head 5 -  Height: 0.45"
.head 5 -  Height Editable? No
.head 4 -  Visible? Yes
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Picture File Name: \BARS98\RESOURCE\BMP\Discard.bmp
.head 4 -  Picture Transparent Color: Gray
.head 4 -  Image Style: Single
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Set strTip = 'Завершити роботу'
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog(hWndForm, FALSE)
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: nRMode
.head 3 -  String: Rep_Code
.head 3 -  Receive Date/Time: dRetDat
.head 2 +  Window Variables
.head 3 -  String: strFileSem
.head 3 -  String: strTempSql
.head 3 -  Sql Handle: hsqlTemp
.head 3 -  Date/Time: TempDate
.head 3 -  Number: nFocus
.head 3 -  String: strTempFName
.head 3 -  Number: nRez
.head 3 -  Boolean: b
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Call PrepareWindowEx(hWndForm)
.head 4 -  Call SalDisableWindow(pbDelete)
.head 4 -  Call SalDisableWindow(pbOk)
.head 4 -  ! Set strTempSql="SELECT DISTINCT kodf FROM tmp_nbu t order by kodf"
.head 4 -  ! Set strTempSql="SELECT DISTINCT kodf FROM kl_f00 t order by kodf"
.head 4 -  ! Call SalListPopulate (cmb1,hSql(),strTempSql)
.head 4 +  ! If Rep_Code= STRING_Null
.head 5 -     Set cmb1='Все'
.head 4 +  ! Else
.head 5 -     Set cmb1=Rep_Code
.head 4 -  ! Call SalListInsert(cmb1,0,'Все')
.head 4 -  ! Set strTempSql="SELECT DISTINCT to_char(t.datf,'dd.MM.yyyy') FROM tmp_nbu t order by to_date(to_char(t.datf,'dd.MM.yyyy'),'dd.MM.yyyy') "
.head 4 -  ! Set hsqlTemp=hSql()
.head 4 -  ! Call SalListPopulate (cmb2,hsqlTemp,strTempSql)
.head 4 -  ! Call SalListPopulate (cmb3,hsqlTemp,'')
.head 4 +  ! If SalListQueryCount (cmb2)>0
.head 5 -     Set cmb2=SalListQueryTextX (cmb2, SalListQueryCount (cmb3)-5)
.head 5 -     Set cmb3=SalListQueryTextX (cmb3, SalListQueryCount (cmb3)-1)
.head 4 -  ! Call tblFileList.Fill(1)
.head 4 -  ! Call SalWaitCursor ( FALSE )
.head 3 -  ! On SAM_Destroy
.head 1 +  Table Window: tbl_BindSQL
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title:
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Yes
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Yes
.head 3 -  Minimizable? Yes
.head 3 -  System Menu? Yes
.head 3 -  Resizable? Yes
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  8.567"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 3.429"
.head 4 -  Height Editable? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 3 -  View: Table
.head 3 -  Allow Row Sizing? Yes
.head 3 -  Lines Per Row: Default
.head 2 -  Memory Settings
.head 3 -  Maximum Rows in Memory: 30000
.head 3 -  Discardable? Yes
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 -  Contents
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Number: nMode
.head 3 -  : param
.head 4 -  Class: cQueryBind
.head 2 +  Window Variables
.head 3 -  Number: nRow
.head 3 -  Number: i
.head 3 -  String: sParamSql
.head 3 -  !
.head 3 -  String: sReferenceTitle   ! Наименование справочника
.head 3 -  String: sReferenceName    ! Имя таблицы для справочника 
.head 3 -  String: sKeyName  ! Ключ справочника, значение которого пойдет  в значение параметра
.head 3 -  String: sWHEREClause      ! WHERE условие для справочника
.head 3 -  String: sColumnList       ! Список колонок, которые показывать в справочнике
.head 3 -  !
.head 3 -  Number: nTabId            ! Номер таб 
.head 3 -  Number: nKeyColId         ! Номер поля ключа 
.head 3 -  String: sColTitle         ! Наименование колонки
.head 3 -  String: saColTitle[*]     ! Наименование колонки 
.head 3 -  Window Handle: hColumn     
.head 3 -  String: sColName          ! имя колонки таблицы
.head 3 -  Number: nColWidth         ! визуальная ширина колонки 
.head 3 -  Number: naColWidth[*]                       
.head 3 -  Number: nColNum           ! количество колонок 
.head 3 -  !
.head 3 -  String: sTmp   
.head 3 -  : cQ
.head 4 -  Class: cGenQuery
.head 3 -  : cF
.head 4 -  Class: cGenFilter
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Call SetWindowFont(hWndForm)
.head 4 -  Call SalSendMsgToChildren(hWndForm, UM_QueryLabelText, 0, 0)
.head 4 -  !
.head 4 -  ! имя справочника
.head 4 -  Set i = SalStrScan(param.sDescSQL, '|')
.head 4 -  Set sReferenceName = SalStrLeftX(param.sDescSQL, i)
.head 4 -  !
.head 4 -  ! имя ключа, которое должно быть подставлено в параметр(ключ)
.head 4 -  Set sTmp = SalStrRightX(param.sDescSQL, SalStrLength(param.sDescSQL) - i - 1)
.head 4 -  Set i = SalStrScan(sTmp, '|')
.head 4 +  If i < 0
.head 5 -  Set sKeyName = sTmp
.head 4 +  Else
.head 5 -  Set sKeyName = SalStrLeftX(sTmp, i)
.head 5 -  !
.head 5 -  ! список полей
.head 5 -  Set sTmp = SalStrRightX(sTmp, SalStrLength(sTmp) - i - 1)
.head 5 -  Set i = SalStrScan(sTmp, '|')
.head 5 +  If i < 0
.head 6 -  Set sColumnList = sTmp
.head 5 +  Else
.head 6 -  Set sColumnList = SalStrLeftX(sTmp, i)
.head 6 -  !
.head 6 -  ! условие WHERE
.head 6 +  If SalStrLength(sTmp) > SalStrLength(sColumnList)+ 1
.head 7 -  Set sWHEREClause = SalStrRightX(sTmp, SalStrLength(sTmp) - i - 1)
.head 5 -  !
.head 4 -  ! Call Debug('sReferenceName=' || sReferenceName || '  sKeyName=' || sKeyName || ' sColumnList=' || sColumnList ||
     ' sWHEREClause=' || sWHEREClause)
.head 4 -  ! Вытащим наименование справочника
.head 4 -  Set sParamSql = 
"SELECT semantic, tabid  
   INTO :sReferenceTitle, :nTabId 
   FROM meta_tables 
  WHERE tabname = :sReferenceName"
.head 4 +  If SqlPrepareAndExecute(hSql(), sParamSql)
.head 5 +  If SqlFetchNext(hSql(), nRow)
.head 6 -  Call SalSetWindowText(hWndForm, sReferenceTitle)
.head 6 -  Call cF.Init(sReferenceName, sReferenceName)
.head 6 -  Set nColNum = 0
.head 6 -  Set sParamSql = 
"SELECT colname,semantic,showwidth 
   INTO :sColName, :sColTitle, :nColWidth
   FROM meta_columns 
  WHERE tabid = :nTabId " ||
        IifS(sColumnList='', "",
  " AND colname IN ('" || sKeyName || "', '" || StrReplaceChr(sColumnList, ",", "','",0) || "') ") ||
 "ORDER BY showpos"
.head 6 -  ! Call Debug(sParamSql)
.head 6 -  Set nColNum = 0
.head 6 -  ! Вытащим все колонки
.head 6 +  If SqlPrepareAndExecute(hSql(), sParamSql)
.head 7 -  Set sParamSql = ''
.head 7 +  While SqlFetchNext(hSql(), nRow)
.head 8 -  Set sParamSql = sParamSql ||  IifS (sParamSql='', sColName, ', '||sColName)
.head 8 -  Set saColTitle[nColNum] = VisStrSubstitute(sColTitle, '~', PutCrLf())
.head 8 -  Set naColWidth[nColNum] = nColWidth
.head 8 -  ! если єто колонка ключа для параметра - запомнить для нее номер
.head 8 +  If (sColName = sKeyName)
.head 9 -  Set nKeyColId = nColNum + 1
.head 8 -  Set nColNum = nColNum + 1
.head 7 -  Set sParamSql = 'SELECT ' || sParamSql || ' FROM ' || sReferenceName || ' ' || StrReplaceChr(sWHEREClause, '"', "'", 0)
.head 7 +  If not SalTblPopulate(hWndForm, hSql(), sParamSql, TBL_FillAll)
.head 8 -  ! Невозможно выполнить население справочника
.head 8 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('tbl_BindSQL.cTErrNsi'), 
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 7 -  Call cQ.Init(sParamSql)
.head 7 -  !
.head 7 -  Set i = 0
.head 7 +  While i < nColNum
.head 8 -  Set hColumn = SalTblGetColumnWindow(hWndForm, i+1, COL_GetPos)
.head 8 -  Call SalTblSetColumnTitle(hColumn, saColTitle[i])
.head 8 +  If naColWidth[i] != NUMBER_Null
.head 9 -  Call SalTblSetColumnWidth(hColumn, naColWidth[i])
.head 8 +  Else
.head 9 -  Call VisTblAutoSizeColumn(hWndForm, hColumn)
.head 8 -  Call SalTblSetColumnFlags(SalTblGetColumnWindow(hWndForm, i+1, COL_GetID), COL_Editable, FALSE)
.head 8 -  Set i = i + 1
.head 5 +  Else
.head 6 -  ! Справочник sReferenceName не описан в Базе Мета Данных
.head 6 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('tbl_BindSQL.cTNsi') || ' ' || sReferenceName || ' ' || 
     CurrentLangTable.GetAtomTitle('tbl_BindSQL.cTNsiNotBMD'), 
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 6 -  Call SalDestroyWindow(hWndForm)
.head 3 +  On SAM_DoubleClick
.head 4 -  Call SalTblGetColumnText ( hWndForm, nKeyColId, sKeyName )
.head 4 +  If nMode = 0
.head 5 -  Set dlg_BindSet.tblBinds.colVal=sKeyName
.head 4 +  Else
.head 5 -  Set dlg_BindSetDat.tblBinds.colVal=sKeyName
.head 4 -  Set param.sVal=sKeyName
.head 4 -  Call SalDestroyWindow ( hWndForm)
.head 3 +  On WM_RbuttonUp
.head 4 +  If SetQueryFilter(cF)
.head 5 -  Set sParamSql = cQ.GetFullSQLString(cF)
.head 5 +  If not SalTblPopulate(hWndForm, hSql(), sParamSql, TBL_FillAll)
.head 6 -  ! Невозможно выполнить население справочника
.head 6 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('tbl_BindSQL.cTErrNsi'), 
     CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 5 -  ! Call VisTblAutoSizeColumn(hWndForm, hWndNULL)
.head 5 -  Set i = 0
.head 5 +  While i < nColNum
.head 6 -  Set hColumn = SalTblGetColumnWindow(hWndForm, i+1, COL_GetPos)
.head 6 -  Call SalTblSetColumnTitle(hColumn, saColTitle[i])
.head 6 +  If naColWidth[i] != NUMBER_Null
.head 7 -  Call SalTblSetColumnWidth(hColumn, naColWidth[i])
.head 6 +  Else
.head 7 -  Call VisTblAutoSizeColumn(hWndForm, hColumn)
.head 6 -  Call SalTblSetColumnFlags(SalTblGetColumnWindow(hWndForm, i+1, COL_GetID), COL_Editable, FALSE)
.head 6 -  Set i = i + 1
.head 1 +  Dialog Box: dlg_OtcnCh
.head 2 -  Class: cGenericTableDlg
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Перевірка контрольних точок
.head 2 -  Accesories Enabled? Class Default
.head 2 -  Visible? Class Default
.head 2 -  Display Settings
.head 3 -  Display Style? Class Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Class Default
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  11.517"
.head 4 -  Width Editable? Class Default
.head 4 -  Height: 6.464"
.head 4 -  Height Editable? Class Default
.head 3 -  Absolute Screen Location? Class Default
.head 3 -  Font Name: Class Default
.head 3 -  Font Size: Class Default
.head 3 -  Font Enhancement: Class Default
.head 3 -  Text Color: Class Default
.head 3 -  Background Color: Class Default
.head 2 -  Description:
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Class Default
.head 4 -  Location? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Size: Class Default
.head 4 -  Size Editable? Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 3 +  Contents
.head 4 +  Pushbutton: pbIns
.head 5 -  Class Child Ref Key: 11
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbDel
.head 5 -  Class Child Ref Key: 12
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbRefresh
.head 5 -  Class Child Ref Key: 20
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbUpdate
.head 5 -  Class Child Ref Key: 15
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 17068
.head 5 -  Class Child Ref Key: 19
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbSearch
.head 5 -  Class Child Ref Key: 13
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbFilter
.head 5 -  Class Child Ref Key: 23
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbPrint
.head 5 -  Class Child Ref Key: 14
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 +  Message Actions
.head 6 +  On SAM_Click
.head 7 -  Call TablePrint( tblT1, 'Контроль файлу ',
GetPrnDir() || '/OTCNCH.TXT', ''  )
.head 4 -  Line
.head 5 -  Resource Id: 17069
.head 5 -  Class Child Ref Key: 21
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 4 +  Pushbutton: pbOk
.head 5 -  Class Child Ref Key: 16
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 +  Pushbutton: pbExit
.head 5 -  Class Child Ref Key: 17
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Property Template:
.head 5 -  Class DLL Name:
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  Class Default
.head 6 -  Width Editable? Class Default
.head 6 -  Height: Class Default
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Keyboard Accelerator: Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Picture File Name:
.head 5 -  Picture Transparent Color: Class Default
.head 5 -  Image Style: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  Message Actions
.head 4 -  Line
.head 5 -  Resource Id: 17070
.head 5 -  Class Child Ref Key: 22
.head 5 -  Class ChildKey: 0
.head 5 -  Class: cGenericTableDlg
.head 5 -  Coordinates
.head 6 -  Begin X:  Class Default
.head 6 -  Begin Y:  Class Default
.head 6 -  End X:  Class Default
.head 6 -  End Y:  Class Default
.head 5 -  Visible? Class Default
.head 5 -  Line Style: Class Default
.head 5 -  Line Thickness: Class Default
.head 5 -  Line Color: Class Default
.head 2 +  Contents
.head 3 +  Child Table: tblT1
.head 4 -  Class Child Ref Key: 8
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cGenericTableDlg
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   Class Default
.head 6 -  Top:    Class Default
.head 6 -  Width:  11.4"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 5.524"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: Class Default
.head 5 -  Font Enhancement: Class Default
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  View: Class Default
.head 5 -  Allow Row Sizing? Class Default
.head 5 -  Lines Per Row: Class Default
.head 4 -  Memory Settings
.head 5 -  Maximum Rows in Memory: 100000
.head 5 -  Discardable? Class Default
.head 4 +  Contents
.head 5 +  Column: colId
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title:
.head 6 -  Visible? No
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: Default
.head 6 -  Data Type: Number
.head 6 -  Justify: Left
.head 6 -  Width:  Default
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 5 +  Column: colTxt
.head 6 -  Class Child Ref Key: 0
.head 6 -  Class ChildKey: 0
.head 6 -  Class:
.head 6 -  Property Template:
.head 6 -  Class DLL Name:
.head 6 -  Title: Повідомлення
.head 6 -  Visible? Yes
.head 6 -  Editable? No
.head 6 -  Maximum Data Length: 200
.head 6 -  Data Type: String
.head 6 -  Justify: Left
.head 6 -  Width:  10.683"
.head 6 -  Width Editable? Yes
.head 6 -  Format: Unformatted
.head 6 -  Country: Default
.head 6 -  Input Mask: Unformatted
.head 6 -  Cell Options
.head 7 -  Cell Type? Standard
.head 7 -  Multiline Cell? No
.head 7 -  Cell DropDownList
.head 8 -  Sorted? Yes
.head 8 -  Vertical Scroll? Yes
.head 8 -  Auto Drop Down? No
.head 8 -  Allow Text Editing? Yes
.head 7 -  Cell CheckBox
.head 8 -  Check Value:
.head 8 -  Uncheck Value:
.head 8 -  Ignore Case? Yes
.head 6 -  List Values
.head 6 -  Message Actions
.head 4 -  Functions
.head 4 -  Window Variables
.head 4 -  Message Actions
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  String: sFc
.head 2 +  Window Variables
.head 3 -  String: sTfc
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Set sTfc = sFc
.head 4 -  Set hWndForm.dlg_OtcnCh.strPrintFileName = "otcnch.txt"
.head 4 -  Set hWndForm.dlg_OtcnCh.nFlags = GT_ReadOnly
.head 4 -  Set strSqlPopulate =
"SELECT id, txt
   INTO :dlg_OtcnCh.tblT1.colId, :dlg_OtcnCh.tblT1.colTxt
   FROM otcn_log
  WHERE kodf = :sTfc
    AND userid =(SELECT id FROM staff WHERE upper(logname)=upper(USER))
  ORDER BY 1 "
.head 4 -  Call SalSendClassMessage(SAM_Create, 0, 0)
.head 1 +  Form Window: frmSEBXml
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Формирование отчетов AML
.head 2 -  Icon File:
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Automatically Created at Runtime? Yes
.head 3 -  Initial State: Normal
.head 3 -  Maximizable? Yes
.head 3 -  Minimizable? Yes
.head 3 -  System Menu? Yes
.head 3 -  Resizable? Yes
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  7.45"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 4.298"
.head 4 -  Height Editable? Yes
.head 3 -  Form Size
.head 4 -  Width:  Default
.head 4 -  Height: Default
.head 4 -  Number of Pages: Dynamic
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 -  Named Menus
.head 2 -  Menu
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Group Box: Тип файлов
.head 4 -  Resource Id: 3255
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.2"
.head 5 -  Top:    0.1"
.head 5 -  Width:  2.5"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 2.5"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  ! Check Box: cbDelta
.winattr
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Delta
.head 4 -  Window Location and Size
.head 5 -  Left:   0.5"
.head 5 -  Top:    0.4"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.end
.head 4 +      Message Actions
.head 5 +      On SAM_Click
.head 6 +      If not cbDelta and not cbFull
.head 7 -      Call SalDisableWindow(pbOk)
.head 6 +      Else
.head 7 -      Call SalEnableWindow(pbOk)
.head 3 +  ! Check Box: cbFull
.winattr
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Full
.head 4 -  Window Location and Size
.head 5 -  Left:   0.5"
.head 5 -  Top:    0.714"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.end
.head 4 +      Message Actions
.head 5 +      On SAM_Click
.head 6 +      If not cbDelta and not cbFull
.head 7 -      Call SalDisableWindow(pbOk)
.head 6 +      Else
.head 7 -      Call SalEnableWindow(pbOk)
.head 3 +  Radio Button: rbDelta
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Delta
.head 4 -  Window Location and Size
.head 5 -  Left:   0.5"
.head 5 -  Top:    0.405"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 +  Radio Button: rbFull
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Full
.head 4 -  Window Location and Size
.head 5 -  Left:   0.5"
.head 5 -  Top:    0.714"
.head 5 -  Width:  1.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.25"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 4 -  Message Actions
.head 3 -  Frame
.head 4 -  Resource Id: 3256
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.2"
.head 5 -  Top:    2.7"
.head 5 -  Width:  6.5"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.8"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pbOk
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbOk
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Формировать
.head 4 -  Window Location and Size
.head 5 -  Left:   0.5"
.head 5 -  Top:    2.85"
.head 5 -  Width:  1.6"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If sListKodz = ''
.head 7 -  Call SalMessageBox('Не задан список кат.запросов для формирования отчетов!', 'Внимание!', MB_IconAsterisk)
.head 7 -  Return FALSE
.head 6 -  Call SalSendMsg(cCalendarFrom, SAM_User, 0, 0)
.head 6 -  Set sFdat = SalStrMidX(strDateFrom, 3, 2 ) || '-' || SalStrMidX(strDateFrom, 0, 2) || '-' || SalStrMidX(strDateFrom, 6, 4)
.head 6 -  Set dDate = MMddyyyyToDate(sFdat)
.head 6 -  ! Set sListKodz = '1111'
.head 6 +  If ExportXML_SEB(sListKodz,
   ":sFdat1='" || SalFmtFormatDateTime(dDate, 'dd/MM/yyyy' )|| "'",
   IifS(rbDelta, 'D', 'F'))
.head 7 -  Call SalMessageBox('Формирование отчетов успешно завершено', 'Информация', MB_IconAsterisk)
.head 3 +  Pushbutton: pbCancel
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   4.75"
.head 5 -  Top:    2.85"
.head 5 -  Width:  1.6"
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalDestroyWindow(hWndForm)
.head 3 +  Custom Control: cCalendarFrom
.data CLASSPROPSSIZE
0000: 4400
.enddata
.data CLASSPROPS
0000: 56543A43616C656E 646172436F6D626F 426F78002B000100 0000010101010000
0020: 0200000001010101 0101000000000000 01000000000A6464 2F4D4D2F79797979
0040: 00000000
.enddata
.data INHERITPROPS
0000: 0100
.enddata
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cCalendarDropDown
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Display Settings
.head 5 -  DLL Name:
.head 5 -  MS Windows Class Name:
.head 5 -  Style:  Class Default
.head 5 -  ExStyle:  Class Default
.head 5 -  Title:
.head 5 -  Window Location and Size
.head 6 -  Left:   3.1"
.head 6 -  Top:    0.321"
.head 6 -  Width:  3.3"
.head 6 -  Width Editable? Class Default
.head 6 -  Height: 0.3"
.head 6 -  Height Editable? Class Default
.head 5 -  Visible? Class Default
.head 5 -  Border? Class Default
.head 5 -  Etched Border? Class Default
.head 5 -  Hollow? Class Default
.head 5 -  Vertical Scroll? Class Default
.head 5 -  Horizontal Scroll? Class Default
.head 5 -  Tab Stop? Class Default
.head 5 -  Tile To Parent? Class Default
.head 5 -  Font Name: Class Default
.head 5 -  Font Size: 10
.head 5 -  Font Enhancement: Bold
.head 5 -  Text Color: Class Default
.head 5 -  Background Color: Class Default
.head 5 -  DLL Settings
.head 4 +  Message Actions
.head 5 +  On SAM_Create
.head 6 -  Call GetMonthArray(strMonth)
.head 6 -  Call GetWeekDayArray(strWeekDays)
.head 6 -  Call cCalendarFrom.SetMonthText(strMonth)
.head 6 -  Call cCalendarFrom.SetWeekDayText(strWeekDays)
.head 6 -  ! ! - - - - - - - - - - - - Инициализация дат календаря  cCalendarFrom - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  - -
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Sunday, SEQ_Unset,  COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Monday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Tuesday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Wednesday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Thursday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Friday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_Weekly, DATETIME_Null, DAY_Saturday, SEQ_Unset, COLOR_Black, COLOR_Gray, TRUE)
.head 6 -  Call cCalendarFrom.SpecialDate(SPECIAL_OneTime, GetBankDate(), DAY_Unset, SEQ_Unset, COLOR_Blue,  COLOR_Cyan, TRUE)
.head 6 -  Call SqlPrepareAndExecute(hSql(), T("SELECT fdat  INTO :dSelect  FROM fdat"))
.head 6 -  Set nI = 0
.head 6 +  While SqlFetchNext(hSql(), nFetchRes)
.head 7 -  Call cCalendarFrom.SpecialDate(SPECIAL_OneTime, dSelect,  DAY_Unset, SEQ_Unset, COLOR_Blue, COLOR_Cyan, TRUE)
.head 7 -  Set nI = nI + 1
.head 6 +  If nI = 0
.head 7 -  ! Call SalMessageBox('Нет доступных дат для выбора','Внимание',0)
.head 7 -  Call SalMessageBox(CurrentLangTable.GetAtomTitle('frm_Out.cTMsgDat'),
  CurrentLangTable.GetAtomTitle('cTAt'), 0)
.head 6 -  Call SalSetWindowText(cCalendarFrom,  strBankDate)
.head 5 +  On SAM_User
.head 6 -  Call SalGetWindowText(hWndItem, strDateFrom, 12)
.head 6 -  Set nDay   = SalDateDay(SalStrToDate(strDateFrom))
.head 6 -  Set nMonth = SalDateMonth(SalStrToDate(strDateFrom))
.head 6 -  Set nYear  = SalDateYear(SalStrToDate(strDateFrom))
.head 6 -  Set strDateFrom = IifS(nDay>9, SalNumberToStrX(nDay,0), "0" || SalNumberToStrX(nDay,0)) ||
    '-' || IifS(nMonth>9, SalNumberToStrX(nMonth,0), '0' || SalNumberToStrX(nMonth,0)) ||
    '-' || SalNumberToStrX(nYear, 0)
.head 3 -  Group Box: За дату
.head 4 -  Resource Id: 3257
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   2.8"
.head 5 -  Top:    0.1"
.head 5 -  Width:  3.9"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 2.5"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  String: sListKodz
.head 2 +  Window Variables
.head 3 -  ! String: sListKodz
.head 3 -  Date/Time: dDate
.head 3 -  String: strMonth[12]           !! Наименов. месяце для календаря
.head 3 -  String: strWeekDays[7]         !! Дни недели для календаря
.head 3 -  Number: nDay
.head 3 -  Number: nMonth
.head 3 -  Number: nYear
.head 3 -  String: strDateFrom            !! Дата отчета с (DD-MM-YYYY)
.head 3 -  String: sFdat
.head 3 -  Number: nI
.head 3 -  Date/Time: dSelect
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call PrepareWindowEx(hWndForm)
.head 4 -  ! Set cbDelta = TRUE
.head 4 -  Set rbDelta = TRUE
.head 4 -  Set strBankDate = SalFmtFormatDateTime(GetBankDate(), 'dd/MM/yyyy')
.head 1 +  Dialog Box: dlg_SetDatZ
.head 2 -  Class:
.head 2 -  Property Template:
.head 2 -  Class DLL Name:
.head 2 -  Title: Внимание!
.head 2 -  Accesories Enabled? No
.head 2 -  Visible? Yes
.head 2 -  Display Settings
.head 3 -  Display Style? Default
.head 3 -  Visible at Design time? Yes
.head 3 -  Type of Dialog: Modal
.head 3 -  Window Location and Size
.head 4 -  Left:   Default
.head 4 -  Top:    Default
.head 4 -  Width:  4.7"
.head 4 -  Width Editable? Yes
.head 4 -  Height: 2.4"
.head 4 -  Height Editable? Yes
.head 3 -  Absolute Screen Location? Yes
.head 3 -  Font Name: Default
.head 3 -  Font Size: Default
.head 3 -  Font Enhancement: Default
.head 3 -  Text Color: Default
.head 3 -  Background Color: Default
.head 2 -  Description:
.head 2 +  Tool Bar
.head 3 -  Display Settings
.head 4 -  Display Style? Default
.head 4 -  Location? Top
.head 4 -  Visible? Yes
.head 4 -  Size: Default
.head 4 -  Size Editable? Yes
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Default
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 -  Contents
.head 2 +  Contents
.head 3 -  Frame
.head 4 -  Resource Id: 3832
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.1"
.head 5 -  Top:    0.1"
.head 5 -  Width:  4.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 1.0"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 -  Background Text: Укажите дату загрузки данных
.head 4 -  Resource Id: 3831
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.2"
.head 5 -  Top:    0.3"
.head 5 -  Width:  4.0"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.167"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Justify: Center
.head 4 -  Font Name: Default
.head 4 -  Font Size: Default
.head 4 -  Font Enhancement: Bold
.head 4 -  Text Color: Default
.head 4 -  Background Color: Default
.head 3 +  Data Field: dfDatZ
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Data
.head 5 -  Maximum Data Length: Default
.head 5 -  Data Type: Date/Time
.head 5 -  Editable? Yes
.head 4 -  Display Settings
.head 5 -  Window Location and Size
.head 6 -  Left:   1.4"
.head 6 -  Top:    0.6"
.head 6 -  Width:  1.6"
.head 6 -  Width Editable? Yes
.head 6 -  Height: 0.25"
.head 6 -  Height Editable? Yes
.head 5 -  Visible? Yes
.head 5 -  Border? Yes
.head 5 -  Justify: Center
.head 5 -  Format: Date
.head 5 -  Country: Default
.head 5 -  Font Name: Default
.head 5 -  Font Size: Default
.head 5 -  Font Enhancement: Default
.head 5 -  Text Color: Default
.head 5 -  Background Color: Default
.head 5 -  Input Mask: Unformatted
.head 4 -  Message Actions
.head 3 -  Frame
.head 4 -  Resource Id: 3833
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class:
.head 4 -  Window Location and Size
.head 5 -  Left:   0.1"
.head 5 -  Top:    1.2"
.head 5 -  Width:  4.4"
.head 5 -  Width Editable? Yes
.head 5 -  Height: 0.75"
.head 5 -  Height Editable? Yes
.head 4 -  Visible? Yes
.head 4 -  Corners: Square
.head 4 -  Border Style: Etched
.head 4 -  Border Thickness: 1
.head 4 -  Border Color: 3D Shadow Color
.head 4 -  Background Color: Default
.head 3 +  Pushbutton: pbOk
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbOk
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title: Применить
.head 4 -  Window Location and Size
.head 5 -  Left:   0.3"
.head 5 -  Top:    1.35"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Class Default
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 +  If not SalIsNull(dfDatZ)
.head 7 -  Set dDatZ = dfDatZ
.head 7 -  Call SalEndDialog(hWndForm, TRUE)
.head 6 +  Else
.head 7 -  Call SalEndDialog(hWndForm, FALSE)
.head 3 +  Pushbutton: pbCancel
.head 4 -  Class Child Ref Key: 0
.head 4 -  Class ChildKey: 0
.head 4 -  Class: cpbCancel
.head 4 -  Property Template:
.head 4 -  Class DLL Name:
.head 4 -  Title:
.head 4 -  Window Location and Size
.head 5 -  Left:   3.1"
.head 5 -  Top:    1.35"
.head 5 -  Width:  Class Default
.head 5 -  Width Editable? Class Default
.head 5 -  Height: Class Default
.head 5 -  Height Editable? Class Default
.head 4 -  Visible? Class Default
.head 4 -  Keyboard Accelerator: Esc
.head 4 -  Font Name: Class Default
.head 4 -  Font Size: Class Default
.head 4 -  Font Enhancement: Class Default
.head 4 -  Picture File Name:
.head 4 -  Picture Transparent Color: Class Default
.head 4 -  Image Style: Class Default
.head 4 -  Text Color: Class Default
.head 4 -  Background Color: Class Default
.head 4 +  Message Actions
.head 5 +  On SAM_Click
.head 6 -  Call SalEndDialog(hWndForm, FALSE)
.head 2 -  Functions
.head 2 +  Window Parameters
.head 3 -  Receive Date/Time: dDatZ
.head 2 -  Window Variables
.head 2 +  Message Actions
.head 3 +  On SAM_Create
.head 4 -  Call SalCenterWindow(hWndForm)
.head 4 -  Set dfDatZ = SalDateCurrent()
.head 4 -  Call SalSetFocus(pbCancel)
.head 4 -  Call SalWaitCursor(FALSE)
